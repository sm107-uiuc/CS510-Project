{"url": "https://towardsdatascience.com/combining-tree-based-models-with-a-linear-baseline-model-to-improve-extrapolation-c100bd448628", "time": 1683015768.640604, "path": "towardsdatascience.com/combining-tree-based-models-with-a-linear-baseline-model-to-improve-extrapolation-c100bd448628/", "webpage": {"metadata": {"title": "Combining tree based models with a linear baseline model to improve extrapolation | by Sebastian Telsemeyer | Towards Data Science", "h1": "Combining tree based models with a linear baseline model to improve extrapolation", "description": "This post is a short intro on combining different machine learning models for practical purposes, to find a good balance between their advantages and disadvantages. In our case we will ensemble a\u2026"}, "outgoing_paragraph_urls": [{"url": "http://blog.kaggle.com/2017/01/23/a-kaggle-master-explains-gradient-boosting/", "anchor_text": "outperform", "paragraph_index": 1}, {"url": "http://freerangestats.info/blog/2016/12/10/extrapolation", "anchor_text": "read more on this", "paragraph_index": 1}, {"url": "http://danielhnyk.cz/creating-your-own-estimator-scikit-learn/", "anchor_text": "our own estimator", "paragraph_index": 7}, {"url": "https://scikit-learn.org/stable/developers/develop.html", "anchor_text": "interface", "paragraph_index": 7}, {"url": "https://scikit-learn.org/stable/developers/develop.html", "anchor_text": "full sklearn compatiblity", "paragraph_index": 15}], "all_paragraphs": ["This post is a short intro on combining different machine learning models for practical purposes, to find a good balance between their advantages and disadvantages. In our case we will ensemble a random forest, a very powerful non-linear, non-parametric tree-based allrounder, with a classical linear regression model, a model that is very easy to interpret and can be verified using domain knowledge.", "For many problems gradient boosting or random forests are the go-to-model. They often outperform many other models as they are able to learn almost any linear or non-linear relationship. Nevertheless one of the disadvantages of tree models is that they do not handle new data very well, they often extrapolate poorly \u2014 read more on this. For practical purposes that can lead to undesired behaviour, for example when predicting time, distances or cost, which will be outlined in a second.", "We can quickly verify that the sklearn implementation for random forest models can learn the identity very well for the provided range (0 to 50), but then fails miserably for values out of the training data range:", "In contrast to tree models, linear models handle new data differently. They can very easily extrapolate predictions, but of course with the drawback of learning only linear relationships. Moreover linear models allow an easy interpretation, simply by looking at the regression coefficients we can actually compare it to domain knowledge, and practically verify it.", "For some regression problems it therefore makes sense to combine both approaches, which we can elaborate with an example: Let\u2019s assume we want to estimate travel time with respect to travel distance for different vehicles, using historic data (a dataset containing the vehicle type, distances and the travel time). We might consider using a linear or a non-linear model, also depending on our expectations. If we aim to estimate travel time for bikes, an increase in distance leads to proportional change in time (if you ride a bike twice as long you can probably travel twice the distance). If we train a linear model it will be a good fit, and the coefficient expresses the proportionality between distance and time.", "But a drawback of a linear model is that it could have problems learning the relationship of time versus distance for other vehicle types, like cars. If the travel distance by car increases we might be able to take highways, opposed to the shorter distances, so the increase in travel time might not be linearly proportional any more. In this case a non-linear model will perform better. However, if we train a non-linear tree model on observed travelled car distances, it will perform poorly on new data, i.e. unseen distances: if our training data only contains car trips up to 100 kilometers, an estimate for 200 kilometers will be very bad, whereas the linear model will still provide a good, extrapolated estimate.", "To tackle this we could support the tree model with a linear model in the following way: if the prediction of the tree model is too far away from the prediction of our baseline linear model, we default to the linear model prediction. So for our example: if the non-linear model prediction for a 200 kilometer car ride is 2 hours (because it has only seen car rides up to 2 hours), but the linear model prediction is 3 hours, we default to the 3 hours. Whereas if the prediction of the non-linear model is not too far away (say less than 25%) from the validation prediction of the linear model, we stick to it (as we expect it to perform better in general).", "In sklearn we could implement this in the following way, by creating our own estimator. Be advised that this first implementation does not comply with the sklearn API standards yet - we will improve this version at the end of this post according to the interface.", "We simply fit two estimators, and predict using two estimators. We can then compare both predictions and adjust our prediction accordingly. We will take the tree model prediction if it is within a certain range of the linear prediction. Alternatively to comparing both models and picking the more reasonable prediction, we can also take the average of both predictions or blend them differently. Moreover we could optimize the parameters upper and lower using grid search (for this we will need to implement some further methods like get_params and set_params).", "Let us generate some sample data using the non-linear function f(x)=x+sqrt(x)+rnorm(0, 3) to evaluate the model:", "We can now train three different models: RandomForestRegressor, LinearRegression and our custom CombinedRegressor on our small sample dataset.", "If we look at plots (see below) of all three model predictions and the true values we can quickly see the initially discussed problem: the tree model cannot really extrapolate", "As expected the random forest model performs best in terms of in-sample mean absolute error. Now if we evaluate out-of-sample (150 opposed to the maximum of 100 in the training data) things look different:", "The tree model makes a bad job due to the incapability of extrapolation, the linear model does a better job, and therefore the ensembled model that is backed up by the linear regression. At the same time it will still perform good in-sample, and it will perform decent (better than the tree model only, worse than the linear regression) if we increase the range drastically:", "We can also plot the individual predictions on some random data (both in and out of training sample) and quickly see the initially discussed problem of previously unseen x-values and the tree model, which flattens out. The linear model continues with the trend, and the combined version has an unpleasant bump but at least follows the trend once the tree model deviates too much.", "If we want to achieve full sklearn compatiblity (model selection, pipelines, etc.) and also use sklearn\u2019s onboard testing utilities we have to do some modifications to the estimator:", "This can be achieved in the following way:", "We can then run hyperparameter grid search on our custom estimator:", "We can also check our estimator using sklearn.utils.estimator_checks utilities:", "In some cases you might not be able to satisfy a specific validation, in this case you could for example mock the return value of that specific check as true:", "This approach can be very helpful if we have one model that works charmingly on a certain set of inputs, but where we lose confidence once the inputs are more exotic. In this case we can guarantee some prediction sanity by using a more transparent (for ex. linear) approach, which we can easily synchronize with domain knowledge and which guarantees a specific behaviour (for ex. extrapolation, proportional increments).", "Instead of using a combined estimator we could also use a non-linear model with better extrapolation behaviour, like a neural network. Another alternative would be to add some artificial samples to the training dataset to increase the supported response range.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Data Scientist based in Sydney, Australia"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fc100bd448628&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcombining-tree-based-models-with-a-linear-baseline-model-to-improve-extrapolation-c100bd448628&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcombining-tree-based-models-with-a-linear-baseline-model-to-improve-extrapolation-c100bd448628&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcombining-tree-based-models-with-a-linear-baseline-model-to-improve-extrapolation-c100bd448628&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcombining-tree-based-models-with-a-linear-baseline-model-to-improve-extrapolation-c100bd448628&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----c100bd448628--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----c100bd448628--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://dsdx.medium.com/?source=post_page-----c100bd448628--------------------------------", "anchor_text": ""}, {"url": "https://dsdx.medium.com/?source=post_page-----c100bd448628--------------------------------", "anchor_text": "Sebastian Telsemeyer"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fb7f2b6fc948e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcombining-tree-based-models-with-a-linear-baseline-model-to-improve-extrapolation-c100bd448628&user=Sebastian+Telsemeyer&userId=b7f2b6fc948e&source=post_page-b7f2b6fc948e----c100bd448628---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fc100bd448628&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcombining-tree-based-models-with-a-linear-baseline-model-to-improve-extrapolation-c100bd448628&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fc100bd448628&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcombining-tree-based-models-with-a-linear-baseline-model-to-improve-extrapolation-c100bd448628&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://towardsdatascience.com/tagged/hands-on-tutorials", "anchor_text": "Hands-on Tutorials"}, {"url": "http://blog.kaggle.com/2017/01/23/a-kaggle-master-explains-gradient-boosting/", "anchor_text": "outperform"}, {"url": "http://freerangestats.info/blog/2016/12/10/extrapolation", "anchor_text": "read more on this"}, {"url": "http://danielhnyk.cz/creating-your-own-estimator-scikit-learn/", "anchor_text": "our own estimator"}, {"url": "https://scikit-learn.org/stable/developers/develop.html", "anchor_text": "interface"}, {"url": "https://scikit-learn.org/stable/developers/develop.html", "anchor_text": "full sklearn compatiblity"}, {"url": "https://blog.telsemeyer.com/2019/10/30/combining-tree-based-modelss-with-a-linear-baseline-model-to-improve-extrapolation-writing-your-own-sklearn-functions-part-1/", "anchor_text": "https://blog.telsemeyer.com"}, {"url": "https://medium.com/tag/regression?source=post_page-----c100bd448628---------------regression-----------------", "anchor_text": "Regression"}, {"url": "https://medium.com/tag/extrapolation?source=post_page-----c100bd448628---------------extrapolation-----------------", "anchor_text": "Extrapolation"}, {"url": "https://medium.com/tag/ensemble-learning?source=post_page-----c100bd448628---------------ensemble_learning-----------------", "anchor_text": "Ensemble Learning"}, {"url": "https://medium.com/tag/modeling?source=post_page-----c100bd448628---------------modeling-----------------", "anchor_text": "Modeling"}, {"url": "https://medium.com/tag/hands-on-tutorials?source=post_page-----c100bd448628---------------hands_on_tutorials-----------------", "anchor_text": "Hands On Tutorials"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fc100bd448628&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcombining-tree-based-models-with-a-linear-baseline-model-to-improve-extrapolation-c100bd448628&user=Sebastian+Telsemeyer&userId=b7f2b6fc948e&source=-----c100bd448628---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fc100bd448628&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcombining-tree-based-models-with-a-linear-baseline-model-to-improve-extrapolation-c100bd448628&user=Sebastian+Telsemeyer&userId=b7f2b6fc948e&source=-----c100bd448628---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fc100bd448628&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcombining-tree-based-models-with-a-linear-baseline-model-to-improve-extrapolation-c100bd448628&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----c100bd448628--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fc100bd448628&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcombining-tree-based-models-with-a-linear-baseline-model-to-improve-extrapolation-c100bd448628&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----c100bd448628---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----c100bd448628--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----c100bd448628--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----c100bd448628--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----c100bd448628--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----c100bd448628--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----c100bd448628--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----c100bd448628--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----c100bd448628--------------------------------", "anchor_text": ""}, {"url": "https://dsdx.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://dsdx.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Sebastian Telsemeyer"}, {"url": "https://dsdx.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "60 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fb7f2b6fc948e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcombining-tree-based-models-with-a-linear-baseline-model-to-improve-extrapolation-c100bd448628&user=Sebastian+Telsemeyer&userId=b7f2b6fc948e&source=post_page-b7f2b6fc948e--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F9dda054f4b51&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcombining-tree-based-models-with-a-linear-baseline-model-to-improve-extrapolation-c100bd448628&newsletterV3=b7f2b6fc948e&newsletterV3Id=9dda054f4b51&user=Sebastian+Telsemeyer&userId=b7f2b6fc948e&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}