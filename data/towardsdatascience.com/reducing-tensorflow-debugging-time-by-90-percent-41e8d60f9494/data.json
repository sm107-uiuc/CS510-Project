{"url": "https://towardsdatascience.com/reducing-tensorflow-debugging-time-by-90-percent-41e8d60f9494", "time": 1683003060.809116, "path": "towardsdatascience.com/reducing-tensorflow-debugging-time-by-90-percent-41e8d60f9494/", "webpage": {"metadata": {"title": "Reducing Tensorflow Debugging Time by 90 Percent | by Wei Yi | Towards Data Science", "h1": "Reducing Tensorflow Debugging Time by 90 Percent", "description": "Tensorflow code is difficult to debug. I used to spend weeks debugging my code. Worse, most of the time, I didn\u2019t know how to proceed \u2014 I can see my code does not learn, but I don\u2019t know it is\u2026"}, "outgoing_paragraph_urls": [{"url": "https://towardsdatascience.com/reducing-tensorflow-debugging-time-by-90-percent-41e8d60f9494?sk=a47e01af4a84a59c3fc4357967f0c8ff", "anchor_text": "friend link", "paragraph_index": 0}, {"url": "https://en.wikipedia.org/wiki/Design_by_contract", "anchor_text": "Design by Contract method", "paragraph_index": 2}, {"url": "https://www.bing.com/search?q=c%23+read+file+line+by+line", "anchor_text": "Bing search engine", "paragraph_index": 4}, {"url": "https://www.tensorflow.org/performance/xla/broadcasting", "anchor_text": "TensorFlow\u2019s broadcasting", "paragraph_index": 7}, {"url": "https://en.wikipedia.org/wiki/DOT_(graph_description_language)", "anchor_text": "DOT", "paragraph_index": 17}, {"url": "https://jasonweiyi.medium.com/membership", "anchor_text": "https://jasonweiyi.medium.com/membership", "paragraph_index": 40}], "all_paragraphs": ["If you are stuck in front of the paywall, use the friend link.", "Tensorflow code is difficult to debug. I used to spend weeks debugging my code. Worse, most of the time, I didn\u2019t know how to proceed \u2014 I can see my code does not learn, but I don\u2019t know it is because the model is not capable of learning, or because the implementation has bugs. If the latter, where is the bug?", "This is the frustration that many machine learning practitioners face. This article introduces the VeriTensor method that I designed to debug Tensorflow code. VeriTensor is based on the Design by Contract method. It includes three techniques. This method reduced my debugging time from weeks to hours, an over 90% improvement. Better, after I\u2019m done debugging, I know that there is no bugs in the code. What a great feeling!", "The key to effective debugging is to write specifications to define correctness of your code. Specifications describe what the code is supposed to do, and implementations describe how to do it. A piece of code is correct only with respect to its specification. In Python, you use assertions to write specifications, as shown in line 2 and 4 in the following listing.", "But it is very hard to write assertions, you say. I agree with you. I spent 15 years verifying code with assertions. I developed assertion based technology that Microsoft includes in its Bing search engine. I know how tricky specifications can be. That\u2019s why when I developed VeriTensor, I made sure it is practical.", "Key to effective debugging is to tell your debugger what your code is supposed to do, via assertions.", "VeriTensor includes 3 techniques. You can apply them after you have written your Tensorflow code. This means the techniques are drop-in, you don\u2019t need to start from scratch to use them.", "When you introduce tensors, you need to write asserts to check their shapes. Incorrect assumptions about tensor shapes often result in tricky bugs. And TensorFlow\u2019s broadcasting mechanism can hide them deep.", "For example, in a regression algorithm, such as a Deep Q Network (DQN), you have a prediction tensor coming from a neural network, a target tensor and a loss tensor:", "The prediction represents the predicted value. The target tensor represents the desired value, calculated from the reward tensor and the bootstrapped_q tensor, and gamma is a float number.The loss tensor represents our training loss as mean square error.", "Now we add assertions for the introduced tensors, shown in the next listing. These assertions check that the shape of the prediction and the target must be the same in terms of batch_size and action_dimension. These are some quantities used in the DQN algorithm. If you are not familiar with them, not to worry. The important thing here is that we write assertions to check tensor shapes. Finally, since loss evaluates to a number, the assertion states its shape is [].", "You\u2019ll get an assertion violation if the shape of a tensor does not match their expected value. You won\u2019t believe how often your shape assertions are violated!", "Tensorflow program is a computation graph. So you need to make sure that you build the tensor graph correctly. If the value of tensor B depends on the value of tensor A (e.g. B=A+1), then there should be an edge from node B to node A in the graph.", "You can visualize your Tensorflow graph using TensorBoard. However, understanding this graph is difficult because a realistic tensor graph often has hundreds of nodes and edges. The following figure shows a typical TensorBoard visualization.", "The key insight here is: to check the structure of your tensor graph, you only need to visualize the relationships between the tensors you introduced. And you can often group many tensors into a single node. For example, in a multi-layer neural network that has many variables, each variable is a tensor. But you only need to visualize the whole network as a single node.", "I developed a Python package, VeriTensor, to simplify tensor graph visualization. I will soon open-source this package. It contains a class TensorGroupDependency. This class allows you to register only the tensors you want to visualize. It generates a new, much smaller visualization for the registered tensors.", "The next listing shows how to use TensorGroupDependency. You first call the add method to register the tensors. Then call the generate_dot_representation method to give you a visualization. This visualization only shows the registered tensors and their dependencies.", "Line 1 to 5 creates a tensor dependency graph object, and registers the tensors whose relationships are to be visualized. Line 8 and 9 generates and prints those tensor dependencies in the DOT language, which can be rendered graphically:", "Let\u2019s understand the above dependency graph:", "To check the correctness of the graph structure, you need to explain why every edge exists. This means to explain the dependency relationship between those tensors. If you\u2019re unable to explain the existence of certain edges, there\u2019s a discrepancy between the idea in your mind and the actual graph you built. This usually signifies a bug.", "Once you have explained all the edges, you generate assertions describing the graph by calling the generate_assertions method, as in Line 12 in the above snippet. The following listing shows the generated assertions. They describe the same dependency graph. And they becomes part of your code and will be checked in all future executions:", "By the way, if you carefully designed the name scopes in your Tensorflow code, and you perform serious folding in your TensorBoard visualization, you can get the same thing as what the above library gives you. But I think a library is nice because:", "So far, you\u2019ve verified the dependency relationships between the tensors you defined. The final step is to check that the tensors perform correct numerical calculations. For example, the equations B = A +1 and B = A -1 both introduce a dependency from B to A, so their dependency graph is the same. But you need to specify that B=A+1 is the correct implementation. Do this for each equation in your algorithm using tensor equation evaluations:", "The next listing shows the tensor equation evaluation for the loss tensor. session.run evaluates the parameter_update_operations, that\u2019s the usual thing you have, like a gradient descend step. Besides this usual work, now session.run also evaluates the prediction, target and the loss tensor. You calculate the desired loss from these three tensor evaluations. Finally, you assert that the actual loss is equal to desired loss at line 4 and 5. Note line 4 and 5 are in Python world. In Python world, you can use loops, call arbitrary functions; it is way easier than in the Tensorflow world.", "We have applied these techniques to all our Tensorflow learners. The following table reports the time we spent in verifying five of our models and the number of bugs we found.", "The \u201cLearning module\u201d column lists the name of the machine learning models. These are Actor-Critic algorithms in deep reinforcement learning.", "The \u201cCoding time\u201d column reports the time in hours we spent writing the code of those learners. In total, we spent 24 hours.", "The \u201cVerification time\u201d column reports the time we spent in verification. This includes writing the assertions, running the code, observing assertion violations and fixing detected bugs. In total, we spent 5 hours. In other words, verification requires 20% more effort.", "The \u201cBugs detected by\u201d columns is a breakdown for each assertion technique. It shows the percentage of time spent on each technique and the number of detected bugs. In total, we detected 23 bugs in only 5 hours. More importantly, after applying the techniques, we know our code is correct.", "We can clearly see that VeriTensor is effective in detecting bugs.", "First, they require you to define the correctness of your code via assertions. Writing specifications is not a new idea, but VeriTensor makes it practical:", "Second, finding where a bug originates is daunting in Tensorflow. People spend most of their time localizing origins of bugs. Once we know the origin, fixing the bug is usually easy. When applied in order, the VeriTensor techniques help you localize faults. When you have a problem in the tensor dependency stage, you know that all involved tensors have correct shapes. When you have a problem with a tensor equation, you know that the dependency structure is correct. In short, you can better focus on and locate every problem.", "Third, VeriTensor turns Tensorflow code debugging from an art into a software engineering process. The process ensures the code is correct if you follow a simple to-do list:", "A common problem when validating and/or testing code is knowing how to proceed and when to stop. Which part of the code do you start on? Which aspects should you check? How will you know when you\u2019ve tested enough?", "Our three techniques remove these doubts. You apply them one by one and each technique has finite and manageable steps. The number of steps are bounded by the number of tensors and equations you introduced in your code \u2014 usually around a dozen. In the end, you know your code is correct. This is an engineering process, not an art. Don\u2019t overlook the power of such an engineering process. When people know the exact steps, they\u2019re a lot more efficient.", "Don\u2019t overlook the power of such an engineering process. When people know the exact steps, they\u2019re a lot more efficient.", "I need to make it clear that VeriTensor verifies the code\u2019s correctness. It doesn\u2019t evaluate the code\u2019s performance. Correctness means the code you implement matches the idea you have in mind. Performance is its ability to learn a meaningful model. Performance is usually measured by plotting loss, cross validation, test data.", "You should look at the code\u2019s performance only after you\u2019ve established its correctness. I call this the correctness before performance principle. Otherwise, you need to worry whether a bad performance is because the learning algorithm is not good enough or there is some bug in the code. Obviously you want the latter, but you will have a hard time showing that your code has no bugs.", "Correctness before performance principle: look at the code\u2019s performance only after you\u2019ve established its correctness.", "Sadly, a pattern I see many people do is to use performance metrics to drive debugging. When their code does not learn, they start debugging by plotting the loss function. This violates the correctness before performance principle, thus not effective in finding bugs. This is because:", "If you like my story, I will be grateful if you consider supporting me by becoming a Medium member via this link: https://jasonweiyi.medium.com/membership.", "I will keep writing these stories.", "A year and a half ago, I presented VeriTensor at a Tensorflow Deep Dive event. The presentation was well received. Here is the presentation.", "In the 20 months after that, I applied VeriTensor to all my machine learning code and it worked again and again. I hope it helps you as well.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "I am a senior data scientist at AstraZeneca. Previously I worked at SecondMind, Microsoft Research, and also was CTO of a hedge fund EQB."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F41e8d60f9494&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freducing-tensorflow-debugging-time-by-90-percent-41e8d60f9494&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freducing-tensorflow-debugging-time-by-90-percent-41e8d60f9494&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freducing-tensorflow-debugging-time-by-90-percent-41e8d60f9494&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freducing-tensorflow-debugging-time-by-90-percent-41e8d60f9494&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----41e8d60f9494--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----41e8d60f9494--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://jasonweiyi.medium.com/?source=post_page-----41e8d60f9494--------------------------------", "anchor_text": ""}, {"url": "https://jasonweiyi.medium.com/?source=post_page-----41e8d60f9494--------------------------------", "anchor_text": "Wei Yi"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F1b4bd5317a6e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freducing-tensorflow-debugging-time-by-90-percent-41e8d60f9494&user=Wei+Yi&userId=1b4bd5317a6e&source=post_page-1b4bd5317a6e----41e8d60f9494---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F41e8d60f9494&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freducing-tensorflow-debugging-time-by-90-percent-41e8d60f9494&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F41e8d60f9494&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freducing-tensorflow-debugging-time-by-90-percent-41e8d60f9494&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://pixabay.com/illustrations/scan-system-bug-virus-malware-3963099/", "anchor_text": "Image"}, {"url": "https://towardsdatascience.com/reducing-tensorflow-debugging-time-by-90-percent-41e8d60f9494?sk=a47e01af4a84a59c3fc4357967f0c8ff", "anchor_text": "friend link"}, {"url": "https://en.wikipedia.org/wiki/Design_by_contract", "anchor_text": "Design by Contract method"}, {"url": "https://www.bing.com/search?q=c%23+read+file+line+by+line", "anchor_text": "Bing search engine"}, {"url": "https://www.tensorflow.org/performance/xla/broadcasting", "anchor_text": "TensorFlow\u2019s broadcasting"}, {"url": "https://en.wikipedia.org/wiki/DOT_(graph_description_language)", "anchor_text": "DOT"}, {"url": "https://jasonweiyi.medium.com/membership", "anchor_text": "https://jasonweiyi.medium.com/membership"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----41e8d60f9494---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/tensorflow?source=post_page-----41e8d60f9494---------------tensorflow-----------------", "anchor_text": "TensorFlow"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----41e8d60f9494---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/tag/technology?source=post_page-----41e8d60f9494---------------technology-----------------", "anchor_text": "Technology"}, {"url": "https://medium.com/tag/towards-data-science?source=post_page-----41e8d60f9494---------------towards_data_science-----------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F41e8d60f9494&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freducing-tensorflow-debugging-time-by-90-percent-41e8d60f9494&user=Wei+Yi&userId=1b4bd5317a6e&source=-----41e8d60f9494---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F41e8d60f9494&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freducing-tensorflow-debugging-time-by-90-percent-41e8d60f9494&user=Wei+Yi&userId=1b4bd5317a6e&source=-----41e8d60f9494---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F41e8d60f9494&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freducing-tensorflow-debugging-time-by-90-percent-41e8d60f9494&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----41e8d60f9494--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F41e8d60f9494&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freducing-tensorflow-debugging-time-by-90-percent-41e8d60f9494&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----41e8d60f9494---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----41e8d60f9494--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----41e8d60f9494--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----41e8d60f9494--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----41e8d60f9494--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----41e8d60f9494--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----41e8d60f9494--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----41e8d60f9494--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----41e8d60f9494--------------------------------", "anchor_text": ""}, {"url": "https://jasonweiyi.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://jasonweiyi.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Wei Yi"}, {"url": "https://jasonweiyi.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "812 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F1b4bd5317a6e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freducing-tensorflow-debugging-time-by-90-percent-41e8d60f9494&user=Wei+Yi&userId=1b4bd5317a6e&source=post_page-1b4bd5317a6e--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fea93cb78cf1e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freducing-tensorflow-debugging-time-by-90-percent-41e8d60f9494&newsletterV3=1b4bd5317a6e&newsletterV3Id=ea93cb78cf1e&user=Wei+Yi&userId=1b4bd5317a6e&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}