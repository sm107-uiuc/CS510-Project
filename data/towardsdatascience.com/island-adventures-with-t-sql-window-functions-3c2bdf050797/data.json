{"url": "https://towardsdatascience.com/island-adventures-with-t-sql-window-functions-3c2bdf050797", "time": 1683008947.404293, "path": "towardsdatascience.com/island-adventures-with-t-sql-window-functions-3c2bdf050797/", "webpage": {"metadata": {"title": "Island adventures with T-SQL Window Functions | by Nikola Ilic | Towards Data Science", "h1": "Island adventures with T-SQL Window Functions", "description": "Recently, I got a request from a business user within my company to create a report which shows the number of consecutive days where money turnover was greater than X value. When I started to prepare\u2026"}, "outgoing_paragraph_urls": [{"url": "http://data-mozart.com", "anchor_text": "data-mozart.com", "paragraph_index": 19}], "all_paragraphs": ["Recently, I got a request from a business user within my company to create a report which shows the number of consecutive days where money turnover was greater than X value. When I started to prepare the data from our SQL Server database, there were a few tricky parts to solve.", "In order to demonstrate how I solved this, I will use the Stack Overflow sample database. Let\u2019s translate the business requests into the following: find a number of consecutive days where there were more than 50 posts and each of these posts had more than 50.000 views.", "Table dbo.Posts contains around 17.2 million rows. First, let\u2019s check how many posts with more than 50.000 views were per every single day:", "When I run this query, I\u2019m getting the following results:", "In order to better cope with running queries, I\u2019ve created a non-clustered index on the CreationDate column, with ViewCount column included. Now, when I run the query to check dates where there were more than 50 posts with 50.000+ views, I am getting the following results:", "As you can notice, between September 15th 2008 and September 19th, all dates are included. Then, 20th and 21st are missing\u2026This problem is well known as the \u201cGaps and Islands\u201d problem. Here, the first bucket of dates (15th \u2014 19th) represents \u201cisland\u201d, while 20th and 21st represent \u201cgap\u201d.", "Let\u2019s first identify our \u201cislands\u201d (buckets of consecutive dates which satisfies the criteria: in our case, dates with more than 50 posts which have 50.000+ views):", "This way, we identified our \u201cislands\u201d, as you can see in the following screenshot:", "If you run a version of SQL Server which is 2012 or later, you can take advantage of time offset functions LEAD and LAG. By default, LEAD will return the next value within the sequence, but the offset can be also adjusted with an optional parameter, while the latter will do exactly the opposite \u2014 return previous value in sequence (by default).", "Let\u2019s see how LEAD works in our scenario:", "This solution is much more intuitive since you avoid complexities with self -joins, but what is more important, this code runs much faster.", "Here, I started with the ROW_NUMBER() function instead of DENSE_RANK(). But, then I found a nice explanation from Itzik Ben-Gan in his book \u201cMicrosoft SQL Server 2012 High-Performance T-SQL Using Window Functions\u201d, where he clarifies that DENSE_RANK() guarantees that code will work properly even if we had duplicate values in our sequence, while ROW_NUMBER() won\u2019t.", "Results are, as expected, the same:", "In some scenarios, you want to check ranges where your business request wasn\u2019t met. For example, you would like to check dates when your sales were below some threshold, or when your system didn\u2019t work properly.", "In my example, I will show dates when there were not more than 50 posts with 50.000+ views.", "Opposite from finding \u201cislands\u201d, where we need to check consecutive values and detect where are the \u201cgaps\u201d in between.", "As for the \u201cislands\u201d problem, similar logic can be implemented to find \u201cgaps\u201d. So, as in the previous example, we will use the LEAD function to achieve our goal:", "Again, with LEAD, the code is much more intuitive and human-readable. Here, we are just checking range between consecutive dates and if it\u2019s greater than 1, that means that we have a gap in our sequence. When that criterion is met, we are just adding one day to last \u201cisland\u201d date in the sequence to get the first \u201cgap\u201d date, while subtracting one from the first \u201cisland\u201d date in the next sequence to get the last date of the \u201cgap\u201d.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Data Mozart \u2014 Make Music from your Data!| data-mozart.com | @DataMozart | Microsoft Data Platform MVP | Power BI Addict | Blogger, speaker, learner\u2026"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F3c2bdf050797&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fisland-adventures-with-t-sql-window-functions-3c2bdf050797&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fisland-adventures-with-t-sql-window-functions-3c2bdf050797&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fisland-adventures-with-t-sql-window-functions-3c2bdf050797&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fisland-adventures-with-t-sql-window-functions-3c2bdf050797&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----3c2bdf050797--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----3c2bdf050797--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://datamozart.medium.com/?source=post_page-----3c2bdf050797--------------------------------", "anchor_text": ""}, {"url": "https://datamozart.medium.com/?source=post_page-----3c2bdf050797--------------------------------", "anchor_text": "Nikola Ilic"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F64005b7daa38&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fisland-adventures-with-t-sql-window-functions-3c2bdf050797&user=Nikola+Ilic&userId=64005b7daa38&source=post_page-64005b7daa38----3c2bdf050797---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F3c2bdf050797&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fisland-adventures-with-t-sql-window-functions-3c2bdf050797&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F3c2bdf050797&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fisland-adventures-with-t-sql-window-functions-3c2bdf050797&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://www.pexels.com/@byrahul?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels", "anchor_text": "Rahul"}, {"url": "https://www.pexels.com/photo/clouds-crescent-moon-daylight-glass-2162909/?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels", "anchor_text": "Pexels"}, {"url": "https://medium.com/tag/towards-data-science?source=post_page-----3c2bdf050797---------------towards_data_science-----------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/tag/sql-server?source=post_page-----3c2bdf050797---------------sql_server-----------------", "anchor_text": "Sql Server"}, {"url": "https://medium.com/tag/data?source=post_page-----3c2bdf050797---------------data-----------------", "anchor_text": "Data"}, {"url": "https://medium.com/tag/sql?source=post_page-----3c2bdf050797---------------sql-----------------", "anchor_text": "Sql"}, {"url": "https://medium.com/tag/database?source=post_page-----3c2bdf050797---------------database-----------------", "anchor_text": "Database"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F3c2bdf050797&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fisland-adventures-with-t-sql-window-functions-3c2bdf050797&user=Nikola+Ilic&userId=64005b7daa38&source=-----3c2bdf050797---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F3c2bdf050797&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fisland-adventures-with-t-sql-window-functions-3c2bdf050797&user=Nikola+Ilic&userId=64005b7daa38&source=-----3c2bdf050797---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F3c2bdf050797&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fisland-adventures-with-t-sql-window-functions-3c2bdf050797&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----3c2bdf050797--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F3c2bdf050797&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fisland-adventures-with-t-sql-window-functions-3c2bdf050797&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----3c2bdf050797---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----3c2bdf050797--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----3c2bdf050797--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----3c2bdf050797--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----3c2bdf050797--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----3c2bdf050797--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----3c2bdf050797--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----3c2bdf050797--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----3c2bdf050797--------------------------------", "anchor_text": ""}, {"url": "https://datamozart.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://datamozart.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Nikola Ilic"}, {"url": "https://datamozart.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "2.1K Followers"}, {"url": "http://data-mozart.com", "anchor_text": "data-mozart.com"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F64005b7daa38&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fisland-adventures-with-t-sql-window-functions-3c2bdf050797&user=Nikola+Ilic&userId=64005b7daa38&source=post_page-64005b7daa38--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F9fc5611a2826&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fisland-adventures-with-t-sql-window-functions-3c2bdf050797&newsletterV3=64005b7daa38&newsletterV3Id=9fc5611a2826&user=Nikola+Ilic&userId=64005b7daa38&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}