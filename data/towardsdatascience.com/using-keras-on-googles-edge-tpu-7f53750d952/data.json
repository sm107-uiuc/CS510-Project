{"url": "https://towardsdatascience.com/using-keras-on-googles-edge-tpu-7f53750d952", "time": 1683003292.1434329, "path": "towardsdatascience.com/using-keras-on-googles-edge-tpu-7f53750d952/", "webpage": {"metadata": {"title": "Using Keras On Google\u2019s Edge TPU. Using Keras is a great way to quickly\u2026 | by Lindo St. Angel | Towards Data Science", "h1": "Using Keras On Google\u2019s Edge TPU", "description": "How to use Keras models and TensorFlow Lite with the fast and efficient Google Coral Edge TPU to deploy inference at the edge."}, "outgoing_paragraph_urls": [{"url": "https://keras.io/", "anchor_text": "Keras", "paragraph_index": 0}, {"url": "https://github.com/tensorflow/tensorflow/tree/r1.13/tensorflow/contrib/quantize", "anchor_text": "quantization-aware training", "paragraph_index": 0}, {"url": "https://coral.ai/", "anchor_text": "Google Coral Edge TPU", "paragraph_index": 1}, {"url": "https://petewarden.com/2015/05/23/why-are-eight-bits-enough-for-deep-neural-networks/", "anchor_text": "Pete Warden\u2019s excellent blog", "paragraph_index": 2}, {"url": "https://github.com/goruck/smart-zoneminder", "anchor_text": "smart-zoneminder", "paragraph_index": 3}, {"url": "https://coral.ai/docs/edgetpu/models-intro/", "anchor_text": "documentation", "paragraph_index": 4}, {"url": "https://www.tensorflow.org/api_docs/python/tf/keras/applications/MobileNet", "anchor_text": "Mobilenet_v1", "paragraph_index": 4}, {"url": "https://www.tensorflow.org/api_docs/python/tf/keras/applications/MobileNetV2", "anchor_text": "Mobilenet_v2", "paragraph_index": 4}, {"url": "https://www.tensorflow.org/api_docs/python/tf/keras/applications/InceptionV3", "anchor_text": "Inception_v3", "paragraph_index": 4}, {"url": "https://www.tensorflow.org/api_docs/python/tf/keras/applications/ResNet50", "anchor_text": "ResNet50", "paragraph_index": 4}, {"url": "https://www.tensorflow.org/api_docs/python/tf/keras/applications/VGG16", "anchor_text": "tried VGG16", "paragraph_index": 4}, {"url": "https://www.tensorflow.org/api_docs/python/tf/keras/applications/InceptionResNetV2", "anchor_text": "InceptionResNetV2", "paragraph_index": 4}, {"url": "https://github.com/goruck/smart-zoneminder", "anchor_text": "smart-zoneminder", "paragraph_index": 4}, {"url": "https://keras.io/applications/", "anchor_text": "Keras documentation", "paragraph_index": 5}, {"url": "https://github.com/goruck/smart-zoneminder/blob/master/person-class/train.py", "anchor_text": "smart-zoneminder", "paragraph_index": 5}, {"url": "https://github.com/tensorflow/tensorflow/tree/r1.13/tensorflow/contrib/quantize", "anchor_text": "quantization-aware training", "paragraph_index": 6}, {"url": "https://www.tensorflow.org/lite/performance/post_training_quantization", "anchor_text": "TF Lite documentation", "paragraph_index": 6}, {"url": "https://github.com/goruck/smart-zoneminder/blob/master/person-class/train.py", "anchor_text": "Python train script", "paragraph_index": 6}, {"url": "https://github.com/goruck/smart-zoneminder", "anchor_text": "smart-zoneminder", "paragraph_index": 6}, {"url": "https://github.com/goruck/smart-zoneminder/blob/master/person-class/keras_to_tflite_quant.py", "anchor_text": "keras_to_tflite_quant", "paragraph_index": 7}, {"url": "https://stackoverflow.com/questions/54093424/why-is-tensorflow-lite-slower-than-tensorflow-on-desktop", "anchor_text": "thread", "paragraph_index": 7}, {"url": "https://coral.ai/docs/edgetpu/compiler/", "anchor_text": "Google Coral compiler", "paragraph_index": 8}, {"url": "https://github.com/goruck/smart-zoneminder/blob/master/person-class/train.py", "anchor_text": "Python train script", "paragraph_index": 8}, {"url": "https://github.com/goruck/smart-zoneminder", "anchor_text": "smart-zoneminder", "paragraph_index": 8}, {"url": "https://github.com/goruck/smart-zoneminder/blob/master/tpu-servers/evaluate_model.py", "anchor_text": "evaluate_model.py", "paragraph_index": 9}, {"url": "https://github.com/goruck/smart-zoneminder", "anchor_text": "smart-zoneminder", "paragraph_index": 9}, {"url": "https://coral.ai/docs/edgetpu/tflite-python/", "anchor_text": "documentation", "paragraph_index": 9}, {"url": "https://www.zerorpc.io/", "anchor_text": "zerorpc-based", "paragraph_index": 12}, {"url": "https://github.com/goruck/smart-zoneminder/blob/master/tpu-servers/detect_servers_tpu.py", "anchor_text": "inference server", "paragraph_index": 12}], "all_paragraphs": ["Using Keras is a great way to quickly understand and be productive using deep neural network models. Currently, the Keras API does not officially support quantization-aware training so it is not possible to use the API to directly produce a model for use on edge hardware optimized (that, for example, use only integer math) for inference. Inference on the edge versus the cloud can offer several advantages including reducing latency, lowering cloud costs and improved customer data privacy.", "This article covers the following steps so you can leverage the ease of using Keras models with the fast and efficient Google Coral Edge TPU.", "This article will not delve deeply into training Deep Neural Networks, the TF Lite or Keras APIs nor the theory behind model quantization. You can follow the various links provided to learn more about these topics. In addition, see Pete Warden\u2019s excellent blog. The article reflects that I am mostly an engineer and am more concerned about getting things to work well then spending a lot of time on theory.", "Please note that I developed much of this material for the smart-zoneminder project which helped me to better understand deep learning as I solved a practical problem at home \u2014 identifying if a person is a member of my family or a stranger. I\u2019ll use examples from the project to clarify some of this material as you can see below.", "According to Google Coral documentation only a few Keras models have been verified on the Edge TPU - Mobilenet_v1, Mobilenet_v2, Inception_v3 and ResNet50. I decided to use Mobilenet_v2, Inception_v3 and ResNet50 to confirm they do indeed work well on the Edge TPU. I also tried VGG16 and InceptionResNetV2 to see how well they performed in comparison. These models were perfect for my smart-zoneminder application since it needed a way to classify if a person is a member of my family or a stranger \u2014 an ideal use of these Convolutional Neural Networks (CNN) models. Choose a problem that is well solved by these models to use the edge hardware otherwise you\u2019ll be in uncharted territory as you try to map another type of network (that may use operators that can\u2019t be quantized by TF Lite) to the hardware.", "There are many good sources that show you how to fine-tune a Keras model on your own custom data set, such as the Keras documentation and smart-zoneminder. However, I found that using max pooling at the output of a Keras model will not compile for the Edge TPU because it has an operator (REDUCE_MAX) than cannot be currently quantized by TF Lite. So you will need to use average pooling (or none) like in the example below.", "Since the Keras models do not support quantization-aware training you need to use post-training quantization as described in the TF Lite documentation. The Python train script used in smart-zoneminder project will run the post-training quantization after the final training step of the Keras model as shown below.", "The keras_to_tflite_quant module quantizes the Keras model (in .h5 format) to a TF Lite 8-bit model. The script can also evaluate the quantized model\u2019s accuracy but inference of a TF Lite model is very slow on an Intel CPU(which I use for training along with an Nvidia GPU) because the current TF Lite operator kernels are optimized for ARM processors (using NEON instruction set). See this thread for more details and below for a feasible way to evaluate the quantized model on the Edge TPU.", "In the next step you need to compile the quantized TensorFlow Lite model for the Edge TPU using the Google Coral compiler. The The Python train script used in smart-zoneminder project will run the compiler as shown below.", "Your model will be impaired somewhat by quantization so you should check if its accuracy is still within the limits of what the application can tolerate. A quick way to do this is to use the quantized model on the TPU to run inferences on the training and validation data set that was used to develop the model. I used the Python script evaluate_model.py that\u2019s part of the smart-zoneminder project running on the Edge TPU for this purpose. The actual evaluation function from that script is shown below. See the Google Coral documentation for more information on how to run inference on the edge TPU using TF Lite.", "The output from the evaluate_model.py for Resnet50 is shown below. You can see the accuracy is 0.966 which is very close to the weighted average of the train and validation data set accuracy of 0.973. The quantization losses for this model are acceptable for my application.", "Overall, all the models I tested had acceptable quantized performance except for InceptionResNetV2 which had a quantized performance of only 0.855 vs a baseline of 0.980. Currently, it is not clear why this quantized model performs poorly.", "After you verify adequate model accuracy you can deploy it to run inferences in your application. smart-zoneminder uses a zerorpc-based inference server for this purpose.", "By careful selection and training of an Edge TPU-compatible Keras model, you can quickly deploy inference models to the edge. These models must be quantized to 8-bits first and then compiled for the Edge TPU. The quantization process will introduce accuracy errors in your model and should be evaluated for suitability in your application before being used in a production environment. Inference on the edge offers several advantages including reducing latency, lowering cloud costs and improved customer data privacy.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "High technology professional at Amazon creating amazing products and services customers love."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F7f53750d952&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-keras-on-googles-edge-tpu-7f53750d952&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-keras-on-googles-edge-tpu-7f53750d952&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-keras-on-googles-edge-tpu-7f53750d952&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-keras-on-googles-edge-tpu-7f53750d952&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----7f53750d952--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----7f53750d952--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@lindo.st.angel?source=post_page-----7f53750d952--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@lindo.st.angel?source=post_page-----7f53750d952--------------------------------", "anchor_text": "Lindo St. Angel"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fe03a0010d87d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-keras-on-googles-edge-tpu-7f53750d952&user=Lindo+St.+Angel&userId=e03a0010d87d&source=post_page-e03a0010d87d----7f53750d952---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F7f53750d952&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-keras-on-googles-edge-tpu-7f53750d952&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F7f53750d952&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-keras-on-googles-edge-tpu-7f53750d952&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@nateshipps?utm_source=medium&utm_medium=referral", "anchor_text": "Nathan Shipps"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://keras.io/", "anchor_text": "Keras"}, {"url": "https://github.com/tensorflow/tensorflow/tree/r1.13/tensorflow/contrib/quantize", "anchor_text": "quantization-aware training"}, {"url": "https://coral.ai/", "anchor_text": "Google Coral Edge TPU"}, {"url": "https://petewarden.com/2015/05/23/why-are-eight-bits-enough-for-deep-neural-networks/", "anchor_text": "Pete Warden\u2019s excellent blog"}, {"url": "https://github.com/goruck/smart-zoneminder", "anchor_text": "smart-zoneminder"}, {"url": "https://coral.ai/docs/edgetpu/models-intro/", "anchor_text": "documentation"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/keras/applications/MobileNet", "anchor_text": "Mobilenet_v1"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/keras/applications/MobileNetV2", "anchor_text": "Mobilenet_v2"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/keras/applications/InceptionV3", "anchor_text": "Inception_v3"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/keras/applications/ResNet50", "anchor_text": "ResNet50"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/keras/applications/VGG16", "anchor_text": "tried VGG16"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/keras/applications/InceptionResNetV2", "anchor_text": "InceptionResNetV2"}, {"url": "https://github.com/goruck/smart-zoneminder", "anchor_text": "smart-zoneminder"}, {"url": "https://keras.io/applications/", "anchor_text": "Keras documentation"}, {"url": "https://github.com/goruck/smart-zoneminder/blob/master/person-class/train.py", "anchor_text": "smart-zoneminder"}, {"url": "https://github.com/tensorflow/tensorflow/tree/r1.13/tensorflow/contrib/quantize", "anchor_text": "quantization-aware training"}, {"url": "https://www.tensorflow.org/lite/performance/post_training_quantization", "anchor_text": "TF Lite documentation"}, {"url": "https://github.com/goruck/smart-zoneminder/blob/master/person-class/train.py", "anchor_text": "Python train script"}, {"url": "https://github.com/goruck/smart-zoneminder", "anchor_text": "smart-zoneminder"}, {"url": "https://github.com/goruck/smart-zoneminder/blob/master/person-class/keras_to_tflite_quant.py", "anchor_text": "keras_to_tflite_quant"}, {"url": "https://stackoverflow.com/questions/54093424/why-is-tensorflow-lite-slower-than-tensorflow-on-desktop", "anchor_text": "thread"}, {"url": "https://coral.ai/docs/edgetpu/compiler/", "anchor_text": "Google Coral compiler"}, {"url": "https://github.com/goruck/smart-zoneminder/blob/master/person-class/train.py", "anchor_text": "Python train script"}, {"url": "https://github.com/goruck/smart-zoneminder", "anchor_text": "smart-zoneminder"}, {"url": "https://github.com/goruck/smart-zoneminder/blob/master/tpu-servers/evaluate_model.py", "anchor_text": "evaluate_model.py"}, {"url": "https://github.com/goruck/smart-zoneminder", "anchor_text": "smart-zoneminder"}, {"url": "https://coral.ai/docs/edgetpu/tflite-python/", "anchor_text": "documentation"}, {"url": "https://www.zerorpc.io/", "anchor_text": "zerorpc-based"}, {"url": "https://github.com/goruck/smart-zoneminder/blob/master/tpu-servers/detect_servers_tpu.py", "anchor_text": "inference server"}, {"url": "https://medium.com/tag/keras?source=post_page-----7f53750d952---------------keras-----------------", "anchor_text": "Keras"}, {"url": "https://medium.com/tag/tensorflow-lite?source=post_page-----7f53750d952---------------tensorflow_lite-----------------", "anchor_text": "Tensorflow Lite"}, {"url": "https://medium.com/tag/edge-computing?source=post_page-----7f53750d952---------------edge_computing-----------------", "anchor_text": "Edge Computing"}, {"url": "https://medium.com/tag/google-coral?source=post_page-----7f53750d952---------------google_coral-----------------", "anchor_text": "Google Coral"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----7f53750d952---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F7f53750d952&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-keras-on-googles-edge-tpu-7f53750d952&user=Lindo+St.+Angel&userId=e03a0010d87d&source=-----7f53750d952---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F7f53750d952&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-keras-on-googles-edge-tpu-7f53750d952&user=Lindo+St.+Angel&userId=e03a0010d87d&source=-----7f53750d952---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F7f53750d952&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-keras-on-googles-edge-tpu-7f53750d952&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----7f53750d952--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F7f53750d952&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-keras-on-googles-edge-tpu-7f53750d952&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----7f53750d952---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----7f53750d952--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----7f53750d952--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----7f53750d952--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----7f53750d952--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----7f53750d952--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----7f53750d952--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----7f53750d952--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----7f53750d952--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@lindo.st.angel?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@lindo.st.angel?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Lindo St. Angel"}, {"url": "https://medium.com/@lindo.st.angel/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "103 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fe03a0010d87d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-keras-on-googles-edge-tpu-7f53750d952&user=Lindo+St.+Angel&userId=e03a0010d87d&source=post_page-e03a0010d87d--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fb32de2b8dd33&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-keras-on-googles-edge-tpu-7f53750d952&newsletterV3=e03a0010d87d&newsletterV3Id=b32de2b8dd33&user=Lindo+St.+Angel&userId=e03a0010d87d&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}