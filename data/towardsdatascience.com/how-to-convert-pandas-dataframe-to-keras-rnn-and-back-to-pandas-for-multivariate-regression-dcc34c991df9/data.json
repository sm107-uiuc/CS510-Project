{"url": "https://towardsdatascience.com/how-to-convert-pandas-dataframe-to-keras-rnn-and-back-to-pandas-for-multivariate-regression-dcc34c991df9", "time": 1683011124.0723672, "path": "towardsdatascience.com/how-to-convert-pandas-dataframe-to-keras-rnn-and-back-to-pandas-for-multivariate-regression-dcc34c991df9/", "webpage": {"metadata": {"title": "How to Convert Pandas Dataframe to Keras RNN and Back to Pandas for Multivariate Regression Problems | by Ran Pelta | Towards Data Science", "h1": "How to Convert Pandas Dataframe to Keras RNN and Back to Pandas for Multivariate Regression Problems", "description": "The problem I encountered was rather common (I think): Taking data in a pandas dataframe format and making predictions using a time series regression model with keras RNN where I have more than one\u2026"}, "outgoing_paragraph_urls": [{"url": "https://stackoverflow.com/", "anchor_text": "StackOverflow", "paragraph_index": 5}, {"url": "https://machinelearningmastery.com/", "anchor_text": "Machine Learning Mastery", "paragraph_index": 5}, {"url": "https://machinelearningmastery.com/multivariate-time-series-forecasting-lstms-keras/", "anchor_text": "Multivariate Time Series Forecasting with LSTMs in Keras", "paragraph_index": 21}, {"url": "https://stackoverflow.com/questions/62876780/how-to-shape-test-data-in-keras-lstm-prediction-for-multivariate-inputs-and-depe?noredirect=1#comment111192708_62876780", "anchor_text": "StackOverflow", "paragraph_index": 31}], "all_paragraphs": ["The problem I encountered was rather common (I think): Taking data in a pandas dataframe format and making predictions using a time series regression model with keras RNN where I have more than one independent X (AKA features or predictors) and one dependent y. To be more precise, the problem was not to build the model, rather to convert the data from a pandas dataframe format to a format that an RNN model (in keras) requires and obtaining predictions from the keras model back as a pandas dataframe.", "It felt that wherever I looked for a solution I got explanations on how RNN works or solutions for uni-variate regression problem. Hence, I will try to keep this post as concise and focused as possible. The coding here assumes that you already did all the necessary preprocessing (e.g., data cleansing, feature engineering etc.) and have a ready-for-analysis time series in a pandas dataframe format.", "What you WILL NOT find here:", "\u00b7 Nice illustrations of an RNN model", "\u00b7 A complicated or sophisticated model", "There are many sources online that well explain these issues, I highly recommend to check the StackOverflow questions and Jason Brownlee\u2019s, Machine Learning Mastery blog post.", "\u00b7 A straightforward Python code that takes a pandas dataframe and outputs predictions in the same format using a keras RNN LSTM model for multivariate regression problems.", "This post will describe snippets of code with explanations and a full seamless code will be provided at the end.", "Step 1, let\u2019s import all needed packages and check the keras version", "As you can see, my keras version is 2.3.1, so if you have some problems with the code I post here, please check that you have the same version or a higher one.", "As you can see, I have 32,128 rows and four columns, with one y and three X. The code here can work on any number of X including just one X. Note that you need to define your y column in order to make things easier and more generic.", "Optional step \u2014 plot the data", "I know, the resolution is not great here but you get the idea of how my data looks like.", "Step 3, split the data to train and test", "Please note here the comment in line #3. Let\u2019s plot again to see if our split makes sense.", "Again, don\u2019t mind the resolution, it\u2019s not important. The plot looks good, the past (blue) is our training data and recent dates are our test data (orange).", "Step 4, separate X and y only for the training data. We will handle the test data later.", "Now, the X_train looks like this:", "and the y_train looks like this:", "Step 5, scale and prepare X and y data for keras", "This part requires some explanations. Here we convert the data from pandas dataframe to numpy arrays which is required by keras. In line 1\u20138 we first scale X and y using the sklearn MinMaxScaler model, so that their range will be from 0 to 1. The next lines are some shape manipulation to the y in order to make it applicable for keras. We need the shape of y to be (n, ), where n is the number of rows. Line 12 \u201cpushes\u201d the y data one step forward by adding zero in the first position and line 13 keeps the shape of y by deleting the last time step (last row). Here is a simplified example of what happens in line 12\u201313:", "If this is explanation is not clear enough, I refer you to Jason Brownlee\u2019s blog post Multivariate Time Series Forecasting with LSTMs in Keras. Look for the section with the title: Multivariate Inputs and Dependent Series Example.", "To sum up the shape manipulation of y let\u2019s have a quick look on what happened. We started with y data as a dataframe:", "And now it should look like this:", "Step 6, combine X and y using the keras TimeseriesGenerator", "The TimeseriesGenerator transforms the separate X and y into a structure of samples ready to train deep learning models. I would recommend to print the shape of the generator object to make sure it worked. The shape should be (batch_size,n_input,n_features)exactly how it shows in step 6 in line 8.", "The hard part of converting our data from pandas dataframe to something ready to use for deep learning models is behind us. Now we can move on to step 7, instantiate the model:", "Note that I used here a very simple model, with only one hidden layer and without a dropout layer. This is because I wanted to keep this post concise and the actual model architecture is not the focus here. But feel free to experiment with more layers.", "Step 8, fit the model and plot the losses", "Also here, I used simple settings, only 5 epochs, just to illustrate the entire process.", "Now the model is ready to use and we can make predictions on the test set.", "The first line generates the X_test data by dropping the y from the test set, we do not want the y data to be included in the X. Then we scale the X_test according to the MinMaxScaler model which was fitted on the X_train earlier. Line 3 is important because we need to create a TimeseriesGenerator for the test data. I was struggling with this part because in the examples that I saw the y_test was included in here , but I do not want the model to have any knowledge whatsoever about the y_test data. I did not want the slightest chance of data leakage that will result in bias predictions. Thanks to a great help I received from Marco Cerliani on StackOverflow I understood that the second argument in the TimeseriesGenerator, which is the y_test is just a prediction method and that the actual values of the y_test don\u2019t matter (in this specific place), so you can insert a dummy y_test \u2192 an array of zeros that has the same shape of the actual y_test data. The rest of the TimeseriesGenerator is similar to the training data, and also here I printed the shape to make sure it\u2019s OK.", "Line 10 calls the predict method and line 11 rescales the predictions. Remember that we earlier scaled the y data between 0 and 1, so we need to scale it back. In line 12 we construct a dataframe from y_true and y_pred. Note that we only call for a subset of y_true (test[y_col].values[n_input:]), this is because the model needs n_input timesteps (rows or observations) to start predict, so it takes these n_input (in this case 25 timesteps) from X_test and only then start to predict. For example, if we had 50 timesteps in our test set (or 50 rows or observations), then we will have only 25 predictions because the first 25 were used by the model according to its architecture that we set.", "Now we have our results in a nice pandas dataframe structure:", "And we can plot them using results.plot();:", "That\u2019s it, we began with data in a pandas dataframe format and finished with predictions in the same format.", "That\u2019s the entire code in one block", "I hope this is useful and will help you in your machine learning missions. Please write me below if you have any comments.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "PhD | Remote Sensing | Data Scientist"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fdcc34c991df9&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-convert-pandas-dataframe-to-keras-rnn-and-back-to-pandas-for-multivariate-regression-dcc34c991df9&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-convert-pandas-dataframe-to-keras-rnn-and-back-to-pandas-for-multivariate-regression-dcc34c991df9&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-convert-pandas-dataframe-to-keras-rnn-and-back-to-pandas-for-multivariate-regression-dcc34c991df9&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-convert-pandas-dataframe-to-keras-rnn-and-back-to-pandas-for-multivariate-regression-dcc34c991df9&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----dcc34c991df9--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----dcc34c991df9--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@ranpelta?source=post_page-----dcc34c991df9--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@ranpelta?source=post_page-----dcc34c991df9--------------------------------", "anchor_text": "Ran Pelta"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fd11771749e5d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-convert-pandas-dataframe-to-keras-rnn-and-back-to-pandas-for-multivariate-regression-dcc34c991df9&user=Ran+Pelta&userId=d11771749e5d&source=post_page-d11771749e5d----dcc34c991df9---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fdcc34c991df9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-convert-pandas-dataframe-to-keras-rnn-and-back-to-pandas-for-multivariate-regression-dcc34c991df9&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fdcc34c991df9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-convert-pandas-dataframe-to-keras-rnn-and-back-to-pandas-for-multivariate-regression-dcc34c991df9&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://stackoverflow.com/", "anchor_text": "StackOverflow"}, {"url": "https://machinelearningmastery.com/", "anchor_text": "Machine Learning Mastery"}, {"url": "https://machinelearningmastery.com/multivariate-time-series-forecasting-lstms-keras/", "anchor_text": "Multivariate Time Series Forecasting with LSTMs in Keras"}, {"url": "https://stackoverflow.com/questions/62876780/how-to-shape-test-data-in-keras-lstm-prediction-for-multivariate-inputs-and-depe?noredirect=1#comment111192708_62876780", "anchor_text": "StackOverflow"}, {"url": "https://medium.com/tag/time-series-forecasting?source=post_page-----dcc34c991df9---------------time_series_forecasting-----------------", "anchor_text": "Time Series Forecasting"}, {"url": "https://medium.com/tag/keras?source=post_page-----dcc34c991df9---------------keras-----------------", "anchor_text": "Keras"}, {"url": "https://medium.com/tag/python?source=post_page-----dcc34c991df9---------------python-----------------", "anchor_text": "Python"}, {"url": "https://medium.com/tag/multivariate-regression?source=post_page-----dcc34c991df9---------------multivariate_regression-----------------", "anchor_text": "Multivariate Regression"}, {"url": "https://medium.com/tag/predictions?source=post_page-----dcc34c991df9---------------predictions-----------------", "anchor_text": "Predictions"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fdcc34c991df9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-convert-pandas-dataframe-to-keras-rnn-and-back-to-pandas-for-multivariate-regression-dcc34c991df9&user=Ran+Pelta&userId=d11771749e5d&source=-----dcc34c991df9---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fdcc34c991df9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-convert-pandas-dataframe-to-keras-rnn-and-back-to-pandas-for-multivariate-regression-dcc34c991df9&user=Ran+Pelta&userId=d11771749e5d&source=-----dcc34c991df9---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fdcc34c991df9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-convert-pandas-dataframe-to-keras-rnn-and-back-to-pandas-for-multivariate-regression-dcc34c991df9&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----dcc34c991df9--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fdcc34c991df9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-convert-pandas-dataframe-to-keras-rnn-and-back-to-pandas-for-multivariate-regression-dcc34c991df9&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----dcc34c991df9---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----dcc34c991df9--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----dcc34c991df9--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----dcc34c991df9--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----dcc34c991df9--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----dcc34c991df9--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----dcc34c991df9--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----dcc34c991df9--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----dcc34c991df9--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@ranpelta?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@ranpelta?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Ran Pelta"}, {"url": "https://medium.com/@ranpelta/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "17 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fd11771749e5d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-convert-pandas-dataframe-to-keras-rnn-and-back-to-pandas-for-multivariate-regression-dcc34c991df9&user=Ran+Pelta&userId=d11771749e5d&source=post_page-d11771749e5d--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F2265fee53702&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-convert-pandas-dataframe-to-keras-rnn-and-back-to-pandas-for-multivariate-regression-dcc34c991df9&newsletterV3=d11771749e5d&newsletterV3Id=2265fee53702&user=Ran+Pelta&userId=d11771749e5d&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}