{"url": "https://towardsdatascience.com/how-to-batch-correct-single-cell-7bad210c7ae1", "time": 1683000250.6621041, "path": "towardsdatascience.com/how-to-batch-correct-single-cell-7bad210c7ae1/", "webpage": {"metadata": {"title": "How to Batch Correct Single Cell. Comparing batch correction methods for\u2026 | by Nikolay Oskolkov | Towards Data Science", "h1": "How to Batch Correct Single Cell", "description": "This is the eleventh post in the column Mathematical Statistics and Machine Learning for Life Sciences where I try to cover analytical techniques common for Bioinformatics, Biomedicine, Genetics\u2026"}, "outgoing_paragraph_urls": [{"url": "https://towardsdatascience.com/tagged/stats-ml-life-sciences?source=post_page---------------------------", "anchor_text": "Mathematical Statistics and Machine Learning for Life Sciences", "paragraph_index": 0}, {"url": "https://en.wikipedia.org/wiki/Single_cell_sequencing", "anchor_text": "scRNAseq", "paragraph_index": 0}, {"url": "https://towardsdatascience.com/how-to-normalize-single-cell-a438281ea654", "anchor_text": "comparing normalization strategies", "paragraph_index": 0}, {"url": "https://www.nature.com/articles/ni.3368", "anchor_text": "\u00c5. Bj\u00f6rklund et al., Nature Immunology 17, p. 451\u2013460 (2016)", "paragraph_index": 2}, {"url": "https://github.com/NikolayOskolkov/HowToBatchCorrectSingleCell", "anchor_text": "github", "paragraph_index": 2}, {"url": "https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3307112/", "anchor_text": "SVA", "paragraph_index": 5}, {"url": "https://www.ncbi.nlm.nih.gov/pubmed/16632515", "anchor_text": "Combat", "paragraph_index": 5}, {"url": "https://bioconductor.org/packages/release/bioc/html/limma.html", "anchor_text": "Limma", "paragraph_index": 6}, {"url": "https://www.nature.com/articles/nbt.4091.pdf", "anchor_text": "Mutual Nearest Neighbors (MNN)", "paragraph_index": 7}, {"url": "https://en.wikipedia.org/wiki/K-nearest_neighbors_algorithm", "anchor_text": "K-Nearest Neighbors (KNN)", "paragraph_index": 7}, {"url": "https://www.nature.com/articles/nbt.4096.pdf", "anchor_text": "Seurat Canonical Correlation Analysis (CCA)", "paragraph_index": 9}, {"url": "https://towardsdatascience.com/supervised-omics-integration-2158e1a6d23f", "anchor_text": "PLS data integration", "paragraph_index": 9}, {"url": "https://en.wikipedia.org/wiki/Dynamic_time_warping", "anchor_text": "Dynamic Time Warping (DTW)", "paragraph_index": 9}, {"url": "https://www.nature.com/articles/nmeth.4644", "anchor_text": "SCMAP", "paragraph_index": 10}, {"url": "https://www.humancellatlas.org/", "anchor_text": "the Human Cell Atlas", "paragraph_index": 10}, {"url": "https://github.com/NikolayOskolkov/HowToBatchCorrectSingleCell", "anchor_text": "github", "paragraph_index": 12}, {"url": "https://en.wikipedia.org/wiki/Occam's_razor", "anchor_text": "Occam\u2019s Razor", "paragraph_index": 13}, {"url": "https://github.com/NikolayOskolkov/HowToBatchCorrectSingleCell", "anchor_text": "github", "paragraph_index": 16}, {"url": "https://medium.com/u/8570b484f56c?source=post_page-----7bad210c7ae1--------------------------------", "anchor_text": "Nikolay Oskolkov", "paragraph_index": 16}, {"url": "http://linkedin.com/in/nikolay-oskolkov-abb321186?source=post_page---------------------------", "anchor_text": "Linkedin", "paragraph_index": 16}, {"url": "https://umap-learn.readthedocs.io/en/latest/", "anchor_text": "UMAP", "paragraph_index": 16}], "all_paragraphs": ["This is the eleventh post in the column Mathematical Statistics and Machine Learning for Life Sciences where I try to cover analytical techniques common for Bioinformatics, Biomedicine, Genetics, Evolution etc. In one of my previous posts, I started covering methods of removing technical variation in scRNAseq data by comparing normalization strategies. Here I am going to expand on the topic and talk about correcting systematic differences between same type of cells sequenced by different technologies, labs, protocols etc, i.e. batch-effects detection and elimination.", "Batch-effects have a danger to confound the true biological signal, which is the discovery of the cell types present in a sample for the case of scRNAseq. Batches can originate from: different dates of sequencing, people doing the sequencing, flow-cells / plates, chemistry / protocol, lanes, read length, labs produced the data or even different organisms as the extreme case scenario.", "Batch-effects can be genome-wide, i.e. present for majority of genes, or gene-specific, i.e. certain genes happen to be influenced by the batch. The former is very easy to see from the dimension reduction plots like PCA or tSNE. Here for demonstration purposes I will continue using the innate lymphoid cells (ILC) scRNAseq data set from \u00c5. Bj\u00f6rklund et al., Nature Immunology 17, p. 451\u2013460 (2016). Below I compute the PCA and tSNE dimensionality reduction plots for the ILC cells from three donors, for details please check the complete notebook on my github.", "The donor-specific batch is clearly visible from the plots, i.e. the cells from the same donor tend to cluster together and distinctly from the cells coming from other donors. To further quantify, let us display how much of variation in each Principal Component (PC) is explained by the Donor, Plate and Cell Type.", "From the heatmap above it follows that 44% of PC1 is explained by the Donor batch while the Cell Type contribution is negligible, therefore we have a severe genome-wide Donor related batch effect. However, what if we did not observe any clustering by Donor at the dimension reduction plots above, does it mean that there are no batch-effects present in our data set? No it does not. Certain genes might still have their variation to a large extent due to the batch and not the cell type. We can rank all genes influenced by the batch by correlating their expression with the Donor variable. From the left figure below we observe that there are genes with > 20% of their variation due to the Donor batch. To assess whether this number is a lot or a little we shuffle the batch variable (or alternatively the gene expression) a number of times and calculate the noise zone, i.e. variation in gene expression due to a random variable. We can also do a formal statistical test and calculate a p-value of significance of deviation from the noise zone (right figure below). In this way, we end up with a list of approximately 200 genes which are significantly influenced by the batch, those genes are good to keep an eye on for the further downstream analysis.", "Once we have detected the batch-effects in our data, we can apply multiple batch correction algorithms available. I do not recommend unsupervised correction similar to SVA for scRNAseq data, because scRNAseq analysis is also unsupervised with not known ground truth (cell types), thus removing the surrogate variables approximating the batch may damage the biological signal. For supervised batch correction, i.e. when the batch is known a-priori, a simple linear correction with the Combat method would be a good start.", "Combat performs batch correction through the Bayesian linear regression and therefore offers a considerable improvement compared to the simple aka Frequentist linear batch removal implemented e.g. in Limma. Besides better performance for small sample sizes, Combat uses the Bayesian shrinkage towards the mean, this implies that correcting each gene we use a \u201cmean\u201d information from other genes while Limma does the correction gene-by-gene independently. Nevertheless, Combat applies a linear batch-effect correction.", "Mutual Nearest Neighbors (MNN) algorithm uses a non-linear batch-effect correction inspired by the idea from K-Nearest Neighbors (KNN). The method tries to find most similar cells (mutual neighbors) between the batches, those cells are assumed to belong to the same type and the systematic differences between the MNN cells quantify the strength of the batch, this information is used to scale the rest of the cells in the batches.", "My general problem with this method is that I always failed to understand the assumption that the MNN cells should belong to the same type. My intuition is that a batch can completely mess up the concept of distance between the cells in the batches, so two cells that are closest neighbors between the batches can actually belong to different cell types but seem to be very similar because of the batch itself. Nevertheless, the MNN batch-effect correction seems to work well in practice and we will see later that it does a good job on our benchmark.", "Another popular scRNAseq specific batch correction method which sometimes is seen as an across samples integration is the Seurat Canonical Correlation Analysis (CCA) technique. The concept of CCA is very similar to the PLS data integration which I described in one of my previous posts. The data from the batches are projected into a low-dimensional space by maximizing correlation (or covariance) between the data sets from different batches. This implies that the projections of the data sets are correlated but not necessarily aligned, i.e. do not overlap quite well in the low-dimensional space. The latter is solved by applying the Dynamic Time Warping (DTW) technique that locally stretches and squeezes the CCA data projections in order to further align them.", "While Combat, MNN and Seurat CCA seek to transform the data in order to merge the sub-sets from different batches, SCMAP algorithm tries to project the query cells onto a reference data set, that might be e.g. the Human Cell Atlas, without actually producing a single corrected data set.", "SCMAP uses a KNN classifier for finding correspondence between tested cells and a presumably much bigger reference data set which was used for training the classifier.", "How do these methods work in practice? We will use the ILC scRNAseq data set in order to run them and try to remove the Donor related batch effect and thus harmonize the cells between the batches. The complete notebook can be found at the github, here I only present the final comparison tSNE plots:", "Looking at the tSNE plots above, I would say that all the methods have done a good job by well mixing the cells from different donors. Following the Occam\u2019s Razor principle, I think the performance of the simplest Combat is satisfactory enough while being super easy to understand and program.", "Interestingly, when training the SCMAP classifier on two donors as a reference and projecting the cells from the third donor on the the reference resulted in a poor cell assignment / classification accuracy of 84% taking into account that about the half of the cells could not be reliably assigned to any cluster at all. This might be due to the training set was not big enough or the data did not satisfy the spherical symmetry that is crucial for the KNN classifier.", "In this post, we have learnt that batch-effects represent a technical variation which might confound the biological signal in scRNaseq analyses. These effects can be detected in genome-wide or gene-specific way and corrected using linear (Combat) or non-linear (MNN, Seurat CCA, SCMAP) algorithms. Overall, the batch correction methods work well on benchmarks suggesting that the simplest (Combat) model should be prioritized.", "In the comments below let me know which analyses in Life Sciences seem especially mysterious to you and I will try to address them in this column. Check the codes from the post on my github. Follow me at Medium Nikolay Oskolkov, in Twitter @NikolayOskolkov and connect in Linkedin. Next time we will cover how exactly UMAP works, stay tuned.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F7bad210c7ae1&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-batch-correct-single-cell-7bad210c7ae1&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-batch-correct-single-cell-7bad210c7ae1&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-batch-correct-single-cell-7bad210c7ae1&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-batch-correct-single-cell-7bad210c7ae1&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----7bad210c7ae1--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----7bad210c7ae1--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://nikolay-oskolkov.medium.com/?source=post_page-----7bad210c7ae1--------------------------------", "anchor_text": ""}, {"url": "https://nikolay-oskolkov.medium.com/?source=post_page-----7bad210c7ae1--------------------------------", "anchor_text": "Nikolay Oskolkov"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F8570b484f56c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-batch-correct-single-cell-7bad210c7ae1&user=Nikolay+Oskolkov&userId=8570b484f56c&source=post_page-8570b484f56c----7bad210c7ae1---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F7bad210c7ae1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-batch-correct-single-cell-7bad210c7ae1&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F7bad210c7ae1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-batch-correct-single-cell-7bad210c7ae1&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://towardsdatascience.com/tagged/stats-ml-life-sciences", "anchor_text": "Mathematical Statistics and Machine Learning for Life Sciences"}, {"url": "https://www.nature.com/articles/nbt.4096", "anchor_text": "image source"}, {"url": "https://towardsdatascience.com/tagged/stats-ml-life-sciences?source=post_page---------------------------", "anchor_text": "Mathematical Statistics and Machine Learning for Life Sciences"}, {"url": "https://en.wikipedia.org/wiki/Single_cell_sequencing", "anchor_text": "scRNAseq"}, {"url": "https://towardsdatascience.com/how-to-normalize-single-cell-a438281ea654", "anchor_text": "comparing normalization strategies"}, {"url": "https://www.nature.com/articles/ni.3368", "anchor_text": "\u00c5. Bj\u00f6rklund et al., Nature Immunology 17, p. 451\u2013460 (2016)"}, {"url": "https://github.com/NikolayOskolkov/HowToBatchCorrectSingleCell", "anchor_text": "github"}, {"url": "https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3307112/", "anchor_text": "SVA"}, {"url": "https://www.ncbi.nlm.nih.gov/pubmed/16632515", "anchor_text": "Combat"}, {"url": "https://bioconductor.org/packages/release/bioc/html/limma.html", "anchor_text": "Limma"}, {"url": "https://www.nature.com/articles/nbt.4091.pdf", "anchor_text": "Mutual Nearest Neighbors (MNN)"}, {"url": "https://en.wikipedia.org/wiki/K-nearest_neighbors_algorithm", "anchor_text": "K-Nearest Neighbors (KNN)"}, {"url": "https://www.nature.com/articles/nbt.4091.pdf", "anchor_text": "Haghverdi et al., Nat. Biot. 36, 2018"}, {"url": "https://www.nature.com/articles/nbt.4096.pdf", "anchor_text": "Seurat Canonical Correlation Analysis (CCA)"}, {"url": "https://towardsdatascience.com/supervised-omics-integration-2158e1a6d23f", "anchor_text": "PLS data integration"}, {"url": "https://en.wikipedia.org/wiki/Dynamic_time_warping", "anchor_text": "Dynamic Time Warping (DTW)"}, {"url": "https://www.nature.com/articles/nbt.4096.pdf", "anchor_text": "Butler et al., Nat. Biot. 36, 2018"}, {"url": "https://www.nature.com/articles/nmeth.4644", "anchor_text": "SCMAP"}, {"url": "https://www.humancellatlas.org/", "anchor_text": "the Human Cell Atlas"}, {"url": "https://www.nature.com/articles/nmeth.4644", "anchor_text": "Kiselev et al., Nat. Met. 15, 2018"}, {"url": "https://github.com/NikolayOskolkov/HowToBatchCorrectSingleCell", "anchor_text": "github"}, {"url": "https://en.wikipedia.org/wiki/Occam's_razor", "anchor_text": "Occam\u2019s Razor"}, {"url": "https://github.com/NikolayOskolkov/HowToBatchCorrectSingleCell", "anchor_text": "github"}, {"url": "https://medium.com/u/8570b484f56c?source=post_page-----7bad210c7ae1--------------------------------", "anchor_text": "Nikolay Oskolkov"}, {"url": "http://linkedin.com/in/nikolay-oskolkov-abb321186?source=post_page---------------------------", "anchor_text": "Linkedin"}, {"url": "https://umap-learn.readthedocs.io/en/latest/", "anchor_text": "UMAP"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----7bad210c7ae1---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/data-science?source=post_page-----7bad210c7ae1---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/towards-data-science?source=post_page-----7bad210c7ae1---------------towards_data_science-----------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/tag/stats-ml-life-sciences?source=post_page-----7bad210c7ae1---------------stats_ml_life_sciences-----------------", "anchor_text": "Stats Ml Life Sciences"}, {"url": "https://medium.com/tag/bioinformatics?source=post_page-----7bad210c7ae1---------------bioinformatics-----------------", "anchor_text": "Bioinformatics"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F7bad210c7ae1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-batch-correct-single-cell-7bad210c7ae1&user=Nikolay+Oskolkov&userId=8570b484f56c&source=-----7bad210c7ae1---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F7bad210c7ae1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-batch-correct-single-cell-7bad210c7ae1&user=Nikolay+Oskolkov&userId=8570b484f56c&source=-----7bad210c7ae1---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F7bad210c7ae1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-batch-correct-single-cell-7bad210c7ae1&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----7bad210c7ae1--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F7bad210c7ae1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-batch-correct-single-cell-7bad210c7ae1&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----7bad210c7ae1---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----7bad210c7ae1--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----7bad210c7ae1--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----7bad210c7ae1--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----7bad210c7ae1--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----7bad210c7ae1--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----7bad210c7ae1--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----7bad210c7ae1--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----7bad210c7ae1--------------------------------", "anchor_text": ""}, {"url": "https://nikolay-oskolkov.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://nikolay-oskolkov.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Nikolay Oskolkov"}, {"url": "https://nikolay-oskolkov.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "3.1K Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F8570b484f56c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-batch-correct-single-cell-7bad210c7ae1&user=Nikolay+Oskolkov&userId=8570b484f56c&source=post_page-8570b484f56c--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Ff4a74ad409c6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-batch-correct-single-cell-7bad210c7ae1&newsletterV3=8570b484f56c&newsletterV3Id=f4a74ad409c6&user=Nikolay+Oskolkov&userId=8570b484f56c&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}