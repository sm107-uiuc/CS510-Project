{"url": "https://towardsdatascience.com/testing-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3", "time": 1683003231.032674, "path": "towardsdatascience.com/testing-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3/", "webpage": {"metadata": {"title": "Testing, profiling, and optimizing NLP models with Pytest, Cython, and spaCy | by Ray Johns | Towards Data Science", "h1": "Testing, profiling, and optimizing NLP models with Pytest, Cython, and spaCy", "description": "I read a blog post that claimed to have profiled spaCy and NLTK for natural-language data preprocessing, and to have found NLTK far faster. NLTK is the Jeep Grand Cherokee of natural language\u2026"}, "outgoing_paragraph_urls": [{"url": "https://tahirnaeem.net/performance-comparison-of-nlp-libraries-in-text-tokenization", "anchor_text": "blog post", "paragraph_index": 0}, {"url": "http://nltk.org", "anchor_text": "NLTK", "paragraph_index": 1}, {"url": "https://spacy.io", "anchor_text": "SpaCy", "paragraph_index": 2}, {"url": "https://cython.org", "anchor_text": "Cython", "paragraph_index": 8}, {"url": "https://realpython.com/introduction-to-python-generators/", "anchor_text": "generator objects", "paragraph_index": 20}, {"url": "https://github.com/explosion/spaCy/blob/master/spacy/tokens/doc.pyx", "anchor_text": "a Doc object", "paragraph_index": 27}, {"url": "https://course.spacy.io/", "anchor_text": "Advanced NLP with Spacy", "paragraph_index": 28}], "all_paragraphs": ["I read a blog post that claimed to have profiled spaCy and NLTK for natural-language data preprocessing, and to have found NLTK far faster.", "NLTK is the Jeep Grand Cherokee of natural language processing toolkits: it\u2019s huge, it\u2019s been around for a long time, it\u2019s got a lot of power, but it\u2019s slow and takes a lot of gas.", "SpaCy is the Lamborghini Aventador. It may not be a tank with all the bells and whistles, but it\u2019s sleek, stripped down to bare metal. What it does, it does fast. And with its high horsepower comes the risk (and fun) of taking too hard a turn while speeding down a winding course and fishtailing right off the road.", "So, this claim struck me as outlandish:", "Spacy is way, way slower than NLTK. NLTK took barely 2 seconds to tokenize the 7 MB text sample while Spacy took whooping 3 minutes!", "If you write your pipeline correctly, and your hardware has decent memory, there is no way this can happen.", "I primarily work in research engineering \u2014 my job is to make the models, not build software architecture. So why care about your code performance if you just want to build chatbots and search engines?", "If you\u2019re interested in building the best model for the data, you can\u2019t consider the machine learning model apart from the code quality.", "SpaCy\u2019s paint job is Python, but the engine is Cython. Cython is like a creole language \u2014 part Python, part c. It is a superset of Python (all valid Python is valid Cython), but it includes faster, more complex features from c.", "For certain use cases, Cython is a great speed-enhancing tool \u2014 for instance, computing lots of numerical results whose outcomes are contingent on a series of if-statements. Usually you\u2019d use numpy to speed up computation, but numpy is good at vectorizing code \u2014 doing the same thing to every element. When we want to do a different thing to each element, Cython lets us use that same c optimization, but with the added logical complexity.", "SpaCy makes extensive use of cythonization out of the box, making it a very fast NLP framework in comparison to many other Python libraries.", "Let\u2019s go back to the blog that thought spaCy was slower than NLTK.", "When I ran my versions of NLTK and spaCy text cleaners on the same documents using line_profiler, employing an apples-to-apples comparison, NLTK took 5.5 times as long as spaCy to do substantially similar work.", "TL;DR: NLTK is 5.5 times slower than spaCy when used in a comparable NLP pipeline on the same data.", "What was different in my code? To begin with, I studied the architecture of both these systems inside and out, including:", "To get a meaningful comparison, you need to know that spaCy is doing a lot more than NLTK is in the referenced code. By default, the spaCy pipeline includes tokenization, lemmatization, part of speech tagging, dependency parsing, and named entity recognition. It does all of that (and more) every time you call nlp(doc).", "By contrast, NLTK (in the referenced code) is only tokenizing and lowercasing the corpus.", "Comparing those two pipelines against each other is absurd.", "This still isn\u2019t a perfect one-to-one comparison, but it\u2019s a lot closer.", "I wrote two versions of the spaCy pipeline, to reflect how I see people using nlp.pipe in the wild. The first is list(nlp.pipe(docs)). The second, more efficient way, is to use nlp.pipe(docs) as the generator object that it is.", "This distinction matters, because unlike Python lists, generator objects do not hold the entire corpus in memory at the same time. That means you can iteratively modify, extract content from, or write chunks of the corpus to a database. In NLP, this comes up a lot, because corpora are often very large \u2014 too large to hold in memory all at once.", "Testing my three pipelines (with NLTK, spaCy-as-list, and spaCy-as-generator) on the same Reddit corpus (n=15000), here are the results according to line_profiler:", "Results of profiling can be found here as *_reddit_2.txt", "Using spaCy, without even writing your own Cython, speeds up your code more than 5x.", "This makes sense \u2014 NLTK isn\u2019t optimizing with Cython, and when it tags and lemmatizes tokens, it uses more time-expensive operations than spaCy\u2019s.", "As with any code, spaCy will be slow if you don\u2019t understand its data structures and how to wield them responsibly.", "Read the source code. SpaCy relies on two main things to run fast: Cython\u2019s c internals and Python generators. Because of this, it uses complex classes and data pipelines that mean the types and methods of its objects aren\u2019t always immediately apparent.", "For example, when you call nlp on a text to get a Doc object, spaCy generates c code to process your data. While you can use ordinary commands like bracket notation for indexing to interact with the resulting Doc, they don\u2019t work the same as base Python. Rather, the Doc class overloads Python operators to let you interact with a struct as though it were a Python object.", "The only way to really know this is to read the source code. The documentation won\u2019t spell it out for you. Apart from working through the Advanced NLP with Spacy tutorial, there\u2019s no other way to really learn the ropes.", "Getting comfortable reading source code will vastly improve your programming literacy and your data pipelines.", "Have a plan. Make sure you have outlined the steps of your pipeline in doodles and pseudocode before you start writing it. Having a thought-out plan will help you think about how best to chain together different functions. You\u2019ll see efficiencies in the data, ways to group functions and variables together to speed things up, and how to cast your data for ease of flow.", "Before you start cythonizing everything, though, make sure you\u2019ve profiled your code and cleaned up your Python. Even pure Python libraries like gensim can be extremely fast and memory-efficient, because they\u2019ve scrupulously tightened up their data structures and pipelines.", "Thinking this way takes a little more architecting of your model, but it\u2019s worth it to avoid waiting half an hour for your docs to process. Take the time to think through the logical structure of your model, write tests, and reflect on the output of the profiler to avoid doing sloppy science in the name of instant gratification. Anyone can make a bag of words; the finesse and nuance of NLP lie in the detail work.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Opinions are my own. Machine Learning, AI, Linguistics, NLP with Deep Learning | { B.A. : Dartmouth; J.D. : Yale; M.S. : Simmons; CS Graduate Courses: Stanford}"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fa78a8397f9f3&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftesting-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftesting-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftesting-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftesting-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----a78a8397f9f3--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----a78a8397f9f3--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@rayljohns?source=post_page-----a78a8397f9f3--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@rayljohns?source=post_page-----a78a8397f9f3--------------------------------", "anchor_text": "Ray Johns"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F304c3bcee737&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftesting-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3&user=Ray+Johns&userId=304c3bcee737&source=post_page-304c3bcee737----a78a8397f9f3---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fa78a8397f9f3&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftesting-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fa78a8397f9f3&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftesting-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://towardsdatascience.com/testing-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3#921a", "anchor_text": "Why you should care about profiling NLP models"}, {"url": "https://towardsdatascience.com/testing-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3#6609", "anchor_text": "Why spaCy is faster than NLTK"}, {"url": "https://towardsdatascience.com/testing-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3#4ce4", "anchor_text": "What\u2019s really going on when you call nlp(doc)?"}, {"url": "https://towardsdatascience.com/testing-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3#1892", "anchor_text": "Setting up the model testing"}, {"url": "https://towardsdatascience.com/testing-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3#38bb", "anchor_text": "The verdict: which one wins for speed"}, {"url": "https://towardsdatascience.com/testing-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3#8b36", "anchor_text": "Best practices for writing text processing pipelines"}, {"url": "https://towardsdatascience.com/testing-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3#647d", "anchor_text": "A suggested workflow for NLP optimization"}, {"url": "https://towardsdatascience.com/testing-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3#373e", "anchor_text": "Resources and code repository"}, {"url": "https://tahirnaeem.net/performance-comparison-of-nlp-libraries-in-text-tokenization", "anchor_text": "blog post"}, {"url": "https://giphy.com/gifs/latelateshow-what-confused-5t9wJjyHAOxvnxcPNk", "anchor_text": "giphy"}, {"url": "http://nltk.org", "anchor_text": "NLTK"}, {"url": "https://spacy.io", "anchor_text": "SpaCy"}, {"url": "https://giphy.com/gifs/3ohc1eTesPXxSRVwNq/html5", "anchor_text": "giphy"}, {"url": "https://cython.org", "anchor_text": "Cython"}, {"url": "https://github.com/lorarjohns/nlp_profiling/blob/master/scripts/profiling_spacy.py", "anchor_text": "lorarjohns/nlp_profilingA script for comparing the pipelines to each other.github.com"}, {"url": "https://realpython.com/introduction-to-python-generators/", "anchor_text": "generator objects"}, {"url": "https://giphy.com/gifs/iJDLBX5GY8niCpZYkR/html5", "anchor_text": "giphy"}, {"url": "https://github.com/lorarjohns/nlp_profiling/tree/master/profiling", "anchor_text": "lorarjohns/nlp_profilingResults of profiling can be found here as *_reddit_2.txt"}, {"url": "https://github.com/explosion/spaCy/blob/master/spacy/tokens/doc.pyx", "anchor_text": "a Doc object"}, {"url": "https://course.spacy.io/", "anchor_text": "Advanced NLP with Spacy"}, {"url": "https://github.com/rkern/line_profiler", "anchor_text": "Line profiler"}, {"url": "https://docs.python.org/2/library/profile.html", "anchor_text": "cProfile"}, {"url": "https://github.com/benfred/py-spy", "anchor_text": "py-spy"}, {"url": "https://github.com/lorarjohns/nlp_profiling/blob/master/scripts/test_profiling_spacy.py", "anchor_text": "lorarjohns/nlp_profilingSome tests of the pipelines using pytestgithub.com"}, {"url": "https://github.com/lorarjohns/nlp_profiling", "anchor_text": "My full repo for this blog post"}, {"url": "https://github.com/lorarjohns/nlp_profiling", "anchor_text": "lorarjohns/nlp_profilinggithub.com"}, {"url": "https://course.spacy.io/", "anchor_text": "Advanced NLP with Spacy"}, {"url": "http://nltk.org", "anchor_text": "NLTK"}, {"url": "https://spacy.io", "anchor_text": "SpaCy"}, {"url": "https://github.com/explosion/spaCy/blob/master/spacy", "anchor_text": "source code"}, {"url": "https://docs.pytest.org/en/latest/getting-started.html", "anchor_text": "pytest"}, {"url": "https://github.com/rkern/line_profiler", "anchor_text": "Line profiler"}, {"url": "https://docs.python.org/2/library/profile.html", "anchor_text": "cProfile"}, {"url": "https://github.com/benfred/py-spy", "anchor_text": "py-spy"}, {"url": "https://realpython.com/introduction-to-python-generators/", "anchor_text": "generator object"}, {"url": "https://cython.org", "anchor_text": "Cython"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----a78a8397f9f3---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----a78a8397f9f3---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/programming?source=post_page-----a78a8397f9f3---------------programming-----------------", "anchor_text": "Programming"}, {"url": "https://medium.com/tag/technology?source=post_page-----a78a8397f9f3---------------technology-----------------", "anchor_text": "Technology"}, {"url": "https://medium.com/tag/software-development?source=post_page-----a78a8397f9f3---------------software_development-----------------", "anchor_text": "Software Development"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fa78a8397f9f3&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftesting-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3&user=Ray+Johns&userId=304c3bcee737&source=-----a78a8397f9f3---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fa78a8397f9f3&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftesting-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3&user=Ray+Johns&userId=304c3bcee737&source=-----a78a8397f9f3---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fa78a8397f9f3&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftesting-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----a78a8397f9f3--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fa78a8397f9f3&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftesting-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----a78a8397f9f3---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----a78a8397f9f3--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----a78a8397f9f3--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----a78a8397f9f3--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----a78a8397f9f3--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----a78a8397f9f3--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----a78a8397f9f3--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----a78a8397f9f3--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----a78a8397f9f3--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@rayljohns?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@rayljohns?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Ray Johns"}, {"url": "https://medium.com/@rayljohns/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "656 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F304c3bcee737&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftesting-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3&user=Ray+Johns&userId=304c3bcee737&source=post_page-304c3bcee737--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F199f98e22d81&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftesting-profiling-and-optimizing-nlp-models-with-pytest-cython-and-spacy-a78a8397f9f3&newsletterV3=304c3bcee737&newsletterV3Id=199f98e22d81&user=Ray+Johns&userId=304c3bcee737&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}