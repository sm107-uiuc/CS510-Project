{"url": "https://towardsdatascience.com/deploy-models-and-create-custom-handlers-in-torchserve-fc2d048fbe91", "time": 1683009022.215025, "path": "towardsdatascience.com/deploy-models-and-create-custom-handlers-in-torchserve-fc2d048fbe91/", "webpage": {"metadata": {"title": "Deploy models in PyTorch with Torchserve \ud83d\ude80 | by Francesco Zuppichini | Towards Data Science | Towards Data Science", "h1": "Deploy models in PyTorch \ud83d\ude80", "description": "In this tutorial we will deploy deep learning models in PyTorch using TorchServe"}, "outgoing_paragraph_urls": [{"url": "https://github.com/FrancescoSaverioZuppichini/torchserve-tryout", "anchor_text": "here", "paragraph_index": 0}, {"url": "https://hub.docker.com/r/pytorch/torchserve/tags", "anchor_text": "here", "paragraph_index": 5}, {"url": "https://github.com/pytorch/serve#quick-start-with-docker", "anchor_text": "here", "paragraph_index": 6}], "all_paragraphs": ["All the code used in this article is here", "Recently, PyTorch has introduced its new production framework to properly serve models, called torchserve.So, without further due, let\u2019s present today\u2019s roadmap:", "To showcase torchserve, we will serve a fully trained ResNet34 to perform image classification.", "The best way to install torchserve is with docker. You just need to pull the image.", "You can use the following command to save the latest image.", "All the tags are available here", "More about docker and torchserve here", "Handlers are the ones responsible to make a prediction using your model from one or more HTTP requests.", "Torchserve supports the following default handlers", "But keep in mind that none of them supports batching requests!", "torchserve exposes a rich interface to do almost everything you want. An Handler is just a class that must have three functions", "You can create your own class or just subclassBaseHandler . The main advantage of subclasssing BaseHandler is to have the model loaded accessible at self.model . The following snippet shows how to subclass BaseHandler", "Going back to our image classification example. We need to", "The .preprocess function takes an array of requests. Assuming we are sending an image to the server, the serialized image can be accessed from the data or body field of the request. Thus, we can just iterate over all requests and preprocess individually each image. The full code is shown below.", "self.transform is our preprocess transformation, nothing fancy. This is a classic preprocessing step for models trained on ImageNet.", "After we have preprocessed each image in each request we concatenate them to create a pytorch Tensor.", "This step is very easy, we get the tensor from the .preprocess function and we extract the prediction for each image.", "Now we have our predictions for each image, we need to return something to the client. Torchserve always expects an array to be returned. BaseHandler also automatically opens a .json file with the mapping index -> label (we are going to see it later how to provide such file) and store it at self.mapping . We can return an array of dictionaries with the label and index class for each prediction", "Wrapping everything together, our glorious handler looks like", "Since all the handling logic encapsulated in a class, you can easily unit test it!", "Torchserve expects a .mar file to be provided. In a nutshell, the file is just your model and all the dependencies packed together. To create one need to first export our trained model.", "There are three ways to export your model for torchserve. The best way that I have found so far is to trace the model and store the results. By doing so we do not need to add any additional files to torchserve.", "Let\u2019s see an example, we are going to deploy a fully trained ResNet34 model.", "Then, we are ready to create the .mar file by using the following command", "In order. The variable --model-name defines the final name of our model. This is very important since it will be the namespace of the endpoint that will be responsible for its predictions. You can also specify a --version . --serialized-file points to the stored .pt model we created before. --handler is a python file where we call our custom handler. In general, it always looks like this:", "It exposes a handle function from which we call the methods in the custom handler. You can use the default names to use the default handled (e.g. --handler image_classifier ).", "In --extra-files you need to pass the path to all the files your handlers are using. In our case, we have to add the path to the .json file with all the human-readable labels names and MyHandler.py file in which we have the class definition for MyHandler.", "One minor thing, if you pass an index_to_name.json file, it will be automatically loaded into the handler and be accessible at self.mapping .", "--export-path is where the .mar file will be stored, I also added the -f to overwrite everything in it.", "If everything went smooth, you should see resnet34.mar stored into ./model-store .", "This is an easy step, we can run the torchserve docker container with all the required parameters", "I am binding the container port 8080 and 8081 to 3000 and 3001 respectively (8080/8081 were already in used in my machine). Then, I am creating a volume from ./model-store (where we stored the .mar file) to the container default model-store folder. Lastly, I am calling torchserve by padding the model-store path and a list of key-value pairs in which we specify the model name for each .mar file.", "At this point, torchserve has one endpoint /predictions/resnet34 to which we can get a prediction by sending an image. This can be done using curl", "To recap, in this article we have covered:", "If you like this article and pytorch, you may also be interested in these my other articles", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Ffc2d048fbe91&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-models-and-create-custom-handlers-in-torchserve-fc2d048fbe91&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-models-and-create-custom-handlers-in-torchserve-fc2d048fbe91&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-models-and-create-custom-handlers-in-torchserve-fc2d048fbe91&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-models-and-create-custom-handlers-in-torchserve-fc2d048fbe91&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----fc2d048fbe91--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----fc2d048fbe91--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@FrancescoZ?source=post_page-----fc2d048fbe91--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@FrancescoZ?source=post_page-----fc2d048fbe91--------------------------------", "anchor_text": "Francesco Zuppichini"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F1bd9d6f5a0c4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-models-and-create-custom-handlers-in-torchserve-fc2d048fbe91&user=Francesco+Zuppichini&userId=1bd9d6f5a0c4&source=post_page-1bd9d6f5a0c4----fc2d048fbe91---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ffc2d048fbe91&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-models-and-create-custom-handlers-in-torchserve-fc2d048fbe91&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ffc2d048fbe91&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-models-and-create-custom-handlers-in-torchserve-fc2d048fbe91&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://github.com/FrancescoSaverioZuppichini/torchserve-tryout", "anchor_text": "here"}, {"url": "https://github.com/pytorch/serve/blob/master/README.md##install-torchserve", "anchor_text": "here"}, {"url": "https://hub.docker.com/r/pytorch/torchserve/tags", "anchor_text": "here"}, {"url": "https://github.com/pytorch/serve#quick-start-with-docker", "anchor_text": "here"}, {"url": "https://github.com/pytorch/serve/blob/master/docs/custom_service.md", "anchor_text": "here"}, {"url": "https://github.com/pytorch/serve/tree/master/model-archiver#creating-a-model-archive", "anchor_text": "here"}, {"url": "https://github.com/pytorch/serve/blob/master/model-archiver/README.md", "anchor_text": "here"}, {"url": "http://127.0.0.1:3000/predictions/resnet34", "anchor_text": "http://127.0.0.1:3000/predictions/resnet34"}, {"url": "https://pixabay.com/it/photos/gatto-tabby-all-aperto-animali-1506960/", "anchor_text": "source"}, {"url": "https://github.com/FrancescoSaverioZuppichini/torchserve-tryout", "anchor_text": "here"}, {"url": "https://towardsdatascience.com/pytorch-deep-learning-template-6e638fc2fe64", "anchor_text": "PyTorch Deep Learning TemplateA clean and simple template to kick start your next dl project \ud83d\ude80\ud83d\ude80towardsdatascience.com"}, {"url": "https://towardsdatascience.com/pytorch-how-and-when-to-use-module-sequential-modulelist-and-moduledict-7a54597b5f17", "anchor_text": "Pytorch: how and when to use Module, Sequential, ModuleList and ModuleDictUpdated at Pytorch 1.5towardsdatascience.com"}, {"url": "https://medium.com/tag/pytorch?source=post_page-----fc2d048fbe91---------------pytorch-----------------", "anchor_text": "Pytorch"}, {"url": "https://medium.com/tag/programming?source=post_page-----fc2d048fbe91---------------programming-----------------", "anchor_text": "Programming"}, {"url": "https://medium.com/tag/data-science?source=post_page-----fc2d048fbe91---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----fc2d048fbe91---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----fc2d048fbe91---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Ffc2d048fbe91&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-models-and-create-custom-handlers-in-torchserve-fc2d048fbe91&user=Francesco+Zuppichini&userId=1bd9d6f5a0c4&source=-----fc2d048fbe91---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Ffc2d048fbe91&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-models-and-create-custom-handlers-in-torchserve-fc2d048fbe91&user=Francesco+Zuppichini&userId=1bd9d6f5a0c4&source=-----fc2d048fbe91---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ffc2d048fbe91&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-models-and-create-custom-handlers-in-torchserve-fc2d048fbe91&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----fc2d048fbe91--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Ffc2d048fbe91&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-models-and-create-custom-handlers-in-torchserve-fc2d048fbe91&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----fc2d048fbe91---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----fc2d048fbe91--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----fc2d048fbe91--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----fc2d048fbe91--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----fc2d048fbe91--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----fc2d048fbe91--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----fc2d048fbe91--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----fc2d048fbe91--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----fc2d048fbe91--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@FrancescoZ?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@FrancescoZ?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Francesco Zuppichini"}, {"url": "https://medium.com/@FrancescoZ/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "1.7K Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F1bd9d6f5a0c4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-models-and-create-custom-handlers-in-torchserve-fc2d048fbe91&user=Francesco+Zuppichini&userId=1bd9d6f5a0c4&source=post_page-1bd9d6f5a0c4--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fcaa89168dd7d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-models-and-create-custom-handlers-in-torchserve-fc2d048fbe91&newsletterV3=1bd9d6f5a0c4&newsletterV3Id=caa89168dd7d&user=Francesco+Zuppichini&userId=1bd9d6f5a0c4&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}