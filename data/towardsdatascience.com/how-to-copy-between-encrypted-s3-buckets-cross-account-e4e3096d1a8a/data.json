{"url": "https://towardsdatascience.com/how-to-copy-between-encrypted-s3-buckets-cross-account-e4e3096d1a8a", "time": 1683016448.702705, "path": "towardsdatascience.com/how-to-copy-between-encrypted-s3-buckets-cross-account-e4e3096d1a8a/", "webpage": {"metadata": {"title": "How to Copy between Encrypted S3 Buckets Cross Account | by Evan Kozliner | Towards Data Science", "h1": "How to Copy between Encrypted S3 Buckets Cross Account", "description": "In my last post, I went over what you need to know about IAM, the identity and access management service offered by AWS. In this post, I want to be a little more concrete, by covering a common\u2026"}, "outgoing_paragraph_urls": [{"url": "https://towardsdatascience.com/aws-iam-introduction-20c1f017c43", "anchor_text": "my last post", "paragraph_index": 1}, {"url": "https://towardsdatascience.com/aws-iam-introduction-20c1f017c43", "anchor_text": "Introduction to IAM post", "paragraph_index": 2}, {"url": "https://docs.aws.amazon.com/kms/latest/developerguide/key-policies.html#key-policy-default", "anchor_text": "default key policy", "paragraph_index": 10}, {"url": "https://docs.aws.amazon.com/AmazonS3/latest/dev/amazon-s3-policy-keys.html", "anchor_text": "conditions", "paragraph_index": 14}, {"url": "https://docs.aws.amazon.com/AmazonS3/latest/dev/acl-overview.html", "anchor_text": "access control lists (ACLs)", "paragraph_index": 15}, {"url": "https://aws.amazon.com/blogs/security/iam-policies-and-bucket-policies-and-acls-oh-my-controlling-access-to-s3-resources/", "anchor_text": "AWS recommends bucket policies instead", "paragraph_index": 15}, {"url": "https://en.wikipedia.org/wiki/Infrastructure_as_code", "anchor_text": "infrastructure-as-code", "paragraph_index": 18}, {"url": "https://docs.aws.amazon.com/cli/latest/userguide/cli-security-enforcing-tls.html#enforcing-tls-v2", "anchor_text": "encrypts our data in transit", "paragraph_index": 19}, {"url": "https://en.wikipedia.org/wiki/Hardware_security_module", "anchor_text": "HSMs", "paragraph_index": 23}, {"url": "http://thinkoutloudnews.substack.com", "anchor_text": "thinkoutloudnews.substack.com", "paragraph_index": 25}, {"url": "http://evankozliner.com", "anchor_text": "evankozliner.com", "paragraph_index": 25}], "all_paragraphs": ["Encryption is tricky, even when you\u2019re using managed services, like AWS.", "In my last post, I went over what you need to know about IAM, the identity and access management service offered by AWS. In this post, I want to be a little more concrete, by covering a common scenario where a large number of different permissions are at play. Here, you\u2019ll see all the different types of resources I talked about previously in action, and hopefully everything will click.", "Read my Introduction to IAM post if you need a rundown on the basics of how permissions work within AWS.", "Suppose we\u2019re using several AWS accounts, and we want to copy data in some S3 bucket from a source account to some destination account, as you see in the diagram above. Further, let\u2019s imagine our data must be encrypted at rest, for something like regulatory purposes; this means that our buckets in both accounts must also be encrypted.", "There are plenty of ways to accomplish the above goal on AWS, but I\u2019ll be talking about the below combination:", "There are 5 major resources at play here: our two master keys that will handle bucket encryption, our 2 S3 buckets, and our role. This means there are 4 resource policies you will need to get right for this to work (excluding the trust policy on the role) and 1 identity policy.", "Note: You can\u2019t just copy/paste everything below. For each policy, you will have to change the resource ARNs and account id\u2019s to the ones belonging to your source/destination.", "This is the identity policy we will attach to our S3Porter role in order to have it contact S3 and KMS. There are 4 statements necessary in here: one for each resource in the diagram at the top.", "Our destination bucket does not need a resource policy, as requests to it are coming from the S3Porter role in the same AWS account, and we have added s3:PutObject permissions for the destination bucket in our identity policy.", "It\u2019s worth noting that we could have also added a resource policy on the destination bucket, instead of adding it on the S3Porter identity policy above.", "The below is actually the default key policy. A little boring.", "What\u2019s worth noting, however, is that in KMS key policies are different than most resource policies. Without explicit access, IAM permissions on an identity policy alone are not allowed to access a CMK, even within the same AWS account. In a KMS key policy, the default way of giving intra-account policies the ability to access a key is by enabling a root account user to access the key; this will also enable other IAM policies to take action the key, as you see below.", "To allow cross account access to an S3 bucket, we\u2019ll need to add a resource policy, called a bucket policy, to our S3 bucket. This policy is relatively straightforward:", "Missing any of these things may result in a fairly vague 403 (access denied).", "A more sophisticated bucket policy might use conditions to limit IP address ranges or narrow down which objects our S3Porter role can access.", "Another way to grant the below permissions would be to use access control lists (ACLs). ACLs are S3\u2019s \u201cold way\u201d of managing permissions pre-IAM. ACLs are not deprecated, but they are legacy, and AWS recommends bucket policies instead.", "Finally, we have one more policy allowing our S3Porter to decrypt data from our cross-account source bucket.", "Below I set up and execute copying between 2 buckets, cross account.", "I recommend going through the below on your own to gain comfortability with cross-account bucket access, prior to automation or checking things in with infrastructure-as-code.", "Note: It\u2019s worth mentioning here that we\u2019re using version 2 of the AWS CLI. The AWS CLI is great because it encrypts our data in transit with TLS 1.2 by default, so there\u2019s no worry about us sending plaintext over the wire here.", "Next, we will need to edit our ~/.aws/credentials file; this will let us use our porter role as a profile.", "If you followed the above example, remember to tear down any resources you created while doing it!", "Thanks for reading! If you want to chat or have feedback on a post, you can always contact me on Twitter, LinkedIn, or at evankozliner@gmail.com", "[1] A full rundown of envelope encryption is beyond the scope of this post, but envelope encryption is an important (and interesting) topic. There are a lot of reasons envelope encryption is handy: ranging from simplifying the rotation of master keys and ensuring they stay in HSMs, to speeding up encryption by enabling the use of different algorithms for object and key storage.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "I write about technology, philosophy, and their intersections. Subscribe at thinkoutloudnews.substack.com! My articles are also on evankozliner.com."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fe4e3096d1a8a&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-copy-between-encrypted-s3-buckets-cross-account-e4e3096d1a8a&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-copy-between-encrypted-s3-buckets-cross-account-e4e3096d1a8a&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-copy-between-encrypted-s3-buckets-cross-account-e4e3096d1a8a&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-copy-between-encrypted-s3-buckets-cross-account-e4e3096d1a8a&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----e4e3096d1a8a--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----e4e3096d1a8a--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://evankozliner.medium.com/?source=post_page-----e4e3096d1a8a--------------------------------", "anchor_text": ""}, {"url": "https://evankozliner.medium.com/?source=post_page-----e4e3096d1a8a--------------------------------", "anchor_text": "Evan Kozliner"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F1735ba74241&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-copy-between-encrypted-s3-buckets-cross-account-e4e3096d1a8a&user=Evan+Kozliner&userId=1735ba74241&source=post_page-1735ba74241----e4e3096d1a8a---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fe4e3096d1a8a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-copy-between-encrypted-s3-buckets-cross-account-e4e3096d1a8a&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fe4e3096d1a8a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-copy-between-encrypted-s3-buckets-cross-account-e4e3096d1a8a&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://desk.draw.io/support/solutions/articles/16000042494-usage-terms-for-diagrams-created-in-diagrams-net", "anchor_text": "Draw.io"}, {"url": "https://towardsdatascience.com/aws-iam-introduction-20c1f017c43", "anchor_text": "my last post"}, {"url": "https://towardsdatascience.com/aws-iam-introduction-20c1f017c43", "anchor_text": "Introduction to IAM post"}, {"url": "https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingKMSEncryption.html", "anchor_text": "S3 server-side encryption with customer-managed keys"}, {"url": "https://docs.aws.amazon.com/AmazonS3/latest/dev/bucket-encryption.html", "anchor_text": "S3 default encryption"}, {"url": "https://aws.amazon.com/premiumsupport/knowledge-center/s3-multipart-kms-decrypt/#:~:text=Because%20the%20parts%20are%20encrypted,Amazon%20S3%20with%20SSE%2DKMS.", "anchor_text": "behind the scenes, S3 may break your files into chunks and reassemble them"}, {"url": "https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#enveloping", "anchor_text": "envelope encryption"}, {"url": "https://docs.aws.amazon.com/kms/latest/developerguide/key-policies.html#key-policy-default", "anchor_text": "default key policy"}, {"url": "https://docs.aws.amazon.com/AmazonS3/latest/dev/amazon-s3-policy-keys.html", "anchor_text": "conditions"}, {"url": "https://docs.aws.amazon.com/AmazonS3/latest/dev/acl-overview.html", "anchor_text": "access control lists (ACLs)"}, {"url": "https://aws.amazon.com/blogs/security/iam-policies-and-bucket-policies-and-acls-oh-my-controlling-access-to-s3-resources/", "anchor_text": "AWS recommends bucket policies instead"}, {"url": "https://en.wikipedia.org/wiki/Infrastructure_as_code", "anchor_text": "infrastructure-as-code"}, {"url": "https://docs.aws.amazon.com/cli/latest/userguide/cli-security-enforcing-tls.html#enforcing-tls-v2", "anchor_text": "encrypts our data in transit"}, {"url": "https://en.wikipedia.org/wiki/Hardware_security_module", "anchor_text": "HSMs"}, {"url": "https://medium.com/tag/security?source=post_page-----e4e3096d1a8a---------------security-----------------", "anchor_text": "Security"}, {"url": "https://medium.com/tag/aws?source=post_page-----e4e3096d1a8a---------------aws-----------------", "anchor_text": "AWS"}, {"url": "https://medium.com/tag/encryption?source=post_page-----e4e3096d1a8a---------------encryption-----------------", "anchor_text": "Encryption"}, {"url": "https://medium.com/tag/cloud-computing?source=post_page-----e4e3096d1a8a---------------cloud_computing-----------------", "anchor_text": "Cloud Computing"}, {"url": "https://medium.com/tag/software-engineering?source=post_page-----e4e3096d1a8a---------------software_engineering-----------------", "anchor_text": "Software Engineering"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fe4e3096d1a8a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-copy-between-encrypted-s3-buckets-cross-account-e4e3096d1a8a&user=Evan+Kozliner&userId=1735ba74241&source=-----e4e3096d1a8a---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fe4e3096d1a8a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-copy-between-encrypted-s3-buckets-cross-account-e4e3096d1a8a&user=Evan+Kozliner&userId=1735ba74241&source=-----e4e3096d1a8a---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fe4e3096d1a8a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-copy-between-encrypted-s3-buckets-cross-account-e4e3096d1a8a&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----e4e3096d1a8a--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fe4e3096d1a8a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-copy-between-encrypted-s3-buckets-cross-account-e4e3096d1a8a&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----e4e3096d1a8a---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----e4e3096d1a8a--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----e4e3096d1a8a--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----e4e3096d1a8a--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----e4e3096d1a8a--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----e4e3096d1a8a--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----e4e3096d1a8a--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----e4e3096d1a8a--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----e4e3096d1a8a--------------------------------", "anchor_text": ""}, {"url": "https://evankozliner.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://evankozliner.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Evan Kozliner"}, {"url": "https://evankozliner.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "441 Followers"}, {"url": "http://thinkoutloudnews.substack.com", "anchor_text": "thinkoutloudnews.substack.com"}, {"url": "http://evankozliner.com", "anchor_text": "evankozliner.com"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F1735ba74241&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-copy-between-encrypted-s3-buckets-cross-account-e4e3096d1a8a&user=Evan+Kozliner&userId=1735ba74241&source=post_page-1735ba74241--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Ff945805cdbee&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-copy-between-encrypted-s3-buckets-cross-account-e4e3096d1a8a&newsletterV3=1735ba74241&newsletterV3Id=f945805cdbee&user=Evan+Kozliner&userId=1735ba74241&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}