{"url": "https://towardsdatascience.com/im-out-of-the-layers-how-to-make-a-custom-tensorflow-2-layer-9921942c88fc", "time": 1683005053.74209, "path": "towardsdatascience.com/im-out-of-the-layers-how-to-make-a-custom-tensorflow-2-layer-9921942c88fc/", "webpage": {"metadata": {"title": "I\u2019m out of the layers \u2014 how to make a custom TensorFlow 2 layer. | by Daniel Wiczew | Towards Data Science", "h1": "I\u2019m out of the layers \u2014 how to make a custom TensorFlow 2 layer.", "description": "TensorFlow 2 made the machine learning framework far easier to use, still retaining its flexibility to build its models. One of its new features is building new layers through integrated Keras API\u2026"}, "outgoing_paragraph_urls": [], "all_paragraphs": ["TensorFlow 2 made the machine learning framework far easier to use, still retaining its flexibility to build its models. One of its new features is building new layers through integrated Keras API and easily debugging this API with the usage of eager-execution.", "In this article, you will learn how to build custom neural network layers in TensorFlow 2 framework. Writing this article I assume you have a basic understanding of object-oriented programming in Python 3. The best would be if you review __init__, __call__, class inheritance and method overriding before reading this article.", "Let\u2019s start from a template, based on it you will build most of your layers.", "As you can see the construction is simple. The template consists of two methods, __init__, and call. The first method is a standard Python 3 constructor of a class, where we initialize all objects and fields. Thus in the case of the layer, you initialize here all the variables that are going to be used through the training. Also remember to call the __init__ method of Layer class by calling super(YourClassName, self).__init__()otherwise, the constructor of the Layer class won\u2019t be initialized. The method call is where all the forward and backward is defined based on the given input and variables. The only thing you have to do is to define the forward-propagation step, the back-propagation step is taken automatically by TF2.", "Furthermore, there are two mandatory arguments \u2014 one is x_input and another is training. The input can be any type, and you can add more input arguments if you want. Nevertheless, there has to be at least one input or the forward and the backpropagation step won\u2019t be possible. Additionally, there is the training augment, which I set to False as default (to not have False by default during testing). It is used in some layers that, the behavior is different in the testing and training phase. For example, dropout is such a layer, where it is used because it drops neurons only in the training phase.", "If you\u2019re curious why call is used instead of the pythonic __call__, then look at the end of the article.", "Let\u2019s define an more complicated layer, this time it will perform a horribly complicated operation, which is \u2026 multiplication of two real numbers.", "This time the layers consist of two inputs in the call method and a tf.math.multiply method which multiplies two numbers. To use this layer you simply define create MultiplyLayer object and you call it by passing values into it, like below:", "Try by yourself before running forward. The next one is more complicated, I don\u2019t play with word this time. But you will get through it, believe me.", "Let\u2019s assume that, you want to create a neural net that predicts few classes. To do this, you\u2019re going to train the net on the popular CIFAR-10 dataset, which has teen different classes. To solve the problem, you chose the residual neural network (ResNet in short), but it requires you to build your own layer because they are not implemented in TF2 or you want to play with different architecture. The ResNet is built with residual blocks, these blocks have skip connections, that counteract the vanishing gradient problem.", "There are going to be two types of blocks here, one which does preserve the input shape (so the output shape is the same as input) and another that does change. The ResNet blocks have architecture like the one below, where the most important here is the skip connection (sometimes called shortcut connection). The skip connection is nothing else than copying the input and adding it at the end of the output, it is nothing mysterious yet it works very well.", "Let\u2019s now try to build a residual block. I\u2019m not going to create the layer according to some architecture, but rather some intuition. Furthermore, I will try to keep things simple, but it makes things take much more space (unnecessary repetitions), I will make an appointment on how it could be done better.", "With the basics in building TF2 layers, let\u2019s try out our new skills in building ResNet, place ourselves high in the CIFAR10 benchmark dataset. Here you can find a leader-board with corresponding papers:", "Let\u2019s first sketch our identity blocks that, we are going to use to build our custom layers (that are ResNet blocks). First, we will build an identity block which will be called by me as a ResidualLayer further in the code, this layer consists of two paths with three Convolutional Blocks and one shortcut path (look at the image below). The wideness often improves accuracy during the training [1]. Feel free to modify the number of paths and check how it affects resulting accuracy, training time and other parameters. It worth noting that, the two paths should have a different set of hyper-parameters, to learn how to extract a different set of features.", "The second residual block does not preserve the input shape, so the skip connection has to rescale the input. It is done with a convolutional layer. The rest is almost the same as the previously shown residual block. The layer will be called in the code in a similar manner as the previous one, but with Scal postfix, so ResidualLayerScal.", "And the code for the residual blocks is here, for the ResidualLayer and ResidualLayerScal. The code is a bit long so you won\u2019t be able to see it whole on the medium webpage. You have to click on it and go to the gist directly.", "Pay attention to the comments and the training=False.", "All the code looks quite complicated, yet most of the code is a repetition of a certain schema. Most of the code could (and even should) be repeated with a one or two for loops (one for controlling depth, and another for wideness). But to make the code more simple I think it is better to not use it here.", "To create such a layer and use it, you just create an instance of the class the same way as with the MultiplyLayer.", "It is always better to start with \u201cpaper\u201d than rush to work without any plan. Thus let\u2019s make a schema of a block, the block going to consist of five residual layers as on the image below and is called further \u2026 guess how, a residual block!", "There are two types of layers in such block, one layer that, does not preserve the input shape \u2014 ResidualLayerScal and four that preserve \u2014 ResidualLayer. With the blocks defined, let\u2019s build a model and test these layers.", "A schema for the whole model won\u2019t be much more complicated, it is a repetition of the four residual blocks with batch normalization, activation function at the beginning and convolutional layer, another batch normalization with dense output at the end.", "The model is going to be implemented by creating a class that, inherits from the tf.keras.Model class. Let\u2019s call the model class a FunnyResNet (which does not sound even funny). Here comes the code:", "The model implements the schema shown previously, how it works you can learn in my other story.", "After defining your model, the one thing you need to do is to define it with the model.compile()and train the model with model.fit(). The whole Resnet model presented here you can find here in my repository along with image standardization, normalization and, augmentation.", "The purpose of passing the two images to the model before compiling it is to initialize the weight shapes. It is done automatically in TF2, based on the first occurred input.", "Here you can find a Jupyter notebook with all the code:", "or in the Google\u2019s colab directly:", "A resnet example for a tutorial at TowardDataScience", "Creating a layer in TF2 is not a hard task, you have to remember a few things:", "Always use TF functions in the layers, or you won\u2019t be able to compile them with model.fit() or use them with @tf.function statement (which implies far lower performance). In TF2 there are replacements for almost every pythonic function that you need. For example, to perform a for loop in a layer, you will use for i in tf.range(N) or to use arrays you use tf.TensorArray.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F9921942c88fc&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fim-out-of-the-layers-how-to-make-a-custom-tensorflow-2-layer-9921942c88fc&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fim-out-of-the-layers-how-to-make-a-custom-tensorflow-2-layer-9921942c88fc&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fim-out-of-the-layers-how-to-make-a-custom-tensorflow-2-layer-9921942c88fc&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fim-out-of-the-layers-how-to-make-a-custom-tensorflow-2-layer-9921942c88fc&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----9921942c88fc--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----9921942c88fc--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://daniel-wiczew.medium.com/?source=post_page-----9921942c88fc--------------------------------", "anchor_text": ""}, {"url": "https://daniel-wiczew.medium.com/?source=post_page-----9921942c88fc--------------------------------", "anchor_text": "Daniel Wiczew"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F9ecdedb7ac9b&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fim-out-of-the-layers-how-to-make-a-custom-tensorflow-2-layer-9921942c88fc&user=Daniel+Wiczew&userId=9ecdedb7ac9b&source=post_page-9ecdedb7ac9b----9921942c88fc---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F9921942c88fc&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fim-out-of-the-layers-how-to-make-a-custom-tensorflow-2-layer-9921942c88fc&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F9921942c88fc&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fim-out-of-the-layers-how-to-make-a-custom-tensorflow-2-layer-9921942c88fc&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://paperswithcode.com/sota/image-classification-on-cifar-10", "anchor_text": "CIFAR-10 Leaderboard | Papers with CodeThe current state-of-the-art on CIFAR-10 is BiT-L (ResNet). See a full comparison of 91 papers with code.paperswithcode.com"}, {"url": "https://towardsdatascience.com/creating-a-trashy-model-from-scratch-with-tensorflow-2-an-example-with-an-anomaly-detection-27f0d1d7bd00", "anchor_text": "How to create a TensorFlow 2 model from scratch \u2014 A \u201ctrashy\u201d example.Image that you\u2019d like to build a model that could be used by you in a project. You choose to do it the TensorFlow 2\u2026towardsdatascience.com"}, {"url": "https://github.com/DanielWicz/FunnyResNet", "anchor_text": "DanielWicz/FunnyResNetA resnet example for a tutorial at the TowardDataScience - DanielWicz/FunnyResNetgithub.com"}, {"url": "https://colab.research.google.com/github/DanielWicz/FunnyResNet/blob/master/SimpleResNet.ipynb", "anchor_text": "DanielWicz/FunnyResNet Google ColaboratoryA resnet example for a tutorial at TowardDataScience"}, {"url": "https://www.tensorflow.org/guide/keras/custom_layers_and_models", "anchor_text": "here"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/keras/layers/Layer", "anchor_text": "here"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----9921942c88fc---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/data-science?source=post_page-----9921942c88fc---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/tensorflow2?source=post_page-----9921942c88fc---------------tensorflow2-----------------", "anchor_text": "Tensorflow2"}, {"url": "https://medium.com/tag/towards-data-science?source=post_page-----9921942c88fc---------------towards_data_science-----------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/tag/programming?source=post_page-----9921942c88fc---------------programming-----------------", "anchor_text": "Programming"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F9921942c88fc&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fim-out-of-the-layers-how-to-make-a-custom-tensorflow-2-layer-9921942c88fc&user=Daniel+Wiczew&userId=9ecdedb7ac9b&source=-----9921942c88fc---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F9921942c88fc&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fim-out-of-the-layers-how-to-make-a-custom-tensorflow-2-layer-9921942c88fc&user=Daniel+Wiczew&userId=9ecdedb7ac9b&source=-----9921942c88fc---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F9921942c88fc&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fim-out-of-the-layers-how-to-make-a-custom-tensorflow-2-layer-9921942c88fc&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----9921942c88fc--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F9921942c88fc&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fim-out-of-the-layers-how-to-make-a-custom-tensorflow-2-layer-9921942c88fc&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----9921942c88fc---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----9921942c88fc--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----9921942c88fc--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----9921942c88fc--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----9921942c88fc--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----9921942c88fc--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----9921942c88fc--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----9921942c88fc--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----9921942c88fc--------------------------------", "anchor_text": ""}, {"url": "https://daniel-wiczew.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://daniel-wiczew.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Daniel Wiczew"}, {"url": "https://daniel-wiczew.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "33 Followers"}, {"url": "https://www.linkedin.com/in/daniel-wiczew", "anchor_text": "https://www.linkedin.com/in/daniel-wiczew"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F9ecdedb7ac9b&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fim-out-of-the-layers-how-to-make-a-custom-tensorflow-2-layer-9921942c88fc&user=Daniel+Wiczew&userId=9ecdedb7ac9b&source=post_page-9ecdedb7ac9b--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fusers%2F9ecdedb7ac9b%2Flazily-enable-writer-subscription&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fim-out-of-the-layers-how-to-make-a-custom-tensorflow-2-layer-9921942c88fc&user=Daniel+Wiczew&userId=9ecdedb7ac9b&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}