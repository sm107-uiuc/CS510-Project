{"url": "https://towardsdatascience.com/kustomize-explained-an-mlops-use-case-ad8bacffbc07", "time": 1683018066.255703, "path": "towardsdatascience.com/kustomize-explained-an-mlops-use-case-ad8bacffbc07/", "webpage": {"metadata": {"title": "Kustomize explained; an MLOps Use Case | by Tibor Fabian | Towards Data Science", "h1": "Kustomize explained; an MLOps Use Case", "description": "Kustomize is a tool to customize YAML files like Kubernetes (K8s) manifests, template free. Meanwhile, it became a built-in kubectl operation to apply K8s object definitions from YAML files stored in\u2026"}, "outgoing_paragraph_urls": [{"url": "https://github.com/kubernetes-sigs/kustomize", "anchor_text": "Kustomize", "paragraph_index": 0}, {"url": "https://github.com/kubernetes-sigs/kustomize/tree/master/examples", "anchor_text": "great examples", "paragraph_index": 1}, {"url": "https://tibor-fabian.medium.com/mlops-w-dataiku-dss-on-kubernetes-505ee9a2e15a", "anchor_text": "MLOps w/ Dataiku DSS on Kubernetes", "paragraph_index": 4}, {"url": "https://github.com/tibfab/dss-at-k8s.git", "anchor_text": "https://github.com/tibfab/dss-at-k8s.git", "paragraph_index": 6}, {"url": "https://github.com/tibfab/dss-at-k8s/tree/master/deployment", "anchor_text": "GitHub repo", "paragraph_index": 24}, {"url": "https://de.linkedin.com/in/fabiantibor", "anchor_text": "https://de.linkedin.com/in/fabiantibor", "paragraph_index": 40}], "all_paragraphs": ["Kustomize is a tool to customize YAML files like Kubernetes (K8s) manifests, template free. Meanwhile, it became a built-in kubectl operation to apply K8s object definitions from YAML files stored in a hierarchical directory structure.", "There are some great examples in the documentation of Kustomize. Nevertheless, sharing my experience from a journey in the field of Machine Learning Operations (MLOps) might allow you to gain some practical knowledge from a real use case.", "K8s object definition is thought to be a manifest of highly reproducible value. Therefore, templates or environment variables, to make content definitions alterable, are not supported. This might lead to a conflict if multiple deployments share many similarities because common parts need a lot of copy and paste and parallel versioning. Also, copies are hard to maintain and source for errors if changes have repeatedly been made across similar definitions.", "To dissolve such conflicts, Kustomize comes really in handy.", "The example in this article is about to run Dataiku Data Science Studio (DSS) on K8s. DSS provides multiple variants \u2014 node types \u2014 with similar installation configurations to build a complete MLOps pipeline \u2014 Design, Automation, and API Deployer. I\u2019m using Kustomize to manage the similarities of the K8s pod configuration definitions to avoid duplicates. See details of this architecture in my post, \u201cMLOps w/ Dataiku DSS on Kubernetes\u201d.", "The K8s configurations of the DSS nodes differ only slightly and have a significant amount of overlapping parts. It would be tough to maintain them correctly if the manifests for the node deployments were completely separated. Due to similarities, common details needed to be updated everywhere in all node configurations each time they are subject to changes.", "Consider the directory structure of the deployment configuration below. The code to the example use case is available in my GitHub repository https://github.com/tibfab/dss-at-k8s.git.", "There are three deployment directories deployment/design, deployment/automation, and deployment/apideployer for the three corresponding DSS node types \u2014 Design node, Automation node, and API Deployer node. The configuration part common to all deployments is stored in the directory deployment/base.", "The main idea behind Kustomize is to build the K8s configuration based on two parts, special to each deployment and common to all. The directory deployment/base consists of the common configuration in the above tree, and the special parts are defined in the node-specific directories.", "To apply the entire deployment configuration for the DSS Design node, for example, the following kubectl command needs to be performed.", "Let me walk you through this example, step by step. As a reference and for further study, the complete configuration output is inserted at the end of this post, given its lengthy nature.", "First, Kustomize looks up the file kustomization.yaml in the target directory, deployment/design, and based on its content, it merges different parts of the definitions into a whole. The resources specified by the keyword bases are included as the common/shared part, and the customization features (nameSuffix, commonLabels, etc.) are performed on the content of those shared resources.", "This article elaborates on some Kustomize features in detail explaining the above configuration in full.", "With the keyword bases, Kustomize looks at the file kustomize.yaml in the additional configuration directory specified by the path ../base. In this example, that is to be considered as the common/shared part.", "As the content of base/kustomization.yaml above shows, the keyword resources includes two additional configuration files from the same ../base directory:", "Customization, defined in the node-specific kustomization.yaml files, is performed on these resources. Below is an excerpt from base/dss-deployment.yaml, which serves as the basis for modifications by additional customization steps defined for each DSS cluster node separately.", "The Kustomize feature nameSuffix appends a specific suffix, -design-node in my example, to all name definition occurrences shown in file base/dss-deployment.yaml below.", "The diff above highlights changes to the original common definition (on the left) after configuration names were updated (on the right) based on the nameSuffix given in file design/kustomization.yaml.", "To give you the full example, below is base/service.yaml updated with the same nameSuffix automatically by Kustomize.", "Note: The file automation/kustomization.yaml, which uses the same common deployment basis, defines -automation-node at this place and apideployer/kustomization.yaml defines -apideployer-node respectively.", "Like name suffixes, labels are updated in base/dss-deployment.yaml according to the configuration in design/kustomization.yaml. This works slightly differently as it replaces labels\u2019 values for a specific keyword, app in this case, instead of extending it \u2014 even if it\u2019s not that obvious from the diff below.", "The configuration in base/service.yaml is also updated respectively.", "Kustomize allows, in this concrete use case, to create three different services for all DSS node types \u2014 Design, Automation, and API Deployer \u2014 with a single service definition file.", "This feature replaces the placeholder image dss-node-image in the configuration base/dss-deployment.yaml. The placeholder is specified in the container configuration section template \u2192 spec \u2192 containers \u2192 image. Its value is replaced by the customized image name defined in file design/kustomization.yaml with the keywords newName/newTag. The placeholder dss-node-image marks the exact spot where to replace.", "Note: If we look at the GitHub repo in the file deployment/automation/kustomization.yaml, which uses the same common deployment basis, we find a different image but with the same place holder to replace dss-node-image. As a result, a very similar deployment with different images is generated by Kustomize if we specify the target directory deployment/automation instead of deployment/design.", "Kustomize\u2019s configMapGenerator creates K8s ConfigMap resources allowing the usage of customized ConfigMaps as environment variables in the pod definition. To achieve that, configMapGenerator is defined in design/kustomization.yaml and configMapKeyRef with the same name dss-node-type in file base/dss-deployment.yaml.", "To bring these two parts together, Kustomize first generates a ConfigMap with a specific name extension automatically.", "The name of the new ConfigMap is then embedded in the deployment configuration to be referenced as an environment variable.", "Note: The value dss-node-type is the same for all DSS nodes, but the literals in the node-specific kustomization.yaml are different:", "As a consequence, the environment variable DSS_NODE_TYPE becomes different values depending on which customization directory is applied.", "As its name suggests, patchesStrategicMerge allows the merging of specific configuration segments from design/kustomization.yaml into to the common configuration base/dss-deployment.yaml. In this example, the merge is applied for the configuration of resources and volumes.", "resources: The content of design/resources.yaml is merged into the pod definition base/dss-deployment.yaml along with the configuration path template \u2192 spec \u2192 containers \u2192 -name: dss(-design-node) \u2192 resources.", "volumes: Similarly to resources but on two places this time, the content of design/volumes.yaml is merged into the pod definition base/dss-deployment.yaml along the specified configuration paths:", "As mentioned already above, the contents of the other DSS node configuration directories deployment/automation and deployment/apideployer differ only slightly from the above example of deployment/design. Names and labels now contain automation or apideployer instead of design. Images, resources, and volumes are configured slightly differently. See the example automation/kustomization.yaml below.", "Having different contents in automation/resources.yaml and automation/volumes.yaml allows to define different K8s resource requests and the usage of installation-specific volumes as necessary.", "The main part of the deployment configuration, especially the two additional sidecar containers and their volumes for each pod, remains the same and can be maintained easily in one place.", "Kustomize saves us from multiplicating the common part: The contents of base/dss-deploymnet.yaml and base/service.yaml with over a hundred lines of YAML code.", "Kustomize features, described in this article, can be a tremendous help to maintain multiple Kubernetes pods with similar definitions. The advantage is undeniable. I hope that the detailed description of the features above can help you adapt to your actual situation.", "Note: Kustomize output does not maintain the original order of the configuration, making it a little bit difficult to compare with the above examples.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Lead Data Scientist @ Telef\u00f3nica; Visit my LinkedIn profile: https://de.linkedin.com/in/fabiantibor"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fad8bacffbc07&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkustomize-explained-an-mlops-use-case-ad8bacffbc07&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkustomize-explained-an-mlops-use-case-ad8bacffbc07&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkustomize-explained-an-mlops-use-case-ad8bacffbc07&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkustomize-explained-an-mlops-use-case-ad8bacffbc07&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----ad8bacffbc07--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----ad8bacffbc07--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://tibor-fabian.medium.com/?source=post_page-----ad8bacffbc07--------------------------------", "anchor_text": ""}, {"url": "https://tibor-fabian.medium.com/?source=post_page-----ad8bacffbc07--------------------------------", "anchor_text": "Tibor Fabian"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F41751d3c5caf&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkustomize-explained-an-mlops-use-case-ad8bacffbc07&user=Tibor+Fabian&userId=41751d3c5caf&source=post_page-41751d3c5caf----ad8bacffbc07---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fad8bacffbc07&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkustomize-explained-an-mlops-use-case-ad8bacffbc07&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fad8bacffbc07&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkustomize-explained-an-mlops-use-case-ad8bacffbc07&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://github.com/kubernetes-sigs/kustomize", "anchor_text": "Kustomize"}, {"url": "https://unsplash.com/@eprouzet?utm_source=medium&utm_medium=referral", "anchor_text": "Eric Prouzet"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://github.com/kubernetes-sigs/kustomize/tree/master/examples", "anchor_text": "great examples"}, {"url": "https://tibor-fabian.medium.com/mlops-w-dataiku-dss-on-kubernetes-505ee9a2e15a", "anchor_text": "MLOps w/ Dataiku DSS on Kubernetes"}, {"url": "https://github.com/tibfab/dss-at-k8s.git", "anchor_text": "https://github.com/tibfab/dss-at-k8s.git"}, {"url": "https://github.com/tibfab/dss-at-k8s/blob/master/deployment/base/dss-deployment.yaml", "anchor_text": "\u260d"}, {"url": "https://github.com/tibfab/dss-at-k8s/blob/master/deployment/base/service.yaml", "anchor_text": "\u260d"}, {"url": "https://github.com/tibfab/dss-at-k8s/tree/master/deployment", "anchor_text": "GitHub repo"}, {"url": "https://medium.com/tag/kubernetes?source=post_page-----ad8bacffbc07---------------kubernetes-----------------", "anchor_text": "Kubernetes"}, {"url": "https://medium.com/tag/docker?source=post_page-----ad8bacffbc07---------------docker-----------------", "anchor_text": "Docker"}, {"url": "https://medium.com/tag/mlops?source=post_page-----ad8bacffbc07---------------mlops-----------------", "anchor_text": "Mlops"}, {"url": "https://medium.com/tag/data-science?source=post_page-----ad8bacffbc07---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/customization?source=post_page-----ad8bacffbc07---------------customization-----------------", "anchor_text": "Customization"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fad8bacffbc07&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkustomize-explained-an-mlops-use-case-ad8bacffbc07&user=Tibor+Fabian&userId=41751d3c5caf&source=-----ad8bacffbc07---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fad8bacffbc07&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkustomize-explained-an-mlops-use-case-ad8bacffbc07&user=Tibor+Fabian&userId=41751d3c5caf&source=-----ad8bacffbc07---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fad8bacffbc07&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkustomize-explained-an-mlops-use-case-ad8bacffbc07&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----ad8bacffbc07--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fad8bacffbc07&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkustomize-explained-an-mlops-use-case-ad8bacffbc07&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----ad8bacffbc07---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----ad8bacffbc07--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----ad8bacffbc07--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----ad8bacffbc07--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----ad8bacffbc07--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----ad8bacffbc07--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----ad8bacffbc07--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----ad8bacffbc07--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----ad8bacffbc07--------------------------------", "anchor_text": ""}, {"url": "https://tibor-fabian.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://tibor-fabian.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Tibor Fabian"}, {"url": "https://tibor-fabian.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "26 Followers"}, {"url": "https://de.linkedin.com/in/fabiantibor", "anchor_text": "https://de.linkedin.com/in/fabiantibor"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F41751d3c5caf&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkustomize-explained-an-mlops-use-case-ad8bacffbc07&user=Tibor+Fabian&userId=41751d3c5caf&source=post_page-41751d3c5caf--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F819017a298e1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkustomize-explained-an-mlops-use-case-ad8bacffbc07&newsletterV3=41751d3c5caf&newsletterV3Id=819017a298e1&user=Tibor+Fabian&userId=41751d3c5caf&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}