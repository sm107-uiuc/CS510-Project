{"url": "https://towardsdatascience.com/custom-metrics-in-keras-and-how-simple-they-are-to-use-in-tensorflow2-2-6d079c2ca279", "time": 1683010213.734817, "path": "towardsdatascience.com/custom-metrics-in-keras-and-how-simple-they-are-to-use-in-tensorflow2-2-6d079c2ca279/", "webpage": {"metadata": {"title": "Custom metrics in tensorflow2.2 | Towards Data Science", "h1": "Custom metrics in Keras and how simple they are to use in tensorflow2.2", "description": "Tensorflow2.2 makes implementing per-class statistics like recall and precision during training very simple and can be used to implement dynamic training."}, "outgoing_paragraph_urls": [{"url": "https://colab.research.google.com/github/borundev/ml_cookbook/blob/master/Custom%20Metric%20(Confusion%20Matrix)%20and%20train_step%20method.ipynb", "anchor_text": "notebook", "paragraph_index": 0}, {"url": "https://colab.research.google.com/github/borundev/ml_cookbook/blob/master/Custom%20Metric%20(Confusion%20Matrix)%20and%20train_step%20method.ipynb", "anchor_text": "jupyter notebook", "paragraph_index": 5}, {"url": "https://colab.research.google.com/github/borundev/ml_cookbook/blob/master/Custom%20Metric%20(Confusion%20Matrix)%20and%20train_step%20method.ipynb", "anchor_text": "jupyter notebook", "paragraph_index": 8}], "all_paragraphs": ["Keras has simplified DNN based machine learning a lot and it keeps getting better. Here we show how to implement metric based on the confusion matrix (recall, precision and f1) and show how using them is very simple in tensorflow 2.2. You can directly run the notebook in Google Colab.", "When considering a multi-class problem it is often said that accuracy is not a good metric if the classes are imbalanced. While that is certainly true, accuracy is also a bad metric when all classes do not train equally well even if the datasets are balanced.", "In this article, I will use Fashion MNIST to highlight this aspect. This is however not the only goal of this article as this can be done by simply plotting the confusion matrix on the validation set at the end of training. What we discuss here is the ability to easily extend keras.metrics.Metric class to make a metric that tracks the confusion matrix during training and can be used to follow the class specific recall, precision and f1 and plot them in the usual way with keras.", "Getting class specific recall, precision and f1 during training is useful for at least two things:", "Furthermore, since tensorflow 2.2, integrating such custom metrics into training and validation has become very easy thanks to the new model methods train_step and test_step. There is also an associate predict_step that we do not use here but works in the same spirit.", "So lets get down to it. We first make a custom metric class. While there are more steps to this and they are show in the referenced jupyter notebook, the important thing is to implement the API that integrates with the rest of Keras training and testing workflow. That is as simple as implementing and update_state that takes in the true labels and predictions, a reset_states that re-initializes the metric.", "In the normal Keras workflow, the method result will be called and it will return a number and nothing else needs to be done. However, in our case we have three tensors for precision, recall and f1 being returned and Keras does not know how to handle this out of the box. This is where the new features of tensorflow 2.2 come in.", "Since tensorflow 2.2 it is possible to modify what happens in each train step (i.e. training on a mini-batch) transparently (whereas earlier one had to write an unbounded function that was called in a custom training loop and one had to take care of decorating it with tf.function to enable autographing).", "Again, details are in the referenced jupyter notebook but the crux is the following", "That\u2019s it. Now you can create (using the above class not keras.Sequential), compile and fit a sequential model (the procedure to do with with Functional and Subclassing API is straightfoward and one just implements the above function). The resulting history now has elements like val_F1_1 etc.", "The advantage of this is that we can see how individual classes train", "We see that class 6 trains pretty bad with an F1 of around .6 on the validation set but the training itself is stable (the plot doesn\u2019t jump around too much).", "As mentioned in the beginning, getting the per-class metrics during training is useful for at least two things:", "Finally, let's look at the confusion matrix to see what is happening with class 6", "In the confusion matrix, true classes are on the y-axis and predicted ones on the x-axis. We see that shirts (6), are being incorrectly labeled mostly as t-shirts (0), pullovers(2) and coats (4). Conversely, the mislabelling as shirts happens mostly for t-shirts. These kinds of mistakes are reasonable and I will discuss in a separate article what can be done to improve training in such cases.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Formless and shapeless pure consciousness masquerading as a machine learning researcher, a theoretical physicist and a quant."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F6d079c2ca279&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-metrics-in-keras-and-how-simple-they-are-to-use-in-tensorflow2-2-6d079c2ca279&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-metrics-in-keras-and-how-simple-they-are-to-use-in-tensorflow2-2-6d079c2ca279&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-metrics-in-keras-and-how-simple-they-are-to-use-in-tensorflow2-2-6d079c2ca279&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-metrics-in-keras-and-how-simple-they-are-to-use-in-tensorflow2-2-6d079c2ca279&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----6d079c2ca279--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----6d079c2ca279--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://borundev.medium.com/?source=post_page-----6d079c2ca279--------------------------------", "anchor_text": ""}, {"url": "https://borundev.medium.com/?source=post_page-----6d079c2ca279--------------------------------", "anchor_text": "Borun Chowdhury Ph.D."}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F5932426de083&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-metrics-in-keras-and-how-simple-they-are-to-use-in-tensorflow2-2-6d079c2ca279&user=Borun+Chowdhury+Ph.D.&userId=5932426de083&source=post_page-5932426de083----6d079c2ca279---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F6d079c2ca279&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-metrics-in-keras-and-how-simple-they-are-to-use-in-tensorflow2-2-6d079c2ca279&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F6d079c2ca279&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-metrics-in-keras-and-how-simple-they-are-to-use-in-tensorflow2-2-6d079c2ca279&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://colab.research.google.com/github/borundev/ml_cookbook/blob/master/Custom%20Metric%20(Confusion%20Matrix)%20and%20train_step%20method.ipynb", "anchor_text": "notebook"}, {"url": "https://colab.research.google.com/github/borundev/ml_cookbook/blob/master/Custom%20Metric%20(Confusion%20Matrix)%20and%20train_step%20method.ipynb", "anchor_text": "jupyter notebook"}, {"url": "https://colab.research.google.com/github/borundev/ml_cookbook/blob/master/Custom%20Metric%20(Confusion%20Matrix)%20and%20train_step%20method.ipynb", "anchor_text": "jupyter notebook"}, {"url": "https://github.com/borundev/ml_cookbook/blob/master/Custom%20Metric%20(Confusion%20Matrix)%20and%20train_step%20method.ipynb", "anchor_text": "Code on github"}, {"url": "https://colab.research.google.com/github/borundev/ml_cookbook/blob/master/Custom%20Metric%20(Confusion%20Matrix)%20and%20train_step%20method.ipynb", "anchor_text": "notebook"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----6d079c2ca279---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/tensorflow?source=post_page-----6d079c2ca279---------------tensorflow-----------------", "anchor_text": "TensorFlow"}, {"url": "https://medium.com/tag/keras?source=post_page-----6d079c2ca279---------------keras-----------------", "anchor_text": "Keras"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----6d079c2ca279---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/tag/tensorflow2?source=post_page-----6d079c2ca279---------------tensorflow2-----------------", "anchor_text": "Tensorflow2"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F6d079c2ca279&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-metrics-in-keras-and-how-simple-they-are-to-use-in-tensorflow2-2-6d079c2ca279&user=Borun+Chowdhury+Ph.D.&userId=5932426de083&source=-----6d079c2ca279---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F6d079c2ca279&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-metrics-in-keras-and-how-simple-they-are-to-use-in-tensorflow2-2-6d079c2ca279&user=Borun+Chowdhury+Ph.D.&userId=5932426de083&source=-----6d079c2ca279---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F6d079c2ca279&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-metrics-in-keras-and-how-simple-they-are-to-use-in-tensorflow2-2-6d079c2ca279&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----6d079c2ca279--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F6d079c2ca279&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-metrics-in-keras-and-how-simple-they-are-to-use-in-tensorflow2-2-6d079c2ca279&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----6d079c2ca279---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----6d079c2ca279--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----6d079c2ca279--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----6d079c2ca279--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----6d079c2ca279--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----6d079c2ca279--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----6d079c2ca279--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----6d079c2ca279--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----6d079c2ca279--------------------------------", "anchor_text": ""}, {"url": "https://borundev.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://borundev.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Borun Chowdhury Ph.D."}, {"url": "https://borundev.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "84 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F5932426de083&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-metrics-in-keras-and-how-simple-they-are-to-use-in-tensorflow2-2-6d079c2ca279&user=Borun+Chowdhury+Ph.D.&userId=5932426de083&source=post_page-5932426de083--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fe7dab1940968&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-metrics-in-keras-and-how-simple-they-are-to-use-in-tensorflow2-2-6d079c2ca279&newsletterV3=5932426de083&newsletterV3Id=e7dab1940968&user=Borun+Chowdhury+Ph.D.&userId=5932426de083&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}