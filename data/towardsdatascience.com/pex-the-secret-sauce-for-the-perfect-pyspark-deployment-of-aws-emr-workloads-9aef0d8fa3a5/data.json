{"url": "https://towardsdatascience.com/pex-the-secret-sauce-for-the-perfect-pyspark-deployment-of-aws-emr-workloads-9aef0d8fa3a5", "time": 1683006268.901414, "path": "towardsdatascience.com/pex-the-secret-sauce-for-the-perfect-pyspark-deployment-of-aws-emr-workloads-9aef0d8fa3a5/", "webpage": {"metadata": {"title": "PEX \u2014 The secret sauce for the perfect PySpark deployment of AWS EMR workloads | by Jan Teichmann | Towards Data Science", "h1": "PEX \u2014 The secret sauce for the perfect PySpark deployment of AWS EMR workloads", "description": "To run a PySpark application on EMR is surprisingly complex. PySpark Applications on EMR, the bad and the ugly: Cluster Bootstrapping. How to use PEX to speed up deployment of PySpark applications on ephemeral AWS EMR clusters, save time and money by removing the need of cluster bootstrapping."}, "outgoing_paragraph_urls": [{"url": "https://www.linkedin.com/in/janteichmann/", "anchor_text": "https://www.linkedin.com/in/janteichmann/", "paragraph_index": 32}], "all_paragraphs": ["In the big data and data science world Spark has become a gold standard for almost anything else than deep learning:", "While the Scala Spark API plays a significant role in the data lake ELT workloads and data engineering, the data science and advanced analytics spaces are almost exclusively PySpark workloads written in Python. And most of these Spark workloads get executed on AWS EMR clusters. The average data driven company easily runs 100s of daily Spark jobs on an equally staggering number of short-lived ephemeral EMR clusters.", "The attractive price point of AWS Spot Instances has established a paradigm of running single Spark jobs on very short-lived EMR clusters. EMR provides the ephemeral compute resources and S3 the persistent storage for the data. It is perfectly common to push this pattern to the extreme with ephemeral EMR clusters composed of 100% Spot Instances, kamikaze style.", "There is just one big pain point to this pattern of ephemeral PySpark clusters: bootstrapping EMR clusters with Python packages.", "To run a PySpark application on EMR is surprisingly complex.", "With ephemeral EMR we have to bootstrap our cluster with our application requirements before every single run of a PySpark application. This should be a simple pip install of our PySpark application package. But the reality couldn\u2019t be further from simple.", "This approach to EMR has a few pain points:", "Considering how popular Python is, the Python toolchain is far from ideal and installing packages with complex dependency chains with pip ends often in the notorious dependency hell. Unfortunately, pip lacks a powerful dependency resolver.", "In commercial data science teams there is usually a second layer of complexity with private package indexes for proprietary code. And I bet that your private package index is slow. Therefore, a common EMR bootstrap script for your PySpark application might look like this:", "Wouldn\u2019t it be great if running a PySpark application was as simple as just calling an executable? No pip install of requirements. No main.py. No spark-submit with Spark memory configurations cluttering up Jenkins or Airflow.", "PEX (Python EXecutable) is a file format and associated tools to create a general purpose Python environment virtualization solution similar to virtualenv. PEX was originally developed at Twitter in 2011 to deploy Python applications to production. PEX files are self-contained executable Python virtual environments. The emphasis is on self-contained and executable which makes PEX files ideal for application deployment to production environments. With PEX files the only step required to deploy an application is to copy the file. No pip install and no PATH modifications required.", "With the help of PEX running a PySpark application on EMR no longer requires any bootstrapping!", "To create a PEX archive you use the pex utilities. You can simply install it with", "When you do this within a new Python virtual environment, you can use pex to package itself. The following command creates a pex file containing pex and requests, using the console script named \u201cpex\u201d. Save the created executable to ~/bin/pex and you can use pex in or outside of any virtualenv like any other executable on your PATH.", "There is one complication with PEX: the executable contains a self contained Python virtual environment but not the Python interpreter itself: the PEX executable is platform dependent. Currently, EMR runs Python 3.6.10 on Linux and you might develop on a Mac. Therefore, it\u2019s generally best practise to use Docker to create reproducible results.", "Build a docker image compatible with EMR to create your PEX archives within a docker container:", "If your organisation uses a private package index, e.g. Artifactory, then PEX shows another weakness: at the time of writing it does not expose parameters for the requests library via the CLI which means we cannot set a custom network timeout for pip when using PEX directly to resolve package dependencies. A workaround is to use a wheelhouse. The following script can be used to build a pex archive using a wheelhouse and a private package index with a custom timeout:", "Our aim is to package a fully self-contained PySpark application and run it without the need of spark-submit. Therefore, our Python main function has to create a SparkSession:", "You can pass any option from your usual spark-submit to the SparkSession builder.", "This allows you to execute your PySpark application inside a PEX executable for example like this:", "The final step is to execute our pex application as an EMR step. We will use the script-runner and a generic thin wrapper to execute a PEX as a step.", "The script-runner calls our thin wrapper which pulls a PEX file from S3 and executes it with all environment variables and command line arguments we might need. The following script is a thin wrapper called pex-executor.sh you can use. Simply put it on S3 to make it available to your EMR cluster:", "Now you can submit an EMR step, e.g. via Airflow\u2019s EmrAddStepsOperator:", "As you can see above, we first pass two s3 paths. The first to our thin wrapper called pex-executor.sh which will be executed by AWS script-runner.jar. The pex-executor script in turn will download the application pex executable.", "We also define two environment variables HADOOP_HOME and SPARK_HOME which are needed for EMR. You could add any additional environment variables you might want.", "We then pass the name of the executable and pass any CLI parameters for our Python application.", "PEX allows us to run PySpark applications as fully self-contained executables just like a Spark application with an uber-JAR or fat-JAR would allow were we to use the Scala API.", "This greatly simplifies the use of ephemeral EMR clusters with PySpark and saves time and saves money as we do not have to bootstrap the cluster.", "Wrap the creation of your pex executables into a Jenkins pipeline and you have a powerful DevOps pattern to build packages and upload them to S3 for deployment.", "You can then schedule your PySpark applications for example with Airflow. Because your PEX applications are fully self-contained you will be able to create extremely generic DAGs in Airflow without that application any application logic and configurations end up scattered across multiple platforms and repositories.", "Jan is a successful thought leader and consultant in the data transformation of companies and has a track record of bringing data science into commercial production usage at scale. He has recently been recognised by dataIQ as one of the 100 most influential data and analytics practitioners in the UK.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "I\u2019m a Data Scientist by Profession; Techie, Geek and Innovator with Passion. https://www.linkedin.com/in/janteichmann/"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F9aef0d8fa3a5&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpex-the-secret-sauce-for-the-perfect-pyspark-deployment-of-aws-emr-workloads-9aef0d8fa3a5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpex-the-secret-sauce-for-the-perfect-pyspark-deployment-of-aws-emr-workloads-9aef0d8fa3a5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpex-the-secret-sauce-for-the-perfect-pyspark-deployment-of-aws-emr-workloads-9aef0d8fa3a5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpex-the-secret-sauce-for-the-perfect-pyspark-deployment-of-aws-emr-workloads-9aef0d8fa3a5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----9aef0d8fa3a5--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----9aef0d8fa3a5--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@jan.teichmann?source=post_page-----9aef0d8fa3a5--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@jan.teichmann?source=post_page-----9aef0d8fa3a5--------------------------------", "anchor_text": "Jan Teichmann"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F941c2fa7cfd&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpex-the-secret-sauce-for-the-perfect-pyspark-deployment-of-aws-emr-workloads-9aef0d8fa3a5&user=Jan+Teichmann&userId=941c2fa7cfd&source=post_page-941c2fa7cfd----9aef0d8fa3a5---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F9aef0d8fa3a5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpex-the-secret-sauce-for-the-perfect-pyspark-deployment-of-aws-emr-workloads-9aef0d8fa3a5&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F9aef0d8fa3a5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpex-the-secret-sauce-for-the-perfect-pyspark-deployment-of-aws-emr-workloads-9aef0d8fa3a5&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://www.flickr.com/photos/janpersiel/27706588173", "anchor_text": "https://www.flickr.com/photos/janpersiel/27706588173"}, {"url": "https://xkcd.com/1987/", "anchor_text": "https://xkcd.com/1987/"}, {"url": "https://private.registry.dev/pypi/simple", "anchor_text": "https://private.registry.dev/pypi/simple"}, {"url": "https://www.linkedin.com/in/janteichmann/", "anchor_text": "https://www.linkedin.com/in/janteichmann/"}, {"url": "https://medium.com/@jan.teichmann", "anchor_text": "https://medium.com/@jan.teichmann"}, {"url": "https://medium.com/tag/data-science?source=post_page-----9aef0d8fa3a5---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/towards-data-science?source=post_page-----9aef0d8fa3a5---------------towards_data_science-----------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/tag/devops?source=post_page-----9aef0d8fa3a5---------------devops-----------------", "anchor_text": "DevOps"}, {"url": "https://medium.com/tag/spark?source=post_page-----9aef0d8fa3a5---------------spark-----------------", "anchor_text": "Spark"}, {"url": "https://medium.com/tag/software-development?source=post_page-----9aef0d8fa3a5---------------software_development-----------------", "anchor_text": "Software Development"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F9aef0d8fa3a5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpex-the-secret-sauce-for-the-perfect-pyspark-deployment-of-aws-emr-workloads-9aef0d8fa3a5&user=Jan+Teichmann&userId=941c2fa7cfd&source=-----9aef0d8fa3a5---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F9aef0d8fa3a5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpex-the-secret-sauce-for-the-perfect-pyspark-deployment-of-aws-emr-workloads-9aef0d8fa3a5&user=Jan+Teichmann&userId=941c2fa7cfd&source=-----9aef0d8fa3a5---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F9aef0d8fa3a5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpex-the-secret-sauce-for-the-perfect-pyspark-deployment-of-aws-emr-workloads-9aef0d8fa3a5&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----9aef0d8fa3a5--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F9aef0d8fa3a5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpex-the-secret-sauce-for-the-perfect-pyspark-deployment-of-aws-emr-workloads-9aef0d8fa3a5&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----9aef0d8fa3a5---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----9aef0d8fa3a5--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----9aef0d8fa3a5--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----9aef0d8fa3a5--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----9aef0d8fa3a5--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----9aef0d8fa3a5--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----9aef0d8fa3a5--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----9aef0d8fa3a5--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----9aef0d8fa3a5--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@jan.teichmann?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@jan.teichmann?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Jan Teichmann"}, {"url": "https://medium.com/@jan.teichmann/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "1.2K Followers"}, {"url": "https://www.linkedin.com/in/janteichmann/", "anchor_text": "https://www.linkedin.com/in/janteichmann/"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F941c2fa7cfd&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpex-the-secret-sauce-for-the-perfect-pyspark-deployment-of-aws-emr-workloads-9aef0d8fa3a5&user=Jan+Teichmann&userId=941c2fa7cfd&source=post_page-941c2fa7cfd--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F463734a42bc7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpex-the-secret-sauce-for-the-perfect-pyspark-deployment-of-aws-emr-workloads-9aef0d8fa3a5&newsletterV3=941c2fa7cfd&newsletterV3Id=463734a42bc7&user=Jan+Teichmann&userId=941c2fa7cfd&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}