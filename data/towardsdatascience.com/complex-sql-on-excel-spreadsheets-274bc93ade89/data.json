{"url": "https://towardsdatascience.com/complex-sql-on-excel-spreadsheets-274bc93ade89", "time": 1682994705.075362, "path": "towardsdatascience.com/complex-sql-on-excel-spreadsheets-274bc93ade89/", "webpage": {"metadata": {"title": "Complex SQL on Excel Spreadsheets | by Vahid Fazel-Rezai | Towards Data Science", "h1": "Complex SQL on Excel Spreadsheets", "description": "In 2016, Indiana saw its Pell grant awards decrease by $200M. Why? The answer lies somewhere in the Department of Education\u2019s spreadsheet data. We can use SQL to extract it."}, "outgoing_paragraph_urls": [{"url": "https://www.bloomberg.com/news/articles/2019-01-16/high-student-debt-is-driving-low-millennial-homeownership-rates", "anchor_text": "hot topic in today\u2019s news", "paragraph_index": 3}, {"url": "https://www2.ed.gov/programs/fpg/index.html", "anchor_text": "Federal Pell Grant Program", "paragraph_index": 3}, {"url": "https://www2.ed.gov/finaid/prof/resources/data/pell-institution.html", "anchor_text": "Department of Education\u2019s website", "paragraph_index": 5}, {"url": "https://rockset.com/", "anchor_text": "Rockset", "paragraph_index": 6}, {"url": "https://trends.collegeboard.org/student-aid/figures-tables/undergraduate-enrollment-and-percentage-receiving-pell-grants-over-time", "anchor_text": "this figure", "paragraph_index": 17}, {"url": "https://www.amcharts.com/demos/us-heat-map", "anchor_text": "this", "paragraph_index": 17}, {"url": "https://www.ibj.com/articles/60122-update-feds-ban-itt-educational-from-enrolling-students-on-federal-aid", "anchor_text": "banned ITT Tech", "paragraph_index": 20}, {"url": "https://www.nytimes.com/2016/09/18/business/itt-educational-services-files-for-bankruptcy-after-aid-crackdown.html", "anchor_text": "declared bankruptcy", "paragraph_index": 20}, {"url": "https://collegescorecard.ed.gov/data/", "anchor_text": "College Scorecard", "paragraph_index": 21}, {"url": "https://collegescorecard.ed.gov/data/documentation/", "anchor_text": "here", "paragraph_index": 25}], "all_paragraphs": ["In 2016, Indiana saw its Pell grant awards decrease by $200M. Why? The answer lies somewhere in the Department of Education\u2019s spreadsheet data. We can use SQL to extract it.", "A vast trove of the world\u2019s data is similarly locked away in spreadsheets. Tools like Excel are widely used and fantastic for viewing the data. However, as modern data gets bigger and ever-more interconnected, performing complex analysis can get difficult \u2014 illegibly long formulas, wrangling with data frames, even cleaning up CSVs in Sublime Text (I\u2018ve been there\u2026).", "There must be a better way. In this post we will show how to tackle the challenge using a tool that is even older than Excel: SQL.", "The affordability (or unaffordability) of college in America is a hot topic in today\u2019s news. One of the largest sources of financial aid for students is the Federal Pell Grant Program, so we looked to find data that quantified the impact of the program.", "Suppose we want to answer the following questions:", "A quick search reveals that data listing Pell grant disbursements by institution is publicly available on the Department of Education\u2019s website as .XLSX files (Excel spreadsheets). This will be the starting point of our investigation.", "Let\u2019s move the disbursement data into Rockset, a service that can parse and run SQL queries on semi-structured data, including Excel files for our case. In the Rockset console, we create a new empty collection and call it pell_disbursements.", "Next, we download the Excel file from DoE and upload it directly into the Rockset console.", "Rockset will index the file\u2019s contents so that it is ready to be queried.", "Let\u2019s start by understanding the shape of the data. We use the DESCRIBE command to list the available fields in our collection:", "We see that Rockset has parsed the spreadsheet\u2019s columns in fields B through H, as well as useful metadata including:", "Each document in Rockset corresponds to one row of the spreadsheet, so let\u2019s query the first several rows to discern the meaning of each column:", "We see that the fifth row has headers for each column, and the raw data starts in the sixth row. Using a WITH clause, let's construct a subquery called pd that returns just the data we care about:", "This is exciting \u2014 we can use the full breadth of SQL capabilities to comb through this data! Let\u2019s write a query to find the answer to our first question, the institution with the most awards in New York:", "We see that the top institution, with about $76M in Pell awards and significantly more than the next institution, is the Borough of Manhattan Community College.", "Let\u2019s bring in data from 2015\u20132016. We download the data for that year and upload the .XLSX file into the same pell_disbursements collection.  We use the same steps as above, this time filtering by file name, to construct another subquery for 2015-2016 data. Note that the second file has a slightly different format (row offset, column headers, and data type in OPE ID column), so we have to adjust our query appropriately.", "Next we can match up data for each institution across the two years to compute the year-over-year change in number of Pell recipients. We aggregate by state and order from least to greatest:", "We can see that in all but three states the number of Pell grant recipients actually decreased (albeit two of them, Washington, D.C. and the Marshall Islands, are technically not states). This is part of a larger trend as noted by CollegeBoard in this figure. The outlier by far is Indiana, where the recipient count decreased by 27.7%.  Let\u2019s see this data on a map. We can use this readily available US heat map demo from amCharts. To match the data format amCharts expects, we rename the columns and then export the results as a JSON:", "Next we paste the JSON right into the demo code and immediately generate an interactive heat map!", "We visually observe pockets of states near Utah and the Deep South that retained their Pell student counts, and again see Indiana is indeed the outlier in losing Pell students. What happened in Indiana that year? Why such a dramatic change? Let\u2019s dig in. We list changes in the number of students reported receiving Pell grants by institution in just Indiana:", "And therein lies the rub! ITT Technical Institute contributed a drop of nearly 40,000 students, and a quick search reveals the backstory. In August 2016, the Department of Education banned ITT Tech from enrolling new students with federal aid after a series of charges of fraud and misleading students. ITT Tech declared bankruptcy the following month.", "Let\u2019s broaden this investigation to include data about other aspects of an institution. Specifically, we might wonder whether there is any correlation between grant size and whether an institution is categorized as all-male/all-female. A terrific dataset that can help us is the College Scorecard, managed by the Department of Education. We download the data for 2016\u20132017 as a CSV file and upload into a new Rockset collection:", "In order to line this up with the Pell grant data, we use institutions\u2019 OPE IDs (Office of Postsecondary Education Identification, assigned by the U.S. Department of Education). We note that the College Scorecard has two OPE ID columns, one for 6-digit and one for 8-digit IDs:", "Meanwhile, the Pell grant data is slightly mangled. The original Excel file has IDs stored as numeric (so its leading 0\u2019s are stripped) and appends two additional digits to each ID:", "We can fix all this in our Rockset query. We use SQL functions to massage the ID, then use a JOIN to compare institution names and check if they line up.", "Looks good! With a JOIN, we don\u2019t need any prior data preparation to combine datasets \u2014 we are free to explore without predefined boundaries on which data we can use. The College Scorecard documents a huge variety of attributes regarding each institution, check it out here. In our investigation, we compute the average grant size for institutions that are all-male/all-female compared to the rest:", "We\u2019ll stop here, but you can imagine the endless angles to explore:", "If you would like to run your own queries with this data, go wild! Just reach out to hello@rockset.com to get access. (Full disclosure: I work at Rockset.)", "SQL is commonly used to query data in traditional databases, but here we\u2019ve seen how it can also be useful with data outside that context. The flexibility and complexity of SQL allows for data to be massaged on the fly, aggregated in arbitrary ways, and combined efficiently with data elsewhere. As we find new ways to query semi-structured, I think SQL has potential to put even more and more of the world\u2019s data to positive use.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F274bc93ade89&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcomplex-sql-on-excel-spreadsheets-274bc93ade89&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcomplex-sql-on-excel-spreadsheets-274bc93ade89&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcomplex-sql-on-excel-spreadsheets-274bc93ade89&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcomplex-sql-on-excel-spreadsheets-274bc93ade89&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----274bc93ade89--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----274bc93ade89--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@vahidfazelrezai?source=post_page-----274bc93ade89--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@vahidfazelrezai?source=post_page-----274bc93ade89--------------------------------", "anchor_text": "Vahid Fazel-Rezai"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Ffad033e97b2c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcomplex-sql-on-excel-spreadsheets-274bc93ade89&user=Vahid+Fazel-Rezai&userId=fad033e97b2c&source=post_page-fad033e97b2c----274bc93ade89---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F274bc93ade89&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcomplex-sql-on-excel-spreadsheets-274bc93ade89&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F274bc93ade89&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcomplex-sql-on-excel-spreadsheets-274bc93ade89&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://www.bloomberg.com/news/articles/2019-01-16/high-student-debt-is-driving-low-millennial-homeownership-rates", "anchor_text": "hot topic in today\u2019s news"}, {"url": "https://www2.ed.gov/programs/fpg/index.html", "anchor_text": "Federal Pell Grant Program"}, {"url": "https://www2.ed.gov/finaid/prof/resources/data/pell-institution.html", "anchor_text": "Department of Education\u2019s website"}, {"url": "https://rockset.com/", "anchor_text": "Rockset"}, {"url": "https://trends.collegeboard.org/student-aid/figures-tables/undergraduate-enrollment-and-percentage-receiving-pell-grants-over-time", "anchor_text": "this figure"}, {"url": "https://www.amcharts.com/demos/us-heat-map", "anchor_text": "this"}, {"url": "https://www.ibj.com/articles/60122-update-feds-ban-itt-educational-from-enrolling-students-on-federal-aid", "anchor_text": "banned ITT Tech"}, {"url": "https://www.nytimes.com/2016/09/18/business/itt-educational-services-files-for-bankruptcy-after-aid-crackdown.html", "anchor_text": "declared bankruptcy"}, {"url": "https://collegescorecard.ed.gov/data/", "anchor_text": "College Scorecard"}, {"url": "https://collegescorecard.ed.gov/data/documentation/", "anchor_text": "here"}, {"url": "https://www2.ed.gov/finaid/prof/resources/data/pell-institution.html", "anchor_text": "(Excel spreadsheet)"}, {"url": "https://www2.ed.gov/finaid/prof/resources/data/pell-institution.html", "anchor_text": "Excel spreadsheet"}, {"url": "https://collegescorecard.ed.gov/data/", "anchor_text": "CSV file"}, {"url": "https://rockset.com/", "anchor_text": "Rockset"}, {"url": "https://www.amcharts.com/", "anchor_text": "amCharts"}, {"url": "https://gist.github.com/", "anchor_text": "GitHub Gist"}, {"url": "https://codepen.io/", "anchor_text": "CodePen"}, {"url": "https://medium.com/tag/sql?source=post_page-----274bc93ade89---------------sql-----------------", "anchor_text": "Sql"}, {"url": "https://medium.com/tag/excel?source=post_page-----274bc93ade89---------------excel-----------------", "anchor_text": "Excel"}, {"url": "https://medium.com/tag/spreadsheets?source=post_page-----274bc93ade89---------------spreadsheets-----------------", "anchor_text": "Spreadsheets"}, {"url": "https://medium.com/tag/pell-grant?source=post_page-----274bc93ade89---------------pell_grant-----------------", "anchor_text": "Pell Grant"}, {"url": "https://medium.com/tag/data-science?source=post_page-----274bc93ade89---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F274bc93ade89&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcomplex-sql-on-excel-spreadsheets-274bc93ade89&user=Vahid+Fazel-Rezai&userId=fad033e97b2c&source=-----274bc93ade89---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F274bc93ade89&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcomplex-sql-on-excel-spreadsheets-274bc93ade89&user=Vahid+Fazel-Rezai&userId=fad033e97b2c&source=-----274bc93ade89---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F274bc93ade89&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcomplex-sql-on-excel-spreadsheets-274bc93ade89&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----274bc93ade89--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F274bc93ade89&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcomplex-sql-on-excel-spreadsheets-274bc93ade89&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----274bc93ade89---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----274bc93ade89--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----274bc93ade89--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----274bc93ade89--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----274bc93ade89--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----274bc93ade89--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----274bc93ade89--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----274bc93ade89--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----274bc93ade89--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@vahidfazelrezai?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@vahidfazelrezai?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Vahid Fazel-Rezai"}, {"url": "https://medium.com/@vahidfazelrezai/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "134 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Ffad033e97b2c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcomplex-sql-on-excel-spreadsheets-274bc93ade89&user=Vahid+Fazel-Rezai&userId=fad033e97b2c&source=post_page-fad033e97b2c--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fusers%2Ffad033e97b2c%2Flazily-enable-writer-subscription&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcomplex-sql-on-excel-spreadsheets-274bc93ade89&user=Vahid+Fazel-Rezai&userId=fad033e97b2c&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}