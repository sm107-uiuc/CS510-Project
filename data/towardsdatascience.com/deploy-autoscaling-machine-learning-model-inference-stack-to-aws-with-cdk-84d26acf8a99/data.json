{"url": "https://towardsdatascience.com/deploy-autoscaling-machine-learning-model-inference-stack-to-aws-with-cdk-84d26acf8a99", "time": 1683012612.22294, "path": "towardsdatascience.com/deploy-autoscaling-machine-learning-model-inference-stack-to-aws-with-cdk-84d26acf8a99/", "webpage": {"metadata": {"title": "Deploy autoscaling machine learning model inference stack to AWS with CDK | by Guillaume Androz | Towards Data Science", "h1": "Deploy autoscaling machine learning model inference stack to AWS with CDK", "description": "For several years now, data science and machine learning were sexy and lots of companies embraced \u201cartificial intelligence\u201d as a new powerful tool to automate complex tasks as a black box. In this\u2026"}, "outgoing_paragraph_urls": [{"url": "https://github.com/gandroz/deploy_model_ecs_medium", "anchor_text": "repository source code", "paragraph_index": 3}, {"url": "https://sqs.ca-central-1.amazonaws.com/1234567890/MediumArticleQueue", "anchor_text": "MediumArticleQueue", "paragraph_index": 6}, {"url": "https://github.com/gandroz/deploy_model_ecs_medium", "anchor_text": "repo", "paragraph_index": 7}, {"url": "https://github.com/aws/aws-cdk/pull/9192", "anchor_text": "PR", "paragraph_index": 8}], "all_paragraphs": ["For several years now, data science and machine learning were sexy and lots of companies embraced \u201cartificial intelligence\u201d as a new powerful tool to automate complex tasks as a black box. In this area, deep learning appears to be the Holy Grail to build models to detect and classify images or texts among other cool things. Once models are trained, it is common to deploy them on a small web server and expose a simple REST API to perform inference on a given sample. It is very convenient as usually, whereas training a model needs lots of computation power and lots of GPU, inference only needs a relatively low power CPU to make a prediction on a single sample. You could find numerous articles and blog posts on this approach; event open source projects and companies could be found to make the whole thing painless.", "There exist cases, however, where you need to perform inference on not just a sample, but on a batch of samples. In this case, inference can take a lot of time when performed on CPU and you need to use a GPU to parallelize the job. Using a small web server is now no more relevant as you don\u2019t want to pay for an ever running machine with an attached GPU. For example, imagine you have to perform some prediction on large files that are uploaded to your S3 bucket. Your file is first split into small chunks on which the model makes a prediction. What you want is your stack to automatically launch when a file is ready to process, use a machine with a GPU, and shut down the whole thing when there is nothing to process anymore. As there is no serverless stack available (will there be one, one day?), we need to build a stack to scale automatically to our need.", "The proposed architecture is the following: we get a SQS message with the task to perform. For example, it could be the name of a file on S3 to process. Depending on a configuration parameter found in the parameter store of AWS, this message is forwarded to another SQS queue, one for a CPU-based stack, and one for a GPU-based stack. An ECR cluster then uses Cloudwatch alarms to trigger the scaling of two autoscaling groups, one with CPU-only instances and one with GPU-enabled instances. The result is then returned into a S3 bucket.", "To automate a little more the whole thing, we can use a CDK application. Just like Terraform or Kubernetes offer to build a stack by code, CDK tends to be the reference to deploy stacks on AWS. You can of course use Cloudformation, but just the idea to use very large YAML files to manage a stack makes me run away. However, using a modern programming language like Typescript, C# or Python is way more interesting. In the repository source code, you could find two classes to build the stack : DeployModelEcsMediumStackCore and DeployModelEcsMediumStack. The first one as its name suggests builds the core of the stack i.e. the main SQS queue, attach a lambda function to it, an ECS cluster and the definition of some IAM policies. Then the DeployModelEcsMediumStack class builds a stack for the CPU or for the GPU architecture. A SQS queue and associated metrics, an autoscaling group with the right AMI, instance type and the scaling policies, and the ECS task with the right ECR image to retrieve.", "First, a cluster shall be created with ecs.Cluster construct. From there, we create an autoscaling group adding a capacity provider to the cluster with cluster.addCapacity static method. We then need to create a task with the construct ecs.Ec2TaskDefinition providing the proper ECR image retrieved with the static method ecs.ContainerImage.fromEcrRepository. The image has to be an ECS optimized AMI based image to work properly. There is no official AWS AMI that support GPU for ECS, but you can find custom ones. We also need to pay attention to the gpuCount property and set it to 1 when we want to use a GPU. Finally, the service is created with the construct ecs.Ec2Service and attached to the cluster.", "Once everything has been deployed, all you need is to send a message in the main SQS queue with the command to execute i.e. the name of the file to retrieve on S3 in my example. To decide whether to use a GPU based instance or a CPU only instance, we only need to change the configuration found in the parameter store in the system manager. An example of such a message could be", "There are three SQS queues in the proposed architecture, but the user only needs to send a message in the main queue MediumArticleQueue. Once a message is received, a lambda function is triggered and regarding to the configuration (a parameter in the SSM/Parameter Store), the message is forwarded to the proper queue, GPUQueue for an autoscaling group managing GPU based instances and CPUQueue for CPU only based instances.", "The typescript/python code for this CDK stack is a bit large to publish here, but you could find the sources in this repo. Feel free to copy or fork code, just a thumb up or a little comment would be appreciated.", "In the source code, I defined my alarms to scale the autoscaling group but not the tasks count. The reason is that when adding an ECS service, we also set its autoscaling behaviour with ecsService.autoScaleTaskCount method. However, AWS/CDK does not properly link task scaling and instance scaling, which is the role of the capacity provider. This behaviour can be achieved when you work directly in the console, but not programatically. There is a PR to correct it, but it was not available at the time this article was published. To later support this feature, I added a commented code section to illustrate what the code could look like when the feature is released.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F84d26acf8a99&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-autoscaling-machine-learning-model-inference-stack-to-aws-with-cdk-84d26acf8a99&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-autoscaling-machine-learning-model-inference-stack-to-aws-with-cdk-84d26acf8a99&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-autoscaling-machine-learning-model-inference-stack-to-aws-with-cdk-84d26acf8a99&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-autoscaling-machine-learning-model-inference-stack-to-aws-with-cdk-84d26acf8a99&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----84d26acf8a99--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----84d26acf8a99--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://guandroz.medium.com/?source=post_page-----84d26acf8a99--------------------------------", "anchor_text": ""}, {"url": "https://guandroz.medium.com/?source=post_page-----84d26acf8a99--------------------------------", "anchor_text": "Guillaume Androz"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fe9c80b7a94f6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-autoscaling-machine-learning-model-inference-stack-to-aws-with-cdk-84d26acf8a99&user=Guillaume+Androz&userId=e9c80b7a94f6&source=post_page-e9c80b7a94f6----84d26acf8a99---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F84d26acf8a99&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-autoscaling-machine-learning-model-inference-stack-to-aws-with-cdk-84d26acf8a99&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F84d26acf8a99&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-autoscaling-machine-learning-model-inference-stack-to-aws-with-cdk-84d26acf8a99&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/photos/jkuR9QteDGY", "anchor_text": "unsplash"}, {"url": "https://github.com/gandroz/deploy_model_ecs_medium", "anchor_text": "repository source code"}, {"url": "https://sqs.ca-central-1.amazonaws.com/1234567890/MediumArticleQueue", "anchor_text": "https://sqs.ca-central-1.amazonaws.com/1234567890/MediumArticleQueue"}, {"url": "https://sqs.ca-central-1.amazonaws.com/1234567890/MediumArticleQueue", "anchor_text": "MediumArticleQueue"}, {"url": "https://github.com/gandroz/deploy_model_ecs_medium", "anchor_text": "repo"}, {"url": "https://github.com/aws/aws-cdk/pull/9192", "anchor_text": "PR"}, {"url": "https://medium.com/tag/data-science?source=post_page-----84d26acf8a99---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----84d26acf8a99---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----84d26acf8a99---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/tag/programming?source=post_page-----84d26acf8a99---------------programming-----------------", "anchor_text": "Programming"}, {"url": "https://medium.com/tag/technology?source=post_page-----84d26acf8a99---------------technology-----------------", "anchor_text": "Technology"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F84d26acf8a99&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-autoscaling-machine-learning-model-inference-stack-to-aws-with-cdk-84d26acf8a99&user=Guillaume+Androz&userId=e9c80b7a94f6&source=-----84d26acf8a99---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F84d26acf8a99&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-autoscaling-machine-learning-model-inference-stack-to-aws-with-cdk-84d26acf8a99&user=Guillaume+Androz&userId=e9c80b7a94f6&source=-----84d26acf8a99---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F84d26acf8a99&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-autoscaling-machine-learning-model-inference-stack-to-aws-with-cdk-84d26acf8a99&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----84d26acf8a99--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F84d26acf8a99&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-autoscaling-machine-learning-model-inference-stack-to-aws-with-cdk-84d26acf8a99&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----84d26acf8a99---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----84d26acf8a99--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----84d26acf8a99--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----84d26acf8a99--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----84d26acf8a99--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----84d26acf8a99--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----84d26acf8a99--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----84d26acf8a99--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----84d26acf8a99--------------------------------", "anchor_text": ""}, {"url": "https://guandroz.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://guandroz.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Guillaume Androz"}, {"url": "https://guandroz.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "80 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fe9c80b7a94f6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-autoscaling-machine-learning-model-inference-stack-to-aws-with-cdk-84d26acf8a99&user=Guillaume+Androz&userId=e9c80b7a94f6&source=post_page-e9c80b7a94f6--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fe5973915e993&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-autoscaling-machine-learning-model-inference-stack-to-aws-with-cdk-84d26acf8a99&newsletterV3=e9c80b7a94f6&newsletterV3Id=e5973915e993&user=Guillaume+Androz&userId=e9c80b7a94f6&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}