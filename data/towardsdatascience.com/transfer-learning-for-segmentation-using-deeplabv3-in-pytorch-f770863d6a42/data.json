{"url": "https://towardsdatascience.com/transfer-learning-for-segmentation-using-deeplabv3-in-pytorch-f770863d6a42", "time": 1683017312.4699461, "path": "towardsdatascience.com/transfer-learning-for-segmentation-using-deeplabv3-in-pytorch-f770863d6a42/", "webpage": {"metadata": {"title": "Transfer Learning for Segmentation Using DeepLabv3 in PyTorch | by Manpreet Singh Minhas | Towards Data Science", "h1": "Transfer Learning for Segmentation Using DeepLabv3 in PyTorch", "description": "In this article, I'll be covering how to use a pre-trained semantic segmentation DeepLabv3 model for the task of road crack detection in PyTorch by using transfer learning."}, "outgoing_paragraph_urls": [{"url": "https://pytorch.org/docs/stable/generated/torch.nn.CrossEntropyLoss.html", "anchor_text": "https://pytorch.org/docs/stable/generated/torch.nn.CrossEntropyLoss.html", "paragraph_index": 27}, {"url": "https://github.com/msminhas93", "anchor_text": "https://github.com/msminhas93", "paragraph_index": 40}, {"url": "https://www.linkedin.com/in/msminhas93", "anchor_text": "https://www.linkedin.com/in/msminhas93", "paragraph_index": 40}], "all_paragraphs": ["Back when I was researching segmentation using Deep Learning and wanted to run some experiments on DeepLabv3[1] using PyTorch, I couldn\u2019t find any online tutorial. What added to the challenge was that torchvision not only does not provide a Segmentation dataset but also there is no detailed explanation available for the internal structure of the DeepLabv3 class. However, I did the transfer learning on my own, and want to share the procedure so that it may potentially be helpful for you.", "In this article, I\u2019ll be covering how to use a pre-trained semantic segmentation DeepLabv3 model for the task of road crack detection in PyTorch by using transfer learning. The same procedure can be applied to fine-tune the network for your custom dataset. If you want to look at the results and repository link directly, please scroll to the bottom.", "Let us start with a brief introduction to image segmentation. The primary goal of a segmentation task is to output pixel-level output masks in which regions belonging to certain categories are assigned the same distinct pixel value. If you color-code these segmentation masks by assigning a different color for every category for visualizing them, then you\u2019ll get something like an image from a coloring book for kids. An example is shown below.", "Segmentation has existed for a very long time in the domain of Computer Vision and Image processing. Some of the techniques are simple thresholding, clustering based methods such as k means clustering-segmentation, region growing methods, etc. [3]", "With recent advancements in deep learning and the success of convolutional neural networks in image-related tasks over the traditional methods, these techniques have also been applied to the task of image segmentation.", "One of these network architectures is DeepLabv3 by Google. Explaining how the model works is beyond the scope of this article. Instead, we shall focus on how to use a pre-trained DeepLabv3 network for our data-sets. We will discuss transfer learning briefly for this.", "Deep Learning models tend to struggle when limited data is available. And for most practical applications, getting access to a copious dataset can be very difficult if not impossible. Annotation is tedious and time-consuming. Even if you plan to outsource it, you would still have to shell out money. Efforts have been made to be able to train models from limited data. And of such techniques is called Transfer Learning.", "Transfer learning involves the use of a network pre-trained for a source domain and task (in which you hopefully have access to a large dataset) and adopting it for your intended/target domain and task (that is similar to the original task and domain)[4]. It can be conceptually represented by the following diagram.", "If you want to learn more about Transfer Learning, I talk about it in detail in my paper: Anomaly Detection in Images [4]. Next, I\u2019ll talk about the dataset being used in this article before proceeding with the PyTorch related sections.", "For this tutorial, I\u2019ll be using the CrackForest[5][6] dataset for road crack detection using segmentation. It consists of urban road surface images with cracks as defects. The images contain confounding regions such as shadows, oil spills, and water stains. The images were taken using an ordinary iPhone5 camera. The dataset contains 118 images and has corresponding pixel level masks for the cracks, all having a size of 320\u00d7480. The additional confounders along with the limited number of samples available for training make CrackForest a challenging dataset [7].", "Let us begin by constructing a dataset class for our model which will be used to get training samples. For segmentation, instead of a single valued numeric label that could be one hot encoded, we have a ground truth mask image as the label. The mask has pixel level annotations available as shown in Fig. 3. Therefore, the training tensors for both input and labels would be four dimensional. For PyTorch, these would be: batch_size x channels x height x width.", "We will be defining our segmentation dataset class now. The class definition is as follows.", "We use the VisionDataset class from torchvision as the base class for the Segmentation dataset. Following three method need to be overloaded.", "I\u2019ve added additional functionality to allow you to keep your dataset in a single directory instead of splitting the Train, Val into separate folders because a lot of datasets I was using weren\u2019t in this format and I didn\u2019t want to restructure my folder structure every time.", "Now that we have the dataset class defined, the next step is to create a PyTorch data loader from this. Data loaders allow you to create batches of data samples and labels using multiprocessing. This makes the data loading process much faster and efficient. The DataLoader class available under torch.utils.data is used for this purpose. The creation process itself is straightforward. You create a DataLoader object by passing the dataset object to it. The supported arguments are shown below.", "Few useful arguments are explained below:", "Additionally, I\u2019ve written two helper functions that give you data loaders depending on your data directory structure and are available in datahandler.py file.", "2. get_dataloader_single_folder: Create from a single folder. The structure should be as follows.", "These give you training and validation data loaders that shall be used in the training process.", "Next, we discuss the crux of this tutorial i.e. how to load a pre-trained model and change the segmentation head according to our data requirements.", "Torchvision has pre-trained models available and we shall be using one of those models. I\u2019ve written the following function which gives you a model that has a custom number of output channels. You can change this value if you have more than one class.", "So far we\u2019ve covered how to create the data loaders and the DeepLabv3 model with the modified head.", "The next step is to train the model.", "I\u2019ve defined the following train_model function that trains the model. It saves the training and validation loss and metric (if specified) values into a CSV log file for easy access. The training code is as follows. It is well documented to explain what is going on.", "However, I\u2019ll share a few things to keep in mind.", "The best model is decided by the lowest loss value. You can select the best model based on an evaluation metric too. But you\u2019ll have to modify the code a bit.", "I\u2019ve used the mean squared error (MSE) loss function for this task. The reason I used MSE is that it is a simple function, provides better results and gives a better surface for calculating the gradients. The loss is calculated at the pixel level in our case and is defined as follows:", "Note: This loss function won\u2019t work for datasets that have more than one channel. For those cases, you will have to use cross-entropy instead. https://pytorch.org/docs/stable/generated/torch.nn.CrossEntropyLoss.html", "I\u2019ve used the Adadelta optimizer with the default settings and a learning rate of 0.0001. The training was done for 25 epochs.", "To evaluate the quantitative performance of the models, two metrics were selected. The first metric was the area undercurve (AUC) measurement of the receiver operating characteristics (ROC) [8]. AUC or AUROC is a reliable measure of the degree or measure of the separability of any binary classifier (binary segmentation masks in this case). It provides an aggregate measure of the model\u2019s performance across all possible classification thresholds. An excellent model has AUROC value near to the one and it means that the classifier is virtually agnostic to the choice of a particular threshold. The second metric used for the assessment was the F1 score. It is defined as the harmonic mean of precision (P) and recall (R) and is given by the following equation.", "F1 score reaches its best value at one and the worst score at zero. It is a robust choice for classification tasks since it takes both the false positives and false negatives into account.", "The best model achieved a testing AUROC value of 0.842. This is a great score and is also reflected by segmentation output obtained after a thresholding operation.", "I\u2019ve shown the loss and evaluation metrics during the training in the following graph.", "We can observe that the loss value decreased throughout the training. The AUROC and F1 Score values improved with the training. However, we see that the F1 Score values are consistently lower for both training and validation. In fact, these are poor values. The reason for this observation is that I used a threshold of 0.1 for calculating this metric. This wasn\u2019t selected based on the dataset. F1 Score value can change depending on the threshold. However, AUROC is a robust metric that takes into account all possible thresholds. So when you have a binary classification task, it is advisable to use the AUROC metric. Even though the model is performing well on the dataset, as can be seen from the Segmentation Output image, the masks are over dilated in comparison to the ground truth. Maybe since the model is deeper than required, we are observing this kind of behavior. If you have any comments about this phenomenon, please do comment, I would love to know your thoughts.", "With this, we have reached the end of the tutorial!", "We learnt how to do transfer learning for the task of semantic segmentation using DeepLabv3 in PyTorch on our custom dataset.", "Thank you for reading the article. Hope you learned something new from this article. If you found this useful please consider citing my work.", "[5] Yong Shi, Limeng Cui, Zhiquan Qi, Fan Meng, and Zhensong Chen. Automatic road crack detection using randomstructured forests.IEEE Transactions on Intelligent Transportation Systems, 17(12):3434\u20133445, 2016.", "[8] Charles X. Ling, Jin Huang, and Harry Zhang. Auc: A statistically consistent and more discriminating measurethan accuracy. InProceedings of the 18th International Joint Conference on Artificial Intelligence, IJCAI\u201903,pages 519\u2013524, San Francisco, CA, USA, 2003. Morgan Kaufmann Publishers Inc.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "DL/CV Research Engineer | MASc UWaterloo | Follow and subscribe for DL/ML content | https://github.com/msminhas93 | https://www.linkedin.com/in/msminhas93"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Ff770863d6a42&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftransfer-learning-for-segmentation-using-deeplabv3-in-pytorch-f770863d6a42&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftransfer-learning-for-segmentation-using-deeplabv3-in-pytorch-f770863d6a42&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftransfer-learning-for-segmentation-using-deeplabv3-in-pytorch-f770863d6a42&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftransfer-learning-for-segmentation-using-deeplabv3-in-pytorch-f770863d6a42&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----f770863d6a42--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----f770863d6a42--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://manpreetsinghminhas.medium.com/?source=post_page-----f770863d6a42--------------------------------", "anchor_text": ""}, {"url": "https://manpreetsinghminhas.medium.com/?source=post_page-----f770863d6a42--------------------------------", "anchor_text": "Manpreet Singh Minhas"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F35b4b2dadc4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftransfer-learning-for-segmentation-using-deeplabv3-in-pytorch-f770863d6a42&user=Manpreet+Singh+Minhas&userId=35b4b2dadc4&source=post_page-35b4b2dadc4----f770863d6a42---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ff770863d6a42&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftransfer-learning-for-segmentation-using-deeplabv3-in-pytorch-f770863d6a42&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ff770863d6a42&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftransfer-learning-for-segmentation-using-deeplabv3-in-pytorch-f770863d6a42&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://pytorch.org/docs/stable/generated/torch.nn.CrossEntropyLoss.html", "anchor_text": "https://pytorch.org/docs/stable/generated/torch.nn.CrossEntropyLoss.html"}, {"url": "https://github.com/msminhas93/DeepLabv3FineTuning", "anchor_text": "https://github.com/msminhas93/DeepLabv3FineTuning"}, {"url": "https://github.com/msminhas93/DeepLabv3FineTuning%7D", "anchor_text": "https://github.com/msminhas93/DeepLabv3FineTuning}"}, {"url": "https://github.com/msminhas93/DeepLabv3FineTuning", "anchor_text": "https://github.com/msminhas93/DeepLabv3FineTuning"}, {"url": "https://arxiv.org/abs/1706.05587", "anchor_text": "https://arxiv.org/abs/1706.05587"}, {"url": "https://arxiv.org/abs/1802.02611", "anchor_text": "https://arxiv.org/abs/1802.02611"}, {"url": "https://scikit-image.org/docs/dev/user_guide/tutorial_segmentation.html", "anchor_text": "https://scikit-image.org/docs/dev/user_guide/tutorial_segmentation.html"}, {"url": "https://arxiv.org/abs/1905.13147", "anchor_text": "https://arxiv.org/abs/1905.13147"}, {"url": "https://github.com/cuilimeng/CrackForest-dataset", "anchor_text": "https://github.com/cuilimeng/CrackForest-dataset"}, {"url": "https://arxiv.org/abs/1911.10608", "anchor_text": "https://arxiv.org/abs/1911.10608"}, {"url": "https://medium.com/tag/data-science?source=post_page-----f770863d6a42---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----f770863d6a42---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/tag/programming?source=post_page-----f770863d6a42---------------programming-----------------", "anchor_text": "Programming"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----f770863d6a42---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/computer-vision?source=post_page-----f770863d6a42---------------computer_vision-----------------", "anchor_text": "Computer Vision"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Ff770863d6a42&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftransfer-learning-for-segmentation-using-deeplabv3-in-pytorch-f770863d6a42&user=Manpreet+Singh+Minhas&userId=35b4b2dadc4&source=-----f770863d6a42---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Ff770863d6a42&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftransfer-learning-for-segmentation-using-deeplabv3-in-pytorch-f770863d6a42&user=Manpreet+Singh+Minhas&userId=35b4b2dadc4&source=-----f770863d6a42---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ff770863d6a42&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftransfer-learning-for-segmentation-using-deeplabv3-in-pytorch-f770863d6a42&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----f770863d6a42--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Ff770863d6a42&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftransfer-learning-for-segmentation-using-deeplabv3-in-pytorch-f770863d6a42&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----f770863d6a42---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----f770863d6a42--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----f770863d6a42--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----f770863d6a42--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----f770863d6a42--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----f770863d6a42--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----f770863d6a42--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----f770863d6a42--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----f770863d6a42--------------------------------", "anchor_text": ""}, {"url": "https://manpreetsinghminhas.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://manpreetsinghminhas.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Manpreet Singh Minhas"}, {"url": "https://manpreetsinghminhas.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "343 Followers"}, {"url": "https://github.com/msminhas93", "anchor_text": "https://github.com/msminhas93"}, {"url": "https://www.linkedin.com/in/msminhas93", "anchor_text": "https://www.linkedin.com/in/msminhas93"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F35b4b2dadc4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftransfer-learning-for-segmentation-using-deeplabv3-in-pytorch-f770863d6a42&user=Manpreet+Singh+Minhas&userId=35b4b2dadc4&source=post_page-35b4b2dadc4--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fffc3b82d74a1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftransfer-learning-for-segmentation-using-deeplabv3-in-pytorch-f770863d6a42&newsletterV3=35b4b2dadc4&newsletterV3Id=ffc3b82d74a1&user=Manpreet+Singh+Minhas&userId=35b4b2dadc4&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}