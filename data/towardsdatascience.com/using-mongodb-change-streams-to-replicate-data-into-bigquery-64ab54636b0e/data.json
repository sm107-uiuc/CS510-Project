{"url": "https://towardsdatascience.com/using-mongodb-change-streams-to-replicate-data-into-bigquery-64ab54636b0e", "time": 1682994461.787887, "path": "towardsdatascience.com/using-mongodb-change-streams-to-replicate-data-into-bigquery-64ab54636b0e/", "webpage": {"metadata": {"title": "Using MongoDB Change Streams to replicate data into BigQuery | by David Gasquez | Towards Data Science", "h1": "Using MongoDB Change Streams to replicate data into BigQuery", "description": "Before jumping into the technical details, it\u2019s good to review why we decided to build this pipeline. We had two main reasons to develop it: One of the first things we noticed when working with this\u2026"}, "outgoing_paragraph_urls": [{"url": "https://cloud.google.com/bigquery/docs/nested-repeated", "anchor_text": "repeated and nested fields", "paragraph_index": 2}, {"url": "https://docs.mongodb.com/manual/changeStreams/", "anchor_text": "Change Streams", "paragraph_index": 4}, {"url": "https://www.getdbt.com/", "anchor_text": "dbt", "paragraph_index": 7}, {"url": "https://stackoverflow.com/questions/52120182/bigquery-json-extract-all-elements-from-an-array", "anchor_text": "doesn\u2019t natively support extracting all the elements of an array encoded in the JSON", "paragraph_index": 11}, {"url": "https://twitter.com/davidgasquez", "anchor_text": "Twitter as @davidgasquez", "paragraph_index": 13}], "all_paragraphs": ["Before jumping into the technical details, it\u2019s good to review why we decided to build this pipeline. We had two main reasons to develop it:", "One of the first things we noticed when working with this MongoDB database is that some collections had a tricky schema. The documents had nested documents inside and some of them were also arrays.", "Usually, a nested document represents a one to one relationship and an array is a one to many. Luckily Big Query offers support both for repeated and nested fields.", "The most common way of replicating MongoDB data based on our research is to use a timestamp field inside the collection. That field is typically named updated_at and gets updated each time a record is inserted or updated. This method is easy to implement with a batch approach and it only requires querying the desired collection. When applying it to our data and collections we found two main issues:", "Luckily, MongoDB keeps a logs of all the changes that were applied to the collection in the oplog. Since MongoDB 3.6, you can query them using the Change Streams API. With that, we could be alerted of each change (including delete operations) in the collections.", "Our goal then was to build a pipeline that could move of all the change events records returned by MongoDD Change Streams into a Big Query table with the latest state for each record.", "Our first approach was to create a change streams table in Big Query for each collection we wanted to replicate and infer the schema from all the change stream events of that collection. That turns out to be quite tricky. If a new field was added in a record, the pipeline should be smart enough to modify the Big Query table before inserting the record.", "Since we wanted to have the data as soon as possible in Big Query we moved to another approach. Dump all the change streams events into BigQuery as a JSON blob. We can then use tools like dbt to extract, cast and transform the raw JSON data into a proper SQL table. This, of course, has some downsides but allowed us to have an end to end pipeline really soon.", "The pipeline has the following components:", "With these two steps we have data flowing from MongoDB to Big Query in real time. We also keep track of deletions and we have all the changes that took place in the collections we\u2019re replicating (useful for some kind of analysis that require information about the changes over a period of time).", "Since we don\u2019t have any data before the date we started the MongoDB Change Streams crawling service we\u2019re missing lots of records. To solve this we decided to backfill creating fake change events. We dumped the MongoDB collections and made a simple script that wrapped the documents as insertions. These records were sent into the same BigQuery table. Now, running the same dbt model give us the final table with all the backfilled records.", "The main drawback we found is that we need to write all the extraction in SQL. That means lots of extra SQL code and some extra processing. At the moment it\u2019s not too hard to handle using dbt. Another small one is that BigQuery doesn\u2019t natively support extracting all the elements of an array encoded in the JSON.", "For us the pros (iteration time, ease of changes, simple pipeline) outweigh the cons. Since we\u2019re just starting with this pipelines is really useful to have everything working end to end and iterate fast! Having the BigQuery append-only change streams table severs us as a separation. In the future we\u2019re planning on moving to Apache Beam and Cloud Dataflow but that\u2019s for another post!", "Hope you\u2019ve found these insights interesting! You can find me on Twitter as @davidgasquez. Don\u2019t hesitate on reaching out if you have any question.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Data @buffer. Curious learner interested in data and Open Source."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F64ab54636b0e&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-mongodb-change-streams-to-replicate-data-into-bigquery-64ab54636b0e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-mongodb-change-streams-to-replicate-data-into-bigquery-64ab54636b0e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-mongodb-change-streams-to-replicate-data-into-bigquery-64ab54636b0e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-mongodb-change-streams-to-replicate-data-into-bigquery-64ab54636b0e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----64ab54636b0e--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----64ab54636b0e--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@davidgasquez?source=post_page-----64ab54636b0e--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@davidgasquez?source=post_page-----64ab54636b0e--------------------------------", "anchor_text": "David Gasquez"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F75608c8c8fd7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-mongodb-change-streams-to-replicate-data-into-bigquery-64ab54636b0e&user=David+Gasquez&userId=75608c8c8fd7&source=post_page-75608c8c8fd7----64ab54636b0e---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F64ab54636b0e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-mongodb-change-streams-to-replicate-data-into-bigquery-64ab54636b0e&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F64ab54636b0e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-mongodb-change-streams-to-replicate-data-into-bigquery-64ab54636b0e&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@quinten149?utm_source=medium&utm_medium=referral", "anchor_text": "Quinten de Graaf"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://cloud.google.com/bigquery/docs/nested-repeated", "anchor_text": "repeated and nested fields"}, {"url": "https://docs.mongodb.com/manual/changeStreams/", "anchor_text": "Change Streams"}, {"url": "https://unsplash.com/@neonbrand?utm_source=medium&utm_medium=referral", "anchor_text": "NeONBRAND"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://www.getdbt.com/", "anchor_text": "dbt"}, {"url": "https://github.com/bufferapp/carden", "anchor_text": "carden"}, {"url": "https://docs.getdbt.com/v0.12/docs/materializations#section-incremental", "anchor_text": "incrementally and materializes a query into a new table"}, {"url": "https://stackoverflow.com/questions/52120182/bigquery-json-extract-all-elements-from-an-array", "anchor_text": "doesn\u2019t natively support extracting all the elements of an array encoded in the JSON"}, {"url": "https://twitter.com/davidgasquez", "anchor_text": "Twitter as @davidgasquez"}, {"url": "https://medium.com/tag/big-data?source=post_page-----64ab54636b0e---------------big_data-----------------", "anchor_text": "Big Data"}, {"url": "https://medium.com/tag/data-pipeline?source=post_page-----64ab54636b0e---------------data_pipeline-----------------", "anchor_text": "Data Pipeline"}, {"url": "https://medium.com/tag/data?source=post_page-----64ab54636b0e---------------data-----------------", "anchor_text": "Data"}, {"url": "https://medium.com/tag/data-science?source=post_page-----64ab54636b0e---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F64ab54636b0e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-mongodb-change-streams-to-replicate-data-into-bigquery-64ab54636b0e&user=David+Gasquez&userId=75608c8c8fd7&source=-----64ab54636b0e---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F64ab54636b0e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-mongodb-change-streams-to-replicate-data-into-bigquery-64ab54636b0e&user=David+Gasquez&userId=75608c8c8fd7&source=-----64ab54636b0e---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F64ab54636b0e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-mongodb-change-streams-to-replicate-data-into-bigquery-64ab54636b0e&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----64ab54636b0e--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F64ab54636b0e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-mongodb-change-streams-to-replicate-data-into-bigquery-64ab54636b0e&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----64ab54636b0e---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----64ab54636b0e--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----64ab54636b0e--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----64ab54636b0e--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----64ab54636b0e--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----64ab54636b0e--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----64ab54636b0e--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----64ab54636b0e--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----64ab54636b0e--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@davidgasquez?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@davidgasquez?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "David Gasquez"}, {"url": "https://medium.com/@davidgasquez/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "59 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F75608c8c8fd7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-mongodb-change-streams-to-replicate-data-into-bigquery-64ab54636b0e&user=David+Gasquez&userId=75608c8c8fd7&source=post_page-75608c8c8fd7--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F23ea16dc829b&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-mongodb-change-streams-to-replicate-data-into-bigquery-64ab54636b0e&newsletterV3=75608c8c8fd7&newsletterV3Id=23ea16dc829b&user=David+Gasquez&userId=75608c8c8fd7&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}