{"url": "https://towardsdatascience.com/deploy-fastai-transformers-based-nlp-models-using-amazon-sagemaker-and-creating-api-using-aws-7ea39bbcc021", "time": 1683006161.26459, "path": "towardsdatascience.com/deploy-fastai-transformers-based-nlp-models-using-amazon-sagemaker-and-creating-api-using-aws-7ea39bbcc021/", "webpage": {"metadata": {"title": "Deploy Fastai \u2014 Transformers based NLP models using Amazon SageMaker and Creating API using AWS API Gateway and Lambda function | by Zakarya ROUZKI | Towards Data Science", "h1": "Deploy Fastai \u2014 Transformers based NLP models using Amazon SageMaker and Creating API using AWS API Gateway and Lambda function", "description": "The transformers library is created by Hugging Face. Formerly known as pytorch-transformers or pytorch-pretrained-bert, this library brings together over 40 state-of-the-art pre-trained NLP models\u2026"}, "outgoing_paragraph_urls": [{"url": "https://github.com/huggingface/transformers", "anchor_text": "transformers", "paragraph_index": 0}, {"url": "https://huggingface.co", "anchor_text": "Hugging Face", "paragraph_index": 0}, {"url": "https://docs.fast.ai", "anchor_text": "fastai", "paragraph_index": 1}, {"url": "https://www.kaggle.com/melissarajaram/roberta-fastai-huggingface-transformers", "anchor_text": "Kernel", "paragraph_index": 2}, {"url": "https://aws.amazon.com/sagemaker/", "anchor_text": "Amazon SageMaker", "paragraph_index": 7}, {"url": "https://sagemaker.readthedocs.io/en/stable/using_pytorch.html#using-third-party-libraries", "anchor_text": "here", "paragraph_index": 23}, {"url": "https://www.linkedin.com/in/rouzki/", "anchor_text": "https://www.linkedin.com/in/rouzki/", "paragraph_index": 45}], "all_paragraphs": ["The transformers library is created by Hugging Face. Formerly known as pytorch-transformers or pytorch-pretrained-bert, this library brings together over 40 state-of-the-art pre-trained NLP models (BERT, GPT-2, RoBERTa, CTRL\u2026). It\u2019s an opinionated library built for NLP researchers seeking to use/study/extend large-scale transformers models.", "The implementation gives interesting additional utilities like tokenizer, optimizer or scheduler. It can be self-sufficient, but incorporating it within the fastai library provides simpler implementation compatible with powerful fastai tools like Discriminate Learning Rate, Gradual Unfreezing or Slanted Triangular Learning Rates. The point here is to get easily state-of-the-art results and to \u201cmake NLP uncool again\u201d.", "I suppose that you already implemented your model, and I am not going to cover this part, the article will tackle only the deployment part using AWS services, but if you need to see an implementation check this Kernel on Kaggle.", "First, we need to export our model as a PKL file using the learner module of the fastai library :", "When using a custom transformers model such as Bert, you need to redefine the architecture of the custom model, so that when loading it the load_learner() function will look for that specific function to use on new predictions.", "Before loading the model, we need to redefine the custom transformer model that we used on training.", "Then we can load our model and make predictions :", "Amazon SageMaker provides every developer and data scientist with the ability to build, train, and deploy machine learning models quickly. Amazon SageMaker is a fully-managed service that covers the entire machine learning workflow to label and prepare your data, choose an algorithm, train the model, tune and optimize it for deployment, make predictions, and take action. Your models get to production faster with much less effort and lower cost.", "SageMaker provides a framework to both training and deploying your models. Everything is run in Docker containers.", "since we will use Amazon SageMaker Python SDK, we need a notebook instance to run our code.", "3.1. Using SageMaker Python SDK to deploy the model", "from the SageMaker Python SDK documentation :", "Amazon SageMaker Python SDK is an open source library for training and deploying machine-learned models on Amazon SageMaker.", "With the SDK, you can train and deploy models using popular deep learning frameworks, algorithms provided by Amazon, or your own algorithms built into SageMaker-compatible Docker images.", "The general architecture of the deployment is as follows :", "after uploading your model ( PKL file ) to the notebook instance, we need to zip it up so that we can upload it to S3.", "Then we can upload it to S3 storage as follows :", "Now we are ready to deploy our model to the SageMaker model hosting service. We will use the SageMaker Python SDK with the Amazon SageMaker open-source PyTorch container as this container has support for the fast.ai library. Using one of the predefined Amazon SageMaker containers makes it easy to write a script and then run it in Amazon SageMaker.", "To serve models in SageMaker, we need a script that implements 4 methods: model_fn, input_fn, predict_fn & output_fn.", "The methods input_fn and output_fn are optional and if omitted SageMaker will assume the input and output objects are of type NPY format with Content-Type application/x-npy.", "This is the serve.py script :", "one other thing is to put this script inside a folder and call it my_src, and we will add a requirements text file; to force SageMaker to install the required library such as Fastai.", "my requirements.txt file contains only this :", "you can read much about this on the SageMaker Python SDK documentation here.", "First, we need to create a RealTimePredictor class to accept JSON/application item as input and output JSON. The default behavior is to accept a NumPy array.", "We need to get the IAM role ARN to give SageMaker permissions to read our model artefact from S3.", "we will deploy our model to the instance type ml.p2.xlarge . We will pass in the name of our serving script e.g. serve.py. We will also pass in the S3 path of our model that we uploaded earlier.", "It will take a while for SageMaker to provision the endpoint ready for inference.", "Boto is the Amazon Web Services (AWS) SDK for Python. It enables Python developers to create, configure, and manage AWS services, such as EC2 and S3. Boto provides an easy-to-use, object-oriented API, as well as low-level access to AWS services.", "We will invoke our model endpoint deployed by Amazon SageMaker using API Gateway and AWS Lambda.", "The following diagram shows how the deployed model is called using a serverless architecture. Starting from the client-side, a client script calls an Amazon API Gateway API action and passes parameter values. API Gateway is a layer that provides API to the client. In addition, it seals the backend so that AWS Lambda stays and executes in a protected private network. API Gateway passes the parameter values to the Lambda function. The Lambda function parses the value and sends it to the SageMaker model endpoint. The model performs the prediction and returns the predicted value to AWS Lambda. The Lambda function parses the returned value and sends it back to API Gateway. API Gateway responds to the client with that value.", "AWS Lambda is an event-driven, serverless computing platform provided by Amazon as a part of Amazon Web Services. It is a computing service that runs code in response to events and automatically manages the computing resources required by that code.", "To create a function we specify its name and the Runtime Environment (Python 3 in our case) :", "Then we use our custom function to call endpoint using Boto3 library as follows :", "4.2. Creating Amazon Web API Gateway instance :", "Amazon API Gateway is a fully managed service that makes it easy for developers to create, publish, maintain, monitor, and secure APIs at any scale.", "We create an API and associate it to Lambda function as an Integration as follows :", "then we need to identify the routes of our API, we will use just one route \u201c/classify\u201d and the \u201cPOST\u201d as our Request Method.", "Now that we have the Lambda function, an API Gateway, and the test data, let\u2019s test it using Postman, which is an HTTP client for testing web services.", "When we deployed your API Gateway, it provided the invoke URL that looks like:", "In Postman we place the Invoke URL and we choose POST as the method of request. In the Body tab, we place the text to classify as shown in the following screenshot.", "Then we send our requests and it will return JSON item as a response containing prediction of the model.", "We can also use the requests library in python as follows :", "That is it. You have created a model endpoint deployed and hosted by Amazon SageMaker. Then you created serverless components (an API Gateway and a Lambda function) that invoke the endpoint. Now you know how to call a machine learning model endpoint hosted by Amazon SageMaker using serverless technology.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Data Scientist / NLP Engineer at FY COMPUTING. https://www.linkedin.com/in/rouzki/"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F7ea39bbcc021&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-fastai-transformers-based-nlp-models-using-amazon-sagemaker-and-creating-api-using-aws-7ea39bbcc021&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-fastai-transformers-based-nlp-models-using-amazon-sagemaker-and-creating-api-using-aws-7ea39bbcc021&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-fastai-transformers-based-nlp-models-using-amazon-sagemaker-and-creating-api-using-aws-7ea39bbcc021&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-fastai-transformers-based-nlp-models-using-amazon-sagemaker-and-creating-api-using-aws-7ea39bbcc021&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----7ea39bbcc021--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----7ea39bbcc021--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@zakaryarouzki?source=post_page-----7ea39bbcc021--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@zakaryarouzki?source=post_page-----7ea39bbcc021--------------------------------", "anchor_text": "Zakarya ROUZKI"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fce4bea974013&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-fastai-transformers-based-nlp-models-using-amazon-sagemaker-and-creating-api-using-aws-7ea39bbcc021&user=Zakarya+ROUZKI&userId=ce4bea974013&source=post_page-ce4bea974013----7ea39bbcc021---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F7ea39bbcc021&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-fastai-transformers-based-nlp-models-using-amazon-sagemaker-and-creating-api-using-aws-7ea39bbcc021&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F7ea39bbcc021&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-fastai-transformers-based-nlp-models-using-amazon-sagemaker-and-creating-api-using-aws-7ea39bbcc021&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://github.com/huggingface/transformers", "anchor_text": "transformers"}, {"url": "https://huggingface.co", "anchor_text": "Hugging Face"}, {"url": "https://docs.fast.ai", "anchor_text": "fastai"}, {"url": "https://www.kaggle.com/melissarajaram/roberta-fastai-huggingface-transformers", "anchor_text": "Kernel"}, {"url": "https://aws.amazon.com/sagemaker/", "anchor_text": "Amazon SageMaker"}, {"url": "https://sagemaker.readthedocs.io/en/stable/using_pytorch.html#using-third-party-libraries", "anchor_text": "here"}, {"url": "https://{restapi_id}.execute-api.{region}.amazonaws.com/{stage_name}/{resource_name}", "anchor_text": "https://{restapi_id}.execute-api.{region}.amazonaws.com/{stage_name}/{resource_name}"}, {"url": "https://course.fast.ai/start_sagemaker.html", "anchor_text": "Amazon SageMakerThis is a quick guide to starting v4 of the fast.ai course Practical Deep Learning for Coders using Amazon SageMaker\u2026course.fast.ai"}, {"url": "https://aws.amazon.com/blogs/machine-learning/call-an-amazon-sagemaker-model-endpoint-using-amazon-api-gateway-and-aws-lambda/", "anchor_text": "Call an Amazon SageMaker model endpoint using Amazon API Gateway and AWS Lambda | Amazon Web\u2026At AWS Machine Learning workshops, customers often ask, \"After I deploy an endpoint, where do I go from there?\" You can\u2026aws.amazon.com"}, {"url": "https://docs.aws.amazon.com/sagemaker/latest/dg/ex1-deploy-model.html", "anchor_text": "Step 6.1: Deploy the Model to SageMaker Hosting ServicesTo deploy a model in SageMaker, hosting services, you can use either the Amazon SageMaker Python SDK or the AWS SDK for\u2026docs.aws.amazon.com"}, {"url": "https://medium.com/tag/fastai?source=post_page-----7ea39bbcc021---------------fastai-----------------", "anchor_text": "Fastai"}, {"url": "https://medium.com/tag/transformers?source=post_page-----7ea39bbcc021---------------transformers-----------------", "anchor_text": "Transformers"}, {"url": "https://medium.com/tag/aws-sagemaker?source=post_page-----7ea39bbcc021---------------aws_sagemaker-----------------", "anchor_text": "Aws Sagemaker"}, {"url": "https://medium.com/tag/aws-lambda?source=post_page-----7ea39bbcc021---------------aws_lambda-----------------", "anchor_text": "AWS Lambda"}, {"url": "https://medium.com/tag/aws-api-gateway?source=post_page-----7ea39bbcc021---------------aws_api_gateway-----------------", "anchor_text": "Aws Api Gateway"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F7ea39bbcc021&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-fastai-transformers-based-nlp-models-using-amazon-sagemaker-and-creating-api-using-aws-7ea39bbcc021&user=Zakarya+ROUZKI&userId=ce4bea974013&source=-----7ea39bbcc021---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F7ea39bbcc021&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-fastai-transformers-based-nlp-models-using-amazon-sagemaker-and-creating-api-using-aws-7ea39bbcc021&user=Zakarya+ROUZKI&userId=ce4bea974013&source=-----7ea39bbcc021---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F7ea39bbcc021&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-fastai-transformers-based-nlp-models-using-amazon-sagemaker-and-creating-api-using-aws-7ea39bbcc021&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----7ea39bbcc021--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F7ea39bbcc021&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-fastai-transformers-based-nlp-models-using-amazon-sagemaker-and-creating-api-using-aws-7ea39bbcc021&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----7ea39bbcc021---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----7ea39bbcc021--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----7ea39bbcc021--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----7ea39bbcc021--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----7ea39bbcc021--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----7ea39bbcc021--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----7ea39bbcc021--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----7ea39bbcc021--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----7ea39bbcc021--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@zakaryarouzki?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@zakaryarouzki?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Zakarya ROUZKI"}, {"url": "https://medium.com/@zakaryarouzki/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "17 Followers"}, {"url": "https://www.linkedin.com/in/rouzki/", "anchor_text": "https://www.linkedin.com/in/rouzki/"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fce4bea974013&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-fastai-transformers-based-nlp-models-using-amazon-sagemaker-and-creating-api-using-aws-7ea39bbcc021&user=Zakarya+ROUZKI&userId=ce4bea974013&source=post_page-ce4bea974013--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F185693255add&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-fastai-transformers-based-nlp-models-using-amazon-sagemaker-and-creating-api-using-aws-7ea39bbcc021&newsletterV3=ce4bea974013&newsletterV3Id=185693255add&user=Zakarya+ROUZKI&userId=ce4bea974013&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}