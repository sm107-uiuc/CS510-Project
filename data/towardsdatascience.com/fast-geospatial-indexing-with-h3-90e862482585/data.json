{"url": "https://towardsdatascience.com/fast-geospatial-indexing-with-h3-90e862482585", "time": 1683011080.598272, "path": "towardsdatascience.com/fast-geospatial-indexing-with-h3-90e862482585/", "webpage": {"metadata": {"title": "Fast Geospatial Indexing with H3. H3 Hexagon power reloaded! | by Jo\u00e3o Paulo Figueira | Towards Data Science", "h1": "Fast Geospatial Indexing with H3", "description": "In this article, I am following up on the material presented in two previous articles, namely on geospatial indexing with H3, and on how to query geographical data using the triangular inequality. I\u2026"}, "outgoing_paragraph_urls": [{"url": "https://towardsdatascience.com/geospatial-indexing-with-ubers-h3-766399b690c", "anchor_text": "geospatial indexing with H3", "paragraph_index": 0}, {"url": "https://medium.com/iotransportation/using-the-triangle-inequality-to-query-geographic-data-7148a1b103a0", "anchor_text": "how to query geographical data using the triangular inequality", "paragraph_index": 0}, {"url": "https://eng.uber.com/h3/", "anchor_text": "H3 geospatial indexing", "paragraph_index": 2}, {"url": "https://github.com/joaofig/geo-spoke", "anchor_text": "GitHub repository", "paragraph_index": 4}, {"url": "https://medium.com/iotransportation/cleaning-the-dublin-buses-dataset-a-tutorial-2783ba2edab4", "anchor_text": "Dublin Buses dataset", "paragraph_index": 25}, {"url": "https://eng.uber.com/h3/", "anchor_text": "H3: Uber\u2019s Hexagonal Hierarchical Spatial Index", "paragraph_index": 30}, {"url": "http://tblx.io", "anchor_text": "tblx.io", "paragraph_index": 32}], "all_paragraphs": ["In this article, I am following up on the material presented in two previous articles, namely on geospatial indexing with H3, and on how to query geographical data using the triangular inequality. I will use both methods to illustrate the implementation of two of the most useful geospatial queries: radius and KNN. We use these queries to retrieve locations from geospatial databases using reference points. The radius query returns all the points within a preset distance from the reference point, while the KNN query returns the K nearest ones.", "My previous article on the triangular inequality discussed the geometric underpinnings of the indexing process and implemented a simple version of the radius query. While I hinted that the KNN was simple to implement, I left that as an exercise to the reader. In this article, I present a fully revised and complete implementation of both queries based on the triangular inequality.", "While working at it, I wondered whether I could perform the same calculations using the H3 geospatial indexing method. Once hashed to their H3 indexes, all points are immediately and quickly indexable, but there is more to it. Due to its inherent geometry, the H3 hexagonal tiles have relevant properties that allow us to perform both the radius and KNN queries with impressive performance.", "Let\u2019s handle the unfinished business first, and then have a look at H3.", "Let us start by completing the unfinished work of explaining how to implement KNN queries using the triangular inequality. We go back to the previous article\u2019s GitHub repository and build it from there.", "There are a few changes to note since the code was last published. The first change relates to how the calculation of the two foci. In the first incarnation of the Python code, these were hardcoded. Now, their locations depend on the centroid of the input locations, placed in the opposite hemisphere at a ninety-degree latitude difference. The foci themselves have a ninety-degree longitude difference, centered on the input locations\u2019 centroid.", "The data for each \u201cspoke\u201d consists of the array of sorted distances and the sorting indices for the original location data.", "The radius query keeps the original design, calculating all the locations within the given radius from the reference point along the two \u201cspokes\u201d and intersecting the two result sets. A final brute-force distance calculation makes sure that we keep the locations within the given radius.", "As you can see, the code is kept quite lean without loops.", "The KNN query builds upon the idea of the radius query, but with the reverse logic. The idea is to start with a small radius and query the points within its range. If the number of points found is less than K, the code increases the search radius and repeats. Once it is over the required number of locations, the algorithm finishes off with another brute-force distance calculation to retain the nearest K.", "How do we calculate the initial radius value? My solution to this problem was to approximate the average input point density (number of locations per square meter) using the dataset\u2019s bounding box. Using this value, we can estimate the size of the smallest \u201csquare\u201d that contains K points. To get the initial value for the radius, we need to take the square root of that area. I chose to multiply this value by two to compensate for the error introduced by approximating the input area by its bounding box.", "In the formula above, the letter \u201cd\u201d is the bounding-box density.", "The code starts by positioning the query point along both spokes. Next, it enters a loop to search for the nearest locations. The radius around the reference point defines a circular sector centered on each of the foci. By intersecting both areas, we find the query point\u2019s nearest locations. The loop keeps increasing the radius length while there are not enough intersection points.", "Note that this algorithm does not always guarantee to find the K nearest locations. The reason for this problem lies in the fact that the intersected area resembles a square and not a circle. It is then possible to have points outside of the square but still closer than others inside of it, like the ones close to each corner. The solution is to add an extra loop to make sure we have everything covered, at the cost of lost performance.", "Several smart features are in place with H3 that makes it a great choice to support both query types. First of all, there is efficiency and speed. The Cython-compiled package now provides you several options on how to represent hexagon indexes. For this article\u2019s code, I chose to use unsigned sixty-four-bit integers, and all functions that return collections do so via NumPy arrays. The package API is also very complete, equipped with features that enable several different use-cases. Finally, the hexagon shape lends itself quite nicely to the type of queries addressed.", "As you can see from the image above, we can easily approximate a circular shape using a set of hexagons. To perform a radius query centered on the image\u2019s roundabout, we can enumerate all the hexagons that cover the required circle. This process generates a list of H3 hashes that we then use to query all matching points in the dataset. Finally, a closing brute-force query on the resulting locations produces the result.", "Note how I used the NumPy function to search in a sorted array to retrieve the ranges of indices in the source dataset. There are two calls to the same service differing only in the \u201cside\u201d parameter. In the first call, we get the initial indexes for the ranges, while the second provides the ending ones. Missing values get the same number for the initial and ending index, so they are straightforward to tell apart. Here is an illustration of how it works.", "In the image above, you can see some sample code that defines three arrays. The first contains the unsorted source dataset. The second array contains the indices of the sorted source dataset, while the third includes the values whose ranges we want to find. Note that the first value (1) is not present, while the other two are. For these, we want to collect their ranges in the sorted source dataset.", "The next two images show how to get the initial and final range indices.", "We can now reconstruct the ranges for the existing values with a simple expression.", "This implementation has the advantage of being extremely fast compared to the alternative of using set inclusion tests.", "There is a catch, though. During initialization, you have to specify the level at which to generate the H3 hashes. By default, the code uses level ten, which seems appropriate for urban environments. Nevertheless, you should test this against your dataset to check if there is no performance degradation. Remember that smaller values for the H3 level correspond to larger hexagons.", "Note how the constructor code uses parallel processing to improve performance when handling massive arrays. A possible improvement for future versions of the H3 package may be the vectorization of some functions.", "The KNN query uses a similar approach as the triangular inequality. Instead of increasing a radius centered on the query point, the code adds concentric layers of hexagons centered on the query point. The algorithm then uses corresponding H3 hashes to match against the source dataset and retrieve the nearest locations.", "I should make a note similar to the one I made above. It is possible, although unlikely that this algorithm might miss some points. Imagine that the location you are querying lies close to one of the enclosing hexagon\u2019s vertices. This skew might induce a situation where some of the closest points would lie outside the generated \u201cring.\u201d The solution is the same, though. Once you have K nearest points, iterate one more time, and you should be covered.", "To compare the performance of both approaches and on both queries, I ran a benchmark using data from the Dublin Buses dataset. The dataset contains more than forty-four million geo-referenced data points. Each benchmark run extracts a random sample of one hundred of those points and runs both queries, using both approaches.", "After ten runs, I got the above results. While H3 loses a tiny bit during initialization, it blows the triangular inequality-based algorithm out of the water during query time.", "Note that your mileage may vary, depending on your dataset and H3 initialization parameters.", "In this article, I completed the KNN query implementation using the triangle inequality. Using the H3 algorithm and its associated Python package, I implemented both the radius and KNN queries and demonstrated their superior performance.", "H3 packs a punch when it comes to performance and features, and if you work with geospatial data, keep it in your toolbag.", "H3: Uber\u2019s Hexagonal Hierarchical Spatial Index", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Addicted to math and data, slightly off-centered. Data Scientist at tblx.io"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F90e862482585&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffast-geospatial-indexing-with-h3-90e862482585&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffast-geospatial-indexing-with-h3-90e862482585&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffast-geospatial-indexing-with-h3-90e862482585&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffast-geospatial-indexing-with-h3-90e862482585&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----90e862482585--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----90e862482585--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@joao.figueira?source=post_page-----90e862482585--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@joao.figueira?source=post_page-----90e862482585--------------------------------", "anchor_text": "Jo\u00e3o Paulo Figueira"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F64bc009cedeb&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffast-geospatial-indexing-with-h3-90e862482585&user=Jo%C3%A3o+Paulo+Figueira&userId=64bc009cedeb&source=post_page-64bc009cedeb----90e862482585---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F90e862482585&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffast-geospatial-indexing-with-h3-90e862482585&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F90e862482585&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffast-geospatial-indexing-with-h3-90e862482585&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@anastasia_p?utm_source=medium&utm_medium=referral", "anchor_text": "Anastasia Petrova"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://towardsdatascience.com/geospatial-indexing-with-ubers-h3-766399b690c", "anchor_text": "geospatial indexing with H3"}, {"url": "https://medium.com/iotransportation/using-the-triangle-inequality-to-query-geographic-data-7148a1b103a0", "anchor_text": "how to query geographical data using the triangular inequality"}, {"url": "https://eng.uber.com/h3/", "anchor_text": "H3 geospatial indexing"}, {"url": "https://github.com/joaofig/geo-spoke", "anchor_text": "GitHub repository"}, {"url": "https://medium.com/iotransportation/cleaning-the-dublin-buses-dataset-a-tutorial-2783ba2edab4", "anchor_text": "Dublin Buses dataset"}, {"url": "https://github.com/joaofig/geo-spoke", "anchor_text": "GitHub repository"}, {"url": "https://eng.uber.com/h3/", "anchor_text": "H3: Uber\u2019s Hexagonal Hierarchical Spatial Index"}, {"url": "https://medium.com/iotransportation/using-the-triangle-inequality-to-query-geographic-data-7148a1b103a0", "anchor_text": "Using the Triangle Inequality to Query Geographic DataA fast and straightforward method of querying large sets of locations.medium.com"}, {"url": "https://towardsdatascience.com/geospatial-indexing-with-ubers-h3-766399b690c", "anchor_text": "Geospatial Indexing with Uber\u2019s H3Hexagon power!towardsdatascience.com"}, {"url": "https://medium.com/iotransportation/cleaning-the-dublin-buses-dataset-a-tutorial-2783ba2edab4", "anchor_text": "Cleaning the Dublin Buses Dataset \u2014 A TutorialUsing kinematic and geographic criteria to clean datamedium.com"}, {"url": "https://www.linkedin.com/in/joao-paulo-figueira/", "anchor_text": "Jo\u00e3o Paulo Figueira - Data Scientist - tb.lx by Daimler Trucks & Buses | LinkedInView Jo\u00e3o Paulo Figueira's profile on LinkedIn, the world's largest professional community. Jo\u00e3o Paulo has 1 job listed\u2026www.linkedin.com"}, {"url": "https://medium.com/tag/h3?source=post_page-----90e862482585---------------h3-----------------", "anchor_text": "H3"}, {"url": "https://medium.com/tag/geospatial?source=post_page-----90e862482585---------------geospatial-----------------", "anchor_text": "Geospatial"}, {"url": "https://medium.com/tag/geographicdatascience?source=post_page-----90e862482585---------------geographicdatascience-----------------", "anchor_text": "Geographicdatascience"}, {"url": "https://medium.com/tag/programming?source=post_page-----90e862482585---------------programming-----------------", "anchor_text": "Programming"}, {"url": "https://medium.com/tag/towards-data-science?source=post_page-----90e862482585---------------towards_data_science-----------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F90e862482585&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffast-geospatial-indexing-with-h3-90e862482585&user=Jo%C3%A3o+Paulo+Figueira&userId=64bc009cedeb&source=-----90e862482585---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F90e862482585&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffast-geospatial-indexing-with-h3-90e862482585&user=Jo%C3%A3o+Paulo+Figueira&userId=64bc009cedeb&source=-----90e862482585---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F90e862482585&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffast-geospatial-indexing-with-h3-90e862482585&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----90e862482585--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F90e862482585&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffast-geospatial-indexing-with-h3-90e862482585&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----90e862482585---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----90e862482585--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----90e862482585--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----90e862482585--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----90e862482585--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----90e862482585--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----90e862482585--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----90e862482585--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----90e862482585--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@joao.figueira?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@joao.figueira?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Jo\u00e3o Paulo Figueira"}, {"url": "https://medium.com/@joao.figueira/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "491 Followers"}, {"url": "http://tblx.io", "anchor_text": "tblx.io"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F64bc009cedeb&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffast-geospatial-indexing-with-h3-90e862482585&user=Jo%C3%A3o+Paulo+Figueira&userId=64bc009cedeb&source=post_page-64bc009cedeb--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F33fec95e18df&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffast-geospatial-indexing-with-h3-90e862482585&newsletterV3=64bc009cedeb&newsletterV3Id=33fec95e18df&user=Jo%C3%A3o+Paulo+Figueira&userId=64bc009cedeb&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}