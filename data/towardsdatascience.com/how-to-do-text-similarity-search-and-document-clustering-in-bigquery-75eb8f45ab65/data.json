{"url": "https://towardsdatascience.com/how-to-do-text-similarity-search-and-document-clustering-in-bigquery-75eb8f45ab65", "time": 1683012866.411486, "path": "towardsdatascience.com/how-to-do-text-similarity-search-and-document-clustering-in-bigquery-75eb8f45ab65/", "webpage": {"metadata": {"title": "How to do text similarity search and document clustering in BigQuery | by Lak Lakshmanan | Towards Data Science", "h1": "How to do text similarity search and document clustering in BigQuery", "description": "BigQuery offers the ability to load a TensorFlow SavedModel and carry out predictions. This capability is a great way to add text-based similarity and clustering on top of your data warehouse. Follow\u2026"}, "outgoing_paragraph_urls": [{"url": "https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/blob/master/09_bqml/text_embeddings.ipynb", "anchor_text": "my notebook in GitHub", "paragraph_index": 1}, {"url": "https://tfhub.dev/", "anchor_text": "TensorFlow Hub", "paragraph_index": 4}, {"url": "https://tfhub.dev/google/tf2-preview/gnews-swivel-20dim/1", "anchor_text": "Swivel", "paragraph_index": 5}, {"url": "https://tfhub.dev/", "anchor_text": "TensorFlow Hub", "paragraph_index": 21}, {"url": "https://tfhub.dev/google/tf2-preview/gnews-swivel-20dim/1", "anchor_text": "Swivel", "paragraph_index": 21}, {"url": "https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/blob/master/09_bqml/text_embeddings.ipynb", "anchor_text": "my notebook on GitHub", "paragraph_index": 22}], "all_paragraphs": ["BigQuery offers the ability to load a TensorFlow SavedModel and carry out predictions. This capability is a great way to add text-based similarity and clustering on top of your data warehouse.", "Follow along by copy-pasting queries from my notebook in GitHub. You can try out the queries in the BigQuery console or in an AI Platform Jupyter notebook.", "As an example, I\u2019ll use a dataset consisting of wind reports phoned into National Weather Service offices by \u201cstorm spotters\u201d. This is a public dataset in BigQuery and it can be queried as follows:", "Let\u2019s say that we want to build a SQL query to search for comments that look like \u201cpower line down on a home\u201d.", "TensorFlow Hub has a number of text embedding models. For best results, you should use a model that has been trained on data that is similar to your dataset and which has a sufficient number of dimensions so as to capture the nuances of your text.", "For this demonstration, I\u2019ll use the Swivel embedding which was trained on Google News and has 20 dimensions (i.e., it is pretty coarse). This is sufficient for what we need to do.", "The Swivel embedding layer is already available in TensorFlow SavedModel format, so we simply need to download it, extract it from the tarred, gzipped file, and upload it to Google Cloud Storage:", "Once the model files on GCS, we can load it into BigQuery as an ML model:", "To try out the model in BigQuery, we need to know its input and output schema. These would be the names of the Keras layers when it was exported. We can get them by going to the BigQuery console and viewing the \u201cSchema\u201d tab of the model:", "Let\u2019s try this model out by getting the embedding for a famous August speech, calling the input text as sentences and knowing that we will get an output column named output_0:", "The result has 20 numbers as expected, the first few of which are shown below:", "Define a function to compute the Euclidean squared distance between a pair of embeddings:", "Then, compute the embedding for our search term:", "and compute the distance between each comment\u2019s embedding and the term_embedding of the search term (above):", "Remember that we searched for \u201cpower line down on home\u201d. Note that the top two results are \u201cpower line down on house\u201d \u2014 the text embedding has been helpful in recognizing that home and house are similar in this context. The next set of top matches are all about power lines, the most unique pair of words in our search term.", "Document clustering involves using the embeddings as an input to a clustering algorithm such as K-Means. We can do this in BigQuery itself, and to make things a bit more interesting, we\u2019ll use the location and day-of-year as additional inputs to the clustering algorithm.", "The embedding (output_0) is an array, but BigQuery ML currently wants named inputs. The work around is to convert the array to a struct:", "The resulting ten clusters can visualized in the BigQuery console:", "What do the comments in cluster #1 look like? The query is:", "The result shows that these are mostly short, uninformative comments:", "How about cluster #3? Most of these reports seem to have something to do with verification by radar!!!", "TensorFlow Hub has several text embedding models. You don\u2019t have to use Swivel, although Swivel is a good general-purpose choice.", "Full queries are in my notebook on GitHub. You can try out the queries in the BigQuery console or in an AI Platform Jupyter notebook.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "articles are personal observations and not investment advice."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F75eb8f45ab65&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-do-text-similarity-search-and-document-clustering-in-bigquery-75eb8f45ab65&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-do-text-similarity-search-and-document-clustering-in-bigquery-75eb8f45ab65&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-do-text-similarity-search-and-document-clustering-in-bigquery-75eb8f45ab65&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-do-text-similarity-search-and-document-clustering-in-bigquery-75eb8f45ab65&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----75eb8f45ab65--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----75eb8f45ab65--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://lakshmanok.medium.com/?source=post_page-----75eb8f45ab65--------------------------------", "anchor_text": ""}, {"url": "https://lakshmanok.medium.com/?source=post_page-----75eb8f45ab65--------------------------------", "anchor_text": "Lak Lakshmanan"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F247b0630b5d6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-do-text-similarity-search-and-document-clustering-in-bigquery-75eb8f45ab65&user=Lak+Lakshmanan&userId=247b0630b5d6&source=post_page-247b0630b5d6----75eb8f45ab65---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F75eb8f45ab65&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-do-text-similarity-search-and-document-clustering-in-bigquery-75eb8f45ab65&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F75eb8f45ab65&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-do-text-similarity-search-and-document-clustering-in-bigquery-75eb8f45ab65&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/blob/master/09_bqml/text_embeddings.ipynb", "anchor_text": "my notebook in GitHub"}, {"url": "https://pixabay.com/users/kerttu-569708/?utm_source=link-attribution&utm_medium=referral&utm_campaign=image&utm_content=1151405", "anchor_text": "kerttu"}, {"url": "https://pixabay.com/?utm_source=link-attribution&utm_medium=referral&utm_campaign=image&utm_content=1151405", "anchor_text": "Pixabay"}, {"url": "https://tfhub.dev/", "anchor_text": "TensorFlow Hub"}, {"url": "https://tfhub.dev/google/tf2-preview/gnews-swivel-20dim/1", "anchor_text": "Swivel"}, {"url": "https://tfhub.dev/google/tf2-preview/gnews-swivel-20dim/1?tf-hub-format=compressed", "anchor_text": "https://tfhub.dev/google/tf2-preview/gnews-swivel-20dim/1?tf-hub-format=compressed"}, {"url": "https://tfhub.dev/", "anchor_text": "TensorFlow Hub"}, {"url": "https://tfhub.dev/google/tf2-preview/gnews-swivel-20dim/1", "anchor_text": "Swivel"}, {"url": "https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/blob/master/09_bqml/text_embeddings.ipynb", "anchor_text": "my notebook on GitHub"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----75eb8f45ab65---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/sql?source=post_page-----75eb8f45ab65---------------sql-----------------", "anchor_text": "Sql"}, {"url": "https://medium.com/tag/bigquery?source=post_page-----75eb8f45ab65---------------bigquery-----------------", "anchor_text": "Bigquery"}, {"url": "https://medium.com/tag/google-cloud?source=post_page-----75eb8f45ab65---------------google_cloud-----------------", "anchor_text": "Google Cloud"}, {"url": "https://medium.com/tag/naturallanguageprocessing?source=post_page-----75eb8f45ab65---------------naturallanguageprocessing-----------------", "anchor_text": "Naturallanguageprocessing"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F75eb8f45ab65&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-do-text-similarity-search-and-document-clustering-in-bigquery-75eb8f45ab65&user=Lak+Lakshmanan&userId=247b0630b5d6&source=-----75eb8f45ab65---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F75eb8f45ab65&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-do-text-similarity-search-and-document-clustering-in-bigquery-75eb8f45ab65&user=Lak+Lakshmanan&userId=247b0630b5d6&source=-----75eb8f45ab65---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F75eb8f45ab65&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-do-text-similarity-search-and-document-clustering-in-bigquery-75eb8f45ab65&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----75eb8f45ab65--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F75eb8f45ab65&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-do-text-similarity-search-and-document-clustering-in-bigquery-75eb8f45ab65&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----75eb8f45ab65---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----75eb8f45ab65--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----75eb8f45ab65--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----75eb8f45ab65--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----75eb8f45ab65--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----75eb8f45ab65--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----75eb8f45ab65--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----75eb8f45ab65--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----75eb8f45ab65--------------------------------", "anchor_text": ""}, {"url": "https://lakshmanok.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://lakshmanok.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Lak Lakshmanan"}, {"url": "https://lakshmanok.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "9.3K Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F247b0630b5d6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-do-text-similarity-search-and-document-clustering-in-bigquery-75eb8f45ab65&user=Lak+Lakshmanan&userId=247b0630b5d6&source=post_page-247b0630b5d6--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F44e3f26acd1a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-do-text-similarity-search-and-document-clustering-in-bigquery-75eb8f45ab65&newsletterV3=247b0630b5d6&newsletterV3Id=44e3f26acd1a&user=Lak+Lakshmanan&userId=247b0630b5d6&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}