{"url": "https://towardsdatascience.com/review-kaggle-corporaci%C3%B3n-favorita-grocery-sales-forecasting-part-i-9330b7350713", "time": 1682993218.222063, "path": "towardsdatascience.com/review-kaggle-corporaci%C3%B3n-favorita-grocery-sales-forecasting-part-i-9330b7350713/", "webpage": {"metadata": {"title": "[Review] Kaggle Corporaci\u00f3n Favorita Grocery Sales Forecasting \u2014 Part 1 | by Ceshine Lee | Towards Data Science", "h1": "[Review] Kaggle Corporaci\u00f3n Favorita Grocery Sales Forecasting \u2014 Part 1", "description": "Since upgrading my gear from GTX960 4GB to GTX1070 (8GB) in July last year, I\u2019ve been keen on improving my general deep learning skill set. I used PyTorch in the two previous Kaggle competition\u2026"}, "outgoing_paragraph_urls": [{"url": "https://www.kaggle.com/c/instacart-market-basket-analysis", "anchor_text": "Instacart Market Basket Analysis", "paragraph_index": 0}, {"url": "https://www.kaggle.com/c/web-traffic-time-series-forecasting#timeline", "anchor_text": "Web Traffic Time Series Forecasting", "paragraph_index": 0}, {"url": "https://www.kaggle.com/c/web-traffic-time-series-forecasting", "anchor_text": "Web Traffic Time Series Forecasting", "paragraph_index": 24}, {"url": "https://www.kaggle.com/c/zillow-prize-1", "anchor_text": "Zillow\u2019s Home Value Prediction", "paragraph_index": 24}, {"url": "https://www.kaggle.com/shixw125/1st-place-lgb-model-public-0-506-private-0-511", "anchor_text": "top 1 spot with a LGBM model", "paragraph_index": 26}], "all_paragraphs": ["Since upgrading my gear from GTX960 4GB to GTX1070 (8GB) in July last year, I\u2019ve been keen on improving my general deep learning skill set. I used PyTorch in the two previous Kaggle competition, Instacart Market Basket Analysis and Web Traffic Time Series Forecasting. My DNN models for the Instacart competition were doomed to fail because I had not mastered how to load dataset that is bigger than the size of the memory (16GB) and it\u2019s really important for DNN models to have enough training data. The web traffic forecasting competition though, was much more interesting. The 1st position solution turned out to be very similar to what I had in mind. However, I was not able to finish my model on time, and the final submissions were seriously flawed. I was very lucky it still landed in the top 50. When Corporaci\u00f3n Favorita competition came up, I found the size of the dataset big enough for DNN, and very soon began to see it as a opportunity to finish what I\u2019ve started in the web traffic forecasting competition.", "Despite the (relatively) disappointing final ranking (20th) due to a bad bet, I still feel quite good about the result. If removing the bad bet, my DNN models would get from a solid silver to maybe 2\u20135th position, depending on how I\u2019d choose to make the final ensemble. Although I\u2019d be very likely better off in terms of ranking if I put more time into improving GBM models, I\u2019d achieved what I signed up for (to build what I had in mind for the web traffic competition, and a bit more).", "This is also my first time I compete as a team (I had teamed up with my mentee at work once but I failed to make room for him to contribute). We had many thought-provoking discussions and it was generally a very good experience. I really thought we were going to get very good result as a team. I haven\u2019t had the chance to re-run my teammate\u2019s model with the bad bet removed, but based on past experience his models should be able to boost us to a solid top 3 spot (my GBM models really suck).", "Sorry for the very long introduction\u2026 I have a problem of blabbering when it comes to something I feel attached to. In this Part I, I plan to give an overview of the problem and do a postmortem with my models trained before the end of the competition. In the next post I\u2019ll present a setting that I found most ideal but had not enough time to include in the final submissions because I missed the insight until the last week of the competition.", "The challenge of the competition is to predict the unit sales for each item in each store for each day in the period from 2017/08/16 to 2017/08/31. There are 54 stores located at 22 different cities in 16 states of Ecuador. There are 4400 unique items from 33 families and 337 classes. The evaluation metric is Normalized Weighted Root Mean Squared Logarithmic Error (NWRMSLE):", "Deciding evaluation metric is actually the most important part in real world scenarios. You need to make sure it aligns with your business goal. Unfortunately, Kaggle usually don\u2019t share much information on how the decision was made, possibly because of the trade secrets involved. It\u2019s really a very complicated problem with many trade-offs to make, and we could write an entire independent post on that. The discussion forum of this competition has many good insights on whether this metric is appropriate. Go there if you\u2019re interested.", "There are of course other aspects of this dataset that can be improved, e.g. providing the types and intensities of the promotions, the shelf positions of items in stores, but they are mostly icing on the cake. The two problems presented above actually hinders the real-world application of this dataset.", "A lot of people had tried to restore the onpromotion information, as we\u2019d learned after the competition was over. My teammate also came up a clever way to restore the information, based on the insight that the stores often had very similar promotion schedule for certain items. So he developed an algorithm that finds subgroups of stores and dates that are (1) always or (2) mostly have the same promotion schedule if we ignore entries having unknown onpromotion, and guesses the unknown based on that pattern. It does not involve any leaderboard probing, but there\u2019s no other way to validate its effect other than using the public leaderboard.", "I felt uncomfortable how dramatic the distribution of the predictions had changed from original models to models trained with restored onpromotion from both patterns (1) and (2), so I decided to train my models restored onpromotion from only patterns (1) for 2017 and 2016 data. I left 2015 and 2014 data as is because they contains a lot more NA in onpromotion. And I mixed the models trained with restored onpromotion with ones trained with all unknown onpromotion filled with 0 (50/50 ratio). (That\u2019s why I found out what went wrong very quickly after the competition finished. I just removed the problematic 50% of the ensemble and voil\u00e0 the private score improved.)", "This final 50/50 setup gave me 0.001~0.002 boosts in public score but 0.002+ decreases in private score. My teammate went all-in and seemed to get even larger decreases. That\u2019s the peril of validating using public score. We got comfortable with this very risky bet and did not do enough to hedge the bet. Even the 50/50 ratio was set in a completely arbitrary and subjective way since we have no way to verify it except for the public score.", "We also used all our spare submission slots to probe the leaderboard about the new items. We want to know from the public score which stores had non-zero sales of those new items in the next 5 days (the public split). My teammate built the models for predicting those new items. Unfortunately in the end we are better off predicting zeros for all new items. I\u2019m not sure if removing restored onpromotion can help, but the score differences were less than 0.001 anyway.", "The data from year 2014 to 2017 were used to train my model. I only included selected months for each year so I can avoid modeling the effect of 2016 earthquake and also too much disk serialization. I would use more data if I have 32+ GB RAM in my computer.", "I mainly used three different validation periods for this competition:", "For all the DNN models, I used (1) the last 56 days (2) roughly the same 56 days in the previous year and (3) the 16 days after that 56 days in the previous year to predict the next 16 days. To save time, I used various filters to reduce the size of the dataset:", "I predicted zero for all the discarded (store, item) combinations. I had planned to explore removing those filters but kept postponing it. My teammate reminded me of it in the last week of the competition, and I checked the validation prediction to see if the models can do better than predicting zeros for those (store, item) with no sales recently. The models actually did significantly better! I was going to leave those simple gains in score on the table!", "I did not have much time then, so I quickly trained a set of models using 2017/07/26 validation with the filter removed, and also picked up previously trained models using 2016/09/07 and 56 days filter because it\u2019s the only trained setup with 56 days filer available at the time. The (store, item) discarded by some models will be predicted solely by the models that did not in the final ensemble. This explains the weird model setup we\u2019re about to see in the next section.", "I won\u2019t go into model details in the post. They will be covered in the later part(s). I used 4 versions of the settings in my final ensemble:", "The DNN models and GBM models are averaged in log scale using 13:3 weight ratio. (Ratio obtained from cross-validation.)", "Here\u2019s how my ensemble would perform without the restored onpromotion:", "comp_filter means the predictions from that setting are only used for those (store, item) combonations that are discarded by all other settings. Note that all the models were trained before the end of the competition, and the internal ensemble weights remains the same except the weights for all models trained with restored onpromotion (they are set to zero). I only changed the way how models from different settings are mixed together.", "These are the ideal settings I\u2019d use if I had the time:", "We can remove v12_lgb by taking out 56-day filters in v13 and v14. It might actually do a little bit better. But I think it does not worth the increase of training time.", "I\u2019m training some models according to these settings and we\u2019ll see how they perform in the next post.", "It\u2019s worth mentioning that the score distribution in the private leaderboard is more dense than I expected. I expected more variation because of the higher uncertainty in the later days. A possible explanation is we all did a bad job predicting sales in the later days, so we ended up in the same ballpark.", "That\u2019s the problem of this kind of time-split competition. In the real world, we\u2019d probably care more about the prediction for the first 5 days than for the later 11 days, as we can adjust our prediction again 5 days later. How this competition was set up implied we only cared about the later 11 days, which would only be reasonable if the sales data takes 5 days to be ready to use. I think the better way to do this is a two-stage setup like Web Traffic Time Series Forecasting and Zillow\u2019s Home Value Prediction. Release a train dataset solely for the private leaderboard.", "This Part I did not cover what most people care about \u2014 model structures, features, hyper-parameters, ensemble technique, etc. Instead it focused on what I found more important in the data science process \u2014 analyzing and formulating dataset, and described my thought process leading to where I was in the end.", "In fact, you can achieve top 1 spot with a LGBM model with some amount of feature engineering. If you just want to see a top level solution, you could just check out that kernel. Personally I\u2019m satisfied with a working DNN framework that can be used in later projects and requires little feature engineering, even though it may be outperformed by well-crafted GBM models.", "I\u2019ll share the scores from model trained with the ideal settings, and maybe describe my models a bit in the next part. Eventually I hope I can find time to extract a cleaner and simpler version of my code and open-source it on Github.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Data Geek. Maker. Researcher. Twitter: @ceshine_en"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F9330b7350713&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freview-kaggle-corporaci%C3%B3n-favorita-grocery-sales-forecasting-part-i-9330b7350713&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freview-kaggle-corporaci%C3%B3n-favorita-grocery-sales-forecasting-part-i-9330b7350713&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freview-kaggle-corporaci%C3%B3n-favorita-grocery-sales-forecasting-part-i-9330b7350713&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freview-kaggle-corporaci%C3%B3n-favorita-grocery-sales-forecasting-part-i-9330b7350713&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----9330b7350713--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----9330b7350713--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@ceshine?source=post_page-----9330b7350713--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@ceshine?source=post_page-----9330b7350713--------------------------------", "anchor_text": "Ceshine Lee"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fa50580c33120&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freview-kaggle-corporaci%C3%B3n-favorita-grocery-sales-forecasting-part-i-9330b7350713&user=Ceshine+Lee&userId=a50580c33120&source=post_page-a50580c33120----9330b7350713---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F9330b7350713&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freview-kaggle-corporaci%C3%B3n-favorita-grocery-sales-forecasting-part-i-9330b7350713&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F9330b7350713&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freview-kaggle-corporaci%C3%B3n-favorita-grocery-sales-forecasting-part-i-9330b7350713&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://pixabay.com/en/bananas-fruits-food-grocery-store-698608/", "anchor_text": "Source"}, {"url": "https://www.kaggle.com/c/favorita-grocery-sales-forecasting", "anchor_text": "Corporaci\u00f3n Favorita Grocery Sales ForecastingCan you accurately predict sales for a large grocery chain?www.kaggle.com"}, {"url": "https://www.kaggle.com/c/instacart-market-basket-analysis", "anchor_text": "Instacart Market Basket Analysis"}, {"url": "https://www.kaggle.com/c/web-traffic-time-series-forecasting#timeline", "anchor_text": "Web Traffic Time Series Forecasting"}, {"url": "https://www.kaggle.com/c/web-traffic-time-series-forecasting#timeline", "anchor_text": "Web Traffic Time Series ForecastingForecast future traffic to Wikipedia pageswww.kaggle.com"}, {"url": "http://pytorch.org/docs/master/_modules/torch/optim/lr_scheduler.html#ReduceLROnPlateau", "anchor_text": "ReduceLROnPlateau"}, {"url": "https://docs.google.com/spreadsheets/d/1lUdflmNPLa5tXTXKTzT7RCtRJ5_sUwzizU9Jm-I9gvs/edit?usp=sharing", "anchor_text": "Google Spreadsheet Link"}, {"url": "https://pixabay.com/en/time-clock-head-face-view-outlook-3098699/", "anchor_text": "Source"}, {"url": "https://www.kaggle.com/c/web-traffic-time-series-forecasting", "anchor_text": "Web Traffic Time Series Forecasting"}, {"url": "https://www.kaggle.com/c/zillow-prize-1", "anchor_text": "Zillow\u2019s Home Value Prediction"}, {"url": "https://www.kaggle.com/shixw125/1st-place-lgb-model-public-0-506-private-0-511", "anchor_text": "top 1 spot with a LGBM model"}, {"url": "https://medium.com/@ceshine/review-kaggle-corporaci%C3%B3n-favorita-grocery-sales-forecasting-part-ii-680cca7f9bc5", "anchor_text": "[Review] Kaggle Corporaci\u00f3n Favorita Grocery Sales Forecasting \u2014 Part IIPost-competition Models and Model Descriptionsmedium.com"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----9330b7350713---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/kaggle?source=post_page-----9330b7350713---------------kaggle-----------------", "anchor_text": "Kaggle"}, {"url": "https://medium.com/tag/forecasting?source=post_page-----9330b7350713---------------forecasting-----------------", "anchor_text": "Forecasting"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F9330b7350713&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freview-kaggle-corporaci%25C3%25B3n-favorita-grocery-sales-forecasting-part-i-9330b7350713&user=Ceshine+Lee&userId=a50580c33120&source=-----9330b7350713---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F9330b7350713&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freview-kaggle-corporaci%25C3%25B3n-favorita-grocery-sales-forecasting-part-i-9330b7350713&user=Ceshine+Lee&userId=a50580c33120&source=-----9330b7350713---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F9330b7350713&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freview-kaggle-corporaci%C3%B3n-favorita-grocery-sales-forecasting-part-i-9330b7350713&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----9330b7350713--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F9330b7350713&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freview-kaggle-corporaci%C3%B3n-favorita-grocery-sales-forecasting-part-i-9330b7350713&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----9330b7350713---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----9330b7350713--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----9330b7350713--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----9330b7350713--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----9330b7350713--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----9330b7350713--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----9330b7350713--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----9330b7350713--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----9330b7350713--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@ceshine?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@ceshine?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Ceshine Lee"}, {"url": "https://medium.com/@ceshine/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "1.6K Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fa50580c33120&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freview-kaggle-corporaci%C3%B3n-favorita-grocery-sales-forecasting-part-i-9330b7350713&user=Ceshine+Lee&userId=a50580c33120&source=post_page-a50580c33120--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F9ac31978da65&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freview-kaggle-corporaci%C3%B3n-favorita-grocery-sales-forecasting-part-i-9330b7350713&newsletterV3=a50580c33120&newsletterV3Id=9ac31978da65&user=Ceshine+Lee&userId=a50580c33120&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}