{"url": "https://towardsdatascience.com/real-time-multi-facial-attribute-detection-using-transfer-learning-and-haar-cascades-with-fastai-47ff59e36df0", "time": 1682995050.0676322, "path": "towardsdatascience.com/real-time-multi-facial-attribute-detection-using-transfer-learning-and-haar-cascades-with-fastai-47ff59e36df0/", "webpage": {"metadata": {"title": "Facial attribute detection using Deep learning | by Aayush Agrawal | Towards Data Science", "h1": "Facial attribute detection using Deep learning", "description": "In this post, we are trying to achieve the above result. The post guides with an end to end process on how I went about building this. The entire codebase for replicating the project is in my GitHub\u2026"}, "outgoing_paragraph_urls": [{"url": "https://github.com/aayushmnit/Deep_learning_explorations/tree/master/7_Facial_attributes_fastai_opencv", "anchor_text": "GitHub repository", "paragraph_index": 0}, {"url": "https://cloud.google.com/vision/", "anchor_text": "Google vision API", "paragraph_index": 1}, {"url": "https://www.kaggle.com/datasets", "anchor_text": "Kaggle dataset website", "paragraph_index": 2}, {"url": "https://www.kaggle.com/jessicali9530/celeba-dataset", "anchor_text": "CelebFaces Attributes (CelebA) Dataset", "paragraph_index": 2}, {"url": "https://github.com/aayushmnit/Deep_learning_explorations/blob/master/7_Facial_attributes_fastai_opencv/Data_prepration.ipynb", "anchor_text": "this notebook", "paragraph_index": 5}, {"url": "https://github.com/ageitgey/face_recognition", "anchor_text": "Face Recognition", "paragraph_index": 6}, {"url": "https://docs.opencv.org/3.3.0/d7/d8b/tutorial_py_face_detection.html", "anchor_text": "Haar cascades", "paragraph_index": 6}, {"url": "https://towardsdatascience.com/face-detection-for-beginners-e58e8f21aad9", "anchor_text": "this blog", "paragraph_index": 7}, {"url": "https://github.com/opencv/opencv/tree/master/data/haarcascades", "anchor_text": "pre-built haar cascade", "paragraph_index": 7}, {"url": "https://docs.opencv.org/3.3.0/index.html", "anchor_text": "OpenCV", "paragraph_index": 7}, {"url": "https://docs.fast.ai/", "anchor_text": "FastAI", "paragraph_index": 11}, {"url": "https://pytorch.org/", "anchor_text": "Pytorch 1.0", "paragraph_index": 11}, {"url": "https://github.com/aayushmnit/Deep_learning_explorations/blob/master/7_Facial_attributes_fastai_opencv/MultiClass%20classification%20on%20CelebA%20dataset%20using%20FastAI.ipynb", "anchor_text": "Github here", "paragraph_index": 11}, {"url": "https://github.com/aayushmnit/Deep_learning_explorations/blob/master/7_Facial_attributes_fastai_opencv/detect_features.py", "anchor_text": "Github here", "paragraph_index": 42}, {"url": "https://github.com/aayushmnit/Deep_learning_explorations/tree/master/7_Facial_attributes_fastai_opencv", "anchor_text": "Github", "paragraph_index": 45}, {"url": "https://www.linkedin.com/in/aayushmnit/", "anchor_text": "LinkedIn", "paragraph_index": 45}, {"url": "http://aayushmnit.com", "anchor_text": "aayushmnit.com", "paragraph_index": 47}], "all_paragraphs": ["In this post, we are trying to achieve the above result. The post guides with an end to end process on how I went about building this. The entire codebase for replicating the project is in my GitHub repository.", "For any deep learning model to give reasonable accuracy, we need to rely on a large amount of labeled data. Most of the repo\u2019s on facial feature detection I found are focused only on multi-class classification like Emotion detection, smile detection, etc. I was looking for a dataset with multiple labels attached to a facial image so that I can achieve something which a Google vision API achieve as below \u2014", "So for this purpose, I found a dataset on Kaggle dataset website called CelebFaces Attributes (CelebA) Dataset which contains -", "It\u2019s a pretty decent size dataset for doing various exciting problems in computer vision, for my purpose I was only interested in facial images and the 40 binary attribute annotations of those images. The 40 binary attributes(Yes/No) are listed here \u2014 5_o_Clock_Shadow, Arched_Eyebrows, Attractive, Bags_Under_Eyes, Bald, Bangs, Big_Lips, Big_Nose, Black_Hair, Blond_Hair, Blurry, Brown_Hair, Bushy_Eyebrows, Chubby, Double_Chin, Eyeglasses, Goatee, Gray_Hair, Heavy_Makeup, High_Cheekbones, Male, Mouth_Slightly_Open, Mustache, Narrow_Eyes, No_Beard, Oval_Face, Pale_Skin, Pointy_Nose, Receding_Hairline, Rosy_Cheeks, Sideburns, Smiling, Straight_Hair, Wavy_Hair, Wearing_Earrings, Wearing_Hat, Wearing_Lipstick, Wearing_Necklace, Wearing_Necktie, Young. Here is an example -", "The above image has these features labeled \u2014 Arched_Eyebrows, Attractive, Big_Lips, Heavy_Makeup, Narrow_Eyes, No_Beard, Pointy_Nose, Wearing_Lipstick, Young. Because Male flag is False, we can say that the label is Female.", "The entire code for data pre-processing is in this notebook.", "Key thoughts I have when I was doing data processing for CelebA dataset was to think that how I am going to use the model built on a real video/webcam stream/image. CelebA data is tightly cropped around the face but in a video/webcam/image the face can be anywhere, and it has to be detected first. There are many prebuilt tools to localize a face in an image for example Face Recognition, which uses a deep learning network to detect a face. I wanted to keep this step simple, so I used Haar cascades, which is a traditional computer vision approach to detect objects. Haar cascade return the bounding box coordinates on an image where the face is detected, here is an example output of using Haar cascade -", "To learn more about HAAR cascades refer to this blog. There are pre-built haar cascade filters in OpenCV. I am using one of them for frontal face detection. So once decided on the methodology for face detection, the next step is to apply the same method on the CelebA dataset to detect faces and crop only the facial area of an image(with some added margins), this step will help ensure that", "Notice in the above case the picture in the left is transformed to picture in the right(looks more zoomed-in) after haar cascade cropping. We also filtered down from 202,599 to 175,640 images as the filtered images don\u2019t contain the front side faces. An example of a filtered image is shown below -", "Apart from pre-processing on images, we need to create our label file which can be used by FastAI dataset loader.", "In the original label file, the multi-attribute labels contain 1 /-1 value for every 40 attributes where 1 signifying if the feature is present and -1 meaning the absence of that feature. I just wrote a simple function to convert this file so that we only have one label column with space separated labels(figure below)-", "Once we have pre-processed our data, the next step is to build a model which can detect these 40+ attributes given a facial image. For this, we are going to use FastAI v1 library written over Pytorch 1.0. The model training notebook can be found on my Github here. I have divided the data in the training and validation set based on the recommended partitioning that image number from 1\u2013182637 for training and 182638 onwards for validation. It\u2019s incredibly easy to train world-class models with few lines of code in FastAI library, so let\u2019s go through the code -", "Boiler Plate library import commands \u2014", "Line 1 \u2014 Defining the path to the dataset folder.", "Line 2\u20134 \u2014 Defining how we are going to find the training and validation image.", "Line 6\u20137 \u2014 Define transformation we want to do on our data like rotating the image randomly by a maximum of 30 degrees and lighting adjustment of a max of 0.3.", "Line 8 \u2014 Define images as Item list from the labels CSV", "Line 9 \u2014 Split data in training and validation by using the validation function in Line 2\u20134", "Line 10 \u2014 Helps get our label from the tags column of labels.csv and helps us define that it\u2019s a multi-label column where a space separates labels.", "Line 12 \u2014 Passing the transformation function from Line 6\u20137 and resizing images to 3*128*128", "Line 13 \u2014 Defines our batch size of 256 images and normalize our data by using ImageNet averages", "Notice that we are using a smaller image size for initial training of our model and later on we are going to increase the image size to 3*256*256. This trick helps us train our model faster by allowing bigger batch size and experiment more quickly on what model configuration works.", "We are going to do transfer learning by using a pre-trained ResNet 50 model for this modeling exercise.", "Line1 \u2014 Downloads a pre-trained Resnet 50 model", "Line 2\u20136 \u2014 In FastAI, we can track as many accuracy measures on validation data; these metrics are just for monitoring and are not used in training the model. We are using partial functions to define accuracy at a different threshold and also tracking the F-score at threshold 0.2", "Line 7 \u2014 Helps in creating a CNN architecture by using the pre-trained convolution part of ResNet 50 model and adding two new Fully connected layers at the top.", "The good thing about FastAI is that it saves a lot of time in training by finding an ideal learning rate for a particular exercise of interest.", "Line 1 \u2014 Finds the ideal learning rate by trying multiple learning rates on a sample of data", "Line 2 \u2014 Let us plot the loss at various learning rate.", "We need to choose a learning rate with the maximum declining slope on the above function. In this case, it\u2019s 1e-2.", "Now we have trained our last fully connected layer a bit. Let us unfreeze all the layers and train the full model. We are going to use the learning rate finder to determine the ideal learning rate again.", "Line 1 \u2014 Unfree all the layers", "Line 2\u20133 \u2014 Helps us find the ideal learning rate.", "Now we will use different learning rate for each layer in the model by exponentially decaying the learning rate as we go back in layers.", "Line 1 \u2014 Uses one cycle learning by the variable learning rate", "Line 2 \u2014 Saves our model with the specified name.", "Now we can increase the input image size to 3*256*256 and use transfer learning on the above-trained model to adjust to the new input image size.", "Line 1\u20132 \u2014 Create a new data loader which resizes images to 3*256*256 and reduces the batch size to 64.", "Line 4\u20136 \u2014 Defines which metric we need to track and create a ResNet 50 model similar to the previous model.", "Line 8 \u2014 Loads the weights from our previously trained model into the newly created model.", "Now we can train the model a bit more following similar steps as mentioned above. The training notebook also provides codes to visualize activations of the intermediate layer to help understand what part of the image drives the final result of the model.", "As we can see from the image above the model is most activated where the face is in the image, which is what we want as it\u2019s a facial feature detection model.", "Now we have our model trained let\u2019s write a script which can do facial attribute detection, the last part it to put it all together. The code for this part is on my Github here.", "The script does the following task -", "In the above blog, we saw how to do end to end facial attribute detection problem by combining various techniques from traditional machine vision to deep learning together.", "I hope you enjoyed reading, and feel free to use my code on Github to try it out for your purposes. Also, if there is any feedback on code or just the blog post, feel free to reach out on LinkedIn or email me at aayushmnit@gmail.com. You can also follow me on Medium and Github for future blog post and exploration project codes I might write.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Experienced data scientist. Passionate about solving interesting problems with data. All views are my own unless you share them. More on aayushmnit.com"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F47ff59e36df0&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freal-time-multi-facial-attribute-detection-using-transfer-learning-and-haar-cascades-with-fastai-47ff59e36df0&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freal-time-multi-facial-attribute-detection-using-transfer-learning-and-haar-cascades-with-fastai-47ff59e36df0&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freal-time-multi-facial-attribute-detection-using-transfer-learning-and-haar-cascades-with-fastai-47ff59e36df0&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freal-time-multi-facial-attribute-detection-using-transfer-learning-and-haar-cascades-with-fastai-47ff59e36df0&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----47ff59e36df0--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----47ff59e36df0--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@aayushmnit?source=post_page-----47ff59e36df0--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@aayushmnit?source=post_page-----47ff59e36df0--------------------------------", "anchor_text": "Aayush Agrawal"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F85dd669ac015&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freal-time-multi-facial-attribute-detection-using-transfer-learning-and-haar-cascades-with-fastai-47ff59e36df0&user=Aayush+Agrawal&userId=85dd669ac015&source=post_page-85dd669ac015----47ff59e36df0---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F47ff59e36df0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freal-time-multi-facial-attribute-detection-using-transfer-learning-and-haar-cascades-with-fastai-47ff59e36df0&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F47ff59e36df0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freal-time-multi-facial-attribute-detection-using-transfer-learning-and-haar-cascades-with-fastai-47ff59e36df0&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://github.com/aayushmnit/Deep_learning_explorations/tree/master/7_Facial_attributes_fastai_opencv", "anchor_text": "GitHub repository"}, {"url": "https://cloud.google.com/vision/", "anchor_text": "Google vision API"}, {"url": "https://www.kaggle.com/datasets", "anchor_text": "Kaggle dataset website"}, {"url": "https://www.kaggle.com/jessicali9530/celeba-dataset", "anchor_text": "CelebFaces Attributes (CelebA) Dataset"}, {"url": "https://github.com/aayushmnit/Deep_learning_explorations/blob/master/7_Facial_attributes_fastai_opencv/Data_prepration.ipynb", "anchor_text": "this notebook"}, {"url": "https://github.com/ageitgey/face_recognition", "anchor_text": "Face Recognition"}, {"url": "https://docs.opencv.org/3.3.0/d7/d8b/tutorial_py_face_detection.html", "anchor_text": "Haar cascades"}, {"url": "https://towardsdatascience.com/face-detection-for-beginners-e58e8f21aad9", "anchor_text": "this blog"}, {"url": "https://github.com/opencv/opencv/tree/master/data/haarcascades", "anchor_text": "pre-built haar cascade"}, {"url": "https://docs.opencv.org/3.3.0/index.html", "anchor_text": "OpenCV"}, {"url": "https://docs.fast.ai/", "anchor_text": "FastAI"}, {"url": "https://pytorch.org/", "anchor_text": "Pytorch 1.0"}, {"url": "https://github.com/aayushmnit/Deep_learning_explorations/blob/master/7_Facial_attributes_fastai_opencv/MultiClass%20classification%20on%20CelebA%20dataset%20using%20FastAI.ipynb", "anchor_text": "Github here"}, {"url": "https://github.com/aayushmnit/Deep_learning_explorations/blob/master/7_Facial_attributes_fastai_opencv/detect_features.py", "anchor_text": "Github here"}, {"url": "https://github.com/aayushmnit/Deep_learning_explorations/tree/master/7_Facial_attributes_fastai_opencv", "anchor_text": "Github"}, {"url": "https://www.linkedin.com/in/aayushmnit/", "anchor_text": "LinkedIn"}, {"url": "https://medium.com/tag/computer-vision?source=post_page-----47ff59e36df0---------------computer_vision-----------------", "anchor_text": "Computer Vision"}, {"url": "https://medium.com/tag/opencv?source=post_page-----47ff59e36df0---------------opencv-----------------", "anchor_text": "Opencv"}, {"url": "https://medium.com/tag/data-science?source=post_page-----47ff59e36df0---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----47ff59e36df0---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/tag/facial-recognition?source=post_page-----47ff59e36df0---------------facial_recognition-----------------", "anchor_text": "Facial Recognition"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F47ff59e36df0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freal-time-multi-facial-attribute-detection-using-transfer-learning-and-haar-cascades-with-fastai-47ff59e36df0&user=Aayush+Agrawal&userId=85dd669ac015&source=-----47ff59e36df0---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F47ff59e36df0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freal-time-multi-facial-attribute-detection-using-transfer-learning-and-haar-cascades-with-fastai-47ff59e36df0&user=Aayush+Agrawal&userId=85dd669ac015&source=-----47ff59e36df0---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F47ff59e36df0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freal-time-multi-facial-attribute-detection-using-transfer-learning-and-haar-cascades-with-fastai-47ff59e36df0&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----47ff59e36df0--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F47ff59e36df0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freal-time-multi-facial-attribute-detection-using-transfer-learning-and-haar-cascades-with-fastai-47ff59e36df0&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----47ff59e36df0---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----47ff59e36df0--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----47ff59e36df0--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----47ff59e36df0--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----47ff59e36df0--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----47ff59e36df0--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----47ff59e36df0--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----47ff59e36df0--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----47ff59e36df0--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@aayushmnit?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@aayushmnit?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Aayush Agrawal"}, {"url": "https://medium.com/@aayushmnit/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "414 Followers"}, {"url": "http://aayushmnit.com", "anchor_text": "aayushmnit.com"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F85dd669ac015&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freal-time-multi-facial-attribute-detection-using-transfer-learning-and-haar-cascades-with-fastai-47ff59e36df0&user=Aayush+Agrawal&userId=85dd669ac015&source=post_page-85dd669ac015--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F8137fc02bcb8&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freal-time-multi-facial-attribute-detection-using-transfer-learning-and-haar-cascades-with-fastai-47ff59e36df0&newsletterV3=85dd669ac015&newsletterV3Id=8137fc02bcb8&user=Aayush+Agrawal&userId=85dd669ac015&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}