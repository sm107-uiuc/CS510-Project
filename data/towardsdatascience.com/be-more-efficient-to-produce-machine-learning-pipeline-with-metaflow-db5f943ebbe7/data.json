{"url": "https://towardsdatascience.com/be-more-efficient-to-produce-machine-learning-pipeline-with-metaflow-db5f943ebbe7", "time": 1683003352.275684, "path": "towardsdatascience.com/be-more-efficient-to-produce-machine-learning-pipeline-with-metaflow-db5f943ebbe7/", "webpage": {"metadata": {"title": "Be more efficient to produce machine learning pipeline with Metaflow | by Jean-Michel D | Towards Data Science", "h1": "Be more efficient to produce machine learning pipeline with Metaflow", "description": "For this article, I am going to describe my hands-on on a new library that has open-sourced recently by Netflix to operate and version machine learning/data science pipeline called Metaflow. Metaflow\u2026"}, "outgoing_paragraph_urls": [{"url": "https://metaflow.org/", "anchor_text": "Metaflow", "paragraph_index": 0}, {"url": "https://netflixtechblog.com/open-sourcing-metaflow-a-human-centric-framework-for-data-science-fa72e04a5d9", "anchor_text": "article", "paragraph_index": 8}, {"url": "https://github.com/spotify/luigi", "anchor_text": "Spotify Luigi", "paragraph_index": 12}, {"url": "https://www.datacamp.com/community/tutorials/decorators-python", "anchor_text": "article", "paragraph_index": 16}, {"url": "https://docs.metaflow.org/metaflow/dependencies", "anchor_text": "documentation", "paragraph_index": 17}, {"url": "https://github.com/jeanmidevacc/metaflow-experimentation", "anchor_text": "this repository", "paragraph_index": 18}, {"url": "http://the-odd-dataguy.com/a-gentle-introduction-on-hearthstone/", "anchor_text": "Hearthstone", "paragraph_index": 31}, {"url": "https://github.com/jeanmidevacc/metaflow-experimentation", "anchor_text": "this repository", "paragraph_index": 34}, {"url": "https://github.com/jeanmidevacc/metaflow-experimentation/blob/master/hearthstone_deckarchetypeestimator/monitoring.ipynb", "anchor_text": "notebook", "paragraph_index": 36}, {"url": "https://docs.metaflow.org/metaflow-on-aws/metaflow-on-aws", "anchor_text": "documentation", "paragraph_index": 40}, {"url": "https://metaflow.org/sandbox/", "anchor_text": "AWS sandbox", "paragraph_index": 40}, {"url": "https://github.com/jeanmidevacc/metaflow-experimentation/blob/master/hearthstone_deckarchetypeestimator/pipeline_crossflow.py", "anchor_text": "the other script", "paragraph_index": 47}], "all_paragraphs": ["For this article, I am going to describe my hands-on on a new library that has open-sourced recently by Netflix to operate and version machine learning/data science pipeline called Metaflow.", "The idea of this article is to :", "Metaflow is a package developed by Netflix, they started to work on it a few years ago (around 2016), and open-sourced in 2019. The idea of Metaflow is to offer a framework for data scientists to build a data science/machine learning pipeline quickly, and that can go smoothly from development to production.", "I am inviting you to watch the presentation of Ville Tuulos of Netflix at AWS reinvent 2019.", "The big question at Netflix behind this package was", "What is the hardest thing for a data scientist in its daily job ?\u201d", "The engineers of Netflix were expecting to listen to access large datasets, significant computing power and usage of GPU, but the answer (two years ago) was different. One of the most significant bottleneck was the data access and the move from PoC to production.", "In the following figure, there is a visualization of the interest of data scientists and the infrastructure needs in an ML/DS process.", "In this article that announces Metaflow, there is one quote that I think is defining the moho behind Metaflow:", "The infrastructure should allow them to exercise their freedom as data scientists, but it should provide enough guardrails and scaffolding, so they don\u2019t have to worry about software architecture too much.", "The idea is to offer a safe path for the data scientist in their work without compromising their creativity. This framework needs to be easy to use and offer access to significant computing power without having to put hands on the infrastructure.", "Let see more the design of the framework.", "Metaflow is a Python library that is only running on Linux, mostly inspired by Spotify Luigi, and designed around DAG. In the following figure, there is a representation of a typical flow on Metaflow.", "The DAG is structured around :", "Let\u2019s talk about the architecture now. In the following figure of Netflix, there is a view of the components.", "There are 3 components around the flow:", "For me, one of the central part that is handling the core of Metaflow is the decorator. It is a Python feature that permits to update the property of a python object without modifying his structure, and I am inviting you to read this article of Data camp on the subject.", "In Metaflow, there are multiple decorators, well explained in this section of the documentation. Still, for me, the most important are the ones that I am going to explain in the next part.", "I built a simple flow to illustrate the decorators and the branches\u2019 transitions. The code of flow is in this repository ( decorator_experimentation folder); the flow is looking like that.", "And there is a visual illustration of the flow.", "This goal of the flow is to :", "The regular check of the version of Python/Pandas is to illustrate two specific decorators.Let\u2019s start by the standard execution of the script; to execute this flow, you need to run the following command in the folder of the script.", "There is the log produced by the script.", "As we can see on the log, the version of Python is 3.6.9 and Pandas is 0.25.3. Let\u2019s test the @conda_base decorator. Just need to uncomment a line and execute the following command line.", "This decorator applied a new version of Python on the flow, in this case, 3.7.4, with a new version of Pandas (0.25.2). There is the log produced by the pipeline.", "As I said, there is now a new version of Python/Pandas used to execute all the flow. To finish, let\u2019s see the @conda decorator.", "This one is like the @conda_base, but only for a step, in this case, I am modifying the python version to 3.6.8 just for this specific step (with a random version of Pandas, I know it looks stupid, but It\u2019s just for test).", "And in the log, we can see that there is a new version of Python/pandas applied just for the check_version step.", "I think that this test illustrates the usage of Metaflow to version the environment used for the execution of a flow or a step. The strength of Metaflow is to offer the flexibility to a data scientist to set up precisely the environment needed to execute code without having to set up a conda environment or a container.", "There is more than these decorators in the package like:", "Let\u2019s see a data science/machine learning flow designed with Metaflow.", "A few weeks ago, I built a dataset related to Hearthstone, the card game of Blizzard. I invite you to have a look at it if you don\u2019t have a clear vision of the game.", "One aspect that I avoided in the previous article was the notion of archetype. These archetypes are based on the hero selected and the cards in the deck, there is multiple kind of archetype, and some are most popular.", "In the dataset presented in the previous article, 40% of the decks have no archetype associated, so I wanted to start to build an archetype predictor based on the card used (It\u2019s a dummy system just to test the flow of Metaflow).", "In the following figure, there is a representation of the flow that I designed to test Metaflow (the code is in the folder related to Hearthstone in this repository).", "The idea of this flow is to build a Random forest predictor of the archetype based on the top cards of the archetype that we want to assign to the one that have no archetype. I think that the code is clear enough, so I am not going to enter too much in details of the execution because it\u2019s not exciting. I am going to take time to analyze the result of multiple runs with the client of Metaflow.", "The data produced during the different executions of the flow are stored in a data store in a local storage (in a /metaflow hidden folder on your working directory). Still, all the results can be accessed directly in a notebook. I am going to put the \u201cprocessing part\u201d of the artifacts of the different runs in a gist.", "The goal is to compute the time of execution, collect the first sample of the training set, and the information on the best model produced by the HPO (accuracy and parameters). There is a screenshot of the processing.", "As we can see, there is a lot of information that is versioned during the execution of the flow. I am really like this versioning of all the data produced during a pipeline for reproducibility and debugging it\u2019s excellent.", "Let\u2019s now have a look at the AWS part of Metaflow.", "Metaflow gives you all the processes to set up your AWS environment in their documentation. Still, I am lazy, and they can give you access to an AWS sandbox (with restricted resources to test the features on the cloud) just by signing up on the website.", "After a few days, you have access to the sandbox ( I would like to thanks again Metaflow support to have granted my access a little bit more longer to their sandbox to make some presentations around me).", "To set up the connection to the sandbox is straightforward, just need to add a token in a command line of Metaflow. After that, all your backend is:", "Two options are used to access AWS computation from your local machine:", "I found this approach of cloud management compelling and easy to use and the switch between local computation to cloud computation is straightforward. To illustrate the cloud computation, I just screenshotted the CPU usage on my instance that is running my Metaflow code versus the kind of run that I executed.", "I think that it is a good illustration of the fact that my local machine is not used to do the computation versus the local run (between the boundaries of the run 11 and 17.", "And now the final question on Metaflow can it work with mlflow.", "No please do it, I added in the other script the mlflow layer to my HPO. I just am adding in my mlflow logs information related to my Metaflow run. There is a screenshot of the logs of mlflow.", "The two versioning framework seems to work great together. So today, we can do the monitoring of your pipeline with Metaflow, logs your model and do the deployment with mlflow on any cloud platform support.", "Metaflow is a framework that has been developing for data scientist it offers:", "It\u2019s a great job that has been done by Netflix and open-sourced. More elements are coming on Metaflow like:", "The only drawbacks that I have on Metaflow are:", "I am going to follow the evolution in Metaflow, but honestly, the first try was good, and I am inviting you to try it and make your own opinion.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Data scientist at @ubisoftMtl (Worked for @edfenergy, @cea_officiel, @cstb_fr) My opinion are my own (and I have always an opinion because I am French)"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fdb5f943ebbe7&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbe-more-efficient-to-produce-machine-learning-pipeline-with-metaflow-db5f943ebbe7&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbe-more-efficient-to-produce-machine-learning-pipeline-with-metaflow-db5f943ebbe7&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbe-more-efficient-to-produce-machine-learning-pipeline-with-metaflow-db5f943ebbe7&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbe-more-efficient-to-produce-machine-learning-pipeline-with-metaflow-db5f943ebbe7&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----db5f943ebbe7--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----db5f943ebbe7--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@boitemailjeanmid?source=post_page-----db5f943ebbe7--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@boitemailjeanmid?source=post_page-----db5f943ebbe7--------------------------------", "anchor_text": "Jean-Michel D"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fc607131f9cd3&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbe-more-efficient-to-produce-machine-learning-pipeline-with-metaflow-db5f943ebbe7&user=Jean-Michel+D&userId=c607131f9cd3&source=post_page-c607131f9cd3----db5f943ebbe7---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fdb5f943ebbe7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbe-more-efficient-to-produce-machine-learning-pipeline-with-metaflow-db5f943ebbe7&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fdb5f943ebbe7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbe-more-efficient-to-produce-machine-learning-pipeline-with-metaflow-db5f943ebbe7&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/photos/vS7LVkPyXJU", "anchor_text": "Unsplash"}, {"url": "https://metaflow.org/", "anchor_text": "Metaflow"}, {"url": "https://docs.metaflow.org/getting-started/tutorials", "anchor_text": "the tutorials"}, {"url": "https://netflixtechblog.com/open-sourcing-metaflow-a-human-centric-framework-for-data-science-fa72e04a5d9", "anchor_text": "https://netflixtechblog.com/open-sourcing-metaflow-a-human-centric-framework-for-data-science-fa72e04a5d9"}, {"url": "https://netflixtechblog.com/open-sourcing-metaflow-a-human-centric-framework-for-data-science-fa72e04a5d9", "anchor_text": "article"}, {"url": "https://github.com/spotify/luigi", "anchor_text": "Spotify Luigi"}, {"url": "https://netflixtechblog.com/open-sourcing-metaflow-a-human-centric-framework-for-data-science-fa72e04a5d9", "anchor_text": "https://netflixtechblog.com/open-sourcing-metaflow-a-human-centric-framework-for-data-science-fa72e04a5d9"}, {"url": "https://docs.metaflow.org/", "anchor_text": "documentation"}, {"url": "https://docs.metaflow.org/", "anchor_text": "https://docs.metaflow.org/"}, {"url": "https://www.datacamp.com/community/tutorials/decorators-python", "anchor_text": "article"}, {"url": "https://docs.metaflow.org/metaflow/dependencies", "anchor_text": "documentation"}, {"url": "https://github.com/jeanmidevacc/metaflow-experimentation", "anchor_text": "this repository"}, {"url": "http://the-odd-dataguy.com/a-gentle-introduction-on-hearthstone/", "anchor_text": "Hearthstone"}, {"url": "https://github.com/jeanmidevacc/metaflow-experimentation", "anchor_text": "this repository"}, {"url": "https://github.com/jeanmidevacc/metaflow-experimentation/blob/master/hearthstone_deckarchetypeestimator/monitoring.ipynb", "anchor_text": "notebook"}, {"url": "https://docs.metaflow.org/metaflow-on-aws/metaflow-on-aws", "anchor_text": "documentation"}, {"url": "https://metaflow.org/sandbox/", "anchor_text": "AWS sandbox"}, {"url": "https://aws.amazon.com/s3/?sc_channel=PS&sc_campaign=acquisition_CA&sc_publisher=google&sc_medium=ACQ-P%7CPS-GO%7CBrand%7CDesktop%7CSU%7CStorage%7CS3%7CCA%7CEN%7CText&sc_content=s3_e&sc_detail=aws%20s3&sc_category=Storage&sc_segment=293634539894&sc_matchtype=e&sc_country=CA&s_kwcid=AL!4422!3!293634539894!e!!g!!aws%20s3&ef_id=CjwKCAiA66_xBRBhEiwAhrMuLbbCejPdVe1ALI7jLgtUYhM2JAYzO3GOoslfsz0rSmc1Srh96tC_rRoCk5oQAvD_BwE:G:s", "anchor_text": "S3"}, {"url": "https://aws.amazon.com/rds/", "anchor_text": "RDS"}, {"url": "https://aws.amazon.com/batch/", "anchor_text": "AWS batch"}, {"url": "https://aws.amazon.com/sagemaker/", "anchor_text": "Amazon Sagemaker"}, {"url": "https://github.com/jeanmidevacc/metaflow-experimentation/blob/master/hearthstone_deckarchetypeestimator/pipeline_crossflow.py", "anchor_text": "the other script"}, {"url": "http://the-odd-dataguy.com/", "anchor_text": "the-odd-dataguy.com"}, {"url": "https://medium.com/tag/data-science?source=post_page-----db5f943ebbe7---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----db5f943ebbe7---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/netflix?source=post_page-----db5f943ebbe7---------------netflix-----------------", "anchor_text": "Netflix"}, {"url": "https://medium.com/tag/versioning?source=post_page-----db5f943ebbe7---------------versioning-----------------", "anchor_text": "Versioning"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fdb5f943ebbe7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbe-more-efficient-to-produce-machine-learning-pipeline-with-metaflow-db5f943ebbe7&user=Jean-Michel+D&userId=c607131f9cd3&source=-----db5f943ebbe7---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fdb5f943ebbe7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbe-more-efficient-to-produce-machine-learning-pipeline-with-metaflow-db5f943ebbe7&user=Jean-Michel+D&userId=c607131f9cd3&source=-----db5f943ebbe7---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fdb5f943ebbe7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbe-more-efficient-to-produce-machine-learning-pipeline-with-metaflow-db5f943ebbe7&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----db5f943ebbe7--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fdb5f943ebbe7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbe-more-efficient-to-produce-machine-learning-pipeline-with-metaflow-db5f943ebbe7&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----db5f943ebbe7---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----db5f943ebbe7--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----db5f943ebbe7--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----db5f943ebbe7--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----db5f943ebbe7--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----db5f943ebbe7--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----db5f943ebbe7--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----db5f943ebbe7--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----db5f943ebbe7--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@boitemailjeanmid?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@boitemailjeanmid?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Jean-Michel D"}, {"url": "https://medium.com/@boitemailjeanmid/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "226 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fc607131f9cd3&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbe-more-efficient-to-produce-machine-learning-pipeline-with-metaflow-db5f943ebbe7&user=Jean-Michel+D&userId=c607131f9cd3&source=post_page-c607131f9cd3--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F5b424bd1598&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbe-more-efficient-to-produce-machine-learning-pipeline-with-metaflow-db5f943ebbe7&newsletterV3=c607131f9cd3&newsletterV3Id=5b424bd1598&user=Jean-Michel+D&userId=c607131f9cd3&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}