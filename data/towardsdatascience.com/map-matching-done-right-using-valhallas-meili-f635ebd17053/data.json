{"url": "https://towardsdatascience.com/map-matching-done-right-using-valhallas-meili-f635ebd17053", "time": 1683015440.164068, "path": "towardsdatascience.com/map-matching-done-right-using-valhallas-meili-f635ebd17053/", "webpage": {"metadata": {"title": "Map Matching done right using Valhalla\u2019s Meili | by Sergei Zotov | Towards Data Science", "h1": "Map Matching done right using Valhalla\u2019s Meili", "description": "The problem of GPS being non ideally accurate is not new, as well as the \u201csnap-to-road\u201d functionality that mainly does the matching of GPS traces to roads. Most of the projects that tend to have this\u2026"}, "outgoing_paragraph_urls": [{"url": "https://developers.google.com/maps/documentation/roads/snap", "anchor_text": "Google Maps Snap to Roads API", "paragraph_index": 0}, {"url": "http://project-osrm.org/docs/v5.22.0/api/?language=cURL#match-service", "anchor_text": "OSRM Match Service API", "paragraph_index": 0}, {"url": "https://github.com/valhalla/valhalla", "anchor_text": "GitHub repository", "paragraph_index": 6}, {"url": "https://github.com/valhalla/valhalla", "anchor_text": "GitHub", "paragraph_index": 10}, {"url": "https://github.com/ptpt", "anchor_text": "https://github.com/ptpt", "paragraph_index": 25}, {"url": "https://github.com/kevinkreiser", "anchor_text": "https://github.com/kevinkreiser", "paragraph_index": 25}, {"url": "https://www.linkedin.com/in/szotov/", "anchor_text": "LinkedIn", "paragraph_index": 26}, {"url": "https://github.com/zotttttttt/gps-trace-optimization/blob/main/GPS-trace-optimization-via-Valhalla.ipynb", "anchor_text": "the full Jupyter Notebook", "paragraph_index": 27}], "all_paragraphs": ["The problem of GPS being non ideally accurate is not new, as well as the \u201csnap-to-road\u201d functionality that mainly does the matching of GPS traces to roads. Most of the projects that tend to have this problem are solving this either through Google Maps Snap to Roads API or OSRM Match Service API. But I\u2019m going to show you the way I had taken and didn\u2019t regret anything.", "Primarily my problem was to calculate the distances of travelling per day and month done by cars. What\u2019s also important is that I was trying to build a production solution that could do that every day, so not only a research part.", "Since I had multiple already preprocessed GPS traces in GeoJSON, I created a Python script that calculates distances using geopy.distance.geodesic function and looping over the whole trip's geopoints. By my rough estimation, this approach sometimes had an error rate of more than 30%, which is actually horrible. Let me explain why.", "As shown in the map below, sometimes GPS traces are not exactly accurate. Obviously, the driver was using the road path here, but the geopoints that we got from the GPS are placed near the road, not on it.", "First of all, I wanted to solve this problem myself. I thought that it can be done with some math involved, but thankfully I quickly understood that the problem is more about where to get roads\u2019 coordinates before even getting to the math and found OSRM / Google Maps APIs that can do the whole process for me.", "Google Maps API didn\u2019t quite amaze me since it only can get up to 100 geopoints in their Snap to Roads method, which is very low for GPS traces of a car. On the other hand, OSRM API looked good, until I stumbled across Valhalla.", "As perfectly pointed out in their GitHub repository, Valhalla is an open-source routing engine and accompanying libraries for use with OpenStreetMap data. Valhalla also includes tools like time+distance matrix computation, isochrones, elevation sampling, map matching and tour optimization (Travelling Salesman).", "Here are the benefits of using Valhalla which I could think of:", "Meili is one of the main modules inside Valhalla. Its function is to perform map matching (snap to road functionality), which is exactly what I needed to solve my problem.", "To briefly explain how it works, Meili firstly finds nearest candidates of road segments within the given radius of a given position and then detects the highest probability map match (Viterbi path) using Viterbi algorithm in the context of hidden Markov models (HMM).", "I\u2019m not going to fill this article with the information on the details of those algorithms and how to set up Valhalla and run a server on your machine. It is perfectly explained on GitHub, so I suggest you go there for this purpose.", "Instead, let\u2019s get practical and use Python, Pandas and Valhalla\u2019s Meili to fix our GPS traces.", "For simplifying this example, I\u2019m going to use a Pandas DataFrame (df_trip) with these columns:", "My example consists of 82 rows representing geopoints of an actual GPS trace:", "Now let\u2019s add headers and perform an actual request to the local server:", "Here\u2019s a server log with a correct response from Valhalla:", "If Valhalla does not respond with 200, it\u2019s primarily because:", "I use this code to process the response from Meili. It\u2019s not beautiful, but it works:", "Here\u2019s the outcome of this code:", "It resulted in the addition of 3 new columns:", "To save the geopoints that couldn\u2019t be snapped to any road (for example, some movement on a parking lot) you can use this code that also parses the \u201clocation\u201d column that we got from Meili before:", "As a result, we have a very neat GPS trace, snapped to the actual road, as shown below:", "Let\u2019s combine both GPS traces (optimized and non-optimized) to see the difference:", "The main reason for me to choose Valhalla instead of OSRM API was that Valhalla is a production-ready solution with many other benefits to it.", "For fast research purposes, you might use OSRM API instead of Valhalla since you can do it without priorly setting up an environment.", "I want to say big thanks to all Valhalla contributors. Especially to the creators of Meili, Tao Peng (https://github.com/ptpt) and Kevin Kreiser (https://github.com/kevinkreiser). You guys rock!", "Hopefully, this article helped you somehow. Feel free to contact me on LinkedIn or leave a comment down below.", "You can also explore the full Jupyter Notebook that solves this exact problem with some minor additions.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "I specialize in building Data Science teams, processes and products. Achieved $5M+ ARR Growth"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Ff635ebd17053&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmap-matching-done-right-using-valhallas-meili-f635ebd17053&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmap-matching-done-right-using-valhallas-meili-f635ebd17053&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmap-matching-done-right-using-valhallas-meili-f635ebd17053&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmap-matching-done-right-using-valhallas-meili-f635ebd17053&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----f635ebd17053--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----f635ebd17053--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@zotov?source=post_page-----f635ebd17053--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@zotov?source=post_page-----f635ebd17053--------------------------------", "anchor_text": "Sergei Zotov"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F2a2a47362d65&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmap-matching-done-right-using-valhallas-meili-f635ebd17053&user=Sergei+Zotov&userId=2a2a47362d65&source=post_page-2a2a47362d65----f635ebd17053---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ff635ebd17053&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmap-matching-done-right-using-valhallas-meili-f635ebd17053&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ff635ebd17053&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmap-matching-done-right-using-valhallas-meili-f635ebd17053&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://developers.google.com/maps/documentation/roads/snap", "anchor_text": "Google Maps Snap to Roads API"}, {"url": "http://project-osrm.org/docs/v5.22.0/api/?language=cURL#match-service", "anchor_text": "OSRM Match Service API"}, {"url": "https://github.com/valhalla/valhalla", "anchor_text": "GitHub repository"}, {"url": "https://github.com/valhalla/valhalla", "anchor_text": "GitHub"}, {"url": "https://github.com/valhalla/valhalla#running", "anchor_text": "GitHub"}, {"url": "https://github.com/ptpt", "anchor_text": "https://github.com/ptpt"}, {"url": "https://github.com/kevinkreiser", "anchor_text": "https://github.com/kevinkreiser"}, {"url": "https://www.linkedin.com/in/szotov/", "anchor_text": "LinkedIn"}, {"url": "https://github.com/zotttttttt/gps-trace-optimization/blob/main/GPS-trace-optimization-via-Valhalla.ipynb", "anchor_text": "the full Jupyter Notebook"}, {"url": "https://medium.com/tag/geospatial?source=post_page-----f635ebd17053---------------geospatial-----------------", "anchor_text": "Geospatial"}, {"url": "https://medium.com/tag/gps?source=post_page-----f635ebd17053---------------gps-----------------", "anchor_text": "Gps"}, {"url": "https://medium.com/tag/valhalla?source=post_page-----f635ebd17053---------------valhalla-----------------", "anchor_text": "Valhalla"}, {"url": "https://medium.com/tag/snap-to-road?source=post_page-----f635ebd17053---------------snap_to_road-----------------", "anchor_text": "Snap To Road"}, {"url": "https://medium.com/tag/pandas?source=post_page-----f635ebd17053---------------pandas-----------------", "anchor_text": "Pandas"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Ff635ebd17053&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmap-matching-done-right-using-valhallas-meili-f635ebd17053&user=Sergei+Zotov&userId=2a2a47362d65&source=-----f635ebd17053---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Ff635ebd17053&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmap-matching-done-right-using-valhallas-meili-f635ebd17053&user=Sergei+Zotov&userId=2a2a47362d65&source=-----f635ebd17053---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ff635ebd17053&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmap-matching-done-right-using-valhallas-meili-f635ebd17053&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----f635ebd17053--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Ff635ebd17053&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmap-matching-done-right-using-valhallas-meili-f635ebd17053&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----f635ebd17053---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----f635ebd17053--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----f635ebd17053--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----f635ebd17053--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----f635ebd17053--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----f635ebd17053--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----f635ebd17053--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----f635ebd17053--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----f635ebd17053--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@zotov?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@zotov?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Sergei Zotov"}, {"url": "https://medium.com/@zotov/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "27 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F2a2a47362d65&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmap-matching-done-right-using-valhallas-meili-f635ebd17053&user=Sergei+Zotov&userId=2a2a47362d65&source=post_page-2a2a47362d65--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fe2fcad71a78a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmap-matching-done-right-using-valhallas-meili-f635ebd17053&newsletterV3=2a2a47362d65&newsletterV3Id=e2fcad71a78a&user=Sergei+Zotov&userId=2a2a47362d65&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}