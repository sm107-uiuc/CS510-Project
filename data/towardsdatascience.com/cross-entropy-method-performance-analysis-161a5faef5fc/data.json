{"url": "https://towardsdatascience.com/cross-entropy-method-performance-analysis-161a5faef5fc", "time": 1683008843.4779289, "path": "towardsdatascience.com/cross-entropy-method-performance-analysis-161a5faef5fc/", "webpage": {"metadata": {"title": "Cross-Entropy Method Performance Analysis | by Jordi TORRES.AI | Towards Data Science", "h1": "Cross-Entropy Method Performance Analysis", "description": "In this post, we will describe in detail the training loop of the Cross-Entropy method, which we have skipped in the previous post, as well as see how we can improve the learning of the Agent\u2026"}, "outgoing_paragraph_urls": [{"url": "https://github.com/jorditorresBCN/Deep-Reinforcement-Learning-Explained/blob/master/DRL_06_07_Cross_Entropy.ipynb", "anchor_text": "entire code of this post can be found on GitHub", "paragraph_index": 2}, {"url": "https://colab.research.google.com/github/jorditorresBCN/Deep-Reinforcement-Learning-Explained/blob/master/DRL_06_07_Cross_Entropy.ipynb", "anchor_text": "can be run as a Colab google notebook using this link", "paragraph_index": 2}, {"url": "https://towardsdatascience.com/pytorch-performance-analysis-with-tensorboard-7c61f91071aa", "anchor_text": "previous post", "paragraph_index": 40}, {"url": "https://github.com/jorditorresBCN/Deep-Reinforcement-Learning-Explained/blob/master/DRL_06_07_Cross_Entropy.ipynb", "anchor_text": "GitHub code", "paragraph_index": 43}, {"url": "https://towardsdatascience.com/the-bellman-equation-59258a0d3fa7", "anchor_text": "the next post", "paragraph_index": 56}, {"url": "https://towardsdatascience.com/the-bellman-equation-59258a0d3fa7", "anchor_text": "the next post", "paragraph_index": 57}, {"url": "https://github.com/jorditorresBCN/Deep-Reinforcement-Learning-Explained/blob/master/DRL_06_07_Cross_Entropy.ipynb", "anchor_text": "entire code of this post can be found on GitHub", "paragraph_index": 58}, {"url": "https://colab.research.google.com/github/jorditorresBCN/Deep-Reinforcement-Learning-Explained/blob/master/DRL_06_07_Cross_Entropy.ipynb", "anchor_text": "can be run as a Colab google notebook using this link", "paragraph_index": 58}, {"url": "https://github.com/PacktPublishing/Deep-Reinforcement-Learning-Hands-On-Second-Edition/tree/master/Chapter04", "anchor_text": "the code of Maxim Lapan who has written an excellent practical book on the subject", "paragraph_index": 59}, {"url": "https://www.upc.edu/en", "anchor_text": "UPC Barcelona Tech", "paragraph_index": 60}, {"url": "https://www.bsc.es/", "anchor_text": "Barcelona Supercomputing Center", "paragraph_index": 60}, {"url": "https://torres.ai/deep-reinforcement-learning-explained-series/", "anchor_text": "series", "paragraph_index": 61}, {"url": "https://twitter.com/hashtag/StayAtHome?src=hashtag_click", "anchor_text": "#StayAtHome", "paragraph_index": 62}, {"url": "https://torres.ai", "anchor_text": "https://torres.ai", "paragraph_index": 65}], "all_paragraphs": ["In this post, we will describe in detail the training loop of the Cross-Entropy method, which we have skipped in the previous post, as well as see how we can improve the learning of the Agent considering more complex neural networks. Also, we will present the improved variant of the method that keeps \u201celite\u201d episodes for several iterations of the training process. Finally, we will show the limitations of the Cross-Entropy method to motivate other approaches.", "Next, we will present in detail the code that makes up the training loop that we presented in the previous post.", "The entire code of this post can be found on GitHub and can be run as a Colab google notebook using this link.", "The code begins by defining the main parameters of the method.", "We suggest to use two helper classes to easy the explainability of the code:", "Here we will define two helper classes that are named tuples from the collections package in the standard library:", "At this point, a set of variables that we will use in the training loop are initialized. We will present each of them as they are required in the loop:", "We learned in the previous post that the training loop of our Agent that implements the Cross-Entropy algorithm repeats 4 main steps until we become satisfied with the result:", "1 \u2014 Play N number of episodes", "2 \u2014 Calculate the Expected Return for every episode and decide on a return boundary", "3 \u2014 Throw away all episodes with a return below the boundary.", "4 \u2014 Train the neural network using episode steps from the \u201celite\u201d episodes", "We have decided that the Agent must be trained until a certain Reward threshold is reached. Specifically, we have decided a threshold of 80% indicated in the variable REWARD_GOAL:", "The next piece of code is the one that generates the batches with episodes:", "The main variables we will use are:", "The list of episode steps is extended with an (observation, action) pair. It is important to note that we save the observed state that was used to choose the action (but not the observation next_state returned by the Environment as a result of the action):", "The reward is added to the current episode\u2019s total reward:", "When the current episode is over (hole or goal state) we need to append the finalized episode to the batch, saving the total reward and steps we have taken. Then, we reset our environment to start over and we reset variables episode_steps and episode_reward to start to track next episode:", "The next piece of code implements step 2:", "The training loop executes this step when a number of plays equal toBATCH_SIZE have been run:", "First, the code calculates the expected return for all the episodes in the current batch:", "In this step, from the given batch of episodes and percentile value, we calculate a boundary reward, which will be used to filter \u201celite\u201d episodes to train the Agents neural networks:", "To obtain the boundary reward, we will use NumPy\u2019s percentile function, which, from the list of values and the desired percentile, calculates the percentile\u2019s value. In this code, we will use the top 30% of episodes (indicated by the variable PERCENTILE) to create the \u201celite\u201d episodes.", "During this step we compute the reward_mean that is used to decide when to finish the training loop:", "Next, we will filter off our episodes with the following code:", "For every episode in the batch:", "we will check that the episode has a higher total reward than our boundary:", "and if it has, we will populate the list of observed states and actions that we will train on, and keep track of the elite episodes:", "Then we will update this tree variable with the \u201celite\u201d episodes, the list of states and actions with which we will train our neural network:", "Every time our loop accumulates enough episodes (BATCH_SIZE), we compute the \u201celite\u201d episodes and at the same iteration the loop trains the neural network of the Agent with this code:", "This code train the neural network using episode steps from the \u201celite\u201d episodes, using the state s as the input and issued actions a as the label (desired output). Let\u2019s go to comment it in more detail al the code lines:", "First, we transform the variables to tensors:", "We zero gradients of our neural network", "and pass the observed state to the neural network, obtaining its action scores:", "These scores are passed to the objective function, which will calculate cross-entropy between the neural network output and the actions that the agent took", "Remember that we only consider \u201celite\u201d actions. The idea of this is to reinforce our neural network to carry out those \u201celite\u201d actions that have led to good rewards.", "Finally, we need to calculate gradients on the loss using thebackward method and adjust the parameters of our neural network using the step method of the optimizer:", "In order to monitor the progress of the Agent\u2019s learning performance, we included this print in the training loop:", "With it we show the iteration number, the loss and the mean reward of the batch (in the next section we also write the same values to TensorBoard to get a nice chart):", "We can check that the last value of the reward_mean variable is the one that allowed to finish the training loop.", "In a previous post, we already introduced TensorBoard, a tool that helps in the process of data visualization. Instead, the \u201cprint\u201d used in the previous section, we could use these two sentences to plot the behavior of these two variables:", "In this case, the output is:", "One question that arises is if we could improve the Agent\u2019s neural network. For instance, what happens if we consider a hidden layer with more neurons, let say 128 neurons:", "The result can be shown here (or executing the GitHub code):", "We can see that this network learns faster than the previous one.", "What happens if we change the activation function? e.g. a ReLU instead a Sigmoid?", "Below you can see what happens: the network converges much earlier, with only 200 iterations it has already been completed.", "So far we have shown how to improve the neural network architecture. But we can also improve the algorithm itself: we can keep \u201celite\u201d episodes for a longer time. The previous version of the algorithm samples episodes from the Environment, train on the best ones and threw them away. However, when the number of successful episodes is small, the \u201celite\u201d episodes can be maintained longer, keeping them for several iterations to train on them. We need to change only one line in the code:", "The result seen through TensorBoard is:", "We can see that the number of iterations required is reduced again.", "So far we have seen that with the proposed improvements, with very few iterations of the training loop we can find a good neural network. But this is because we are talking about a very simple \u201cnon-slippery\u201d Environment. But what if we have a \u201cslippery\u201d environment?", "Again TensorBoard is a big help. In the following figure, we see the behavior of the algorithm during the first iterations. It is not able to take off the value of the Reward:", "But if we wait for 5,000 more iterations, we see that it can improve, but from there it stagnates and is no longer able to surpass a threshold:", "And although we have waited more than two hours, it fails to improve and not surpass the threshold of 60%:", "In these two posts about Cross-Entropy method the reader became familiar with the method. We choosed this method becase it was a good warm-up due to it is simple but quite powerful, despite its limitations, and merge Reinforcement Learning and Deep Learning.", "We applied it to FrozenLake Environment. We have seen that with can find a good neural network for the simple \u201cnon-slippery\u201d Environment. But if we consider a \u201cslippery\u201d Environment the Cross-Entropy method cannot find the solution (of training a neural network). Later in the series, you will become familiar with other methods that address these limitations.", "In the next post, that starts a new part of this series, we will switch to a more systematic study of RL methods and discuss the value-based family of methods.", "See you in the next post!.", "The entire code of this post can be found on GitHub and can be run as a Colab google notebook using this link.", "Acknowledgments: The code presented in this post has been inspired from the code of Maxim Lapan who has written an excellent practical book on the subject.", "by UPC Barcelona Tech and Barcelona Supercomputing Center", "A relaxed introductory series that gradually and with a practical approach introduces the reader to this exciting technology that is the real enabler of the latest disruptive advances in the field of Artificial Intelligence.", "I started to write this series in May, during the period of lockdown in Barcelona. Honestly, writing these posts in my spare time helped me to #StayAtHome because of the lockdown. Thank you for reading this publication in those days; it justifies the effort I made.", "Disclaimers \u2014 These posts were written during this period of lockdown in Barcelona as a personal distraction and dissemination of scientific knowledge, in case it could be of help to someone, but without the purpose of being an academic reference document in the DRL area. If the reader needs a more rigorous document, the last post in the series offers an extensive list of academic resources and books that the reader can consult. The author is aware that this series of posts may contain some errors and suffers from a revision of the English text to improve it if the purpose were an academic document. But although the author would like to improve the content in quantity and quality, his professional commitments do not leave him free time to do so. However, the author agrees to refine all those errors that readers can report as soon as he can.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Professor at UPC Barcelona Tech & Barcelona Supercomputing Center. Research focuses on Supercomputing & Artificial Intelligence https://torres.ai @JordiTorresAI"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F161a5faef5fc&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcross-entropy-method-performance-analysis-161a5faef5fc&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcross-entropy-method-performance-analysis-161a5faef5fc&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcross-entropy-method-performance-analysis-161a5faef5fc&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcross-entropy-method-performance-analysis-161a5faef5fc&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----161a5faef5fc--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----161a5faef5fc--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://torres-ai.medium.com/?source=post_page-----161a5faef5fc--------------------------------", "anchor_text": ""}, {"url": "https://torres-ai.medium.com/?source=post_page-----161a5faef5fc--------------------------------", "anchor_text": "Jordi TORRES.AI"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F497013a3c715&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcross-entropy-method-performance-analysis-161a5faef5fc&user=Jordi+TORRES.AI&userId=497013a3c715&source=post_page-497013a3c715----161a5faef5fc---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F161a5faef5fc&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcross-entropy-method-performance-analysis-161a5faef5fc&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F161a5faef5fc&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcross-entropy-method-performance-analysis-161a5faef5fc&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://towardsdatascience.com/tagged/deep-r-l-explained", "anchor_text": "DEEP REINFORCEMENT LEARNING EXPLAINED \u2014 07"}, {"url": "https://github.com/jorditorresBCN/Deep-Reinforcement-Learning-Explained/blob/master/DRL_06_07_Cross_Entropy.ipynb", "anchor_text": "entire code of this post can be found on GitHub"}, {"url": "https://colab.research.google.com/github/jorditorresBCN/Deep-Reinforcement-Learning-Explained/blob/master/DRL_06_07_Cross_Entropy.ipynb", "anchor_text": "can be run as a Colab google notebook using this link"}, {"url": "https://towardsdatascience.com/pytorch-performance-analysis-with-tensorboard-7c61f91071aa", "anchor_text": "previous post"}, {"url": "https://github.com/jorditorresBCN/Deep-Reinforcement-Learning-Explained/blob/master/DRL_06_07_Cross_Entropy.ipynb", "anchor_text": "GitHub code"}, {"url": "https://towardsdatascience.com/the-bellman-equation-59258a0d3fa7", "anchor_text": "the next post"}, {"url": "https://towardsdatascience.com/the-bellman-equation-59258a0d3fa7", "anchor_text": "the next post"}, {"url": "https://github.com/jorditorresBCN/Deep-Reinforcement-Learning-Explained/blob/master/DRL_06_07_Cross_Entropy.ipynb", "anchor_text": "entire code of this post can be found on GitHub"}, {"url": "https://colab.research.google.com/github/jorditorresBCN/Deep-Reinforcement-Learning-Explained/blob/master/DRL_06_07_Cross_Entropy.ipynb", "anchor_text": "can be run as a Colab google notebook using this link"}, {"url": "https://github.com/PacktPublishing/Deep-Reinforcement-Learning-Hands-On-Second-Edition/tree/master/Chapter04", "anchor_text": "the code of Maxim Lapan who has written an excellent practical book on the subject"}, {"url": "https://www.upc.edu/en", "anchor_text": "UPC Barcelona Tech"}, {"url": "https://www.bsc.es/", "anchor_text": "Barcelona Supercomputing Center"}, {"url": "https://torres.ai/deep-reinforcement-learning-explained-series/", "anchor_text": "series"}, {"url": "https://torres.ai/deep-reinforcement-learning-explained-series/", "anchor_text": "Deep Reinforcement Learning Explained \u2014 Jordi TORRES.AIContent of this series"}, {"url": "https://twitter.com/hashtag/StayAtHome?src=hashtag_click", "anchor_text": "#StayAtHome"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----161a5faef5fc---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/tag/reinforcement-learning?source=post_page-----161a5faef5fc---------------reinforcement_learning-----------------", "anchor_text": "Reinforcement Learning"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----161a5faef5fc---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/tag/deep-r-l-explained?source=post_page-----161a5faef5fc---------------deep_r_l_explained-----------------", "anchor_text": "Deep R L Explained"}, {"url": "https://medium.com/tag/towards-data-science?source=post_page-----161a5faef5fc---------------towards_data_science-----------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F161a5faef5fc&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcross-entropy-method-performance-analysis-161a5faef5fc&user=Jordi+TORRES.AI&userId=497013a3c715&source=-----161a5faef5fc---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F161a5faef5fc&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcross-entropy-method-performance-analysis-161a5faef5fc&user=Jordi+TORRES.AI&userId=497013a3c715&source=-----161a5faef5fc---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F161a5faef5fc&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcross-entropy-method-performance-analysis-161a5faef5fc&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----161a5faef5fc--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F161a5faef5fc&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcross-entropy-method-performance-analysis-161a5faef5fc&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----161a5faef5fc---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----161a5faef5fc--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----161a5faef5fc--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----161a5faef5fc--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----161a5faef5fc--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----161a5faef5fc--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----161a5faef5fc--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----161a5faef5fc--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----161a5faef5fc--------------------------------", "anchor_text": ""}, {"url": "https://torres-ai.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://torres-ai.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Jordi TORRES.AI"}, {"url": "https://torres-ai.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "2.1K Followers"}, {"url": "https://torres.ai", "anchor_text": "https://torres.ai"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F497013a3c715&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcross-entropy-method-performance-analysis-161a5faef5fc&user=Jordi+TORRES.AI&userId=497013a3c715&source=post_page-497013a3c715--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F9fb911e344f9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcross-entropy-method-performance-analysis-161a5faef5fc&newsletterV3=497013a3c715&newsletterV3Id=9fb911e344f9&user=Jordi+TORRES.AI&userId=497013a3c715&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}