{"url": "https://towardsdatascience.com/a-couple-tricks-for-using-spacy-at-scale-54affd8326cf", "time": 1682995767.3841898, "path": "towardsdatascience.com/a-couple-tricks-for-using-spacy-at-scale-54affd8326cf/", "webpage": {"metadata": {"title": "A couple tricks for using spaCy at scale | by Schaun Wheeler | Towards Data Science", "h1": "A couple tricks for using spaCy at scale", "description": "The Python package spaCy is a great tool for natural language processing. Here are a couple things I\u2019ve done to use it on large datasets."}, "outgoing_paragraph_urls": [{"url": "https://spacy.io/", "anchor_text": "SpaCy", "paragraph_index": 1}, {"url": "https://medium.com/activewizards-machine-learning-company/comparison-of-top-6-python-nlp-libraries-c4ce160237eb", "anchor_text": "each with its own strengths and weaknesses", "paragraph_index": 1}, {"url": "https://towardsdatascience.com/deploy-a-python-model-more-efficiently-over-spark-497fc03e0a8d", "anchor_text": "used in the past", "paragraph_index": 7}, {"url": "http://aampe.co", "anchor_text": "aampe.co", "paragraph_index": 11}], "all_paragraphs": ["EDIT: This post is now outdated (look at a few of the comments). Since the time I wrote, SpaCy introduced a pipe method that does what I do here, except it does it without a hack, and faster. I suggest everyone use that method.", "When a project I\u2019m working on requires natural language processing, I tend to turn to SpaCy first. Python has several other NLP pacakges, each with its own strengths and weaknesses. I generally find spaCy to be fast and its conventions to be simple to learn.", "One difficulty I\u2019ve encountered with Spacy is the need to process large numbers of small texts. For example, I recently had several hundred thousands different labels, each ranging from one to 15 words, that I decided I wanted to compare using word2vec. I\u2019ve been happy with spaCy\u2019s word vectorization, but I also needed to process each string to first remove irrelevant words and parts of speech, lemmatize some tokens, and things like that. It took a long time. Here are two ways I sped things up.", "The intuitive way to process a bunch of separate records is to process them separately. I started out by looping through each record, and calling spaCy\u2019s nlp on each one. I didn\u2019t time how long it took to process everything, because I ran out of patience and just killed the process before it finished. So I thought about it a little, read some more of the documentation, and came up with this:", "This joins all the texts into a single string, with each original text separated by some character sequence that is very unlikely to occur naturally. I chose three pipes with a space on each side. I then called nlp once. It took a few seconds to process around 25,000 records. After that, I could run through the list of tokens, identify special sequence of characters, and use that to split the document into spans. These spans contain individual tokens, and have the attributes of documents such as word vectors.", "This isn\u2019t as simple as it sounds. In my experience, the most expensive part of doing NLP is loading the corpus. Once you have everything loaded, it\u2019s just a matter of efficiently looking up the information you need. If you\u2019re using the largest English corpus spaCy offers, as I was, you face some difficulty getting that corpus onto your Spark executors.", "For one thing, spaCy uses a different pickling library than PySpark does, which results in errors when trying to include the corpus in a user defined field \u2014 either as a broadcast variable or otherwise. At any rate, it doesn\u2019t necessarily makes sense to serialize the huge corpus, and then move it over to the executors, and then de-serialize it, when you can just load it on the executor itself.", "That presents a new problem. It takes a long time to load the corpus, so you want to minimize how many times you need to load it. I\u2019ve found it useful to follow a practice I\u2019ve used in the past when deploying Scikit-learn models to Pyspark: group records into reasonably long lists of records, then call a UDF on the list. That allows you to do the expensive thing once, at the cost of having to do a relatively small group of inexpensive things serially.", "So I randomly grouped my spark dataframe into 20 sections, collecting all of my texts into a list. My UDF loads the corpus from spaCy, then runs through the texts to process them.", "Using these two methods, processing large amounts of text has become much more efficient for me.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Co-founder @ aampe.co. Anthropologist + Data Scientist."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F54affd8326cf&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-couple-tricks-for-using-spacy-at-scale-54affd8326cf&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-couple-tricks-for-using-spacy-at-scale-54affd8326cf&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-couple-tricks-for-using-spacy-at-scale-54affd8326cf&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-couple-tricks-for-using-spacy-at-scale-54affd8326cf&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----54affd8326cf--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----54affd8326cf--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@schaun.wheeler?source=post_page-----54affd8326cf--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@schaun.wheeler?source=post_page-----54affd8326cf--------------------------------", "anchor_text": "Schaun Wheeler"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F2d3762e7f110&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-couple-tricks-for-using-spacy-at-scale-54affd8326cf&user=Schaun+Wheeler&userId=2d3762e7f110&source=post_page-2d3762e7f110----54affd8326cf---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F54affd8326cf&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-couple-tricks-for-using-spacy-at-scale-54affd8326cf&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F54affd8326cf&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-couple-tricks-for-using-spacy-at-scale-54affd8326cf&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://spacy.io/", "anchor_text": "SpaCy"}, {"url": "https://medium.com/activewizards-machine-learning-company/comparison-of-top-6-python-nlp-libraries-c4ce160237eb", "anchor_text": "each with its own strengths and weaknesses"}, {"url": "https://towardsdatascience.com/deploy-a-python-model-more-efficiently-over-spark-497fc03e0a8d", "anchor_text": "used in the past"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----54affd8326cf---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/data-science?source=post_page-----54affd8326cf---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/nlp?source=post_page-----54affd8326cf---------------nlp-----------------", "anchor_text": "NLP"}, {"url": "https://medium.com/tag/python?source=post_page-----54affd8326cf---------------python-----------------", "anchor_text": "Python"}, {"url": "https://medium.com/tag/spark?source=post_page-----54affd8326cf---------------spark-----------------", "anchor_text": "Spark"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F54affd8326cf&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-couple-tricks-for-using-spacy-at-scale-54affd8326cf&user=Schaun+Wheeler&userId=2d3762e7f110&source=-----54affd8326cf---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F54affd8326cf&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-couple-tricks-for-using-spacy-at-scale-54affd8326cf&user=Schaun+Wheeler&userId=2d3762e7f110&source=-----54affd8326cf---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F54affd8326cf&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-couple-tricks-for-using-spacy-at-scale-54affd8326cf&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----54affd8326cf--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F54affd8326cf&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-couple-tricks-for-using-spacy-at-scale-54affd8326cf&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----54affd8326cf---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----54affd8326cf--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----54affd8326cf--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----54affd8326cf--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----54affd8326cf--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----54affd8326cf--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----54affd8326cf--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----54affd8326cf--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----54affd8326cf--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@schaun.wheeler?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@schaun.wheeler?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Schaun Wheeler"}, {"url": "https://medium.com/@schaun.wheeler/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "894 Followers"}, {"url": "http://aampe.co", "anchor_text": "aampe.co"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F2d3762e7f110&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-couple-tricks-for-using-spacy-at-scale-54affd8326cf&user=Schaun+Wheeler&userId=2d3762e7f110&source=post_page-2d3762e7f110--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fd8dcfa98f86c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-couple-tricks-for-using-spacy-at-scale-54affd8326cf&newsletterV3=2d3762e7f110&newsletterV3Id=d8dcfa98f86c&user=Schaun+Wheeler&userId=2d3762e7f110&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}