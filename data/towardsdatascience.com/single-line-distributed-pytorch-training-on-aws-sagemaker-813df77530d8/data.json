{"url": "https://towardsdatascience.com/single-line-distributed-pytorch-training-on-aws-sagemaker-813df77530d8", "time": 1683015074.53342, "path": "towardsdatascience.com/single-line-distributed-pytorch-training-on-aws-sagemaker-813df77530d8/", "webpage": {"metadata": {"title": "Single line distributed PyTorch training on AWS SageMaker | by Ariel Shiftan | Towards Data Science", "h1": "Single line distributed PyTorch training on AWS SageMaker", "description": "How to iterate faster on your data science project, to let your brilliant idea to see the light of day"}, "outgoing_paragraph_urls": [{"url": "https://github.com/shiftan/simple_sagemaker", "anchor_text": "simple-sagemaker", "paragraph_index": 2}, {"url": "https://sagemaker.readthedocs.io/en/stable/frameworks/pytorch/using_pytorch.html#distributed-pytorch-training", "anchor_text": "the supported gloo or nccl backends", "paragraph_index": 2}, {"url": "https://github.com/shiftan/simple_sagemaker", "anchor_text": "Simple-sagemaker", "paragraph_index": 3}, {"url": "https://aws.amazon.com/sagemaker/", "anchor_text": "AWS SageMaker", "paragraph_index": 3}, {"url": "https://aws.amazon.com/sagemaker/pricing/", "anchor_text": "any supported instance type", "paragraph_index": 3}, {"url": "https://towardsdatascience.com/a-very-simple-and-cheap-way-to-run-your-processing-job-on-the-cloud-c76af579f9e9", "anchor_text": "this blog post", "paragraph_index": 3}, {"url": "https://github.com/pytorch/examples/tree/master/imagenet", "anchor_text": "official ImageNet example", "paragraph_index": 4}, {"url": "https://github.com/shiftan/simple_sagemaker", "anchor_text": "documentation", "paragraph_index": 8}, {"url": "https://towardsdatascience.com/a-very-simple-and-cheap-way-to-run-your-processing-job-on-the-cloud-c76af579f9e9", "anchor_text": "blog post", "paragraph_index": 8}, {"url": "https://github.com/pytorch/examples/tree/master/imagenet", "anchor_text": "ImageNet example", "paragraph_index": 12}, {"url": "https://console.aws.amazon.com/sagemaker/home#/jobs", "anchor_text": "SageMaker training jobs console", "paragraph_index": 16}, {"url": "https://docs.aws.amazon.com/sagemaker/latest/dg/training-metrics.html", "anchor_text": "SageMaker metrics", "paragraph_index": 23}, {"url": "http://image-net.org/challenges/LSVRC/2012/ilsvrc2012.pdf", "anchor_text": "LSVRC2012 ImageNet", "paragraph_index": 26}, {"url": "http://image-net.org/", "anchor_text": "image-net.org", "paragraph_index": 26}, {"url": "https://cloud.google.com/tpu/docs/imagenet-setup#download_the_imagenet_dataset", "anchor_text": "here", "paragraph_index": 26}, {"url": "https://github.com/shiftan/simple_sagemaker/blob/master/examples/imagenet/run_remote.sh", "anchor_text": "simple-sagemaker repository", "paragraph_index": 30}], "all_paragraphs": ["It doesn\u2019t matter what research project I\u2019m working on, having the right infrastructure in place is always a critical part for success. It\u2019s very simple: assuming all other \u201cparameters\u201d are equal, the faster/cheaper one can iterate, the better results could be achieved for the same time/cost budget. As these are always limited, good infrastructure is usually a make or break for a breakthrough.", "When it comes to data science, and deep learning specifically, the ability to easily distribute the training process on a strong HW, is a key for achieving fast iterations. Even the brightest idea requires a few iterations to get polished and validated, e.g. for checking different pre-processing options, network architectures, and just standard hyperparameters such as batch size and learning rate.", "In this post, I\u2019d like to show you how easy (and cheap, if you want) it is to distribute existing distribution-ready PyTorch training code on AWS SageMaker using simple-sagemaker (assuming distribution is done on top of the supported gloo or nccl backends). Moreover, you\u2019ll see how to easily monitor and analyze resource utilization and key training metrics in real time, during the training.", "Simple-sagemaker is thin wrapper around AWS SageMaker, that makes distribution of work on any supported instance type very simple and cheap. A quick introduction can be found in this blog post.", "I\u2019ll be basing the demonstration on PyTorch\u2019s official ImageNet example. In fact, I\u2019ll be running it as-is on AWS by using just a single command!", "To be more precise, I assume:", "Now, to run the training code on a single p3.2xlarge instance, just run the following command:", "That\u2019s it, take a sit while the training job is running. You may actually need to take a sleep as it should take ~8 hours for 10 epochs on the complete dataset (total ~1.2M images). Don\u2019t worry, the trained model will be waiting for you under output/state by the end.", "For more information and options, e.g. if you need to customize the docker image or to use a local dataset for the training, read the documentation, run ssm shell -h to get the help on the command line parameters, and/or review the introduction blog post.", "Let's take a look at the end of the output logs at ./output1/logs/log0:", "We achieved 46.3 top-1 accuracy and 72.484 top-5 accuracy, with total training time of 26,614 seconds = ~7:23 hours. The total 8 hours of running time is due to an overhead, mostly due to downloading (and extracting) the input data (~150 BG). Roughly 3\u20134 minutes out of it are due to the \u201cstandard SageMaker overhead\u201d \u2014 launching and preparing the instance, downloading the input data and the training image. This can get a bit longer when training on spot instances.", "Going back to the time budget you have, ~8 hours may be too much for you to wait. As explained above, it may even mean in some cases that your brilliant idea isn\u2019t going to see the light of day :(.", "Luckily, the ImageNet example code is well written, and can easily be accelerated by distributing the training on a few instances. Moreover, it\u2019s going to be just a single additional argument!", "That\u2019s it again. Setting the instance count to 3(--ic 3) is all you need to get the same job done in ~3:51 hours!", "Looking on the output logs ./output2/logs/log0 we see that the same accuracy is achieved, for less than half of the training time \u2014 11,605 seconds = ~3:13 hours!", "So, you\u2019ve saved the time, and your brilliant idea is closer to the light of day. But, how can you easily watch and monitor the progress to make the chances even higher?", "First, take a look on the SageMaker training jobs console, and select the 3-nodes job. Here should be able to to get all the available information about it:", "There\u2019s much more information available there, including e.g. links to the state (checkpoints) and output on S3, feel free to explore it.", "The most interesting part for us now is the \u201cMonitor\u201d section where you can get graphs of instance utilization (CPU, RAM, GPU, GPU memory, Disk) and algorithm metrics (more about it in a second).", "Links to the full logs and to a dynamic CloudWatch graph system for the instance and for the algorithm metrics are on the top of that section, and are the way to go for the analysis.", "Here\u2019re the instance metrics from the two training cycles:", "The graphs get updated in real time, and should allow you to make sure everything is going as expected, and whether there\u2019re any crucial bottlenecks that should be taken care of.", "The rule of thumb is to make sure the GPU load is close to 100% most of the time. Taking our 3 nodes example in the graph above, it can be seen that the GPU is only ~70% loaded, which means we may be able to get more from that HW. A good guess may be to have more data loading worker threads, to push data faster toward the GPU.", "To further simplify the monitoring of the training process, we can use SageMaker metrics to get training specific metrics in real time. Again, we just need to update a few more parameters:", "--md is used to define the metrics, where the first argument is the name, e.g. \"loss\" and the second is a regular expression that extracts the numeric value from the output logs.", "Fast forward, here\u2019re the algorithm metrics from the two training cycles:", "The LSVRC2012 ImageNet data can be downloaded from the image-net.org website. The simple steps described by Google here are very helpful.", "As the full dataset is ~1.2M images with a total size of almost 150GB, downloading it locally, then uploading to S3 bucket is going to take a lot of time. In addition, synchronizing that many files from S3 to the training instances before training will be very slow as well. The following strategy is used to overcome these issues:", "The processing task can easily be launched by using the followingssm command:", "Where download.sh is a bash script that downloads and arranges the data to the path it gets on the first argument ($SSM_OUTPUT/data). Once that task is completed, thedata directory with train and val subfolders get placed under the output directory of the task dedicated S3 path [Bucket name]/[Project name]/[Task name]. The training command should now be updated as well:", "A complete pipeline that downloads the data and executes a few training alternatives can be found on the simple-sagemaker repository.", "An easy distributed model training setup is a must-have tool for your data science projects. It\u2019s now at the reach of your hand, simpler and easier than you ever thought. Utilize it!", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Entrepreneur | CS Ph.D. | Cyber-security expert | Data scientist | Past: Head of product security @ MagicLeap, Co-founder & CTO of NorthBit (acq. by MagicLeap)"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F813df77530d8&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsingle-line-distributed-pytorch-training-on-aws-sagemaker-813df77530d8&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsingle-line-distributed-pytorch-training-on-aws-sagemaker-813df77530d8&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsingle-line-distributed-pytorch-training-on-aws-sagemaker-813df77530d8&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsingle-line-distributed-pytorch-training-on-aws-sagemaker-813df77530d8&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----813df77530d8--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----813df77530d8--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@shiftan?source=post_page-----813df77530d8--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@shiftan?source=post_page-----813df77530d8--------------------------------", "anchor_text": "Ariel Shiftan"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F93a8884172bd&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsingle-line-distributed-pytorch-training-on-aws-sagemaker-813df77530d8&user=Ariel+Shiftan&userId=93a8884172bd&source=post_page-93a8884172bd----813df77530d8---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F813df77530d8&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsingle-line-distributed-pytorch-training-on-aws-sagemaker-813df77530d8&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F813df77530d8&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsingle-line-distributed-pytorch-training-on-aws-sagemaker-813df77530d8&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://github.com/shiftan/simple_sagemaker", "anchor_text": "simple-sagemaker"}, {"url": "https://sagemaker.readthedocs.io/en/stable/frameworks/pytorch/using_pytorch.html#distributed-pytorch-training", "anchor_text": "the supported gloo or nccl backends"}, {"url": "https://github.com/shiftan/simple_sagemaker", "anchor_text": "Simple-sagemaker"}, {"url": "https://aws.amazon.com/sagemaker/", "anchor_text": "AWS SageMaker"}, {"url": "https://aws.amazon.com/sagemaker/pricing/", "anchor_text": "any supported instance type"}, {"url": "https://towardsdatascience.com/a-very-simple-and-cheap-way-to-run-your-processing-job-on-the-cloud-c76af579f9e9", "anchor_text": "this blog post"}, {"url": "https://github.com/pytorch/examples/tree/master/imagenet", "anchor_text": "official ImageNet example"}, {"url": "https://github.com/shiftan/simple_sagemaker", "anchor_text": "simple-sagemaker"}, {"url": "https://boto3.amazonaws.com/v1/documentation/api/latest/guide/credentials.html", "anchor_text": "Boto3 docs"}, {"url": "https://raw.githubusercontent.com/pytorch/examples/master/imagenet/main.py", "anchor_text": "main.py"}, {"url": "https://github.com/shiftan/simple_sagemaker#data-maintenance-on-s3", "anchor_text": "A few directories exist under that path"}, {"url": "https://github.com/shiftan/simple_sagemaker#worker-environment", "anchor_text": "here"}, {"url": "https://github.com/shiftan/simple_sagemaker", "anchor_text": "documentation"}, {"url": "https://towardsdatascience.com/a-very-simple-and-cheap-way-to-run-your-processing-job-on-the-cloud-c76af579f9e9", "anchor_text": "blog post"}, {"url": "https://github.com/pytorch/examples/tree/master/imagenet", "anchor_text": "ImageNet example"}, {"url": "https://console.aws.amazon.com/sagemaker/home#/jobs", "anchor_text": "SageMaker training jobs console"}, {"url": "https://docs.aws.amazon.com/sagemaker/latest/dg/training-metrics.html", "anchor_text": "SageMaker metrics"}, {"url": "http://image-net.org/challenges/LSVRC/2012/ilsvrc2012.pdf", "anchor_text": "LSVRC2012 ImageNet"}, {"url": "http://image-net.org/", "anchor_text": "image-net.org"}, {"url": "https://cloud.google.com/tpu/docs/imagenet-setup#download_the_imagenet_dataset", "anchor_text": "here"}, {"url": "https://github.com/shiftan/simple_sagemaker/blob/master/examples/imagenet/run_remote.sh", "anchor_text": "simple-sagemaker repository"}, {"url": "https://medium.com/tag/pytorch?source=post_page-----813df77530d8---------------pytorch-----------------", "anchor_text": "Pytorch"}, {"url": "https://medium.com/tag/distributed-training?source=post_page-----813df77530d8---------------distributed_training-----------------", "anchor_text": "Distributed Training"}, {"url": "https://medium.com/tag/sagemaker?source=post_page-----813df77530d8---------------sagemaker-----------------", "anchor_text": "Sagemaker"}, {"url": "https://medium.com/tag/data-science?source=post_page-----813df77530d8---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----813df77530d8---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F813df77530d8&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsingle-line-distributed-pytorch-training-on-aws-sagemaker-813df77530d8&user=Ariel+Shiftan&userId=93a8884172bd&source=-----813df77530d8---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F813df77530d8&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsingle-line-distributed-pytorch-training-on-aws-sagemaker-813df77530d8&user=Ariel+Shiftan&userId=93a8884172bd&source=-----813df77530d8---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F813df77530d8&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsingle-line-distributed-pytorch-training-on-aws-sagemaker-813df77530d8&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----813df77530d8--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F813df77530d8&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsingle-line-distributed-pytorch-training-on-aws-sagemaker-813df77530d8&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----813df77530d8---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----813df77530d8--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----813df77530d8--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----813df77530d8--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----813df77530d8--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----813df77530d8--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----813df77530d8--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----813df77530d8--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----813df77530d8--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@shiftan?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@shiftan?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Ariel Shiftan"}, {"url": "https://medium.com/@shiftan/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "11 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F93a8884172bd&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsingle-line-distributed-pytorch-training-on-aws-sagemaker-813df77530d8&user=Ariel+Shiftan&userId=93a8884172bd&source=post_page-93a8884172bd--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fusers%2F93a8884172bd%2Flazily-enable-writer-subscription&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsingle-line-distributed-pytorch-training-on-aws-sagemaker-813df77530d8&user=Ariel+Shiftan&userId=93a8884172bd&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}