{"url": "https://towardsdatascience.com/data-analysis-for-cybersecurity-101-detecting-data-exfiltration-ae887594f675", "time": 1683000771.9210858, "path": "towardsdatascience.com/data-analysis-for-cybersecurity-101-detecting-data-exfiltration-ae887594f675/", "webpage": {"metadata": {"title": "Data Analysis for Cyber Security 101: Detecting Data Exfiltration | by Pepe Berba | Towards Data Science", "h1": "Data Analysis for Cyber Security 101: Detecting Data Exfiltration", "description": "This is both a walkthrough of the solution of Wildcard 400 challenge in the recent 2019 Trend Micro CTF, and some notes on network security monitoring. I\u2019d recommend you try out the challenges first\u2026"}, "outgoing_paragraph_urls": [{"url": "https://ctf.trendmicro.com", "anchor_text": "2019 Trend Micro CTF", "paragraph_index": 0}, {"url": "https://www.kaggle.com/hawkcurry/data-analysis-for-network-security-101-questions", "anchor_text": "here", "paragraph_index": 0}, {"url": "https://www.kaggle.com/hawkcurry/data-analysis-for-network-security-101-solution", "anchor_text": "this kernel", "paragraph_index": 0}, {"url": "https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html", "anchor_text": "cyber kill chain", "paragraph_index": 3}, {"url": "https://infosecrockstar.com/prevention-is-ideal-but-detection-is-a-must/", "anchor_text": "Dr. Eric Cole", "paragraph_index": 8}, {"url": "https://attack.mitre.org/resources/enterprise-introduction/", "anchor_text": "ATT&CK matrix", "paragraph_index": 9}, {"url": "https://blogs.akamai.com/2017/09/introduction-to-dns-data-exfiltration.html", "anchor_text": "blog from Akamai", "paragraph_index": 40}, {"url": "http://www.cs.uit.no/~daniels/PingTunnel/", "anchor_text": "ICMP", "paragraph_index": 40}, {"url": "https://towardsdatascience.com/data-analysis-for-cyber-security-101-detecting-lateral-movement-2026216de439", "anchor_text": "lateral movement.", "paragraph_index": 48}, {"url": "https://www.sans.org/course/continuous-monitoring-security-operations", "anchor_text": "SEC511: Continuous Monitoring and Security Operations", "paragraph_index": 50}, {"url": "https://www.pexels.com/@joshsorenson?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels", "anchor_text": "Josh Sorenson", "paragraph_index": 51}, {"url": "https://www.pexels.com/photo/boat-deep-ocean-idyllic-leisure-570987/?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels", "anchor_text": "Pexels", "paragraph_index": 51}, {"url": "https://www.pexels.com/@skitterphoto?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels", "anchor_text": "Skitterphoto", "paragraph_index": 51}, {"url": "https://www.pexels.com/photo/sea-clouds-boat-ship-16513/?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels", "anchor_text": "Pexels", "paragraph_index": 51}], "all_paragraphs": ["This is both a walkthrough of the solution of Wildcard 400 challenge in the recent 2019 Trend Micro CTF, and some notes on network security monitoring. I\u2019d recommend you try out the challenges first here. All implementation of the solutions can be found this kernel.", "You are a network security administrator for the medium sized business XYZcorp. You often use network flow data to uncover anomalous security events. This challenge provides some sample aggregated data on flows, and uses answers from the anomalous events to construct the flag.", "Data here is synthetic and does not model typical network protocols and behaviour. So deep knowledge of network protocols is not needed for these challenges.", "All of the questions in this challenge are related to post-exploitation activities, which makes up the latter half of the cyber kill chain.", "<Insert obligatory kill-chain diagram and spiel>", "Modern approaches to cybersecurity do not stop in just trying to prevent exploitation. Exploitation is only the first step of the attack, and the end goal is typically* data theft.", "*Except for attacks such as ransomware attacks", "If we are able to detect and stop the attacker at any of these stages, then we can consider that as a win!", "\u201cPrevention is ideal, but detection is a must\u201d \u2014 Dr. Eric Cole", "Of course, this is a simplified version of a more complex chain of events. If you want to read up more on this you can look through the ATT&CK matrix", "Data exfiltration is a fancy way of saying data theft. At one point, the data has to flow from within your network to the hands of the attacker*.", "*There are exceptions of course, such as exfiltrating the data physically", "Our intellectual property is leaving the building in large chunks. A machine inside is being used to send out all of our widget designs. One host is sending out much more data from the enterprise than the others. What is its IP?", "Here we might assume that the attacker is not trying to hide. They try to transfer as much data as they can, without setting a limit to their data transfer. Let\u2019s look at the hosts with the most outbound network traffic.", "We identify 13.37.84.125 as the bad IP, and looking at the distribution of the outbound of the traffic and see that this is atypical.", "This is the simplest alert you can make. Look at the daily distributions of your outbound traffic, and find a threshold to alert on. It would be embarrassing to discover a data breach 3 days after an attacker uploaded 50GB to Google Drive within an\u00a0hour.", "You might find outliers that are normal! Being an outlier is not necessarily synonymous with being malicious. You can find hosts that have extremely large outbound traffic compared to the rest of your network, only to discover that they are normal.", "Let\u2019s say your company uses a web proxy server, and requires HTTPS traffic to be proxied through this server. Then we would expect that this proxy server to have traffic several magnitudes larger than the rest of the network. The traffic we observe from it is the combined HTTPS traffic of hundreds of users.", "In such a case, you should document these special servers, and analyse these separately. And while you\u2019re at it, you might also want to check on the desktops that make or attempt to make direct outbound HTTPS traffic even if they do not consume high bandwidth, because they should pass through the proxy.", "Another attacker has a job scheduled that export the contents of our internal wiki. One host is sending out much more data during off hours from the enterprise than the others. What is its IP?", "Typically, we should have some notion of business hours and off hours. For this challenge, we first have to infer what hours are business", "Now that we have identified the business hours of the company, we filter our view only for traffic generated between 0:00 and 16:00 and see the hosts with the most outbound traffic during off-hours.", "This time, we see that 12.55.77.96 might be our bad IP. We look at the distribution of the total outbound traffic size during off hours, and we also see that this is an outlier.", "Looking only at off hour traffic is important because this might not be something that we would detect if we only looked at overall outbound traffic.", "It becomes apparent here that we should model \u201con\u201d and \u201coff\u201d times separately. This is quite intuitive, the type of activities you expect to see during the day is different from those at night. This includes weekends and special holidays.", "These off periods are also a good starting point for your baseline. You get an idea of the \u201cbackground radiation\u201d of your network.", "Bad traffic that typically blends in during business hours, might stick out during off hours.", "You might also find insider threats. \u201cRemotely accesses the network while on vacation, sick or at odd times\u201d, and \u201cWorks odd hours without authorization\u201d are behavioural indicator of insider threats [1]. People are more sensitive to physical surveillance; they are more likely to try to do bad stuff when no one is around without realising that their actions are obvious at the network level.", "Off-time is valuable. If I want to identify dial-homes, file exfiltration, and other suspicious activity, I like to do so by watching off-hours. There\u2019s less traffic, there are fewer people\u2026 This is the reason I like to keep track of a company\u2019s own special off-times. It\u2019s easy enough for someone to hide his traffic by keeping all activity in 9\u20135/M\u2013F, but if the attacker doesn\u2019t know the company gives St. Swithin\u2019s Day off, then he\u2019s more likely to stick out.", "Although, if you go hunting, what you will find here are a lot of legitimate (maybe undocumented) business processes such as those that try to offload during the night to have minimal impact on business during the day. For example, you may discover that the database team has scheduled a weekly backup of your databases to your Amazon S3 bucket every 12 midnight. These are definitely things you should be able to detect.", "Some assailant is grabbing all the employee and vendor email addresses, and sending them out on a channel normally reserved for other uses. This is similar to attackers abusing DNS for data exfiltration. One host is sending out much more data on a some port from the enterprise than other hosts do. What is its port?", "DNS tunneling is a technique used to exfiltrate data through features of the DNS protocol. If a host tries to exfiltrate data through DNS then we expect the number of requests to port 53 to be much larger than the other hosts which only use DNS to resolve the IP addresses of domains. So what we are looking for is traffic that is abnormal for that particular port.", "We can actually use a similar approach to the previous sections, by looking at the top sources of traffic and seeing if they are outliers based on the port\u2019s univariate distribution. However, this doesn\u2019t scale well when you now have to look through many ports.", "Let\u2019s first look at several ports and we see that most of them are \u201cnice\u201d (maybe too nice), but have different means and variance.", "After looking some of the distributions, they look bell-shaped so using the Z-score might be appropriate. However, if you find that the distributions are highly skewed, then you might want to do transformations such as the log transformation, to make the distribution more bell-shaped.", "For each port, we standardize the outbound traffic and get the top z-score for each port.", "And if we look at the total outbound traffic for port 124 compared to other ports, we see that this is not something we can detect if we used a global threshold.", "So how do we detect this? Similar to the previous section, there is a recurring theme: model different types of network activities separately. If you can identify distinct groups in the network traffic, then try to analyse them separately. It is easier to detect outliers if your data is identically distributed.", "Also, we should also consider analyzing the long tail. If you see outbound traffic to ports that are not commonly used, then you should investigate what it is. Document it if it has legitimate use. Otherwise, you shouldn\u2019t have allowed outbound connections to unknown ports in the first place.", "However, for protocols such as DNS traffic, they are essential. So you\u2019d find these ports are open outbound. Similar to a web proxy, to make our lives easier, you should require all DNS queries to go through an internal DNS server, and block all outbound traffic on port 53 except for your internal DNS server. With logs from your DNS server, you get a wealth of information that makes detecting techniques like DNS tunneling easier. You do not have to limit your alerts on just frequency and connection sizes, since you can use the number of unique subdomains or the number of unique domains queried.", "If you want to read more about DNS tunnelling you can read this blog from Akamai. Another similar and interesting way to tunnel is through ICMP.", "It\u2019s a little bit funny to think that by the time you detect data exfiltration in outbound network traffic, it may already too late! For us to detect high outbound traffic, the attacker has to have already stolen a lot of data first.", "To mitigate this, you have to think about the data you actually care about:", "Let\u2019s say an attacker wants to exfiltrate 50GB of data from your SQL data base. He would first have to dump the tables of your SQL server to his host, and then upload these to some external cloud storage.", "You could have detected the attacker even before he can exfiltrate the data if you were able to alert on either:", "For example, you look at what your SQL server typically does, and find out that the bulk of the SQL server\u2019s traffic would typically with the web application server, some ETL processes and maybe some backup processes. Then high data transfer from SQL server to a SQL admin workstation may be considered abnormal.", "Rather than monitoring all the traffic in your network to find \u201canything weird\u201d, with a bit of analysis, you might be able to concentrate on a few components of your network.", "Reducing the scope of some of your alerts to some key users or systems makes your models more efficient and you are able to detect subtler high-impact attacks.", "In the next blog post, we will go through some of the questions on finding lateral movement.", "The initial host that the attacker controls may not have access to the data that the attacker wants. The attacker then has to explore and navigate through the network, through different hosts and accounts until he reaches the final objective. This might be something we can detect given the right vantage points", "[3] SEC511: Continuous Monitoring and Security Operations", "Photos: Josh Sorenson from Pexels, Skitterphoto from Pexels", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Stats, security, and cryptography | Cloud Security | GMON, CCSK | Masters student in data science"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fae887594f675&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-analysis-for-cybersecurity-101-detecting-data-exfiltration-ae887594f675&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-analysis-for-cybersecurity-101-detecting-data-exfiltration-ae887594f675&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-analysis-for-cybersecurity-101-detecting-data-exfiltration-ae887594f675&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-analysis-for-cybersecurity-101-detecting-data-exfiltration-ae887594f675&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----ae887594f675--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----ae887594f675--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@pberba?source=post_page-----ae887594f675--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@pberba?source=post_page-----ae887594f675--------------------------------", "anchor_text": "Pepe Berba"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fdc355a36c19a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-analysis-for-cybersecurity-101-detecting-data-exfiltration-ae887594f675&user=Pepe+Berba&userId=dc355a36c19a&source=post_page-dc355a36c19a----ae887594f675---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fae887594f675&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-analysis-for-cybersecurity-101-detecting-data-exfiltration-ae887594f675&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fae887594f675&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-analysis-for-cybersecurity-101-detecting-data-exfiltration-ae887594f675&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://www.pexels.com/@padrinan?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels", "anchor_text": "Miguel \u00c1. Padri\u00f1\u00e1n"}, {"url": "https://www.pexels.com/photo/paper-boats-on-solid-surface-194094/?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels", "anchor_text": "Pexels"}, {"url": "https://ctf.trendmicro.com", "anchor_text": "2019 Trend Micro CTF"}, {"url": "https://www.kaggle.com/hawkcurry/data-analysis-for-network-security-101-questions", "anchor_text": "here"}, {"url": "https://www.kaggle.com/hawkcurry/data-analysis-for-network-security-101-solution", "anchor_text": "this kernel"}, {"url": "https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html", "anchor_text": "cyber kill chain"}, {"url": "https://infosecrockstar.com/prevention-is-ideal-but-detection-is-a-must/", "anchor_text": "Dr. Eric Cole"}, {"url": "https://attack.mitre.org/resources/enterprise-introduction/", "anchor_text": "ATT&CK matrix"}, {"url": "https://blogs.akamai.com/2017/09/introduction-to-dns-data-exfiltration.html", "anchor_text": "blog from Akamai"}, {"url": "http://www.cs.uit.no/~daniels/PingTunnel/", "anchor_text": "ICMP"}, {"url": "https://towardsdatascience.com/data-analysis-for-cyber-security-101-detecting-lateral-movement-2026216de439", "anchor_text": "lateral movement."}, {"url": "https://www.us-cert.gov/sites/default/files/publications/Combating%20the%20Insider%20Threat_0.pdf", "anchor_text": "Combating the Insider Threat"}, {"url": "https://www.sans.org/course/continuous-monitoring-security-operations", "anchor_text": "SEC511: Continuous Monitoring and Security Operations"}, {"url": "https://www.pexels.com/@joshsorenson?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels", "anchor_text": "Josh Sorenson"}, {"url": "https://www.pexels.com/photo/boat-deep-ocean-idyllic-leisure-570987/?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels", "anchor_text": "Pexels"}, {"url": "https://www.pexels.com/@skitterphoto?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels", "anchor_text": "Skitterphoto"}, {"url": "https://www.pexels.com/photo/sea-clouds-boat-ship-16513/?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels", "anchor_text": "Pexels"}, {"url": "https://medium.com/tag/cybersecurity?source=post_page-----ae887594f675---------------cybersecurity-----------------", "anchor_text": "Cybersecurity"}, {"url": "https://medium.com/tag/data-analysis?source=post_page-----ae887594f675---------------data_analysis-----------------", "anchor_text": "Data Analysis"}, {"url": "https://medium.com/tag/network-security?source=post_page-----ae887594f675---------------network_security-----------------", "anchor_text": "Network Security"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fae887594f675&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-analysis-for-cybersecurity-101-detecting-data-exfiltration-ae887594f675&user=Pepe+Berba&userId=dc355a36c19a&source=-----ae887594f675---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fae887594f675&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-analysis-for-cybersecurity-101-detecting-data-exfiltration-ae887594f675&user=Pepe+Berba&userId=dc355a36c19a&source=-----ae887594f675---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fae887594f675&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-analysis-for-cybersecurity-101-detecting-data-exfiltration-ae887594f675&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----ae887594f675--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fae887594f675&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-analysis-for-cybersecurity-101-detecting-data-exfiltration-ae887594f675&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----ae887594f675---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----ae887594f675--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----ae887594f675--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----ae887594f675--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----ae887594f675--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----ae887594f675--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----ae887594f675--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----ae887594f675--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----ae887594f675--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@pberba?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@pberba?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Pepe Berba"}, {"url": "https://medium.com/@pberba/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "294 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fdc355a36c19a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-analysis-for-cybersecurity-101-detecting-data-exfiltration-ae887594f675&user=Pepe+Berba&userId=dc355a36c19a&source=post_page-dc355a36c19a--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fd712a5263bbc&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-analysis-for-cybersecurity-101-detecting-data-exfiltration-ae887594f675&newsletterV3=dc355a36c19a&newsletterV3Id=d712a5263bbc&user=Pepe+Berba&userId=dc355a36c19a&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}