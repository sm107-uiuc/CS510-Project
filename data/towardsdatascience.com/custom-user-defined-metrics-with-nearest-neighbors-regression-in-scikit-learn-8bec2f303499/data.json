{"url": "https://towardsdatascience.com/custom-user-defined-metrics-with-nearest-neighbors-regression-in-scikit-learn-8bec2f303499", "time": 1683012842.8537521, "path": "towardsdatascience.com/custom-user-defined-metrics-with-nearest-neighbors-regression-in-scikit-learn-8bec2f303499/", "webpage": {"metadata": {"title": "Custom user-defined metrics with nearest neighbors regression in scikit-learn | by Marcos del Cueto | Towards Data Science", "h1": "Custom user-defined metrics with nearest neighbors regression in scikit-learn", "description": "Tutorial on user-defined metrics for kNN regression in scikit-learn. Introduction to kNN regression, implementation of custom metrics. Example and analysis"}, "outgoing_paragraph_urls": [{"url": "https://scikit-learn.org/stable/", "anchor_text": "scikit-learn", "paragraph_index": 0}, {"url": "https://towardsdatascience.com/a-brief-tour-of-scikit-learn-sklearn-6e829a9db2fd", "anchor_text": "Sadrach Pierre", "paragraph_index": 0}, {"url": "https://scikit-learn.org/stable/modules/generated/sklearn.neighbors.KNeighborsRegressor.html", "anchor_text": "k-nearest neighbors", "paragraph_index": 1}, {"url": "https://github.com/marcosdelcueto/Tutorial_kNN_custom_metric", "anchor_text": "Github repository", "paragraph_index": 2}, {"url": "https://www.mdelcueto.com/blog/example-nearest-neighbors-regression/", "anchor_text": "blog post", "paragraph_index": 4}, {"url": "http://www.astropixels.com/ephemeris/perap2001.html", "anchor_text": "2019", "paragraph_index": 6}, {"url": "https://www.climate.gov/maps-data/dataset/daily-temperature-and-precipitation-reports-data-tables", "anchor_text": "NOAA climate.gov", "paragraph_index": 9}, {"url": "https://github.com/marcosdelcueto/Tutorial_kNN_custom_metric", "anchor_text": "Github repository", "paragraph_index": 10}, {"url": "https://scikit-learn.org/stable/modules/generated/sklearn.neighbors.DistanceMetric.html", "anchor_text": "distance metrics", "paragraph_index": 11}, {"url": "https://github.com/marcosdelcueto/Tutorial_kNN_custom_metric", "anchor_text": "Github repository", "paragraph_index": 25}, {"url": "https://www.mdelcueto.com", "anchor_text": "https://www.mdelcueto.com", "paragraph_index": 28}], "all_paragraphs": ["The number of data science tools available to the general public has increased dramatically over the last years. One such tool is the Python library scikit-learn (often referred to as sklearn). For a recent introductory overview of scikit-learn, you can take a look at recent post by Sadrach Pierre.", "In this post, I will be dealing with k-nearest neighbors (kNN) regression. Specifically, we will see how to use user-defined metrics. This area receives a surprisingly low amount of attention. I will present a simple example in which it would be beneficial to implement our own distance metric. We will see how to do this implementation in detail and comment on the advantages of this approach.", "Anyone with a basic Python knowledge could follow this tutorial, and complete codes are given as a reference. All data, codes, and images used in the tutorial are provided at this Github repository. This tutorial is divided into different sections:", "When trying to predict a new point\u2019s target property (y), kNN performs a weighted average of the target property values of near neighbors to calculate the y value at the new point. Usually, one can increase the prediction accuracy by considering that the closest near neighbors have a more significant influence. This is done by weighting all k-nearest neighbors with a weight that is inversely proportional to their distance. In scikit-learn, we can do this by simply selecting the option weights= \u2018distance\u2019 in the kNN regressor. This means that closer points (smaller distance) will have a larger weight in the prediction. Formally, the target property\u2019s value at a new point n, with k nearest neighbors, is calculated as:", "For a more detailed explanation of kNN regression, as well as the effect of weights functions, feel free to refer to my recent blog post about these topics.", "As an example of why one would be interested in defining a custom metric, we work with a simple dataset that contains the average temperatures of a weather station in Canada for each day of 2019. Our dataset is formed simply by one descriptor (day of the year) and one target property (average daily temperature at the weather station).", "In 2019, the farthest distance between the Earth and the Sun (aphelion) was 1.521\u00d710\u2078 km, and the closest distance (perihelion) was 1.471\u00d710\u2078 km. These two values are very similar (~3% difference), so for simplicity, we assume here that Earth\u2019s orbit is circular. This approximation can be visualized in the Figure below, where the actual orbit around the Sun is shown in orange, and the circular approximated orbit is shown in white.", "During one year, the Earth completes a whole turn around the Sun. Thus, the distance between two dates of the year can be calculated as the distance that the Earth traveled along its orbit during that time. The distance of two points along the orbit will not be the same as the direct Euclidean distance that we might naively calculate initially.", "In the Figure below, we show the relative distances of two points B and C with respect to an initial point A. For example, when we calculate the ratio of the A-B and A-C distances directly using a Euclidean metric (in red), we obtain approximately 0.7, which means that the A-B distance is around 70% that of A-C. However, if we consider the distances calculated along the circumference (in green), we obtain that the A-B distance is 50% that of A-C. We can easily observe how this last metric is the one that would correctly describe our problem: the distance between January and April is 50% of the distance between January and July.", "We take temperature data from NOAA climate.gov. We focus on data for 2019 at the station at Swan River, Manitoba, Canada (station CA00504K80K).", "Raw data is formed by Date (YYYYMMDD) and T (tenths of Celsius). We transform that data to Day (from 1 to 365) and T (Celsius). We provide data with these four columns, although only the last two columns are used in the code, for 364 days of 2019 (data for 30th July is missing). Below we show how this data looks, and the complete dataset is provided at this Github repository.", "In scikit-learn, k-NN regression uses Euclidean distances by default, although there are a few more distance metrics available, such as Manhattan and Chebyshev. In addition, we can use the keyword metric to use a user-defined function, which reads two arrays, X1 and X2, containing the two points\u2019 coordinates whose distance we want to calculate.", "Below, we show a simple code with the function mimic_minkowski, such that using metric=mimic_minkowski would produce precisely the same results than using the default minkowski (Euclidean) metric with metric=\u2019minkowski\u2019.", "Since we want to study the distances of points on a circumference, using polar coordinates is exceptionally convenient. We show below what the resulting distance equation is.", "Note that our function will be used to calculate relative differences between distances, so we can simplify the above equation to:", "In our dataset, we have the date of each day, so we can easily transform the day difference to the angle difference (\u03b8\u2081-\u03b8\u2082). Assuming that Earth\u2019s orbit is circular and it moves at a constant speed, we can turn the difference between two days of the year, Day\u2081 and Day\u2082, to an angle difference, as shown below.", "Finally, we can create our custom_metric function as shown below.", "A simple method to select the optimum number of k nearest neighbors to make accurate predictions is to use a grid search. A grid search involves trying different k values and finally choosing the one that minimizes the prediction error.", "As with any machine learning model, one is faced with the task of selecting data that will be used to train the model and data that will be used to test the model accuracy.", "Since we have a relatively small amount of low-dimensional data, we will use the leave-one-out cross-validation (for more complex datasets, one may opt for a k-fold cross-validation). To use a leave-one-out cross-validation with a dataset with N samples, one trains the machine learning model with N-1 points, and uses the remaining point as a test. This is repeated N times, so each point is used exactly once as a test. A schematic view of this cross-validation is shown below.", "As a result, one ends with a predicted value for each point. Then, the predicted value of each point is compared with its actual value. As an error metric, we have used the root mean square error (rmse). Finally, we can compare the (rmse) obtained for different k values, and we select as an optimum k value the one that minimizes the rmse. The complete code, including this grid search, is shown below.", "Using this code, we obtain that the minimum rmse is obtained with k=2, resulting in rmse=2.725 \u00b0C. This means that we could estimate the average daily temperature of any day in 2019, with just the knowledge of the daily average temperature for the rest of the year, with an average error or 2.725\u00b0C.", "We can reasonably ask what the gain of using this new metric was. If we change to metric= \u2018minkowski\u2019 at line 39 of the code above, we obtain that the number of optimum neighbors is k=2, with an average error of rmse=2.740 \u00b0C. Since we use a very simple example, with just one descriptor, the improvement of using a more reasonable metric is small: approximately 0.5%.", "However, one should always make sure that a sensible metric is used. Besides, that 0.5% error might be critical for your problem. In addition, the improvement of adopting an appropriate metric will likely increase as the dataset increases in complexity.", "We have covered the basics of a k-nearest neighbors regression and how to apply it to a simple dataset. We have also seen how to implement custom metric functions defined by the user, and how the use of the correct metric may improve your prediction accuracy.", "Remember that the dataset presented here, code, images, etc. are provided in this Github repository.", "Was this tutorial helpful to you? Let me know if you were able to successfully implement your own distance metric!", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Senior data scientist in ad-tech ~ PhD in Computational Modelling ~ https://www.mdelcueto.com ~ @marcosdelcueto"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F8bec2f303499&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-user-defined-metrics-with-nearest-neighbors-regression-in-scikit-learn-8bec2f303499&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-user-defined-metrics-with-nearest-neighbors-regression-in-scikit-learn-8bec2f303499&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-user-defined-metrics-with-nearest-neighbors-regression-in-scikit-learn-8bec2f303499&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-user-defined-metrics-with-nearest-neighbors-regression-in-scikit-learn-8bec2f303499&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----8bec2f303499--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----8bec2f303499--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@delcueto.marcos?source=post_page-----8bec2f303499--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@delcueto.marcos?source=post_page-----8bec2f303499--------------------------------", "anchor_text": "Marcos del Cueto"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F1e4964370d8&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-user-defined-metrics-with-nearest-neighbors-regression-in-scikit-learn-8bec2f303499&user=Marcos+del+Cueto&userId=1e4964370d8&source=post_page-1e4964370d8----8bec2f303499---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F8bec2f303499&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-user-defined-metrics-with-nearest-neighbors-regression-in-scikit-learn-8bec2f303499&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F8bec2f303499&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-user-defined-metrics-with-nearest-neighbors-regression-in-scikit-learn-8bec2f303499&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@adolfofelix?utm_source=medium&utm_medium=referral", "anchor_text": "Adolfo F\u00e9lix"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://scikit-learn.org/stable/", "anchor_text": "scikit-learn"}, {"url": "https://towardsdatascience.com/a-brief-tour-of-scikit-learn-sklearn-6e829a9db2fd", "anchor_text": "Sadrach Pierre"}, {"url": "https://scikit-learn.org/stable/modules/generated/sklearn.neighbors.KNeighborsRegressor.html", "anchor_text": "k-nearest neighbors"}, {"url": "https://github.com/marcosdelcueto/Tutorial_kNN_custom_metric", "anchor_text": "Github repository"}, {"url": "https://www.mdelcueto.com/blog/example-nearest-neighbors-regression/", "anchor_text": "blog post"}, {"url": "http://www.astropixels.com/ephemeris/perap2001.html", "anchor_text": "2019"}, {"url": "https://de.wikipedia.org/wiki/Benutzer:Sch", "anchor_text": "Sch"}, {"url": "https://commons.wikimedia.org/wiki/File:EarthsOrbit_en.png", "anchor_text": "Wikimedia Commons"}, {"url": "https://creativecommons.org/licenses/by-sa/3.0/deed.en", "anchor_text": "CC BY-SA 3.0"}, {"url": "https://www.climate.gov/maps-data/dataset/daily-temperature-and-precipitation-reports-data-tables", "anchor_text": "NOAA climate.gov"}, {"url": "https://github.com/marcosdelcueto/Tutorial_kNN_custom_metric", "anchor_text": "Github repository"}, {"url": "https://scikit-learn.org/stable/modules/generated/sklearn.neighbors.DistanceMetric.html", "anchor_text": "distance metrics"}, {"url": "https://github.com/marcosdelcueto/Tutorial_kNN_custom_metric", "anchor_text": "Github repository"}, {"url": "https://medium.com/tag/metrics?source=post_page-----8bec2f303499---------------metrics-----------------", "anchor_text": "Metrics"}, {"url": "https://medium.com/tag/scikit-learn?source=post_page-----8bec2f303499---------------scikit_learn-----------------", "anchor_text": "Scikit Learn"}, {"url": "https://medium.com/tag/knn?source=post_page-----8bec2f303499---------------knn-----------------", "anchor_text": "Knn"}, {"url": "https://medium.com/tag/regression?source=post_page-----8bec2f303499---------------regression-----------------", "anchor_text": "Regression"}, {"url": "https://medium.com/tag/tutorial?source=post_page-----8bec2f303499---------------tutorial-----------------", "anchor_text": "Tutorial"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F8bec2f303499&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-user-defined-metrics-with-nearest-neighbors-regression-in-scikit-learn-8bec2f303499&user=Marcos+del+Cueto&userId=1e4964370d8&source=-----8bec2f303499---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F8bec2f303499&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-user-defined-metrics-with-nearest-neighbors-regression-in-scikit-learn-8bec2f303499&user=Marcos+del+Cueto&userId=1e4964370d8&source=-----8bec2f303499---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F8bec2f303499&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-user-defined-metrics-with-nearest-neighbors-regression-in-scikit-learn-8bec2f303499&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----8bec2f303499--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F8bec2f303499&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-user-defined-metrics-with-nearest-neighbors-regression-in-scikit-learn-8bec2f303499&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----8bec2f303499---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----8bec2f303499--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----8bec2f303499--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----8bec2f303499--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----8bec2f303499--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----8bec2f303499--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----8bec2f303499--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----8bec2f303499--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----8bec2f303499--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@delcueto.marcos?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@delcueto.marcos?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Marcos del Cueto"}, {"url": "https://medium.com/@delcueto.marcos/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "25 Followers"}, {"url": "https://www.mdelcueto.com", "anchor_text": "https://www.mdelcueto.com"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F1e4964370d8&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-user-defined-metrics-with-nearest-neighbors-regression-in-scikit-learn-8bec2f303499&user=Marcos+del+Cueto&userId=1e4964370d8&source=post_page-1e4964370d8--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fusers%2F1e4964370d8%2Flazily-enable-writer-subscription&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-user-defined-metrics-with-nearest-neighbors-regression-in-scikit-learn-8bec2f303499&user=Marcos+del+Cueto&userId=1e4964370d8&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}