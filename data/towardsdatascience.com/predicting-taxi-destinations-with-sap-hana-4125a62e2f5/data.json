{"url": "https://towardsdatascience.com/predicting-taxi-destinations-with-sap-hana-4125a62e2f5", "time": 1683011051.393188, "path": "towardsdatascience.com/predicting-taxi-destinations-with-sap-hana-4125a62e2f5/", "webpage": {"metadata": {"title": "Predicting Taxi Destinations with SAP HANA | by Mathias Kemeter | Towards Data Science", "h1": "Predicting Taxi Destinations with SAP HANA", "description": "In my recent story I used the SAP HANA Spatial Engine and the SAP HANA Automated Predictive Library to predict how long a taxi ride in the city of Porto is going to take based on historical ride\u2026"}, "outgoing_paragraph_urls": [{"url": "https://towardsdatascience.com/spatial-data-science-powered-by-sap-hana-9d1153afa577", "anchor_text": "recent story", "paragraph_index": 0}, {"url": "https://github.com/mkemeter/public/blob/master/TaxiTrajectories.ipynb#", "anchor_text": "can be reviewed on GitHub", "paragraph_index": 2}, {"url": "https://towardsdatascience.com/spatial-data-science-powered-by-sap-hana-9d1153afa577", "anchor_text": "previous blog", "paragraph_index": 3}, {"url": "https://en.wikipedia.org/wiki/Multiclass_classification", "anchor_text": "multiclass classification problem", "paragraph_index": 4}, {"url": "https://help.sap.com/doc/0172e3957b5946da85d3fde85ee8f33d/2.0.040/en-US/html/hana_ml.algorithms.apl.html#apl-gb-classification-label", "anchor_text": "GradientBoostingClassifier", "paragraph_index": 4}, {"url": "https://help.sap.com/viewer/7c78579ce9b14a669c1f3295b0d8ca16/Cloud/en-US/abf3dd7576464c30a7897a05d1ef8cb2.html", "anchor_text": "RANDOM_PARTITION", "paragraph_index": 13}, {"url": "https://blogs.sap.com/2020/02/08/spatial-data-science-powered-by-sap-hana/", "anchor_text": "and my recent", "paragraph_index": 39}, {"url": "https://help.sap.com/doc/0172e3957b5946da85d3fde85ee8f33d/2.0.040/en-US/html/index.html", "anchor_text": "hana_ml Python Client", "paragraph_index": 39}, {"url": "https://blogs.sap.com/2020/03/25/predicting-taxi-destinations-with-sap-hana/", "anchor_text": "https://blogs.sap.com", "paragraph_index": 40}, {"url": "https://linkedin.com/in/mathiaskemeter", "anchor_text": "LinkedIn", "paragraph_index": 40}, {"url": "https://twitter.com/math1ask", "anchor_text": "Twitter", "paragraph_index": 40}, {"url": "https://about.me/mkemeter", "anchor_text": "https://about.me/mkemeter", "paragraph_index": 42}], "all_paragraphs": ["In my recent story I used the SAP HANA Spatial Engine and the SAP HANA Automated Predictive Library to predict how long a taxi ride in the city of Porto is going to take based on historical ride data. Technically I leveraged Jupyter Notebooks as well as the free SAP HANA Express Edition to push down all operations (Geospatial + Machine Learning) to the database level instead of moving the data (and the calculations) to the client.", "Today, I would like to go one step further and even predict the destination of a taxi based on the starting point, time of day and the first few points of the trajectory. In a real-life scenario such a model could support taxi operations by enabling backoffice operators to anticipate the number of available taxis within a certain area even before those taxis arrive.", "The full Jupyter Notebook can be reviewed on GitHub.", "Let\u2019s start with the code \u2014 I will not go into details of uploading data and the concept behind the hexagonal reference grid as this has been discussed in the previous blog. Just a short recap: Instead of predicting outcomes based on exact coordinates, we will predict the taxi destination base on the area (i.e. hexagonal cell) where the taxi is departing.", "When looking at hexagonal cells also for destination areas of the taxi we eventually deal with a multiclass classification problem, where each hexagonal cell (i.e. its ID value) is one target class. HANA\u2019s Automated Predictive Library offers a GradientBoostingClassifier, which is capable of doing multiclass classifications.", "However, there is one limitation of the GradientBoostingClassifier that we have to deal with: It supports a maximum of 100 target classes. We can easily spot, that our reference grid contains more than 1300 potential target areas.", "So, how do we handle this? Taxis are often going to the same areas. In our preceding analysis we already identified the hotspots of Porto in terms of taxi pickups and dropoffs. And we have seen that there are many areas with just a very low number of trips arriving or departing.", "What would be the impact of only predicting the top 100 destinations? We can check which percentage of our overall trips are arriving in the top 100 cells with the following nested statement:", "As a result, we see that less than 10% of the trips are arriving in other locations. This means a model predicting the top 100 destinations would be applicable for more than 90% of the trips. For the remainder of 10% we would, of course, always predict an incorrect destination. But since these are rare destinations the prediction probably would have been hard anyway.", "Ok, so we are going to predict the 100 most frequent destination areas.", "To make the prediction more interesting we will furthermore incorporate the first 10 coordinates of the taxi trajectory. This can give us an idea of which direction the taxi is heading to. For the operator in our real-world scenario this would still be a sufficient heads-up for trips, which are not ultra-short.", "Based on the first 10 coordinates of the trip, we would like to add the following features to our training dataset:", "To add those features to our dataset, we can issue the following statement, which also categorizes the compass direction based on the above calculated value.", "Well, let\u2019s construct a dataset with 75000 sample trajectories divided into training dataset (80%) and test dataset (20%). To do this we will use the HANA built-in window function RANDOM_PARTITION. The second part of the nested SQL statement we have already seen earlier when selecting the top 100 destinations.", "The double use of randomization may seem confusing first. We use \u201corder by rand()\u201d in combination with \u201ctop 75000\u201d to randomly pick 75000 samples. These samples we then randomly divide into training and test datasets by using \u201crandom_partition()\u201d.", "The resulting dataset looks like the following, where END_HEXID is the target variable of our model and SET_NUM determines if the record belongs to the training dataset (SET_NUM = 1) or the test dataset (SET_NUM = 3).", "Finally, we are ready to train our gradient boosting model. On my laptop with HANA Express the training lasts a couple of minutes. So take your time and grab a coffee\u2026.. or espresso, better grab an espresso.", "When using the hana_ml client for Python, the model training will be triggered from within Python. However all calculations are pushed down to the database in the background and data does not get transferred to the client.", "After having our espresso with a load of sugar we observe the contributing features for our classification model.", "The three most important influencing factors for determining the destination of a taxi are:", "This makes sense \u2014 especially the influence of the daytime is expected as trips at around 8pm are probably more likely to end in a bar or restaurant and trips after midnight are more likely to end in suburbs, where people are living.", "Of course, we can retrieve statistical measures for our model from APL by issuing:", "However, this time we want to evaluate the model slightly different. Since we clustered our locations by hexagons we may have some \u201cnear-misses\u201d at the edge of the hexagons. The above performance measurements only reflect if we predicted the exact correct target hexagon and it does not include geospatial proximity measures.", "To have some data to work with, we will do predictions based on our test dataset of 15000 records.", "For each predicted record we now have the correct target hexagon as well as the id of the predicted target hexagon. To evaluate geospatial proximity we need to join the geometry data from our reference grid back to the result table.", "The resulting dataframe looks like the following, where TRUE_CENTROID and PREDICTED_CENTROID are the centroid points of the respective hexagonal cells/areas. We can see, that APL even added a probability field to the output with which we can determine how likely the predicted location is according to the model.", "Based on that, we can calculate the average distance between the predicted and the true centroids.", "So on average we are predicting within a range of 2.6 km. To set this into relation we need to know the diameter of our hexagonal cells.", "This means due to our spatial binning we can anyhow only do predictions within a range of 1 km. So how many of our predictions are either in the correct target cell or in one of its neighbouring cells? Based on the diameter, we can query the centroids which are in a 1.1km range.", "We can see, that based on this measurement we predict one third (33.9% in my case) of the trips correctly.", "That sounds good, but we should compare this result to a proper baseline. What would happen, if we simply always predict the hexagonal cell with most overall taxi activity? If we only have one guess, this one would probably be good.", "We can determine the most frequently visited cell and do the \u2018prediction\u2019 as follows.", "So, how does our model compare against this \u2018majority vote\u2019 as a baseline?", "With our model we are still 10% better than with the baseline. Our model predicted (in my case) 5085 out of 15000 trips correctly, whereas the baseline majority vote predicted only 3568 out of 15000 trips correctly.", "Finally, we can configure the APL to also output the probabilities of all other hexagonal clusters, which have not been predicted as a destination.", "This data we can use to visualize one scenario:", "Looking at the probability distribution we can tell that the center of the city is a likely destination in any case (independent of time and direction). However for the westwards-variant we do not see any high probabilities in the eastern part of the city and the probability that the trip goes to the airport is significantly higher. For the trip heading northeast we see a higher probability for destinations in the northeast as well as a lower probability for the airport and destinations at the seaside.", "As a by-catch we can also nicely see in the visualization, that our top 100 destination areas essentially cover the urban core of Porto.", "In all honesty I am not sure if this makes a business case to sell the solution to taxi operators. But still this is a fun example to show how to get the geospatial dimension into your machine learning models!", "We have seen in this (and my recent) blog post, how to seamlessly incorporate geospatial data into a simple machine learning model. We used SAP HANA as unified platform to handle spatial data and train our model. Furthermore, we have used the hana_ml Python Client to make all functionalities accessible from within our Jupyter Notebook.", "Originally published at https://blogs.sap.com. Follow the author on LinkedIn or Twitter.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Spatial, Data Science and other math stuff @SAP @math1ask https://about.me/mkemeter"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F4125a62e2f5&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-taxi-destinations-with-sap-hana-4125a62e2f5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-taxi-destinations-with-sap-hana-4125a62e2f5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-taxi-destinations-with-sap-hana-4125a62e2f5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-taxi-destinations-with-sap-hana-4125a62e2f5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----4125a62e2f5--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----4125a62e2f5--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://mkemeter.medium.com/?source=post_page-----4125a62e2f5--------------------------------", "anchor_text": ""}, {"url": "https://mkemeter.medium.com/?source=post_page-----4125a62e2f5--------------------------------", "anchor_text": "Mathias Kemeter"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F6ad5b4b18dd8&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-taxi-destinations-with-sap-hana-4125a62e2f5&user=Mathias+Kemeter&userId=6ad5b4b18dd8&source=post_page-6ad5b4b18dd8----4125a62e2f5---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F4125a62e2f5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-taxi-destinations-with-sap-hana-4125a62e2f5&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F4125a62e2f5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-taxi-destinations-with-sap-hana-4125a62e2f5&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@rexcuando?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Eric Nopanen"}, {"url": "https://unsplash.com/?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Unsplash"}, {"url": "https://towardsdatascience.com/spatial-data-science-powered-by-sap-hana-9d1153afa577", "anchor_text": "recent story"}, {"url": "https://github.com/mkemeter/public/blob/master/TaxiTrajectories.ipynb#", "anchor_text": "can be reviewed on GitHub"}, {"url": "https://towardsdatascience.com/spatial-data-science-powered-by-sap-hana-9d1153afa577", "anchor_text": "previous blog"}, {"url": "https://en.wikipedia.org/wiki/Multiclass_classification", "anchor_text": "multiclass classification problem"}, {"url": "https://help.sap.com/doc/0172e3957b5946da85d3fde85ee8f33d/2.0.040/en-US/html/hana_ml.algorithms.apl.html#apl-gb-classification-label", "anchor_text": "GradientBoostingClassifier"}, {"url": "https://help.sap.com/viewer/7c78579ce9b14a669c1f3295b0d8ca16/Cloud/en-US/abf3dd7576464c30a7897a05d1ef8cb2.html", "anchor_text": "RANDOM_PARTITION"}, {"url": "https://blogs.sap.com/2020/02/08/spatial-data-science-powered-by-sap-hana/", "anchor_text": "and my recent"}, {"url": "https://help.sap.com/doc/0172e3957b5946da85d3fde85ee8f33d/2.0.040/en-US/html/index.html", "anchor_text": "hana_ml Python Client"}, {"url": "https://blogs.sap.com/2020/03/25/predicting-taxi-destinations-with-sap-hana/", "anchor_text": "https://blogs.sap.com"}, {"url": "https://linkedin.com/in/mathiaskemeter", "anchor_text": "LinkedIn"}, {"url": "https://twitter.com/math1ask", "anchor_text": "Twitter"}, {"url": "https://medium.com/tag/database?source=post_page-----4125a62e2f5---------------database-----------------", "anchor_text": "Database"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----4125a62e2f5---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/gis?source=post_page-----4125a62e2f5---------------gis-----------------", "anchor_text": "GIS"}, {"url": "https://medium.com/tag/spatial-analysis?source=post_page-----4125a62e2f5---------------spatial_analysis-----------------", "anchor_text": "Spatial Analysis"}, {"url": "https://medium.com/tag/data-science?source=post_page-----4125a62e2f5---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F4125a62e2f5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-taxi-destinations-with-sap-hana-4125a62e2f5&user=Mathias+Kemeter&userId=6ad5b4b18dd8&source=-----4125a62e2f5---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F4125a62e2f5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-taxi-destinations-with-sap-hana-4125a62e2f5&user=Mathias+Kemeter&userId=6ad5b4b18dd8&source=-----4125a62e2f5---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F4125a62e2f5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-taxi-destinations-with-sap-hana-4125a62e2f5&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----4125a62e2f5--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F4125a62e2f5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-taxi-destinations-with-sap-hana-4125a62e2f5&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----4125a62e2f5---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----4125a62e2f5--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----4125a62e2f5--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----4125a62e2f5--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----4125a62e2f5--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----4125a62e2f5--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----4125a62e2f5--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----4125a62e2f5--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----4125a62e2f5--------------------------------", "anchor_text": ""}, {"url": "https://mkemeter.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://mkemeter.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Mathias Kemeter"}, {"url": "https://mkemeter.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "51 Followers"}, {"url": "https://about.me/mkemeter", "anchor_text": "https://about.me/mkemeter"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F6ad5b4b18dd8&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-taxi-destinations-with-sap-hana-4125a62e2f5&user=Mathias+Kemeter&userId=6ad5b4b18dd8&source=post_page-6ad5b4b18dd8--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fusers%2F6ad5b4b18dd8%2Flazily-enable-writer-subscription&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-taxi-destinations-with-sap-hana-4125a62e2f5&user=Mathias+Kemeter&userId=6ad5b4b18dd8&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}