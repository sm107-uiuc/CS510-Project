{"url": "https://towardsdatascience.com/shared-models-and-custom-losses-in-tensorflow-2-keras-6776ecb3b3a9", "time": 1683017653.278081, "path": "towardsdatascience.com/shared-models-and-custom-losses-in-tensorflow-2-keras-6776ecb3b3a9/", "webpage": {"metadata": {"title": "Shared Models and Custom Losses in Tensorflow 2 / Keras | by Charles Guan | Towards Data Science", "h1": "Shared Models and Custom Losses in Tensorflow 2 / Keras", "description": "In this tutorial, I show how to share neural network layer weights and define custom loss functions. The example code assumes beginner knowledge of Tensorflow 2 and the Keras API. For a recent\u2026"}, "outgoing_paragraph_urls": [{"url": "https://github.com/BethanyL/DeepKoopman", "anchor_text": "DeepKoopman", "paragraph_index": 1}, {"url": "https://doi.org/10.1038/s41467-018-07210-0", "anchor_text": "\u201cDeep learning for universal linear embeddings of nonlinear dynamics\u201d", "paragraph_index": 1}, {"url": "https://keras.io/api/losses/#the-addloss-api", "anchor_text": "custom training loop", "paragraph_index": 18}, {"url": "https://gist.github.com/charlesincharge/d339bc5f5e98e4706a8157e9e4333b68", "anchor_text": "as a gist on GitHub", "paragraph_index": 19}, {"url": "https://github.com/BethanyL/DeepKoopman", "anchor_text": "DeepKoopman GitHub", "paragraph_index": 20}, {"url": "https://towardsdatascience.com/advanced-keras-constructing-complex-custom-losses-and-metrics-c07ca130a618", "anchor_text": "Towards Data Science \u2014 Another way to define custom loss functions", "paragraph_index": 20}, {"url": "https://keras.io/guides/functional_api/", "anchor_text": "Keras \u2014The Functional API", "paragraph_index": 20}], "all_paragraphs": ["In this tutorial, I show how to share neural network layer weights and define custom loss functions. The example code assumes beginner knowledge of Tensorflow 2 and the Keras API.", "For a recent project, I wanted to use Tensorflow 2 / Keras to re-implement DeepKoopman, an autoencoder-based neural network architecture described in \u201cDeep learning for universal linear embeddings of nonlinear dynamics\u201d. My end goal was to create a user-friendly version that I could eventually extend", "DeepKoopman embeds time series x onto data into a low-dimensional coordinate system y in which the dynamics are linear.", "The DeepKoopman schematic shows that there are three main components:", "To start building the model, we can define the three sub-models as follows:", "We can connect the sub-models and then plot the overall architecture using Keras plot_model.", "At this point, we are set up to train the autoencoder component, but we haven\u2019t taken into account the time series nature. We still need to be able to input and compute over a second input, x1.", "In basic use-cases, neural networks have a single input node and a single output node (although the corresponding tensors may be multi-dimensional). The original DeepKopman shows the encoder and decoder converting different inputs to different outputs, namely x samples from different times.", "Layer sharing turns out to be quite simple in Keras. We can share layers by calling the same encoder and decoder models on a new Input.", "To recap, in the DeepKoopman example, we want to use the same encoder \u03c6, decoder, and linear dynamics K for each time-point. To share models, we first define the encoder, decoder, and linear dynamics models. Then, we can use the models to connect different inputs and outputs as if they were independent.", "This approach of sharing layers can be helpful in other situations, too. For example, if we wanted to create neural networks with tied weights, we could call the same layer on two inputs.", "So far, we have defined the connections of our neural network architecture. But we haven\u2019t yet defined the loss function, so Tensorflow has no way to optimize the weights.", "The DeepKoopman loss function is composed of :", "Each loss is the mean squared error between two values. In a typical neural network setup, we would pass in ground-truth targets to compare against our model predictions. For example, many Tensorflow/Keras examples use something like:", "With DeepKoopman, we know the target values for losses (1) and (2), but y1 and y1_pred do not have ground truth values, so we cannot use the same approach to calculate loss (3). Instead, Keras offers a second interface to add custom losses, model.add_loss().", "model.add_loss() takes a tensor as input, which means that you can create arbitrarily complex computations using Keras and Tensorflow, then simply add the result as a loss.", "If you want to add arbitrary metrics, you can also use a similar API through model.add_metric():", "The last step is to compile and fit the model:", "Note: unfortunately, the model.add_loss() approach is not compatible with applying loss functions to outputs through model.compile(loss=...) . The best solution for losses that include model outputs and internal tensors may be to define a custom training loop.", "Hope that was helpful! My full implementation of DeepKoopman is available as a gist on GitHub.", "[1] DeepKoopman GitHub[2] Towards Data Science \u2014 Another way to define custom loss functions[3] Keras \u2014The Functional API", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F6776ecb3b3a9&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fshared-models-and-custom-losses-in-tensorflow-2-keras-6776ecb3b3a9&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fshared-models-and-custom-losses-in-tensorflow-2-keras-6776ecb3b3a9&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fshared-models-and-custom-losses-in-tensorflow-2-keras-6776ecb3b3a9&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fshared-models-and-custom-losses-in-tensorflow-2-keras-6776ecb3b3a9&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----6776ecb3b3a9--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----6776ecb3b3a9--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://charlesguan.medium.com/?source=post_page-----6776ecb3b3a9--------------------------------", "anchor_text": ""}, {"url": "https://charlesguan.medium.com/?source=post_page-----6776ecb3b3a9--------------------------------", "anchor_text": "Charles Guan"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F872998583654&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fshared-models-and-custom-losses-in-tensorflow-2-keras-6776ecb3b3a9&user=Charles+Guan&userId=872998583654&source=post_page-872998583654----6776ecb3b3a9---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F6776ecb3b3a9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fshared-models-and-custom-losses-in-tensorflow-2-keras-6776ecb3b3a9&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F6776ecb3b3a9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fshared-models-and-custom-losses-in-tensorflow-2-keras-6776ecb3b3a9&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://github.com/BethanyL/DeepKoopman", "anchor_text": "DeepKoopman"}, {"url": "https://doi.org/10.1038/s41467-018-07210-0", "anchor_text": "\u201cDeep learning for universal linear embeddings of nonlinear dynamics\u201d"}, {"url": "https://doi.org/10.1038/s41467-018-07210-0", "anchor_text": "Lusch, Kutz, and Brunton (Nature Communications 2018)"}, {"url": "https://creativecommons.org/licenses/by/4.0/", "anchor_text": "CC-BY 4.0"}, {"url": "https://keras.io/api/losses/#the-addloss-api", "anchor_text": "custom training loop"}, {"url": "https://gist.github.com/charlesincharge/d339bc5f5e98e4706a8157e9e4333b68", "anchor_text": "as a gist on GitHub"}, {"url": "https://github.com/BethanyL/DeepKoopman", "anchor_text": "DeepKoopman GitHub"}, {"url": "https://towardsdatascience.com/advanced-keras-constructing-complex-custom-losses-and-metrics-c07ca130a618", "anchor_text": "Towards Data Science \u2014 Another way to define custom loss functions"}, {"url": "https://keras.io/guides/functional_api/", "anchor_text": "Keras \u2014The Functional API"}, {"url": "https://medium.com/tag/keras?source=post_page-----6776ecb3b3a9---------------keras-----------------", "anchor_text": "Keras"}, {"url": "https://medium.com/tag/tensorflow?source=post_page-----6776ecb3b3a9---------------tensorflow-----------------", "anchor_text": "TensorFlow"}, {"url": "https://medium.com/tag/neural-networks?source=post_page-----6776ecb3b3a9---------------neural_networks-----------------", "anchor_text": "Neural Networks"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----6776ecb3b3a9---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/python?source=post_page-----6776ecb3b3a9---------------python-----------------", "anchor_text": "Python"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F6776ecb3b3a9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fshared-models-and-custom-losses-in-tensorflow-2-keras-6776ecb3b3a9&user=Charles+Guan&userId=872998583654&source=-----6776ecb3b3a9---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F6776ecb3b3a9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fshared-models-and-custom-losses-in-tensorflow-2-keras-6776ecb3b3a9&user=Charles+Guan&userId=872998583654&source=-----6776ecb3b3a9---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F6776ecb3b3a9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fshared-models-and-custom-losses-in-tensorflow-2-keras-6776ecb3b3a9&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----6776ecb3b3a9--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F6776ecb3b3a9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fshared-models-and-custom-losses-in-tensorflow-2-keras-6776ecb3b3a9&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----6776ecb3b3a9---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----6776ecb3b3a9--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----6776ecb3b3a9--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----6776ecb3b3a9--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----6776ecb3b3a9--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----6776ecb3b3a9--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----6776ecb3b3a9--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----6776ecb3b3a9--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----6776ecb3b3a9--------------------------------", "anchor_text": ""}, {"url": "https://charlesguan.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://charlesguan.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Charles Guan"}, {"url": "https://charlesguan.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "66 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F872998583654&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fshared-models-and-custom-losses-in-tensorflow-2-keras-6776ecb3b3a9&user=Charles+Guan&userId=872998583654&source=post_page-872998583654--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fe154ada8d009&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fshared-models-and-custom-losses-in-tensorflow-2-keras-6776ecb3b3a9&newsletterV3=872998583654&newsletterV3Id=e154ada8d009&user=Charles+Guan&userId=872998583654&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}