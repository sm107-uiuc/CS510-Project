{"url": "https://towardsdatascience.com/snowflake-and-dask-33c84ce0bc36", "time": 1683011028.356503, "path": "towardsdatascience.com/snowflake-and-dask-33c84ce0bc36/", "webpage": {"metadata": {"title": "Snowflake and Dask. How to efficiently load data from\u2026 | by Hugo Shi | Towards Data Science", "h1": "Snowflake and Dask", "description": "Snowflake is the most popular data warehouse among our Saturn users. This article will cover efficient ways to load Snowflake data into Dask so you can do non-sql operations (think machine learning)\u2026"}, "outgoing_paragraph_urls": [{"url": "https://arrow.apache.org/", "anchor_text": "Arrow", "paragraph_index": 2}, {"url": "https://www.saturncloud.io/s/", "anchor_text": "Saturn Cloud", "paragraph_index": 4}, {"url": "https://www.saturncloud.io/s/snowflake/", "anchor_text": "Dask and Snowflake", "paragraph_index": 4}, {"url": "https://https//manager.aws.saturnenterprise.io/register", "anchor_text": "check that out if this is interesting to you", "paragraph_index": 4}, {"url": "https://www.saturncloud.io/s/snowflake/", "anchor_text": "Dask with Snowflake", "paragraph_index": 22}, {"url": "https://manager.aws.saturnenterprise.io/register?trackid=17314f965cd13a-02aa54870e0bee-24414032-317040-17314f965ce320", "anchor_text": "I recommend you check out Saturn Cloud", "paragraph_index": 22}], "all_paragraphs": ["Snowflake is the most popular data warehouse among our Saturn users. This article will cover efficient ways to load Snowflake data into Dask so you can do non-sql operations (think machine learning) at scale. Disclaimer: I\u2019m the CTO of Saturn Cloud \u2014 we focus on enterprise Dask.", "First, some basics, the standard way to load Snowflake data into Pandas:", "Snowflake recently introduced a much faster method for this operation, fetch_pandas_all, and fetch_pandas_batches which leverages Arrow", "fetch_pandas_batches returns an iterator, but since we\u2019re going to focus on loading this into a distributed dataframe (pulling from multiple machines), we\u2019re going to setup our query to shard the data, and use fetch_pandas_all on our workers.", "It can be very tempting to rip all the data out of snowflake so that you can work with it in Dask. That definitely works, however, snowflake is going to be much faster at applying sql-like operations to the data. Snowflake stores the data and has highly optimized routines to get every ounce of performance out of your query. These examples will pretend like we\u2019re loading the entire data into Dask \u2014 in your case, you will probably have some SQL query, which performs the sql-like transformations you care about, and you\u2019ll be loading the result set into Dask, for the things that Dask is good at (possibly some types of feature engineering, and machine learning). Saturn Cloud has native integration with Dask and Snowflake, so check that out if this is interesting to you.", "You can think about a Dask dataframe as a giant Pandas dataframe that has been chopped up and scattered across a bunch of computers. When we are loading data from Snowflake (assuming that the data is large), it\u2019s not efficient to load all the data on one machine, and then scatter that out to your cluster. We are going to focus on having all machines in your Dask cluster load a partition (a small slice) of your data.", "We need a way to split the data into little partitions so that we can load it into the cluster. Data in SQL doesn\u2019t necessarily have any natural ordering. You can\u2019t just say that you\u2019re going to throw the first 10k rows into one partition, and the second 10k rows into another partition. That partitioning has to be based on a column of the data. For example, you can partition the data by a date field. Or you can create a row number by adding an identity column into your Snowflake table.", "Once you\u2019ve decided what column you want to partition your data on, it\u2019s important to set up data clustering on the snowflake side. Every single worker is going to ask for a small slice of the data. Something like", "If you don\u2019t set up data clustering, every single query is going to trigger a full table scan on the resulting database (I\u2019m probably overstating the problem, but without data clustering, performance here can be quite bad)", "We aren\u2019t going to use read_sql_table from the dask library here. I prefer to have more control over how we load the data from Snowflake, and we want to call fetch_pandas_all, which is a Snowflake specific function, and therefore not supported with read_sql_table", "This code assumes that partitions is a list of starting/ending partitions, for example:", "delayed is a decorator that turns a Python function into a function suitable for running on the dask cluster. When you execute it, instead of executing, it returns a delayed result that represents what the return value of the function will be. from_delayed takes a list of these delayed objects, and concatenates them into a giant dataframe.", "This is advanced concepts, but I urge you to read this section, it can save you alot of time and headache from running out of memory on your workstation. Don\u2019t assume that just because Snowflake says that a dataset is 20GB that it will be 20GB when you load it into pandas. The pandas in memory representation is always much larger, though you can get better by being good about data types.", "df.memory_usage(deep=True) is a good way to understand how much memory each column is using. This can help you understand what benefit you are getting from converting your data to appropriate DTypes.", "Python strings have roughly 40 bytes of overhead. That doesn\u2019t sound like a lot, but if you have a billion strings, it can add up quickly. The new StringDType can help here.", "Many string and numerical fields are actually categorical. Take a column named \u201cHousehold Income\u201d. Instead of a numerical value, you usually get data in bands, like \u201c0-$40,000\u201d or \u201cmore than $100,000\u201d.", "As a general guideline, I usually look for columns where the ratio of the number of unique values, to the number of rows is less than 1%.", "In pandas, this is the relevant code.", "However, I\u2019m assuming that loading the entire column out of snowflake in order to compute the categorical dtype is not feasible. I recommend the following type of query to identify which columns are good candidates for categorical dtypes:", "You can compare that result to the number of rows in your table in order to figure out which columns should be categorical.", "Then to figure out the unique values", "Assuming you\u2019ve done some of the memory optimizations listed above, and you\u2019ve figured out some fields that should be converted to StringDType, some that should be categoricals. And assuming that you have a dictionary called dtypes which is a mapping of column names, to the dtype you wish to coerce the result to.", "Thanks for reading. If you\u2019re interested in using Dask with Snowflake, then I recommend you check out Saturn Cloud.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F33c84ce0bc36&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsnowflake-and-dask-33c84ce0bc36&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsnowflake-and-dask-33c84ce0bc36&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsnowflake-and-dask-33c84ce0bc36&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsnowflake-and-dask-33c84ce0bc36&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----33c84ce0bc36--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----33c84ce0bc36--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://hhuuggoo.medium.com/?source=post_page-----33c84ce0bc36--------------------------------", "anchor_text": ""}, {"url": "https://hhuuggoo.medium.com/?source=post_page-----33c84ce0bc36--------------------------------", "anchor_text": "Hugo Shi"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F58d7b003c928&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsnowflake-and-dask-33c84ce0bc36&user=Hugo+Shi&userId=58d7b003c928&source=post_page-58d7b003c928----33c84ce0bc36---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F33c84ce0bc36&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsnowflake-and-dask-33c84ce0bc36&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F33c84ce0bc36&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsnowflake-and-dask-33c84ce0bc36&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@dariuscotoi?utm_source=medium&utm_medium=referral", "anchor_text": "Darius Cotoi"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://arrow.apache.org/", "anchor_text": "Arrow"}, {"url": "https://www.saturncloud.io/s/", "anchor_text": "Saturn Cloud"}, {"url": "https://www.saturncloud.io/s/snowflake/", "anchor_text": "Dask and Snowflake"}, {"url": "https://https//manager.aws.saturnenterprise.io/register", "anchor_text": "check that out if this is interesting to you"}, {"url": "https://www.saturncloud.io/s/snowflake/", "anchor_text": "Dask with Snowflake"}, {"url": "https://manager.aws.saturnenterprise.io/register?trackid=17314f965cd13a-02aa54870e0bee-24414032-317040-17314f965ce320", "anchor_text": "I recommend you check out Saturn Cloud"}, {"url": "https://medium.com/tag/data-science?source=post_page-----33c84ce0bc36---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----33c84ce0bc36---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/dask?source=post_page-----33c84ce0bc36---------------dask-----------------", "anchor_text": "Dask"}, {"url": "https://medium.com/tag/python?source=post_page-----33c84ce0bc36---------------python-----------------", "anchor_text": "Python"}, {"url": "https://medium.com/tag/snowflake?source=post_page-----33c84ce0bc36---------------snowflake-----------------", "anchor_text": "Snowflake"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F33c84ce0bc36&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsnowflake-and-dask-33c84ce0bc36&user=Hugo+Shi&userId=58d7b003c928&source=-----33c84ce0bc36---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F33c84ce0bc36&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsnowflake-and-dask-33c84ce0bc36&user=Hugo+Shi&userId=58d7b003c928&source=-----33c84ce0bc36---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F33c84ce0bc36&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsnowflake-and-dask-33c84ce0bc36&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----33c84ce0bc36--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F33c84ce0bc36&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsnowflake-and-dask-33c84ce0bc36&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----33c84ce0bc36---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----33c84ce0bc36--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----33c84ce0bc36--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----33c84ce0bc36--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----33c84ce0bc36--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----33c84ce0bc36--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----33c84ce0bc36--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----33c84ce0bc36--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----33c84ce0bc36--------------------------------", "anchor_text": ""}, {"url": "https://hhuuggoo.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://hhuuggoo.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Hugo Shi"}, {"url": "https://hhuuggoo.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "54 Followers"}, {"url": "http://SaturnCloud.io", "anchor_text": "SaturnCloud.io"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F58d7b003c928&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsnowflake-and-dask-33c84ce0bc36&user=Hugo+Shi&userId=58d7b003c928&source=post_page-58d7b003c928--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fc661b05647be&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsnowflake-and-dask-33c84ce0bc36&newsletterV3=58d7b003c928&newsletterV3Id=c661b05647be&user=Hugo+Shi&userId=58d7b003c928&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}