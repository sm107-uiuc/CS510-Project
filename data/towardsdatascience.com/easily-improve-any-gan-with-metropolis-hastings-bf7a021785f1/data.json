{"url": "https://towardsdatascience.com/easily-improve-any-gan-with-metropolis-hastings-bf7a021785f1", "time": 1683007815.289813, "path": "towardsdatascience.com/easily-improve-any-gan-with-metropolis-hastings-bf7a021785f1/", "webpage": {"metadata": {"title": "Easily Improve Any GAN with Metropolis-Hastings | by Jacob Gursky | Towards Data Science", "h1": "Easily Improve Any GAN with Metropolis-Hastings", "description": "Ever had trouble getting believable outputs from your GAN? In this article we are going to review a recent improvement to GANs that boosts output quality with an easy-to-follow Tensorflow 2\u2026"}, "outgoing_paragraph_urls": [{"url": "https://towardsdatascience.com/understanding-generative-adversarial-networks-gans-cd6e4651a29", "anchor_text": "article", "paragraph_index": 1}, {"url": "https://www.tensorflow.org/tutorials/generative/dcgan", "anchor_text": "here", "paragraph_index": 5}, {"url": "https://scikit-learn.org/stable/modules/calibration.html", "anchor_text": "here", "paragraph_index": 16}, {"url": "https://arxiv.org/abs/1810.06758", "anchor_text": "\u201cDiscriminator Rejection Sampling\u201d", "paragraph_index": 31}, {"url": "https://arxiv.org/abs/2003.06060", "anchor_text": "\u201cYour GAN is Secretly an Energy-based Model and You Should use Discriminator Driven Latent Sampling\u201d", "paragraph_index": 31}], "all_paragraphs": ["Ever had trouble getting believable outputs from your GAN? In this article we are going to review a recent improvement to GANs that boosts output quality with an easy-to-follow Tensorflow 2 implementation to get your own Metropolis-Hastings GAN off the ground!", "In late 2018, Uber Engineering released a paper entitled \u201cMetropolis- Hastings Generative Adversarial Networks\u201d (Turner et al.), in which the authors introduce a simple trick that improves the output of GANs with no additional train time of the GAN. If you are not very familiar with GANs, I suggest reading this article before proceeding to get a better understand of the models we are dealing with.", "The basic premise of Uber\u2019s work is that the discriminator, which is normally thrown out after training, contains valuable information in determining which samples resemble the true data distribution. The authors propose a novel sampling scheme in which samples are drawn from the latent space of the generator using Metropolis-Hastings with the discriminator choosing which generated samples to accept.", "What\u2019s ingenious about this method is that it works with any GAN architecture or loss function, as MH-GAN is really just a post-training sampling methodology. Before we show how to apply this sampling method, let\u2019s first train a GAN to use it on!", "To start on our journey of training a MH-GAN, we are first going to a train a Least-Squares GAN due to its stability and ease of implementation. I included a link at the bottom of the article if you want to learn more about LS-GANs. For the data, we are going to be working with the Fashion MNIST dataset included in TensorFlow so these results are easy to replicate at home!", "Please note that some of the training code below is adapted from the official TensorFlow DC-GAN tutorial located here:", "Note that we are also using the tensorflow-addons package to implement some more advanced functionality such as the Ranger optimizer and Mish activation layers to smooth the training process.", "The next step in training our networks is to define our generator and discriminator objects to feed into our LS-GAN class:", "We have a base class to train a Least-Squares GAN as well as a generator and discriminator to feed into it, now its time to dive into implementing the MH-GAN!", "The first thing we need to understand when implementing a MH-GAN is the Metropolis-Hastings algorithm. MH is a Markov-Chain Monte-Carlo method for sampling from a distribution that is difficult to directly sample from. In this case, we are trying to sample from the true data distribution that is implied by the discriminator.", "We won\u2019t dive too deep into the theory behind Metropolis-Hastings, but I have included a link at the bottom of this article if you want to learn more.", "Once we have a trained generator and discriminator, we use the following steps to draw samples that follow the true data distribution (feel free to refer to the pseudocode above):", "Essentially what this rule is doing is comparing the ratio of the proposed sample\u2019s discriminator score to the current sample\u2019s score to determine if we should \u201caccept\u201d the new sample. With enough iterations our independent chain will approximate the true data distribution implied by our discriminator\u2019s output!", "If we fail to accept any samples after a certain number of iterations, the authors recommend restarting the chain from a synthetic sample to guarantee convergence, albeit at a slower pace.", "This is not the end of the story however, as there is an outstanding issue with the output of our discriminator, which we will address in the next section.", "One of the assumptions made in applying Metropolis-Hastings is that the probabilities of our discriminator are well-calibrated. This means that the discriminator output must be interpretable as a confidence level. Unfortunately, the raw outputs of a neural network classifier are almost never well-calibrated, meaning we have to apply an additional step to calibrate the outputs. This is true even if we use a sigmoid or softmax activation on the final layer!", "The Scikit-Learn documentation has a great section on calibration here, but what the authors of the paper recommend is using a technique called isotonic regression to convert the network outputs to calibrated probabilities as a post-processing step. Unfortunately, this needs to be done on a held-out set, meaning we have to divide our Fashion-MNIST into a training and validation set (fortunately Tensorflow does this for us!)", "Below is a calibration curve (a diagnostic tool that illustrates the calibration of a model, the 45 degree line represents perfect calibration) on held-out data showing how our isotonic predictions satisfy the condition of Metropolis-Hastings. Our raw outputs, on the other hand, are clearly poorly-calibrated.", "Once we have our discriminator calibrated, we can then use the calibrated probabilities in determining the acceptance probabilities of new samples in the independent MCMC chain we outlined above!", "Now its finally time to put the calibration and Metropolis-Hastings sampling into practice with a subclass of the LS-GAN we coded above. Note that we could easily apply this subclass to any other sort of GAN that follows the API we outlined above, or even adapt it to existing GAN packages.", "Note that there are a couple of things going on here, first we need to implement a method to train our calibrator as well as a calibrated scoring method.", "For training the calibrator, we simply take a held-out set and generate the same number of samples from the generator. Next, we train the IsotonicRegression class from Scikit-Learn to translate the discriminator scores into true probabilities.", "Finally, we have our generate_mh_samples() method, which generates a specified number of accepted samples given a true example to seed the MCMC chain. Can you see a common theme here? The calibrated scoring and MH sample generation methods are simply the MH-GAN counterparts to the score_samples() and generate_samples() methods from the LS-GAN!", "Time to wet our feet with this new class using the Fashion-MNIST data!", "To start using our shiny new MH-GAN class, the first thing we have to do is load our Fashion-MNIST data and separate it into our training and validation sets, as well as normalizing the pixels. Fortunately, tf.keras makes this super easy!", "Now that we have our training and test sets, all we have to do is initialize our MHGAN object with the generator and discriminator we declared above, as well as the dimensionality of our noise for the generator and the optimizer learning rate. We are going to then train for 50 epochs (this was rather arbitrary, usually this needs to be more thought-out for GANs), and finally calibrate our discriminator. Our object-oriented approach allows us to do this in 3 lines of code!", "After the training is completed, we can draw samples from our trained MH-GAN by using either our normal naive GAN sampling, or the Metropolis-Hastings algorithm from the Uber paper.", "Let\u2019s take a look at 15 images generated using LS-GAN, MH-GAN, and some true images to compare:", "Wow! We can definitely see that the MH-GAN nearly entirely avoids the issue of clearly fake samples! This finding is in line with that of the Uber team, who reported on CelebA dataset their method drastically reduces the number of low-fidelity images. We can see instances of samples from the LS-GAN that just look like ill-defined blobs, whereas this occurs much less frequently in our MH-GAN.", "The team also argues that it addresses the mode-collapse problem, but in my trials of their method I didn\u2019t really see this occurring, but MNIST and Fashion-MNIST aren\u2019t always the best indicators of algorithm performance and this wasn\u2019t an issue to begin with.", "If you are interested in applying the quick improvement to GANs we demonstrated in this article, I would highly recommend reading the original MH-GAN paper which is linked below! Furthermore, we have shown that TensorFlow 2 makes it extremely easy to apply the technique with very little additional code!", "There are quite a few other intriguing papers regarding discriminator-based GAN sampling, such as \u201cDiscriminator Rejection Sampling\u201d by Azadi et al. and \u201cYour GAN is Secretly an Energy-based Model and You Should use Discriminator Driven Latent Sampling\u201d by Che et al., showing the promise of this field. No doubt it will be interesting to see where this goes over the next few years.", "If you have any questions or comments about this article, please feel free to post them below!", "Link to the original MH-GAN paper by Uber:", "Original website article by Uber Engineering on MH-GANS:", "A helpful article on Least-Squares GAN", "A quick tutorial to Metropolis-Hastings sampling:", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Data Scientist/ML Engineer working at Seagate Technology. My interests include Natural Language Generation and Changepoint Detection."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fbf7a021785f1&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Feasily-improve-any-gan-with-metropolis-hastings-bf7a021785f1&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Feasily-improve-any-gan-with-metropolis-hastings-bf7a021785f1&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Feasily-improve-any-gan-with-metropolis-hastings-bf7a021785f1&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Feasily-improve-any-gan-with-metropolis-hastings-bf7a021785f1&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----bf7a021785f1--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----bf7a021785f1--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@gurskyjacob?source=post_page-----bf7a021785f1--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@gurskyjacob?source=post_page-----bf7a021785f1--------------------------------", "anchor_text": "Jacob Gursky"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F13efc0f9bee7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Feasily-improve-any-gan-with-metropolis-hastings-bf7a021785f1&user=Jacob+Gursky&userId=13efc0f9bee7&source=post_page-13efc0f9bee7----bf7a021785f1---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fbf7a021785f1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Feasily-improve-any-gan-with-metropolis-hastings-bf7a021785f1&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fbf7a021785f1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Feasily-improve-any-gan-with-metropolis-hastings-bf7a021785f1&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://pixabay.com/photos/fox-sleeping-resting-relaxing-red-1284512/", "anchor_text": "Pixabay"}, {"url": "https://towardsdatascience.com/understanding-generative-adversarial-networks-gans-cd6e4651a29", "anchor_text": "article"}, {"url": "https://www.tensorflow.org/tutorials/generative/dcgan", "anchor_text": "here"}, {"url": "https://scikit-learn.org/stable/modules/calibration.html", "anchor_text": "here"}, {"url": "https://arxiv.org/abs/1810.06758", "anchor_text": "\u201cDiscriminator Rejection Sampling\u201d"}, {"url": "https://arxiv.org/abs/2003.06060", "anchor_text": "\u201cYour GAN is Secretly an Energy-based Model and You Should use Discriminator Driven Latent Sampling\u201d"}, {"url": "https://arxiv.org/abs/1811.11357", "anchor_text": "Metropolis-Hastings Generative Adversarial NetworksWe introduce the Metropolis-Hastings generative adversarial network (MH-GAN), which combines aspects of Markov chain\u2026arxiv.org"}, {"url": "https://eng.uber.com/mh-gan/", "anchor_text": "How to Get a Better GAN (Almost) for Free: Introducing the Metropolis-Hastings GANGenerative Adversarial Networks (GANs) have achieved impressive feats in realistic image generation and image repair \u2026eng.uber.com"}, {"url": "https://wiseodd.github.io/techblog/2017/03/02/least-squares-gan/", "anchor_text": "Least Squares GANThanks to F-GAN, which established the general framework of GAN training, recently we saw modifications of GAN which\u2026wiseodd.github.io"}, {"url": "https://towardsdatascience.com/from-scratch-bayesian-inference-markov-chain-monte-carlo-and-metropolis-hastings-in-python-ef21a29e25a", "anchor_text": "From Scratch: Bayesian Inference, Markov Chain Monte Carlo and Metropolis Hastings, in python0- My first articletowardsdatascience.com"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----bf7a021785f1---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/tag/tensorflow?source=post_page-----bf7a021785f1---------------tensorflow-----------------", "anchor_text": "TensorFlow"}, {"url": "https://medium.com/tag/data-science?source=post_page-----bf7a021785f1---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----bf7a021785f1---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/python?source=post_page-----bf7a021785f1---------------python-----------------", "anchor_text": "Python"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fbf7a021785f1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Feasily-improve-any-gan-with-metropolis-hastings-bf7a021785f1&user=Jacob+Gursky&userId=13efc0f9bee7&source=-----bf7a021785f1---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fbf7a021785f1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Feasily-improve-any-gan-with-metropolis-hastings-bf7a021785f1&user=Jacob+Gursky&userId=13efc0f9bee7&source=-----bf7a021785f1---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fbf7a021785f1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Feasily-improve-any-gan-with-metropolis-hastings-bf7a021785f1&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----bf7a021785f1--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fbf7a021785f1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Feasily-improve-any-gan-with-metropolis-hastings-bf7a021785f1&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----bf7a021785f1---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----bf7a021785f1--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----bf7a021785f1--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----bf7a021785f1--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----bf7a021785f1--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----bf7a021785f1--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----bf7a021785f1--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----bf7a021785f1--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----bf7a021785f1--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@gurskyjacob?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@gurskyjacob?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Jacob Gursky"}, {"url": "https://medium.com/@gurskyjacob/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "95 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F13efc0f9bee7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Feasily-improve-any-gan-with-metropolis-hastings-bf7a021785f1&user=Jacob+Gursky&userId=13efc0f9bee7&source=post_page-13efc0f9bee7--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fb84943f5e164&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Feasily-improve-any-gan-with-metropolis-hastings-bf7a021785f1&newsletterV3=13efc0f9bee7&newsletterV3Id=b84943f5e164&user=Jacob+Gursky&userId=13efc0f9bee7&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}