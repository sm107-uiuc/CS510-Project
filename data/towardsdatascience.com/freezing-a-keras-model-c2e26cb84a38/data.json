{"url": "https://towardsdatascience.com/freezing-a-keras-model-c2e26cb84a38", "time": 1682993694.75374, "path": "towardsdatascience.com/freezing-a-keras-model-c2e26cb84a38/", "webpage": {"metadata": {"title": "Freezing a Keras model. How to freeze a model for serving and\u2026 | by Joseph Aylett-Bullock | Towards Data Science", "h1": "Freezing a Keras model", "description": "Keras has become one of the dominant APIs for developing and testing neural networks across industry and academia. It combines user friendly syntax with flexibility due to its various backend\u2026"}, "outgoing_paragraph_urls": [{"url": "https://www.tensorflow.org/api_guides/cc/guide", "anchor_text": "TensorFlow C++ API", "paragraph_index": 1}, {"url": "https://stackoverflow.com/questions/36720498/convert-keras-model-to-c", "anchor_text": "stack overflow", "paragraph_index": 2}, {"url": "https://medium.com/@hamedmp/exporting-trained-tensorflow-models-to-c-the-right-way-cf24b609d183", "anchor_text": "Medium", "paragraph_index": 2}, {"url": "https://github.com/pplonski/keras2cpp", "anchor_text": "keras2cpp", "paragraph_index": 2}, {"url": "https://www.tensorflow.org/guide/graphs", "anchor_text": "graph", "paragraph_index": 5}, {"url": "https://www.tensorflow.org/extend/tool_developers/", "anchor_text": "ProtoBuf library", "paragraph_index": 5}, {"url": "https://www.tensorflow.org/guide/estimators", "anchor_text": "Estimator", "paragraph_index": 11}, {"url": "https://www.tensorflow.org/guide/graphs", "anchor_text": "sessions", "paragraph_index": 11}, {"url": "http://yann.lecun.com/exdb/mnist/", "anchor_text": "MNIST", "paragraph_index": 12}, {"url": "https://www.tensorflow.org/guide/custom_estimators", "anchor_text": "custom Estimators", "paragraph_index": 14}, {"url": "https://cloud.google.com/blog/products/gcp/new-in-tensorflow-14-converting-a-keras-model-to-a-tensorflow-estimator", "anchor_text": "tutorial", "paragraph_index": 14}, {"url": "https://www.tensorflow.org/api_docs/python/tf/estimator/Estimator", "anchor_text": "Documentation", "paragraph_index": 16}, {"url": "https://www.tensorflow.org/tutorials/", "anchor_text": "MNIST tutorial", "paragraph_index": 19}, {"url": "https://blog.metaflow.fr/tensorflow-how-to-freeze-a-model-and-serve-it-with-a-python-api-d4f3596b3adc", "anchor_text": "simplified version", "paragraph_index": 23}, {"url": "https://medium.com/u/17b66605e1fa?source=post_page-----c2e26cb84a38--------------------------------", "anchor_text": "Morgan", "paragraph_index": 23}], "all_paragraphs": ["Keras has become one of the dominant APIs for developing and testing neural networks across industry and academia. It combines user friendly syntax with flexibility due to its various backend possibilities, meaning that you can write in TensorFlow, Theano or CNTK and call it in Keras.", "Once you have designed a network using Keras, you may want to serve it in another API, on the web, or other medium. One of the easiest way to do many of the above is to use the pre-built TensorFlow libraries (such as the TensorFlow C++ API for model inference in a C++ environment). In order to do this you will most likely have to \u2018freeze\u2019 your trained Keras model due to the way the backends of these APIs work. Unfortunately, in order to do this easily, you will have to retrain your model in the TensorFlow implementation of Keras. Fortunately, however, this process is very simple if you know what you\u2019re aiming for thanks to the way Keras is integrated into TensorFlow, and various other materials provided by TensorFlow for this task.", "When I was originally researching how to go about this task for my own requirement of serving a model in a C++ environment, I came across several possible answers from similar posts on places like stack overflow, as well as here on Medium. Similarly, some people have made a variety of great open source packages to do just this, such as keras2cpp. Yet, I found the articles lacking in some crucial details, and frequently using complicated techniques, necessary when written, but which have been significantly simplified thanks to TensorFlow updates.", "My hope is that this article provides a simple, up-to-date walkthrough of how to freeze a Keras model for any general requirement, not just for serving in a C++ environment. The methodology described in this article, although written specifically for converting a model written in the Keras API (natively or in the TensorFlow implementation), it can also be used for any model written in native TensorFlow as well.", "If your model is trained and saved in the Keras API then you will probably have saved an hdf5 file of your model in which the network architecture and weights are saved together in one file. This file can be called and loaded back into the Keras API for inference. Sadly, however, this file type is not recognised by TensorFlow APIs and is also unnecessarily large to store, load in, and perform inference on.", "Similarly, if you write a model in the TensorFlow Python API, then the training procedure will save a TensorFlow graph, using Google\u2019s ProtoBuf library, and a series of checkpoint files. The graph stores the information about the architecture of the network with Variable ops, whereas the checkpoint files contain the values of the weights at various stages of training (depending on how regularly your session checkpoints during training). These can normally be loaded in for inference in a TensorFlow Python API session during which weights from the checkpoint files are inserted into the Variable ops in the graph. Yet, this is inefficient when just performing inference. A saved Keras .h5 file, on the other hand, is simply the graph and final state checkpoint file combined together, while still keeping the hyperparameters stored as Variable ops. (Note: a detailed understanding of the above is not necessary, I just add it for those wanting a more detailed explanation.)", "Freezing the model means producing a singular file containing information about the graph and checkpoint variables, but saving these hyperparameters as constants within the graph structure. This eliminates additional information saved in the checkpoint files such as the gradients at each point, which are included so that the model can be reloaded and training continued from where you left off. As this is not needed when serving a model purely for inference they are discarded in freezing. A frozen model is a file of the Google .pb file type.", "The requirements for freezing your model for inference are simple, however, you will probably need to install various other packages to actually perform inference depending on your application:", "In order to generate a .pb file containing the necessary information TensorFlow has helpfully written the freeze_graph.py file which, when called, will merge the TensorFlow graph and checkpoint files. Using this Python script is often advisable since it was written by the TensorFlow team, who ensure that it will work with their in-house file formats. However, in order to use it you must first have a graph and checkpoint file in the correct format. The Keras API does not generate automatically this file so you will need to retrain the model in order to generate them.", "There are two relatively simple ways to go about acquiring a saved trained model in the correct format for freezing. If you are using the Keras API directly, then you will be required to change to the Keras API implemented in a TensorFlow environment.", "Note: This should just require a change at the importing stage e.g. instead of from keras.layers import Convolution2D you would have from tensorflow.keras.layers import Convolution2D.", "The first method calls the model and then converts it to a TensorFlow Estimator, which will handle the training. The second requires an understanding of how TensorFlow sessions work, as this method trains the network as you would one written in native TensorFlow. After implementing either of these training methods, you will be able to run freeze_graph in order to get the correct output.", "Let\u2019s work through an example in order to demonstrate this process. Here we shall convert a simple Keras model for digit classification on the MNIST dataset into an Estimator.", "First, we build the model in the Keras API implemented in TensorFlow, be sure to name your input and output layers, as we will need these names later:", "This method is probably the most simple of the two in general, however, it can quickly become more complex, depending on how you want to train the model, due to the nature of handling custom Estimators. If you are only familiar with training models in the native Keras API then this is the most similar way to train your model. The ability to convert a Keras model into a TensorFlow Estimator was introduced in TensorFlow 1.4 and is descibed in this tutorial.", "To convert the model as written above into an estimator, first compile the model using the normal Keras API implemented in TensorFlow and then use the model_to_estimator() function:", "Now the estimator_model behaves like a TensorFlow Estimator and we can train the model accordingly. For a guide on how to train an Estimator see the Documentation.", "For training, define an input function and train the model accordingly:", "The model is now trained and the graph.pbtxt and checkpoint .ckpt files will be saved in the ./Keras_MNIST model directory.", "An alternative approch is to train the model by initiating a TensorFlow session and training within the session. This requires a more detailed understanding of how sessions work, which is beyond the scope of this article, and I refer the reader to this MNIST tutorial as an example of such training. However, unlike the example, you do not need to write the model in native TensorFlow, instead we can call our model above and just change the input layer:", "The rest can be followed from the tutorial.", "Now that the model has been trained and the graph and checkpoint files made we can use TensorFlow\u2019s freeze_graph.py to merge these together.", "Note: Make sure the freeze_graph.py is in the same directory as the checkpoint and graph files you\u2019d like to freeze.", "Alternatively, I find the simplified version developed by Morgan to be less prone to flagging errors.", "This function restarts a temporary session with a graph to restore the most recent checkpoint. Another advantage of using this implementation is that you don\u2019t have to make sure you\u2019re specifying the correct checkpoint file, or handle the more syntactically dense freeze_graph.py inputs.", "We need to know the name of the output node to give as a reference point to the function. This is the same if we use the simplified version of freeze_graph or not. The name given you gave to the final layer is not enough here, instead opening TensorBoard will give a visualisation of the graph.", "In this example we want the tensor which feeds into the \u2018metrics\u2019 node, called output_node/Softmax.", "This will now generate a frozen graph in the model directory.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "PhD Researcher at the Institute of Particle Physics Phenomenology, Durham University, specialising in Data Intensive Science/ Machine Learning"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fc2e26cb84a38&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffreezing-a-keras-model-c2e26cb84a38&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffreezing-a-keras-model-c2e26cb84a38&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffreezing-a-keras-model-c2e26cb84a38&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffreezing-a-keras-model-c2e26cb84a38&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----c2e26cb84a38--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----c2e26cb84a38--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@JosephBullock?source=post_page-----c2e26cb84a38--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@JosephBullock?source=post_page-----c2e26cb84a38--------------------------------", "anchor_text": "Joseph Aylett-Bullock"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Ffad6b2f307fc&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffreezing-a-keras-model-c2e26cb84a38&user=Joseph+Aylett-Bullock&userId=fad6b2f307fc&source=post_page-fad6b2f307fc----c2e26cb84a38---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fc2e26cb84a38&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffreezing-a-keras-model-c2e26cb84a38&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fc2e26cb84a38&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffreezing-a-keras-model-c2e26cb84a38&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@theforestbirds?utm_source=medium&utm_medium=referral", "anchor_text": "Joel & Jasmin F\u00f8restbird"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://www.tensorflow.org/api_guides/cc/guide", "anchor_text": "TensorFlow C++ API"}, {"url": "https://stackoverflow.com/questions/36720498/convert-keras-model-to-c", "anchor_text": "stack overflow"}, {"url": "https://medium.com/@hamedmp/exporting-trained-tensorflow-models-to-c-the-right-way-cf24b609d183", "anchor_text": "Medium"}, {"url": "https://github.com/pplonski/keras2cpp", "anchor_text": "keras2cpp"}, {"url": "https://www.tensorflow.org/guide/graphs", "anchor_text": "graph"}, {"url": "https://www.tensorflow.org/extend/tool_developers/", "anchor_text": "ProtoBuf library"}, {"url": "https://www.tensorflow.org/guide/summaries_and_tensorboard", "anchor_text": "TensorBoard"}, {"url": "https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/tools/freeze_graph.py", "anchor_text": "freeze_graph.py"}, {"url": "https://www.tensorflow.org/guide/estimators", "anchor_text": "Estimator"}, {"url": "https://www.tensorflow.org/guide/graphs", "anchor_text": "sessions"}, {"url": "http://yann.lecun.com/exdb/mnist/", "anchor_text": "MNIST"}, {"url": "https://www.tensorflow.org/guide/custom_estimators", "anchor_text": "custom Estimators"}, {"url": "https://cloud.google.com/blog/products/gcp/new-in-tensorflow-14-converting-a-keras-model-to-a-tensorflow-estimator", "anchor_text": "tutorial"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/estimator/Estimator", "anchor_text": "Documentation"}, {"url": "https://www.tensorflow.org/tutorials/", "anchor_text": "MNIST tutorial"}, {"url": "https://blog.metaflow.fr/tensorflow-how-to-freeze-a-model-and-serve-it-with-a-python-api-d4f3596b3adc", "anchor_text": "simplified version"}, {"url": "https://medium.com/u/17b66605e1fa?source=post_page-----c2e26cb84a38--------------------------------", "anchor_text": "Morgan"}, {"url": "https://medium.com/u/17b66605e1fa?source=post_page-----c2e26cb84a38--------------------------------", "anchor_text": "Morgan"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----c2e26cb84a38---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/tensorflow?source=post_page-----c2e26cb84a38---------------tensorflow-----------------", "anchor_text": "TensorFlow"}, {"url": "https://medium.com/tag/keras?source=post_page-----c2e26cb84a38---------------keras-----------------", "anchor_text": "Keras"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----c2e26cb84a38---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/tag/towards-data-science?source=post_page-----c2e26cb84a38---------------towards_data_science-----------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fc2e26cb84a38&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffreezing-a-keras-model-c2e26cb84a38&user=Joseph+Aylett-Bullock&userId=fad6b2f307fc&source=-----c2e26cb84a38---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fc2e26cb84a38&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffreezing-a-keras-model-c2e26cb84a38&user=Joseph+Aylett-Bullock&userId=fad6b2f307fc&source=-----c2e26cb84a38---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fc2e26cb84a38&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffreezing-a-keras-model-c2e26cb84a38&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----c2e26cb84a38--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fc2e26cb84a38&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffreezing-a-keras-model-c2e26cb84a38&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----c2e26cb84a38---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----c2e26cb84a38--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----c2e26cb84a38--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----c2e26cb84a38--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----c2e26cb84a38--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----c2e26cb84a38--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----c2e26cb84a38--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----c2e26cb84a38--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----c2e26cb84a38--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@JosephBullock?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@JosephBullock?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Joseph Aylett-Bullock"}, {"url": "https://medium.com/@JosephBullock/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "94 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Ffad6b2f307fc&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffreezing-a-keras-model-c2e26cb84a38&user=Joseph+Aylett-Bullock&userId=fad6b2f307fc&source=post_page-fad6b2f307fc--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fusers%2Ffad6b2f307fc%2Flazily-enable-writer-subscription&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffreezing-a-keras-model-c2e26cb84a38&user=Joseph+Aylett-Bullock&userId=fad6b2f307fc&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}