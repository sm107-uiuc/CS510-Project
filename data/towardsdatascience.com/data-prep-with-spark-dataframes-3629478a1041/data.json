{"url": "https://towardsdatascience.com/data-prep-with-spark-dataframes-3629478a1041", "time": 1683003287.44132, "path": "towardsdatascience.com/data-prep-with-spark-dataframes-3629478a1041/", "webpage": {"metadata": {"title": "Data Prep with Spark DataFrames. Using PySpark to continue investigating\u2026 | by Allison Stafford | Towards Data Science", "h1": "Data Prep with Spark DataFrames", "description": "As we saw in last week\u2019s blog, the big three credit reporting agencies are among the most complained about companies in the US Federal Financial Services Consumer Complaint Database. It\u2019s interesting\u2026"}, "outgoing_paragraph_urls": [{"url": "https://towardsdatascience.com/exploring-financial-consumer-complaints-with-spark-48a253f9c830?source=friends_link&sk=66da638afb846bf78032a63afd8acc0c", "anchor_text": "last week\u2019s blog", "paragraph_index": 0}, {"url": "https://towardsdatascience.com/exploring-financial-consumer-complaints-with-spark-48a253f9c830?source=friends_link&sk=66da638afb846bf78032a63afd8acc0c", "anchor_text": "post", "paragraph_index": 1}, {"url": "https://spark.apache.org/docs/2.3.0/api/python/pyspark.sql.html#pyspark.sql.DataFrame", "anchor_text": "PySpark DataFrame", "paragraph_index": 1}, {"url": "https://spark.apache.org/docs/2.3.0/api/python/pyspark.sql.html#pyspark.sql.Column", "anchor_text": "PySpark Column", "paragraph_index": 1}, {"url": "https://spark.apache.org/docs/2.3.0/api/sql/index.html", "anchor_text": "PySpark Functions", "paragraph_index": 1}, {"url": "https://www.consumerfinance.gov/data-research/consumer-complaints/", "anchor_text": "US Federal Financial Services Consumer Complaint Database", "paragraph_index": 1}, {"url": "https://simplemaps.com/data/us-zips", "anchor_text": "SimpleMaps", "paragraph_index": 18}, {"url": "https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html", "anchor_text": "census.gov", "paragraph_index": 18}, {"url": "https://github.com/allisonhonold/spark-data-prep-blog", "anchor_text": "GitHub repo", "paragraph_index": 24}], "all_paragraphs": ["As we saw in last week\u2019s blog, the big three credit reporting agencies are among the most complained about companies in the US Federal Financial Services Consumer Complaint Database. It\u2019s interesting to think about everything your credit score is used for: getting a loan, renting an apartment, getting a cell phone plan. Scratch that. It\u2019s more frightening than interesting. So today we are going to dig further into the Complaint database to answer several questions that have been on my mind:", "Once you have your data in a Spark DataFrame (if not, check out last week\u2019s post), you\u2019re ready to do some exploration and cleaning. The PySpark DataFrame, PySpark Column and PySpark Functions documentation will definitely be your friends as you work in your own context (Ross, Monica, and Chandler, respectively\u2026sorry Joey, I\u2019m still not sure where your place in the world of Data Science lies). For my project on the US Federal Financial Services Consumer Complaint Database, I\u2019ll be counting, filling, and dropping NaNs, converting date column to datetime and extracting date features, and checking values against a list of acceptable values.", "Before getting started, I recommend that you set the Spark configuration like so:", "This setting makes the output more like pandas and less like command-line SQL. After this, you no longer need to specify show() to see the output. Alternatively, you can also use .toPandas() or .toPandas().T (for transpose) to see the pandas style output. Remember to only do this on DataFrames that are small enough to fit in memory. It\u2019s easy to crash your kernel with a too-large pandas dataframe.", "Note that in PySpark NaN is not the same as Null. Both of these are also different than an empty string \u201c\u201d, so you may want to check for each of these, on top of any data set specific filler values.", "You can see here that this formatting is definitely easier to read than the standard output, which does not do well with long column titles, but it does still require scrolling right to see the remaining columns.", "This data set has no NaNs, so I move on to Null.", "You can count your Null values using the following code:", "To check for duplicates, I compared df.count() to df.distinct().count(). In this case I had none.", "Next, I decided to drop the single row with a null value in company_response_to_consumer. Here we see that it is very similar to pandas.", "For the consumer_disputed column, I decided to replace null values with No, while adding a flag column for this change:", "Again, this is very similar to pandas, with the exception of the new syntax for adding columns \u201cwithColumn\u201d). You\u2019ll see an alternate way to add new columns in the next section.", "Now I\u2019m ready to add my new features:", "This allowed me to investigate the temporal aspect of our data set", "Interesting that people are mostly making complaints M-F, even though there is an online form. I wonder how this breaks out by submission type.", "There does seem to be potential for a cyclical pattern here, but it\u2019s hard to say from this graph alone. Another area for future investigation.", "I cleaned up my state column using a list of state abbreviations, replacing all non-standard responses with a single value \u201cunknown.\u201d", "I ended up with 26k rows with \u2018unknown\u2019 states \u2014 a prime reason to restrict inputs, but at least this is now contained, and not a whole bunch of random mistyped state values.", "With this, I grouped by state and converted my now 50-row, 2-column dataframe to pandas. Then I joined this dataframe with my state-based data (thank you SimpleMaps CC4.0), and graphed using geopandas (and shapefiles from census.gov).", "In GeoPandas, I found that Alaska\u2019s most western islands did not play nice with my visualizations, and made the choice to only plot the Contiguous United States for today \u2014 more on how to separate and manipulate Shapely Multipolygons another day.", "This is still not a very attractive choice of projection (forcing a globe onto a flat screen), but we are getting the gist of where the majority of the complaints are coming from \u2014 the most populated states. I wanted to even the playing field and account for population size:", "The choropleth auto-scales the coloring, so we must have a small state with a disproportionate amount of complaint submissions. A little digging shows that Washington, DC, leads the way with more 1.1 complaints per 100 residents.", "Lastly, I performed another groupby().count() to see which products have been the biggest cause for concern.", "We find Credit reporting twice in the top four most problematic products. This matches what we discovered in my previous blog, where the three big credit reporting agencies, Equifax, Experian, and Transunion, were the top three financial companies in terms of complaints.", "As always, you can check out the details on the GitHub repo. Happy coding!", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Data scientist with a background in business, education, and environmental science."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F3629478a1041&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-prep-with-spark-dataframes-3629478a1041&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-prep-with-spark-dataframes-3629478a1041&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-prep-with-spark-dataframes-3629478a1041&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-prep-with-spark-dataframes-3629478a1041&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----3629478a1041--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----3629478a1041--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@allison.stafford?source=post_page-----3629478a1041--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@allison.stafford?source=post_page-----3629478a1041--------------------------------", "anchor_text": "Allison Stafford"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F87b1f621568d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-prep-with-spark-dataframes-3629478a1041&user=Allison+Stafford&userId=87b1f621568d&source=post_page-87b1f621568d----3629478a1041---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F3629478a1041&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-prep-with-spark-dataframes-3629478a1041&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F3629478a1041&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-prep-with-spark-dataframes-3629478a1041&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@stphnwlkr?utm_source=medium&utm_medium=referral", "anchor_text": "Stephen Walker"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://towardsdatascience.com/exploring-financial-consumer-complaints-with-spark-48a253f9c830?source=friends_link&sk=66da638afb846bf78032a63afd8acc0c", "anchor_text": "last week\u2019s blog"}, {"url": "https://towardsdatascience.com/exploring-financial-consumer-complaints-with-spark-48a253f9c830?source=friends_link&sk=66da638afb846bf78032a63afd8acc0c", "anchor_text": "post"}, {"url": "https://spark.apache.org/docs/2.3.0/api/python/pyspark.sql.html#pyspark.sql.DataFrame", "anchor_text": "PySpark DataFrame"}, {"url": "https://spark.apache.org/docs/2.3.0/api/python/pyspark.sql.html#pyspark.sql.Column", "anchor_text": "PySpark Column"}, {"url": "https://spark.apache.org/docs/2.3.0/api/sql/index.html", "anchor_text": "PySpark Functions"}, {"url": "https://www.consumerfinance.gov/data-research/consumer-complaints/", "anchor_text": "US Federal Financial Services Consumer Complaint Database"}, {"url": "https://simplemaps.com/data/us-zips", "anchor_text": "SimpleMaps"}, {"url": "https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html", "anchor_text": "census.gov"}, {"url": "https://github.com/allisonhonold/spark-data-prep-blog", "anchor_text": "GitHub repo"}, {"url": "https://medium.com/tag/pyspark?source=post_page-----3629478a1041---------------pyspark-----------------", "anchor_text": "Pyspark"}, {"url": "https://medium.com/tag/python?source=post_page-----3629478a1041---------------python-----------------", "anchor_text": "Python"}, {"url": "https://medium.com/tag/data-preparation?source=post_page-----3629478a1041---------------data_preparation-----------------", "anchor_text": "Data Preparation"}, {"url": "https://medium.com/tag/spark?source=post_page-----3629478a1041---------------spark-----------------", "anchor_text": "Spark"}, {"url": "https://medium.com/tag/dataframes?source=post_page-----3629478a1041---------------dataframes-----------------", "anchor_text": "Dataframes"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F3629478a1041&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-prep-with-spark-dataframes-3629478a1041&user=Allison+Stafford&userId=87b1f621568d&source=-----3629478a1041---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F3629478a1041&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-prep-with-spark-dataframes-3629478a1041&user=Allison+Stafford&userId=87b1f621568d&source=-----3629478a1041---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F3629478a1041&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-prep-with-spark-dataframes-3629478a1041&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----3629478a1041--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F3629478a1041&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-prep-with-spark-dataframes-3629478a1041&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----3629478a1041---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----3629478a1041--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----3629478a1041--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----3629478a1041--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----3629478a1041--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----3629478a1041--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----3629478a1041--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----3629478a1041--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----3629478a1041--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@allison.stafford?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@allison.stafford?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Allison Stafford"}, {"url": "https://medium.com/@allison.stafford/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "386 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F87b1f621568d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-prep-with-spark-dataframes-3629478a1041&user=Allison+Stafford&userId=87b1f621568d&source=post_page-87b1f621568d--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fb4bbbb8c248&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdata-prep-with-spark-dataframes-3629478a1041&newsletterV3=87b1f621568d&newsletterV3Id=b4bbbb8c248&user=Allison+Stafford&userId=87b1f621568d&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}