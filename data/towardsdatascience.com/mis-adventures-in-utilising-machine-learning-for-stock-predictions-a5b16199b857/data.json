{"url": "https://towardsdatascience.com/mis-adventures-in-utilising-machine-learning-for-stock-predictions-a5b16199b857", "time": 1683002190.213204, "path": "towardsdatascience.com/mis-adventures-in-utilising-machine-learning-for-stock-predictions-a5b16199b857/", "webpage": {"metadata": {"title": "(Mis)adventures in using machine learning for equity portfolio selection | by Raphael Lee Cher Hern | Towards Data Science", "h1": "(Mis)adventures in using machine learning for equity portfolio selection", "description": "I recently built a machine learning model to predict and select a portfolio of outperforming equities, here are my (mis)adventures as I discovered the pains of preventing data leakage in multi-period forward forecasts."}, "outgoing_paragraph_urls": [{"url": "https://www.morningstar.com/", "anchor_text": "Morningstar", "paragraph_index": 4}, {"url": "http://www.linkedin.com/in/raphael-lee-cher-hern", "anchor_text": "Linkedin", "paragraph_index": 27}], "all_paragraphs": ["As a fledgling data scientist, I recently built a machine learning model to predict and select a portfolio of outperforming equities within the CSI 300 Index (top 300 equities by market capitalisation for the Shanghai and Shenzhen stock exchange).", "The results were promising, but not good enough. My model managed to select a portfolio of equities that consistently outperformed the benchmark index (accumulated excess returns of at least 5% over a 200 day period), but if brokerage costs and slippage were factored in\u2026 well, let\u2019s just say I\u2019m not putting my money on my model\u2019s predictions for now!", "So why am I writing this article? Well, because I\u2019ve tried in vain to search for articles/advice regarding some of the challenges I faced in the course of building this model, hence the (mis)adventures, and I sincerely hope that somewhere, someday, someone in the same situation can get some use out of this article. Or I find out that I\u2019m really bad at online searches. Either way, learning happens!", "To use a machine learning model fed with fundamental and technical indicators to predict and select a portfolio comprising equities from the CSI 300 Index that will outperform the benchmark index.", "The primary source of the data was from a trial subscription to Morningstar.", "These were all calculated for different period or permutation of periods.", "These were all derived from quarterly financial reports and normalised to their sector designations (using Morningstar\u2019s designation of sectors)", "To prevent data leakage, quarterly financial statement numbers would only be used one month after the end of that quarter, as that would be the latest that a listed company would have to publish their quarterly financial statement.", "Additionally, key economic indicators used were:", "To prevent data leakage, economic indicator numbers were only used on the next trading day after their publication.", "With only 10 quarters of financial statements to work with, the timeframe of my data that I could use for modelling was only from October 2017 to Nov 2019.", "Moreover, with missing fields in the financial statements for some companies, I only had 225 equities to work with, out of the 300 originally intended.", "Still, it was a decent chunk of data to work with. No issues! Yet\u2026", "Most, if not all, of what I managed to find in regards to equity prediction tended towards one-period forward predictions. Those that looked multiple periods ahead were generally of the auto-regression variety.", "Neither was what I had in mind for this model.", "I really wasn\u2019t looking to create a high/mid-frequency algorithmic strategy for this model, as I have generally taken a fundamental approach to trading. The primary intent of the model is to identify significant divergences between the actual traded price and supposed intrinsic value of an equity, and these corrections would take multiple periods (days, at least) to materialise, if they do at all.", "So assuming a holding period of 5 periods, it would make sense to base the target variable on the Close price of 5 periods ahead, right\u2026?", "Although I was using 240 periods for training and my X variables did not actually include the dates, this seemingly small leakage actually resulted in a massive (and wholly unwarranted) outperformance in my prediction results.", "Why not just drop the last 5 periods of X variables then? Because it resulted in a massive (and this time, wholly warranted) underperformance in my prediction results.", "Slicing the data for each training period ensures that Close prices that ought to be in the \u2018future\u2019 will be left out. We can then proceed to shift the Close prices forward, and use the last Close price of that period as the fill value.", "Over here, observations are labelled as the positive class 1 if the equity outperform the benchmark index by more than 5% at the end of the holding period of 5 days.", "These sliced sets of target variables are then added to a dictionary, which can be called by the model for each specific training period.", "I don\u2019t think this is an elegant solution by any measure, as there is definitely some concern that the target variable might be mislabelled when using these fill values. But weighing that consideration against the information gained from the last few days of the training period, I think it was worth it, as it definitely improved my model\u2019s results.", "Of course, if anyone can think of a more elegant solution, please do share!", "This seems like a good place to break, wrap up this article for now, and gauge if this has been helpful for or of interest to anyone. If so, I would be glad to regale the subsequent misadventures I had in the course of this project, such as trying to use GridSearch to tune hyperparameter for a classification model where the accuracy of the model\u2019s (discrete) predictions is not truly indicative of the actual (continuous) price of the equity portfolio. And maybe even some of the methodologies that worked.", "And because ultimately every equity selection model is evaluated on it\u2019s performance, here\u2019s mine thus far. The model\u2019s predictions (blue line) are yielding 10% accumulated excess returns above the benchmark index (orange line) over a 200 trading day period, but this is assuming no brokerage costs and trading slippage\u2026 so yeah, still a long way to go.", "Once more, I\u2019m just a fledgling data scientist and I\u2019m always keen to hear and learn from all of you here. This is still a work-in-progress, and I\u2019d definitely welcome any input or suggestions that the community has!", "Thanks for reading, and feel free to reach out to me on Linkedin anytime!", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Data Scientist with a background in Commodities Trading and Research"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fa5b16199b857&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmis-adventures-in-utilising-machine-learning-for-stock-predictions-a5b16199b857&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmis-adventures-in-utilising-machine-learning-for-stock-predictions-a5b16199b857&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmis-adventures-in-utilising-machine-learning-for-stock-predictions-a5b16199b857&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmis-adventures-in-utilising-machine-learning-for-stock-predictions-a5b16199b857&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----a5b16199b857--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----a5b16199b857--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@cherhern.lee?source=post_page-----a5b16199b857--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@cherhern.lee?source=post_page-----a5b16199b857--------------------------------", "anchor_text": "Raphael Lee Cher Hern"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F37f63dcfee8c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmis-adventures-in-utilising-machine-learning-for-stock-predictions-a5b16199b857&user=Raphael+Lee+Cher+Hern&userId=37f63dcfee8c&source=post_page-37f63dcfee8c----a5b16199b857---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fa5b16199b857&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmis-adventures-in-utilising-machine-learning-for-stock-predictions-a5b16199b857&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fa5b16199b857&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmis-adventures-in-utilising-machine-learning-for-stock-predictions-a5b16199b857&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://www.morningstar.com/", "anchor_text": "Morningstar"}, {"url": "http://www.linkedin.com/in/raphael-lee-cher-hern", "anchor_text": "Linkedin"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----a5b16199b857---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/equity?source=post_page-----a5b16199b857---------------equity-----------------", "anchor_text": "Equity"}, {"url": "https://medium.com/tag/stocks?source=post_page-----a5b16199b857---------------stocks-----------------", "anchor_text": "Stocks"}, {"url": "https://medium.com/tag/random-forest?source=post_page-----a5b16199b857---------------random_forest-----------------", "anchor_text": "Random Forest"}, {"url": "https://medium.com/tag/data-leak-prevention?source=post_page-----a5b16199b857---------------data_leak_prevention-----------------", "anchor_text": "Data Leak Prevention"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fa5b16199b857&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmis-adventures-in-utilising-machine-learning-for-stock-predictions-a5b16199b857&user=Raphael+Lee+Cher+Hern&userId=37f63dcfee8c&source=-----a5b16199b857---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fa5b16199b857&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmis-adventures-in-utilising-machine-learning-for-stock-predictions-a5b16199b857&user=Raphael+Lee+Cher+Hern&userId=37f63dcfee8c&source=-----a5b16199b857---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fa5b16199b857&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmis-adventures-in-utilising-machine-learning-for-stock-predictions-a5b16199b857&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----a5b16199b857--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fa5b16199b857&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmis-adventures-in-utilising-machine-learning-for-stock-predictions-a5b16199b857&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----a5b16199b857---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----a5b16199b857--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----a5b16199b857--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----a5b16199b857--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----a5b16199b857--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----a5b16199b857--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----a5b16199b857--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----a5b16199b857--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----a5b16199b857--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@cherhern.lee?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@cherhern.lee?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Raphael Lee Cher Hern"}, {"url": "https://medium.com/@cherhern.lee/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "46 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F37f63dcfee8c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmis-adventures-in-utilising-machine-learning-for-stock-predictions-a5b16199b857&user=Raphael+Lee+Cher+Hern&userId=37f63dcfee8c&source=post_page-37f63dcfee8c--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fda3e1d1b3a88&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmis-adventures-in-utilising-machine-learning-for-stock-predictions-a5b16199b857&newsletterV3=37f63dcfee8c&newsletterV3Id=da3e1d1b3a88&user=Raphael+Lee+Cher+Hern&userId=37f63dcfee8c&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}