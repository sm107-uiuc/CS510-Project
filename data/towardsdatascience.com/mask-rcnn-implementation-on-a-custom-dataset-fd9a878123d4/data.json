{"url": "https://towardsdatascience.com/mask-rcnn-implementation-on-a-custom-dataset-fd9a878123d4", "time": 1683018203.27795, "path": "towardsdatascience.com/mask-rcnn-implementation-on-a-custom-dataset-fd9a878123d4/", "webpage": {"metadata": {"title": "Mask RCNN implementation on a custom dataset! | by Dhruvil Shah | Towards Data Science", "h1": "Mask RCNN implementation on a custom dataset!", "description": "Instance segmentation is the function of pixel-level recognition of object outlines. It\u2019s one of the hardest possible vision tasks relative to equivalent computer vision tasks. Refer to the following\u2026"}, "outgoing_paragraph_urls": [{"url": "https://arxiv.org/pdf/1703.06870.pdf", "anchor_text": "here", "paragraph_index": 1}, {"url": "https://www.robots.ox.ac.uk/~vgg/software/via/via_demo.html", "anchor_text": "VGG Image Annotator (VIA)", "paragraph_index": 6}, {"url": "https://github.com/matterport/Mask_RCNN/tree/master/samples/balloon", "anchor_text": "original implementation of Mask RCNN", "paragraph_index": 33}, {"url": "http://LinkedIn.com/in/dhruvilshah28", "anchor_text": "LinkedIn.com/in/dhruvilshah28", "paragraph_index": 38}], "all_paragraphs": ["Instance segmentation is the function of pixel-level recognition of object outlines. It\u2019s one of the hardest possible vision tasks relative to equivalent computer vision tasks. Refer to the following terminologies:", "You can learn the basics and how Mask RCNN actually works from here.", "We will implement Mask RCNN for a custom dataset in just one notebook. All you need to do is run all the cells in the notebook. We will perform simple Horse vs Man classification in this notebook. You can change this to your own dataset.", "I have shared the links at the end of the article.", "First, we will clone a repository that contains some of the building code blocks for implementing Mask RCNN. The function copytree() will get the necessary files for you. After cloning the repository we will import the dataset. I am importing the dataset from my drive.", "Let\u2019s talk about the dataset now. The dataset that I imported from my drive is structured as:", "The dataset that I have used, is created from VGG Image Annotator (VIA). The annotation file is in .json format which contains the coordinates of all the polygons which I have drawn on my images. The .json file will look something like this:", "Note: Although I have shown more than one shape in the above snippet, you should only use one shape while annotating the images. For instance, if you choose polygons as I have for the Horse vs Man classifier then you should annotate all the regions with polygons only. We will discuss how you can use multiple shapes for annotations later in this tutorial.", "Note: This is the most important step for implementing the Mask RCNN architecture without getting any errors.", "You will face many errors in TensorFlow version 2.x. Also, the Keras version 2.2.5 will save us from many errors. I will not go into detail regarding which kinds of error this resolves.", "First, we will import a few libraries. Then we will give the path to the trained weights file. This could be the COCO weights file or your last saved weights file (checkpoint). The log directory is where all our data will be stored when training begins. The model weights at every epoch are saved in .h5 format in the directory so if the training gets hindered due to any reason you can always start from where you left off by specifying the path to the last saved model weights. For instance, if I am training my model for 10 epochs and at epoch 3 my training is obstructed then I will have 3 .h5 files stored in my logs directory. And now I do not have to start my training from the beginning. I can simply change my weights path to the last weights file e.g. \u2018mask_rcnn_object_0003.h5\u2019.", "CustomConfig class contains our custom configurations for the model. We simply overwrite the data in the original Config class from the config.py file that was imported earlier. The number of classes is supposed to be total_classes + 1 (for background). Steps per epoch are set to 100 but if you want you can increase if you have access to higher computing resources.", "The detection threshold is 90% that means all the proposals with less than 0.9 confidence will be ignored. This threshold is different than the one while testing an image. Look at the two images below for clarification.", "The class below contains 3 crucial methods for our custom dataset. This class inherits from \u201cutils.Dataset\u201d which we imported in the 1st step. The \u2018load_custom\u2019 method is for saving the annotations along with the image. Here we extract polygons and the respective classes.", "Polygons variable contains the coordinates of the masks. Objects variable contains the names of the respective classes.", "The \u2018load_mask\u2019 method loads the masks as per the coordinates of polygons. The mask of an image is nothing but a list containing binary values. Skimage.draw.polygon() does the task for us and returns the indices for the coordinates of the mask.", "Earlier we discussed that you should not use more than one shape while annotating as it will get intricate when loading masks.", "Although If you want to use multiple shapes i.e. circle, ellipse, and polygon then you will need to change the load mask function as below.", "This is one way you can load masks with multiple shapes but this is just speculation and the model will not detect a circle or ellipse unless it captures a perfect circle or ellipse.", "The dataset that I imported from my drive is structured as:", "First, we will create an instance of CustomDataset class for the training dataset. Similarly, create another instance for the validation dataset. Then we will call the load_custom() method by passing in the name of the directory where our data is stored. \u2018layers\u2019 parameter is set to \u2018heads\u2019 here as I am not planning to train all the layers in the model. This will only train some of the top layers in the architecture. If you want you can set \u2018layers\u2019 to \u2018all\u2019 for training all the layers in the model.", "I am running the model for only 10 only as this tutorial is supposed to just guide you.", "This step is for setting up the model for training and downloading and loading pre-trained weights. You can load the weights of COCO or your last saved model.", "The call \u2018modellib.MaskRCNN()\u2019 is the step where you can get lots of errors if you have not chosen the right versions in the 2nd section. This method has a parameter \u2018mode\u2019 which decides whether we want to train the model or test the model. If you want to test set \u2018mode\u2019 to \u2018inference\u2019. \u2018model_dir\u2019 is for saving the data while training for backup. Then, we download the pre-trained COCO weights in the next step.", "Note: If you want to resume training from a saved point then you need to change \u2018weights_path\u2019 to the path where your .h5 file is stored.", "This step should not throw any error if you have followed the steps above and training should start smoothly. Remember we need to have Keras version 2.2.5 for this step to run error-free.", "Note: If you get an error restart runtime and run all the cells again. It may be because of the version of TensorFlow or Keras loaded. Follow step 2 for choosing the right versions.", "Note: Ignore any warnings you get while training!", "You can find the instructions in the notebook on how to test our model once training is finished.", "Here, we define the path to our last saved weights file to run the inference on. Then, we define simple configuration terms. Here, confidence is specified again for testing. This is different from the one used in training.", "Now we will load the model to run inference.", "Now loading the weights in the model.", "Now, we are ready for testing our model on any image.", "For fun, you can try the below code which is present in the original implementation of Mask RCNN. This will convert everything grayscale except for the object mask areas.", "You can call this function as specified below. For video detection, call the second function.", "You can learn how Region Proposals work from the latter cells of the notebook. Below are some of the interesting images that might catch your eye if you are curious about how the Region Proposal Networks work.", "You may want to see how Proposal classification works and how we get our final regions for segmentation. This portion is also covered in the latter part of the notebook.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Data Science Enthusiast | Full Stack Developer | LinkedIn.com/in/dhruvilshah28"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Ffd9a878123d4&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmask-rcnn-implementation-on-a-custom-dataset-fd9a878123d4&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmask-rcnn-implementation-on-a-custom-dataset-fd9a878123d4&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmask-rcnn-implementation-on-a-custom-dataset-fd9a878123d4&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmask-rcnn-implementation-on-a-custom-dataset-fd9a878123d4&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----fd9a878123d4--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----fd9a878123d4--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@dhruvilshah28?source=post_page-----fd9a878123d4--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@dhruvilshah28?source=post_page-----fd9a878123d4--------------------------------", "anchor_text": "Dhruvil Shah"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fe0cd54e8f51c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmask-rcnn-implementation-on-a-custom-dataset-fd9a878123d4&user=Dhruvil+Shah&userId=e0cd54e8f51c&source=post_page-e0cd54e8f51c----fd9a878123d4---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ffd9a878123d4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmask-rcnn-implementation-on-a-custom-dataset-fd9a878123d4&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ffd9a878123d4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmask-rcnn-implementation-on-a-custom-dataset-fd9a878123d4&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@ethanhjy?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Ethan Hu"}, {"url": "https://unsplash.com/s/photos/horse-with-man?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Unsplash"}, {"url": "https://arxiv.org/pdf/1703.06870.pdf", "anchor_text": "here"}, {"url": "https://www.robots.ox.ac.uk/~vgg/software/via/via_demo.html", "anchor_text": "VGG Image Annotator (VIA)"}, {"url": "https://unsplash.com/@ethanhjy?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Ethan Hu"}, {"url": "https://unsplash.com/s/photos/horse-with-man?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Unsplash"}, {"url": "https://unsplash.com/@timothyeberly?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Timothy Eberly"}, {"url": "https://unsplash.com/s/photos/horse-with-man?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Unsplash"}, {"url": "https://github.com/matterport/Mask_RCNN/tree/master/samples/balloon", "anchor_text": "original implementation of Mask RCNN"}, {"url": "https://unsplash.com/@ethanhjy?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Ethan Hu"}, {"url": "https://unsplash.com/s/photos/horse-with-man?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Unsplash"}, {"url": "https://unsplash.com/@ethanhjy?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Ethan Hu"}, {"url": "https://unsplash.com/s/photos/horse-with-man?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Unsplash"}, {"url": "https://unsplash.com/@ethanhjy?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Ethan Hu"}, {"url": "https://unsplash.com/s/photos/horse-with-man?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Unsplash"}, {"url": "https://github.com/jackfrost1411/MaskRCNN", "anchor_text": "here"}, {"url": "https://www.linkedin.com/in/dhruvilshah28/", "anchor_text": "here"}, {"url": "https://arxiv.org/pdf/1703.06870.pdf", "anchor_text": "https://arxiv.org/pdf/1703.06870.pdf"}, {"url": "https://github.com/SriRamGovardhanam/wastedata-Mask_RCNN-multiple-classes", "anchor_text": "https://github.com/SriRamGovardhanam/wastedata-Mask_RCNN-multiple-classes"}, {"url": "https://github.com/matterport/Mask_RCNN", "anchor_text": "https://github.com/matterport/Mask_RCNN"}, {"url": "https://engineering.matterport.com/splash-of-color-instance-segmentation-with-mask-r-cnn-and-tensorflow-7c761e238b46", "anchor_text": "https://engineering.matterport.com/splash-of-color-instance-segmentation-with-mask-r-cnn-and-tensorflow-7c761e238b46"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----fd9a878123d4---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/tag/computer-vision?source=post_page-----fd9a878123d4---------------computer_vision-----------------", "anchor_text": "Computer Vision"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----fd9a878123d4---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----fd9a878123d4---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/data-science?source=post_page-----fd9a878123d4---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Ffd9a878123d4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmask-rcnn-implementation-on-a-custom-dataset-fd9a878123d4&user=Dhruvil+Shah&userId=e0cd54e8f51c&source=-----fd9a878123d4---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Ffd9a878123d4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmask-rcnn-implementation-on-a-custom-dataset-fd9a878123d4&user=Dhruvil+Shah&userId=e0cd54e8f51c&source=-----fd9a878123d4---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ffd9a878123d4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmask-rcnn-implementation-on-a-custom-dataset-fd9a878123d4&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----fd9a878123d4--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Ffd9a878123d4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmask-rcnn-implementation-on-a-custom-dataset-fd9a878123d4&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----fd9a878123d4---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----fd9a878123d4--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----fd9a878123d4--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----fd9a878123d4--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----fd9a878123d4--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----fd9a878123d4--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----fd9a878123d4--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----fd9a878123d4--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----fd9a878123d4--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@dhruvilshah28?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@dhruvilshah28?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Dhruvil Shah"}, {"url": "https://medium.com/@dhruvilshah28/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "172 Followers"}, {"url": "http://LinkedIn.com/in/dhruvilshah28", "anchor_text": "LinkedIn.com/in/dhruvilshah28"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fe0cd54e8f51c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmask-rcnn-implementation-on-a-custom-dataset-fd9a878123d4&user=Dhruvil+Shah&userId=e0cd54e8f51c&source=post_page-e0cd54e8f51c--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F2bf065f3ed8b&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmask-rcnn-implementation-on-a-custom-dataset-fd9a878123d4&newsletterV3=e0cd54e8f51c&newsletterV3Id=2bf065f3ed8b&user=Dhruvil+Shah&userId=e0cd54e8f51c&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}