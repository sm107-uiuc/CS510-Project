{"url": "https://towardsdatascience.com/python-trading-toolbox-05-backtesting-84266edb1d59", "time": 1683014801.567534, "path": "towardsdatascience.com/python-trading-toolbox-05-backtesting-84266edb1d59/", "webpage": {"metadata": {"title": "Python Trading Toolbox: a gentle introduction to backtesting | by Stefano Basurto | Towards Data Science", "h1": "Python Trading Toolbox: a gentle introduction to backtesting", "description": "We started this series by introducing some indicators based on price. Our goal is to use indicators, along with price and volume, to make investment decisions: to choose when to buy or sell a\u2026"}, "outgoing_paragraph_urls": [{"url": "https://en.wikipedia.org/wiki/Technical_analysis", "anchor_text": "Technical Analysis", "paragraph_index": 0}, {"url": "https://en.wikipedia.org/wiki/Algorithmic_trading", "anchor_text": "Algorithmic Trading", "paragraph_index": 0}, {"url": "https://www.investopedia.com/terms/b/backtesting.asp", "anchor_text": "backtesting", "paragraph_index": 3}, {"url": "https://www.zipline.io/", "anchor_text": "Zipline", "paragraph_index": 5}, {"url": "https://www.backtrader.com/", "anchor_text": "Backtrader", "paragraph_index": 5}, {"url": "https://uk.finance.yahoo.com/quote/CPB", "anchor_text": "Yahoo! Finance", "paragraph_index": 7}, {"url": "https://raw.githubusercontent.com/stebas101/TradingToolbox/master/data/CPB.csv", "anchor_text": "here", "paragraph_index": 7}, {"url": "https://www.investopedia.com/articles/03/081303.asp", "anchor_text": "corporate actions", "paragraph_index": 22}, {"url": "https://towardsdatascience.com/trading-toolbox-03-ohlc-charts-95b48bb9d748", "anchor_text": "OHLC bars or candlesticks", "paragraph_index": 33}, {"url": "https://github.com/matplotlib/mplfinance/blob/master/markdown/subplots.md#external-axes-method", "anchor_text": "External Axes Method", "paragraph_index": 34}], "all_paragraphs": ["We started this series by introducing some indicators based on price. Our goal is to use indicators, along with price and volume, to make investment decisions: to choose when to buy or sell a financial asset. There are different ways we can incorporate price, volume, and indicators in our investment decision process. The first, the most traditional, is to interpret their patterns in a discretional way, as followers of Technical Analysis do. Indicators can also be employed in a more quantitative approach as building blocks of a trading system that removes human discretion from the investment process. Algorithmic Trading, in particular, is an approach based on trading strategies that take positions in financial instruments on their own without human intervention. We can also use price, volume, and indicators as part of a more complex machine learning model for our investment decisions.", "An obvious disclaimer: the content of this post is for educational purposes only. All the examples here are suggested as a learning exercise and they should never be intended as investment advice.", "Whatever way we choose to use our indicators, we need to answer an important question: how good are our indicators, or combinations of indicators, to inform our investment decisions? In other words, will the use of any indicator lead to better results than not using them at all?", "A process that can help us to answer this question is known as backtesting. With backtesting, we apply a trading or investment strategy to historical data to generate hypothetical results. We can then analyze those results to evaluate the profitability and the risk of our strategy.", "This process has its own pitfalls: there is no guarantee that a strategy that performed well on historical data will perform well in real trading. Real trading involves many factors that cannot be simulated or tested on historical data. Also, since financial markets keep evolving fast, the future may exhibit patterns not present in historical data. However, if a strategy cannot prove itself valid in a backtest most probably will never work in real trading. Backtesting can at least help us to weed out the strategies that do not prove themselves worthy.", "Several frameworks make it easy to backtest trading strategies using Python. Two popular examples are Zipline and Backtrader. Frameworks like Zipline and Backtrader include all the tools needed to design, test, and implement an algorithmic trading strategy. They can even automate the submission of real orders to an execution broker.", "With this article, we are taking a different approach: we want to investigate how to build and test a trading system from scratch using Python, pandas, and NumPy as our only tools. Why should we want to do that? To start with, building a backtest from scratch is an excellent exercise and will help to understand in detail how a strategy works. Also, we may find ourselves in situations where we need to implement solutions not available in existing frameworks. Or, you may want to embark on the journey of creating your own backtesting framework!", "We can create a barebone backtest using Python with NumPy and pandas. To build an example, we are going to use prices for the Campbell Soup Company stock (CPB) traded on the NYSE. I downloaded five years of trading history from Yahoo! Finance: the file is available here.", "We start by setting up our environment and load the price series into a data frame:", "For our example, we are going to test a basic moving average crossover system based on a 20-day Exponential Moving Average (EMA) and a 200-day Simple Moving Average (SMA) of the daily closing price (using Adjusted Close in this example). We are going to buy the stock (take a long position) whenever the 20-day EMA crosses the 200-day SMA from below.", "We add columns with our moving averages to the data frame:", "As we can see, by using a 200-day SMA we get NaN values in the first 199 rows for the respective column. This is just an exercise, and we can just get rid of those rows to perform our backtest. In real practice, we may consider using a different indicator to avoid losing so much data. To remove the NaN values:", "Let\u2019s have a look at our data in a chart:", "To keep track of our positions in the data frame we add a column that contains, for each row, the number 1 for the days when we have a long position and the number 0 for the days when we have no position:", "Whatever rule we are trying to implement, it\u2019s a good idea to inspect our signals to make sure that everything works as intended. Pesky mistakes like to hide inside this kind of computations: it\u2019s way too easy to start testing a system, only to discover later that we did not implement our rules correctly. In particular, we need to be wary of introducing any form of look-ahead bias: this happens when we include in our trading rule data that is not actually available at the time the rule is evaluated. If a system backtest produces results that are too good to be true, look-ahead bias is the most likely culprit.", "We can inspect our signals by checking the numeric variables in our data frame and by plotting the signals on a chart.", "To select the days when the trading signal is triggered:", "We have only three signals in this case. To make sure that we are applying the crossover trading rule correctly, we can include the days before the signals in the selection:", "Everything looks good so far: on the days before the signal, ema20 is below sma200, and it crosses above on the signal days. We can do a similar inspection for the signals to exit our positions: I leave this exercise to you.", "We can plot markers for our signals on a chart:", "From the chart, we can see that there is a mismatch between Buy and Sell signals. The first signal is a Sell (without a Buy) since we start from a long position at the beginning of the series. The last signal is a Buy (without a Sell) because we keep a long position at the end of the series.", "We can now compute the return for our strategy as a percentage of the initial investment and compare it to the returns of a Buy and Hold strategy that simply buys our stock at the beginning of the period and holds it until the end.", "The price series that we are going to use to calculate the returns is Adjusted Close: by using an adjusted price we make sure that the effects of dividends, stock splits, and other corporate actions on returns are taken into account in our calculation.", "The returns for the whole period are simply a sum of the daily logarithmic returns (I will explain the maths later):", "Those returns are related to a period of 1060 days. If we want to compare them to returns from other periods we need to annualize them:", "Unless you are familiar with logarithmic returns, you may wonder why and how we used logarithms in the return calculations. Here is a bit of maths to explain that in case that sounds all new to you. Otherwise, feel free to skip to the next section.", "In quantitative finance it\u2019s very common to use logarithms to calculate returns: they make some computations easier to handle. If the daily return R_t is defined as:", "where P_t is the price at date \ud835\udc61, the logarithmic return \ud835\udc5f_\ud835\udc61 is defined as:", "By applying some basic algebra, it\u2019s possible to compute the daily log-return as:", "Why are log-returns handy? If we have a series of daily returns and we need to calculate the return for the whole period, with log returns we can make a sum of them. By contrast, with regular returns, we need to a multiplication:", "where T is the number of days in the period of time that we are considering. Calculating the annualized returns comes easier as well.", "The strategy we have just tested had only two possible positions: we were either long (holding the stock) or flat (holding just cash). It would be interesting to try and test a strategy that adds the possibility of a short position as well (selling borrowed shares and buying them back when exiting the position). To build an example of this strategy we include two simple moving averages, one for the daily highs, and one for the daily lows. We also add a 15-day exponential moving average. We take positions based on the following rules:", "I added the offset to the SMAs to reduce the numbers of false signals. Let\u2019s prepare a new data frame:", "Here we are making use of High and Low prices in addition to Close prices. To plot those values on a chart, it\u2019s a good idea to use OHLC bars or candlesticks. We are going to use the mplfinance library for this. If you have not done that yet, you can easily install mplfinance using:", "To integrate the candlestick chart with our existing style, I am going to apply the External Axes Method of mplfinance:", "We can examine more in detail any specific range of dates:", "We then apply our trading rule and add the position columns:", "We can plot our signals on the chart:", "This system has more signals than the previous one and the chart looks quite crowded. We can take a look at any date range in detail:", "We apply the same calculation as before to obtain the strategy\u2019s return:", "As before, we can annualize the returns:", "In this case, our strategy is actually worse better than the buy and hold strategy.", "You might have noted that I used the unadjusted price series to evaluate the signals, while I kept using adjusted prices to calculate returns. Evaluating signals using non-adjusted prices has the risk to introduce false triggers whenever dividends, splits, or other corporate actions create a gap in the prices. Here, I just used a price series that is commonly available and that everyone can download for free. If all we have is unadjusted prices, we should correct our backtest using all the information available about corporate actions.", "Is that all we need to perform backtests and to select strategies we can rely on? Definitely not: in our backtests, we made (although implicitly) some assumptions and simplifications that can substantially affect our results. To start with, we assumed that a stock can be bought at exactly the closing price of the day the signal is triggered. This is, in reality, not guaranteed: the actual price will be somewhere in the range of the day after the signal occurred. Then, transaction costs have to be included. For example:", "Some of those factors are more evident than others to understand and include in the model.", "When we want to evaluate the performance of a system and compare it to that of other systems, the return over a given period is only one of the many performance and risk metrics that we want to consider. Some examples are:", "The barebone backtests we have just introduced provides the starting point to calculate all those metrics and to build a more realistic system.", "For all those reasons, unless we want to build a complete system from scratch, if we need to backtest a strategy realistically the best option is most probably to use a complete solution like Zipline or Backtrader. However, I still keep learning a lot about indicators and strategies when writing a backtest from scratch, and this is an exercise I definitely recommend.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Passionate about exploring new ways to apply data science techniques to make better investment decisions and develop insights in markets."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F84266edb1d59&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpython-trading-toolbox-05-backtesting-84266edb1d59&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpython-trading-toolbox-05-backtesting-84266edb1d59&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpython-trading-toolbox-05-backtesting-84266edb1d59&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpython-trading-toolbox-05-backtesting-84266edb1d59&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----84266edb1d59--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----84266edb1d59--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@stebas101?source=post_page-----84266edb1d59--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@stebas101?source=post_page-----84266edb1d59--------------------------------", "anchor_text": "Stefano Basurto"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Faf1de1bdf68d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpython-trading-toolbox-05-backtesting-84266edb1d59&user=Stefano+Basurto&userId=af1de1bdf68d&source=post_page-af1de1bdf68d----84266edb1d59---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F84266edb1d59&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpython-trading-toolbox-05-backtesting-84266edb1d59&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F84266edb1d59&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpython-trading-toolbox-05-backtesting-84266edb1d59&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://towardsdatascience.com/tag/trading-toolbox", "anchor_text": "trading-toolbox"}, {"url": "https://unsplash.com/@mbaumi?utm_source=medium&utm_medium=referral", "anchor_text": "Mika Baumeister"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://en.wikipedia.org/wiki/Technical_analysis", "anchor_text": "Technical Analysis"}, {"url": "https://en.wikipedia.org/wiki/Algorithmic_trading", "anchor_text": "Algorithmic Trading"}, {"url": "https://www.investopedia.com/terms/b/backtesting.asp", "anchor_text": "backtesting"}, {"url": "https://www.zipline.io/", "anchor_text": "Zipline"}, {"url": "https://www.backtrader.com/", "anchor_text": "Backtrader"}, {"url": "https://uk.finance.yahoo.com/quote/CPB", "anchor_text": "Yahoo! Finance"}, {"url": "https://raw.githubusercontent.com/stebas101/TradingToolbox/master/data/CPB.csv", "anchor_text": "here"}, {"url": "https://www.investopedia.com/articles/03/081303.asp", "anchor_text": "corporate actions"}, {"url": "https://towardsdatascience.com/trading-toolbox-03-ohlc-charts-95b48bb9d748", "anchor_text": "OHLC bars or candlesticks"}, {"url": "https://github.com/matplotlib/mplfinance/blob/master/markdown/subplots.md#external-axes-method", "anchor_text": "External Axes Method"}, {"url": "https://www.investopedia.com/terms/d/drawdown.asp", "anchor_text": "Drawdown"}, {"url": "https://www.investopedia.com/terms/r/riskrewardratio.asp", "anchor_text": "Risk/Reward ratio"}, {"url": "https://medium.com/tag/trading-toolbox?source=post_page-----84266edb1d59---------------trading_toolbox-----------------", "anchor_text": "Trading Toolbox"}, {"url": "https://medium.com/tag/python?source=post_page-----84266edb1d59---------------python-----------------", "anchor_text": "Python"}, {"url": "https://medium.com/tag/trading-system?source=post_page-----84266edb1d59---------------trading_system-----------------", "anchor_text": "Trading System"}, {"url": "https://medium.com/tag/pandas?source=post_page-----84266edb1d59---------------pandas-----------------", "anchor_text": "Pandas"}, {"url": "https://medium.com/tag/finance?source=post_page-----84266edb1d59---------------finance-----------------", "anchor_text": "Finance"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F84266edb1d59&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpython-trading-toolbox-05-backtesting-84266edb1d59&user=Stefano+Basurto&userId=af1de1bdf68d&source=-----84266edb1d59---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F84266edb1d59&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpython-trading-toolbox-05-backtesting-84266edb1d59&user=Stefano+Basurto&userId=af1de1bdf68d&source=-----84266edb1d59---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F84266edb1d59&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpython-trading-toolbox-05-backtesting-84266edb1d59&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----84266edb1d59--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F84266edb1d59&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpython-trading-toolbox-05-backtesting-84266edb1d59&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----84266edb1d59---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----84266edb1d59--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----84266edb1d59--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----84266edb1d59--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----84266edb1d59--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----84266edb1d59--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----84266edb1d59--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----84266edb1d59--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----84266edb1d59--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@stebas101?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@stebas101?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Stefano Basurto"}, {"url": "https://medium.com/@stebas101/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "411 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Faf1de1bdf68d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpython-trading-toolbox-05-backtesting-84266edb1d59&user=Stefano+Basurto&userId=af1de1bdf68d&source=post_page-af1de1bdf68d--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F95600df64f18&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpython-trading-toolbox-05-backtesting-84266edb1d59&newsletterV3=af1de1bdf68d&newsletterV3Id=95600df64f18&user=Stefano+Basurto&userId=af1de1bdf68d&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}