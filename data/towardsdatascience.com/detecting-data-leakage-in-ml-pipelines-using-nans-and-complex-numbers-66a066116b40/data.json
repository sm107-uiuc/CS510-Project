{"url": "https://towardsdatascience.com/detecting-data-leakage-in-ml-pipelines-using-nans-and-complex-numbers-66a066116b40", "time": 1683011396.0527391, "path": "towardsdatascience.com/detecting-data-leakage-in-ml-pipelines-using-nans-and-complex-numbers-66a066116b40/", "webpage": {"metadata": {"title": "Detecting leakage in machine learning pipelines using NANs/complex numbers | by Abhay Pawar | Towards Data Science", "h1": "Detecting leakage in machine learning pipelines using NANs/complex numbers", "description": "In this post, I will share an amazingly simple way to detect data leakages using NANs and complex numbers while treating your pipeline as a blackbox..."}, "outgoing_paragraph_urls": [{"url": "https://github.com/abhayspawar/leak-detect", "anchor_text": "leak-detect", "paragraph_index": 23}, {"url": "https://github.com/abhayspawar/leak-detect", "anchor_text": "leak-detect", "paragraph_index": 23}, {"url": "https://github.com/abhayspawar/leak-detect/blob/master/leak-detect%20example.ipynb", "anchor_text": "leak-detect example.ipynb", "paragraph_index": 24}, {"url": "https://github.com/abhayspawar/leak-detect", "anchor_text": "github repo", "paragraph_index": 24}, {"url": "https://github.com/abhayspawar/leak-detect/blob/master/leak_detect/base.py", "anchor_text": "here", "paragraph_index": 25}, {"url": "http://twitter.com/abhayspawar", "anchor_text": "Twitter", "paragraph_index": 26}, {"url": "https://www.linkedin.com/in/abhayspawar/", "anchor_text": "Linkedin", "paragraph_index": 26}], "all_paragraphs": ["Data leakage in machine learning pipelines can cause havoc for your model. In this post, I\u2019m going to share an amazingly simple way to detect data leakages using NANs and complex numbers while treating your ML pipeline as a black box. I\u2019ll talk very briefly about what data leakage is. I\u2019ll also talk about leak-detect, a python package I\u2019m releasing to do all this in one line code.", "The most precise way to describe data leakage could be this:", "Data leakage in an ML model occurs when data used to create predictor variables during training time is unavailable at the time of inference.", "Clearly, using data(features) unavailable at inference time during training leads to model underperforming in production. This under-performance could mean millions of lost dollars depending on the scale of your company!", "What are some ways feature creation pipelines can introduce data leakage?", "First is generally easier to detect and keep track of. So, let\u2019s try to understand the second one using an example. Consider you are trying to predict stock price of a company after 5 days. Our data contains date and daily open price.", "We want to create various hand-made features for this task. Say, one feature we want is \u2018price on the previous day\u2019.", "But instead of doing .shift(1), let\u2019s say by mistake we did .shift(-1)and used values from the next row of open price as a feature. We just created \u2018price on the next day\u2019 instead. This is a leaky feature because it uses data from a future period.", "There are many best practices to follow to avoid leakage, but none of these can make you 100% sure that your pipeline is not leaky. This is where NANs and complex numbers come in! This methodology can be looked at as a unit test for data leakages.", "Before getting to the methodology, let\u2019s do an analogy first :).", "Let\u2019s say you have two tanks connected through a pipe which is closed. How can we detect that this pipe is indeed closed and is not leaky without inspecting the pipe? You can add color to one tank and check if the other tank also gets that color. Just like watercolors, NANs and complex numbers are ideal for leakage detection tasks because they have the ability to persist after any operation with real numbers. Operations like addition, subtraction, etc between a real number and NAN or complex number yield NAN or complex number respectively. Of course, there are exceptions to this and we will come to that later.", "In the stock price example, let\u2019s say we set open price on a specific day D to NAN and create our features using this data. \u2018Price on next day\u2019 (leaky feature) will have NAN value for day D-1, whereas \u2018price on previous day\u2019 (non-leaky) will have it for day D+1.", "So for the leaky feature, we will observe an extra NAN in the feature before day D. Essentially, if open-price on day D is being used to create a feature for days before D (which is leakage), we will see extra NAN in that feature before day D. This is true if the feature is being created using any operation which yields NAN when one input is NAN.", "What if we want to check if data from day D+1, D+2, etc is being used to create features for days before D? Well, we set them all to NAN and just count NANs in final features before day D.", "This methodology can be summarized in 4 simple steps:", "1. Define an imaginary leakage partition that splits your data into the upper and lower half. In our case, we don\u2019t want lower half data (future) to be used to create features for dates in the upper half (past).", "2. Run the data creation pipeline on raw data and count the number of NANs in all features in the upper half. Our data creation pipeline here creates both leaky and non-leaky features described above. Our non-leaky feature (previous day price) has 1 NAN because our data starts from 1-Jan-2020 and leaky one (price on next day) has 0 NANs.", "3. Now set all the columns in raw data used to create features to NAN below the leakage partition.", "4. Run the data creation pipeline on this raw data with NANs. Count the number of NANs above partition again. For our leaky feature, there\u2019s 1 extra NAN!", "The number of NANs in the upper half for non-leaky feature stayed the same but increased by 1 for the leaky feature. Where did this extra NAN come from? The only place it can come from is the lower half which is all NANs. And we just detected leakage in our leaky feature! This methodology works for any feature because it\u2019s not dependent on the definition of a feature.", "The same process above can be repeated by adding an imaginary component instead of replacing with NAN and counting the number of rows with an imaginary component. Pandas and numpy already support all operations with NANs and complex numbers. So, you don\u2019t have to change your code at all! Also, this detects leakage only in your pipelines and not leakages which might be already present in raw data.", "Why use both NANs and complex numbers?", "It\u2019s important to run this test with both NANs and complex numbers because your pipeline could be replacing NANs with a value. Or numpy converts complex numbers to real numbers for some operations. I\u2019ve tested it for different features that involve addition, multiplication, max, min operations and leakage detection works in all these cases. Still, it\u2019s important to keep an eye out for special cases.", "I\u2019m also releasing a python package:leak-detect to do all this with one line code! leak-detect can detect horizontal (from target to features) and vertical (from future to past) leakage occurring due to buggy code. In the example below, we are creating two leaky features which use data from the future: \u2018return_2day_leaky\u2019 and \u2018open_10day_before_leaky\u2019. Both get detected to have vertical leakage. It also prints out the number of previous rows data is leaking into. For the first feature, it\u2019s 2 because it uses price after 2 days.", "The leak-detect example.ipynb notebook in the repo lists more such examples. You can install the package by doing pip install leak-detect. Here\u2019s the github repo.", "Leak-detect works only on data similar to the stock price data. In your case, you could be using multiple datasets to create features or maybe even SQL. Whatever your pipeline is, the idea still remains the same. You would have to write your own custom functions which can be replicated by looking at leak-detect code here.", "Hope this is something that would be useful to you. Let me know if you have any thoughts in the comments! You can also reach out to me through abhayspawar on Twitter, Linkedin and Gmail. Thanks a lot for reading. Stay safe!", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "ML @ StitchFix, Instacart. Columbia and IIT Madras alum"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F66a066116b40&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdetecting-data-leakage-in-ml-pipelines-using-nans-and-complex-numbers-66a066116b40&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdetecting-data-leakage-in-ml-pipelines-using-nans-and-complex-numbers-66a066116b40&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdetecting-data-leakage-in-ml-pipelines-using-nans-and-complex-numbers-66a066116b40&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdetecting-data-leakage-in-ml-pipelines-using-nans-and-complex-numbers-66a066116b40&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----66a066116b40--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----66a066116b40--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://abhayspawar.medium.com/?source=post_page-----66a066116b40--------------------------------", "anchor_text": ""}, {"url": "https://abhayspawar.medium.com/?source=post_page-----66a066116b40--------------------------------", "anchor_text": "Abhay Pawar"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fe0c80b6d3c2&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdetecting-data-leakage-in-ml-pipelines-using-nans-and-complex-numbers-66a066116b40&user=Abhay+Pawar&userId=e0c80b6d3c2&source=post_page-e0c80b6d3c2----66a066116b40---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F66a066116b40&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdetecting-data-leakage-in-ml-pipelines-using-nans-and-complex-numbers-66a066116b40&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F66a066116b40&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdetecting-data-leakage-in-ml-pipelines-using-nans-and-complex-numbers-66a066116b40&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://github.com/abhayspawar/leak-detect", "anchor_text": "leak-detect"}, {"url": "https://github.com/abhayspawar/leak-detect", "anchor_text": "leak-detect"}, {"url": "https://github.com/abhayspawar/leak-detect/blob/master/leak-detect%20example.ipynb", "anchor_text": "leak-detect example.ipynb"}, {"url": "https://github.com/abhayspawar/leak-detect", "anchor_text": "github repo"}, {"url": "https://github.com/abhayspawar/leak-detect/blob/master/leak_detect/base.py", "anchor_text": "here"}, {"url": "http://twitter.com/abhayspawar", "anchor_text": "Twitter"}, {"url": "https://www.linkedin.com/in/abhayspawar/", "anchor_text": "Linkedin"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----66a066116b40---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/data-science?source=post_page-----66a066116b40---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/python?source=post_page-----66a066116b40---------------python-----------------", "anchor_text": "Python"}, {"url": "https://medium.com/tag/data-analysis?source=post_page-----66a066116b40---------------data_analysis-----------------", "anchor_text": "Data Analysis"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----66a066116b40---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F66a066116b40&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdetecting-data-leakage-in-ml-pipelines-using-nans-and-complex-numbers-66a066116b40&user=Abhay+Pawar&userId=e0c80b6d3c2&source=-----66a066116b40---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F66a066116b40&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdetecting-data-leakage-in-ml-pipelines-using-nans-and-complex-numbers-66a066116b40&user=Abhay+Pawar&userId=e0c80b6d3c2&source=-----66a066116b40---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F66a066116b40&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdetecting-data-leakage-in-ml-pipelines-using-nans-and-complex-numbers-66a066116b40&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----66a066116b40--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F66a066116b40&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdetecting-data-leakage-in-ml-pipelines-using-nans-and-complex-numbers-66a066116b40&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----66a066116b40---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----66a066116b40--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----66a066116b40--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----66a066116b40--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----66a066116b40--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----66a066116b40--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----66a066116b40--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----66a066116b40--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----66a066116b40--------------------------------", "anchor_text": ""}, {"url": "https://abhayspawar.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://abhayspawar.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Abhay Pawar"}, {"url": "https://abhayspawar.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "2.2K Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fe0c80b6d3c2&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdetecting-data-leakage-in-ml-pipelines-using-nans-and-complex-numbers-66a066116b40&user=Abhay+Pawar&userId=e0c80b6d3c2&source=post_page-e0c80b6d3c2--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F307fd235cc2f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdetecting-data-leakage-in-ml-pipelines-using-nans-and-complex-numbers-66a066116b40&newsletterV3=e0c80b6d3c2&newsletterV3Id=307fd235cc2f&user=Abhay+Pawar&userId=e0c80b6d3c2&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}