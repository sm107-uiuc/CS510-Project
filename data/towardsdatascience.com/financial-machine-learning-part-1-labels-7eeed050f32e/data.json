{"url": "https://towardsdatascience.com/financial-machine-learning-part-1-labels-7eeed050f32e", "time": 1682995431.707587, "path": "towardsdatascience.com/financial-machine-learning-part-1-labels-7eeed050f32e/", "webpage": {"metadata": {"title": "Financial Machine Learning Part 1: Labels | by Maks Ivanov | Towards Data Science", "h1": "Financial Machine Learning Part 1: Labels", "description": "In the previous post, we\u2019ve explored several approaches for aggregating raw data for a financial instrument to create observations called bars. In this post, we will focus on the next crucial stage\u2026"}, "outgoing_paragraph_urls": [{"url": "https://towardsdatascience.com/financial-machine-learning-part-0-bars-745897d4e4ba", "anchor_text": "previous post", "paragraph_index": 0}, {"url": "https://www.amazon.com/Advances-Financial-Machine-Learning-Marcos/dp/1119482089", "anchor_text": "Advances in Financial Machine Learning", "paragraph_index": 1}, {"url": "http://www.quantresearch.org/", "anchor_text": "Marcos Lopez de Prado", "paragraph_index": 1}, {"url": "https://www.bitmex.com/app/seriesGuide/XBT", "anchor_text": "BitMex:XBT", "paragraph_index": 5}, {"url": "https://gist.github.com/maks-ivanov/e668c47addfa69e86da5a44e3f634dd5", "anchor_text": "code snippet", "paragraph_index": 5}, {"url": "https://www.investopedia.com/video/play/explaining-long-and-short-position/", "anchor_text": "long and short bets", "paragraph_index": 13}, {"url": "https://en.wikipedia.org/wiki/Precision_and_recall", "anchor_text": "recall", "paragraph_index": 27}, {"url": "https://arxiv.org/pdf/1106.1813.pdf", "anchor_text": "synthetic minority over-sampling technique", "paragraph_index": 29}, {"url": "https://en.wikipedia.org/wiki/F1_score", "anchor_text": "F1 score", "paragraph_index": 34}, {"url": "http://linkedin.com/in/maksivanov", "anchor_text": "linkedin.com/in/maksivanov", "paragraph_index": 40}], "all_paragraphs": ["In the previous post, we\u2019ve explored several approaches for aggregating raw data for a financial instrument to create observations called bars. In this post, we will focus on the next crucial stage of the machine learning pipeline \u2014 labeling observations. As a reminder, labels in machine learning denote the outcomes of the random variable that we would like to predict.", "Just like in the rest of this series, the techniques shown in this post are based on Advances in Financial Machine Learning by Marcos Lopez de Prado. I recommend checking out the book for a much more detailed treatment of the subject. With that said, it\u2019s time to jump in and swim around.", "In the financial context, a simple approach for a supervised learning problem is to try to predict the price of an instrument at some fixed horizon in the future. Note that this is a regression task, i.e. we\u2019d attempt to predict a continuous random variable. This is a hard problem to solve because prices are notoriously noisy and serially correlated, and the set of all possible price values is technically infinite. On the other hand, we can approach this as a classification problem \u2014 instead of predicting the exact price, we can predict discretized returns.", "Most financial literature uses fixed-horizon labeling methods, i.e. the observations are labeled according to returns some fixed number of steps in the future. The labels are discretized by profit and loss thresholds:", "This labeling method is a good start, but it has two addressable problems.", "To address the first problem, we can set dynamic thresholds as a function of rolling volatility. We\u2019re assuming that we already have OHLC bars at this point. I use the dollar bars of BitMex:XBT, the bitcoin perpetual swap contract from the previous post \u2014 this code snippet will help you catch up if you are starting from scratch.", "Here we will estimate hourly volatility of returns to compute profit and loss thresholds. Below you\u2019ll find a slightly modified function directly from Lopez De Prado, with comments added for clarity:", "To better incorporate the stop-loss and take-profit scenarios of a hypothetical trading strategy, we will modify the fixed-horizon labeling method so that it reflects which barrier has been touched first \u2014 upper, lower, or horizon. Hence the name: the triple-barrier method.", "The labeling schema is defined as follows:", "y=1 : top barrier is hit first", "y=0 : right barrier is hit first", "y=-1 : bottom barrier is hit first", "What about the side of the bet?", "The schema above works fine for long-only strategies, however things get more complicated when we allow for both long and short bets. If we are betting short, our profit/loss is inverted relative to the price action \u2014 we profit if the price goes down and we lose when the price goes up.", "In order to account for this, we can simply represent side as 1 for long and -1 for short. Thus we can multiply our returns by the side, so whenever we\u2019re betting short the negative returns become positive and vice-versa. Effectively, we flip the y=1 and y=-1 labels if side=-1.", "Let\u2019s take a shot at the implementation (based on MLDP\u2019s code).", "First, we define the procedure for getting the timestamps of the horizon barriers:", "Now that we have our horizon barriers, we define a function to set upper and lower barriers based on the volatility estimates computed earlier:", "Finally, we define a function to compute the labels:", "On a conceptual level, our goal is to place bets where we expect to win and not to place bets where we don\u2019t expect to win, which reduces to a binary classification problem (where the losing case includes both betting on the wrong direction and not betting at all when we should have). Here\u2019s another way to look at the labels we just generated:", "A binary classification problem presents a trade-off between type-I errors (false positives) and type-II errors (false negatives). Increasing the true positive rate usually comes at the cost of increasing the false positive rate.", "To characterize this more formally, let us first define:", "y\u0302 \u2208 {0, 1, -1} : prediction of the primary model for the observation", "r : price return for the observation", "Then at prediction time the confusion matrix of the primary model looks like the one below.", "We are not too worried about the false negatives \u2014 we might miss a few bets but at least we\u2019re not losing money. We are most concerned about the false positives \u2014 this is where we lose money.", "To reflect this, our meta-labels y* can be defined according to the diagram:", "In effect, the primary model should have high recall \u2014 it should identify more of the true positives correctly at the expense of many false positives. The secondary model will then filter out the false positives of the first model.", "First, we create a primary model. Before we do so, an important preprocessing step is to make sure that our training data has balanced labels.", "The labels in the original dataset are heavily dominated by 0 values, so if we train on those, we get a degenerate model that predicts 0 every time. We deal with this by applying the synthetic minority over-sampling technique to create a new training dataset where the label counts are roughly equal.", "Next we fit a logistic regression model to our resampled training data. Note that at this point we should not expect our model to do well because we haven\u2019t generated any features, but we should still see an improved F1 score when using meta-labeling over the baseline model.", "We can see that our model predicts more 1\u2019s and -1\u2019s than there are in our test data. The blue portions of the leftmost and rightmost columns represent the false positives, which we intend to eliminate by meta-labeling and training the secondary model.", "Let\u2019s map our triple-barrier predictions into binary positive/negative meta-labels introduced earlier and check the confusion matrix:", "As expected, we see no false negatives and a lot of false positives. We will try to reduce the false positives without adding too many false negatives.", "The results in the secondary model show that we introduce a few false negatives, but we eliminate over 30% of false positives from the primary model. While it isn\u2019t always a worthy trade-off, remember the context of trading \u2014 we miss out on some trading opportunities (false negatives), but that is a cheap price to pay for cutting down many trades that blow up in our faces (false positives). The classification report confirms our intuition that the efficiency of the classifier improves as measured by the F1 score.", "While neither model is great, remember that we are merely demonstrating a technique for improving classifier efficiency, which can conceivably work well on a larger dataset, better model, and more powerful features.", "In general, the interpretation of meta-labeling + secondary model is to predict the confidence level of the primary model. In our example, both the primary and the secondary models were data-driven, but this doesn\u2019t always have to be the case.", "In addition to improving F1 scores, meta-labeling has another extremely powerful application \u2014 it can add a machine learning layer on top of non-ML models, including econometric forecasts, fundamental analysis, technical signals, and even discretionary strategies. This offers a powerful combination of human intuition/expertise and quantitative edge that is favored by many asset managers for its explainability and robustness.", "Labeling observations is a crucial component for supervised learning. In this demo, we\u2019ve developed an approach for labeling observations of a financial asset, as well as a meta-labeling technique to help achieve better F1 scores in classification problems. I encourage you to combine these labeling techniques with other datasets and parameters, and share your results. Thanks for reading and feel free to reach out with comments/suggestions!", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "linkedin.com/in/maksivanov | Opinions are my own"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F7eeed050f32e&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffinancial-machine-learning-part-1-labels-7eeed050f32e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffinancial-machine-learning-part-1-labels-7eeed050f32e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffinancial-machine-learning-part-1-labels-7eeed050f32e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffinancial-machine-learning-part-1-labels-7eeed050f32e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----7eeed050f32e--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----7eeed050f32e--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@maks.ivanov?source=post_page-----7eeed050f32e--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@maks.ivanov?source=post_page-----7eeed050f32e--------------------------------", "anchor_text": "Maks Ivanov"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Faf72e8ccb37d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffinancial-machine-learning-part-1-labels-7eeed050f32e&user=Maks+Ivanov&userId=af72e8ccb37d&source=post_page-af72e8ccb37d----7eeed050f32e---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F7eeed050f32e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffinancial-machine-learning-part-1-labels-7eeed050f32e&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F7eeed050f32e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffinancial-machine-learning-part-1-labels-7eeed050f32e&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://towardsdatascience.com/financial-machine-learning-part-0-bars-745897d4e4ba", "anchor_text": "previous post"}, {"url": "https://www.amazon.com/Advances-Financial-Machine-Learning-Marcos/dp/1119482089", "anchor_text": "Advances in Financial Machine Learning"}, {"url": "http://www.quantresearch.org/", "anchor_text": "Marcos Lopez de Prado"}, {"url": "https://www.bitmex.com/app/seriesGuide/XBT", "anchor_text": "BitMex:XBT"}, {"url": "https://gist.github.com/maks-ivanov/e668c47addfa69e86da5a44e3f634dd5", "anchor_text": "code snippet"}, {"url": "https://www.investopedia.com/video/play/explaining-long-and-short-position/", "anchor_text": "long and short bets"}, {"url": "https://en.wikipedia.org/wiki/Precision_and_recall", "anchor_text": "recall"}, {"url": "https://arxiv.org/pdf/1106.1813.pdf", "anchor_text": "synthetic minority over-sampling technique"}, {"url": "https://en.wikipedia.org/wiki/F1_score", "anchor_text": "F1 score"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----7eeed050f32e---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/trading?source=post_page-----7eeed050f32e---------------trading-----------------", "anchor_text": "Trading"}, {"url": "https://medium.com/tag/visualization?source=post_page-----7eeed050f32e---------------visualization-----------------", "anchor_text": "Visualization"}, {"url": "https://medium.com/tag/finance?source=post_page-----7eeed050f32e---------------finance-----------------", "anchor_text": "Finance"}, {"url": "https://medium.com/tag/cryptocurrency?source=post_page-----7eeed050f32e---------------cryptocurrency-----------------", "anchor_text": "Cryptocurrency"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F7eeed050f32e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffinancial-machine-learning-part-1-labels-7eeed050f32e&user=Maks+Ivanov&userId=af72e8ccb37d&source=-----7eeed050f32e---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F7eeed050f32e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffinancial-machine-learning-part-1-labels-7eeed050f32e&user=Maks+Ivanov&userId=af72e8ccb37d&source=-----7eeed050f32e---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F7eeed050f32e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffinancial-machine-learning-part-1-labels-7eeed050f32e&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----7eeed050f32e--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F7eeed050f32e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffinancial-machine-learning-part-1-labels-7eeed050f32e&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----7eeed050f32e---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----7eeed050f32e--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----7eeed050f32e--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----7eeed050f32e--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----7eeed050f32e--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----7eeed050f32e--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----7eeed050f32e--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----7eeed050f32e--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----7eeed050f32e--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@maks.ivanov?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@maks.ivanov?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Maks Ivanov"}, {"url": "https://medium.com/@maks.ivanov/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "721 Followers"}, {"url": "http://linkedin.com/in/maksivanov", "anchor_text": "linkedin.com/in/maksivanov"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Faf72e8ccb37d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffinancial-machine-learning-part-1-labels-7eeed050f32e&user=Maks+Ivanov&userId=af72e8ccb37d&source=post_page-af72e8ccb37d--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F12726023061d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffinancial-machine-learning-part-1-labels-7eeed050f32e&newsletterV3=af72e8ccb37d&newsletterV3Id=12726023061d&user=Maks+Ivanov&userId=af72e8ccb37d&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}