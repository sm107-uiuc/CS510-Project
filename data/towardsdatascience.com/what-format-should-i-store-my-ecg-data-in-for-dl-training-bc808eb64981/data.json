{"url": "https://towardsdatascience.com/what-format-should-i-store-my-ecg-data-in-for-dl-training-bc808eb64981", "time": 1683003917.597013, "path": "towardsdatascience.com/what-format-should-i-store-my-ecg-data-in-for-dl-training-bc808eb64981/", "webpage": {"metadata": {"title": "What format should I store my ECG data in for DL training? | by Emily P. | Towards Data Science", "h1": "What format should I store my ECG data in for DL training?", "description": "Historically, we saved data so we could read it. Now, with rapid advances in data science, machines are reading our data. We\u2019re shifting from humans accessing small data to deep learning scripts\u2026"}, "outgoing_paragraph_urls": [{"url": "https://en.wikipedia.org/wiki/Hierarchical_Data_Format", "anchor_text": "Hierarchical Data Format", "paragraph_index": 17}, {"url": "https://strace.io/", "anchor_text": "strace", "paragraph_index": 19}, {"url": "https://www.h5py.org/", "anchor_text": "h5py", "paragraph_index": 19}, {"url": "https://support.hdfgroup.org/HDF5/doc/H5.format.html#Btrees", "anchor_text": "HDF uses", "paragraph_index": 21}, {"url": "https://www.geeksforgeeks.org/introduction-of-b-tree-2/", "anchor_text": "B-Tree", "paragraph_index": 21}, {"url": "https://github.com/PureStorage-OpenConnect/fleet-format/", "anchor_text": "Fleet GitHub page", "paragraph_index": 40}], "all_paragraphs": ["Historically, we saved data so we could read it. Now, with rapid advances in data science, machines are reading our data. We\u2019re shifting from humans accessing small data to deep learning scripts accessing large volumes of data repeatedly.", "It\u2019s the difference between loading a patient\u2019s x-ray on a monitor to visually assess it versus running the x-ray 1,000 times through a neural network that converts the raw image to vectors, crops it, rotates it, blurs it, and then tries to identify a pneumothorax.", "That\u2019s why we\u2019ve seen increasing usage of GPUs for deep learning \u2014 we need to perform more and more math on our data. The compute elements in a GPU are designed for massive, data-parallel math operations that are the foundation of modern graphics pipelines. And, as it turns out, the math behind deep learning workflows.", "While GPUs perform the complex math of deep learning, each training job is a pipeline with steps before that GPU work.", "In training, before the data enters the neural network, it gets preprocessed in a series of manipulations. Preprocessing often includes a series of tasks: indexing (listing) the items in a training dataset, shuffling them, actually loading them from storage, and then performing distortions. Preprocessing usually occurs on CPUs (frequently, on the CPUs within a GPU server).", "So data has to move from where it\u2019s stored, through a CPU, to the GPUs for computation.", "The data load itself is often the cause of the largest throughput bottleneck for training pipelines.", "If you were loading a patient\u2019s x-ray to look at it, you might find a 0.04 sec data load time acceptable. You\u2019d hardly notice the latency because your \u201creview\u201d time might be several minutes long.", "On the other hand, a GPU server that only takes 0.001 sec to \u201creview\u201d the image would be slowed down by a 0.04 sec data load time. And the delay compounds. With massive training datasets that contain not 1 item but thousands\u2013or millions\u2013and iterative computations (e.g. 20 epochs in a single job), data loading delays are incurred a lot of times.", "Regardless of how fast your GPUs are, your training job can only be as fast as your data load time.", "So, there\u2019s a massive performance benefit in ensuring that data loading is efficient.", "This post describes our project with Geisinger\u2019s Department of Imaging Science and Innovation to optimize training throughput for a dataset of electrocardiogram results. We produced a simulated dataset matched in data size and type for optimization testing.", "A good place to start a DL performance investigation is to check the ratio between duration of data load work and duration of training work.", "After we ran this basic task breakdown, we saw that data load time was significantly larger than training time. This is highly inefficient because, with a train:load ratio of 1:4, our GPUs are idle for \u00be of the job duration.", "Every batch, 75% of the GPU time was spent idle while we waited for the next batch to load.", "We need to be loading data a lot faster.", "Our synthetic training data represented logs from 15-lead ECG tests: 15x 5GB HDF5 files, each with 1,000,000 records (patients). Each file represented a single ECG channel, inside of which a \u2018patient_id\u2019 was the key and that channel\u2019s results were its record.", "We were treating HDF5 like a key-value store, but the file format is actually designed to support more complex data structures. HDF (Hierarchical Data Format) is great for storing large numerical datasets that have extensive metadata. It enables grouping within the file, effectively making an HDF file a portable file system. HDF is primarily used for scientific datasets in HPC use cases.", "A downside of that functionality, however, is that there\u2019s significant overhead per read of an HDF5 file.", "We can use strace to snoop on the system calls that occur when we issue a single read (issued via the h5py python library).", "\u2018lseek\u2019 is used to move the file pointer to specific locations within the file, then \u2018read\u2019 is used for actually reading data. The final line is a read of 4992 bytes to retrieve one value in the key-value pairs that comprise our HDF5 file. The prior 5 reads are of metadata (pointers) inside the file that are required to locate the desired data.", "Why are there so many metadata reads? Because HDF uses a B-Tree structure to help increase performance of its file-system-like metadata queries. Just like on a filesystem, knowing where to look for data can be a harder problem than moving the data into a CPU.", "After seeing how many redundant system calls are needed for HDF reads, we were convinced that there was a more read-performant way to save our simplistic dataset. We weren\u2019t really using the hierarchical functionality that gives HDF its name.", "As a thought experiment, we started with the question, \u201cWhat\u2019s the best possible layout for key-value data inside a file for maximum read throughput?\u201d", "1. We don\u2019t need to save complex metadata", "The only descriptive information we\u2019re using for the records is the key.", "Let\u2019s move away from the functionality in HDF that we\u2019re not making use of.", "2. Fast reads for both individual records and for collecting the list of keys", "As is common during training jobs, our scripts start by shuffling the dataset. The dataset\u2019s contents must be enumerated before those items can be shuffled. Since this enumeration step occurs at the beginning of every job, we don\u2019t want to build in front-end delays by having slow key collection (which we had seen with HDF5).", "3. The larger the IO, the better", "We\u2019d prefer to train from datasets saved on remote storage. Why? First, data management is simpler, and we don\u2019t have to spend time copying datasets to local devices ahead of time. Second, our dataset was too large to fit in local memory in its entirety, so we\u2019d have to manage some data sharding process if we trained from a local storage location.", "So, since we\u2019ll be issuing reads that have to go out over the network to storage, we might as well optimize the cost of that network round trip by making the read size larger.", "We started by combining data from all 15 ECG leads into a single record. This change both simplifies our dataset and helps increase IO size; now reading a single patient\u2019s ECG result can be collected in 1 trip over the network, not 15.", "Each record contains an array of data from all 15 ECG leads:", "We can associate a single result to the ECG lead number it came from simply by its position in the array.", "The block of keys contains [key_id, value_location] for each record. Now we can jump (`lseek`) directly to a specific record\u2019s data inside the file.", "We store an array of all the keys together at the end of the file. Upon opening the file, we read a header which contains file configuration information like schema specs and, most importantly, the location of the key block within the file. Key loading is extremely efficient because we can jump straight to the starting location of the key block and then read all the keys at once.", "In HDF5 files, the keys were spread randomly throughout the file. Having contiguous keys in our new file format allows large, sequential reads of the key block, minimizing network overhead.", "The resulting file format, which we\u2019ve named \u201cFleet\u201d and are making available on GitHub, gave 30x higher read throughput than HDF5 for our workload. Even better, our train:load ratio was now above 1:1 (for both remote storage and local storage). We can efficiently train with our ECG data in-place on NFS.", "We think such a lightweight file format is optimal for a large numeric datasets being curated for deep learning training. If grouping were necessary, additional Fleet files could be created to represent each group.", "Fleet is an open source file format. You can find the code and several helper scripts on the Fleet GitHub page.", "While training scripts that consume JPEG images or tensor records have been tested and tuned extensively in the AI ecosystem, training on other file formats will likely require some performance analysis to optimize overall job throughput.", "Sometimes the format of a training dataset may introduce read patterns or compute demands that slow the overall training job. In this case, we optimized training performance by switching to a lightweight, read-optimized file format.", "As we continue to apply deep learning methods to a wider range of use cases and datasets, we should continue to ask ourselves, \u201cWhat would our data look like if we solved for optimal training throughput?\u201d", "This investigation was a project run with my colleague Brian Gold at Pure Storage and with the Department of Imaging Science and Innovation at Geisinger. Thanks especially to David Vanmaanen, Sush Raghunath, and Alvaro Ulloa Cerna.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fbc808eb64981&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhat-format-should-i-store-my-ecg-data-in-for-dl-training-bc808eb64981&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhat-format-should-i-store-my-ecg-data-in-for-dl-training-bc808eb64981&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhat-format-should-i-store-my-ecg-data-in-for-dl-training-bc808eb64981&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhat-format-should-i-store-my-ecg-data-in-for-dl-training-bc808eb64981&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----bc808eb64981--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----bc808eb64981--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@aihelper?source=post_page-----bc808eb64981--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@aihelper?source=post_page-----bc808eb64981--------------------------------", "anchor_text": "Emily P."}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fff882220c17d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhat-format-should-i-store-my-ecg-data-in-for-dl-training-bc808eb64981&user=Emily+P.&userId=ff882220c17d&source=post_page-ff882220c17d----bc808eb64981---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fbc808eb64981&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhat-format-should-i-store-my-ecg-data-in-for-dl-training-bc808eb64981&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fbc808eb64981&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhat-format-should-i-store-my-ecg-data-in-for-dl-training-bc808eb64981&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@nci?utm_source=medium&utm_medium=referral", "anchor_text": "National Cancer Institute"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://en.wikipedia.org/wiki/Hierarchical_Data_Format", "anchor_text": "Hierarchical Data Format"}, {"url": "https://strace.io/", "anchor_text": "strace"}, {"url": "https://www.h5py.org/", "anchor_text": "h5py"}, {"url": "https://support.hdfgroup.org/HDF5/doc/H5.format.html#Btrees", "anchor_text": "HDF uses"}, {"url": "https://www.geeksforgeeks.org/introduction-of-b-tree-2/", "anchor_text": "B-Tree"}, {"url": "https://github.com/PureStorage-OpenConnect/fleet-format/", "anchor_text": "Fleet GitHub page"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----bc808eb64981---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/tag/ai?source=post_page-----bc808eb64981---------------ai-----------------", "anchor_text": "AI"}, {"url": "https://medium.com/tag/data?source=post_page-----bc808eb64981---------------data-----------------", "anchor_text": "Data"}, {"url": "https://medium.com/tag/data-science?source=post_page-----bc808eb64981---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/healthcare?source=post_page-----bc808eb64981---------------healthcare-----------------", "anchor_text": "Healthcare"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fbc808eb64981&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhat-format-should-i-store-my-ecg-data-in-for-dl-training-bc808eb64981&user=Emily+P.&userId=ff882220c17d&source=-----bc808eb64981---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fbc808eb64981&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhat-format-should-i-store-my-ecg-data-in-for-dl-training-bc808eb64981&user=Emily+P.&userId=ff882220c17d&source=-----bc808eb64981---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fbc808eb64981&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhat-format-should-i-store-my-ecg-data-in-for-dl-training-bc808eb64981&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----bc808eb64981--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fbc808eb64981&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhat-format-should-i-store-my-ecg-data-in-for-dl-training-bc808eb64981&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----bc808eb64981---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----bc808eb64981--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----bc808eb64981--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----bc808eb64981--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----bc808eb64981--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----bc808eb64981--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----bc808eb64981--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----bc808eb64981--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----bc808eb64981--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@aihelper?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@aihelper?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Emily P."}, {"url": "https://medium.com/@aihelper/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "179 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fff882220c17d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhat-format-should-i-store-my-ecg-data-in-for-dl-training-bc808eb64981&user=Emily+P.&userId=ff882220c17d&source=post_page-ff882220c17d--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F726ef29b5f75&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhat-format-should-i-store-my-ecg-data-in-for-dl-training-bc808eb64981&newsletterV3=ff882220c17d&newsletterV3Id=726ef29b5f75&user=Emily+P.&userId=ff882220c17d&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}