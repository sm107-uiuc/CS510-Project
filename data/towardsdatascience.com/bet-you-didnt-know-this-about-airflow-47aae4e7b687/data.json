{"url": "https://towardsdatascience.com/bet-you-didnt-know-this-about-airflow-47aae4e7b687", "time": 1683018235.80653, "path": "towardsdatascience.com/bet-you-didnt-know-this-about-airflow-47aae4e7b687/", "webpage": {"metadata": {"title": "Bet you didn\u2019t know this about Airflow! | by Jyoti Dhiman | Towards Data Science", "h1": "Bet you didn\u2019t know this about Airflow!", "description": "We are living in the Airflow era. Almost all of us started our scheduling journey with cronjobs and the transition to a workflow scheduler like Airflow has given us better handling with complex\u2026"}, "outgoing_paragraph_urls": [{"url": "https://aws.amazon.com/blogs/aws/introducing-amazon-managed-workflows-for-apache-airflow-mwaa/", "anchor_text": "airflow", "paragraph_index": 0}, {"url": "https://towardsdatascience.com/delta-lake-with-spark-what-and-why-6d08bef7b963", "anchor_text": "Delta Lake", "paragraph_index": 15}], "all_paragraphs": ["We are living in the Airflow era. Almost all of us started our scheduling journey with cronjobs and the transition to a workflow scheduler like Airflow has given us better handling with complex inter-dependent pipelines, UI based scheduling, retry mechanism, alerts & what not! AWS also recently announced managed airflow workflows. These are truly exciting times and today, Airflow has really changed the scheduling landscape, with scheduling configuration as a code.", "Now, coming to a use case where I really dug down in airflow capabilities. For the below use case, all the references to task are for airflow tasks.", "The above DAG consists of the following operations:", "So, in a nutshell, one task is submitting the spark job to the cluster and its downstream sensor task is polling the state of the upstream task to get job status. Since the pipeline includes EMR, this might be a little different from the scenario in a running cluster where you can submit the spark job directly from airflow using spark-submit and BashOperator and single task indicates job state.", "I didn\u2019t want to handle this in code or via markers and was looking to take care of the same in the DAG itself. Additionally, I also wanted to add a retry mechanism to the user_etl pipeline, so in case user_etl_sensor fails, retry user_etl(which is an upstream task).", "What did I want? For a DAG run, if user_etl_sensor fails, user_etl is submitted again to the cluster n times as a retry mechanism and if it still fails, then in the next DAG run, user_etl job is not submitted to the cluster.", "For these \u201cinter-dependent\u201d task use cases, I could not simply use airflow parameters mentioned below, directly.", "As a retry mechanism, I thought if I can clear the state of the upstream task(user_etl), on user_etl_sensor failure, I might be able to submit the job to the cluster n times and that\u2019s what I implemented withon_retry_callback on the user_etl_sensor task with 2 retries and programmatically cleared the state of the user_etl task on sensor failure.", "So now, user_etl_sensor fails > goes into retry state > function mentioned as on_retry_callback is called > function clears the state of user_etl > job gets submitted to the cluster again > sensor goes into running state again.", "Now, coming to controlling the next scheduled run of user_step if the previous run of the user_etl_sensor has failed even after retries. I thought of programmatically mark user_etl to failed(in the same DAG run) if user_etl_sensor fails.", "By doing so, I can use depends_on_past=True on user_etl and the task won\u2019t be triggered in the next DAG run because user_etl is marked failed on the previous run. It\u2019ll behave like only one task is controlling the submission of the job and the running state of the job and that\u2019s what I did, using on_failure_callback.", "retry_upstream_task function is passed as on_retry_callback:", "mark_upstream_failed function is passed as on_failure_callback:", "These callbacks can be added on user_etl_sensor as shown below:", "Pretty cool, isn\u2019t it? That\u2019s how I explored the configuration as code. This \u201cPythonic\u201d task state control can be applied to any airflow sensor operator which inherits BaseSensorOperator not just dealing with EMR based jobs or basically any use case of working with interdependent tasks.", "This user_etl pipeline in my case was a Delta Lake based pipeline and if the next scheduled run has \u201crun\u201d with the previous run failed, it might have caused data inconsistencies. I really like the flexibility airflow allowed me to convert my logic to code and actually achieve it.", "In the callbacks, I looped over all the tasks to get the task object to make changes in its state i.e. marking the task as failed or clearing the task for the retry functionality. I am researching more to get the task object directly from task_id, instead of looping over, will edit the post if I find a better way to do it.", "Ciao from my DAG, which, Airflow says, is fresh as a Daisy :)", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F47aae4e7b687&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbet-you-didnt-know-this-about-airflow-47aae4e7b687&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbet-you-didnt-know-this-about-airflow-47aae4e7b687&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbet-you-didnt-know-this-about-airflow-47aae4e7b687&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbet-you-didnt-know-this-about-airflow-47aae4e7b687&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----47aae4e7b687--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----47aae4e7b687--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://mycupoftea00.medium.com/?source=post_page-----47aae4e7b687--------------------------------", "anchor_text": ""}, {"url": "https://mycupoftea00.medium.com/?source=post_page-----47aae4e7b687--------------------------------", "anchor_text": "Jyoti Dhiman"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F8c38262e7804&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbet-you-didnt-know-this-about-airflow-47aae4e7b687&user=Jyoti+Dhiman&userId=8c38262e7804&source=post_page-8c38262e7804----47aae4e7b687---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F47aae4e7b687&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbet-you-didnt-know-this-about-airflow-47aae4e7b687&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F47aae4e7b687&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbet-you-didnt-know-this-about-airflow-47aae4e7b687&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@commonboxturtle?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Conor Brown"}, {"url": "https://unsplash.com/s/photos/daisy?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Unsplash"}, {"url": "https://aws.amazon.com/blogs/aws/introducing-amazon-managed-workflows-for-apache-airflow-mwaa/", "anchor_text": "airflow"}, {"url": "https://aws.amazon.com/emr/?nc=sn&loc=0&whats-new-cards.sort-by=item.additionalFields.postDateTime&whats-new-cards.sort-order=desc", "anchor_text": "here"}, {"url": "https://towardsdatascience.com/delta-lake-with-spark-what-and-why-6d08bef7b963", "anchor_text": "Delta Lake"}, {"url": "https://github.com/apache/airflow/blob/b6bf25306243e78bf12528f9a080ea100a575641/airflow/utils/state.py", "anchor_text": "apache/airflowApache Airflow - A platform to programmatically author, schedule, and monitor workflows - apache/airflowgithub.com"}, {"url": "https://forum.astronomer.io/t/how-can-i-set-my-on-failure-and-on-success-callbacks-to-have-the-task-context/182", "anchor_text": "How can I set my on_failure and on_success callbacks to have the task context?If you want to perform some actions in response to a DAG's final state, failure or success, then these\u2026forum.astronomer.io"}, {"url": "https://medium.com/tag/airflow?source=post_page-----47aae4e7b687---------------airflow-----------------", "anchor_text": "Airflow"}, {"url": "https://medium.com/tag/big-data?source=post_page-----47aae4e7b687---------------big_data-----------------", "anchor_text": "Big Data"}, {"url": "https://medium.com/tag/programming?source=post_page-----47aae4e7b687---------------programming-----------------", "anchor_text": "Programming"}, {"url": "https://medium.com/tag/data-science?source=post_page-----47aae4e7b687---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/data-engineering?source=post_page-----47aae4e7b687---------------data_engineering-----------------", "anchor_text": "Data Engineering"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F47aae4e7b687&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbet-you-didnt-know-this-about-airflow-47aae4e7b687&user=Jyoti+Dhiman&userId=8c38262e7804&source=-----47aae4e7b687---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F47aae4e7b687&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbet-you-didnt-know-this-about-airflow-47aae4e7b687&user=Jyoti+Dhiman&userId=8c38262e7804&source=-----47aae4e7b687---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F47aae4e7b687&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbet-you-didnt-know-this-about-airflow-47aae4e7b687&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----47aae4e7b687--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F47aae4e7b687&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbet-you-didnt-know-this-about-airflow-47aae4e7b687&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----47aae4e7b687---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----47aae4e7b687--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----47aae4e7b687--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----47aae4e7b687--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----47aae4e7b687--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----47aae4e7b687--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----47aae4e7b687--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----47aae4e7b687--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----47aae4e7b687--------------------------------", "anchor_text": ""}, {"url": "https://mycupoftea00.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://mycupoftea00.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Jyoti Dhiman"}, {"url": "https://mycupoftea00.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "546 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F8c38262e7804&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbet-you-didnt-know-this-about-airflow-47aae4e7b687&user=Jyoti+Dhiman&userId=8c38262e7804&source=post_page-8c38262e7804--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F1157276dcbca&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbet-you-didnt-know-this-about-airflow-47aae4e7b687&newsletterV3=8c38262e7804&newsletterV3Id=1157276dcbca&user=Jyoti+Dhiman&userId=8c38262e7804&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}