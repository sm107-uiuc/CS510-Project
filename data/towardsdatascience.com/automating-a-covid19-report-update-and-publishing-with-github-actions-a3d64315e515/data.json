{"url": "https://towardsdatascience.com/automating-a-covid19-report-update-and-publishing-with-github-actions-a3d64315e515", "time": 1683017382.228976, "path": "towardsdatascience.com/automating-a-covid19-report-update-and-publishing-with-github-actions-a3d64315e515/", "webpage": {"metadata": {"title": "Automating a COVID19 report update and publishing with GitHub Actions | by Luis Chaves | Towards Data Science", "h1": "Automating a COVID19 report update and publishing with GitHub Actions", "description": "Each article in the series is self-contained, meaning that you don\u2019t need to read the whole series to make the most out of it. \u00b7 Introduction \u00b7 Pipeline building blocks \u2014 Steps \u2218 Structure of a\u2026"}, "outgoing_paragraph_urls": [{"url": "https://github.com/lc5415/COVID19", "anchor_text": "[Project repo]", "paragraph_index": 0}, {"url": "https://lucha6.shinyapps.io/COVIDEDA/", "anchor_text": "here", "paragraph_index": 4}, {"url": "https://ourworldindata.org/coronavirus", "anchor_text": "Our World in Data", "paragraph_index": 4}, {"url": "https://github.com/r-lib/actions", "anchor_text": "R-lib/actions", "paragraph_index": 5}, {"url": "https://github.com/actions", "anchor_text": "GitHub actions", "paragraph_index": 5}, {"url": "https://towardsdatascience.com/interactive-covid19-report-with-rmarkdown-plotly-leaflet-and-shiny-c6a716af7d9b#02e7", "anchor_text": "the steps to generate these keys", "paragraph_index": 17}, {"url": "https://docs.github.com/en/free-pro-team@latest/actions/reference/encrypted-secrets", "anchor_text": "GitHub Secrets", "paragraph_index": 18}, {"url": "https://docs.github.com/en/free-pro-team@latest/actions/reference/encrypted-secrets", "anchor_text": "ref", "paragraph_index": 20}, {"url": "https://docs.github.com/en/free-pro-team@latest/actions/reference/events-that-trigger-workflows", "anchor_text": "in the GitHub docs", "paragraph_index": 23}, {"url": "https://crontab.guru/#0_12_*/3_*_*", "anchor_text": "crontab.guru", "paragraph_index": 26}, {"url": "http://www.cronmaker.com/;jsessionid=node0w0ng6duahmbu1kfovqkfva2b4364730.node0?0", "anchor_text": "cronmaker", "paragraph_index": 26}, {"url": "https://github.com/actions/cache", "anchor_text": "https://github.com/actions/cache", "paragraph_index": 27}, {"url": "https://docs.github.com/en/free-pro-team@latest/actions/guides/caching-dependencies-to-speed-up-workflows", "anchor_text": "in the GH docs", "paragraph_index": 30}, {"url": "https://github.com/ad-m/github-push-action#usage", "anchor_text": "https://github.com/ad-m/github-push-action", "paragraph_index": 31}, {"url": "https://github.com/ad-m/github-push-action#example-workflow-file", "anchor_text": "repo\u2019s README", "paragraph_index": 31}, {"url": "https://github.com/lc5415/COVID19/blob/master/.github/workflows/automate.yml", "anchor_text": "here", "paragraph_index": 32}], "all_paragraphs": ["This post is part 4 of a series of 4 publications[Project repo]:", "Each article in the series is self-contained, meaning that you don\u2019t need to read the whole series to make the most out of it.", "\u00b7 Introduction\u00b7 Pipeline building blocks \u2014 Steps \u2218 Structure of a Github Action .yml file \u2218 Setup repo, R and pandoc \u2218 Install dependencies \u2218 Report steps \u2014 update data, run scripts, publish \u2218 Publishing and secret tokens\u00b7 When to run the pipeline \u2014 Trigger \u2218 At event \u2218 On schedule \u2014 using cron\u00b7 Making your pipeline even better \u2014 Extras \u2218 Cache dependencies \u2218 Committing back the latest changes to your repo", "If you have never used GitHub Actions you are in for a treat. Github Actions is a fairly recent feature from GitHub which allows you to automate workflows, such as testing code or package deployment. GitHub actions are a powerful tool for continuous integration and continuous development, which enables you to outsource the testing of your code to isolated machines and to various operating systems that you may not have at hand.", "In this article, I will show you how to use GH Actions for something a bit less usual than code testing. GH Actions provide us with an isolated environment where we can run any code, hence they are perfect for a report publishing pipeline like the one we are going to build here. In the previous articles of this series, I built an interactive COVID-19 report using Shiny that you can visit here. Building this project, I split the code into 3 stages. First, the most recent COVID data gets downloaded from Our World in Data and cleaned. Next, I wrote several scripts to make a variety of plots (treemaps, line plots and maps). Finally, I wrote a deployable Shiny RMarkdown document and uploaded it through the RStudio IDE or from the command line. Because this workflow was already designed in a step-wise manner, the steps for automating it are clear. Here, I will showcase the basics of GitHub Actions and how I use them in this particular instance to update my COVID report without even noticing!", "The structure of a GitHub Action YAML file is very intuitive. First, it needs a name, one or several jobs to run and a set of instruction on when to run the job (the on section \u2014 e.g. when there\u2019s a push to master). Each job is usually broken down into steps, for which we can either use a pre-made GitHub Action (like those available in the R-lib/actions or the GitHub actions repositories) or run bash commands as we would from the command line. We also need to specify the type of machine we wish to run our jobs in (macOS, Ubuntu, Windows\u2026). That leaves us with a backbone that will look something like this:", "Now that we know the basics, let\u2019s learn by doing!", "I write code in a MacBook, so I will use macOS as my default OS to avoid potential compatibility problems. Furthermore, I will be using a single R version (R 4.0.2 \u2014 the one I have installed in my computer) for the same reason.", "I want everything to run like it would in my computer but without actually running it on my computer", "If you are planning to use GHA for testing a package, using several OS and several R versions is recommended to ensure compatibility of your code with whatever setup the users of your package may be running. Our jobs section thus starts like this:", "The first step you will see in most GHA YAML files is a call to the checkout action written by the GitHub teams themselves. This action clones your repository from the respective branch that has triggered it:", "Next, we need to set-up an R installation in our GHA machine to run our scripts. We will also need pandoc (the multi-language rendering engine that powers RMarkdown) to compile our Shiny RMarkdown report. We are going to be using actions from the core R team for this, hence we know they are reliable.", "As you can see the uses: section is simply specifying the path to a GitHub profile (r-lib), a repo within that profile (r-lib/actions) and a specific action and its version under that repo (r-lib/actions/setup-pandoc@v1). Also, it is worth mentioning the syntax used to specify the r-version from the settings we specified earlier. When we use ${{ }} we can refer to an object we have defined within the YAML file, in this particular instance the R version from the matrix we set. Had we specified several R versions (let\u2019s say 3), the GHA would automatically launch 3 independent jobs and run the rest of the steps in parallel in their respective R versions. Pretty awesome if you ask me!", "Now that we have our fundamental set up, we need to install the specific tools for our specific task, i.e. R packages. We do this the same way you would do it from your computer:", "Note here we have written the run: section in R and specified to run this in a Rscript shell. If you don\u2019t like that flavour you could write it up like so:", "That simple! In my experience, this step took the longest as it had to install a lot of packages. Though there is a way to store the dependencies that I will cover later for \u201cpro\u201d users :)", "Now we just need to run the R scripts that we previously made. The first R script that we wrote last time, downloads the updated data from Our World in Data and the other ones make plots out of that data. Here having a reliable data source (one that does not change often) and good code will avoid having to troubleshoot our GHA pipeline in the long run. As promised we just need to run our R scripts:", "To be able to publish our Shiny document (could be a Shiny App too), the Shiny server needs to verify we are legitimate. A token and a secret are used to verify the identity of whoever is trying to upload a document to the server. In my previous post, I broke down the steps to generate these keys. I am going to create a new set of keys but you could also re-use the keys you use for your local R or RStudio. After creating the keys, you should be shown something like so:", "One, of course, would not want to simply add this R code within your YAML file. That would expose your private keys and allow anyone that finds these to change your documents and apps hosted in your shiny server. We are going to use GitHub Secrets \ud83d\udd12, which allows users to store keys and passwords for an individual repo or for an entire organization in a secure way.", "Next, our actions YAML section will look like this:", "This method of passing secrets to scripts is the one endorsed by Github[ref]. I was initially worried about this being a potentially vulnerable way of passing the private keys to our actions file. I thought someone could print this out with an echo command and reveal the keys in the logs, but GitHub has some way to prevent that behaviour luckily (see below)", "Finally, we need to run a single line of R code to deploy our updated report, just like we would from our computer:", "You may not want to trigger an action every time you commit a change, or may not want to trigger actions if you are working in a branch. You can specify what triggers your actions in the on: section of your YAML file. A common on: section looks like this:", "Note that if you are using the newest GH repos your master branch will probably be called main. The section above will trigger our action whenever we push new changes to master or submit a pull request to the master branch. You can read more about what events trigger an action in the GitHub docs.", "Being able to validate your workflows every time you submit changes to your master branch is a must-have for whatever codebase you are working on. Sometimes though, like in our case, you may have a workflow that you wish to run recurrently even if no changes have been performed in your code. GitHub Actions support cron jobs, which do exactly that! Our updated on: section now looks like:", "The above section specifies to run our action \u201cAt 12:00 on every 3rd day-of-month.\u201d. To me, this is the most useful feature in the entire action file. Every 3 days, the updated data from Our World in Data will be pulled, the scripts we wrote will be re-run and our interactive report will be updated without us even noticing! \u2014 Freeing time through automation \ud83d\udd4a \ud83d\ude4c", "I would highly recommend using the crontab.guru or cronmaker to define and understand your cron job schedules.", "Certain steps of your workflows may take a long time to be computed but may actually not change much over time. Package \ud83d\udce6 dependencies are a perfect example of this. Downloading and installing several packages over a network connection every single time we run our action is a waste of time and resources (remember that the cloud \u2601\ufe0f still burns fuel \ud83d\udd25). For this, GitHub Actions offers a caching tool (https://github.com/actions/cache). The cache allows us to store the state of a given file or directory (in our case the R libraries directory) so that it can simply be loaded from memory the next time we need it.", "To cache our dependencies we simply need to add the following blocks in our YAML:", "The block above will store the state of the directory specified by path: (line 5), with the key value of macOS-shinydoc . The restore-keys: argument is optional, it provides a list of key pattern to search for if an exact match is not found. Additionally, we need to add an if: section to our \u201cInstall dependencies\u201d step to ensure that dependencies are re-installed only if a cache-hit does not occur.", "Our cached files will be erased after one week of inactivity. You can read more about cache in the GH docs.", "Finally, you may wish to commit your latest changes after the action is completed. In my case, I don\u2019t wish to do so as the only files that will be modified will be the data (csv and rds files) and the plots (png images), though I would understand if other people would like to have this option. You can accomplish this using the push-action (https://github.com/ad-m/github-push-action). An example action file is provided in the repo\u2019s README.", "As always, I hope you have learned something useful with this walkthrough \ud83d\ude04. I personally find it mind-boggling that such a powerful tool is available for free and I also like the fact that the community can contribute by providing custom-made high-quality actions! You can find the complete actions file I use in my project here.", "If you are interested in learning more about GitHub Actions or have any problems with your workflows please feel free to post a comment or contact me directly via Twitter @lu_cha_", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "I am passionate about computer science and biology. I graduated as a biomedical engineer but I am now exploring data science and machine learning!"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fa3d64315e515&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fautomating-a-covid19-report-update-and-publishing-with-github-actions-a3d64315e515&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fautomating-a-covid19-report-update-and-publishing-with-github-actions-a3d64315e515&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fautomating-a-covid19-report-update-and-publishing-with-github-actions-a3d64315e515&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fautomating-a-covid19-report-update-and-publishing-with-github-actions-a3d64315e515&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----a3d64315e515--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----a3d64315e515--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://lucharo.medium.com/?source=post_page-----a3d64315e515--------------------------------", "anchor_text": ""}, {"url": "https://lucharo.medium.com/?source=post_page-----a3d64315e515--------------------------------", "anchor_text": "Luis Chaves"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F9980528d4b06&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fautomating-a-covid19-report-update-and-publishing-with-github-actions-a3d64315e515&user=Luis+Chaves&userId=9980528d4b06&source=post_page-9980528d4b06----a3d64315e515---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fa3d64315e515&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fautomating-a-covid19-report-update-and-publishing-with-github-actions-a3d64315e515&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fa3d64315e515&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fautomating-a-covid19-report-update-and-publishing-with-github-actions-a3d64315e515&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://github.com/lc5415/COVID19", "anchor_text": "[Project repo]"}, {"url": "https://towardsdatascience.com/create-an-interactive-covid-19-report-using-r-host-it-for-free-and-automate-its-update-41a5bdd46e9d", "anchor_text": "part 1"}, {"url": "https://rpubs.com/lucha6/covid-cleaning-owid-data", "anchor_text": "part 2"}, {"url": "https://towardsdatascience.com/interactive-covid19-report-with-rmarkdown-plotly-leaflet-and-shiny-c6a716af7d9b", "anchor_text": "part 3"}, {"url": "https://lucha6.shinyapps.io/COVIDEDA/", "anchor_text": "here"}, {"url": "https://ourworldindata.org/coronavirus", "anchor_text": "Our World in Data"}, {"url": "https://github.com/r-lib/actions", "anchor_text": "R-lib/actions"}, {"url": "https://github.com/actions", "anchor_text": "GitHub actions"}, {"url": "https://towardsdatascience.com/interactive-covid19-report-with-rmarkdown-plotly-leaflet-and-shiny-c6a716af7d9b#02e7", "anchor_text": "the steps to generate these keys"}, {"url": "https://docs.github.com/en/free-pro-team@latest/actions/reference/encrypted-secrets", "anchor_text": "GitHub Secrets"}, {"url": "https://docs.github.com/en/free-pro-team@latest/actions/reference/encrypted-secrets", "anchor_text": "ref"}, {"url": "https://docs.github.com/en/free-pro-team@latest/actions/reference/events-that-trigger-workflows", "anchor_text": "in the GitHub docs"}, {"url": "https://crontab.guru/#0_12_*/3_*_*", "anchor_text": "crontab.guru"}, {"url": "http://www.cronmaker.com/;jsessionid=node0w0ng6duahmbu1kfovqkfva2b4364730.node0?0", "anchor_text": "cronmaker"}, {"url": "https://github.com/actions/cache", "anchor_text": "https://github.com/actions/cache"}, {"url": "https://docs.github.com/en/free-pro-team@latest/actions/guides/caching-dependencies-to-speed-up-workflows", "anchor_text": "in the GH docs"}, {"url": "https://github.com/ad-m/github-push-action#usage", "anchor_text": "https://github.com/ad-m/github-push-action"}, {"url": "https://github.com/ad-m/github-push-action#example-workflow-file", "anchor_text": "repo\u2019s README"}, {"url": "https://github.com/lc5415/COVID19/blob/master/.github/workflows/automate.yml", "anchor_text": "here"}, {"url": "https://medium.com/tag/automation?source=post_page-----a3d64315e515---------------automation-----------------", "anchor_text": "Automation"}, {"url": "https://medium.com/tag/github?source=post_page-----a3d64315e515---------------github-----------------", "anchor_text": "Github"}, {"url": "https://medium.com/tag/github-actions?source=post_page-----a3d64315e515---------------github_actions-----------------", "anchor_text": "Github Actions"}, {"url": "https://medium.com/tag/continuous-integration?source=post_page-----a3d64315e515---------------continuous_integration-----------------", "anchor_text": "Continuous Integration"}, {"url": "https://medium.com/tag/continuous-delivery?source=post_page-----a3d64315e515---------------continuous_delivery-----------------", "anchor_text": "Continuous Delivery"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fa3d64315e515&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fautomating-a-covid19-report-update-and-publishing-with-github-actions-a3d64315e515&user=Luis+Chaves&userId=9980528d4b06&source=-----a3d64315e515---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fa3d64315e515&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fautomating-a-covid19-report-update-and-publishing-with-github-actions-a3d64315e515&user=Luis+Chaves&userId=9980528d4b06&source=-----a3d64315e515---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fa3d64315e515&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fautomating-a-covid19-report-update-and-publishing-with-github-actions-a3d64315e515&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----a3d64315e515--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fa3d64315e515&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fautomating-a-covid19-report-update-and-publishing-with-github-actions-a3d64315e515&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----a3d64315e515---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----a3d64315e515--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----a3d64315e515--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----a3d64315e515--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----a3d64315e515--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----a3d64315e515--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----a3d64315e515--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----a3d64315e515--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----a3d64315e515--------------------------------", "anchor_text": ""}, {"url": "https://lucharo.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://lucharo.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Luis Chaves"}, {"url": "https://lucharo.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "46 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F9980528d4b06&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fautomating-a-covid19-report-update-and-publishing-with-github-actions-a3d64315e515&user=Luis+Chaves&userId=9980528d4b06&source=post_page-9980528d4b06--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F3a6792600e4d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fautomating-a-covid19-report-update-and-publishing-with-github-actions-a3d64315e515&newsletterV3=9980528d4b06&newsletterV3Id=3a6792600e4d&user=Luis+Chaves&userId=9980528d4b06&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}