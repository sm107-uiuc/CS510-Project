{"url": "https://towardsdatascience.com/dealing-with-class-imbalanced-image-datasets-1cbd17de76b5", "time": 1683006944.8161988, "path": "towardsdatascience.com/dealing-with-class-imbalanced-image-datasets-1cbd17de76b5/", "webpage": {"metadata": {"title": "Dealing with class imbalanced image datasets using the Focal Tversky Loss | by Robin Vinod | Towards Data Science", "h1": "Dealing with class imbalanced image datasets using the Focal Tversky Loss", "description": "Class imbalanced image datasets and how they can be addressed using Weighted Binary Cross Entropy or the Dice Coefficient. A look at the Focal Tversky Loss and how it it is a better solution."}, "outgoing_paragraph_urls": [{"url": "https://arxiv.org/abs/1706.05721", "anchor_text": "Tversky loss function for image segmentation using 3D fully convolutional deep networks", "paragraph_index": 21}, {"url": "https://arxiv.org/abs/1810.07842", "anchor_text": "A Novel Focal Tversky loss function with improved Attention U-Net for lesion segmentation", "paragraph_index": 27}, {"url": "https://github.com/robinvvinod/unet/", "anchor_text": "https://github.com/robinvvinod/unet/", "paragraph_index": 31}, {"url": "https://www.linkedin.com/in/robin-vinod/", "anchor_text": "https://www.linkedin.com/in/robin-vinod/", "paragraph_index": 33}], "all_paragraphs": ["Class imbalanced datasets is a frequent problem experienced when trying to train segmentation networks. The first time I trained an image segmentation model, I was getting over 96% accuracy straight off the bat. Either I unknowingly made the biggest breakthrough since the inception of the first CNN, or there was something wrong with my approach.", "I quickly realised that the pixels to be segmented accounted for a very small percentage of the total pixels in the image. All the model had to do was predict a fully black image (a.k.a no segmentation) and it was rewarded with over 90% accuracy. This is a common problem encountered in most image segmentation tasks, where the background class is much larger than the other classes.", "In this story, I go through the techniques used to deal with class imbalanced problems and why the Focal Tverky Loss might be the best option for you.", "Once of the losses typically used to deal with class imbalance is the weighted binary cross entropy. The crux of the normal binary cross entropy is that it considers all pixels equally when calculating the loss. In a mask where 90% of the pixels are 0s and only 10% are 1, the network receives receives a low loss even if it misses all the 1s, which means the network is not learning anything.", "Weighted binary cross entropy (WBCE) attempts to solve this by weighting the positive class.", "For every class 1 predicted by the network, BCE adds log(p) to the loss while WBCE adds \ud835\udf37 log(p) to the loss.", "Hence, if \u03b2 > 1, class 1 is weighted higher, meaning the network is less likely to ignore it (lesser false negatives). Conversely, if \u03b2 < 1, class 0 is weighted higher, meaning there will be lesser false positives.", "By controlling, the value of \u03b2, you can reduce the problem of class imbalance by weighting the smaller class higher. However, the optimal value of \u03b2 is hard to ascertain and requires many rounds of trial and error.", "Pros: Simple smooth loss surface that is fast in training", "Cons: Difficult to optimise and find the sweet spot", "The Dice Coefficient is well-known for being the go-to evaluation metric for image segmentation, but it can also serve as a loss function. Although not as widely used as other loss functions like binary cross entropy, the dice coefficient does wonders when it comes to class imbalance.", "Unlike BCE, dice coefficient only considers the segmentation class and not the background class. The pixels are classified as True Positive (TP), False Negative (FN) and False Positive (FP).", "The dice coefficient is a measure of overlap of the predicted mask and the groundtruth. Since it does not account for the background class, it cannot dominate over the smaller segmentation class. The dice coefficient outputs a score in the range [0,1] where 1 is a perfect overlap. Thus, (1-DSC) can be used as a loss function.", "Considering the maximisation of the dice coefficient is the goal of the network, using it directly as a loss function can yield good results, since it works well with class imbalanced data by design.", "However, one of the pitfalls of the dice coefficient is the potential for exploding gradients. Early in the training, the dice coefficient is close to 0, which can cause instability in training due to exploding gradients as a result of the network making large changes to weights. However, this is easily manageable using batch normalisation and ReLUs.", "Pros: Easy solution to class imbalance without having to manually optimise any parameters", "Cons: Potential for gradient explosion, and generally slower to train than BCE", "The Tversky Index (TI) is a asymmetric similarity measure that is a generalisation of the dice coefficient and the Jaccard index.", "The tversky index adds two parameters, \u03b1 and \ud835\udf37, where \u03b1 + \ud835\udf37 = 1. In the case where \u03b1 = \ud835\udf37 = 0.5, it simplifies into the dice coefficient. It simplifies to the Jaccard index if \u03b1 = \ud835\udf37 = 1.", "By setting the value of \u03b1 > \ud835\udf37, you can penalise false negatives more. This becomes useful in highly imbalanced datasets where the additional level of control over the loss function yields better small scale segmentations than the normal dice coefficient.", "Although the tversky index is only a simple improvement over the dice coefficient, it can prove useful in edge cases where you need a finer level of control.", "In the paper, Tversky loss function for image segmentation using 3D fully convolutional deep networks by Salehi et al., the tversky loss was used to obtain the most desirable performance for multiple sclerosis lesion segmentation, a typically class imbalanced problem.", "The Focal Tversky Loss (FTL) is a generalisation of the tversky loss. The non-linear nature of the loss gives you control over how the loss behaves at different values of the tversky index obtained.", "\u03b3 is a parameter that controls the non-linearity of the loss. As \u03b3 tends to positive \u221e, the gradient of the loss tends to \u221e as the Tversky Index (TI) tends to 1. As \u03b3 tends to 0, the gradient of the loss tends to 0 as TI tends to 1.", "Essentially, with a value of \u03b3 < 1, the gradient of the loss is higher for examples where TI > 0.5, forcing the model to focus on such examples. This behaviour can be useful towards the end of training as the model is still incentivised to learn even though TI is nearing convergence. However, at the same time, it will weight easier examples higher during the early stages of training, which can lead to poor learning.", "In the case of class imbalance, the FTL becomes useful when \u03b3 > 1. This results in a higher loss gradient for examples where TI < 0.5. This forces the model to focus on harder examples, especially small scale segmentations which usually receive low TI scores.", "In the image above, the blue line is the standard tversky loss. The purple line shows the higher gradient and higher loss when TI > 0.5 while the green line shows higher loss when TI < 0.5.", "The table above is extracted from the paper, A Novel Focal Tversky loss function with improved Attention U-Net for lesion segmentation.", "In the BUS dataset, the FTL showed significant improvements in all categories. In the ISIC dataset, although the overall dice coefficient was the highest, the model did not have the highest precision or recall.", "Although models trained with FTL may not have the outright highest precision or recall, it is important to note that the balance between precision and recall was best when trained with FTL, which shows that the objective of tackling class imbalance was satisfied. The end result is the best overall dice coefficient.", "The Focal Tversky Loss is an easy drop in solution to deal with class imbalance. Although the best parameter values will take some trial and error to determine, you should see good results with the following:", "To get the full implementation of a U-Net with attention, recurrence and inception layers pre-implemented, please check https://github.com/robinvvinod/unet/.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "17 year old student interested in ML research and application development. I use Medium to share what I\u2019ve learnt. https://www.linkedin.com/in/robin-vinod/"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F1cbd17de76b5&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdealing-with-class-imbalanced-image-datasets-1cbd17de76b5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdealing-with-class-imbalanced-image-datasets-1cbd17de76b5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdealing-with-class-imbalanced-image-datasets-1cbd17de76b5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdealing-with-class-imbalanced-image-datasets-1cbd17de76b5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----1cbd17de76b5--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----1cbd17de76b5--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@robinvvinod?source=post_page-----1cbd17de76b5--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@robinvvinod?source=post_page-----1cbd17de76b5--------------------------------", "anchor_text": "Robin Vinod"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F5e2c08907591&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdealing-with-class-imbalanced-image-datasets-1cbd17de76b5&user=Robin+Vinod&userId=5e2c08907591&source=post_page-5e2c08907591----1cbd17de76b5---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F1cbd17de76b5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdealing-with-class-imbalanced-image-datasets-1cbd17de76b5&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F1cbd17de76b5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdealing-with-class-imbalanced-image-datasets-1cbd17de76b5&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://arxiv.org/abs/1706.05721", "anchor_text": "Tversky loss function for image segmentation using 3D fully convolutional deep networks"}, {"url": "https://arxiv.org/abs/1810.07842", "anchor_text": "Abraham et. al, 2018"}, {"url": "https://arxiv.org/abs/1810.07842", "anchor_text": "A Novel Focal Tversky loss function with improved Attention U-Net for lesion segmentation"}, {"url": "https://github.com/robinvvinod/unet/", "anchor_text": "https://github.com/robinvvinod/unet/"}, {"url": "https://medium.com/tag/data-science?source=post_page-----1cbd17de76b5---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----1cbd17de76b5---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/tversky?source=post_page-----1cbd17de76b5---------------tversky-----------------", "anchor_text": "Tversky"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F1cbd17de76b5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdealing-with-class-imbalanced-image-datasets-1cbd17de76b5&user=Robin+Vinod&userId=5e2c08907591&source=-----1cbd17de76b5---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F1cbd17de76b5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdealing-with-class-imbalanced-image-datasets-1cbd17de76b5&user=Robin+Vinod&userId=5e2c08907591&source=-----1cbd17de76b5---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F1cbd17de76b5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdealing-with-class-imbalanced-image-datasets-1cbd17de76b5&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----1cbd17de76b5--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F1cbd17de76b5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdealing-with-class-imbalanced-image-datasets-1cbd17de76b5&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----1cbd17de76b5---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----1cbd17de76b5--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----1cbd17de76b5--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----1cbd17de76b5--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----1cbd17de76b5--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----1cbd17de76b5--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----1cbd17de76b5--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----1cbd17de76b5--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----1cbd17de76b5--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@robinvvinod?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@robinvvinod?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Robin Vinod"}, {"url": "https://medium.com/@robinvvinod/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "60 Followers"}, {"url": "https://www.linkedin.com/in/robin-vinod/", "anchor_text": "https://www.linkedin.com/in/robin-vinod/"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F5e2c08907591&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdealing-with-class-imbalanced-image-datasets-1cbd17de76b5&user=Robin+Vinod&userId=5e2c08907591&source=post_page-5e2c08907591--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fc9834c921339&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdealing-with-class-imbalanced-image-datasets-1cbd17de76b5&newsletterV3=5e2c08907591&newsletterV3Id=c9834c921339&user=Robin+Vinod&userId=5e2c08907591&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}