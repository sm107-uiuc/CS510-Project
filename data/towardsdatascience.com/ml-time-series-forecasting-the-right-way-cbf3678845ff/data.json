{"url": "https://towardsdatascience.com/ml-time-series-forecasting-the-right-way-cbf3678845ff", "time": 1683006407.562782, "path": "towardsdatascience.com/ml-time-series-forecasting-the-right-way-cbf3678845ff/", "webpage": {"metadata": {"title": "ML time series forecasting the right way | by Mario Dagrada | Towards Data Science", "h1": "ML time series forecasting the right way", "description": "The application of machine learning (ML) techniques to time series forecasting is not straightforward. One of the main challenges is to use the ML model for actually predicting the future in what is\u2026"}, "outgoing_paragraph_urls": [{"url": "https://medium.com/u/99ed96040994?source=post_page-----cbf3678845ff--------------------------------", "anchor_text": "Mario Dagrada", "paragraph_index": 0}, {"url": "https://medium.com/u/f93d8afa68ed?source=post_page-----cbf3678845ff--------------------------------", "anchor_text": "Lorenzo Ghiringhello", "paragraph_index": 0}, {"url": "https://towardsdatascience.com/how-not-to-use-machine-learning-for-time-series-forecasting-avoiding-the-pitfalls-19f9d7adf424", "anchor_text": "straightforward", "paragraph_index": 1}, {"url": "https://neptune.ai/blog/select-model-for-time-series-prediction-task", "anchor_text": "this", "paragraph_index": 6}, {"url": "https://dzone.com/articles/autocorrelation-in-time-series-data", "anchor_text": "here", "paragraph_index": 10}, {"url": "https://xgboost.readthedocs.io/en/latest/get_started.html", "anchor_text": "this", "paragraph_index": 11}, {"url": "https://filip-wojcik.com/talks/xgboost_forecasting_eng.pdf", "anchor_text": "here", "paragraph_index": 11}, {"url": "https://towardsdatascience.com/forecasting-stock-prices-using-xgboost-a-detailed-walk-through-7817c1ff536a", "anchor_text": "here", "paragraph_index": 11}, {"url": "https://stats.stackexchange.com/a/268847", "anchor_text": "cross-validation with rolling time window", "paragraph_index": 13}, {"url": "https://hyperopt.github.io/hyperopt/", "anchor_text": "hyperopt", "paragraph_index": 13}, {"url": "https://dzone.com/articles/lessons-learnt-while-solving-time-series-forecasti-1", "anchor_text": "here", "paragraph_index": 15}, {"url": "https://robjhyndman.com/papers/rectify.pdf", "anchor_text": "here", "paragraph_index": 25}, {"url": "https://www.linkedin.com/in/lorenzo-ghiringhello-a5235414b/", "anchor_text": "Lorenzo", "paragraph_index": 26}, {"url": "https://www.linkedin.com/in/mariodagrada/", "anchor_text": "Mario", "paragraph_index": 26}, {"url": "https://github.com/madagra/energy-ts-analysis", "anchor_text": "Github", "paragraph_index": 26}], "all_paragraphs": ["Written by Mario Dagrada & Lorenzo Ghiringhello.", "The application of machine learning (ML) techniques to time series forecasting is not straightforward. One of the main challenges is to use the ML model for actually predicting the future in what is commonly referred to as forecasting. Without forecasting, time series analysis becomes irrelevant.", "This issue stems from the temporal structure of the data since, at variance with standard ML projects, it is not enough to apply a pre-trained model on new data points to get the forecasts but, as we will see in this post, additional steps are required. Very few examples of time series forecasting with ML available online are really end-to-end since they keep the focus on testing the model on available data and overlook the forecasting part.", "This post shows instead a complete example \u2014 from feature engineering to forecasting the future using different strategies \u2014 of a common problem such as the prediction of the energy consumption of a utility (for instance a transformer) within a factory. Before diving in, let us briefly clarify some terminology.", "Time series analysis is a broad domain that has been applied to many different problems, ranging from econometric to earthquakes and weather predictions. Broadly speaking, time series methods can be divided into two categories depending on the desired outcome:", "Here, we are dealing only with time series forecasting. We restrict our problem to forecast a univariate time series performing multi-step forecasting of several steps ahead in the future.", "If you want to dive deeper into time series analysis and how to select the right model for your specific problem, you can refer to this excellent article.", "The dataset we consider consists of hourly energy consumption rates in kWh for an industrial utility over a period of around 7 months, from July 2019 to January 2020. The energy measurements have been taken from a sensor installed in a real factory in Italy. Data are anonymized by random constant multiplication. Let us plot different views of our data.", "In the top left figure above we see the original behavior over time of the energy consumption. The p-value of the augmented Dick-Fuller (ADF) test, shown in the figure title, is a good indication that the time series is stationary.", "The top right panel shows the value distribution of energy consumption. The data values seem to follow a slow-decaying Poisson distribution where high values of the energy consumption above 50 KWh are much less likely than lower ones (10 to 40 KWh). This is expected behavior since the energy consumption of industrial utilities operating continuously has usually a fairly constant average with sporadic peaks due to production increase or maintenance windows.", "The bottom figures show the autocorrelation (ACF) and partial autocorrelation (PACF) functions. See here for more details on their importance for time series analysis. The ACF shows that the time series has a seasonal component at 24 hours (grey horizontal lines) with autocorrelation peaks which do not decrease over time, indicating the strength of this component. This is confirmed by the PACF.", "For our forecasting problem, we choose the XGBoost algorithm using this popular Python implementation. XGBoost is fast and accurate compared to other tree-based ML methods for time series problems, as shown by several Kaggle competitions and other works available online (see for instance here or here).", "In order to transform a time series forecasting task into a supervised machine learning problem, we need to generate the features. The actual time series values are instead used as a target for the ML model. The types of features we can consider for a time series are divided into 3 categories:", "We use a standard pipeline for training and testing the XGBoost model with 80/20 train test split, cross-validation with rolling time window, and hyperparameters optimization using the hyperopt library. The best model yields a mean average percentage error (MAPE) of 14.302 from cross-validation and 8.378 when predicting on the much smaller test set. The predicted values on the test set and corresponding importance coefficients for the top features are shown below.", "The ML model results are acceptable and our job is done. Not quite! We mentioned in the introduction that getting satisfactory results from the model is not enough to obtain an actionable outcome. Similarly to standard supervised ML problems, one wants to use the model on unknown data points which in our case are future time periods: ultimately we want to predict the future. The number of time periods to forecast into the future is usually referred to as the forecasting horizon.", "At variance with standard ML where the model can be directly applied to new data, the temporal structure of time series problems makes forecasting more complicated. There are several strategies to achieve multi-step ahead forecasting, a good introduction to these methods can be found here. In this post, we compare two of the most widely used strategies showing also their implementation for the ML model discussed above. We choose a forecasting horizon of 48 time periods which corresponds to 2 days ahead forecasting.", "The recursive forecasting strategy uses only a single model pre-trained for one-step-ahead forecasting. At each forecasting step, this model is used to predict one-step ahead and the value obtained from the forecasting is then fed into the same model to predict the following step (similarly to a recursive function, hence the name) and so on and so forth until the desired forecasting horizon is reached. The recursive strategy is the least expensive method for forecasting since it uses the same model. However, it is not the best strategy for long time horizons since it accumulates forecasting errors at each step. This problem arises because previous forecast values are used to build the feature space for the current step.", "The following snippet implements the recursive strategy for our ML model.", "The direct forecasting strategy uses a different ML model for each forecasting step. More specifically, each model is trained using as target the time series shifted of the desired number of time periods into the future. Imagine for example that one wants to train a 4 steps ahead model. In this case, each timestamp in the target time series is chosen 4 steps ahead with respect to the corresponding timestamp in the feature set. In this way, we create a model trained to predict 4 steps ahead into the future. The same procedure is repeated for all forecasting steps. The size of the training/cross-validation set slightly decreases for each additional step ahead to perform.", "The direct method outlined above does not generate error accumulation at each forecast, but it has larger computational cost making it not suitable for large forecasting horizons. Moreover, it cannot model statistical relationships among predictions since the models used for each time step are independent. As a side remark, the latter issue can be overcome by using a neural network trained to output multiple forecasts at once \u2014 one for each future time period \u2014 which also learns the relationships in the process.", "Here the implementation of a simple direct forecast for our ML model.", "And finally, let us look at how the two strategies above compare in forecasting the future. We consider the last 48 hours of our dataset as the future so that we have real data to compare the forecasting with. Beware that in real-world problems the future is not known in advance!", "By looking at the MAPE score for the two methods, the direct one performs better than the recursive strategy as expected, with an error of around 15% lower.", "Just looking at these values is not enough to assess forecasting quality. Let us plot the two forecasts.", "For this relatively short horizon, both strategies perform similarly for the initial forecasting steps. After around 24 hours, however, the recursive strategy starts to diverge from the direct one. This is most likely due to the error accumulation starting to affect recursive method results. Error accumulation likely generates also the stronger fluctuations displayed by the recursive forecast. The improvement yielded by the direct strategy is however not so significant to always justify its use. In production deployments of time series models, it is often better to use a less accurate method requiring much lower computational effort such as the recursive strategy.", "In conclusion, remember that the present methods are just basic forecasting strategies. Extensive research effort has been put into devising more precise and controlled forecasting techniques, one example being the Rectify strategy described here.", "If you enjoyed this post and you have any comments, suggestions, criticism just connect with us (Lorenzo or Mario). The full code used for this post is available on Github.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "VP of Quantum Software @ Pasqal"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fcbf3678845ff&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-time-series-forecasting-the-right-way-cbf3678845ff&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-time-series-forecasting-the-right-way-cbf3678845ff&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-time-series-forecasting-the-right-way-cbf3678845ff&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-time-series-forecasting-the-right-way-cbf3678845ff&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----cbf3678845ff--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----cbf3678845ff--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://mariodagrada.medium.com/?source=post_page-----cbf3678845ff--------------------------------", "anchor_text": ""}, {"url": "https://mariodagrada.medium.com/?source=post_page-----cbf3678845ff--------------------------------", "anchor_text": "Mario Dagrada"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F99ed96040994&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-time-series-forecasting-the-right-way-cbf3678845ff&user=Mario+Dagrada&userId=99ed96040994&source=post_page-99ed96040994----cbf3678845ff---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fcbf3678845ff&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-time-series-forecasting-the-right-way-cbf3678845ff&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fcbf3678845ff&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-time-series-forecasting-the-right-way-cbf3678845ff&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://medium.com/u/99ed96040994?source=post_page-----cbf3678845ff--------------------------------", "anchor_text": "Mario Dagrada"}, {"url": "https://medium.com/u/f93d8afa68ed?source=post_page-----cbf3678845ff--------------------------------", "anchor_text": "Lorenzo Ghiringhello"}, {"url": "https://unsplash.com/@aronvisuals?utm_source=medium&utm_medium=referral", "anchor_text": "Aron Visuals"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://towardsdatascience.com/how-not-to-use-machine-learning-for-time-series-forecasting-avoiding-the-pitfalls-19f9d7adf424", "anchor_text": "straightforward"}, {"url": "https://neptune.ai/blog/select-model-for-time-series-prediction-task", "anchor_text": "this"}, {"url": "https://dzone.com/articles/autocorrelation-in-time-series-data", "anchor_text": "here"}, {"url": "https://xgboost.readthedocs.io/en/latest/get_started.html", "anchor_text": "this"}, {"url": "https://filip-wojcik.com/talks/xgboost_forecasting_eng.pdf", "anchor_text": "here"}, {"url": "https://towardsdatascience.com/forecasting-stock-prices-using-xgboost-a-detailed-walk-through-7817c1ff536a", "anchor_text": "here"}, {"url": "https://stats.stackexchange.com/a/268847", "anchor_text": "cross-validation with rolling time window"}, {"url": "https://hyperopt.github.io/hyperopt/", "anchor_text": "hyperopt"}, {"url": "https://dzone.com/articles/lessons-learnt-while-solving-time-series-forecasti-1", "anchor_text": "here"}, {"url": "https://robjhyndman.com/papers/rectify.pdf", "anchor_text": "here"}, {"url": "https://www.linkedin.com/in/lorenzo-ghiringhello-a5235414b/", "anchor_text": "Lorenzo"}, {"url": "https://www.linkedin.com/in/mariodagrada/", "anchor_text": "Mario"}, {"url": "https://github.com/madagra/energy-ts-analysis", "anchor_text": "Github"}, {"url": "https://medium.com/tag/time-series-forecasting?source=post_page-----cbf3678845ff---------------time_series_forecasting-----------------", "anchor_text": "Time Series Forecasting"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----cbf3678845ff---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/energy?source=post_page-----cbf3678845ff---------------energy-----------------", "anchor_text": "Energy"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fcbf3678845ff&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-time-series-forecasting-the-right-way-cbf3678845ff&user=Mario+Dagrada&userId=99ed96040994&source=-----cbf3678845ff---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fcbf3678845ff&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-time-series-forecasting-the-right-way-cbf3678845ff&user=Mario+Dagrada&userId=99ed96040994&source=-----cbf3678845ff---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fcbf3678845ff&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-time-series-forecasting-the-right-way-cbf3678845ff&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----cbf3678845ff--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fcbf3678845ff&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-time-series-forecasting-the-right-way-cbf3678845ff&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----cbf3678845ff---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----cbf3678845ff--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----cbf3678845ff--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----cbf3678845ff--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----cbf3678845ff--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----cbf3678845ff--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----cbf3678845ff--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----cbf3678845ff--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----cbf3678845ff--------------------------------", "anchor_text": ""}, {"url": "https://mariodagrada.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://mariodagrada.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Mario Dagrada"}, {"url": "https://mariodagrada.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "197 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F99ed96040994&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-time-series-forecasting-the-right-way-cbf3678845ff&user=Mario+Dagrada&userId=99ed96040994&source=post_page-99ed96040994--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F4d4eed447fb7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-time-series-forecasting-the-right-way-cbf3678845ff&newsletterV3=99ed96040994&newsletterV3Id=4d4eed447fb7&user=Mario+Dagrada&userId=99ed96040994&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}