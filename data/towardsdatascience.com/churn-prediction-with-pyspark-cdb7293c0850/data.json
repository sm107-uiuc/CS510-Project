{"url": "https://towardsdatascience.com/churn-prediction-with-pyspark-cdb7293c0850", "time": 1683016019.5194812, "path": "towardsdatascience.com/churn-prediction-with-pyspark-cdb7293c0850/", "webpage": {"metadata": {"title": "Churn prediction with PySpark. Churn baby churn! Don\u2019t you hate it\u2026 | by Thijs Essens | Towards Data Science", "h1": "Churn prediction with PySpark", "description": "As mentioned by Flo in his article: \u201cAcquiring new customers can be five to twenty-five times more expensive than retaining existing ones according to Harvard Business Review.\u201d In this article, I\u2026"}, "outgoing_paragraph_urls": [{"url": "https://blog.markgrowth.com/eliminating-churn-is-growth-hacking-2-0-47a380194a06", "anchor_text": "his article", "paragraph_index": 2}, {"url": "https://hbr.org/2014/10/the-value-of-keeping-the-right-customers", "anchor_text": "Harvard Business Review", "paragraph_index": 2}, {"url": "https://spark.apache.org/", "anchor_text": "Spark", "paragraph_index": 9}, {"url": "https://stackoverflow.com/questions/44627386/how-to-find-count-of-null-and-nan-values-for-each-column-in-a-pyspark-dataframe", "anchor_text": "stackoverflow answer", "paragraph_index": 27}, {"url": "https://towardsdatascience.com/having-an-imbalanced-dataset-here-is-how-you-can-solve-it-1640568947eb", "anchor_text": "many ways to deal with imbalanced data", "paragraph_index": 32}, {"url": "https://medium.com/@junwan01/oversampling-and-undersampling-with-pyspark-5dbc25cdf253", "anchor_text": "Oversampling method for Pyspark", "paragraph_index": 34}], "all_paragraphs": ["Don\u2019t you hate it when your customers leave?", "It\u2019s sad and they may never come back!", "As mentioned by Flo in his article: \u201cAcquiring new customers can be five to twenty-five times more expensive than retaining existing ones according to Harvard Business Review.\u201d", "You can do something about it!", "What if I told you, you can predict churn.", "In this article, I would like to provide you with the practical machine learning implementation to predict churn using a fictional digital music streaming service.", "We\u2019ll go through the following points:", "Let\u2019s explain the data source before moving on with the specifics.", "The dataset is from a fictional digital music streaming service called Sparkify. It contains several potentially interesting fields derived from website interaction logs.", "We are using Spark since the dataset is 12GB and we need the power of distributed machine learning technologies to help us with the heavy lifting.", "In our case, Churn is defined as page == \u201cCancellation Confirmation\u201d.", "The schema of the data looks like this:", "Our dataset allows for many approaches to Feature Engineering. I focused on using the \u201cpage\u201d field in combination with our time \u201cts\u201d component to understand user engagement with our website.", "The page field is categorical and has several different values, see below:", "In PySpark, creating dummy variables from a categorical column is not straight forward at all. It\u2019s worth showing the steps:", "Use StringIndexer to convert categorical column to indexed", "Use OneHotEncoder to convert indexed to SparseVector", "This could be enough, because the input for the machine learning function accepts features as a SparseVector. However, let\u2019s think about what we have now. We have 1\u2019s and 0\u2019s in a SparseVector matrix for every \u201cpage\u201d categorical value.", "We want to get to a form of customer engagement metrics. When thinking about this from a user perspective, I would like to have daily usage as well as weekly and monthly averages for all of my page interatctions. At this point, I\u2019m not sure which of the categorical values will be most important in predicting churn, so I will keep all.", "In order to check if the growth or decline of the specific engagment metrics affects the churn, we will create comparisons between daily, 7d and 30d averages.", "Here\u2019s a list of features I want:", "Finally, we\u2019ll add tenure on the platform as an additional feature. This is a commonly used user engagment metric.", "In order to, get to daily, weekly and monthly metrics, I will need to convert \u201cts\u201d to dates and use some sort of Window function per feature.", "Use a row extractor to get individual columns per SparseVector item:", "This will give us our Daily metrics:", "Now for a little fun. I found an elegant way to loop through this daily dataset to get 7d and 30d averages, as well as deriving variance metrics for several metric pairs. That sounds complicated. But I\u2019m expecting that if your daily listened songs are significantly below your 7d average, you are disengaged and therefore more likely to cancel.", "Finally, I created a tenure metric, like so:", "We have now done many calculations. There is a risk they don\u2019t all yield values (e.g. dividing by 0). Check the NULLs per column by using this stackoverflow answer.", "This told me I definitely needed to fill my dataframe:", "Before moving on, for modeling in PySpark ML, we need to combine all of our separate metrics back into a SparseVector. We can use a VectorAssembler:", "Ever been frustrated by having your LogisticRegression only forecast the majority class of your label?", "It\u2019s not the fault of the model. It is rightfully predicting the most likely classification.", "It is caused by imbalance in your dataset. There are many ways to deal with imbalanced data. In particular, Oversampling can work if the class you are interested in is very small.", "This is the secret sauce for your model performing much better by training on more examples of the minority class.", "I found this neat Oversampling method for Pyspark from Jun Wan:", "First, train test split in PySpark:", "This last model performed exceptionally well. With a quick CrossValidation, the outcomes for maxDepth=20 were even better. I couldn\u2019t run that for the full dataset due to performance issues.", "Here are the results for a small subset:", "Below you can find a summary of all of the metrics by model. GBT with maxDepth=20 clearly wins.", "In order to find which features were most important, I looked at my GBT model with this code:", "To find that these are some of the most important metrics to predict churn:", "In this article, I gave you some practical tools to predict churn:", "I faced difficulties in several different areas:", "I hope you enjoyed this article!", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Data @Instagram. Opinions are my own."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fcdb7293c0850&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchurn-prediction-with-pyspark-cdb7293c0850&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchurn-prediction-with-pyspark-cdb7293c0850&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchurn-prediction-with-pyspark-cdb7293c0850&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchurn-prediction-with-pyspark-cdb7293c0850&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----cdb7293c0850--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----cdb7293c0850--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@essens?source=post_page-----cdb7293c0850--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@essens?source=post_page-----cdb7293c0850--------------------------------", "anchor_text": "Thijs Essens"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F986b0e2b9e02&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchurn-prediction-with-pyspark-cdb7293c0850&user=Thijs+Essens&userId=986b0e2b9e02&source=post_page-986b0e2b9e02----cdb7293c0850---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fcdb7293c0850&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchurn-prediction-with-pyspark-cdb7293c0850&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fcdb7293c0850&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchurn-prediction-with-pyspark-cdb7293c0850&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@tiomp?utm_source=medium&utm_medium=referral", "anchor_text": "Marcos Paulo Prado"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://blog.markgrowth.com/eliminating-churn-is-growth-hacking-2-0-47a380194a06", "anchor_text": "his article"}, {"url": "https://hbr.org/2014/10/the-value-of-keeping-the-right-customers", "anchor_text": "Harvard Business Review"}, {"url": "https://spark.apache.org/", "anchor_text": "Spark"}, {"url": "https://stackoverflow.com/questions/44627386/how-to-find-count-of-null-and-nan-values-for-each-column-in-a-pyspark-dataframe", "anchor_text": "stackoverflow answer"}, {"url": "https://towardsdatascience.com/having-an-imbalanced-dataset-here-is-how-you-can-solve-it-1640568947eb", "anchor_text": "many ways to deal with imbalanced data"}, {"url": "https://medium.com/@junwan01/oversampling-and-undersampling-with-pyspark-5dbc25cdf253", "anchor_text": "Oversampling method for Pyspark"}, {"url": "https://github.com/thijsessens/sparkify_churn_prediction", "anchor_text": "https://github.com/thijsessens/sparkify_churn_prediction"}, {"url": "https://medium.com/tag/spark?source=post_page-----cdb7293c0850---------------spark-----------------", "anchor_text": "Spark"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----cdb7293c0850---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/churn?source=post_page-----cdb7293c0850---------------churn-----------------", "anchor_text": "Churn"}, {"url": "https://medium.com/tag/pyspark?source=post_page-----cdb7293c0850---------------pyspark-----------------", "anchor_text": "Pyspark"}, {"url": "https://medium.com/tag/data-science?source=post_page-----cdb7293c0850---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fcdb7293c0850&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchurn-prediction-with-pyspark-cdb7293c0850&user=Thijs+Essens&userId=986b0e2b9e02&source=-----cdb7293c0850---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fcdb7293c0850&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchurn-prediction-with-pyspark-cdb7293c0850&user=Thijs+Essens&userId=986b0e2b9e02&source=-----cdb7293c0850---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fcdb7293c0850&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchurn-prediction-with-pyspark-cdb7293c0850&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----cdb7293c0850--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fcdb7293c0850&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchurn-prediction-with-pyspark-cdb7293c0850&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----cdb7293c0850---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----cdb7293c0850--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----cdb7293c0850--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----cdb7293c0850--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----cdb7293c0850--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----cdb7293c0850--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----cdb7293c0850--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----cdb7293c0850--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----cdb7293c0850--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@essens?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@essens?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Thijs Essens"}, {"url": "https://medium.com/@essens/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "47 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F986b0e2b9e02&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchurn-prediction-with-pyspark-cdb7293c0850&user=Thijs+Essens&userId=986b0e2b9e02&source=post_page-986b0e2b9e02--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fusers%2F986b0e2b9e02%2Flazily-enable-writer-subscription&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchurn-prediction-with-pyspark-cdb7293c0850&user=Thijs+Essens&userId=986b0e2b9e02&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}