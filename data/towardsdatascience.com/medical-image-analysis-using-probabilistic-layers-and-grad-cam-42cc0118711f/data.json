{"url": "https://towardsdatascience.com/medical-image-analysis-using-probabilistic-layers-and-grad-cam-42cc0118711f", "time": 1683001482.9836879, "path": "towardsdatascience.com/medical-image-analysis-using-probabilistic-layers-and-grad-cam-42cc0118711f/", "webpage": {"metadata": {"title": "Medical Image Analysis using probabilistic layers and Grad-Cam | by Rik Kraan | Towards Data Science", "h1": "Medical Image Analysis using probabilistic layers and Grad-Cam", "description": "Demonstrating two methods valuable for providing insights in a convolutional neural network\u2019s way of \u2018thinking\u2019"}, "outgoing_paragraph_urls": [{"url": "https://arxiv.org/abs/1803.04386", "anchor_text": "https://arxiv.org/abs/1803.04386", "paragraph_index": 9}, {"url": "https://arxiv.org/abs/1610.02391", "anchor_text": "https://arxiv.org/abs/1610.02391", "paragraph_index": 15}, {"url": "https://www.linkedin.com/in/rikkraan/", "anchor_text": "Rik Kraan", "paragraph_index": 19}, {"url": "https://medium.com/u/6637acb5a331?source=post_page-----42cc0118711f--------------------------------", "anchor_text": "Richard Bartels", "paragraph_index": 20}, {"url": "https://medium.com/u/67c88c5676e2?source=post_page-----42cc0118711f--------------------------------", "anchor_text": "Loek Gerrits", "paragraph_index": 20}], "all_paragraphs": ["Interest in artificial intelligence applications for image analysis in healthcare is increasing fast. The number of publications in academic journals concerning machine learning is growing exponentially and consequently several image-recognition applications have been implemented in daily clinical practice. Accurate algorithms can serve as additional diagnostic tools for physicians in order to facilitate and accelerate the workflow and, most importantly, improve the accuracy of the diagnostic process.", "Image analysis algorithms should be added to the physician\u2019s toolbox and not be regarded as a potential replacement of medical specialists. Despite physicians being concerned with and responsible for their patients\u2019 well-being, most are not familiar with the mathematical details of machine learning algorithms. Therefore, medical applications should not serve as \u2018black boxes\u2019, but provide additional information on how the model came to its predictions. This blog demonstrates two possible techniques for acquiring this information: probabilistic layers, which can be used to address the uncertainty on a model\u2019s predictions and Grad-CAM a method for demonstrating which pixels contribute most to the model\u2019s outcome. In this blog we will focus on dermatoscopic images, but the presented techniques are applicable to other medical fields (e.g. radiology and pathology) as well.", "The two techniques will be illustrated using Kaggle\u2019s public HAM (\u201cHuman Against Machine\u201d) 10000 dataset which contains over 10000 images of 7 classes of pigmented skin lesions, including several types of skin cancer (i.e. melanoma and basal cell carcinoma) and less invasive types like benign keratosis-like lesions and physiological melanocytic lesions.", "Although the dataset contains additional features as age and location valuable for classifying skin lesions, for illustrative purposes this blog will merely focus on the imaging data. On the left several example images, all obtained with a dermatoscope are depicted.", "First, a basic convolutional neural network was trained using the VGG16 architecture with predefined weights. The weights of the first layers were frozen and only the last 6 layers were retrained. An additional dense layer with a softmax activation function was added.", "After 10 epochs of training the transfer learned model yielded a validation accuracy of 82%. At this moment, the output of the model consists of an array representing the probabilities an image belongs to each of the 7 classes (see below).", "These predictions can already guide physicians in the right direction, however additional information of the model\u2019s method of \u2018thinking\u2019 will increase understanding of and trust in these kind of deep learning models. The next sections will illustrate that for this purpose probabilistic layers and Grad-CAM can be extremely valuable.", "Adding a probabilistic layer to a model\u2019s architecture is a valuable method to evaluate the uncertainty of a model\u2019s predictions. The fundamental difference between \u2018normal\u2019 and probabilistic layers is that probabilistic layers assume weights to have a certain distribution instead of being point estimates. Probabilistic layers approximate the posterior distribution of the weights by variational inference. Essentially, the posterior distribution is approximated through a Gaussian distributed surrogate function. During each forward pass, weights of a probabilistic layer are sampled from this surrogate distribution.", "As a consequence, introducing the same input multiple times will result in slightly different predictions each time. In a classification problem, the model will yield a distribution of probabilities for each class. This probability distribution can be used to asses the uncertainty of a model\u2019s predictions: if the uncertainty is limited, repeated predictions will be very close to each other, while a wide distribution of predictions imply a large model uncertainty.", "This blog will focus on implementation of a specific probabilistic dense layer (Flipout), which can be easily achieved using the Tensorflow Probability module. Instead of adding a normal dense layer to the predefined VGG16 network we add a dense Flipout layer using the same method. The full mathematical background of Flipout was described by Wen et al. and can be found at https://arxiv.org/abs/1803.04386.", "After training the model, the output of our dense Flipout layer looks similar at first glance: an array representing a probability for each of the 6 classes. However, as aforementioned each prediction of the same image is slightly different as a result of the Flipout layer sampling weights out of a distribution each forward pass. By repeating the predictions for a certain image multiple times, a distribution of probabilities can be obtained for each of the 7 classes of skin lesions.", "Each of the images on the left shows the probability distribution of an image belonging to the class \u2018melanocytic nevi\u2019 (blue) or \u2018melanoma (orange) generated by passing each image through the network 100 times. The x-axis reflects the probability of the image belonging to one of the classes, while the height of the plots express the distribution density.", "The value of the additional information for physicians can be illustrated with the depicted density plots. Let\u2019s have a look at the left plot: passing the first image through a \u2018normal\u2019 convolution neural network would yield a low point estimate for the class \u2018melanocytic nevi\u2019 (blue) and a high point estimate for the class \u2018melanoma\u2019 (orange). The probabilistic Flipout layer enables the evaluation of the uncertainty of these predictions. Specifically, the left plot shows little variation in the predicted (low) probabilities for the class \u2018melanocytic nevi\u2019. However, the distribution of the \u2018melanoma\u2019 class has much more variation, implying that the probability of the image belonging to the class \u2018melanoma\u2019 is quite uncertain.", "In summary, a \u2018normal\u2019 convolutional neural network would provide a probability for each class, while a model containing a probabilistic Flipout layer yields a distribution of probabilities for each class and can thus be used to evaluate the uncertainty of the model\u2019s predictions. Physicians can use this extra information to gain a better understanding of the predictions and use his/her knowledge to confirm or exclude a certain diagnosis.", "Gradient-weighted Class Activation Mapping (Grad-CAM) is a method that extracts gradients from a convolutional neural network\u2019s final convolutional layer and uses this information to highlight regions most responsible for the predicted probability the image belongs to a predefined class.", "The steps of Grad-CAM include extracting the gradients with subsequent global average pooling. A ReLU activation function is added to only depict the regions of the image that have a positive contribution to the predefined class. The resulting attention map can be plotted over the original image and can be interpreted as a visual tool for identifying regions the model \u2018looks at\u2019 to predict if an image belongs to a specific class. Readers interested in the mathematical theory behind Grad-CAM are encouraged to read the paper by Selvaraju et al. via https://arxiv.org/abs/1610.02391.", "The code below demonstrates the relative ease of implementing Grad-CAM with our basic model.", "These images demonstrate the original image of a melanoma and the same image with a superimposed attention map created using the Grad-CAM algorithm. These images clearly illustrate that Grad-CAM yields additional information that is useful for daily clinical practice. This attention map reflects which parts of the skin lesion is affecting the model\u2019s predictions most. Possibly, this information can be valuable to guide skin biopsies in search for confirmation of the suspected diagnosis. In addition, provided that the algorithm is accurate in it\u2019s predictions, repeated use of the algorithm with incorporated visual features in different patients will increase a physician\u2019s trust in the algorithm\u2019s predictions.", "Convolutional neural networks have the potential to provide additional diagnostic tools for several medical specialties as radiologists, dermatologists and pathologists. However, models that merely provide class-predictions are not sufficient. We believe that introducing methods as adding a probabilistic reasoning and Grad-CAM provide insight in the model\u2019s decisive properties and are therefore essential for physicians to understand and start embracing machine learning algorithms in daily clinical practice.", "Rik Kraan is medical doctor working as data scientist at Vantage AI, a data science consultancy company in the Netherlands. Feel free to get in touch via rik.kraan@vantage-ai.com", "Special thanks to Richard Bartels and Loek Gerrits", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "MD, PhD | Machine Learning Engineer ad BigData Republic"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F42cc0118711f&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-analysis-using-probabilistic-layers-and-grad-cam-42cc0118711f&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-analysis-using-probabilistic-layers-and-grad-cam-42cc0118711f&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-analysis-using-probabilistic-layers-and-grad-cam-42cc0118711f&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-analysis-using-probabilistic-layers-and-grad-cam-42cc0118711f&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----42cc0118711f--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----42cc0118711f--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@rikkraan?source=post_page-----42cc0118711f--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@rikkraan?source=post_page-----42cc0118711f--------------------------------", "anchor_text": "Rik Kraan"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fd37d14e1ebcd&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-analysis-using-probabilistic-layers-and-grad-cam-42cc0118711f&user=Rik+Kraan&userId=d37d14e1ebcd&source=post_page-d37d14e1ebcd----42cc0118711f---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F42cc0118711f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-analysis-using-probabilistic-layers-and-grad-cam-42cc0118711f&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F42cc0118711f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-analysis-using-probabilistic-layers-and-grad-cam-42cc0118711f&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://arxiv.org/abs/1803.04386", "anchor_text": "https://arxiv.org/abs/1803.04386"}, {"url": "https://arxiv.org/abs/1610.02391", "anchor_text": "https://arxiv.org/abs/1610.02391"}, {"url": "https://www.linkedin.com/in/rikkraan/", "anchor_text": "Rik Kraan"}, {"url": "https://medium.com/u/6637acb5a331?source=post_page-----42cc0118711f--------------------------------", "anchor_text": "Richard Bartels"}, {"url": "https://medium.com/u/67c88c5676e2?source=post_page-----42cc0118711f--------------------------------", "anchor_text": "Loek Gerrits"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----42cc0118711f---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/cnn?source=post_page-----42cc0118711f---------------cnn-----------------", "anchor_text": "Cnn"}, {"url": "https://medium.com/tag/medicine?source=post_page-----42cc0118711f---------------medicine-----------------", "anchor_text": "Medicine"}, {"url": "https://medium.com/tag/image-analysis?source=post_page-----42cc0118711f---------------image_analysis-----------------", "anchor_text": "Image Analysis"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----42cc0118711f---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F42cc0118711f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-analysis-using-probabilistic-layers-and-grad-cam-42cc0118711f&user=Rik+Kraan&userId=d37d14e1ebcd&source=-----42cc0118711f---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F42cc0118711f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-analysis-using-probabilistic-layers-and-grad-cam-42cc0118711f&user=Rik+Kraan&userId=d37d14e1ebcd&source=-----42cc0118711f---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F42cc0118711f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-analysis-using-probabilistic-layers-and-grad-cam-42cc0118711f&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----42cc0118711f--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F42cc0118711f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-analysis-using-probabilistic-layers-and-grad-cam-42cc0118711f&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----42cc0118711f---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----42cc0118711f--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----42cc0118711f--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----42cc0118711f--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----42cc0118711f--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----42cc0118711f--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----42cc0118711f--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----42cc0118711f--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----42cc0118711f--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@rikkraan?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@rikkraan?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Rik Kraan"}, {"url": "https://medium.com/@rikkraan/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "88 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fd37d14e1ebcd&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-analysis-using-probabilistic-layers-and-grad-cam-42cc0118711f&user=Rik+Kraan&userId=d37d14e1ebcd&source=post_page-d37d14e1ebcd--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fca34a3ad96f9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-analysis-using-probabilistic-layers-and-grad-cam-42cc0118711f&newsletterV3=d37d14e1ebcd&newsletterV3Id=ca34a3ad96f9&user=Rik+Kraan&userId=d37d14e1ebcd&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}