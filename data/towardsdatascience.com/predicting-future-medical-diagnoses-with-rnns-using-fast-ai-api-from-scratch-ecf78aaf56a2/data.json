{"url": "https://towardsdatascience.com/predicting-future-medical-diagnoses-with-rnns-using-fast-ai-api-from-scratch-ecf78aaf56a2", "time": 1682995893.124413, "path": "towardsdatascience.com/predicting-future-medical-diagnoses-with-rnns-using-fast-ai-api-from-scratch-ecf78aaf56a2/", "webpage": {"metadata": {"title": "Predicting future medical diagnoses with RNNs using Fast AI API from scratch | by Sparkle Russell-Puleri | Towards Data Science", "h1": "Predicting future medical diagnoses with RNNs using Fast AI API from scratch", "description": "In the first part one of this tutorial we created a rough template of the Doctor AI: Predicting Clinical Events via Recurrent Neural Networks paper(2016) by Edward Choi et.al. In this tutorial we\u2026"}, "outgoing_paragraph_urls": [{"url": "https://sparalic.github.io/post/gated-recurrent-units-explained-using-matrices-part-1/", "anchor_text": "part one", "paragraph_index": 0}, {"url": "https://arxiv.org/abs/1511.05942", "anchor_text": "Doctor AI: Predicting Clinical Events via Recurrent Neural Networks paper(2016)", "paragraph_index": 0}, {"url": "https://sparalic.github.io/post/gated-recurrent-units-explained-using-matrices-part-1/", "anchor_text": "part one", "paragraph_index": 0}, {"url": "https://mimic.physionet.org/", "anchor_text": "MIMIC III", "paragraph_index": 1}, {"url": "https://sparalic.github.io/post/using-electronic-health-records-to-predict-future-diagnosis-codes-with-gated-recurrent-units/", "anchor_text": "part one", "paragraph_index": 1}, {"url": "http://jmlr.org/papers/volume15/srivastava14a.old/srivastava14a.pdf", "anchor_text": "Srivastava (2014)", "paragraph_index": 19}, {"url": "https://arxiv.org/pdf/1708.02182.pdf", "anchor_text": "Merity (2017)", "paragraph_index": 19}], "all_paragraphs": ["In the first part one of this tutorial we created a rough template of the Doctor AI: Predicting Clinical Events via Recurrent Neural Networks paper(2016) by Edward Choi et.al. In this tutorial we took it a step further using the Fast.ai buttom up approach. This code is fully functional and details on how the data was processed can be accessed in part one.", "This study will utilize the MIMIC III electronic health record (EHR) dataset, which is comprised of over 58,000 hospital admissions for 38,645 adults and 7,875 neonates. This dataset is a collection of de-identified intensive care unit stays at the Beth Israel Deaconess Medical Center from June 2001- October 2012. A detailed walkthrough of the data pre-processing steps used can be found in part one.", "The data pre-processed datasets will be loaded and split into a train, test and validation set at a 75%:15%:10% ratio.", "Using the artificial EHR data created in part one we pad the sequences to the length of the longest sequence in each mini-batch. To help explain this in greater depth let\u2019s take a look at the Artificial EHR data created in part one.", "Here you can see that we have an array with two list, each list representing a unique patient. Now, within each list are a series of lists, each representing a unique visit. Finally, the encoded numericals represent the diagnosis codes assigned during each unique visit. It is key to note that given the uniqueness of each patient\u2019s condition, there are variable length sequences for both the visits and diagnosis codes assigned. Because EHR data is longitudinal in nature and we are often interested in understand a patient's risk or progression over time. When using tabular data processing these nested time-dependent variable length sequences can get complicated quickly. Recall the following image from part one, detailing the mapping of each visit date to the diagnosis codes assigned during that visit.", "Let\u2019s break down the padding function:", "What does this mean? Given the structure of the data, the last visit in each patient\u2019s record will be removed. As illustrated here:", "If this was a character level problem let\u2019s say [Sparkle,Dorian, Deep, Learning]. The sequences are first arranged by length, in descending order and padded with zeros (red), where each letter represents a token. As shown here:", "However, for EHR data of this form given our current problem, instead of each encoded diagnosis code representing a unique token. In this case, each visit represents a token/sequence. So, using the same approach used with character level RNNs we first arrange each mini-batch by the patient visits in descending order. In this the patient 1 has the longest visit history with a total of two visits, while patient 2\u2019s visits will be padded to the max length of 2, since it\u2019s the longest sequence. As shown here:", "Now, that we have taken care of the variable length problem, we can proceed to multi-one hot encode our sequences. This will result in the desired dimensions of S x B x I ( Sequence length, Batch size, Input dimensions/vocab).", "Here we can easily see that the sequences will represent the patient with the longest visit history in each mini-batch, while all others will be padded to this length (red). Depending on the desired batch size, the batch size will represent how many patients sequences are feed in at each timestep. Finally, the inner list will be encoded to the length of the vocabulary, which in this case the number of unique diagnosis codes in the entire dataset.", "To ensure that the labels are shifted over by one sequence, so that the algorithm can accurately predict the next time step. The author took care of this by ensuring that the training data excluded the last visit within each patient\u2019s history, using this logic for xvec, subseq in zip(x[:, idx, :], seq[:-1]):, where we took all but the last visit within each patient's visit record seq[:-1]. For the labels, this meant that the sequences will start from the patients second visit, or in python's indexing style the first index for yvec, subseq in zip(y[:, idx, :], label[1:]), where the label label[1:], is shifted by one.", "Masking allows the algorithm to know where the true sequences are in one-hot encoded data, simply put ignore/filter out the padding values, which in our case are zeros. This allows us to easily handle variable length sequences in RNNs, which require fixed length inputs. How is it done? Remember the lengths variable? This variable stores the effective lengths of each patient's sequences in descending order (recall: after removing the last sequence in each record for inference, eg. patient 1 has 3 visits, but length will reflect only 2). The logic in the code mask[:lengths[idx], idx] = 1. then fills in our zeroed tensor along the rows with 1's to match the length of each patient sequence from largest to smallest.", "The Dataset class is an abstract class that represents the data in x and y pairs.", "The Sampler class randomly shuffles the order of the training set (validation set will not be randomized). Additionally, it keeps the exact amount of sequences needed created a full batch.", "The DataLoader class combines the dataset and the data sampler which iterates over the dataset and grabs batches.", "The Custom_Embedding class was used to project the high-dimensional multi-hot encoded vectors to a lower dimensional space prior to presenting the input data to the GRU. In this step the auther used two approaches", "2. Pre-trained embedding initialized using the Skip-gram algorithm, then refine weights during back-prop", "In this implementation of the paper we used the first approach. Therefore, the Custom Embedding class was created to created apply a tanh activation on the embedding layer.", "In this paper the author used the naive application of dropout that was first introduced by Srivastava (2014). While this method works well, it impacts the RNNs ability to retain long term dependencies, because we are not maintaining the same mask across each timestep. Why is this important? It\u2019s simple, if we randomly sample a new mask at each time step, it perturbs our RNNs connections making it difficult for the network to determine what information might be relevant in the long term. In this approach, I tested the a technique proposed by Gal & Ghahramani (2016) and further developed by Merity (2017) for LSTMs. Here, they proposed overcoming the aforementioned problem with associated random sampling, by using the same dropout mask across multiple time steps in LSTMs. Here, I will applied the same approach on a GRU between each layer (two layers).", "Despite the popularity and preference given to LSTMs. This paper used a GRU architecture, for its simplicity and ability to get similar performance as LSTMs. The dataset used in this paper contained 263, 706 patients, whereas our dataset (MIMIC III) contained a total of 7537 patients. However, the author demonstrated transfer learning can be a viable option in cases where one hospital system lack the large scale datasets need to train deep learning models like Dr. AI. Using the following architecture, my interest lies in the prediction of the patient's future diagnosis codes. However, one can easily extrapolate the algorithm to predict both diagnoses and duration between visits.", "This class uses the EHR_GRU cell class and allows the iteration over the desired number of layers.", "The loss function used to assess model perform, contained a combination of the cross entropy. The prediction loss for each mini-batch was normalized to the sequence length. Finally, L2-norm regularization was applied to all of the weight matrices.", "The parameters used here were selected from those used in the Dr AI paper. The major difference between this approach and what I present here, was my use of the more updated drop out approach for RNNs.", "It\u2019s key to note that you want to pass in the same file for the sequences and labels into the load_data function, as the model will take care of the adjusting the time steps for prediction internally.", "I ran the same sequences on the paper\u2019s algorithm, which is written in theano and python 2.7 and here you can see that the best cross entropy score after 10 epochs is about 86.79 vs. my 107. While, I am not performing better with some more hyperparameter tuning and optimization the algorithm can definitely perform better.", "As you can see our training and validation losses are about the same, with such a small subset of the data used in the actual paper. It might be difficult to get better performance without overfitting. However, the intent of this tutorial was to provide a detailed walkthrough of how one can use EHR data to drive insights!", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fecf78aaf56a2&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-future-medical-diagnoses-with-rnns-using-fast-ai-api-from-scratch-ecf78aaf56a2&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-future-medical-diagnoses-with-rnns-using-fast-ai-api-from-scratch-ecf78aaf56a2&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-future-medical-diagnoses-with-rnns-using-fast-ai-api-from-scratch-ecf78aaf56a2&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-future-medical-diagnoses-with-rnns-using-fast-ai-api-from-scratch-ecf78aaf56a2&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----ecf78aaf56a2--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----ecf78aaf56a2--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@sparklerussell?source=post_page-----ecf78aaf56a2--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@sparklerussell?source=post_page-----ecf78aaf56a2--------------------------------", "anchor_text": "Sparkle Russell-Puleri"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F4c795c746a8d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-future-medical-diagnoses-with-rnns-using-fast-ai-api-from-scratch-ecf78aaf56a2&user=Sparkle+Russell-Puleri&userId=4c795c746a8d&source=post_page-4c795c746a8d----ecf78aaf56a2---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fecf78aaf56a2&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-future-medical-diagnoses-with-rnns-using-fast-ai-api-from-scratch-ecf78aaf56a2&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fecf78aaf56a2&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-future-medical-diagnoses-with-rnns-using-fast-ai-api-from-scratch-ecf78aaf56a2&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://sparalic.github.io/post/gated-recurrent-units-explained-using-matrices-part-1/", "anchor_text": "part one"}, {"url": "https://arxiv.org/abs/1511.05942", "anchor_text": "Doctor AI: Predicting Clinical Events via Recurrent Neural Networks paper(2016)"}, {"url": "https://sparalic.github.io/post/gated-recurrent-units-explained-using-matrices-part-1/", "anchor_text": "part one"}, {"url": "https://github.com/sparalic/Predicting-future-medical-diagnoses-with-RNNs-using-Fast-AI-API-from-scratch", "anchor_text": "Github"}, {"url": "https://mimic.physionet.org/", "anchor_text": "MIMIC III"}, {"url": "https://sparalic.github.io/post/using-electronic-health-records-to-predict-future-diagnosis-codes-with-gated-recurrent-units/", "anchor_text": "part one"}, {"url": "http://jmlr.org/papers/volume15/srivastava14a.old/srivastava14a.pdf", "anchor_text": "Srivastava (2014)"}, {"url": "https://arxiv.org/pdf/1708.02182.pdf", "anchor_text": "Merity (2017)"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----ecf78aaf56a2---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----ecf78aaf56a2---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/tag/electronic-health-record?source=post_page-----ecf78aaf56a2---------------electronic_health_record-----------------", "anchor_text": "Electronic Health Record"}, {"url": "https://medium.com/tag/healthcare?source=post_page-----ecf78aaf56a2---------------healthcare-----------------", "anchor_text": "Healthcare"}, {"url": "https://medium.com/tag/towards-data-science?source=post_page-----ecf78aaf56a2---------------towards_data_science-----------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fecf78aaf56a2&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-future-medical-diagnoses-with-rnns-using-fast-ai-api-from-scratch-ecf78aaf56a2&user=Sparkle+Russell-Puleri&userId=4c795c746a8d&source=-----ecf78aaf56a2---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fecf78aaf56a2&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-future-medical-diagnoses-with-rnns-using-fast-ai-api-from-scratch-ecf78aaf56a2&user=Sparkle+Russell-Puleri&userId=4c795c746a8d&source=-----ecf78aaf56a2---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fecf78aaf56a2&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-future-medical-diagnoses-with-rnns-using-fast-ai-api-from-scratch-ecf78aaf56a2&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----ecf78aaf56a2--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fecf78aaf56a2&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-future-medical-diagnoses-with-rnns-using-fast-ai-api-from-scratch-ecf78aaf56a2&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----ecf78aaf56a2---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----ecf78aaf56a2--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----ecf78aaf56a2--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----ecf78aaf56a2--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----ecf78aaf56a2--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----ecf78aaf56a2--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----ecf78aaf56a2--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----ecf78aaf56a2--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----ecf78aaf56a2--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@sparklerussell?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@sparklerussell?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Sparkle Russell-Puleri"}, {"url": "https://medium.com/@sparklerussell/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "171 Followers"}, {"url": "https://sparalic.github.io", "anchor_text": "https://sparalic.github.io"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F4c795c746a8d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-future-medical-diagnoses-with-rnns-using-fast-ai-api-from-scratch-ecf78aaf56a2&user=Sparkle+Russell-Puleri&userId=4c795c746a8d&source=post_page-4c795c746a8d--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F6b72d9ab4946&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-future-medical-diagnoses-with-rnns-using-fast-ai-api-from-scratch-ecf78aaf56a2&newsletterV3=4c795c746a8d&newsletterV3Id=6b72d9ab4946&user=Sparkle+Russell-Puleri&userId=4c795c746a8d&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}