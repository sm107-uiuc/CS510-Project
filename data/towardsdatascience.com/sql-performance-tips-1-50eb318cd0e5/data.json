{"url": "https://towardsdatascience.com/sql-performance-tips-1-50eb318cd0e5", "time": 1683017066.521863, "path": "towardsdatascience.com/sql-performance-tips-1-50eb318cd0e5/", "webpage": {"metadata": {"title": "SQL Performance Tips #1. Avoiding self joins and join on\u2026 | by Guilherme Banhudo | Towards Data Science", "h1": "SQL Performance Tips #1", "description": "Many consider SQL to be data science\u2019s ugly brother, often dedicating little time exploring its nuances and capabilities. And yet, SQL is often the primary means of extracting and preparing\u2026"}, "outgoing_paragraph_urls": [], "all_paragraphs": ["Many consider SQL to be data science\u2019s ugly brother, often dedicating little time exploring its nuances and capabilities. And yet, SQL is often the primary means of extracting and preparing information (ETL) to be consumed further on.", "This series of posts attempts to shed light on some of the often misunderstood or unknown details in modern SQL which can severely hinder a query\u2019s performance.", "An introductory note is required: I am by no means an SQL expert, feedback and suggestions are more than welcome.", "The concept of self-join might be daunting for those not used to SQL\u2019s line of thought. But even some seasoned data professionals forget there are alternatives to self-joins, which effectively prevent its complex cardinality.", "A typical use case is to fill in missing event timestamps. For instance, the following table is missing the event\u2019s termination date, which corresponds to the following event date.", "Typical solutions rely on using a self-join, which looks cluttered and inefficient, relying on an extremely declarative structure, like so:", "The same behavior could be emulated using a windowed LEAD term, which effectively retrieves the following event\u2019s timestamp.", "Using a windowed function resulted not only in a cleaner and more succinct code but in significant performance improvements as well. Notice the absence of a loop in the windowed version\u2019s execution plan, a critical aspect of performance.", "But what if you are interested in retrieving the date of the last known event, after the current record? Or the highest event value after the current date? LEAD wouldn\u2019t help much, unless assuming a fixed lag term. Self-joins on the other hand could do the trick, but they can also be incredibly slow. But what if we could simply look-ahead to the entire dataset for the maximum value? We can, using unbounded partitioned windows.", "Unbounded window functions allow a partition to consist of all records immediately preceding or following a given record, typically the current record and apply an aggregating function to all those records.", "In the first case, consider we are interested in retrieving, in addition to the event\u2019s termination date, should it exist, the date of the last known event, disregarding the current date so that if it doesn\u2019t exist, a null is returned instead. To do so, the partition can be modified to skip the current row and retrieve only the posterior records; given the partition is ordered by the event_start_date.", "How about if we want to sum the event value in the preceding and following 2 records?", "Hopefully, this brief section clarified why using self-joins isn\u2019t always the desirable nor optimal path, and whilst grasping window functions can sometimes take a while, it's a critical and life-saving feature.", "Another performance hog is typically found in the use of functions and operators in the join statements, to the detriment of a pure equal join. Although apparently innocent, this can lead to the SQL engine not being able to make reasonable decisions on which indexes to use, being forced instead, to perform full-table scans; another possible consequence is an incorrect resultset estimation which again, forces incorrect index usage.", "For this purpose, consider again a fictional users table, only this time containing user names as well, for one-hundred users, containing a nonclustered index on the name column:", "Let us retrieve the user data associated with Kaseem Moses, trimming the user name considering the IT department incorrectly inserted some spaces:", "Notice that despite not being able to directly find Kaseem Moses, it still managed to select and scan the NIX_users_name index and applying the trimming operation.", "However, we get a drastically different behavior if all fields are selected instead of only selecting the name column:", "Notice how the SQL Server stopped being able to use the nonclustered index. Although in both cases the query estimated 163 results, it actually returned 1 row. It clearly overestimated the resultset, resulting in it thinking the lookup keys would perform poorly, relying on the primary key instead.", "Recall to consistently use the execution plan and its IO statistics to get a grasp of what's happening, not only will it make it easier to spot performance bottlenecks early on, but it can also help you understand the server\u2019s internal makings. In the next articles, the focus will shift increasingly to these tools.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F50eb318cd0e5&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsql-performance-tips-1-50eb318cd0e5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsql-performance-tips-1-50eb318cd0e5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsql-performance-tips-1-50eb318cd0e5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsql-performance-tips-1-50eb318cd0e5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----50eb318cd0e5--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----50eb318cd0e5--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://gbanhudo.medium.com/?source=post_page-----50eb318cd0e5--------------------------------", "anchor_text": ""}, {"url": "https://gbanhudo.medium.com/?source=post_page-----50eb318cd0e5--------------------------------", "anchor_text": "Guilherme Banhudo"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F464f2164bfee&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsql-performance-tips-1-50eb318cd0e5&user=Guilherme+Banhudo&userId=464f2164bfee&source=post_page-464f2164bfee----50eb318cd0e5---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F50eb318cd0e5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsql-performance-tips-1-50eb318cd0e5&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F50eb318cd0e5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsql-performance-tips-1-50eb318cd0e5&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@crisovalle", "anchor_text": "Cris Ovalle"}, {"url": "https://unsplash.com/?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://medium.com/tag/sql?source=post_page-----50eb318cd0e5---------------sql-----------------", "anchor_text": "Sql"}, {"url": "https://medium.com/tag/optimization?source=post_page-----50eb318cd0e5---------------optimization-----------------", "anchor_text": "Optimization"}, {"url": "https://medium.com/tag/data-science?source=post_page-----50eb318cd0e5---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/database?source=post_page-----50eb318cd0e5---------------database-----------------", "anchor_text": "Database"}, {"url": "https://medium.com/tag/technology?source=post_page-----50eb318cd0e5---------------technology-----------------", "anchor_text": "Technology"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F50eb318cd0e5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsql-performance-tips-1-50eb318cd0e5&user=Guilherme+Banhudo&userId=464f2164bfee&source=-----50eb318cd0e5---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F50eb318cd0e5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsql-performance-tips-1-50eb318cd0e5&user=Guilherme+Banhudo&userId=464f2164bfee&source=-----50eb318cd0e5---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F50eb318cd0e5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsql-performance-tips-1-50eb318cd0e5&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----50eb318cd0e5--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F50eb318cd0e5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsql-performance-tips-1-50eb318cd0e5&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----50eb318cd0e5---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----50eb318cd0e5--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----50eb318cd0e5--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----50eb318cd0e5--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----50eb318cd0e5--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----50eb318cd0e5--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----50eb318cd0e5--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----50eb318cd0e5--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----50eb318cd0e5--------------------------------", "anchor_text": ""}, {"url": "https://gbanhudo.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://gbanhudo.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Guilherme Banhudo"}, {"url": "https://gbanhudo.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "59 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F464f2164bfee&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsql-performance-tips-1-50eb318cd0e5&user=Guilherme+Banhudo&userId=464f2164bfee&source=post_page-464f2164bfee--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F978a538038ae&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsql-performance-tips-1-50eb318cd0e5&newsletterV3=464f2164bfee&newsletterV3Id=978a538038ae&user=Guilherme+Banhudo&userId=464f2164bfee&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}