{"url": "https://towardsdatascience.com/celeba-attribute-prediction-and-clustering-with-keras-3d148063098d", "time": 1683000249.701144, "path": "towardsdatascience.com/celeba-attribute-prediction-and-clustering-with-keras-3d148063098d/", "webpage": {"metadata": {"title": "CelebA Attribute Prediction and Clustering with Keras | by Luca Anzalone | Towards Data Science", "h1": "CelebA Attribute Prediction and Clustering with Keras", "description": "A complete guide on how to Detect and Cluster up to 40 facial attributes, using an efficient MobileNetV2-based model with step-by-step Python code, explained and commented."}, "outgoing_paragraph_urls": [{"url": "http://mmlab.ie.cuhk.edu.hk/projects/CelebA.html", "anchor_text": "CelebA dataset", "paragraph_index": 5}, {"url": "http://mmlab.ie.cuhk.edu.hk/projects/CelebA.html", "anchor_text": "here", "paragraph_index": 6}, {"url": "https://github.com/Luca96/face-clustering", "anchor_text": "repository", "paragraph_index": 63}], "all_paragraphs": ["In this article, we talk about facial attribute prediction. We will examine the dataset and point out its weaknesses. Furthermore, we will build and train a deep model and finally discuss the overall results.", "Facial Attribute prediction is a Computer Vision (CV) task about deducing the set of attributes belonging to a face. Example attributes are the color of hair, hairstyle, age, gender, etc.", "In general, facial attribute prediction is a challenging task: it involves face localization first, and then attribute prediction. Moreover, faces are inherently difficult to analyze due to their complex appearance. The appearance of a face can be altered, being even more complex, by face variations. The most common form of face variations are the following:", "Thus, it\u2019s very important that a convolutional model is trained on difficult exemplars of faces in order to generalize well to faces captured in the wild (faces captured under any kind of conditions).", "Facial attribute prediction is not only an academic challenge, but also a way to improve existing applications. For example, a photo app can detect the \u201csmiling\u201d attribute in order to decide which is the best photo among a given sequence.", "A nice, wide, and diversified dataset to work with is the CelebA dataset. It is a large-scale face attributes dataset with more than 200K celebrity images, covering a large amount of variations, each with 40 attribute annotations.", "So, the first thing to do is to download the dataset. It can be found here or on Kaggle, by executing the following code in the terminal:", "After downloading and unzipping it, we can load it in our Python environment or Jupyter Notebook. For this, I\u2019ve prepared the CelebA class that does all the boring work, loading the dataset into a nice Pandas DataFrame:", "Now, its a piece of cake to load the dataset (I assume that its path is celeba-dataset\\) and eventually select a subset of the facial attributes. In the example code, we drop three features.", "After that, we can show some random samples to understand the structure of the celeba dataframe.", "Now we know that every example is associated to a vector of binary labels, where each attribute can be 0 or 1. Therefore, can be very useful to know how much faces an attribute belong to (I omit this but each image of the dataset depicts a single face). By counting the times a 1 occurs for a certain attribute, it is possible to compute its absolute frequency (or even relative frequency by dividing by the total number of samples).", "Here, we can clearly observe a data imbalance problem. The frequency of the facial attributes vary a lot, rather than being roughly equal to each other. There are rare attributes (Bald, Mustache, Double_Chin, etc) with a frequency below 10%, and a couple of very common attributes (No_Beard, Young) with a frequency above 70%.", "This exhibit another issue: the dataset is biased with respect to young and beardless people.", "When the data is imbalanced, the model can easily overfit the datapoints. In this case, it can learn to always output a 1 for every common attributes, and always output a 0 for the rare attributes: the model finds out that this strategy (predicting 0s and 1s) is good (which is not true, because it doesn\u2019t learn patterns). Following this fashion, the model\u2019s output predictions will look like [1, 0, ..., 0, 1] vectors, all the same for every image.", "If that happen, the resulting model is quite dumb: it will only waste computational resources, because it can be replaced by simple code (e.g. random guess, or a constant value).", "The good news is that the problem can be mitigated by using a proper loss function (further details in the next section).", "Finally, the above image shows some images taken from CelebA:", "The model we are going to build is heavily based on the MobileNetV2 architecture, basically is the same model but without the top classification layers (MobileNetV2 is built to output 1000 class probabilities).", "First, the model takes one image (3 channels, 224\u00d7224 in size) at a time as input, and outputs a vector of probabilities of size n (typically, the size vary according to how much attributes you want to detect). The i-th element of the vector is a real number between 0 (attribute i is not present) and 1 (attribute i is present).", "Note that the output vector can contain more than one non-zero elements, meaning that more than one attribute can belong to a face.", "To define the model architecture we have to load the MobileNetV2 architecture without its top layers, set the input size to be 224\u00d7224, and add the new top layers. The following code implements all the needed operations:", "Then to create the model and display its summary (layers, number of parameters, \u2026), run the following code:", "As you can see, creating the model is simple. Here, we will review the newly added top layers:", "Note that without the GlobalAveragePooling layer, a Flatten layer is necessary. Flattening (w, h, n) feature maps results in a layer with w\u00d7h\u00d7n units, instead of n resulting from the application of global average pooling (the number of parameter is, thus, considerably less).", "Finally, the model is pretty simple to create and is even small: it has only 4.3M parameters, being lightweight and fast, making it also suitable for mobile and web applications.", "Sometimes, training a neural network to solve a certain task given a dataset, can be seen as trying to make the network fit the true underlying probability distribution that generates the dataset and the real-world data (the dataset is only a part of the whole data). Usually, the true probability distribution is unknown and can only be partially estimated thanks to the use of a dataset during training.", "The amount of training data impacts directly the generalization capability of the network we are trying to train. Briefly, the generalization error drops as the amount of training data increases.", "The sad news is that, usually, the training data cannot capture the entire probability distribution, because there could be no examples that cover a particular case of the distribution.", "Actually, what we can do is to slightly \u201cedit\u201d the training data in order to intentionally introduce some variations (e.g. rotations, shifts, \u2026) \u2014 we assume that the real-world data could have such variations.", "The practice of Data Augmentation is an effective way to increase the size of the training set. Augmenting the training examples allow the network to \u201csee\u201d more diversified, but still representative, datapoints during training.", "The following code defines a set of augmentations for the training-set: rotation, shift, shear, flip, and zoom.", "Note that both the validation-set and test-set must not be augmented.", "Then we define a couple of data generators: one for training data, and the other for validation data.", "When we deal with big datasets that doesn\u2019t fit into memory, we have to find a way to load only the data actually needed.", "A data generator is capable of loading the required amount of data (a minibatch of images) directly from the source folder, convert them into training data (fed to the model) and training targets (a vector of attributes \u2014 the supervision signal).", "For my experiments, I usually set the batch_size = 80. In general a value between 64 and 128 should work well. Usually you want to increase/decrease the batch size according to computational resources and model\u2019s performances.", "At this point we select the adadelta optimizer (adam optimizer is fine too, but it seems to perform slightly worse) with default values: like adam, adadelta is an optimizer that requires little tuning because it is capable of automatically adapting the learning rate (slowing down when things go wrong, or moving faster towards promising directions).", "The next step, is to chose the loss function: responsible of monitoring the model\u2019s performance and guiding the optimization process.", "I find out that a good loss function for attribute prediction task, is a function able to discriminate the single elements of the attribute vector rather than considering the whole vector as a single object. I mean that the loss must understand that the vector [0, 1, 1, 0] is a lot different from this vector [1, 0, 0, 1](the loss should be high); what is meaningful is the amount of 1s and 0s, and the exact location of the single elements within the input vector.", "Loss functions like Mean Absolute Error (MAE), Mean Square Error (MSE) or Root Mean Square Error (RMSE) are not capable of doing this kind of distinction: intuitively, they just count the 1s over a vector, and average on them, consequently loosing information about position.", "Instead, loss functions like binary cross-entropy and cosine proximity are the ideal choice. Empirically, the latter seems to perform slightly better.", "The last step, is to choose our target performance measure. In this case, we care about maximizing the binary accuracy of the model\u2019s predictions.", "Finally, we can compile our model:", "Before training the model is useful to define one or more callbacks. Pretty handy one, are: ModelCheckpoint and EarlyStopping.", "Actually, I\u2019ve used only the ModelCheckpoint callback because there was no need to use early stopping. Anyway, if you want to play around by changing the model architecture, hyperparameters, loss and optimizer, the use of early stopping is suggested.", "The following code will start training, collecting fitting info into the history variable that provides two learning curve: one for loss, and another for accuracy; which can be both plotted.", "Usually, I set num_epochs to be between 10 and 20. Note that the model reaches more or less 89% of accuracy in the first two epochs. But requires longer training to stuck at about 91% (well, at least this is the maximum accuracy I\u2019ve got).", "Note: each epoch took around 40 minutes to complete (on Google Colab GPU).", "To evaluate the model on the test partition of the dataset, we have to set the test data generator, and let the model make a prediction for each test-data:", "The test accuracy I\u2019ve got is about 90.95%. In particular, each facial attribute is detected with the following accuracy:", "Once we have a working model, we can do stuff like clustering. For this task, the goal of clustering is to group images into clusters where each cluster share the largest possible amount of facial attributes among the images it contains.", "In other words, we want to group images whose faces have similar attributes, like having a blonde girls cluster, guys with hats and eyeglasses, etc.", "For example, if we want to cluster the following ten attributes:", "we may end up with these clusters:", "Here, we can see that each cluster captures one or more facial attributes among the ones that we chosen.", "Note: the above clusters are obtained by running standard clustering algorithms like K-Means, on the model\u2019s predictions.", "To have a better understanding of the attributes that the cluster have captured, we can summarize it and observe the cluster\u2019s summary, instead.", "A cluster can be summarized by extracting its \u201cdistinctive features\u201d. Such a thing can be done by computing the principal components describing the cluster (e.g. using PCA). In this case we have clusters of faces, so we can try to compute an eigenface for each cluster, and see what it looks like\u2026", "Surprisingly, a cluster\u2019s eigenface is able to summarize the entire cluster by producing a synthetic face (not belonging to the cluster) whose facial attributes are the one captured by the cluster.", "In this way, we can see at a glance what are the prominent facial attributes of a set of images, grouped into the same cluster.", "In conclusion, well engineered and general applicable models like MobileNetV2 (or Inception and Resnet models), make possible to build effective task-specific models.", "It is always a good practice to analyze the dataset and observe some of its sample, in order to understand its structure, data, and eventual flaws.", "Attribute prediction is a task that can improve many existing applications and fields (e.g. security, photography, etc).", "I omitted the code about the clustering because is a bit long and convoluted. Anyway, you can find all the code at this repository.", "I recommend experiment with the Jupyter notebook version of the code.", "Hope you enjoyed it, and Thanks for reading it!", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "PhD student in Data Science and Computation @Alma Mater Studiorum"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F3d148063098d&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fceleba-attribute-prediction-and-clustering-with-keras-3d148063098d&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fceleba-attribute-prediction-and-clustering-with-keras-3d148063098d&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fceleba-attribute-prediction-and-clustering-with-keras-3d148063098d&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fceleba-attribute-prediction-and-clustering-with-keras-3d148063098d&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----3d148063098d--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----3d148063098d--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://luca-anzalone.medium.com/?source=post_page-----3d148063098d--------------------------------", "anchor_text": ""}, {"url": "https://luca-anzalone.medium.com/?source=post_page-----3d148063098d--------------------------------", "anchor_text": "Luca Anzalone"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F1f6569b0de4a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fceleba-attribute-prediction-and-clustering-with-keras-3d148063098d&user=Luca+Anzalone&userId=1f6569b0de4a&source=post_page-1f6569b0de4a----3d148063098d---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F3d148063098d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fceleba-attribute-prediction-and-clustering-with-keras-3d148063098d&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F3d148063098d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fceleba-attribute-prediction-and-clustering-with-keras-3d148063098d&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://www.groundai.com/project/multi-task-learning-of-cascaded-cnn-for-facial-attribute-classification/", "anchor_text": "Source"}, {"url": "http://mmlab.ie.cuhk.edu.hk/projects/CelebA.html", "anchor_text": "CelebA dataset"}, {"url": "http://mmlab.ie.cuhk.edu.hk/projects/CelebA.html", "anchor_text": "here"}, {"url": "http://mmlab.ie.cuhk.edu.hk/projects/CelebA.html", "anchor_text": "CelebA"}, {"url": "https://github.com/lutzroeder/netron", "anchor_text": "Netron"}, {"url": "https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=5&cad=rja&uact=8&ved=2ahUKEwjy2dWL0avkAhUG26QKHWMYD4QQFjAEegQICRAB&url=https%3A%2F%2Farxiv.org%2Fabs%2F1409.4842&usg=AOvVaw1agJQRRq17Mx3oRyCZJGOu", "anchor_text": "GoogleLeNet"}, {"url": "http://introtodeeplearning.com/materials/2019_6S191_L6.pdf", "anchor_text": "Source"}, {"url": "http://introtodeeplearning.com/materials/2019_6S191_L1.pdf", "anchor_text": "Source"}, {"url": "https://openaccess.thecvf.com/content_iccv_2015/papers/Liu_Deep_Learning_Face_ICCV_2015_paper.pdf", "anchor_text": "here"}, {"url": "https://github.com/Luca96/face-clustering", "anchor_text": "repository"}, {"url": "https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=2&cad=rja&uact=8&ved=2ahUKEwil44qR4rLkAhXBzaQKHUcRAuUQFjABegQIARAB&url=http%3A%2F%2Fintrotodeeplearning.com%2F&usg=AOvVaw0pc46QlF-SLjGePsq0gDPA", "anchor_text": "MIT 6.S191: Introduction to Deep Learning"}, {"url": "https://medium.com/tag/computer-vision?source=post_page-----3d148063098d---------------computer_vision-----------------", "anchor_text": "Computer Vision"}, {"url": "https://medium.com/tag/attribute-prediction?source=post_page-----3d148063098d---------------attribute_prediction-----------------", "anchor_text": "Attribute Prediction"}, {"url": "https://medium.com/tag/keras?source=post_page-----3d148063098d---------------keras-----------------", "anchor_text": "Keras"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----3d148063098d---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/tag/clustering?source=post_page-----3d148063098d---------------clustering-----------------", "anchor_text": "Clustering"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F3d148063098d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fceleba-attribute-prediction-and-clustering-with-keras-3d148063098d&user=Luca+Anzalone&userId=1f6569b0de4a&source=-----3d148063098d---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F3d148063098d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fceleba-attribute-prediction-and-clustering-with-keras-3d148063098d&user=Luca+Anzalone&userId=1f6569b0de4a&source=-----3d148063098d---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F3d148063098d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fceleba-attribute-prediction-and-clustering-with-keras-3d148063098d&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----3d148063098d--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F3d148063098d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fceleba-attribute-prediction-and-clustering-with-keras-3d148063098d&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----3d148063098d---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----3d148063098d--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----3d148063098d--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----3d148063098d--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----3d148063098d--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----3d148063098d--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----3d148063098d--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----3d148063098d--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----3d148063098d--------------------------------", "anchor_text": ""}, {"url": "https://luca-anzalone.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://luca-anzalone.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Luca Anzalone"}, {"url": "https://luca-anzalone.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "96 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F1f6569b0de4a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fceleba-attribute-prediction-and-clustering-with-keras-3d148063098d&user=Luca+Anzalone&userId=1f6569b0de4a&source=post_page-1f6569b0de4a--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F72dec1d68cf4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fceleba-attribute-prediction-and-clustering-with-keras-3d148063098d&newsletterV3=1f6569b0de4a&newsletterV3Id=72dec1d68cf4&user=Luca+Anzalone&userId=1f6569b0de4a&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}