{"url": "https://towardsdatascience.com/ml-design-pattern-4-keyed-predictions-a8de67d9c0f4", "time": 1683001110.56765, "path": "towardsdatascience.com/ml-design-pattern-4-keyed-predictions-a8de67d9c0f4/", "webpage": {"metadata": {"title": "ML Design Pattern #4: Keyed Predictions | by Lak Lakshmanan | Towards Data Science", "h1": "ML Design Pattern #4: Keyed Predictions", "description": "Normally, you train your model on the same set of inputs that the model will be supplied in real-time. In many situations, however, it can be advantageous for your model to also pass through a\u2026"}, "outgoing_paragraph_urls": [{"url": "https://medium.com/@lakshmanok/machine-learning-design-patterns-58e6ecb013d7", "anchor_text": "Full list here.", "paragraph_index": 0}], "all_paragraphs": ["An occasional series of design patterns for ML engineers. Full list here.", "Normally, you train your model on the same set of inputs that the model will be supplied in real-time. In many situations, however, it can be advantageous for your model to also pass through a client-supplied key.", "If your model is deployed as a web service and accepts a single input, then it is quite clear which output corresponds to which input. What if the model accepts an array of inputs? You might think that it should be obvious that the first output instance corresponds to the first input instance, the second output instance to the second input instance, etc. However, such a 1:1 relationship will cause significant hot spots in your serving infrastructure since whichever server node is unlucky enough to receive a particularly large request will need to compute the output for all the instances in the array. These hot spots will force that you to make your server machines more powerful than they need to be.", "It would, of course, be much more efficient if the receiving node can farm out the instances to a cluster, collect all the resulting outputs, and send them back. But if it does that, then the outputs are going to be jumbled up. How can the client figure out which output corresponds to which input?", "Solution? Have the client supply a key associated with each input. For example, suppose your model is trained with three inputs (a, b, c), shown in green, to produce the output d, shown in yellow. Make your clients supply (k, a, b, c) to your model where k is a key. The key could be as simple as numbering the input instances 1, 2, 3, \u2026, etc. Your model will then return (k, d) and so the client will be able to figure out which output instance corresponds to which input instance.", "This is exactly the same situation that you will run into when you do batch predictions, so keys are useful in that context as well.", "Wait a second \u2026 why can\u2019t the server just assign keys to the inputs it receives before it invokes the model, and then remove the keys before sending along the outputs? Why ask clients to specify a key?", "This is because there are a couple of other situations where keys are useful \u2014 asynchronous serving and evaluation. Many production machine learning models these days are neural networks, and neural networks involve matrix multiplications. Matrix multiplication on hardware like GPUs and TPUs is more efficient if you can ensure that the matrices are within certain size ranges and/or multiples of a certain number. It can, therefore, be helpful to accumulate requests (up to a maximum latency of course) and handle the incoming requests in chunks. Since the chunks will consist of interleaved requests from multiple clients, the key, in this case, needs to have some sort of client identifier as well.", "If you are doing continuous evaluation, it can be helpful to log metadata about the prediction requests, so that you can monitor whether performance drops across the board, or only in specific situations. Such slicing is made much easier if the key identifies the situation in question.", "Because high-performance servers will support both multiple clients, be backed by a cluster, and batch up requests to gain performance benefits, it\u2019s better to plan ahead for this \u2014 ask clients supply keys with every prediction and for clients to specify keys that will not cause a collision with other clients.", "In order to get your Keras model to pass through keys, supply a serving signature when exporting the model.", "For example, this is the code to take a model that would otherwise take 4 inputs (is_male, mother_age, plurality, and gestation_weeks) and have it also take a key that it will pass through to the output along with the original output of the model (the babyweight):", "Note that the code above works even if the original model was not saved with a serving function. Simply load the model using tf.saved_model.load(), attach a serving function and use the code snippet above!", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "articles are personal observations and not investment advice."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fa8de67d9c0f4&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-design-pattern-4-keyed-predictions-a8de67d9c0f4&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-design-pattern-4-keyed-predictions-a8de67d9c0f4&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-design-pattern-4-keyed-predictions-a8de67d9c0f4&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-design-pattern-4-keyed-predictions-a8de67d9c0f4&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----a8de67d9c0f4--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----a8de67d9c0f4--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://lakshmanok.medium.com/?source=post_page-----a8de67d9c0f4--------------------------------", "anchor_text": ""}, {"url": "https://lakshmanok.medium.com/?source=post_page-----a8de67d9c0f4--------------------------------", "anchor_text": "Lak Lakshmanan"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F247b0630b5d6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-design-pattern-4-keyed-predictions-a8de67d9c0f4&user=Lak+Lakshmanan&userId=247b0630b5d6&source=post_page-247b0630b5d6----a8de67d9c0f4---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fa8de67d9c0f4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-design-pattern-4-keyed-predictions-a8de67d9c0f4&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fa8de67d9c0f4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-design-pattern-4-keyed-predictions-a8de67d9c0f4&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://medium.com/@lakshmanok/machine-learning-design-patterns-58e6ecb013d7", "anchor_text": "Full list here."}, {"url": "https://unsplash.com/@bergerteam?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Florian Berger"}, {"url": "https://unsplash.com/s/photos/key?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Unsplash"}, {"url": "http://twitter.com/tf", "anchor_text": "@tf"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----a8de67d9c0f4---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/keras?source=post_page-----a8de67d9c0f4---------------keras-----------------", "anchor_text": "Keras"}, {"url": "https://medium.com/tag/tensorflow?source=post_page-----a8de67d9c0f4---------------tensorflow-----------------", "anchor_text": "TensorFlow"}, {"url": "https://medium.com/tag/serving?source=post_page-----a8de67d9c0f4---------------serving-----------------", "anchor_text": "Serving"}, {"url": "https://medium.com/tag/design-patterns?source=post_page-----a8de67d9c0f4---------------design_patterns-----------------", "anchor_text": "Design Patterns"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fa8de67d9c0f4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-design-pattern-4-keyed-predictions-a8de67d9c0f4&user=Lak+Lakshmanan&userId=247b0630b5d6&source=-----a8de67d9c0f4---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fa8de67d9c0f4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-design-pattern-4-keyed-predictions-a8de67d9c0f4&user=Lak+Lakshmanan&userId=247b0630b5d6&source=-----a8de67d9c0f4---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fa8de67d9c0f4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-design-pattern-4-keyed-predictions-a8de67d9c0f4&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----a8de67d9c0f4--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fa8de67d9c0f4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-design-pattern-4-keyed-predictions-a8de67d9c0f4&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----a8de67d9c0f4---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----a8de67d9c0f4--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----a8de67d9c0f4--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----a8de67d9c0f4--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----a8de67d9c0f4--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----a8de67d9c0f4--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----a8de67d9c0f4--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----a8de67d9c0f4--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----a8de67d9c0f4--------------------------------", "anchor_text": ""}, {"url": "https://lakshmanok.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://lakshmanok.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Lak Lakshmanan"}, {"url": "https://lakshmanok.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "9.3K Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F247b0630b5d6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-design-pattern-4-keyed-predictions-a8de67d9c0f4&user=Lak+Lakshmanan&userId=247b0630b5d6&source=post_page-247b0630b5d6--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F44e3f26acd1a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fml-design-pattern-4-keyed-predictions-a8de67d9c0f4&newsletterV3=247b0630b5d6&newsletterV3Id=44e3f26acd1a&user=Lak+Lakshmanan&userId=247b0630b5d6&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}