{"url": "https://towardsdatascience.com/how-are-convolutions-actually-performed-under-the-hood-226523ce7fbf", "time": 1683002014.00352, "path": "towardsdatascience.com/how-are-convolutions-actually-performed-under-the-hood-226523ce7fbf/", "webpage": {"metadata": {"title": "How Are Convolutions Actually Performed Under the Hood? | by Anirudh Shenoy | Towards Data Science", "h1": "How Are Convolutions Actually Performed Under the Hood?", "description": "In this blog, we\u2019ll look at 2 tricks that PyTorch, TensorFlow, and most other libraries use to make convolutions significantly faster."}, "outgoing_paragraph_urls": [{"url": "https://en.wikipedia.org/wiki/Basic_Linear_Algebra_Subprograms", "anchor_text": "BLAS", "paragraph_index": 19}, {"url": "https://www.tensorflow.org/api_docs/python/tf/nn/conv2d", "anchor_text": "TensorFlow", "paragraph_index": 41}, {"url": "https://www.tensorflow.org/api_docs/python/tf/nn/conv2d", "anchor_text": "docs", "paragraph_index": 41}, {"url": "http://linkedin.com/in/anirudhshenoy/", "anchor_text": "linkedin.com/in/anirudhshenoy/", "paragraph_index": 49}], "all_paragraphs": ["Convolutions have become a fundamental part of modern neural networks because of their ability to capture local information and reduce the number of parameters with weight sharing. Since almost all vision-based models (and a few NLP-models) use convolutions of one form or the other, it\u2019s obvious that we would like to make these operations as fast as possible.", "To emphasis the need for fast convolutions, here\u2019s a profiler output of a simple network with a single 2D convolution layer followed by a Fully Connected layer:", "The convolutional layer followed by the linear layer (addmm) are responsible for ~ 90% of the total execution time. As a consequence, it\u2019s no surprise that several tricks have been developed to speed up this computation as much as possible.", "In this blog, we\u2019ll look at 2 tricks that PyTorch and TensorFlow use to make convolutions significantly faster. We\u2019ll use 2D convolutions since that\u2019s the easiest to visualize, but the exact same concept applies to 1D and 3D convolutions", "Let\u2019s start with a naive implementation for 2D convolution. We\u2019ll use a simple 2x2 kernel with a 3x3 input matrix (with 1 channel):", "The naive implementation is quite simple to understand, we simply traverse the input matrix and pull out \u201cwindows\u201d that are equal to the shape of the kernel. For each window, we do simple element-wise multiplication with the kernel and sum up all the values. Finally, before returning the result we add the bias term to each element of the output.", "We can quickly verify that we\u2019re getting the correct result by checking the output with PyTorch\u2019s own conv2d layer.", "And here\u2019s the execution time for both of them:", "Now let\u2019s check how the execution time changes when the kernel size is kept the same and the size of the input matrix is slowly varied.", "The 2 for-loops in our implementation are responsible for O(n\u00b2) execution time and as the input size increases beyond 250 x 250, Naive Conv takes 1\u20133 secs per matrix. If we had a huge network like Inception Net with hundreds of convolutions and thousands of large input matrices, naive convolution would be an absolutely terrible idea.", "However, notice that PyTorch\u2019s own implementation scales very well with the input matrix size. Clearly, PyTorch does convolutions differently.", "While multiplying each window with the kernel we did 2 operations:", "\u2026.and we did this for each window in the input matrix.", "Now the important question to ask here is: Can we vectorize this entire operation?", "The answer is Yes and that\u2019s exactly what im2col helps us do (which stands for Image Block to Column)", "Simply put, im2col is a technique where we take each window, flatten it out and stack them as columns in a matrix. Now, if we flatten out the kernel into a row vector and do matrix multiplication between the two, we should get the exact same result after reshaping the output.", "And now we flatten the kernel and do matrix multiplication:", "Now let\u2019s check how it scales:", "Vectorizing definitely helped but there\u2019s still room for improvement. Before we move on to the next trick, let\u2019s see why vectorizing actually helps.", "All modern CPUs and GPUs come with optimized matrix algebra libraries that allow code to take advantage of hardware acceleration. These libraries fall under the umbrella term of BLAS or Basic Linear Algebra Subroutines. When we vectorize code and call np.dot() it allows numpy to use the BLAS Library allowing for faster execution.", "In fact, in the earlier profiler output, you might have seen this:", "MKLDNN stands for Math Kernel Library for Deep Neural Networks which is Intel\u2019s BLAS library. Since I ran the PyTorch model on my Intel i7, PyTorch automatically called Intel\u2019s BLAS library. If you ran this on an Nvidia GPU, PyTorch would have used cuBLAS (Nvidia\u2019s BLAS library).", "The next trick involves getting rid of the 2- for loops and creating the im2col matrix efficiently.", "While creating the windows in im2col we still used 2 for loops to index the input matrix, which slows down execution. To understand how to improve this we need to take a look at how numpy arrays are stored in memory.", "Just like all other arrays, numpy arrays are stored as contiguous blocks in memory. Each numpy array also has a .strides attribute that tells us how many bytes need to be jumped to access the next element.", "Each element is int64 i.e. 64bits or 8bytes and this is why x.strides tells us we need to jumpy 8bytes to access the next element in the array.", "When dealing with 2D arrays we get two stride values telling us how many bytes to jump in the column direction and the row direction.", "Now here\u2019s the interesting part, numpy gives us the ability to change the strides of any numpy array by using a function callednp.lib.stride_tricks.as_strided. Based on what stride values we provide, this function simply changes the way we look at the array in memory and generates a new \u201cview\u201d.", "Instead of jumping 24bytes (3 elements) to start the next row we used as_strided to jump only 8 bytes (1 element) when starting the next row. Using the shape parameter we can also set the output shape as needed.", "Note: As mentioned earlier, as_strided changes the way we look at the array in the memory. This means if we change a value in the \u201cview\u201d it changes the value in memory which changes the element in the original matrix.", "Since as_strided does not use any loops to create these \u201cviews\u201d we can use it to efficiently generate the windows for convolution. All we need to do is calculate the right stride values and output shape and as_strided does the rest for us.", "However, if we provide wrong stride values,as_strided will access memory locations that are outside the array and return junk values. Luckily, the view_as_windows function in the scikit-images library does all the heavy lifting for us by calculating the shape and stride values automatically while using as_strided in the background:", "Here\u2019s the final function that does all of these:", "Now we can do matrix multiplication, in the same way we did previously:", "Let\u2019s check how it compares against all the other implementations so far:", "Using as_strided has significantly increased the speed of our implementation! In fact, it\u2019s almost as fast as PyTorch.", "Also, if you noticed in the profiler output, PyTorch uses its own as_strided function before convolution:", "Since we need to create columns for each window of the input matrix, the im2col matrix ends up consuming more memory than the naive implementation.", "However, the improvements in speed(shown in table below) far outweigh the difficulties with increased memory consumption.", "Here\u2019s a summary of the execution times for all implementations. The kernel size (2 x 2) was held constant while the input size was changed. I ran all of these on my Intel i7 processor.", "It\u2019s incredible that we were able to get almost 150x improvement over Naive convolution with just 2 simple tricks. The PyTorch implementation is still 2x faster than our Memory Strided im2col implementation. This is most likely because PyTorch has its own tensor implementation that might be optimized for bigger matrices. In fact, our implementation is faster than PyTorch for matrix sizes below 50 x 50.", "Although we used only PyTorch here, TensorFlow also performs the exact same set of operations while performing convolutions (docs).", "And finally, here\u2019s how our implementation would change when padding, strides or 1D/3D convolutions are used:", "Padding: If we added padding it would make no difference to our implementation, as padding is generally applied before convolution. However, the output shape would have to be correctly calculated.", "Strides: Here we assumed a stride of 1. A larger stride would just slide the window with bigger jumps, which means the strides in as_strided would have to be re-calculated. However, the concept remains the same. ( In fact, view_as_windows has a step parameter that takes care of strides as well. )", "More Filters: In our examples, we assumed a single filter for the kernel. If we had more filters, each filter would be flattened out to give us a matrix instead of vector. Next, we would multiply this matrix with the im2col matrix. This means we would multiply a matrix by a matrix instead of vector by matrix to get the output.", "1D or 3D Convolution: The columns in the im2col matrix would just be shorter or taller since the size of the window changes (depending on the kernel as well).", "I hope you enjoyed and found this useful! Feel free to connect with me for any questions or comments.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Product @ Yellow Messenger | Breaking down Machine Learning & Data Science topics into simple concepts | linkedin.com/in/anirudhshenoy/ | Views are personal |"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F226523ce7fbf&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-are-convolutions-actually-performed-under-the-hood-226523ce7fbf&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-are-convolutions-actually-performed-under-the-hood-226523ce7fbf&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-are-convolutions-actually-performed-under-the-hood-226523ce7fbf&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-are-convolutions-actually-performed-under-the-hood-226523ce7fbf&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----226523ce7fbf--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----226523ce7fbf--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://anirudhshenoy.medium.com/?source=post_page-----226523ce7fbf--------------------------------", "anchor_text": ""}, {"url": "https://anirudhshenoy.medium.com/?source=post_page-----226523ce7fbf--------------------------------", "anchor_text": "Anirudh Shenoy"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fc577fea1786&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-are-convolutions-actually-performed-under-the-hood-226523ce7fbf&user=Anirudh+Shenoy&userId=c577fea1786&source=post_page-c577fea1786----226523ce7fbf---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F226523ce7fbf&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-are-convolutions-actually-performed-under-the-hood-226523ce7fbf&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F226523ce7fbf&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-are-convolutions-actually-performed-under-the-hood-226523ce7fbf&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@thekidnamedhosea?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Hosea Georgeson"}, {"url": "https://unsplash.com/s/photos/under-the-hood?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Unsplash"}, {"url": "https://en.wikipedia.org/wiki/Basic_Linear_Algebra_Subprograms", "anchor_text": "BLAS"}, {"url": "https://stackoverflow.com/questions/53097952/how-to-understand-numpy-strides-for-layman", "anchor_text": "on StackOverflow"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/nn/conv2d", "anchor_text": "TensorFlow"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/nn/conv2d", "anchor_text": "docs"}, {"url": "https://gist.github.com/anirudhshenoy/089a70deed944d0ca7ab0b6a5eb5a7f1", "anchor_text": "https://gist.github.com/anirudhshenoy/089a70deed944d0ca7ab0b6a5eb5a7f1"}, {"url": "http://cs231n.stanford.edu/slides/2016/winter1516_lecture11.pdf", "anchor_text": "http://cs231n.stanford.edu/slides/2016/winter1516_lecture11.pdf"}, {"url": "https://stackoverflow.com/questions/53097952/how-to-understand-numpy-strides-for-layman", "anchor_text": "https://stackoverflow.com/questions/53097952/how-to-understand-numpy-strides-for-layman"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/nn/conv2d", "anchor_text": "https://www.tensorflow.org/api_docs/python/tf/nn/conv2d"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----226523ce7fbf---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/programming?source=post_page-----226523ce7fbf---------------programming-----------------", "anchor_text": "Programming"}, {"url": "https://medium.com/tag/data-science?source=post_page-----226523ce7fbf---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----226523ce7fbf---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----226523ce7fbf---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F226523ce7fbf&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-are-convolutions-actually-performed-under-the-hood-226523ce7fbf&user=Anirudh+Shenoy&userId=c577fea1786&source=-----226523ce7fbf---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F226523ce7fbf&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-are-convolutions-actually-performed-under-the-hood-226523ce7fbf&user=Anirudh+Shenoy&userId=c577fea1786&source=-----226523ce7fbf---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F226523ce7fbf&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-are-convolutions-actually-performed-under-the-hood-226523ce7fbf&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----226523ce7fbf--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F226523ce7fbf&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-are-convolutions-actually-performed-under-the-hood-226523ce7fbf&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----226523ce7fbf---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----226523ce7fbf--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----226523ce7fbf--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----226523ce7fbf--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----226523ce7fbf--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----226523ce7fbf--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----226523ce7fbf--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----226523ce7fbf--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----226523ce7fbf--------------------------------", "anchor_text": ""}, {"url": "https://anirudhshenoy.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://anirudhshenoy.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Anirudh Shenoy"}, {"url": "https://anirudhshenoy.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "163 Followers"}, {"url": "http://linkedin.com/in/anirudhshenoy/", "anchor_text": "linkedin.com/in/anirudhshenoy/"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fc577fea1786&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-are-convolutions-actually-performed-under-the-hood-226523ce7fbf&user=Anirudh+Shenoy&userId=c577fea1786&source=post_page-c577fea1786--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fa7b82d481cff&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-are-convolutions-actually-performed-under-the-hood-226523ce7fbf&newsletterV3=c577fea1786&newsletterV3Id=a7b82d481cff&user=Anirudh+Shenoy&userId=c577fea1786&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}