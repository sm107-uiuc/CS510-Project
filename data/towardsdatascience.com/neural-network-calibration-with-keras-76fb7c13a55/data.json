{"url": "https://towardsdatascience.com/neural-network-calibration-with-keras-76fb7c13a55", "time": 1683005828.697396, "path": "towardsdatascience.com/neural-network-calibration-with-keras-76fb7c13a55/", "webpage": {"metadata": {"title": "Neural Network Calibration with Keras | by Marco Cerliani | Towards Data Science", "h1": "Neural Network Calibration with Keras", "description": "The concept of probability is very common in the machine learning field. In classification tasks, probabilities are the output scores of almost every predictive model together with the relative\u2026"}, "outgoing_paragraph_urls": [{"url": "https://www.kaggle.com/c/DontGetKicked", "anchor_text": "Don\u2019t Get Kicked!", "paragraph_index": 3}], "all_paragraphs": ["The concept of probability is very common in the machine learning field. In classification tasks, probabilities are the output scores of almost every predictive model together with the relative labels. Show them together is more informative than providing only a raw classification report. In this way, we use probabilities as confidence scores to approximate the uncertainty of our model predictions. This is a common practice and reflects how we reason.", "The problem is that our algorithms aren\u2019t intelligent enough to provide probabilities in the form of trustable confidence scores. They tend to not calibrate results, i.e. they overestimate or underestimate probabilities if we compare them with the expected accuracy. This results in misleading reliability, corrupting our decision policy.", "In this post, we want to play with probabilities facing the problem of neural network calibration. As we\u2019ll see, build a calibrated model is not obvious and we must take care during its development. We operate the adequate technique to calibrate scores in a real classification problem to not get kicked in auto auctions where the risk is to purchase a \u2018lemon\u2019.", "The dataset is collected from Kaggle, from a past competition \u2018Don\u2019t Get Kicked!\u2019. The challenge of this competition is to predict if the car purchased at the Auction is a Kick (bad buy). Kicked cars often result when there are serious issues or some other unforeseen problems on vehicles, causing high costs to dealers. We have to figure out which cars have a higher risk of being kick, providing real value to dealerships. The problem can be carried out as a binary classification task (good or bad buy?).", "The variables at our disposal are a mix of categorical and numerical:", "We operate a standard preprocessing: NaNs values are filled with medians (for numerical) and \u2018unknown\u2019 class (for categorical). The numerical variables are then standard scaled and the categorical are ordinally encoded.", "The model, used to predict if our purchase is a good deal, is a feed-forward neural network with categorical embeddings. The categorical embeddings are connected at the second level, while in the final parts we maintain the separation among raw output layer (logits) and activation (softmax) for probability computation. This little trick will be useful for us when we\u2019ll have to calibrate our model.", "We separate our initial dataset in train, validation, and test. The validation will be firstly used for network tuning and in the second stage to fit the temperature scale coefficient for the calibration procedure. After fitting we achieve 0.90% accuracy with great precision on the test data, which is better than a random model that classifies all cars as a good deal.", "As we can see, our model can grant good performance on unseen data. But how reliable this result is? The advantage of predicting well-calibrated probabilities is that we can be confident if the predicted probability is close to 1 or 0, and not so confident otherwise. In our case, if not, our classifier may over-predict similar cars as \u2018lemon\u2019 which may result in decisions to not buy cars which are actually in good condition.", "By definition, a model is perfectly calibrated if, for any probability value p, correspond a prediction of a class with an accuracy level of p*100 %. To check if our classifier is well-calibrated all we need to do is a plot! At the same time, produce calibrated probabilities is very simple as applying a post-process technique.", "The first step is to plot the reliability diagram, where we can compare the expected accuracy versus prediction confidences. The fraction of positives and mean predicted value are calculated, for convenience reasons, per equal-width groups/bins. This can be computed for binary or multiclass problems and results in a curve for each class.", "The optimal situation is when we have a perfect linear relationship between the computed probability and the fraction of positives (blue dashed line). In our case, our neural network tends to respectively overestimate and underestimate a little the probabilities of the two classes in the middle. We can quantify the goodness of calibration with a proper index, the so-called Expected Calibration Error (ECE), that is the weighted (proportion of samples in each bin) average of the difference between expected accuracy and prediction confidence (the lower the better).", "We can adjust the ECE by applying a technique, which is an extension of Temperature scaling, known as Platt scaling. The neural network outputs a vector known as logits. Platt scaling simply divides the logits vector by a learned scalar parameter T, before passing it through a softmax function to get class probabilities.", "Practically speaking with few lines of code, we can build our function to compute the Temperature scaling. The scaling factor T is learned on a predefined validation set, where we try to minimize a mean cost function (in TensorFlow: tf.nn.softmax_cross_entropy_with_logits). The inputs and output will be respectively our logits, scaled with the learnable T, and the true output in the form of dummy vectors. The train is computed classically with the stochastic gradient descent method.", "In the end, the ECE score on the scaled probability records an improvement in both the classes. As we can also see above on the new reliability diagrams, we can produce better-calibrated probabilities.", "In this post, we\u2019ve examined a post-process technique to calibrate the probabilities of our neural network and let it, when it\u2019 possible (not always temperature scaling is effective), a more trustable instrument. It\u2019s a very simple trick applicable anywhere, which became useful if we care about the probabilities our model computes to make a decision.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F76fb7c13a55&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-with-keras-76fb7c13a55&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-with-keras-76fb7c13a55&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-with-keras-76fb7c13a55&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-with-keras-76fb7c13a55&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----76fb7c13a55--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----76fb7c13a55--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@cerlymarco?source=post_page-----76fb7c13a55--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@cerlymarco?source=post_page-----76fb7c13a55--------------------------------", "anchor_text": "Marco Cerliani"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fc843902314c7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-with-keras-76fb7c13a55&user=Marco+Cerliani&userId=c843902314c7&source=post_page-c843902314c7----76fb7c13a55---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F76fb7c13a55&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-with-keras-76fb7c13a55&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F76fb7c13a55&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-with-keras-76fb7c13a55&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@_lewis_f?utm_source=medium&utm_medium=referral", "anchor_text": "Lewis Fagg"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://www.kaggle.com/c/DontGetKicked", "anchor_text": "Don\u2019t Get Kicked!"}, {"url": "https://github.com/cerlymarco/MEDIUM_NoteBook", "anchor_text": "CHECK MY GITHUB REPO"}, {"url": "https://www.linkedin.com/in/marco-cerliani-b0bba714b/", "anchor_text": "Linkedin"}, {"url": "https://medium.com/stellargraph/graph-neural-network-model-calibration-for-trusted-predictions-e49628487e7b", "anchor_text": "StellarGraph \u2014 Machine Learning on Graphs"}, {"url": "https://medium.com/tag/data-science?source=post_page-----76fb7c13a55---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----76fb7c13a55---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/neural-networks?source=post_page-----76fb7c13a55---------------neural_networks-----------------", "anchor_text": "Neural Networks"}, {"url": "https://medium.com/tag/probability?source=post_page-----76fb7c13a55---------------probability-----------------", "anchor_text": "Probability"}, {"url": "https://medium.com/tag/towards-data-science?source=post_page-----76fb7c13a55---------------towards_data_science-----------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F76fb7c13a55&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-with-keras-76fb7c13a55&user=Marco+Cerliani&userId=c843902314c7&source=-----76fb7c13a55---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F76fb7c13a55&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-with-keras-76fb7c13a55&user=Marco+Cerliani&userId=c843902314c7&source=-----76fb7c13a55---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F76fb7c13a55&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-with-keras-76fb7c13a55&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----76fb7c13a55--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F76fb7c13a55&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-with-keras-76fb7c13a55&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----76fb7c13a55---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----76fb7c13a55--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----76fb7c13a55--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----76fb7c13a55--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----76fb7c13a55--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----76fb7c13a55--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----76fb7c13a55--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----76fb7c13a55--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----76fb7c13a55--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@cerlymarco?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@cerlymarco?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Marco Cerliani"}, {"url": "https://medium.com/@cerlymarco/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "6K Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fc843902314c7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-with-keras-76fb7c13a55&user=Marco+Cerliani&userId=c843902314c7&source=post_page-c843902314c7--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fe2412974851a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-with-keras-76fb7c13a55&newsletterV3=c843902314c7&newsletterV3Id=e2412974851a&user=Marco+Cerliani&userId=c843902314c7&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}