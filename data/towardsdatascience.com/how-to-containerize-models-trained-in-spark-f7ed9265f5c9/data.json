{"url": "https://towardsdatascience.com/how-to-containerize-models-trained-in-spark-f7ed9265f5c9", "time": 1683005981.6617038, "path": "towardsdatascience.com/how-to-containerize-models-trained-in-spark-f7ed9265f5c9/", "webpage": {"metadata": {"title": "How to Containerize Models Trained in Spark: MLLib, ONNX and more | by Facundo Santiago | Towards Data Science", "h1": "How to Containerize Models Trained in Spark: MLLib, ONNX and more", "description": "If we shall name two trends in modern applications, one should mention containers and machine learning. More and more applications are taking advantage of containerized microservices architectures in\u2026"}, "outgoing_paragraph_urls": [{"url": "https://spark.apache.org/docs/latest/ml-pipeline.html", "anchor_text": "an ML model is represented by a", "paragraph_index": 4}, {"url": "https://spark.apache.org/docs/latest/ml-pipeline.html", "anchor_text": "Transformer", "paragraph_index": 4}, {"url": "https://spark.apache.org/docs/1.6.1/ml-guide.html", "anchor_text": "spark.apache.org", "paragraph_index": 5}, {"url": "https://github.com/onnx/onnxmltools/tree/master/onnxmltools/convert/sparkml", "anchor_text": "In Spark this includes", "paragraph_index": 8}, {"url": "https://pypi.org/project/onnxmltools/", "anchor_text": "onnxmltools", "paragraph_index": 9}, {"url": "https://github.com/santiagxf/portable-sparkml/blob/master/score_onnx.py", "anchor_text": "a sample scoring file in the following GitHub link", "paragraph_index": 17}, {"url": "https://github.com/santiagxf/portable-sparkml/blob/master/score_pyspark.py", "anchor_text": "a sample scoring file in the following GitHub link", "paragraph_index": 26}, {"url": "https://github.com/santiagxf/portable-sparkml", "anchor_text": "the GitHub repository", "paragraph_index": 27}], "all_paragraphs": ["If we shall name two trends in modern applications, one should mention containers and machine learning. More and more applications are taking advantage of containerized microservices architectures in order to enable improved elasticity, fault-tolerance, and scalability \u2014 whether or on-premise or in the cloud. At the same time, achine Learning have increasingly become a basic requirement in any application.", "However, the two things do not always get on each other, and this is the case of Spark. Spark is now-a-days the industry defacto standard for big data analytics, either by using Cloudera, Azure Databricks, AWS EMR, or whatever. But what about if you want to use the model you trained in Spark somewhere else outside the cluster?", "There are a couple of options for this:", "ONNX is an open-standard for serialization and specification of a machine learning model. Since the format describes the computation graph (input, output and operations), it is self-contained. It is focused on deep-learning and it is championed mainly by Microsoft and Facebook. Supported in many frameworks like TensorFlow and PyTorch.", "In Spark, an ML model is represented by aTransformer which transforms an inputDataFrame with features into another DataFrame with predictions. A Transformer can also output another set of features. Since in Machine Learning you usually have to perform several steps to produce the desired prediction, Spark has aPipelineModelobject which is a sequence of steps or Transformers(note that the pipeline object is a bit more complex, but for the sake of simplicity of this post, we will assume it as that). It chains multiple Transformers together to specify a ML workflow.", "Consider the following example from spark.apache.org where we have a PipelineModelwith 3 stages: A tokenizer (which takes text and return words), a Hashing function (which takes words and returns vectors) and a Logistic Regression Model (which takes features and return predictions).", "You get a PipelineModel by training a Pipeline using the method fit(). Here you have an example:", "Now the question is, how to run this PipelineModel object outside Spark?", "ONNX is designed for deep-learning models, however, it supports in some extends more \u201ctraditional\u201d machine learning techniques. Spark is commonly used for those more traditional approaches. In Spark this includes:", "To export your model to an ONNX format, you need to install first onnxmltools which is available right now only for PySpark. Depending on the platform you are using the way you will install the library. In my case, I\u2019m using Azure Databricks, so I will install this library using the Install library option in the cluster.", "Once the library is installed, then you can export your pipeline model into ONNX by:", "Note: This last parameter isn\u2019t documented in the GitHub repository but after some debuging I needed to specify it to avoid a null spark context being used. In my case I\u2019m using Azure Databricks, so I don\u2019t know if this is specific to Databricks or not.", "Once the model is converted, you can persist it into a file by:", "You can load this model easily using ONNX runtime in Python like:", "Note: input_data is a dictionary with keys as feature names, and Tensors (1,1) as values. The reshape function transform the input to an array of Tensor with shape (feature_count,1,1), which is expected. It is also important to cast the values as float32.", "You then can ship this model in a docker container with Python and the following libraries installed:", "Your scoring file will load the model using the onnxruntime.InferenceSession() method. You usually perform this once. Your scoring routine will call session.run() on the other hand.", "I have a sample scoring file in the following GitHub link.", "By the time writing this post, the following features are missing in the Spark to ONNX converter:", "Another way to run a PipelineModel inside of a container is to export the model and create a Spark context inside of the container even when there is not cluster available.", "If you want to persist this PipelineModel, the object implements the interface MLWritable, which exponses the method save(path) and write().overwrite().save(path). This method saves the model in a folder structure like the following:", "In this structure, the PipelineModel is persisted inside a folder structure where all the steps in the pipeline are detailed. In this case, this model I created has 2 stages: a VectorAssembler and a GradientBoostedRegressor. Opposite as what you may be used to, all the structure is required to load and restore the trained model. If you are using a model registry, like MLFlow or Azure Machine Learning Services, I suggest you zip the directory in an archive. The following line helps to do so:", "Please notice that shutil.make_archive will create the file in the driver node in its local file system.", "Since you will be loading the Spark model directly, you will need to install pyspark Python library in the container image. Then in your scoring script you will create a spark session, unpack the archive in a folder and load the PipelineModel object.", "The variables spark and trainedModel have to be available in all the routines. Personally, I declare those two as global variables.", "Then, you run your model by:", "I have a sample scoring file in the following GitHub link.", "We reviewed in this post two different ways to port models trained inside a Spark cluster to run them inside a container. Using the open-standard ONNX or loading the persisted model in an Spark context. You can check the GitHub repository if you want to see the complete code for the examples. There is also a Databricks notebook to generate both the ONNX file and the MLLib zip file. Hope it helps.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Product Manager @ Microsoft AI. Graduate adjunct professor at University of Buenos Aires. Frustrated sociologist."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Ff7ed9265f5c9&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-containerize-models-trained-in-spark-f7ed9265f5c9&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-containerize-models-trained-in-spark-f7ed9265f5c9&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-containerize-models-trained-in-spark-f7ed9265f5c9&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-containerize-models-trained-in-spark-f7ed9265f5c9&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----f7ed9265f5c9--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----f7ed9265f5c9--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://santiagof.medium.com/?source=post_page-----f7ed9265f5c9--------------------------------", "anchor_text": ""}, {"url": "https://santiagof.medium.com/?source=post_page-----f7ed9265f5c9--------------------------------", "anchor_text": "Facundo Santiago"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Ff8050e1eb986&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-containerize-models-trained-in-spark-f7ed9265f5c9&user=Facundo+Santiago&userId=f8050e1eb986&source=post_page-f8050e1eb986----f7ed9265f5c9---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ff7ed9265f5c9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-containerize-models-trained-in-spark-f7ed9265f5c9&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ff7ed9265f5c9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-containerize-models-trained-in-spark-f7ed9265f5c9&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://santiagof.medium.com/effortless-models-deployment-with-mlflow-2b1b443ff157", "anchor_text": "Effortless deployments using MLFlow"}, {"url": "https://spark.apache.org/docs/latest/ml-pipeline.html", "anchor_text": "an ML model is represented by a"}, {"url": "https://spark.apache.org/docs/latest/ml-pipeline.html", "anchor_text": "Transformer"}, {"url": "https://spark.apache.org/docs/1.6.1/ml-guide.html", "anchor_text": "spark.apache.org"}, {"url": "https://spark.apache.org/docs/1.6.1/ml-guide.html", "anchor_text": "spark.apache.org"}, {"url": "https://github.com/onnx/onnxmltools/tree/master/onnxmltools/convert/sparkml", "anchor_text": "In Spark this includes"}, {"url": "https://pypi.org/project/onnxmltools/", "anchor_text": "onnxmltools"}, {"url": "https://pypi.org/project/onnxmltools/", "anchor_text": "onnxruntime"}, {"url": "https://github.com/santiagxf/portable-sparkml/blob/master/score_onnx.py", "anchor_text": "a sample scoring file in the following GitHub link"}, {"url": "https://github.com/santiagxf/portable-sparkml/blob/master/score_pyspark.py", "anchor_text": "a sample scoring file in the following GitHub link"}, {"url": "https://github.com/santiagxf/portable-sparkml", "anchor_text": "the GitHub repository"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----f7ed9265f5c9---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/spark?source=post_page-----f7ed9265f5c9---------------spark-----------------", "anchor_text": "Spark"}, {"url": "https://medium.com/tag/onnx?source=post_page-----f7ed9265f5c9---------------onnx-----------------", "anchor_text": "Onnx"}, {"url": "https://medium.com/tag/towards-data-science?source=post_page-----f7ed9265f5c9---------------towards_data_science-----------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Ff7ed9265f5c9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-containerize-models-trained-in-spark-f7ed9265f5c9&user=Facundo+Santiago&userId=f8050e1eb986&source=-----f7ed9265f5c9---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Ff7ed9265f5c9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-containerize-models-trained-in-spark-f7ed9265f5c9&user=Facundo+Santiago&userId=f8050e1eb986&source=-----f7ed9265f5c9---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ff7ed9265f5c9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-containerize-models-trained-in-spark-f7ed9265f5c9&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----f7ed9265f5c9--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Ff7ed9265f5c9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-containerize-models-trained-in-spark-f7ed9265f5c9&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----f7ed9265f5c9---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----f7ed9265f5c9--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----f7ed9265f5c9--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----f7ed9265f5c9--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----f7ed9265f5c9--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----f7ed9265f5c9--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----f7ed9265f5c9--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----f7ed9265f5c9--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----f7ed9265f5c9--------------------------------", "anchor_text": ""}, {"url": "https://santiagof.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://santiagof.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Facundo Santiago"}, {"url": "https://santiagof.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "487 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Ff8050e1eb986&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-containerize-models-trained-in-spark-f7ed9265f5c9&user=Facundo+Santiago&userId=f8050e1eb986&source=post_page-f8050e1eb986--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F83b63ed9696e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-containerize-models-trained-in-spark-f7ed9265f5c9&newsletterV3=f8050e1eb986&newsletterV3Id=83b63ed9696e&user=Facundo+Santiago&userId=f8050e1eb986&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}