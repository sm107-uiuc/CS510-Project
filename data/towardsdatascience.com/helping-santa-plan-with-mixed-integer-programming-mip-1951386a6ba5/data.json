{"url": "https://towardsdatascience.com/helping-santa-plan-with-mixed-integer-programming-mip-1951386a6ba5", "time": 1683002933.089702, "path": "towardsdatascience.com/helping-santa-plan-with-mixed-integer-programming-mip-1951386a6ba5/", "webpage": {"metadata": {"title": "Helping Santa plan with Mixed Integer Programming (MIP) | by Gilles Vandewiele | Towards Data Science", "h1": "Helping Santa plan with Mixed Integer Programming (MIP)", "description": "This year, Bram Steenwinckel and I ensured our Christmas gifts by being the 28th team (of more than 1600 participants) to deliver Santa an optimal schedule for his annual 100-day workshop. This blog\u2026"}, "outgoing_paragraph_urls": [{"url": "https://bsteenwi.github.io/", "anchor_text": "Bram Steenwinckel", "paragraph_index": 0}, {"url": "https://opensourc.es/blog/kaggle-santa-2019", "anchor_text": "blog post", "paragraph_index": 11}, {"url": "https://www.kaggle.com/xhlulu/santa-s-2019-faster-cost-function-24-s", "anchor_text": "C implementations", "paragraph_index": 14}, {"url": "https://www.kaggle.com/khahuras/the-elegant-prize", "anchor_text": "but only the affected ones", "paragraph_index": 14}, {"url": "https://en.wikipedia.org/wiki/Sinterklaas", "anchor_text": "Sinterklaas", "paragraph_index": 15}, {"url": "https://twitter.com/localsolver/status/1203002028282257409", "anchor_text": "tweeted", "paragraph_index": 15}, {"url": "https://www.kaggle.com/ghostskipper/visualising-results", "anchor_text": "public kernel", "paragraph_index": 27}], "all_paragraphs": ["This year, Bram Steenwinckel and I ensured our Christmas gifts by being the 28th team (of more than 1600 participants) to deliver Santa an optimal schedule for his annual 100-day workshop. This blog post contains a problem description and the different steps we took to achieve this optimal solution.", "DISCLAIMER: Bram and I are, by no means, experts in optimization. Nevertheless, we had a lot of fun and learned a lot.", "Each year, Santa organizes a Christmas workshop spanning 100 days, allowing 5000 families to attend it. Each of the families (consisting of a certain number of family members) can provide a list of their top 10 preferences of days that they would like to attend. As the workshop venue has only a limited capacity (there must be between 125 and 300 attendants each day), it is impossible to grant everyone their first choice. Therefore, compensations are provided to families that do not get their first pick. A family of size N, not getting their first pick would get:", "Oh boy, I wouldn\u2019t mind not getting a pick from my top 10 list. I can already imagine myself sitting next to Santa for a helicopter ride over the North Pole. Also, $500 and a free dinner is not too shabby.", "But that\u2019s not all\u2026 There\u2019s also an accounting penalty if we do not uniformly distribute the number of attendants over the 100 days:", "The ultimate goal is to create an assignment of these 5000 families to one of the 100 days that minimizes the sum of the preference and accounting costs.", "Let\u2019s take a closer look at the provided data of the 5000 families. First, let\u2019s check the family sizes:", "So it seems that the family sizes are somewhat normally distributed with a size of 4 being the mode. Now let\u2019s look at the days provided as first choice:", "Clearly, day 1 is a very popular one. Actually, the days count backwards, day d means d days before Christmas. As such, day 1 is the day right before Christmas, which explains why it is so popular. Moreover, we see periodical peaks corresponding to weekends. Let\u2019s create a heatmap of the (logarithm of the) preference costs in function of the family size and assigned choice:", "Finally, let\u2019s take a look at a heatmap for the log of the accounting costs:", "Our first attempt was a very naive one. As the number of attendants each day had to be at least 125, we kept a list of days that did not yet have 125 attendants. We then iterated over each of the families and assigned it to one of its choices that is still in the list. If none of the family\u2019s choices is within that list, we just assigned it to the best choice, ensuring the attendants on that day would not exceed 300.", "Shortly after the launch of the competition, a blog post was published by opensourc.es which achieved a much better score than what we currently were achieving. His strategy was to ignore the accounting cost, and minimize the preference cost by using the Hungarian method. The vanilla implementation tries to uniformly assign the families (50 per day). We quickly extended that approach by assigning more families to more popular days. We actually tried to solve the following optimization problem for a while: find a 100-dimensional vector V of which the elements sum to 5000 (number of families) that results in a minimal cost when provided to the Hungarian algorithm. V[i] would then be the number of families assigned to day i. Unfortunately, this what somewhat of an \u201cexpensive\u201d problem, for each new V, we had to re-run the Hungarian method which took some time. With our final vector, a score of 95441 was achieved as opposed to the 144287, achieved by the original proposal. A code snippet for this can be found below.", "We then implemented some algorithms (or used some of the great implementations provided to us through public notebooks) to make small adaptations to a solution. After each adaptation, we then re-calculated the score and checked if there was an improvement. It is clear that a fast scoring function is of key importance. We will discuss that further. The strategies we used were:", "We also played around a bit with some meta-heuristics. Our first thought was that genetic algorithms would excel in this competition. We focused on genetic algorithms quickly after the beginning of the competition, but quickly gave up on it as our population always converged to a very bad score. Simulated annealing was more successful, as it sometimes helped us to escape out of a local minimum where our greedy local searches could not escape from. The gist of simulated annealing is that it allows a solution to temporarily worsen, in order to escape a deep local optimum.", "As mentioned, a fast cost function is very important, as this allows for more local searching in the same time frame. People quickly provided C implementations that could be used within python that could run in a few nanoseconds. These implementations could even be optimized even more, due to the nature of local searches: as the adaptations in each iteration are minimal, we do not need to calculate the preference & accounting cost for every day but only the affected ones.", "As the competition was progressing, it became clear that the top competitors actually achieved the optimal score (68888.04). And as the days passed, more and more people were achieving that optimal value. On 6 December (which is \u201cSinterklaas\u201d in Belgium), the people from LocalSolver (a non-linear solver) gave us a gift. They tweeted a dumbed-down version of their solution to achieve a top 50 position, using their tool. The solution was a formulation of the non-linear objective, which could be optimized with their tool. We got ourselves an academic license and ran the tool, which resulted in a score of roughly 71000 at that time. A code snippet can be found below:", "In a nutshell, we create a 5000x100 binary matrix x which contains the assignments of the families to the days. If x[f][d] = 1, then family f is assigned to day d. From this, a 100-dimensional N-vector is created that contains the occupancy for each day. We then place constraints that each family should be assigned exactly 1 day and that the occupancy of each day cannot be lower than 125 and not exceed 300. Using x and N we can then directly formulate our non-linear objective and let LocalSolver work his magic to find the optimal x-matrix.", "While using LocalSolver was a direct improvement compared to using our greedy local searches, it was still rather far away from the optimum. We therefore turned to solving a (linear) Mixed Integer Program (using Gurobi, a powerful commercial solver). To do this, we had to apply some tricks.", "First, LP or MIP solvers expect constraints and objectives to be at most quadratic and preferably linear. When looking at the formula for the accounting penalty, it is clear that this is a non-linear function. BUT, as the occupancy of a day is restricted to be between 125 and 300, the number of inputs to this accounting function is limited. From the formula, we can see two dependent variables: the occupancy of the current day and the occupancy of day d + 1 (which is the previous day in this framework). As such, we can create a (lookup) 176x176 matrix that contain all possible values of this accounting cost (we hinted at that by creating grid lines in the heatmap of the accounting costs). In total, a 100x176x176 matrix, called occ, was used to store all this information. occ[d][k][l] was equal to 1 if on day d the occupancy was equal to k and on day d + 1 equal to l. This matrix is huge, but we can easily prune out some of the variables. We know that the accounting cost of the optimal solution is roughly 6020, as such binary variables that are associated with costs higher than this can immediately be discarded.", "In our LocalSolver formulation, we used a 5000x100 binary matrix to store our assignment in. When inspecting our solutions, it quickly became clear that the optimal solution would never assign a bad choice to a family. As such, we could reduce our binary matrix to be of size 5000x10. x[f][c] would then be 1 if family f gets assigned choice c.", "In summary, we have the following variables:", "Of course, we can also calculate the occupancy variables from the assignment matrix:", "Here, family_size contains the sizes of each of the families and choices is a matrix that contains the choices for each family. To make this more concrete, let\u2019s look at a simple example. Assume we have 5 families with the following choice matrix:", "Then the occupancy of day 1 (occupancy(1)) would be equal to:", "We then add constraints that the occupancy should be between 125 and 300, that each family must exactly be assigned one of its choices and that the one bits in the binary occupancy matrix must be consistent with the calculated occupancy values. Finally, we optimize the following objective:", "With PREF and ACC two matrices that contain the corresponding costs. The code that can be provided to Gurobi can be found below:", "We let this run for 1 week (!!) and it finally outputted the optimal solution. Some tricks can be added for faster convergence, most notably adding constraints that guide the solver towards the optimal solution of 68888.04 (with a corresponding \u201coptimality proof\u201d of the solver). If you managed to make your solver converge faster than 1 week, then please let us know in the comments!", "Using a public kernel, we can create a nice visualization of our optimal solution:", "Bram and I were the 28th team to find this optimal solution. Given the fact that we had no experience in Linear Programming, we were very proud of our result in the end. We are now both awarded a silver medal, and I got promoted to being a \u201cCompetition Expert\u201d.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F1951386a6ba5&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhelping-santa-plan-with-mixed-integer-programming-mip-1951386a6ba5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhelping-santa-plan-with-mixed-integer-programming-mip-1951386a6ba5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhelping-santa-plan-with-mixed-integer-programming-mip-1951386a6ba5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhelping-santa-plan-with-mixed-integer-programming-mip-1951386a6ba5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----1951386a6ba5--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----1951386a6ba5--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://gillesvandewiele.medium.com/?source=post_page-----1951386a6ba5--------------------------------", "anchor_text": ""}, {"url": "https://gillesvandewiele.medium.com/?source=post_page-----1951386a6ba5--------------------------------", "anchor_text": "Gilles Vandewiele"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F3e8cbc53806e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhelping-santa-plan-with-mixed-integer-programming-mip-1951386a6ba5&user=Gilles+Vandewiele&userId=3e8cbc53806e&source=post_page-3e8cbc53806e----1951386a6ba5---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F1951386a6ba5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhelping-santa-plan-with-mixed-integer-programming-mip-1951386a6ba5&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F1951386a6ba5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhelping-santa-plan-with-mixed-integer-programming-mip-1951386a6ba5&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://bsteenwi.github.io/", "anchor_text": "Bram Steenwinckel"}, {"url": "https://opensourc.es/blog/kaggle-santa-2019", "anchor_text": "blog post"}, {"url": "https://www.kaggle.com/golubev/c-stochastic-product-search-65ns", "anchor_text": "Stochastic Searching"}, {"url": "https://www.kaggle.com/golubev/c-stochastic-product-search-65ns", "anchor_text": "C++ implementation"}, {"url": "https://www.kaggle.com/xhlulu/santa-s-2019-faster-cost-function-24-s", "anchor_text": "C implementations"}, {"url": "https://www.kaggle.com/khahuras/the-elegant-prize", "anchor_text": "but only the affected ones"}, {"url": "https://en.wikipedia.org/wiki/Sinterklaas", "anchor_text": "Sinterklaas"}, {"url": "https://twitter.com/localsolver/status/1203002028282257409", "anchor_text": "tweeted"}, {"url": "https://www.kaggle.com/ghostskipper/visualising-results", "anchor_text": "public kernel"}, {"url": "https://medium.com/tag/optimization?source=post_page-----1951386a6ba5---------------optimization-----------------", "anchor_text": "Optimization"}, {"url": "https://medium.com/tag/kaggle?source=post_page-----1951386a6ba5---------------kaggle-----------------", "anchor_text": "Kaggle"}, {"url": "https://medium.com/tag/santa?source=post_page-----1951386a6ba5---------------santa-----------------", "anchor_text": "Santa"}, {"url": "https://medium.com/tag/linear-programming?source=post_page-----1951386a6ba5---------------linear_programming-----------------", "anchor_text": "Linear Programming"}, {"url": "https://medium.com/tag/assignment-problem?source=post_page-----1951386a6ba5---------------assignment_problem-----------------", "anchor_text": "Assignment Problem"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F1951386a6ba5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhelping-santa-plan-with-mixed-integer-programming-mip-1951386a6ba5&user=Gilles+Vandewiele&userId=3e8cbc53806e&source=-----1951386a6ba5---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F1951386a6ba5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhelping-santa-plan-with-mixed-integer-programming-mip-1951386a6ba5&user=Gilles+Vandewiele&userId=3e8cbc53806e&source=-----1951386a6ba5---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F1951386a6ba5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhelping-santa-plan-with-mixed-integer-programming-mip-1951386a6ba5&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----1951386a6ba5--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F1951386a6ba5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhelping-santa-plan-with-mixed-integer-programming-mip-1951386a6ba5&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----1951386a6ba5---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----1951386a6ba5--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----1951386a6ba5--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----1951386a6ba5--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----1951386a6ba5--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----1951386a6ba5--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----1951386a6ba5--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----1951386a6ba5--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----1951386a6ba5--------------------------------", "anchor_text": ""}, {"url": "https://gillesvandewiele.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://gillesvandewiele.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Gilles Vandewiele"}, {"url": "https://gillesvandewiele.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "231 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F3e8cbc53806e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhelping-santa-plan-with-mixed-integer-programming-mip-1951386a6ba5&user=Gilles+Vandewiele&userId=3e8cbc53806e&source=post_page-3e8cbc53806e--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fe7b38ac3fda1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhelping-santa-plan-with-mixed-integer-programming-mip-1951386a6ba5&newsletterV3=3e8cbc53806e&newsletterV3Id=e7b38ac3fda1&user=Gilles+Vandewiele&userId=3e8cbc53806e&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}