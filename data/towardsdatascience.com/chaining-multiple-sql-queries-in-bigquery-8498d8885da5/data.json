{"url": "https://towardsdatascience.com/chaining-multiple-sql-queries-in-bigquery-8498d8885da5", "time": 1683012389.090563, "path": "towardsdatascience.com/chaining-multiple-sql-queries-in-bigquery-8498d8885da5/", "webpage": {"metadata": {"title": "Chaining Multiple SQL Queries in BigQuery | by muffaddal qutbuddin | Towards Data Science", "h1": "Chaining Multiple SQL Queries in BigQuery", "description": "Bigquery is a fantastic tool! It lets you do really powerful analytics works all using SQL like syntax. But it lacks chaining the SQL queries. We cannot run one SQL right after the completion of\u2026"}, "outgoing_paragraph_urls": [{"url": "https://towardsdatascience.com/rfm-analysis-using-bigquery-ml-bfaa51b83086", "anchor_text": "RFM analysis using BigQuery ML", "paragraph_index": 2}, {"url": "https://bit.ly/2X4kefM", "anchor_text": "here is an excellent course", "paragraph_index": 6}, {"url": "https://medium.com/u/5ecbb8c195df?source=post_page-----8498d8885da5--------------------------------", "anchor_text": "Simon Thomsen", "paragraph_index": 28}, {"url": "https://medium.com/u/c81ac22e20c7?source=post_page-----8498d8885da5--------------------------------", "anchor_text": "S\u00e9bastien Morand", "paragraph_index": 30}, {"url": "https://medium.com/@seb.morand/i-propose-two-other-methods-with-no-time-limitation-615c6e10c0a4", "anchor_text": "two more methods", "paragraph_index": 30}, {"url": "https://www.linkedin.com/in/muffaddal-qutbuddin/", "anchor_text": "https://www.linkedin.com/in/muffaddal-qutbuddin/", "paragraph_index": 35}], "all_paragraphs": ["Bigquery is a fantastic tool! It lets you do really powerful analytics works all using SQL like syntax.", "But it lacks chaining the SQL queries. We cannot run one SQL right after the completion of another. There are many real-life applications where the output of one query depends upon for the execution of another. And we would want to run multiple queries to achieve the results.", "Here is one scenario, suppose you are doing RFM analysis using BigQuery ML. Where first you have to calculate the RFM values for all the users then apply the k-means cluster to the result of the first query and then merge the output of the first query and second query to generate the final data table.", "In the above scenario, every next query depends upon the output of the previous query and the output of each query also needs to be stored in data for other uses.", "I this guide I will show how to execute as many SQL queries as you want in BigQuery one after another creating a chaining effect to gain the desire results.", "I will demonstrate two approaches to chaining the queries", "And If you want to get your hands dirty yourself then here is an excellent course to start with.", "Note: We will continue with the RFM example discussed above to get you the idea of the process. But the same can be applied for any possible scenario where triggering multiple SQL queries is needed.", "Method 1 uses the combination of cloud functions and pub/subs to chain the entire flow. The process starts by query scheduler which after executing the first query sends a message to pub/sub topic that triggers a cloud function responsible to trigger 2nd query and once completed sends a message to another pub/sub topic to start yet another cloud function. The process continues until the last query is executed by the cloud function.", "Let\u2019s understand the process with our RFM analysis use case.", "Suppose we have three queries that are needed to be run one after another to perform RFM analysis. First, that calculates RFM values, we will call it RFM Values. Second, that creates the model, we will call itRFM Model. Third, that merges model output with users RFM values, we will call it RFM Final.", "Here is how the data pipeline looks like:", "Note: I will assume that tables for all three queries have already been created.", "1- We start by first creating a Pub/Sub topic as it will be needed while creating RFM Values query schedular. I have named it RFM_Model_Topic as it will trigger the cloud function responsible for executing our model query (i.e RFM Model).", "Copy the topic name that is needed while creating RFM Values schedular.", "2- Next, go to BigQuery, paste the RFM Values query that calculates RFM values for our users, in the query editor, and click the \u2018Schedule query\u2019 button to create a new query schedular.", "3- Enter the required values in the scheduler creation menu to create the scheduler", "What this scheduler will do is it will execute on the specified time to calculate users' recency, frequency, and monetary values and store it in the mentioned BigQuery table. Once the schedule is done executing the query it will send a message to our RFM_Model_Topic which will trigger a cloud function to trigger our model query. So next let\u2019s create a cloud function.", "4- Go to RFM_Model_Topicpub/sub topi and click \u2018Trigger Cloud Function\u2019 Button at the top of the screen.", "5- Enters settings as shown below and name the cloud function as RFM_Model_Function", "6- And paste below code in index.js file", "Once the query is executed cloud function sends a publish message to a new pub/sub topic named RFM_Final which triggers cloud function responsible for the last query that combines both RFM values and model results in one data set.", "7- Therefore, next, create RFM_Model topic in pub/sub and a cloud function as we did in the previous step. Copy-paste below code in cloud function so that it can run the last query.", "We can use as many pub/sub and cloud functions as we want to chain as many SQL queries as we want.", "Now the first approach is robust but requires a bit of programming background and says it is not your strong suit. You can use method 2 to chain the BigQuery queries.", "BigQuery\u2019s query scheduler can be used to run the queries one after another.", "Idea is that we start the process the same as we did in method 1, i.e. trigger the first query using a scheduler and estimate its time for completion. Let\u2019s say the first query takes 5 minutes to complete. What we will do is trigger the 2nd query 10 mints after the first query start time. This way we are ensured that the second query is triggered after the first query is completely executed.", "Suppose we scheduled the first query at 12:30 am. It takes 10 mints to complete. So we know at 12:40 am the first query should be completed. We will set the second query scheduler to execute at 12:50 am (keeping a 10 mint gap between two schedulers just in case). And we will trigger the third query at 1:10 am and so on.", "Method 2 can also work with a combination of method 1. Meaning that we trigger Query Schedular using the cloud function to do the trick. Doing so also has the added benefit that you don\u2019t have to run into the execution time limit of cloud function and your query can take as long as it needs to execute. PS: Triggering on-demand query scheduler with cloud function was suggested by Simon Thomsen.", "Note: Since the query scheduler doesn\u2019t work with BigQuery ML, therefore, method 2 won\u2019t work for our RFM analysis case but It should get you the idea of how to use the scheduler to chain queries.", "If you can handle more sophisticated pipelines S\u00e9bastien Morand proposed two more methods that you can employ.", "Executing queries one after another helps to achieve really great results especially when the result of one query depends on the output of another and all the query results are also needed as table format as well. BigQuery out of the box doesn\u2019t support this functionality but using GCP\u2019s component we can streamline the process to achieve the results.", "In this article, we went through two of the method to do this. First using the cloud pub/sub and cloud function and another using BigQuery\u2019s own query scheduler.", "With this article, I hope I was able to convey the idea of the process for you to pick it up and tailor it for your particular business case.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Muffaddal has around 6 years of experience working with web analytics and user behavior data. https://www.linkedin.com/in/muffaddal-qutbuddin/"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F8498d8885da5&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchaining-multiple-sql-queries-in-bigquery-8498d8885da5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchaining-multiple-sql-queries-in-bigquery-8498d8885da5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchaining-multiple-sql-queries-in-bigquery-8498d8885da5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchaining-multiple-sql-queries-in-bigquery-8498d8885da5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----8498d8885da5--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----8498d8885da5--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://muffaddal-qutbuddin.medium.com/?source=post_page-----8498d8885da5--------------------------------", "anchor_text": ""}, {"url": "https://muffaddal-qutbuddin.medium.com/?source=post_page-----8498d8885da5--------------------------------", "anchor_text": "muffaddal qutbuddin"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F13dafa14dc1c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchaining-multiple-sql-queries-in-bigquery-8498d8885da5&user=muffaddal+qutbuddin&userId=13dafa14dc1c&source=post_page-13dafa14dc1c----8498d8885da5---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F8498d8885da5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchaining-multiple-sql-queries-in-bigquery-8498d8885da5&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F8498d8885da5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchaining-multiple-sql-queries-in-bigquery-8498d8885da5&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://pixabay.com/users/dakub-8222964/", "anchor_text": "Dakub"}, {"url": "https://pixabay.com/photos/duck-goose-march-series-queue-3217049/", "anchor_text": "Pixabay"}, {"url": "https://towardsdatascience.com/rfm-analysis-using-bigquery-ml-bfaa51b83086", "anchor_text": "RFM analysis using BigQuery ML"}, {"url": "https://bit.ly/2X4kefM", "anchor_text": "here is an excellent course"}, {"url": "https://medium.com/u/5ecbb8c195df?source=post_page-----8498d8885da5--------------------------------", "anchor_text": "Simon Thomsen"}, {"url": "https://medium.com/u/c81ac22e20c7?source=post_page-----8498d8885da5--------------------------------", "anchor_text": "S\u00e9bastien Morand"}, {"url": "https://medium.com/@seb.morand/i-propose-two-other-methods-with-no-time-limitation-615c6e10c0a4", "anchor_text": "two more methods"}, {"url": "https://towardsdatascience.com/rfm-analysis-using-bigquery-ml-bfaa51b83086", "anchor_text": "RFM Analysis using BigQuery MLUser Segmentation using RFM analysis in BigQuery ML and Visualization in the Data Studio.towardsdatascience.com"}, {"url": "https://towardsdatascience.com/send-google-analytics-hit-level-data-to-bigquery-5093e2db481b", "anchor_text": "Send Standard Google Analytics Hit Level Data to BigQueryHow to send standard Google Analytics hit level data to BigQuery.towardsdatascience.com"}, {"url": "https://towardsdatascience.com/automate-data-import-to-google-analytics-471de2c3fc76", "anchor_text": "Automate Data Import to Google Analytics.Set up a data pipeline to import data to google analytics using Google Cloud Platfrom.towardsdatascience.com"}, {"url": "https://medium.com/tag/bigquery?source=post_page-----8498d8885da5---------------bigquery-----------------", "anchor_text": "Bigquery"}, {"url": "https://medium.com/tag/sql?source=post_page-----8498d8885da5---------------sql-----------------", "anchor_text": "Sql"}, {"url": "https://medium.com/tag/gcp?source=post_page-----8498d8885da5---------------gcp-----------------", "anchor_text": "Gcp"}, {"url": "https://medium.com/tag/cloud-functions?source=post_page-----8498d8885da5---------------cloud_functions-----------------", "anchor_text": "Cloud Functions"}, {"url": "https://medium.com/tag/query?source=post_page-----8498d8885da5---------------query-----------------", "anchor_text": "Query"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F8498d8885da5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchaining-multiple-sql-queries-in-bigquery-8498d8885da5&user=muffaddal+qutbuddin&userId=13dafa14dc1c&source=-----8498d8885da5---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F8498d8885da5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchaining-multiple-sql-queries-in-bigquery-8498d8885da5&user=muffaddal+qutbuddin&userId=13dafa14dc1c&source=-----8498d8885da5---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F8498d8885da5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchaining-multiple-sql-queries-in-bigquery-8498d8885da5&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----8498d8885da5--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F8498d8885da5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchaining-multiple-sql-queries-in-bigquery-8498d8885da5&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----8498d8885da5---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----8498d8885da5--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----8498d8885da5--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----8498d8885da5--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----8498d8885da5--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----8498d8885da5--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----8498d8885da5--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----8498d8885da5--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----8498d8885da5--------------------------------", "anchor_text": ""}, {"url": "https://muffaddal-qutbuddin.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://muffaddal-qutbuddin.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "muffaddal qutbuddin"}, {"url": "https://muffaddal-qutbuddin.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "357 Followers"}, {"url": "https://www.linkedin.com/in/muffaddal-qutbuddin/", "anchor_text": "https://www.linkedin.com/in/muffaddal-qutbuddin/"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F13dafa14dc1c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchaining-multiple-sql-queries-in-bigquery-8498d8885da5&user=muffaddal+qutbuddin&userId=13dafa14dc1c&source=post_page-13dafa14dc1c--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fe2e482d68f4c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fchaining-multiple-sql-queries-in-bigquery-8498d8885da5&newsletterV3=13dafa14dc1c&newsletterV3Id=e2e482d68f4c&user=muffaddal+qutbuddin&userId=13dafa14dc1c&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}