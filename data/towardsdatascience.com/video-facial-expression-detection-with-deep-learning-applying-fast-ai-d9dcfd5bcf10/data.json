{"url": "https://towardsdatascience.com/video-facial-expression-detection-with-deep-learning-applying-fast-ai-d9dcfd5bcf10", "time": 1683006553.688889, "path": "towardsdatascience.com/video-facial-expression-detection-with-deep-learning-applying-fast-ai-d9dcfd5bcf10/", "webpage": {"metadata": {"title": "Video Facial Expression and Awareness Detection with Fast.ai and OpenCV | by Joyce Zheng | Towards Data Science", "h1": "Video Facial Expression and Awareness Detection with Fast.ai and OpenCV", "description": "The inspiration behind this? The FBI agent watching me through my webcam, but replaced by deep learning :) The goal of this tutorial? Train a facial expression classification model with the fast.ai\u2026"}, "outgoing_paragraph_urls": [{"url": "https://github.com/jy6zheng/FacialExpressionRecognition", "anchor_text": "https://github.com/jy6zheng/FacialExpressionRecognition", "paragraph_index": 1}, {"url": "https://www.pyimagesearch.com/2017/05/08/drowsiness-detection-opencv/", "anchor_text": "https://www.pyimagesearch.com/2017/05/08/drowsiness-detection-opencv/", "paragraph_index": 2}, {"url": "https://www.kaggle.com/jonathanoheix/face-expression-recognition-dataset", "anchor_text": "https://www.kaggle.com/jonathanoheix/face-expression-recognition-dataset", "paragraph_index": 3}, {"url": "https://github.com/jy6zheng/FacialExpressionRecognition/blob/master/Facial_recognition.ipynb", "anchor_text": "https://github.com/jy6zheng/FacialExpressionRecognition", "paragraph_index": 4}, {"url": "https://github.com/jy6zheng/FacialExpressionRecognition", "anchor_text": "https://github.com/jy6zheng/FacialExpressionRecognition", "paragraph_index": 19}], "all_paragraphs": ["The inspiration behind this? The FBI agent watching me through my webcam, but replaced by deep learning :)", "The goal of this tutorial? Train a facial expression classification model with the fast.ai library, read facial expressions from your webcam or a video file, and finally, add in facial landmarking to track your eyes to determine awareness! (TL;DR the fully working code is here https://github.com/jy6zheng/FacialExpressionRecognition)", "The main reason why I wrote this tutorial is that when working on this project, a big challenge was figuring out how to take my trained classifier and make it work on both live videos and video files efficiently. The additional eye landmarking feature was based off this tutorial that I found extremely useful: https://www.pyimagesearch.com/2017/05/08/drowsiness-detection-opencv/", "The first step is to train an image classification model with a convolutional neural network. The data I used was from https://www.kaggle.com/jonathanoheix/face-expression-recognition-dataset", "I used the fast.ai library, built on top of PyTorch to train my classification model. The model was trained with resnet34 pre-trained weights and the training dataset and exported as a .pkl file. For step-by-step instructions, check out the google colab notebook in my repository, which contains all the code to train your model: https://github.com/jy6zheng/FacialExpressionRecognition", "The greatest challenge was first finding a public dataset and then cleaning the data. Initially, when I used the Kaggle dataset, I was only able to train up to an error rate of 0.328191, which meant it was only correct around 68% of the time (not that great at all). When I plotted images that produced the top losses, I quickly realized that a large amount of the data was incorrectly labeled (the left is the predicted expression by the model, the right is the labeled emotion).", "After cleaning the data, the error rate decreased by over 16%. Now the classifier has around 84% accuracy meaning it correctly identified 84% of the face images. There are still some incorrect and dirty data, and therefore room for more improvement.", "Now, it is time to take our classifier and use it on live video streams. First, it is preferable to create a virtual environment so that this project has its own dependencies and does not interfere with any other project. Then, download the required packages and libraries. Create a file called liveVideoFrame.py (or whatever you want to name it) and import the following:", "I wanted the option to save the predictions in a .csv file and save the marked-up video, so I added argument parsing. I also exported the trained classification model and moved it to my working directory.", "Great! Now it is time to start our video stream. I used VideoStream from imutils.video since I found it works faster than cv2.VideoCapture. Note: the source for the video stream is 0 for the built-in webcam, it will be different if you are using a different camera such as a plugin.", "A haar cascade classifier is used to identify frontal faces in the video frame. We have an array named data to store our predictions. The timer and time_value are used to label the time of each prediction in our data so that the predictions increment by 1s in the.csv file.", "Now, we will implement a while loop that reads each frame from the video stream:", "Now we have our fast.ai learning model working with imutils and OpenCV to predict faces from live videos!", "Next, it is time to determine the awareness of the face. The function eye_aspect_ratio calculates the eye aspect ratio from the coordinates of the eye. The position and coordinates of each eye are found from the dlib pre-trained facial landmark detector. The function data_time is used to append predictions in the data array every 1-second interval.", "Within the for loop which loops over the face coordinates, add the following block of code. The eye is detected using the dlib face landmark detector and drawn onto the frame. When the average calculated eye aspect ratio between the two eyes is less than the threshold for more than ten consecutive frames (which you can modify to your own liking), then the face is marked as distracted.", "Finally, at the bottom of our code, we can save the data as a data frame and then a .csv file.", "You can test the code in the command-line by running:", "I used a very similar approach to video files compared to live videos. The main difference is that predictions occur every number of frames, which can be modified using the command-line argument \u2014 frame-step. The full code is below:", "And that\u2019s it! You now are able to predict facial expressions from both video files and live webcams.", "Thank you for reading this :), and let me know if there are any improvements or questions. The fully working code is here: https://github.com/jy6zheng/FacialExpressionRecognition", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Engineering Student from UWaterloo who is exploring deep learning and loves writing :)"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fd9dcfd5bcf10&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fvideo-facial-expression-detection-with-deep-learning-applying-fast-ai-d9dcfd5bcf10&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fvideo-facial-expression-detection-with-deep-learning-applying-fast-ai-d9dcfd5bcf10&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fvideo-facial-expression-detection-with-deep-learning-applying-fast-ai-d9dcfd5bcf10&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fvideo-facial-expression-detection-with-deep-learning-applying-fast-ai-d9dcfd5bcf10&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----d9dcfd5bcf10--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----d9dcfd5bcf10--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@joyce6zheng?source=post_page-----d9dcfd5bcf10--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@joyce6zheng?source=post_page-----d9dcfd5bcf10--------------------------------", "anchor_text": "Joyce Zheng"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Faad24e307f03&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fvideo-facial-expression-detection-with-deep-learning-applying-fast-ai-d9dcfd5bcf10&user=Joyce+Zheng&userId=aad24e307f03&source=post_page-aad24e307f03----d9dcfd5bcf10---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fd9dcfd5bcf10&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fvideo-facial-expression-detection-with-deep-learning-applying-fast-ai-d9dcfd5bcf10&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fd9dcfd5bcf10&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fvideo-facial-expression-detection-with-deep-learning-applying-fast-ai-d9dcfd5bcf10&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://github.com/jy6zheng/FacialExpressionRecognition", "anchor_text": "https://github.com/jy6zheng/FacialExpressionRecognition"}, {"url": "https://www.pyimagesearch.com/2017/05/08/drowsiness-detection-opencv/", "anchor_text": "https://www.pyimagesearch.com/2017/05/08/drowsiness-detection-opencv/"}, {"url": "https://www.kaggle.com/jonathanoheix/face-expression-recognition-dataset", "anchor_text": "https://www.kaggle.com/jonathanoheix/face-expression-recognition-dataset"}, {"url": "https://github.com/jy6zheng/FacialExpressionRecognition/blob/master/Facial_recognition.ipynb", "anchor_text": "https://github.com/jy6zheng/FacialExpressionRecognition"}, {"url": "https://github.com/jy6zheng/FacialExpressionRecognition", "anchor_text": "https://github.com/jy6zheng/FacialExpressionRecognition"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----d9dcfd5bcf10---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/tag/face-recognition?source=post_page-----d9dcfd5bcf10---------------face_recognition-----------------", "anchor_text": "Face Recognition"}, {"url": "https://medium.com/tag/fastai?source=post_page-----d9dcfd5bcf10---------------fastai-----------------", "anchor_text": "Fastai"}, {"url": "https://medium.com/tag/machine-vision?source=post_page-----d9dcfd5bcf10---------------machine_vision-----------------", "anchor_text": "Machine Vision"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fd9dcfd5bcf10&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fvideo-facial-expression-detection-with-deep-learning-applying-fast-ai-d9dcfd5bcf10&user=Joyce+Zheng&userId=aad24e307f03&source=-----d9dcfd5bcf10---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fd9dcfd5bcf10&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fvideo-facial-expression-detection-with-deep-learning-applying-fast-ai-d9dcfd5bcf10&user=Joyce+Zheng&userId=aad24e307f03&source=-----d9dcfd5bcf10---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fd9dcfd5bcf10&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fvideo-facial-expression-detection-with-deep-learning-applying-fast-ai-d9dcfd5bcf10&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----d9dcfd5bcf10--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fd9dcfd5bcf10&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fvideo-facial-expression-detection-with-deep-learning-applying-fast-ai-d9dcfd5bcf10&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----d9dcfd5bcf10---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----d9dcfd5bcf10--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----d9dcfd5bcf10--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----d9dcfd5bcf10--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----d9dcfd5bcf10--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----d9dcfd5bcf10--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----d9dcfd5bcf10--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----d9dcfd5bcf10--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----d9dcfd5bcf10--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@joyce6zheng?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@joyce6zheng?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Joyce Zheng"}, {"url": "https://medium.com/@joyce6zheng/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "25 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Faad24e307f03&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fvideo-facial-expression-detection-with-deep-learning-applying-fast-ai-d9dcfd5bcf10&user=Joyce+Zheng&userId=aad24e307f03&source=post_page-aad24e307f03--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F232a2530715e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fvideo-facial-expression-detection-with-deep-learning-applying-fast-ai-d9dcfd5bcf10&newsletterV3=aad24e307f03&newsletterV3Id=232a2530715e&user=Joyce+Zheng&userId=aad24e307f03&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}