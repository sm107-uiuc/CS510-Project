{"url": "https://towardsdatascience.com/replicate-avro-messages-to-target-part1-conflicting-schema-exists-on-target-8489df60fd05", "time": 1683018035.260533, "path": "towardsdatascience.com/replicate-avro-messages-to-target-part1-conflicting-schema-exists-on-target-8489df60fd05/", "webpage": {"metadata": {"title": "Replicate Avro Messages To Target, Conflicting Schema Exists On Target Schema Registry | Towards Data Science", "h1": "Replicate Avro Messages To Target\u2014 Part1 (Conflicting Schema Exists On Target)", "description": "What will happen when kafka confluent replicator copies messages from source to target but there already a schema ID that exists on target schema registry"}, "outgoing_paragraph_urls": [{"url": "https://ranjitnagi.medium.com/replicate-avro-messages-to-target-part2-conflicting-schema-exists-on-target-same-subject-4aafb3bad3d", "anchor_text": "part2", "paragraph_index": 31}, {"url": "https://www.confluent.io/white-paper/disaster-recovery-for-multi-datacenter-apache-kafka-deployments/?_ga=2.137289968.1984469085.1608261456-106423691.1601582112&_gac=1.48882004.1606360874.CjwKCAiAnvj9BRA4EiwAuUMDf5hzUXSZqNRwqrBcgSMiO8y7k97Ffl4HSwDxqFzwWVQDOv23BJ3AyRoCHuYQAvD_BwE", "anchor_text": "here", "paragraph_index": 32}], "all_paragraphs": ["In this article, we are going to uncover how Confluent replicator will behave and what to expect when it's been asked to copy topic from source to target Kafka cluster where source and target have their own schema registries. In this scenario, we will see what happens when the same schema ID already exists somewhere on the target schema registry instance.", "Before covering this scenario, there are certain knowledge and environment assumptions that I\u2019m going to make:", "Let's assume you want to replicate the \u201cbar\u201d topic which has Avro messages with schema id \u201c1\u201d embedded into these messages. On the target side, you have a separate schema-registry instance that already has schema id \u201c1\u201d registered but that schema is completely different.", "We will cover this step by step", "We are going to use Avro console producer to produce Avro messages in the \u201cbar\u201d topic on the source Kafka cluster.", "Here we are producing 3 messages with a value schema of two fields \u201cf1\u201d and \u201cf2\u201d as a string data type.", "If we try to consume these messages on the source itself, we will see all these 3 messages. More importantly, we will also see these messages have schema id of 1 embedded.", "\u201cSince this is the first time we are producing on source side, therefore it will get schema id of 1. Schema IDs are monotonically increasing and will start with 1. Well the idea was to get schema id 1 on both source and target.\u201d", "2. Inspect schema ids on both source and target", "Let's quickly inspect what schemas we see in our source and target schema registries.", "I\u2019m using topic name subject strategy, that's why we see a subject name as \u201cbar-value\u201d where \u201cbar\u201d is the topic name. \u201cbar-value\u201d subject have version 1 registered with Avro schema consisting of two fields i.e. \u201cf1\u201d and \u201cf2\u201d with string data types.", "On target, we don't have a subject \u201cbar-value\u201d but we do have a schema with an id of \u201c1\u201d. This schema of id \u201c1\u201d has four fields \u201cage\u201d, \u201cphone\u201d, \u201chousenumber\u201d and \u201cdistance\u201d, all having \u201cint\u201d as data type, which is a completely different schema that we saw above on the source side with schema id of \u201c1\u201d.", "Deploy replicator as a connector on connect cluster at target connect instance.", "As you might have noticed connector\u2019s config, we are using the \u201cByteArrayConverter\u201d class for the key.converter and value.converter properties. Rest are specific to \u201csrc\u201d i.e. source and \u201cdest\u201d i.e. target environments.", "Run Avro console consumer to consume/check messages from \u201cbar\u201d topic on target Kafka cluster. We will see messages on the target topic that have schema id \u201c1\u201d embedded.", "This is depicted in the following diagram", "Console consumer has tried to consume all those 3 messages but those messages now have a totally different meaning. As we saw, these messages are referring to schema id of \u201c1\u201d. But as noted above, schema id \u201c1\u201d on the target schema-registry cluster has a different meaning, therefore consumer on the target cluster has failed to provide us with actual messages which were produced on the source cluster. The problem is not with the message itself but with the schema id these messages are referring to.", "Now that we have learned whenever replicator is going to copy messages from source to target, it copies those messages as it is without altering/changing the schema id which is embedded into them.", "Since we have used the \u201cio.confluent.connect.replicator.util.ByteArrayConverter\u201d class for our replicator, we can change it to use AvroConverter to see if this is going to have similar behavior or results.", "5. Delete \u201cbar\u201d topic and replicator connector on the target environment", "Let's delete the \u201cbar\u201d topic on the target cluster because we want to see how AvroConverter is going to work.", "This time we are going to use the \u201cio.confluent.connect.avro.AvroConverter\u201d class for both key and value converters properties.", "Deploy connector with following config (Connector have a new name and new src.consumer.group.id)", "Run Avro console consumer once again.", "Ok, this time we see Consumer has successfully shown us the correct messages on the target \u201cbar\u201d topic that we were expecting to see. But more interestingly, if you notice, these messages/records are now referring to a new schema id of \u201c2\u201d.", "Let's check what this schema is on the target schema registry.", "The schema of id \u201c2\u201d seems to be the same we had on the source schema registry, or more specifically, this is the same schema that we sent along (console Avro producer) while producing messages on the source site. But apart from schema being the same, there are two extra metadata fields that we see, which are \\\u201dconnect.version\\\u201d:1,\\\u201dconnect.name\\\u201d:\\\u201dmyrecord\\\u201d. The schema itself is the same but it's just the metadata that the replicator connector uses. We can disable this additional metadata by setting \u201cconnect.meta.data\u201d:\u201dfalse\u201d in the Connect worker property file.", "Replicator acts as a consumer that reads and de-serialize messages from source cluster based on property \u201dsrc.key.converter\u201d/\u201dsrc.value.converter\u201d and then finally produce and serialize the messages to target kafka cluster using property \u201ckey.converter\u201d/\u201dvalue.converter\u201d", "Also if now check on target schema registry instance, it has registered a new subject i.e. \u201cbar-value\u201d with version 1.", "This version 1 under the \u201cbar-value\u201d subject is using schema id of \u201c2\u201d.", "Although, \u201cAvroConverter\u201d is a bit slower than \u201cByteArrayConverter\u201d (not noticeable for low streaming data) but as we have seen, it is helping us in altering/changing the schema id of messages when it reaches to target. Using ByteArrayConverter with connector, schema id was preserved in those messages, which we didn\u2019t want, as we have schema id \u201c1\u201d already exists on target and had a different schema.", "There is one caveat though, let's say if schema id \u201c1\u201d was part of \u201cbar-value\u201d subject on target schema registry, then based on compatibility settings (backward is the default), replicator would have failed to insert these messages into \u201cbar\u201d topic on target which I have covered more in part2 of this article.", "Although we would not face the above scenario with two separate schema registries, as it's always recommended to have 1 unified consolidated schema registry instance for all environments, in a situation where a consolidated schema registry is not an option or not already in place, then above step with Avro converter would help in replicating topic over and hopefully won\u2019t break consumer on the target side. If you are interested more in single schema registry deployment, I would suggest reading the Confluent disaster recovery deployment whitepaper here", "For situations where we want to have schema id changed when the message reaches target because the same schema ID already exists on target, we can use \u201cAvroConverter\u201d instead of \u201cByteArrayConverter\u201d with the replicator.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F8489df60fd05&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freplicate-avro-messages-to-target-part1-conflicting-schema-exists-on-target-8489df60fd05&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freplicate-avro-messages-to-target-part1-conflicting-schema-exists-on-target-8489df60fd05&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freplicate-avro-messages-to-target-part1-conflicting-schema-exists-on-target-8489df60fd05&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freplicate-avro-messages-to-target-part1-conflicting-schema-exists-on-target-8489df60fd05&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----8489df60fd05--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----8489df60fd05--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://ranjitnagi.medium.com/?source=post_page-----8489df60fd05--------------------------------", "anchor_text": ""}, {"url": "https://ranjitnagi.medium.com/?source=post_page-----8489df60fd05--------------------------------", "anchor_text": "RanjitNagi"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F580c05206e0c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freplicate-avro-messages-to-target-part1-conflicting-schema-exists-on-target-8489df60fd05&user=RanjitNagi&userId=580c05206e0c&source=post_page-580c05206e0c----8489df60fd05---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F8489df60fd05&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freplicate-avro-messages-to-target-part1-conflicting-schema-exists-on-target-8489df60fd05&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F8489df60fd05&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freplicate-avro-messages-to-target-part1-conflicting-schema-exists-on-target-8489df60fd05&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@oskaryil?utm_source=medium&utm_medium=referral", "anchor_text": "Oskar Yildiz"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://docs.confluent.io/platform/current/multi-dc-deployments/replicator/index.html", "anchor_text": "confluent"}, {"url": "https://towardsdatascience.com/${SCHEMA_REGISTRY}:8081", "anchor_text": "http://schema-registry-1:8081"}, {"url": "https://towardsdatascience.com/${SCHEMA_REGISTRY}:8081", "anchor_text": "http://schema-registry-1:8081"}, {"url": "http://${SCHEMA_REGISTRY}:8081/subjects/bar-value/versions", "anchor_text": "http://schema-registry-1:8081/subjects/bar-value/versions"}, {"url": "http://${SCHEMA_REGISTRY}:8081/subjects/bar-value/versions/1", "anchor_text": "http://"}, {"url": "http://${SCHEMA_REGISTRY}:8081/subjects/bar-value/versions", "anchor_text": "schema-registry-1"}, {"url": "http://${SCHEMA_REGISTRY}:8081/subjects/bar-value/versions/1", "anchor_text": ":8081/subjects/bar-value/versions/1"}, {"url": "http://${SCHEMA_REGISTRY}:8081/subjects/bar-value/versions/", "anchor_text": "http://schema-registry-2:8081/subjects/bar-value/versions/"}, {"url": "http://${SCHEMA_REGISTRY}:8081/schemas/ids/1", "anchor_text": "http://schema-registry-2:8081/schemas/ids/1"}, {"url": "http://${CONNECT}:8083/connectors/bar-replicator/status", "anchor_text": "http://connect-2:8083/connectors/bar-replicator/status"}, {"url": "https://towardsdatascience.com/${SCHEMA_REGISTRY}:8081", "anchor_text": "http://schema-registry-2:8081"}, {"url": "http://${CONNECT}:8083/connectors/replicator-name-to-emea", "anchor_text": "http://connect-2:8083/connectors/"}, {"url": "https://towardsdatascience.com/${SCHEMA_REGISTRY}:8081", "anchor_text": "http://schema-registry-2:8081"}, {"url": "http://${SCHEMA_REGISTRY}:8081/schemas/ids/2", "anchor_text": "http://schema-registry-2:8081/schemas/ids/2"}, {"url": "http://${SCHEMA_REGISTRY}:8081/subjects/bar-value/versions", "anchor_text": "http://schema-registry-2:8081/subjects/bar-value/versions"}, {"url": "http://${SCHEMA_REGISTRY}:8081/subjects/bar-value/versions/1", "anchor_text": "http://schema-registry-2:8081/subjects/bar-value/versions/1"}, {"url": "https://ranjitnagi.medium.com/replicate-avro-messages-to-target-part2-conflicting-schema-exists-on-target-same-subject-4aafb3bad3d", "anchor_text": "part2"}, {"url": "https://www.confluent.io/white-paper/disaster-recovery-for-multi-datacenter-apache-kafka-deployments/?_ga=2.137289968.1984469085.1608261456-106423691.1601582112&_gac=1.48882004.1606360874.CjwKCAiAnvj9BRA4EiwAuUMDf5hzUXSZqNRwqrBcgSMiO8y7k97Ffl4HSwDxqFzwWVQDOv23BJ3AyRoCHuYQAvD_BwE", "anchor_text": "here"}, {"url": "https://ranjitnagi.medium.com/replicate-avro-messages-to-target-part2-conflicting-schema-exists-on-target-same-subject-4aafb3bad3d", "anchor_text": "Replicate Avro Messages To Target \u2014 Part2 (Conflicting Schema Exists On Target, Same Subject)What to do when Replicator fails to insert messages to the target topic because the topic\u2019s subject has a version with\u2026ranjitnagi.medium.com"}, {"url": "https://docs.confluent.io/platform/current/schema-registry/connect.html", "anchor_text": "Using Kafka Connect with Schema Registry - Confluent DocumentationTo use Kafka Connect with Schema Registry, you must specify the key.converter or value.converter properties in the\u2026docs.confluent.io"}, {"url": "https://docs.confluent.io/platform/current/schema-registry/index.html", "anchor_text": "Schema Management Overview - Confluent DocumentationConfluent Schema Registry provides a serving layer for your metadata. It provides a RESTful interface for storing and\u2026docs.confluent.io"}, {"url": "https://medium.com/tag/kafka?source=post_page-----8489df60fd05---------------kafka-----------------", "anchor_text": "Kafka"}, {"url": "https://medium.com/tag/schemaregistry?source=post_page-----8489df60fd05---------------schemaregistry-----------------", "anchor_text": "Schemaregistry"}, {"url": "https://medium.com/tag/confluent?source=post_page-----8489df60fd05---------------confluent-----------------", "anchor_text": "Confluent"}, {"url": "https://medium.com/tag/replicator?source=post_page-----8489df60fd05---------------replicator-----------------", "anchor_text": "Replicator"}, {"url": "https://medium.com/tag/schema?source=post_page-----8489df60fd05---------------schema-----------------", "anchor_text": "Schema"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F8489df60fd05&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freplicate-avro-messages-to-target-part1-conflicting-schema-exists-on-target-8489df60fd05&user=RanjitNagi&userId=580c05206e0c&source=-----8489df60fd05---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F8489df60fd05&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freplicate-avro-messages-to-target-part1-conflicting-schema-exists-on-target-8489df60fd05&user=RanjitNagi&userId=580c05206e0c&source=-----8489df60fd05---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F8489df60fd05&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freplicate-avro-messages-to-target-part1-conflicting-schema-exists-on-target-8489df60fd05&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----8489df60fd05--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F8489df60fd05&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freplicate-avro-messages-to-target-part1-conflicting-schema-exists-on-target-8489df60fd05&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----8489df60fd05---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----8489df60fd05--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----8489df60fd05--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----8489df60fd05--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----8489df60fd05--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----8489df60fd05--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----8489df60fd05--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----8489df60fd05--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----8489df60fd05--------------------------------", "anchor_text": ""}, {"url": "https://ranjitnagi.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://ranjitnagi.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "RanjitNagi"}, {"url": "https://ranjitnagi.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "7 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F580c05206e0c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freplicate-avro-messages-to-target-part1-conflicting-schema-exists-on-target-8489df60fd05&user=RanjitNagi&userId=580c05206e0c&source=post_page-580c05206e0c--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fusers%2F580c05206e0c%2Flazily-enable-writer-subscription&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Freplicate-avro-messages-to-target-part1-conflicting-schema-exists-on-target-8489df60fd05&user=RanjitNagi&userId=580c05206e0c&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}