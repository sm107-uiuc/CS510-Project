{"url": "https://towardsdatascience.com/all-in-one-image-dehazing-aod-paper-explanation-tensorflow-implementation-bb97f6a6f1ef", "time": 1682997716.767334, "path": "towardsdatascience.com/all-in-one-image-dehazing-aod-paper-explanation-tensorflow-implementation-bb97f6a6f1ef/", "webpage": {"metadata": {"title": "All In One Image Dehazing (AOD) \u2014 Paper Explanation & Tensorflow Implementation | by Tushar Sircar | Towards Data Science", "h1": "All In One Image Dehazing (AOD) \u2014 Paper Explanation & Tensorflow Implementation", "description": "Haze degrades image quality and limits visibility especially in outdoor settings. This consequently affects performance on other high-level tasks such as object detection and recognition. The AOD\u2026"}, "outgoing_paragraph_urls": [{"url": "https://github.com/tusharsircar95/All-In-One-Image-Dehazing-Tensorflow", "anchor_text": "here", "paragraph_index": 3}, {"url": "https://en.wikipedia.org/wiki/Peak_signal-to-noise_ratio", "anchor_text": "PSNR", "paragraph_index": 25}, {"url": "https://en.wikipedia.org/wiki/Structural_similarity", "anchor_text": "SSIM", "paragraph_index": 25}, {"url": "https://github.com/tusharsircar95/All-In-One-Image-Dehazing-Tensorflow", "anchor_text": "here", "paragraph_index": 48}], "all_paragraphs": ["Haze degrades image quality and limits visibility especially in outdoor settings. This consequently affects performance on other high-level tasks such as object detection and recognition.", "The AOD network proposed by Boyi Li et. al. is an end-to-end CNN to de-haze an image. AOD takes as input a hazy image and generates a de-hazed image.", "In this post, I have provided an explanation for the main components of the AOD-net paper along with a step-by-step tutorial to implement AOD-net in Tensorflow.", "You can find the entire code here.", "AOD assumes that hazy images are generated based on the atmospheric scattering model described below.", "where,I(x): Observed hazy imageJ(x): Original imageA: Global Atmospheric Lightingt(x): Transmission Matrix", "A refers to the natural light of the atmosphere across the entire scene.t(x) represents the amount of light that reaches the camera from the object. It is calculated as follows:", "where,\u03b2: Scattering Co-efficient (Non-negative)d(x): Distance between the object and observer (Non-negative)", "Let us try to understand this.", "The idea is that the atmosphere scatters light coming from the object before it reaches the camera. The amount of light scattered depends on the atmospheric properties (captured by \u03b2) as well as the distance of the object from the camera (captured by d(x)). Rest of the light is transmitted (reaches) the camera.", "Since \u03b2 and d(x) are both non-negative, the value of t(x) is in the range (0,1]. 0 means no light from the object reaches the camera (all light is scattered) and 1 means all the light from the object reaches the camera (no scattering).", "A higher value of \u03b2 represents an atmosphere that tends to scatter light more. Moreover, as the object moves further away from the camera, more light is scattered.", "Now, given values of transmission (for each pixel) and the global atmospheric light, the light received by the camera can be calculated.", "If t(x) is 1, then the camera sees the light from the object perfectly (no scattering).If t(x) is 0, then the camera sees only the atmospheric light (complete scattering).Else, the camera sees a linear interpolation between the light from the object and the atmosphere.", "Existing work on de-hazing is based on individually estimating t(x) and A. The key problem with this is that the estimation errors may accumulate. AOD aims to estimate both the parameters in a unified manner with the following re-formulation of equation (1).", "t(x) and A are integrated into a single variable K(x) which is dependent on input I(x). Once, K(x) is estimated, the de-hazed image can be calculated using equation (3).", "Hence, the aim now is to estimate K(x) such that it minimizes the mean squared error (MSE) between the de-hazed and original image. This is done by training a CNN.", "The first module estimates K(x). Note that, for an image of size W x H x 3, K(x) also has size W x H x 3.The second module involves element-wise operations to generate the de-hazed image using equation (3).", "The K-Estimation module is critical as it is indirectly estimating the atmospheric light and transmission matrix (implicitly calculating the depth of each pixel in the image).", "It consists of 5 convolutional layers (with ReLU activations). Each layer has 3 filters but a different kernel size (to generate multi-scale features). Moreover, activations of previous layers are concatenated with intermediate layers before taking convolutions as this compensates for information loss during convolutions.", "The network architecture is shown below.", "Hence, the entire pipeline looks like this:", "The authors have generated artificially hazed images for the purpose of training AOD-net. Images from the NYU2 depth database (includes depth information for each pixel) were artificially hazed with different values of \u03b2 and A (selected from a uniform random distribution) based on equation (1). Hence, for ~1500 ground truth images, ~27K hazed images were obtained.", "The model was trained for 10 epochs. Weights were initialized with a standard Gaussian distribution and weight decay was set to 0.0001. Gradient norms were clipped at 0.1.", "NOTE: The paper doesn\u2019t mention the exact learning rate used nor the exact optimization algorithm. (I have used a learning rate of 0.0001 and Adam Optimizer in my implementation).", "The authors compared the performance of AOD-net to previous de-hazing algorithms based on the PSNR and SSIM metrics.", "Let us now dive into the implementation.", "We\u2019ll be using the Tensorflow Dataset API.", "2. Create a dictionary that maps each original image path to whether the image will be used for \u2018train\u2019 or \u2018val\u2019. Note that the set of original images used in the training set should not overlap with the validation set (even if the corresponding hazy images are different) to avoid any information leak.", "3. Now, iterate over all image paths in the \u201chazy_images\u201d folder and extract the path of the corresponding original image (with basic string operations).If the original image path corresponds to a \u2018train\u2019 image, then add the <original_image_path, hazy image path> to the train_data list.Else, add the same to the val_data list.", "4. With the Tensorflow Dataset API, create the train and validation datasets. First, create a train_ds_hazy dataset by applying the from_tensor_slices() function on the hazy image paths of the training set followed by a mapping function that loads the image (explained later).Next, create a train_ds_orig dataset with the original image paths of the training set (in the same manner as before).Lastly, zip both the datasets to create train_ds.", "A similar process is followed to create the val_ds.", "Note that we have also stated that the dataset should be shuffled, the data should be extracted in batches of batch_size.", "5. Now, we define an iterator to iterate over the dataset elements. We use the from_structure() API so that the same iterator can be utilized for both the train and validation datasets.", "We then define train_init_op and val_init_op operations. Running these operations tells the iterator whether to pick data from the training or validation dataset respectively.", "6. Finally, we define the next_element operation, which can be called to read the next batch of data from the iterator.", "We define the load_image() function that maps an image path to the pre-processed image \u2014 ready to be fed into the network.We resize the image to a height of 480px and width of 640px and normalize the pixel values to [0,1].", "Note the following:- Weight initialization (kernel_initializer) is done with a Gaussian distribution (Mean 0.0, STD 0.02).- L2 regularization with parameter 0.0001 is used.- ReLU activation is applied after each convolution.- ReLU activation with a max value of 1.0 is applied after the element-wise multiplication layer.", "2. Define placeholders X and Y for the input (hazy) image and the original image respectively.Define dehazed_X as the output of the network when X is passed through it.", "3. Define the network loss \u2014 MSE between the original and de-hazed image.", "4. Define the optimizer operation.a) Define Adam Optimizer with the <learning_rate> set to 0.001.b) Pass the list of trainable variables and compute the gradients for each of them.c) Clip the gradients on norm 0.1d) Update the trainable variables by applying the clipped gradients.", "3. In each epoch, run the train_init_op so that the iterator reads data from the training dataset.", "4. Define the number of batches that need to be processed, this is equivalent to the number of training examples divided by the batch size.", "5. For each batch, run the optimizer operation and store the corresponding loss (MSE) achieved. Print the batch loss every 1000 iterations to check if the loss is decreasing.", "6. To evaluate performance on the validation dataset, repeat the same process except that the optimizer operation is not run.Also, after every 100 batches, the hazed, original and de-hazed images (produced by the network) are displayed for visual examination.", "6. After each epoch, save the model weights.", "I trained the network for 10 epochs and achieved an MSE of ~0.018 on the validation set. However, I did not observe significant improvement after 3-4 epochs.", "Here are some qualitative results on several natural hazy images (not artificially generated haze).", "The entire code along with the trained models can be found here. It\u2019s a Python notebook that can be run on GoogleCollab.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Master's in CSE Student at UC San Diego, Exploring the world of computer science"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fbb97f6a6f1ef&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fall-in-one-image-dehazing-aod-paper-explanation-tensorflow-implementation-bb97f6a6f1ef&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fall-in-one-image-dehazing-aod-paper-explanation-tensorflow-implementation-bb97f6a6f1ef&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fall-in-one-image-dehazing-aod-paper-explanation-tensorflow-implementation-bb97f6a6f1ef&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fall-in-one-image-dehazing-aod-paper-explanation-tensorflow-implementation-bb97f6a6f1ef&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----bb97f6a6f1ef--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----bb97f6a6f1ef--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@tusharsircar95?source=post_page-----bb97f6a6f1ef--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@tusharsircar95?source=post_page-----bb97f6a6f1ef--------------------------------", "anchor_text": "Tushar Sircar"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F394152fc1c5a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fall-in-one-image-dehazing-aod-paper-explanation-tensorflow-implementation-bb97f6a6f1ef&user=Tushar+Sircar&userId=394152fc1c5a&source=post_page-394152fc1c5a----bb97f6a6f1ef---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fbb97f6a6f1ef&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fall-in-one-image-dehazing-aod-paper-explanation-tensorflow-implementation-bb97f6a6f1ef&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fbb97f6a6f1ef&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fall-in-one-image-dehazing-aod-paper-explanation-tensorflow-implementation-bb97f6a6f1ef&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://github.com/tusharsircar95/All-In-One-Image-Dehazing-Tensorflow", "anchor_text": "here"}, {"url": "https://sites.google.com/site/boyilics/website-builder/project-page", "anchor_text": "https://sites.google.com/site/boyilics/website-builder/project-page"}, {"url": "https://en.wikipedia.org/wiki/Peak_signal-to-noise_ratio", "anchor_text": "PSNR"}, {"url": "https://en.wikipedia.org/wiki/Structural_similarity", "anchor_text": "SSIM"}, {"url": "https://docs.google.com/viewer?a=v&pid=sites&srcid=ZGVmYXVsdGRvbWFpbnxib3lpbGljc3xneDpjMjBjM2E3ZTAxZTM0NDU", "anchor_text": "here"}, {"url": "https://github.com/tusharsircar95/All-In-One-Image-Dehazing-Tensorflow", "anchor_text": "here"}, {"url": "https://sites.google.com/site/boyilics/website-builder/project-page", "anchor_text": "https://sites.google.com/site/boyilics/website-builder/project-page"}, {"url": "https://github.com/TheFairBear/PyTorch-Image-Dehazing", "anchor_text": "https://github.com/TheFairBear/PyTorch-Image-Dehazing"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----bb97f6a6f1ef---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/computer-vision?source=post_page-----bb97f6a6f1ef---------------computer_vision-----------------", "anchor_text": "Computer Vision"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----bb97f6a6f1ef---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/tag/tensorflow?source=post_page-----bb97f6a6f1ef---------------tensorflow-----------------", "anchor_text": "TensorFlow"}, {"url": "https://medium.com/tag/dehazing?source=post_page-----bb97f6a6f1ef---------------dehazing-----------------", "anchor_text": "Dehazing"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fbb97f6a6f1ef&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fall-in-one-image-dehazing-aod-paper-explanation-tensorflow-implementation-bb97f6a6f1ef&user=Tushar+Sircar&userId=394152fc1c5a&source=-----bb97f6a6f1ef---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fbb97f6a6f1ef&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fall-in-one-image-dehazing-aod-paper-explanation-tensorflow-implementation-bb97f6a6f1ef&user=Tushar+Sircar&userId=394152fc1c5a&source=-----bb97f6a6f1ef---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fbb97f6a6f1ef&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fall-in-one-image-dehazing-aod-paper-explanation-tensorflow-implementation-bb97f6a6f1ef&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----bb97f6a6f1ef--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fbb97f6a6f1ef&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fall-in-one-image-dehazing-aod-paper-explanation-tensorflow-implementation-bb97f6a6f1ef&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----bb97f6a6f1ef---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----bb97f6a6f1ef--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----bb97f6a6f1ef--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----bb97f6a6f1ef--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----bb97f6a6f1ef--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----bb97f6a6f1ef--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----bb97f6a6f1ef--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----bb97f6a6f1ef--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----bb97f6a6f1ef--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@tusharsircar95?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@tusharsircar95?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Tushar Sircar"}, {"url": "https://medium.com/@tusharsircar95/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "12 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F394152fc1c5a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fall-in-one-image-dehazing-aod-paper-explanation-tensorflow-implementation-bb97f6a6f1ef&user=Tushar+Sircar&userId=394152fc1c5a&source=post_page-394152fc1c5a--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fusers%2F394152fc1c5a%2Flazily-enable-writer-subscription&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fall-in-one-image-dehazing-aod-paper-explanation-tensorflow-implementation-bb97f6a6f1ef&user=Tushar+Sircar&userId=394152fc1c5a&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}