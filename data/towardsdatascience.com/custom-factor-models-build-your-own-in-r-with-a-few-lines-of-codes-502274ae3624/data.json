{"url": "https://towardsdatascience.com/custom-factor-models-build-your-own-in-r-with-a-few-lines-of-codes-502274ae3624", "time": 1683017410.6660469, "path": "towardsdatascience.com/custom-factor-models-build-your-own-in-r-with-a-few-lines-of-codes-502274ae3624/", "webpage": {"metadata": {"title": "Equity Factor Models - Build one in R with a few lines of codes | by Charles Malafosse | Towards Data Science", "h1": "Equity Factor Models - Build one in R with a few lines of codes", "description": "Multi-factor models are a must-have for investors looking to understand their portfolio\u2019s performance drivers. It helps explain the actual return of factors such as countries, sectors, and styles\u2026"}, "outgoing_paragraph_urls": [{"url": "https://github.com/charlesmalafosse/custom-factor-model", "anchor_text": "GitHub", "paragraph_index": 26}, {"url": "https://github.com/charlesmalafosse/custom-factor-model", "anchor_text": "GitHub", "paragraph_index": 27}, {"url": "https://cran.r-project.org/web/packages/systemfit/systemfit.pdf", "anchor_text": "R package \u2018systemfit\u2019", "paragraph_index": 28}, {"url": "https://en.wikipedia.org/wiki/Seemingly_unrelated_regressions", "anchor_text": "wikipedia", "paragraph_index": 28}, {"url": "https://lucyinthecloud.com/", "anchor_text": "https://lucyinthecloud.com/", "paragraph_index": 47}], "all_paragraphs": ["Multi-factor models are a must-have for investors looking to understand their portfolio\u2019s performance drivers. It helps explain the actual return of factors such as countries, sectors, and styles, independent of other factors\u2019 effects.", "In this article, we will focus on the mechanics of such models, and how to code them in R. We also introduce a visualization that lets you visualize the factor performance contributions overtime.", "A factor model also called a multi-factor model, is a model that employs multiple factors to explain individual securities or a portfolio of securities.", "It exists at least three types of factor models:", "We will focus on implicit factor models and their implementation in R.", "Implicit factor models are estimated by running a cross-sectional regression. A cross-sectional regression is a type of regression that looked at variables at a single point in time.", "Cross-sectional regression formula takes the following form:", "This formula takes stock\u2019s returns and their exposures to factors as input for each stock. The output after fitting is the return for each factor that minimizes the epsilon in the formula.", "A global universe of 3000 stocks and a factor model with 100 factors such as market, countries, sectors, and styles will produce the following system of equations to fit:", "Note that the only common variables among these equations are the factors implicit return that we want to find. When fitting this system, we have to specify that we want these to be constant among the equations.", "Our goal is to find F1 to F100 to minimize the sum of the epsilons (residuals). In other terms, to find the implicit factors returns that explain most of the return of stocks.", "Most of the multi-factor models use the following factors to explain stock\u2019s returns:", "We use generally accepted definitions for our style factors. These have to be chosen carefully to avoid collinearity. Something to keep in mind.", "Not all equations of the cross-sectional regression should have the same weights. Intuitively, larger stocks should have more influence as they are most likely driving the market. However, we do not want to use an approach such as market cap weighting that would put too much emphasis on larger market cap stocks.", "A good compromise is to use the square root of the market cap as a weighting scheme for our equations. According to Bloomberg\u2019s white paper, this is what is used by their equity model in their <PORT> function.", "Z-scores are highly sensitive to the distribution of the underlying data. For example, the size factor, often measured by the market cap of stocks, is usually skewed toward smaller market cap stocks. A vast majority of stocks are below a few billion dollars market cap while few can reach above 100 billion and even trillions like Apple or Amazon.", "This kind of z-score distribution is not ideal. The average is skewed toward 3, and this will impact our calculation and the implicit return computed. For this reason, we need to modify the distribution, so it becomes a standard normal distribution. It is done by computing z-scores of z-scores until our z-scores have a market-cap-weighted mean of 0 and a standard deviation of 1.", "There is another benefit of doing this; A market portfolio, a theoretical portfolio made up of all the stocks available in our investment universe, need to be logically explained by the market factor (it is called \u201cmarket\u201d portfolio after all). With our modified z-score distributions, all style factors have a 0 exposure, leaving only the market factor explaining the market portfolio performance (ignoring country and sector factors which will be taken care of by our regression constraints)", "Finally, we need to limit extreme values by clipping z-scores between 3 and -3.", "Additional constraints need to be imposed on the cross-sectional regression to avoid collinearity among factors. Country factor exposures suffer from collinearity with the market factor. It means that a linear combination of country factor exposures can reproduce the market factor exposure. The same applies to Sector factor exposures.", "Besides, a market portfolio should only be explained by the market factor (intercept). It makes little sense to have the market portfolio explained by factors other than the market factor.", "Therefore we need to add a matrix of restrictions to our regression. This matrix imposes that the country factor returns (or sector) sum to 0 at the market level. This way, we force our regression to ensure that the market portfolio is only driven by the market factor and avoid any collinearity issue from country and sector factors.", "Our restrictions matrix (M) consists of the weights of each factor in our market portfolio. Our constrained regression will solve implicit returns of factors such as their weighted sum (as given by our restriction matrix) equals 0.", "The result is a matrix with one row for the sector constraint and another row for the country constraint. Weights for each factor match the factor exposure in the market portfolio.", "To fit our cross-sectional regression, we need to feed our model with data. For this article\u2019s sake, we skip the details of the creation of these data and focus only on the format.", "Our code will take in input two files:", "These files are available on the following GitHub repo.", "Time to build our custom model using R. The full code is available in this GitHub repo.", "This code is a wrapper to the function systemfit from the R package \u2018systemfit\u2019. Systemfit is ideal for performing a cross-sectional regression with restrictions. However, one of the drawbacks is that it cannot allow Seemingly Unrelated Regressions (SUR) models with equation-specific weights. Explanation of SUR is out of the scope of this article but more information can be found on wikipedia.", "First things first, we need to load our data files into variables. Make sure your R working directory contains our two files.", "The next step is to modify the data from our data file to ensure that style\u2019s z-scores have a mean of 0 and a standard deviation of 1 and reflect the different equations weighting.", "The below code transforms our z-score distributions to ensure they have a weighted mean of 0 and a standard deviation of 1.", "Unfortunately the package \u2018systemfit\u2019 cannot estimate Seemingly Unrelated Regressions (SUR) models with different weights on equations. To go around this limitation we will repeat the rows of our dataset by their weight multiplied by 100'000. It is not perfect but it does the job.", "And here is the R code to do it.", "We now apply the systemfit function to perform our regression. This function takes for input the formula, our data, and our restrictions matrix.", "The following line of code generates our regression\u2019s formula:", "And finally we execute the line below to run our regression.", "We used the parameter \u201cpooled = TRUE\u201d to restrict coefficients to be equal in all equations, and \u201cmethod = \u201cSUR\u201d to use the estimation method \u201cSeemingly Unrelated Regressions\u201d.", "Use the following code to extract the regression\u2019s output, such as R2 and variable coefficients.", "Code to extract the model statistics:", "Thanks to the R code presented, we can compute implicit factor returns for one date. Repeating the process for additional dates will produce time series for factors. Each factor is net of other effects, and individual factor\u2019s contributions sum up to the total performance of a stock or portfolio.", "Below is an example of performance breakdown visualization for Amazon. This chart shows the November 9th market reversal following the covid-19 vaccine news and its impact on Amazon (harmful residuals and reduction of the momentum factor positive contribution). Note that factors contribution on each day sum up to Amazon\u2019s stock return.", "A word of caution regarding our code and methods; we presented a basic factor model that ignores many details of advanced models, such as handling missing factors and stocks different market open hours.", "In this article, we demonstrated that a multi-factor model can be coded in a few lines of R.", "Custom factor risk models are a must-have for any investors looking to understand their portfolio\u2019s performance drivers. It helps validate the actual return of factors, net of other effects, and lead to better insights for your portfolio management and stocks selection. I recommend anyone investing in the stock market to take a look at them. I believe they are no longer reserved for sophisticated investors and would, without any doubt, benefit retail investors.", "The next step in building your custom model is to pick your factors. There are many ways to do it, and I am preparing another article on the most common choices to select your style\u2019s factors.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "A Quant in the Cloud. Expert in the field of AWS, ML & Big data. Director at https://lucyinthecloud.com/"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F502274ae3624&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-factor-models-build-your-own-in-r-with-a-few-lines-of-codes-502274ae3624&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-factor-models-build-your-own-in-r-with-a-few-lines-of-codes-502274ae3624&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-factor-models-build-your-own-in-r-with-a-few-lines-of-codes-502274ae3624&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-factor-models-build-your-own-in-r-with-a-few-lines-of-codes-502274ae3624&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----502274ae3624--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----502274ae3624--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://charlesmalafosse.medium.com/?source=post_page-----502274ae3624--------------------------------", "anchor_text": ""}, {"url": "https://charlesmalafosse.medium.com/?source=post_page-----502274ae3624--------------------------------", "anchor_text": "Charles Malafosse"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fdd97a784141f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-factor-models-build-your-own-in-r-with-a-few-lines-of-codes-502274ae3624&user=Charles+Malafosse&userId=dd97a784141f&source=post_page-dd97a784141f----502274ae3624---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F502274ae3624&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-factor-models-build-your-own-in-r-with-a-few-lines-of-codes-502274ae3624&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F502274ae3624&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-factor-models-build-your-own-in-r-with-a-few-lines-of-codes-502274ae3624&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://github.com/charlesmalafosse/custom-factor-model", "anchor_text": "GitHub"}, {"url": "https://github.com/charlesmalafosse/custom-factor-model", "anchor_text": "GitHub"}, {"url": "https://cran.r-project.org/web/packages/systemfit/systemfit.pdf", "anchor_text": "R package \u2018systemfit\u2019"}, {"url": "https://en.wikipedia.org/wiki/Seemingly_unrelated_regressions", "anchor_text": "wikipedia"}, {"url": "https://medium.com/@charlesmalafosse/membership", "anchor_text": "https://medium.com/@charlesmalafosse/membership"}, {"url": "https://github.com/charlesmalafosse/custom-factor-model", "anchor_text": "https://github.com/charlesmalafosse/custom-factor-model"}, {"url": "http://www.jstatsoft.org/v23/i04/", "anchor_text": "http://www.jstatsoft.org/v23/i04/"}, {"url": "https://en.wikipedia.org/wiki/Seemingly_unrelated_regressions", "anchor_text": "https://en.wikipedia.org/wiki/Seemingly_unrelated_regressions"}, {"url": "https://medium.com/tag/risk?source=post_page-----502274ae3624---------------risk-----------------", "anchor_text": "Risk"}, {"url": "https://medium.com/tag/finance?source=post_page-----502274ae3624---------------finance-----------------", "anchor_text": "Finance"}, {"url": "https://medium.com/tag/investing?source=post_page-----502274ae3624---------------investing-----------------", "anchor_text": "Investing"}, {"url": "https://medium.com/tag/stock-market?source=post_page-----502274ae3624---------------stock_market-----------------", "anchor_text": "Stock Market"}, {"url": "https://medium.com/tag/asset-management?source=post_page-----502274ae3624---------------asset_management-----------------", "anchor_text": "Asset Management"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F502274ae3624&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-factor-models-build-your-own-in-r-with-a-few-lines-of-codes-502274ae3624&user=Charles+Malafosse&userId=dd97a784141f&source=-----502274ae3624---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F502274ae3624&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-factor-models-build-your-own-in-r-with-a-few-lines-of-codes-502274ae3624&user=Charles+Malafosse&userId=dd97a784141f&source=-----502274ae3624---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F502274ae3624&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-factor-models-build-your-own-in-r-with-a-few-lines-of-codes-502274ae3624&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----502274ae3624--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F502274ae3624&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-factor-models-build-your-own-in-r-with-a-few-lines-of-codes-502274ae3624&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----502274ae3624---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----502274ae3624--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----502274ae3624--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----502274ae3624--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----502274ae3624--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----502274ae3624--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----502274ae3624--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----502274ae3624--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----502274ae3624--------------------------------", "anchor_text": ""}, {"url": "https://charlesmalafosse.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://charlesmalafosse.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Charles Malafosse"}, {"url": "https://charlesmalafosse.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "312 Followers"}, {"url": "https://lucyinthecloud.com/", "anchor_text": "https://lucyinthecloud.com/"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fdd97a784141f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-factor-models-build-your-own-in-r-with-a-few-lines-of-codes-502274ae3624&user=Charles+Malafosse&userId=dd97a784141f&source=post_page-dd97a784141f--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F6fc3c69b59a6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustom-factor-models-build-your-own-in-r-with-a-few-lines-of-codes-502274ae3624&newsletterV3=dd97a784141f&newsletterV3Id=6fc3c69b59a6&user=Charles+Malafosse&userId=dd97a784141f&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}