{"url": "https://towardsdatascience.com/indexing-very-large-tables-569811421ee0", "time": 1683010347.778023, "path": "towardsdatascience.com/indexing-very-large-tables-569811421ee0/", "webpage": {"metadata": {"title": "Indexing Very Large Tables. A short guide to the best practices\u2026 | by Kovid Rathee | Towards Data Science", "h1": "Indexing Very Large Tables", "description": "This article was last updated on 5 August 2021. Thanks to John Trollope for pointing out some embarrassing typos. Slow queries are one of the main problems in any data or software team. Usually, the\u2026"}, "outgoing_paragraph_urls": [{"url": "http://www.percona.com/doc/percona-toolkit/2.1/pt-online-schema-change.html", "anchor_text": "pt-online-schema-change", "paragraph_index": 11}, {"url": "https://dev.mysql.com/doc/refman/8.0/en/partitioning-types.html", "anchor_text": "here", "paragraph_index": 16}, {"url": "https://towardsdatascience.com/generating-test-data-using-sql-2a1162f5ef16", "anchor_text": "generate test data", "paragraph_index": 22}, {"url": "https://linktr.ee/kovid", "anchor_text": "a series of articles about database performance & SQL for Towards Data Science", "paragraph_index": 24}, {"url": "https://kovidrathee.medium.com/membership", "anchor_text": "https://kovidrathee.medium.com/membership", "paragraph_index": 26}], "all_paragraphs": ["This article was last updated on 5 August 2021. Thanks to John Trollope for pointing out some embarrassing typos.", "Slow queries are one of the main problems in any data or software team. Usually, the first knee jerk reaction to fasten your queries is to create all the indexes you can think of. Although indexes are supposed to make queries faster, they cannot absolve you from the sins you committed while writing the queries. Also, creating indexes comes with a cost, which is something, if not thought about, can kill database performance in all aspects and not just reading data.", "Slow query issues are seen more often with large tables. We can see slow queries in two different kinds of setups \u2014 one is not time-critical, and the other is. Let\u2019s talk about what are slow queries for the one that is critical first. If you\u2019re developing an application, a good rule of thumb is to write your frequently run queries in such a way that they return a response within 500 ms. For analytical systems (non time-critical), it is highly subjective. Reports and BI tools can be tricky. Someone once told me that running a single BI dashboard took over a day, and they were not really bothered by that.", "Having worked with large tables (> 1 billion records) quite a lot, I have realized that we can take care of a couple of things while doing indexes on them.", "Creating and maintaining an index on a huge table is costlier than on smaller tables. Whenever you create an index, a copy of the indexed column + the primary key is created on disk, and the index is kept in memory as much as possible. If an index has all the data required by a query, it will never go to the actual table. For example, if you have filtered data on customer_id and grouped by year and the index is on (customer_id, year), and you aren\u2019t querying anything else in the SELECT statement, then the query will not go to the disk table to fetch records as the index satisfies all the data requirements for the query.", "You should strive to have optimal indexes for all queries, i.e., indexes that cover most, if not all, columns that should use an index in operations like filtering, grouping, sorting, selecting, etc. These indexes are called covering indexes. They cover the requirements for your queries.", "More indexes means slower inserts; more indexes mean more disk & memory space occupied.", "Index design is tricky. If your system has a variety of queries, a single or even a couple of indexes might not fulfil the requirements of all those queries. That is dangerous! The first reaction, as mentioned earlier, is to create an index that suits your queries, not using indexes.", "The cost overhead of indexes is great. Every time you add an index, it writes on the indexed table become slower as it has to balance more B-tree structures every time a record comes in. The cost is definitely higher when the B-tree writes are not sequential, which is why, more often than not, it is better to pick an existing index and modify it by adding another column or changing the column order or both.", "Reduce your footprint by modifying an existing index instead of adding more indexes mindlessly.", "For this to happen, you must have deep insight into your queries. It\u2019d be great to have a catalogue that tells you which query requires which index so that the modifications you do to the index don\u2019t have an unintended effect on the rest of the queries.", "MySQL supports online changes for index operations \u2014 so if you create or delete an index, reads and writes on the table will not be impacted during the index creation. That\u2019s what the documentation says, but I have seen issues with that. For better performance with index operations, use Percona\u2019s pt-online-schema-change tool. It\u2019s tried & tested.", "Balancing a larger B-tree is more resource consuming than balancing a smaller B-tree. Partitioning splits your table into smaller sub-tables under the hood, but you don\u2019t get to know about it unless going to the disk and see that there are different table files created instead of one for your table. The same goes for indexes on that table.", "The main motive of indexing & partitioning is the same \u2014 discard data for queries. Apart from discarding the data using partition pruning, partitions also have the positive side effect that I just mentioned \u2014 it gives us smaller trees to balance, smaller indexes to recompute.", "Another rule of thumb is to use partitioning for really large tables, i.e., tables with at least 100 million rows. Once partitioning is done, all of your queries to the partitioned table must contain the partition_key in the WHERE clause otherwise, it will be a full table scan \u2014 which is equivalent to a linear search on the whole table.", "Partitions result in smaller B-trees/indexes, hence there\u2019s less work to recompute those indexes on inserts.", "For indexing to work, you should have a suitable field that all your queries can use. There\u2019s a host of different types of partitions you can use on your data. Find more about them here.", "Although this should be covered by creating covering indexes, I think it deserves a separate mention because indexes can only help you hide bad query writing. Disk operations are costly. I keep bringing up Jim Gray\u2019s analogy to demonstrate Disk I/O as it is important to understand this in the current context.", "Sort operations not using an index are performed on disk. Disks are slow. To avoid disk operations, make sure that you look out for hints & information in the EXPLAIN PLAN of your query. When you see filesort, understand that it will try to fit the whole table in the memory in many chunks. If the table is too large to fit in memory, it will create a temporary table on disk and do it there. Look out for a using filesort with or without a combination of using temporary. Whenever MySQL cannot perform the sort using an index, using filesort will show up in the plan.", "To understand this in-depth, please go through this very old post by someone working on the MySQL optimizer. Although the post is old, I think it\u2019s still relevant, and not much has changed to this part.", "There are a couple of things that you should take care of while sorting \u2014 do remember that you can\u2019t skip columns in an index. You cannot write a query that orders by x, z and expect it to use the index fully for an index. The index won\u2019t also work if you have a range filter or an IN clause on the first column. It will also not work when two columns (x, y) are sorted in a different order in the query, i.e., ORDER BY x ASC, y DESC. If you don\u2019t take care of any of these points, the index will not execute the query.", "\u200eThe essence of this point was to get across the idea of making sure that you use indexes for sorting, too, as otherwise, it\u2019s going to be a very costly operation.", "Handling large tables in databases is fun. That\u2019s really when you get to understand the intricacies of the database system, its strength and its weaknesses. I would advise you to create a test database, generate test data to populate a large table and run queries to understand how it all works. Practice trumps theory.", "Shoutout to Kai Sassnowski for this talk which validated and reinforced my years of learning about indexing in MySQL.", "This is part of a series of articles about database performance & SQL for Towards Data Science. Here are some of them \u2014", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "I write about tech, Indian classical music, literature, and the workplace among other things. 1x engineer on weekdays. https://kovidrathee.medium.com/membership"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F569811421ee0&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Findexing-very-large-tables-569811421ee0&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Findexing-very-large-tables-569811421ee0&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Findexing-very-large-tables-569811421ee0&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Findexing-very-large-tables-569811421ee0&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://me.dm/@kovidrathee", "anchor_text": "Mastodon"}, {"url": "https://towardsdatascience.com/?source=post_page-----569811421ee0--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----569811421ee0--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://kovidrathee.medium.com/?source=post_page-----569811421ee0--------------------------------", "anchor_text": ""}, {"url": "https://kovidrathee.medium.com/?source=post_page-----569811421ee0--------------------------------", "anchor_text": "Kovid Rathee"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F13d513db037&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Findexing-very-large-tables-569811421ee0&user=Kovid+Rathee&userId=13d513db037&source=post_page-13d513db037----569811421ee0---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F569811421ee0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Findexing-very-large-tables-569811421ee0&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F569811421ee0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Findexing-very-large-tables-569811421ee0&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@bamin?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Pierre Bamin"}, {"url": "https://unsplash.com/s/photos/index?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Unsplash"}, {"url": "http://www.percona.com/doc/percona-toolkit/2.1/pt-online-schema-change.html", "anchor_text": "pt-online-schema-change"}, {"url": "https://dev.mysql.com/doc/refman/8.0/en/partitioning-types.html", "anchor_text": "here"}, {"url": "http://s.petrunia.net/blog/?p=24", "anchor_text": "Sergey Petrunia's blog \" How MySQL executes ORDER BYIn last couple of weeks there has been a tide of ORDER/GROUP BY-related optimization bugs, where I was the fixer or the\u2026s.petrunia.net"}, {"url": "https://towardsdatascience.com/generating-test-data-using-sql-2a1162f5ef16", "anchor_text": "generate test data"}, {"url": "https://linktr.ee/kovid", "anchor_text": "a series of articles about database performance & SQL for Towards Data Science"}, {"url": "https://towardsdatascience.com/easy-fixes-for-sql-queries-ff9d8867a617", "anchor_text": "Easy Fixes for SQL Queries"}, {"url": "https://towardsdatascience.com/defensive-query-writing-1fa07674899b", "anchor_text": "Defensive Query Writing"}, {"url": "https://towardsdatascience.com/the-many-flavours-of-sql-7b7da5d56c1e", "anchor_text": "Many Flavours of SQL"}, {"url": "https://towardsdatascience.com/complete-data-engineers-vocabulary-87967e374fad", "anchor_text": "Complete Data Engineer\u2019s Vocabulary"}, {"url": "https://towardsdatascience.com/how-to-avoid-writing-sloppy-sql-43647a160025", "anchor_text": "How to Avoid Writing Sloppy SQL"}, {"url": "https://towardsdatascience.com/well-always-have-sequel-55325432174", "anchor_text": "We\u2019ll Always Have Sequel"}, {"url": "https://medium.com/tag/database?source=post_page-----569811421ee0---------------database-----------------", "anchor_text": "Database"}, {"url": "https://medium.com/tag/indexing?source=post_page-----569811421ee0---------------indexing-----------------", "anchor_text": "Indexing"}, {"url": "https://medium.com/tag/data-engineering?source=post_page-----569811421ee0---------------data_engineering-----------------", "anchor_text": "Data Engineering"}, {"url": "https://medium.com/tag/towards-data-science?source=post_page-----569811421ee0---------------towards_data_science-----------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/tag/software-development?source=post_page-----569811421ee0---------------software_development-----------------", "anchor_text": "Software Development"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F569811421ee0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Findexing-very-large-tables-569811421ee0&user=Kovid+Rathee&userId=13d513db037&source=-----569811421ee0---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F569811421ee0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Findexing-very-large-tables-569811421ee0&user=Kovid+Rathee&userId=13d513db037&source=-----569811421ee0---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F569811421ee0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Findexing-very-large-tables-569811421ee0&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----569811421ee0--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F569811421ee0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Findexing-very-large-tables-569811421ee0&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----569811421ee0---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----569811421ee0--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----569811421ee0--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----569811421ee0--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----569811421ee0--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----569811421ee0--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----569811421ee0--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----569811421ee0--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----569811421ee0--------------------------------", "anchor_text": ""}, {"url": "https://kovidrathee.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://kovidrathee.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Kovid Rathee"}, {"url": "https://kovidrathee.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "3.1K Followers"}, {"url": "https://kovidrathee.medium.com/membership", "anchor_text": "https://kovidrathee.medium.com/membership"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F13d513db037&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Findexing-very-large-tables-569811421ee0&user=Kovid+Rathee&userId=13d513db037&source=post_page-13d513db037--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F8154c41b0f77&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Findexing-very-large-tables-569811421ee0&newsletterV3=13d513db037&newsletterV3Id=8154c41b0f77&user=Kovid+Rathee&userId=13d513db037&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}