{"url": "https://towardsdatascience.com/how-to-create-snapshots-and-backups-of-your-azure-storage-e72bef58e0aa", "time": 1683005197.1932108, "path": "towardsdatascience.com/how-to-create-snapshots-and-backups-of-your-azure-storage-e72bef58e0aa/", "webpage": {"metadata": {"title": "Backup your Azure Storage using snapshots and Data Factory | by Ren\u00e9 Bremer | Towards Data Science", "h1": "Backup your Azure Storage using snapshots and Data Factory", "description": "Azure Storage always stores multiple copies of your data. When Geo-redundant Storage (GRS) is used, it is also replicated to the paired region. This way, GRS prevents that data is lost in case of\u2026"}, "outgoing_paragraph_urls": [{"url": "https://docs.microsoft.com/en-us/azure/best-practices-availability-paired-regions", "anchor_text": "paired region", "paragraph_index": 0}, {"url": "https://docs.microsoft.com/en-us/azure/storage/common/storage-redundancy#geo-redundant-storage", "anchor_text": "lost", "paragraph_index": 0}, {"url": "https://azure.microsoft.com/nl-nl/blog/microsoft-azure-block-blob-storage-backup/", "anchor_text": "a backup", "paragraph_index": 0}, {"url": "https://docs.microsoft.com/en-us/rest/api/storageservices/creating-a-snapshot-of-a-blob", "anchor_text": "blob snapshots", "paragraph_index": 3}, {"url": "https://github.com/rebremer/blog-snapshotbackup-azuredatalake/blob/master/blog-snapshots-func/HttpSnapshotIncBackupContainerProducer/__init__.py", "anchor_text": "script HttpSnapshotIncBackupContainerProducer", "paragraph_index": 6}, {"url": "https://github.com/rebremer/blog-snapshotbackup-azuredatalake/blob/master/blog-snapshots-func/QueueCreateBlobBackupADFv2/__init__.py", "anchor_text": "script QueueCreateBlobBackupADFv2", "paragraph_index": 12}, {"url": "https://github.com/rebremer/blog-snapshotbackup-azuredatalake/blob/master/blog-snapshots-func/HttpSnapshotIncBackupStorageReconciliation/__init__.py", "anchor_text": "script HttpSnapshotIncBackupStorageReconciliation", "paragraph_index": 18}, {"url": "https://github.com/rebremer/blog-snapshotbackup-azuredatalake", "anchor_text": "this github", "paragraph_index": 21}], "all_paragraphs": ["Azure Storage always stores multiple copies of your data. When Geo-redundant Storage (GRS) is used, it is also replicated to the paired region. This way, GRS prevents that data is lost in case of disaster. However, GRS cannot prevent data loss when application errors corrupt data. Corrupted data is then just replicated to other zones/regions. In that case, a backup is needed to restore your data. Two backup strategies are as follows:", "In this blog, it is discussed how snapshots and incremental backups can be created from a storage account, see also overview depicted below.", "To support the creation of automatic snapshots and incremental backup of your storage account, three types of scripts are used and discussed in the remaining of this blog:", "Notice that blob snapshots are only supported in regular storage accounts and are not yet supported in ADLSgen2 (but is expected to become available in ADLSgen2, too). Scripts are therefore based on regular storage accounts, detailed explanation of the scripts can be found below. Also notice that scripts deal with the creation of snapshots/backups, not with restoring it.", "In a data lake, data is typically ingested using Azure Data Factory by a Producer. To create event based triggered snapshots/incremental backups, the following shall be deployed:", "Now every time when new data is ingested using ADFv2, an Azure Function is called that creates a snapshot and sends an incremental backup request for new/changed blobs, see also below.", "The internal working of script HttpSnapshotIncBackupContainerProducer can be explained as follows:", "The core of the script is as follows:", "Notice that only the Producer ADFv2 Managed Identity and this Azure Function Managed Identity have write access to this container. Blob triggers do not work in this scenario since no events are fired when blobs are modified.", "The asynchronous incremental backup creation is discussed in the next chapter.", "Once a new incremental backup request is added to the storage queue, this message shall be processed such that incremental backup is created. In this, the following shall be deployed:", "Now every time a new incremental backup request message is received on the storage queue, an Azure Function is triggered that calls an ADFv2 pipeline that creates an incremental backup, see also below.", "The working of script QueueCreateBlobBackupADFv2 can be explained as follows:", "In step 2b, it can also be decided to run blob_lease mode which exclusively locks the file and guarantees the correct version of the file is added to backup storage account. Whether or not using blob lease depends on a lot of factors (e.g. max lease time allowed, file size, number of jobs, immutability).", "The core of the script is as follows:", "In the previous two chapters, it was discussed how snapshots and incremental backups can be created when a producer adds new data to the data lake using ADFv2. However, there can also be a need to trigger snapshots/incremental backups that are time-based. This will be discussed in the next chapter.", "In chapter 2, it is discussed how a Producer can create event-based snapshots/incremental backup requests. However, there is also a need for a reconciliation script that can create missing snapshots and/or missing backups. This can happen when a Producer forgets to add the Azure Function to its ingestion pipeline and/or the script failed to run. To create a time based function, the following shall be deployed:", "Now an admin can configure the reconciliation script to be run periodically such that snapshots are created and sends an incremental backup request, see also below.", "The internal working of script HttpSnapshotIncBackupStorageReconciliation can be explained as follows:", "The core of the script is as follows:", "Azure Storage always stores multiple copies of your data and Geo-redundant Storage (GRS) additionally stores copies in a paired region. However, GRS storage does not protect data being corrupted because of application errors. Corrupted data is then just replicated to the other zones and regions. Two measurements that can protect against data corruption are as follows:", "In this blog it is discussed how synchronous snapshots and asynchronous incremental backups can be created using scripts in this github. See also extended high level overview depicted below.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Data Solution Architect @ Microsoft, working with Azure services as ADFv2, ADLSgen2, Azure DevOps, Databricks, Function Apps and SQL. Opinions here are mine."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fe72bef58e0aa&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-snapshots-and-backups-of-your-azure-storage-e72bef58e0aa&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-snapshots-and-backups-of-your-azure-storage-e72bef58e0aa&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-snapshots-and-backups-of-your-azure-storage-e72bef58e0aa&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-snapshots-and-backups-of-your-azure-storage-e72bef58e0aa&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----e72bef58e0aa--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----e72bef58e0aa--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://rebremer.medium.com/?source=post_page-----e72bef58e0aa--------------------------------", "anchor_text": ""}, {"url": "https://rebremer.medium.com/?source=post_page-----e72bef58e0aa--------------------------------", "anchor_text": "Ren\u00e9 Bremer"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F11e5e7fb3771&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-snapshots-and-backups-of-your-azure-storage-e72bef58e0aa&user=Ren%C3%A9+Bremer&userId=11e5e7fb3771&source=post_page-11e5e7fb3771----e72bef58e0aa---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fe72bef58e0aa&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-snapshots-and-backups-of-your-azure-storage-e72bef58e0aa&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fe72bef58e0aa&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-snapshots-and-backups-of-your-azure-storage-e72bef58e0aa&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://towardsdatascience.com/how-to-recover-your-azure-data-lake-5b5e53f3736f", "anchor_text": "https://towardsdatascience.com/how-to-recover-your-azure-data-lake-5b5e53f3736f"}, {"url": "https://docs.microsoft.com/en-us/azure/best-practices-availability-paired-regions", "anchor_text": "paired region"}, {"url": "https://docs.microsoft.com/en-us/azure/storage/common/storage-redundancy#geo-redundant-storage", "anchor_text": "lost"}, {"url": "https://azure.microsoft.com/nl-nl/blog/microsoft-azure-block-blob-storage-backup/", "anchor_text": "a backup"}, {"url": "https://docs.microsoft.com/en-us/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs", "anchor_text": "nature of blobs"}, {"url": "https://docs.microsoft.com/en-us/rest/api/storageservices/creating-a-snapshot-of-a-blob", "anchor_text": "blob snapshots"}, {"url": "https://github.com/rebremer/blog-snapshotbackup-azuredatalake/tree/master/blog-snapshots-func/HttpSnapshotIncBackupContainerProducer", "anchor_text": "script"}, {"url": "https://docs.microsoft.com/nl-nl/azure/azure-functions/functions-reference-python", "anchor_text": "link"}, {"url": "https://towardsdatascience.com/how-to-secure-your-azure-function-data-processing-c9947bf724fb", "anchor_text": "blog"}, {"url": "https://github.com/rebremer/blog-snapshotbackup-azuredatalake/blob/master/blog-snapshots-adfv2/pipeline/blogtriggersnapshots.json", "anchor_text": "ingestion pipeline"}, {"url": "https://github.com/rebremer/blog-snapshotbackup-azuredatalake/blob/master/blog-snapshots-func/HttpSnapshotIncBackupContainerProducer/__init__.py", "anchor_text": "script HttpSnapshotIncBackupContainerProducer"}, {"url": "https://docs.microsoft.com/en-us/azure/storage/common/storage-concurrency#optimistic-concurrency-for-blobs-and-containers", "anchor_text": "ETag"}, {"url": "https://github.com/rebremer/blog-snapshotbackup-azuredatalake/tree/master/blog-snapshots-func/QueueCreateBlobBackupADFv2", "anchor_text": "script"}, {"url": "https://github.com/rebremer/blog-snapshotbackup-azuredatalake/blob/master/blog-snapshots-func/appsettings.txt", "anchor_text": "here"}, {"url": "https://github.com/rebremer/blog-snapshotbackup-azuredatalake/blob/master/blog-snapshots-adfv2/pipeline/blogtriggerbackup.json", "anchor_text": "pipeline"}, {"url": "https://docs.microsoft.com/nl-nl/azure/app-service/overview-managed-identity?tabs=dotnet#add-a-system-assigned-identity", "anchor_text": "Managed Identity of your Azure Function"}, {"url": "https://docs.microsoft.com/en-us/azure/data-factory/concepts-roles-permissions", "anchor_text": "RBAC role"}, {"url": "https://github.com/rebremer/blog-snapshotbackup-azuredatalake/blob/master/blog-snapshots-func/QueueCreateBlobBackupADFv2/__init__.py", "anchor_text": "script QueueCreateBlobBackupADFv2"}, {"url": "https://github.com/rebremer/blog-snapshotbackup-azuredatalake/tree/master/blog-snapshots-func/HttpSnapshotIncBackupStorageReconciliation", "anchor_text": "script"}, {"url": "https://github.com/rebremer/blog-snapshotbackup-azuredatalake/blob/master/blog-snapshots-func/appsettings.txt", "anchor_text": "here"}, {"url": "https://github.com/rebremer/blog-snapshotbackup-azuredatalake/blob/master/blog-snapshots-func/HttpSnapshotIncBackupStorageReconciliation/__init__.py", "anchor_text": "script HttpSnapshotIncBackupStorageReconciliation"}, {"url": "https://docs.microsoft.com/en-us/azure/storage/common/storage-concurrency#optimistic-concurrency-for-blobs-and-containers", "anchor_text": "ETag"}, {"url": "https://github.com/rebremer/blog-snapshotbackup-azuredatalake", "anchor_text": "this github"}, {"url": "https://medium.com/tag/azure?source=post_page-----e72bef58e0aa---------------azure-----------------", "anchor_text": "Azure"}, {"url": "https://medium.com/tag/programming?source=post_page-----e72bef58e0aa---------------programming-----------------", "anchor_text": "Programming"}, {"url": "https://medium.com/tag/software-engineering?source=post_page-----e72bef58e0aa---------------software_engineering-----------------", "anchor_text": "Software Engineering"}, {"url": "https://medium.com/tag/data-engineering?source=post_page-----e72bef58e0aa---------------data_engineering-----------------", "anchor_text": "Data Engineering"}, {"url": "https://medium.com/tag/storage?source=post_page-----e72bef58e0aa---------------storage-----------------", "anchor_text": "Storage"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fe72bef58e0aa&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-snapshots-and-backups-of-your-azure-storage-e72bef58e0aa&user=Ren%C3%A9+Bremer&userId=11e5e7fb3771&source=-----e72bef58e0aa---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fe72bef58e0aa&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-snapshots-and-backups-of-your-azure-storage-e72bef58e0aa&user=Ren%C3%A9+Bremer&userId=11e5e7fb3771&source=-----e72bef58e0aa---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fe72bef58e0aa&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-snapshots-and-backups-of-your-azure-storage-e72bef58e0aa&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----e72bef58e0aa--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fe72bef58e0aa&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-snapshots-and-backups-of-your-azure-storage-e72bef58e0aa&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----e72bef58e0aa---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----e72bef58e0aa--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----e72bef58e0aa--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----e72bef58e0aa--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----e72bef58e0aa--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----e72bef58e0aa--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----e72bef58e0aa--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----e72bef58e0aa--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----e72bef58e0aa--------------------------------", "anchor_text": ""}, {"url": "https://rebremer.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://rebremer.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Ren\u00e9 Bremer"}, {"url": "https://rebremer.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "731 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F11e5e7fb3771&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-snapshots-and-backups-of-your-azure-storage-e72bef58e0aa&user=Ren%C3%A9+Bremer&userId=11e5e7fb3771&source=post_page-11e5e7fb3771--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fed36bca8eb16&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-snapshots-and-backups-of-your-azure-storage-e72bef58e0aa&newsletterV3=11e5e7fb3771&newsletterV3Id=ed36bca8eb16&user=Ren%C3%A9+Bremer&userId=11e5e7fb3771&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}