{"url": "https://towardsdatascience.com/neural-network-calibration-using-pytorch-c44b7221a61", "time": 1683014310.662394, "path": "towardsdatascience.com/neural-network-calibration-using-pytorch-c44b7221a61/", "webpage": {"metadata": {"title": "Neural Network Calibration using PyTorch | by Lukas Huber | Towards Data Science", "h1": "Neural Network Calibration using PyTorch", "description": "Neural Networks do not output actual probabilities. We will use PyTorch to calibrate them so they are usable for safety-critical tasks like autonomous driving."}, "outgoing_paragraph_urls": [{"url": "https://colab.research.google.com/drive/1H_XlTbNvjxlAXMW5NuBDWhxF3F2Osg1F?usp=sharing", "anchor_text": "here", "paragraph_index": 3}, {"url": "https://cseweb.ucsd.edu/~elkan/calibrated.pdf", "anchor_text": "Histogram Binning,", "paragraph_index": 11}, {"url": "https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.13.7457&rep=rep1&type=pdf", "anchor_text": "Isotonic Regression", "paragraph_index": 11}, {"url": "https://people.cs.pitt.edu/~milos/research/AAAI_Calibration.pdf", "anchor_text": "Bayesian Binning into Quantiles (BBQ)", "paragraph_index": 11}, {"url": "http://citeseer.ist.psu.edu/viewdoc/summary?doi=10.1.1.41.1639", "anchor_text": "Platt Scaling", "paragraph_index": 11}, {"url": "https://en.wikipedia.org/wiki/Limited-memory_BFGS", "anchor_text": "LBGFS", "paragraph_index": 18}, {"url": "https://colab.research.google.com/drive/1H_XlTbNvjxlAXMW5NuBDWhxF3F2Osg1F?usp=sharing", "anchor_text": "here", "paragraph_index": 19}, {"url": "https://arxiv.org/pdf/1706.04599.pdf", "anchor_text": "On calibration of Neural Networks", "paragraph_index": 20}, {"url": "https://bit.ly/331Exyv", "anchor_text": "https://bit.ly/331Exyv", "paragraph_index": 22}], "all_paragraphs": ["Imagine you are a radiologist working in this new high-tech hospital. Last week you got your first neural-network based model to assist you making diagnoses given your patients data and eventually improving your accuracy. But wait! Very much like us humans, synthetic models are never 100% accurate in their predictions. But how do we know if a model is absolutely certain or if it just barely surpasses the point of guessing? This knowledge is crucial for right interpretation and key for selecting appropriate treatment.", "Assuming you\u2019re more of an engineer: This scenario is also highly relevant for autonomous driving where a car constantly has to make decisions whether there is an obstacle in front of it or not. Ignoring uncertainties can get ugly real quick here.", "If you are like 90% of the Deep Learning community (including past me) you just assumed that the predictions produced by the Softmax functionrepresent probabilities since they are neatly squashed into the domain [0,1]. This is a popular pitfall since these predictions generally tend to be overconfident. As we\u2019ll see soon this behaviour is affected by a variety of architectural choices like the use of Batch Normalization or the number of layers.", "You can find a interactive Google Colab notebook with all the code here.", "As we know now, it is desirable to output calibrated confidences instead of their raw counterparts. To get an intuitive understanding of how well a specific architecture performs in this regard, Realiability Diagramms are often used.", "Summarized in one sentence, Reliability Plots show how well the predicted confidence scores hold up against their actual accuracy. Hence, given 100 predictions each with confidence of 0.9, we expect 90% of them to be correct if the model is perfectly calibrated.", "To fully understand what\u2019s going on we need to dig a bit deeper. As we can see from the plot, all the confidence scores of the test set are binned into M=10 distinct bins [0, 0.1), [0.1, 0.2),\u2026, [0.9, 1]. For each bin we can then calculate its accuracy", "Both values are then visualized as a Bar plot with the identity line indicating perfect calibration.", "Diagrams and plots are just one side of the story. In order to score a model based on its Calibration Error we need to define metrics. Fortunately, both metrics most often used here are really intuitive.", "The Expected Calibration Error (ECE) simply takes a weighted average over the absolute accuracy/confidence difference.", "For safety critical applications, like described above, it may be useful to measure the maximum discrepancy between accuracy and confidence. This can be accomplished by using the Maximum Calibration Error (MCE).", "We now want to focus on how to tackle this issue. While many solutions like Histogram Binning, Isotonic Regression, Bayesian Binning into Quantiles (BBQ) and Platt Scaling exist (with their corresponding extensions for multiclass problems), we want to focus on Temperature Scaling. This is due to the fact that it is the easiest to implement while giving the best results out of the other algorithms named above.", "To fully understand it we need to take a step back and look at the outputs of a neural network. Assuming a multi-class problem, the last layer of a network outputs the logits z\u1d62 \u2208 \u211d. The predicted probability can then be obtained using the Softmax function \u03c3.", "Temperature scaling directly works on the logits z\u1d62 (Not the predicted probabilities!!) and scales them using a single parameter T>0 for all classes. The calibrated confidence can then be obtained by", "It is important to note that the parameter T is optimized with repect to the Negative-Log-Likelihood (NLL) loss on the validation set and the network\u2019s parameters are fixed during this stage.", "As we can see from the figure, the bars are now way closer to the identity line, indicating almost perfect calibration. We can also see this looking at the metrics. The ECE dropped from 2.10% to 0.25% and the MCE from 27.27% to 3.86%, which is a drastic improvement.", "As promised, the implementation in PyTorch is rather straight forward.", "First we define the T_scaling method returning the calibrated confidences given a specific temperature T together with the logits.", "In the next step the parameter T has to be estimated using the LBGFS algorithm. This should only take a couple of seconds on a GPU.", "You are welcome to play around in the Google Colab Notebook I created here.", "As shown in this article, network calibration can be accomplished in just a few lines of code with drastic improvements. If there is enough interest I\u2019m happy to discuss other approaches for model calibration in another Medium article. If you are interested in a deeper dive into this topic I highly recommend the Paper \u201cOn calibration of Neural Networks\u201d by Guo et al..", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Working on autonomous driving @ NVIDIA LinkedIn: https://bit.ly/331Exyv"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fc44b7221a61&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-using-pytorch-c44b7221a61&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-using-pytorch-c44b7221a61&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-using-pytorch-c44b7221a61&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-using-pytorch-c44b7221a61&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----c44b7221a61--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----c44b7221a61--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@lukas.huber1?source=post_page-----c44b7221a61--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@lukas.huber1?source=post_page-----c44b7221a61--------------------------------", "anchor_text": "Lukas Huber"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F6c9d0c78d2f9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-using-pytorch-c44b7221a61&user=Lukas+Huber&userId=6c9d0c78d2f9&source=post_page-6c9d0c78d2f9----c44b7221a61---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fc44b7221a61&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-using-pytorch-c44b7221a61&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fc44b7221a61&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-using-pytorch-c44b7221a61&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@gregshield?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Greg Shield"}, {"url": "https://unsplash.com/s/photos/fall?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Unsplash"}, {"url": "https://colab.research.google.com/drive/1H_XlTbNvjxlAXMW5NuBDWhxF3F2Osg1F?usp=sharing", "anchor_text": "here"}, {"url": "https://cseweb.ucsd.edu/~elkan/calibrated.pdf", "anchor_text": "Histogram Binning,"}, {"url": "https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.13.7457&rep=rep1&type=pdf", "anchor_text": "Isotonic Regression"}, {"url": "https://people.cs.pitt.edu/~milos/research/AAAI_Calibration.pdf", "anchor_text": "Bayesian Binning into Quantiles (BBQ)"}, {"url": "http://citeseer.ist.psu.edu/viewdoc/summary?doi=10.1.1.41.1639", "anchor_text": "Platt Scaling"}, {"url": "https://en.wikipedia.org/wiki/Limited-memory_BFGS", "anchor_text": "LBGFS"}, {"url": "https://github.com/gpleiss/temperature_scaling", "anchor_text": "repository"}, {"url": "https://colab.research.google.com/drive/1H_XlTbNvjxlAXMW5NuBDWhxF3F2Osg1F?usp=sharing", "anchor_text": "here"}, {"url": "https://arxiv.org/pdf/1706.04599.pdf", "anchor_text": "On calibration of Neural Networks"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----c44b7221a61---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/tag/neural-networks?source=post_page-----c44b7221a61---------------neural_networks-----------------", "anchor_text": "Neural Networks"}, {"url": "https://medium.com/tag/model-calibration?source=post_page-----c44b7221a61---------------model_calibration-----------------", "anchor_text": "Model Calibration"}, {"url": "https://medium.com/tag/editors-pick?source=post_page-----c44b7221a61---------------editors_pick-----------------", "anchor_text": "Editors Pick"}, {"url": "https://medium.com/tag/data-science?source=post_page-----c44b7221a61---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "http://creativecommons.org/licenses/by/4.0/", "anchor_text": "Some rights reserved"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fc44b7221a61&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-using-pytorch-c44b7221a61&user=Lukas+Huber&userId=6c9d0c78d2f9&source=-----c44b7221a61---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fc44b7221a61&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-using-pytorch-c44b7221a61&user=Lukas+Huber&userId=6c9d0c78d2f9&source=-----c44b7221a61---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fc44b7221a61&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-using-pytorch-c44b7221a61&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----c44b7221a61--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fc44b7221a61&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-using-pytorch-c44b7221a61&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----c44b7221a61---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----c44b7221a61--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----c44b7221a61--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----c44b7221a61--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----c44b7221a61--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----c44b7221a61--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----c44b7221a61--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----c44b7221a61--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----c44b7221a61--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@lukas.huber1?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@lukas.huber1?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Lukas Huber"}, {"url": "https://medium.com/@lukas.huber1/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "39 Followers"}, {"url": "https://bit.ly/331Exyv", "anchor_text": "https://bit.ly/331Exyv"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F6c9d0c78d2f9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-using-pytorch-c44b7221a61&user=Lukas+Huber&userId=6c9d0c78d2f9&source=post_page-6c9d0c78d2f9--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fb67453eb47e8&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fneural-network-calibration-using-pytorch-c44b7221a61&newsletterV3=6c9d0c78d2f9&newsletterV3Id=b67453eb47e8&user=Lukas+Huber&userId=6c9d0c78d2f9&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}