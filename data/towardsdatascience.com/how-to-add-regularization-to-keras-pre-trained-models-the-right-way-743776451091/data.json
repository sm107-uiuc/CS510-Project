{"url": "https://towardsdatascience.com/how-to-add-regularization-to-keras-pre-trained-models-the-right-way-743776451091", "time": 1683001627.748214, "path": "towardsdatascience.com/how-to-add-regularization-to-keras-pre-trained-models-the-right-way-743776451091/", "webpage": {"metadata": {"title": "How to Add Regularization to Keras Pre-trained Models the Right Way | by Thalles Silva | Towards Data Science", "h1": "How to Add Regularization to Keras Pre-trained Models the Right Way", "description": "Regularizing pre-trained Keras models using Tensorflow 2.0"}, "outgoing_paragraph_urls": [{"url": "https://www.tensorflow.org/api_docs/python/tf/keras/layers/SpatialDropout2D", "anchor_text": "Spatial Dropout", "paragraph_index": 10}, {"url": "https://keras.io/applications/", "anchor_text": "Keras Applications", "paragraph_index": 24}, {"url": "https://sthalles.github.io/", "anchor_text": "https://sthalles.github.io/", "paragraph_index": 28}], "all_paragraphs": ["If you train deep learning models for a living, you might be tired of knowing one specific and important thing:", "Fine-tuning deep pre-trained models requires a lot of regularization.", "As a contrast, you might have noticed that it is not always obvious how to add regularization to pre-trained models taken from deep learning libraries such as Keras. Also, finding the right answer to this question is not easy either. In the processing of writing this post, I came across many code snippets on Stack Overflow and some blog posts that simply did not get it right. Then, as a way of reducing your Google search (and to help my future self), I am going to show you how to add regularization to pre-trained Keras models in the right way.", "Fine-tuning is the process of taking a pre-trained model and use it as the starting point to optimizing a different (most of the times related) task. You can imagine taking a ResNet50 model trained on the ImageNet database and use it fit a new problem like insect classification.", "The process usually follows simple steps.", "P.S. that might be oversimplified but it is fine for our example.", "One thing we must have in mind is:", "When fine-tuning pre-trained models, overfitting is a much bigger concern.", "The problem is easy to see. If you have a small training data, you will keep showing the same instances over and over again to the network. Moreover, as we know, pre-trained ConvNets on ImageNet are usually very complex; i.e. they have a lot of training parameters. As a consequence, the model will quickly memorize your training data entirely.", "As a solution, fine-tuning usually requires 2 things:", "For regularization, anything may help. I usually use l1 or l2 regularization, with early stopping. For ConvNets without batch normalization, Spatial Dropout is helpful as well", "As a side note, deep learning models are known to be data-hungry. These models need a lot of data to disentangle very complex high-dim spaces into linearly separable decisions in the feature space. Many people see fine-tuning as a way of training deep models using smaller datasets. Although in practice this argument may sound right, there is an important catch in here. Even though you may be able to fit a new model using a much smaller dataset, remember that your pre-trained model trained for DAYS (using multiple GPUs). Put it differently, fine-tuning actually means \u2014 Standing on the Shoulder of Giants.", "Let\u2019s now jump into the code.", "Intuitively, the process of adding regularization is straightforward. After loading our pre-trained model, refer to as the base model, we are going loop over all of its layers. For each layer, we check if it supports regularization, and if it does, we add it. The code looks like this.", "It looks like we are done. Indeed, if you Google how to add regularization to Keras pre-trained models, you will find the same.", "As a safety check, let\u2019s make sure that regularization is properly set. In Keras, we can retrieve losses by accessing the losses property of a Layer or a Model. In our case, we can access the list of all losses (from all Layers with regularization) by:", "P.S. if you\u2019re confused with the nomenclature, the property is called losses, because the regularization penalties are added to the loss function during optimization.", "As you can see, there is something weird going on. The list is just empty, which means, there no regularization penalty applied to the convolutional kernels.", "Well, going straight to the problem, it seems that when we change a property on a layer, as we did, the only thing that actually changed was the model config. Thus, the model object itself is just as it was when we loaded. No changes at all.", "Take a look at the config file after adding regularization. The kernel_regularizer property is there like we set it.", "One simple solution to this problem is to reload the model config. This is easy to do and solves the problem.", "Now, if we attempt to see the model.losses, there we have it.", "However, as a common hacking, this introduces another problem. If you pay closer attention to the model\u2019s weights, after reloading the model from the config file, the weights got reset! We just lost, all of the ImageNet pre-trained parameters!", "Well, a quick solution is to use the same strategy. We can save the weights, before reloading the model config, and reload the weights after the model is properly loaded.", "The function below does the complete job. You can pass any model from Keras Applications (using Tensorflow 2.0), along with the regularizer you want, and it returns the model properly configured. Note how we save and reload the model weights before and after reloading the model from the config file.", "Also, you can add bias_regularizer and activity_regularizer using the same code.", "And that is it. A quick but hopefully, useful trick to regularize your pre-trained models.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Computer Vision & Deep Learning. Personal blog: https://sthalles.github.io/"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F743776451091&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-add-regularization-to-keras-pre-trained-models-the-right-way-743776451091&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-add-regularization-to-keras-pre-trained-models-the-right-way-743776451091&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-add-regularization-to-keras-pre-trained-models-the-right-way-743776451091&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-add-regularization-to-keras-pre-trained-models-the-right-way-743776451091&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----743776451091--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----743776451091--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@thalles.silva?source=post_page-----743776451091--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@thalles.silva?source=post_page-----743776451091--------------------------------", "anchor_text": "Thalles Silva"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Ff8db098eb9ca&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-add-regularization-to-keras-pre-trained-models-the-right-way-743776451091&user=Thalles+Silva&userId=f8db098eb9ca&source=post_page-f8db098eb9ca----743776451091---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F743776451091&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-add-regularization-to-keras-pre-trained-models-the-right-way-743776451091&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F743776451091&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-add-regularization-to-keras-pre-trained-models-the-right-way-743776451091&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/keras/layers/SpatialDropout2D", "anchor_text": "Spatial Dropout"}, {"url": "https://keras.io/applications/", "anchor_text": "Keras Applications"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----743776451091---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----743776451091---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/tag/data-science?source=post_page-----743776451091---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/towards-data-science?source=post_page-----743776451091---------------towards_data_science-----------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/tag/tensorflow?source=post_page-----743776451091---------------tensorflow-----------------", "anchor_text": "TensorFlow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F743776451091&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-add-regularization-to-keras-pre-trained-models-the-right-way-743776451091&user=Thalles+Silva&userId=f8db098eb9ca&source=-----743776451091---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F743776451091&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-add-regularization-to-keras-pre-trained-models-the-right-way-743776451091&user=Thalles+Silva&userId=f8db098eb9ca&source=-----743776451091---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F743776451091&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-add-regularization-to-keras-pre-trained-models-the-right-way-743776451091&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----743776451091--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F743776451091&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-add-regularization-to-keras-pre-trained-models-the-right-way-743776451091&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----743776451091---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----743776451091--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----743776451091--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----743776451091--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----743776451091--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----743776451091--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----743776451091--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----743776451091--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----743776451091--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@thalles.silva?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@thalles.silva?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Thalles Silva"}, {"url": "https://medium.com/@thalles.silva/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "1.4K Followers"}, {"url": "https://sthalles.github.io/", "anchor_text": "https://sthalles.github.io/"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Ff8db098eb9ca&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-add-regularization-to-keras-pre-trained-models-the-right-way-743776451091&user=Thalles+Silva&userId=f8db098eb9ca&source=post_page-f8db098eb9ca--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fea9a35433442&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-add-regularization-to-keras-pre-trained-models-the-right-way-743776451091&newsletterV3=f8db098eb9ca&newsletterV3Id=ea9a35433442&user=Thalles+Silva&userId=f8db098eb9ca&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}