{"url": "https://towardsdatascience.com/scaling-apache-airflow-for-machine-learning-workflows-f2446257e495", "time": 1683001620.3309062, "path": "towardsdatascience.com/scaling-apache-airflow-for-machine-learning-workflows-f2446257e495/", "webpage": {"metadata": {"title": "Scaling Apache Airflow for Machine Learning Workflows | by Ari Bajo | Towards Data Science", "h1": "Scaling Apache Airflow for Machine Learning Workflows", "description": "Learn how to easily execute Airflow tasks on the cloud and get automatic version control for each machine learning task."}, "outgoing_paragraph_urls": [{"url": "https://medium.com/bluecore-engineering/were-all-using-airflow-wrong-and-how-to-fix-it-a56f14cb0753", "anchor_text": "Jessica Laughlin argued that we\u2019re all using Airflow wrong", "paragraph_index": 9}, {"url": "https://medium.com/dailymotion/bring-machine-learning-models-faster-to-production-with-airflow-and-kubernetes-e9d47ca3bee5", "anchor_text": "scale Airflow for machine learning tasks with the KubernetesPodOperator", "paragraph_index": 11}, {"url": "https://blog.valohai.com/how-to-track-machine-learning-experiments", "anchor_text": "data, code, environment, parameters and metrics", "paragraph_index": 14}, {"url": "https://valohai.com", "anchor_text": "Valohai", "paragraph_index": 18}, {"url": "https://docs.valohai.com/valohai-api/index.html", "anchor_text": "Valohai\u2019s open API", "paragraph_index": 20}, {"url": "https://github.com/skillupco/airflow-valohai-plugin", "anchor_text": "airflow-valohai-plugin", "paragraph_index": 20}, {"url": "https://docs.valohai.com/valohai-yaml/index.html", "anchor_text": "valohai.yaml", "paragraph_index": 25}, {"url": "https://github.com/skillupco/airflow-valohai-plugin", "anchor_text": "ValohaiSubmitExecutionOperator", "paragraph_index": 34}, {"url": "https://valohai.com", "anchor_text": "Valohai", "paragraph_index": 34}, {"url": "http://guriosity.com", "anchor_text": "guriosity.com", "paragraph_index": 36}], "all_paragraphs": ["Apache Airflow is a popular platform to create, schedule and monitor workflows in Python. It has more than 15k stars on Github and it\u2019s used by data engineers at companies like Twitter, Airbnb and Spotify.", "If you\u2019re using Apache Airflow, your architecture has probably evolved based on the number of tasks and their requirements. While working at Skillup.co, we first had a few hundred DAGs to execute all our data engineering tasks. Then we started doing machine learning.", "We wanted to keep on using Airflow to orchestrate machine learning pipelines but we soon realized that we needed a solution to execute machine learning tasks remotely.", "Apache Airflow has a multi-node architecture based on a scheduler, worker nodes, a metadata database, a web server and a queue service.", "One of the first choices when using Airflow is the type of executor. The executor communicates with the scheduler to allocate resources for each task as they\u2019re queued. The difference between executors comes down to the resources they\u2019ve available.", "The default executor makes it easy to test Airflow locally. It runs tasks sequentially in one machine and uses SQLite to store the task\u2019s metadata.", "The local executor can run tasks in parallel and requires a database that supports parallelism like PostgreSQL. While you can run the local executor in production, it\u2019s common to migrate to the Celery executor to improve availability and scalability.", "The Celery executor requires to set up Redis or RabbitMQ to distribute messages to workers. Airflow then distributes tasks to Celery workers that can run in one or multiple machines. This is the executor that we\u2019re using at Skillup.co to be able to run up to 256 concurrent data engineering tasks.", "The Kubernetes executor creates a new pod for every task instance. It allows you to dynamically scale up and down based on the task requirements.", "Another way to scale Airflow is by using operators to execute some tasks remotely. In 2018, Jessica Laughlin argued that we\u2019re all using Airflow wrong and that the correct way is to only use the Kubernetes operator. Instead of a growing list of functionality-specific operators, she argued that there should be a single bug-free operator to execute any arbitrary task.", "The Kubernetes operator will launch a task in a new pod. When you have a set of tasks that need to run periodically, I find it a better idea to use the Kubernetes operator only for tasks with specific requirements.", "The main problem I see with the Kubernetes operator is that you still need to understand the Kubernetes configuration system and set up a cluster. For example, Dailymotion deployed Airflow in a cluster on Google Kubernetes Engine and decided to also scale Airflow for machine learning tasks with the KubernetesPodOperator.", "In our case, we were a small data team with little resources to set up a Kubernetes cluster. We wanted to focus on building machine learning models and not managing infrastructure.", "At Skillup.co we had to build and deploy several data products in a year as a small team. We knew we wanted to build our models using open source libraries, from classical machine learning models to deep learning. We were also looking for a machine learning platform to help us scale and version control all our models.", "Airflow does a good job keeping track of each task details in the metadata database, but machine learning tasks have different requirements from ETL tasks. A machine learning task is associated with the data, code, environment, parameters and metrics. That information is not collected and displayed by Airflow. And Kubernetes only helps you with the infrastructure.", "Collecting all relevant information for each execution in one place helps debugging machine learning models. In the following table, you can see the information we track to iterate on machine learning models faster.", "You can already find several Airflow operators for machine learning platforms like Google DataFlow, Amazon SageMaker and Databricks. The issue with those operators is that they all have different specifications and are limited to executing code in those platforms.", "Before we started doing any machine learning at Skillup.co, we used Airflow for all data engineering that consisted mostly of Python CLIs called by the Airflow BashOperator.", "Then we decided to use Valohai, a machine learning platform built on open standards, to help us launch machine learning tasks remotely and get automatic version control.", "Having a hybrid solution allowed us to keep sensitive data in our Airflow installation and delegate machine learning to Valohai.", "Thanks to Valohai\u2019s open API, we developed the open-source airflow-valohai-plugin to integrate the two platforms. In the last year, we have used it to release four machine learning models in production.", "The idea behind the Valohai operator is similar to the Kubernetes operator. The advantage is that you don\u2019t need to understand Kubernetes and you also get automatic version control for machine learning.", "Valohai will take care of launching and stopping cloud instances with your requirements, code and data. The Valohai operator simply executes a command in a Docker container, polls for its completion and returns the final status code.", "You can execute code in any language and library by providing a Docker image and your code repository. You also get access to more than fifty cloud environments in AWS, Google and Azure.", "To create a task on Airflow you only need to specify the Valohai project and step to execute. You can also override the default cloud environment, inputs and parameters if needed.", "On the other hand, you need some light configuration on the Valohai side by creating a valohai.yaml. The valohai.yaml serves as a configuration file to set the defaults and validates the machine environment, docker image, command to run, parameters and input data files for each execution.", "Having machine version control from the beginning helped us to debug the data, code and parameters that lead to a prediction and fix it faster. The same way that you want your Airflow tasks to be idempotent to avoid side effects when relaunching them, you want your machine learning models to be based on an audited version of the code and data. That\u2019s easy to do if you always train your models on files stored on your data lake. Below you can see the parsed configuration in the Valohai UI for an execution.", "Valohai is built on top of two smart choices that make it easy to integrate with any programming language and library.", "First, choosing a CLI-first interface universal to all programming languages. CLIs are a popular interface to wrap your functions to execute them locally. CLIs are also the interface for the Bash, Kubernetes and Valohai operators.", "Second, collecting execution metrics from standard output instead of having to install a custom library for each language. All languages have a tool to write a JSON object to standard output. Valohai will automatically parse that object and for example, help you compare the accuracy of each model.", "You can also manually launch executions without any side effects in the Valohai UI. In Airflow, clearing the state of a task will trigger the downstream tasks.", "Last but not least, the new Valohai operator lets you easily pass the outputs from one execution as the inputs of the next one. This helped us create pipelines where the data is automatically versioned on S3. Also, each new execution is run on the same cloud provider and region as the S3 bucket making it fast for Valohai to download it on the AWS EC2 instance.", "Apache Airflow is a powerful tool to create, schedule and monitor workflows but it was built for ETL tasks. Machine learning tasks require specific resources and their execution details should be version controlled.", "If you have the resources to maintain a Kubernetes cluster you can scale machine learning tasks with the KubernetesPodOperator.", "If you want to focus on building models, you can scale Airflow for machine learning tasks with the ValohaiSubmitExecutionOperator. This way, you will also get automatic version control for each execution with Valohai.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Freelance Data Engineer & Technical Writer. I digest 50+ tech blogs by French companies \u2192 guriosity.com"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Ff2446257e495&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fscaling-apache-airflow-for-machine-learning-workflows-f2446257e495&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fscaling-apache-airflow-for-machine-learning-workflows-f2446257e495&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fscaling-apache-airflow-for-machine-learning-workflows-f2446257e495&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fscaling-apache-airflow-for-machine-learning-workflows-f2446257e495&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----f2446257e495--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----f2446257e495--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@arimbr?source=post_page-----f2446257e495--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@arimbr?source=post_page-----f2446257e495--------------------------------", "anchor_text": "Ari Bajo"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F5ad5ce9cd2&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fscaling-apache-airflow-for-machine-learning-workflows-f2446257e495&user=Ari+Bajo&userId=5ad5ce9cd2&source=post_page-5ad5ce9cd2----f2446257e495---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ff2446257e495&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fscaling-apache-airflow-for-machine-learning-workflows-f2446257e495&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ff2446257e495&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fscaling-apache-airflow-for-machine-learning-workflows-f2446257e495&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://medium.com/bluecore-engineering/were-all-using-airflow-wrong-and-how-to-fix-it-a56f14cb0753", "anchor_text": "Jessica Laughlin argued that we\u2019re all using Airflow wrong"}, {"url": "https://medium.com/dailymotion/bring-machine-learning-models-faster-to-production-with-airflow-and-kubernetes-e9d47ca3bee5", "anchor_text": "scale Airflow for machine learning tasks with the KubernetesPodOperator"}, {"url": "https://blog.valohai.com/how-to-track-machine-learning-experiments", "anchor_text": "data, code, environment, parameters and metrics"}, {"url": "https://valohai.com", "anchor_text": "Valohai"}, {"url": "https://docs.valohai.com/valohai-api/index.html", "anchor_text": "Valohai\u2019s open API"}, {"url": "https://github.com/skillupco/airflow-valohai-plugin", "anchor_text": "airflow-valohai-plugin"}, {"url": "https://github.com/skillupco/airflow-valohai-plugin/blob/master/examples/dags/example_valohai_dag_pass_outputs.py", "anchor_text": "source"}, {"url": "https://docs.valohai.com/valohai-yaml/index.html", "anchor_text": "valohai.yaml"}, {"url": "https://github.com/valohai/tensorflow-example", "anchor_text": "source code"}, {"url": "https://github.com/skillupco/airflow-valohai-plugin", "anchor_text": "ValohaiSubmitExecutionOperator"}, {"url": "https://valohai.com", "anchor_text": "Valohai"}, {"url": "https://airflow.apache.org/", "anchor_text": "Apache Airflow documentation"}, {"url": "https://docs.valohai.com/", "anchor_text": "Valohai documentation"}, {"url": "https://airflow.apache.org/kubernetes.html#kubernetes-operator", "anchor_text": "KubernetesPodOperator documentation"}, {"url": "https://github.com/skillupco/airflow-valohai-plugin", "anchor_text": "ValohaiSubmitExecutionOperator documentation"}, {"url": "https://medium.com/tag/airflow?source=post_page-----f2446257e495---------------airflow-----------------", "anchor_text": "Airflow"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----f2446257e495---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/data-engineering?source=post_page-----f2446257e495---------------data_engineering-----------------", "anchor_text": "Data Engineering"}, {"url": "https://medium.com/tag/python?source=post_page-----f2446257e495---------------python-----------------", "anchor_text": "Python"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Ff2446257e495&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fscaling-apache-airflow-for-machine-learning-workflows-f2446257e495&user=Ari+Bajo&userId=5ad5ce9cd2&source=-----f2446257e495---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Ff2446257e495&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fscaling-apache-airflow-for-machine-learning-workflows-f2446257e495&user=Ari+Bajo&userId=5ad5ce9cd2&source=-----f2446257e495---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ff2446257e495&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fscaling-apache-airflow-for-machine-learning-workflows-f2446257e495&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----f2446257e495--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Ff2446257e495&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fscaling-apache-airflow-for-machine-learning-workflows-f2446257e495&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----f2446257e495---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----f2446257e495--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----f2446257e495--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----f2446257e495--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----f2446257e495--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----f2446257e495--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----f2446257e495--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----f2446257e495--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----f2446257e495--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@arimbr?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@arimbr?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Ari Bajo"}, {"url": "https://medium.com/@arimbr/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "310 Followers"}, {"url": "http://guriosity.com", "anchor_text": "guriosity.com"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F5ad5ce9cd2&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fscaling-apache-airflow-for-machine-learning-workflows-f2446257e495&user=Ari+Bajo&userId=5ad5ce9cd2&source=post_page-5ad5ce9cd2--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fda3f7181915e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fscaling-apache-airflow-for-machine-learning-workflows-f2446257e495&newsletterV3=5ad5ce9cd2&newsletterV3Id=da3f7181915e&user=Ari+Bajo&userId=5ad5ce9cd2&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}