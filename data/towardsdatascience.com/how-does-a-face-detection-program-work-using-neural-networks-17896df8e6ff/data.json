{"url": "https://towardsdatascience.com/how-does-a-face-detection-program-work-using-neural-networks-17896df8e6ff", "time": 1682993543.024672, "path": "towardsdatascience.com/how-does-a-face-detection-program-work-using-neural-networks-17896df8e6ff/", "webpage": {"metadata": {"title": "How Does A Face Detection Program Work? (Using Neural Networks) | by Chi-Feng Wang | Towards Data Science", "h1": "How Does A Face Detection Program Work? (Using Neural Networks)", "description": "In my last two posts (click here to read about implementing the model and here to read about the network structure), I've been playing around with a Multi-task Cascaded Convolutional Network (MTCNN)\u2026"}, "outgoing_paragraph_urls": [{"url": "http://arxiv.org/abs/1604.02878", "anchor_text": "This model", "paragraph_index": 0}], "all_paragraphs": ["Recently, I\u2019ve been playing around with a Multi-task Cascaded Convolutional Network (MTCNN) model for face detection. This model has three convolutional networks (P-Net, R-Net, and O-Net) and is able to outperform many face-detection benchmarks while retaining real-time performance. But how, exactly, does it work?", "Note: If you want a concrete example of how to process a face detection neural network, I\u2019ve attached the download links of the MTCNN model below. After downloading, open ./mtcnn/mtcnn.py and scroll to the detect_faces function. This is the function that you would call when implementing this model, so going through this function would give you a sense of how the program calculates and narrows down the coordinates of the bounding box and facial features. However, I won\u2019t decipher the code line-by-line: not only would it make this article unnecessarily long, it would also be counterproductive for most readers as a lot of the parameters in the code are suited for this specific model only.", "Obviously, the first thing to do would be to pass in an image to the program. In this model, we want to create an image pyramid, in order to detect faces of all different sizes. In other words, we want to create different copies of the same image in different sizes to search for different sized faces within the image.", "For each scaled copy, we have a 12 x 12 stage 1 kernel that will go through every part of the image, scanning for faces. It starts in the top left corner, a section of the image from (0,0) to (12,12). This portion of the image is passed to P-Net, which returns the coordinates of a bounding box if it notices a face. Then, it would repeat that process with sections (0+2a,0+2b) to (12+2a, 12+2b), shifting the 12 x 12 kernel 2 pixels right or down at a time. The shift of 2 pixels is known as the stride, or how many pixels the kernel moves by every time.", "Having a stride of 2 helps reduce computation complexity without significantly sacrificing accuracy. Since faces in most images are significantly larger than two pixels, it\u2019s highly improbable that the kernel will miss a face merely because it shifted 2 pixels. At the same time, your computer (or whatever machine is running this code) will have a quarter of the amount of operations to compute, making the program run faster and with less memory.", "The only downside is that we have to recalculate all indexes related to the stride. For example, if the kernel detected a face after moving one step to the right, the output index would tell us the top left corner of that kernel is at (1,0). However, because the stride is 2, we have to multiply the index by 2 to get the correct coordinate: (2,0).", "Each kernel would be smaller relative to a large image, so it would be able to find smaller faces in the larger-scaled image. Similarly, the kernel would be bigger relative to a smaller sized image, so it would be able to find bigger faces in the smaller-scaled image.", "After passing in the image, we need to create multiple scaled copies of the image and pass it into the first neural net \u2014 P-Net \u2014 and gather its output.", "The weights and biases of P-Net have been trained so that it outputs a relatively accurate bounding box for every 12 x 12 kernel. However, the network is more confident about some boxes compared to others. Thus, we need to parse the P-Net output to get a list of confidence levels for each bounding box, and delete the boxes with lower confidence (i.e. the boxes that the network isn\u2019t quite sure contains a face)", "After we\u2019ve picked out the boxes with higher confidence, we will have to standardize the coordinate system, converting all the coordinate systems to that of the actual, \u201cun-scaled\u201d image. Since most kernels are in a scaled-down image, their coordinates will be based on the smaller image.", "However, there are still a lot of bounding boxes left, and a lot of them overlap. Non-Maximum Suppression, or NMS, is a method that reduces the number of bounding boxes.", "In this particular program, NMS is conducted by first sorting the bounding boxes (and their respective 12 x 12 kernels) by their confidence, or score. In some other models, NMS takes the largest bounding box instead of the one the network is most confident in.", "Subsequently, we calculate the area of each of the kernels, as well as the overlapping area between each kernel and the kernel with the highest score. The kernels that overlap a lot with the high-scoring kernel get deleted. Finally, NMS returns a list of the \u201csurviving\u201d bounding boxes.", "We conduct NMS once for every scaled image, then one more time with all the surviving kernels from each scale. This gets rid of redundant bounding boxes, allowing us to narrow our search down to one accurate box per face.", "Why can\u2019t we just choose the box with the highest confidence and delete everything else? There is only one face in the image above. However, there might be more than one face in other images. If so, we would end up deleting all the bounding boxes for the other faces.", "Afterward, we convert the bounding box coordinates to coordinates of the actual image. Right now, the coordinates of each bounding box is a value between 0 and 1, with (0,0) as the top left corner of the 12 x 12 kernel and (1,1) as the bottom right corner (see table above). By multiplying the coordinates by the actual image width and height, we can convert the bounding box coordinates to the standard, real-sized image coordinates.", "Since the bounding boxes may not be square, we then reshape the bounding boxes to a square by elongating the shorter sides (if the width is smaller than the height, we expand it sideways; if the height is smaller than the width, we expand it vertically).", "Finally, we save the coordinates of the bounding boxes and pass it on to stage 2.", "Sometimes, an image may contain only a part of a face peeking in from the side of the frame. In that case, the network may return a bounding box that is partly out of the frame, like Paul McCartney\u2019s face in the photo below:", "For every bounding box, we create an array of the same size, and copy the pixel values (the image in the bounding box) to the new array. If the bounding box is out of bounds, we only copy the portion of the image in the bounding box to the new array and fill in everything else with a 0. In the image above, the new array for McCartney\u2019s face would have pixel values in the left side of the box, and several columns of 0s near the right edge. This process of filling arrays with 0s is called padding.", "After we pad the bounding box arrays, we resize them to 24 x 24 pixels, and normalize them to values between -1 and 1. Currently, the pixel values are between 0 to 255 (RGB values). By subtracting each pixel value by half of 255 (127.5) and dividing it by 127.5, we can keep their values between -1 and 1.", "Now that we have numerous 24 x 24 image arrays(as many as the number of bounding boxes that survived Stage 1, since each of those bounding boxes has been resized and normalized into these kernels), we can feed them into R-Net and gather its output.", "R-Net\u2019s output is similar to that of P-Net: It includes the coordinates of the new, more accurate bounding boxes, as well as the confidence level of each of these bounding boxes.", "Once again, we get rid of the boxes with lower confidence, and perform NMS on every box to further eliminate redundant boxes. Since the coordinates of these new bounding boxes are based on the P-Net bounding boxes, we need to convert them to the standard coordinates.", "After standardizing the coordinates, we reshape the bounding boxes to a square to be passed on to O-Net.", "Before we can pass in the bounding boxes from R-Net, we have to first pad any boxes that are out-of-bounds. Then, after we resize the boxes to 48 x 48 pixels, we can pass in the bounding boxes into O-Net.", "The outputs of O-Net are slightly different from that of P-Net and R-Net. O-Net provides 3 outputs: the coordinates of the bounding box (out[0]), the coordinates of the 5 facial landmarks (out[1]), and the confidence level of each box (out[2]).", "Once again, we get rid of the boxes with lower confidence levels, and standardize both the bounding box coordinates and the facial landmark coordinates. Finally, we run them through the last NMS. At this point, there should only be one bounding box for every face in the image.", "The very last step is to package all the information into a dictionary with three keys: \u2018box\u2019, \u2018confidence\u2019, and \u2018keypoints\u2019. \u2018box\u2019 contains the coordinates of the bounding box, \u2018confidence\u2019 contains the confidence level of the network for each box, and \u2018keypoints\u2019 contains the coordinates of each facial landmark (eyes, nose, and endpoints of the mouth).", "When we want to implement this model in our own code, all we have to do is call detect_faces and we\u2019d be given this dictionary with all the coordinates we need to draw the bounding boxes and mark the facial features.", "This model is rather different from the ones I\u2019ve encountered before. It isn\u2019t just a plain old neural network: it utilizes some interesting techniques to achieve high accuracy with less run-time.", "Low computation complexity results in a fast run-time. To achieve real-time performance, it uses a stride of 2, reducing the number of operations to a quarter of the original. It also doesn\u2019t start finding facial landmarks until the last network (O-Net), after the bounding box coordinates have been calibrated, which narrows down the coordinates of facial features even before it begins its calculations. This makes the program a lot faster as it only has to find facial landmarks in the few boxes that pass through O-Net.", "High accuracy is achieved with a deep neural network. Having 3 networks \u2014 each with multiple layers \u2014 allows for higher precision, as each network can fine-tune the results of the previous one. In addition, this model employs an image pyramid to find faces both large and small. Even though this may produce an overwhelming amount of data, NMS, as well as R-Net and O-Net, all help reject a large number of false bounding boxes.", "Looking at this model\u2019s high performance, I can\u2019t help but wonder what else we can utilize this model for. Would it be able to recognize certain animals? Certain cars? Can it be adjusted to do facial recognition as well as facial detection? This model \u2014 and its applications \u2014 gave us countless applications for future use.", "Download the MTCNN paper and resources here:", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Student at UC Berkeley; Machine Learning Enthusiast"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F17896df8e6ff&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-a-face-detection-program-work-using-neural-networks-17896df8e6ff&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-a-face-detection-program-work-using-neural-networks-17896df8e6ff&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-a-face-detection-program-work-using-neural-networks-17896df8e6ff&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-a-face-detection-program-work-using-neural-networks-17896df8e6ff&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----17896df8e6ff--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----17896df8e6ff--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@reina.wang?source=post_page-----17896df8e6ff--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@reina.wang?source=post_page-----17896df8e6ff--------------------------------", "anchor_text": "Chi-Feng Wang"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F9ddaaec52a09&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-a-face-detection-program-work-using-neural-networks-17896df8e6ff&user=Chi-Feng+Wang&userId=9ddaaec52a09&source=post_page-9ddaaec52a09----17896df8e6ff---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F17896df8e6ff&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-a-face-detection-program-work-using-neural-networks-17896df8e6ff&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F17896df8e6ff&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-a-face-detection-program-work-using-neural-networks-17896df8e6ff&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://pixabay.com/en/flat-recognition-facial-face-woman-3252983/", "anchor_text": "Source"}, {"url": "http://arxiv.org/abs/1604.02878", "anchor_text": "This model"}, {"url": "https://arxiv.org/ftp/arxiv/papers/1604/1604.02878.pdf", "anchor_text": "Source"}, {"url": "https://arxiv.org/ftp/arxiv/papers/1604/1604.02878.pdf", "anchor_text": "Source"}, {"url": "https://www.flickr.com/photos/beatlesmaniac11/4191790770", "anchor_text": "Source"}, {"url": "https://medium.com/@reina.wang/mtcnn-face-detection-cdcb20448ce0", "anchor_text": "here"}, {"url": "https://medium.com/@reina.wang/face-detection-neural-network-structure-257b8f6f85d1", "anchor_text": "here"}, {"url": "https://github.com/ipazc/mtcnn", "anchor_text": "https://github.com/ipazc/mtcnn"}, {"url": "http://arxiv.org/abs/1604.02878", "anchor_text": "http://arxiv.org/abs/1604.02878"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----17896df8e6ff---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/tag/neural-networks?source=post_page-----17896df8e6ff---------------neural_networks-----------------", "anchor_text": "Neural Networks"}, {"url": "https://medium.com/tag/face-detection?source=post_page-----17896df8e6ff---------------face_detection-----------------", "anchor_text": "Face Detection"}, {"url": "https://medium.com/tag/image-pyramid?source=post_page-----17896df8e6ff---------------image_pyramid-----------------", "anchor_text": "Image Pyramid"}, {"url": "https://medium.com/tag/convolutional-network?source=post_page-----17896df8e6ff---------------convolutional_network-----------------", "anchor_text": "Convolutional Network"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F17896df8e6ff&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-a-face-detection-program-work-using-neural-networks-17896df8e6ff&user=Chi-Feng+Wang&userId=9ddaaec52a09&source=-----17896df8e6ff---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F17896df8e6ff&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-a-face-detection-program-work-using-neural-networks-17896df8e6ff&user=Chi-Feng+Wang&userId=9ddaaec52a09&source=-----17896df8e6ff---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F17896df8e6ff&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-a-face-detection-program-work-using-neural-networks-17896df8e6ff&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----17896df8e6ff--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F17896df8e6ff&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-a-face-detection-program-work-using-neural-networks-17896df8e6ff&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----17896df8e6ff---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----17896df8e6ff--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----17896df8e6ff--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----17896df8e6ff--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----17896df8e6ff--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----17896df8e6ff--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----17896df8e6ff--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----17896df8e6ff--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----17896df8e6ff--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@reina.wang?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@reina.wang?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Chi-Feng Wang"}, {"url": "https://medium.com/@reina.wang/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "1.5K Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F9ddaaec52a09&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-a-face-detection-program-work-using-neural-networks-17896df8e6ff&user=Chi-Feng+Wang&userId=9ddaaec52a09&source=post_page-9ddaaec52a09--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F827df2c647b&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-a-face-detection-program-work-using-neural-networks-17896df8e6ff&newsletterV3=9ddaaec52a09&newsletterV3Id=827df2c647b&user=Chi-Feng+Wang&userId=9ddaaec52a09&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}