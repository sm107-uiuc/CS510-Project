{"url": "https://towardsdatascience.com/use-apple-new-ml-compute-framework-to-accelerate-ml-training-and-inferencing-on-ios-and-macos-8b7b84f63031", "time": 1683011076.948653, "path": "towardsdatascience.com/use-apple-new-ml-compute-framework-to-accelerate-ml-training-and-inferencing-on-ios-and-macos-8b7b84f63031/", "webpage": {"metadata": {"title": "Use Apple new ML Compute framework to accelerate ML training and inferencing on iOS and macOS | by Jacopo Mangiavacchi | Towards Data Science", "h1": "Use Apple new ML Compute framework to accelerate ML training and inferencing on iOS and macOS", "description": "With the recent new wave of operating system versions (BigSur, iOS 14 etc.), announced at recent WWDC, Apple quite silently introduced a new ML framework to accelerate training of neural networks\u2026"}, "outgoing_paragraph_urls": [], "all_paragraphs": ["With the recent new wave of operating system versions (BigSur, iOS 14 etc.), announced at recent WWDC, Apple quite silently introduced a new ML framework to accelerate training of neural networks across the CPU or one or more available GPUs.", "ML Compute is not properly a new ML framework but new API\u2019s that utilizes the high performance BNNS primitives made available by the Accelerate framework for the CPU and Metal Performance Shaders for the GPU.", "After looking at the documentation and starting to use it on an iOS/macOS application, I understood that this is not really a simple, high level framework but something probably targeting the acceleration of existing third-party ML library like the ONNX Runtime or the TensorFlow Lite framework on the Apple platform.", "Even if Apple documentation is pretty good, I would say these APIs are not really developer friendly and swifty for doing generic ML on iOS/macOS. The tensor API, for example, is really rough and it requires dealing with unmanaged pointers in Swift. Basically, you are responsible for managing by yourself the ownership and lifetime of memory allocation of objects like tensors, nodes and graphs that you pass to these API.", "More generally, ML Compute does not provide by definition ML APIs like Keras, PyTorch or Swift for TensorFlow to simplify building and training ML models but low level API to build computing graph and manage low level training loop.", "For general ML coding on iOS/macOS, I would suggest continuing to use Core ML with tools like CoreMLTools to import model from other framework (TensorFlow, PyTorch etc.) or eventually give a try to the SwiftCoreMLTools library I developed if you want to completely build and/or train model locally on devices avoiding any Python code.", "Anyway my personal opinion, after playing with that, is that ML Compute could become potentially really powerful even for regular Swift ML developer adding for example on top of that a Swift Function Builder (DSL) high level API, like the one I developed for SwiftCoreMLTools, and a high level Tensor Swift API, hopefully, integrated with Swift Numerics multi dimensional array.", "To quickly test the capability of these APIs, I decided to develop and illustrate a PoC App to train and inference with ML Compute on both iOS and macOS a simple shallow model for the MNIST dataset.", "Before entering the details of this MNIST ML Compute App, please let me share a quick and dirty Swift Playground I\u2019ve initially used to get familiar with the ML Compute tensor and graph API.", "As you can see here I\u2019m not, yet, building a real ML model but I\u2019m using a ML Compute graph to simply run some basic arithmetic operations on tensors.", "I thought it could be very helpful to simply get familiar with this first.", "Now that we get familiarized with the basic of the ML Compute API for building tensors and graph lets you start to see how to build a first sample shallow model for training the famous MNIST dataset.", "We will first import, efficiently, CSV files containing the MNIST training and test dataset and see later how to transform that in ML Compute tensors.", "As you can see the code below read in parallel, the training and dataset CSV file, apply some normalization, and convert images and labels in Swift Float arrays.", "A quick note here about concurrency and Grand Central Dispatch API (GCD). In order to quickly and concurrently processing a batch of data in parallel, I used here the convenient DispatchQueue.concurrentPerform API to easily manage parallel For-Loop in Swift.", "Unfortunately, reading the CSV file buffers into String and using split() method to process the rows is not really performant, so I had to develop an alternative method to scan CSV file line by line using the more efficient C runtime getline() function.", "Other functions below will become useful later when dealing with label and loss function cost in order to encode and decode the label using one hot encoding technique as required by the loss function (ML Compute does not provide a sparse categorical cross entropy).", "Now that we have the training and test images and labels loaded on Swift Float array, we can finally start building the ML Compute graph that we will use respectively to train and test the model.", "The ML model we\u2019re using in particular in this sample application is a very minimal shallow neural network with one dense layer with relu activation followed by a final dense layer with the softmax activation for the ten digit classes of the MNIST dataset.", "As you can see a ML Compute graph is built just adding node of layers and activation functions, passing to all these layers and activation functions the classic parameters like the shape of input/output tensors, weights/bias initial matrix etc.", "It is important to pay attention here to the shape of all the tensors used for weights, biases as well as input and output of the model. In particular, you can see that when building the graph we have to choose the batch size we\u2019re gonna later use for training and inferencing, creating all these tensor shape according to this batch size.", "Now that we have a ML Compute graph we can build a MLCTrainingGraph passing the compute graph and the training parameters.", "In this case we will specify softmax cross entropy as a loss function (ML Compute do not provide a sparse categorical cross entropy) and ADAM as optimizer with standard default parameters.", "In order to train the MLCTrainingGraph we will need to create a full training loop iterating each epoch for all batch that we have, simply dividing the total number of samples we have in the training dataset by the size of batches we used above for creating tensors and graph.", "In particular, in the batch loop, we will get a Swift unsafe buffer of the slice of image and label data from the Swift Float array and we will construct a MLCTensorData through the unsafe pointer of this slice of data and finally pass this tensor data to the training graph execute method to finally train the model with the batch data.", "Once the model is trained for sufficient epochs we will validate the model building a similar MLCInferenceGraph and feeding, one batch at a time, all the test data.", "In the inference graph execute closure callback, we will calculate finally the accuracy of the model simply looking at how many time the prediction corresponds to the test label.", "As always, the code for this story is completely open sourced and available on my GitHub personal account:", "I want to finally thank here the Apple ML Compute team for their very quick and fully-detailed help in providing me suggestions and insights on the new ML Compute framework.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Microsoft Principal Data Scientist \u2014 Google Machine Learning Developer Expert (ML GDE) \u2014 Former \uf8ff + IBM Senior Architect and Engineer"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F8b7b84f63031&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fuse-apple-new-ml-compute-framework-to-accelerate-ml-training-and-inferencing-on-ios-and-macos-8b7b84f63031&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fuse-apple-new-ml-compute-framework-to-accelerate-ml-training-and-inferencing-on-ios-and-macos-8b7b84f63031&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fuse-apple-new-ml-compute-framework-to-accelerate-ml-training-and-inferencing-on-ios-and-macos-8b7b84f63031&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fuse-apple-new-ml-compute-framework-to-accelerate-ml-training-and-inferencing-on-ios-and-macos-8b7b84f63031&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----8b7b84f63031--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----8b7b84f63031--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@JMangia?source=post_page-----8b7b84f63031--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@JMangia?source=post_page-----8b7b84f63031--------------------------------", "anchor_text": "Jacopo Mangiavacchi"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F32d426fb64f9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fuse-apple-new-ml-compute-framework-to-accelerate-ml-training-and-inferencing-on-ios-and-macos-8b7b84f63031&user=Jacopo+Mangiavacchi&userId=32d426fb64f9&source=post_page-32d426fb64f9----8b7b84f63031---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F8b7b84f63031&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fuse-apple-new-ml-compute-framework-to-accelerate-ml-training-and-inferencing-on-ios-and-macos-8b7b84f63031&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F8b7b84f63031&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fuse-apple-new-ml-compute-framework-to-accelerate-ml-training-and-inferencing-on-ios-and-macos-8b7b84f63031&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://github.com/JacopoMangiavacchi/SwiftCoreMLTools", "anchor_text": "JacopoMangiavacchi/SwiftCoreMLToolsA Swift Library for creating CoreML models in Swift. Work in progress This library expose a (function builder based)\u2026github.com"}, {"url": "https://github.com/JacopoMangiavacchi/MNIST-ComputeML", "anchor_text": "JacopoMangiavacchi/MNIST-ComputeMLContribute to JacopoMangiavacchi/MNIST-ComputeML development by creating an account on GitHub.github.com"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----8b7b84f63031---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/swift?source=post_page-----8b7b84f63031---------------swift-----------------", "anchor_text": "Swift"}, {"url": "https://medium.com/tag/coreml?source=post_page-----8b7b84f63031---------------coreml-----------------", "anchor_text": "Coreml"}, {"url": "https://medium.com/tag/mlcompute?source=post_page-----8b7b84f63031---------------mlcompute-----------------", "anchor_text": "Mlcompute"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F8b7b84f63031&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fuse-apple-new-ml-compute-framework-to-accelerate-ml-training-and-inferencing-on-ios-and-macos-8b7b84f63031&user=Jacopo+Mangiavacchi&userId=32d426fb64f9&source=-----8b7b84f63031---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F8b7b84f63031&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fuse-apple-new-ml-compute-framework-to-accelerate-ml-training-and-inferencing-on-ios-and-macos-8b7b84f63031&user=Jacopo+Mangiavacchi&userId=32d426fb64f9&source=-----8b7b84f63031---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F8b7b84f63031&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fuse-apple-new-ml-compute-framework-to-accelerate-ml-training-and-inferencing-on-ios-and-macos-8b7b84f63031&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----8b7b84f63031--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F8b7b84f63031&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fuse-apple-new-ml-compute-framework-to-accelerate-ml-training-and-inferencing-on-ios-and-macos-8b7b84f63031&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----8b7b84f63031---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----8b7b84f63031--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----8b7b84f63031--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----8b7b84f63031--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----8b7b84f63031--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----8b7b84f63031--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----8b7b84f63031--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----8b7b84f63031--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----8b7b84f63031--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@JMangia?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@JMangia?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Jacopo Mangiavacchi"}, {"url": "https://medium.com/@JMangia/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "473 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F32d426fb64f9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fuse-apple-new-ml-compute-framework-to-accelerate-ml-training-and-inferencing-on-ios-and-macos-8b7b84f63031&user=Jacopo+Mangiavacchi&userId=32d426fb64f9&source=post_page-32d426fb64f9--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F1b1eb3a9b2b4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fuse-apple-new-ml-compute-framework-to-accelerate-ml-training-and-inferencing-on-ios-and-macos-8b7b84f63031&newsletterV3=32d426fb64f9&newsletterV3Id=1b1eb3a9b2b4&user=Jacopo+Mangiavacchi&userId=32d426fb64f9&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}