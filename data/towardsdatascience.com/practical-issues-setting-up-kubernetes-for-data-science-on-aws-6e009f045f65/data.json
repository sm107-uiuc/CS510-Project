{"url": "https://towardsdatascience.com/practical-issues-setting-up-kubernetes-for-data-science-on-aws-6e009f045f65", "time": 1683011206.869237, "path": "towardsdatascience.com/practical-issues-setting-up-kubernetes-for-data-science-on-aws-6e009f045f65/", "webpage": {"metadata": {"title": "Practical Issues Setting up Kubernetes for Data Science on AWS | by Hugo Shi | Towards Data Science", "h1": "Practical Issues Setting up Kubernetes for Data Science on AWS", "description": "Disclaimer: I\u2019m the CTO of Saturn Cloud \u2014 we build an enterprise data science platform focusing on huge performance gains leveraging Dask and RAPIDS. Love it or hate it, Jupyter is the most common\u2026"}, "outgoing_paragraph_urls": [{"url": "https://www.saturncloud.io/s/", "anchor_text": "Saturn Cloud", "paragraph_index": 0}, {"url": "https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html#AvailableIpPerENI", "anchor_text": "IP addresses allocated per instance", "paragraph_index": 3}, {"url": "https://binderhub.readthedocs.io/en/latest/", "anchor_text": "binderhub", "paragraph_index": 13}, {"url": "https://www.saturncloud.io/s/pricing/", "anchor_text": "Our pricing", "paragraph_index": 22}], "all_paragraphs": ["Disclaimer: I\u2019m the CTO of Saturn Cloud \u2014 we build an enterprise data science platform focusing on huge performance gains leveraging Dask and RAPIDS.", "Love it or hate it, Jupyter is the most common data science tool IDE today. If you are provisioning a Kubernetes cluster for data scientists, they will definitely want to run Jupyter notebooks. And if they are running Jupyter notebooks they are going to want persistent storage \u2014 working in an IDE where your filesystem is erased whenever you shut down the machine is a very bad experience!. This is very different than conventional Kubernetes workloads which are often stateless.", "This also means that if you are supporting multiple AZs, you need to make sure that Jupyter instances are always started in the same AZ, since your persistent storage (EBS) cannot be automatically migrated to other regions. One option is to use EFS instead of EBS. We do not do that at Saturn because most data scientists want to store data on their drives as well, and once you start getting into massively parallel cluster compute, EFS is not reliable. At Saturn, we route all Jupyter instances to the same AZ, and setup ASGs(auto scaling groups) that are specific to this AZ. You trade off high availability, but you never really had that anyways, unless you are backing up snapshots to multiple AZs and are prepared to restore an EBS snapshot to another AZ if your primary goes down.", "The standard Kubernetes setup keeps workers in a private subnet. Most people end up creating private subnets with CIDR blocks that allocate roughly 256 IP addresses. This seems reasonable because you probably aren\u2019t going to need more than 256 machines right? WRONG! With EKS, the instance type determines the defaults (and maximum) number of IP addresses allocated per instance. By default, some of the larger instances (r5.16xlarge with 512 GB of ram for example) consumes 50 IP addresses. This means that a team of 5 data scientists, each using 1 r5.16xlarge, can easily exhaust the number of IP addresses in your private subnet. We recommend allocating really big subnets (our default configuration has 8000 available in the CIDR block)", "Many data science tools don\u2019t provide much built in security. This is completely reasonable for an OSS project, but a huge problem for enterprise deployments. For example, by default Dask clusters don\u2019t protect the scheduler, which means that anyone that has access to the cluster, can submit jobs to any Dask cluster(Dask has other ways to mitigate this, however for us dealing with this at the network level is the most flexible). Even if you are securing access into the Kubernetes cluster, it\u2019s a good idea to protect data science tools by using Kubernetes networking policies to control to lock down resources.", "The current standard for secure networking in EKS is Calico. The standard Calico setup will horizontally autoscale the metadata store based on the number of nodes \u2014 and is overly aggressive for most data science workloads because we\u2019re typically running 1 user pod per machine (more on this later). This horizontal autoscaling behavior causes instability in Calico which results in nodes failing to communicate. We solve this by controlling the number of replicas in the metadata store manually \u2014 this has been very stable for our data science workloads.", "Data science work loads are very different from normal Kubernetes workloads because they are almost always memory bound. EC2 pricing is mostly driven by memory, you don\u2019t get very much value out of multi-tenancy with data science workloads. Data science workloads are often long running (many data scientists will provision a jupyter instance, and leave it up for an entire month). You are much better off allocating one entire node per data science pod. If you do not do this, it\u2019s very likely that you\u2019ll end up scheduling a pod that should only cost $30 a month on a node that costs $3000 a month.At Saturn we create many ASGs (4GB/16GB/64GB/128GB/256GB/512GB) to waste as little RAM as possible.", "Data science workloads are also very spikey. One day, a data scientist might need to edit code on a 4GB instance which costs $30/month. The next day, they might want a 512 GB jupyter instance ($3000/mo) which connects to a 10 node Dask cluster (5TB /ram total). Being able to autoscale Kubernetes is very important.", "The Kubernetes cluster-autoscaler is a sophisticated genius and can figure out the optimal node to spin up in order to accomodate a new pod, as well as which pods should be shuffled around in order to free up nodes that can be spun down. However if you\u2019ve bought into the one-pod-per-instance configuration, this sophistication a ton of added complexity which almost always causes problems.", "The Kubernetes cluster autoscaler is configured with expanders which determine how it allocates new EC2 instances. The standard for cost concious users is least-waste However the least-waste expander computes waste in percentage terms. This means that if you create a pod, and you forget to specify any CPU or RAM requests (you request 0), the cluster autoscaler will determine that every node type results in 100% waste. When an expander decides it has a tie, everything is routed to the random expander. Congratulations! your $30/month pod now costs $3000/month.", "Kubernetes pods are scheduled based on what nodes currently have capacity before falling back on the cluster autoscaler. Once a pod vacates a node, it takes 10 minutes before the node is torn down. For active clusters, I\u2019ve often seen small pods (4GB) which accidentally get scheduled on large nodes (512 GB). The data scientists thinks they\u2019re consuming 4GB of ram, and so they\u2019re happy leaving this pod up forever. Congratulations! your $30/month pod now costs $3000/month.", "Data science workloads are almost always memory bound, and should monopolize the entire instance. Data science workloads are also very spikey, and so autoscaling in Kubernetes is very important. at Saturn, we solve this problem by explicitly tagging the node selector of every pod, so that it can only be scheduled on the correct ASG.", "This section assumes you are configuring EKS with terraform.", "Should users be able to build docker images? This might be necessary if you want to do things like run binderhub. At Saturn, we allow certain pods to build docker images because we want to enable our docker image building service from standard data science configuration files. If so you\u2019ll want to configure your ASGs with", "The docker bridge does not work on GPU nodes, so you should set", "terraform-aws-eks defaults ASGs to use the CPU AMI. If you are provisioning GPU nodes, you will have to find the GPU ami ID for your region, and pass that in to terraform. Here is the Python code we use to do this", "If you configure the wrong AMI, your nodes will come up like normal, but your expensive GPUs will not be available inside Kubernetes pods.", "You need to tag ASGs to indicate how many GPUs are available, or else the autoscaler won\u2019t know that your deep learning pod which needs 4 V100s can be scheduled on this box.", "If you\u2019ve read this far you must be thinking about setting up your own Kubernetes cluster for your data science team. I just have one question for you.", "Is this really the best use of your time?", "Your company can probably jerry rig a Kubernetes deployment, and set up a bunch of ASGs, and deploy jupyterhub, and then figure out how to deploy dask cluster, and then make sure that the dependencies you need are built into docker images that work well for both jupyter, and dask, and then make sure you configure EBS volumes properly so that data scientists don\u2019t lose their work, and make sure you configure Calico, and nginx-ingress, and the load balancer so that traffic into your applications is secure. Are you planning to deploy dashboards? or models? Is there any sensitive information there? Do you need to provide access control and security around them? Don\u2019t forget to set up jupyter-server-proxy, so that data scientists working in Jupyter/Lab need to use the dask dashboard and experiment with bokeh/plotly/voila as well right? Did you remember to bind one dask worker per GPU? Are you configuring RMM, and do you have proper GPU to Host memory spillover configured?", "Is this really the best use of your time?", "Our pricing is pay as you go, billed through the AWS marketplace. I\u2019d recommend renting our software rather than building your own.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F6e009f045f65&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-issues-setting-up-kubernetes-for-data-science-on-aws-6e009f045f65&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-issues-setting-up-kubernetes-for-data-science-on-aws-6e009f045f65&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-issues-setting-up-kubernetes-for-data-science-on-aws-6e009f045f65&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-issues-setting-up-kubernetes-for-data-science-on-aws-6e009f045f65&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----6e009f045f65--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----6e009f045f65--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://hhuuggoo.medium.com/?source=post_page-----6e009f045f65--------------------------------", "anchor_text": ""}, {"url": "https://hhuuggoo.medium.com/?source=post_page-----6e009f045f65--------------------------------", "anchor_text": "Hugo Shi"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F58d7b003c928&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-issues-setting-up-kubernetes-for-data-science-on-aws-6e009f045f65&user=Hugo+Shi&userId=58d7b003c928&source=post_page-58d7b003c928----6e009f045f65---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F6e009f045f65&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-issues-setting-up-kubernetes-for-data-science-on-aws-6e009f045f65&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F6e009f045f65&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-issues-setting-up-kubernetes-for-data-science-on-aws-6e009f045f65&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@amyames?utm_source=medium&utm_medium=referral", "anchor_text": "Amy Elting"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://www.saturncloud.io/s/", "anchor_text": "Saturn Cloud"}, {"url": "https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html#AvailableIpPerENI", "anchor_text": "IP addresses allocated per instance"}, {"url": "https://binderhub.readthedocs.io/en/latest/", "anchor_text": "binderhub"}, {"url": "https://www.saturncloud.io/s/pricing/", "anchor_text": "Our pricing"}, {"url": "https://medium.com/tag/kubernetes?source=post_page-----6e009f045f65---------------kubernetes-----------------", "anchor_text": "Kubernetes"}, {"url": "https://medium.com/tag/aws?source=post_page-----6e009f045f65---------------aws-----------------", "anchor_text": "AWS"}, {"url": "https://medium.com/tag/software-engineering?source=post_page-----6e009f045f65---------------software_engineering-----------------", "anchor_text": "Software Engineering"}, {"url": "https://medium.com/tag/data-science?source=post_page-----6e009f045f65---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----6e009f045f65---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F6e009f045f65&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-issues-setting-up-kubernetes-for-data-science-on-aws-6e009f045f65&user=Hugo+Shi&userId=58d7b003c928&source=-----6e009f045f65---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F6e009f045f65&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-issues-setting-up-kubernetes-for-data-science-on-aws-6e009f045f65&user=Hugo+Shi&userId=58d7b003c928&source=-----6e009f045f65---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F6e009f045f65&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-issues-setting-up-kubernetes-for-data-science-on-aws-6e009f045f65&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----6e009f045f65--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F6e009f045f65&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-issues-setting-up-kubernetes-for-data-science-on-aws-6e009f045f65&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----6e009f045f65---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----6e009f045f65--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----6e009f045f65--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----6e009f045f65--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----6e009f045f65--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----6e009f045f65--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----6e009f045f65--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----6e009f045f65--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----6e009f045f65--------------------------------", "anchor_text": ""}, {"url": "https://hhuuggoo.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://hhuuggoo.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Hugo Shi"}, {"url": "https://hhuuggoo.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "54 Followers"}, {"url": "http://SaturnCloud.io", "anchor_text": "SaturnCloud.io"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F58d7b003c928&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-issues-setting-up-kubernetes-for-data-science-on-aws-6e009f045f65&user=Hugo+Shi&userId=58d7b003c928&source=post_page-58d7b003c928--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fc661b05647be&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-issues-setting-up-kubernetes-for-data-science-on-aws-6e009f045f65&newsletterV3=58d7b003c928&newsletterV3Id=c661b05647be&user=Hugo+Shi&userId=58d7b003c928&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}