{"url": "https://towardsdatascience.com/5-bigquery-sql-performance-tips-for-modern-data-scientists-f880b79cfa71", "time": 1683017639.5508668, "path": "towardsdatascience.com/5-bigquery-sql-performance-tips-for-modern-data-scientists-f880b79cfa71/", "webpage": {"metadata": {"title": "BigQuery SQL performance tips | Towards Data Science", "h1": "5 BigQuery SQL performance tips for modern data scientists", "description": "5 Bigquery SQL performance tips for modern data scientists. SQL tuning tips and advice to help reduce BigQuery costs."}, "outgoing_paragraph_urls": [{"url": "https://www.ancoris.com/solutions/data_analytics_ai", "anchor_text": "Ancoris Data, Analytics & AI", "paragraph_index": 60}], "all_paragraphs": ["Google BigQuery, like other modern hyper-scale data platforms, has a different architecture to what many data professionals and data scientists are used to; it stores its data in columns instead of rows (referred to as a column-store), and processes SQL queries in a fully distributed architecture.", "It is these unique properties that enable the platform to achieve such high levels of query performance.", "If, like me, you came to BigQuery from an MS SQL background, a lot of what I knew in regards to writing efficient SQL queries, actually no longer applied. There are subtle differences that I have learned whilst working with BigQuery nearly every day, on large-scale client projects over recent years.", "In this article, I share my top 5 key learnings.", "I hope this helps you to write faster queries, and lower your costs :)", "To help illustrate these tips, I will be using the publicly available cycle ride data from the London public cycle hire scheme. You can access this by following these instructions.", "This comprises a stations table, containing 718 stations.", "And a rides table, containing ~24M individual cycle rides.", "I imagine that you are familiar with writing SQL statements like this one, to limit the number of rows returned from a (typically large) table:", "Even if the table is very large, this query will execute very quickly; the database engine simply retrieves only the first 100 rows it finds and does not need to, therefore, perform a full scan on the table.", "Often I see people do this in BigQuery (at first, myself included!):", "This also returns 100 rows. So what\u2019s the big deal?", "Well, BigQuery handles these limit clauses differently; in the above example, despite my limit 100, BigQuery does in fact perform a full table scan of my rides table.", "BigQuery is applying the limit clause after the main query has been executed; only then, is the limit applied to reduce the rows returned.", "So be careful with limit, and certainly don\u2019t use it as a way to reduce scan times, or scan costs.", "Instead, restrict your data in your joins and where clause.", "Tip: Resist the urge to use limit 10 to inspect the top 10 rows of a table during data discovery; if that table is large, you will be charged for a full table scan! Instead, use the handy preview feature in BigQuery. Just click on the table name, and then click on the Preview tab to see the top 100 rows. For free!", "Bonus tip: When in the SQL window in the BigQuery UI, hold the control key, and click on a table name; the above Schema, Details and Preview tabs are displayed for that table.", "One factor that impacts performance in BigQuery is the volume of data scanned when your SQL queries are executed. Note too, data scan is also tied to how much you are charged (together with how much data your store).", "BigQuery offers a super-helpful feature in the UI that actually tells you, before a SQL query is executed, how much data that query will scan. Clever, hey?", "I use this feature a lot, and I would encourage others to use this too. It\u2019s a great way to learn about what is happening \u201cunder the hood\u201d, especially when you start to work with partitioned tables.", "To show you how useful it is, let\u2019s see what it estimates for a full scan of our rides table. I just type my SQL in the BigQuery UI, and in real-time it reveals:", "This query will process 2.8GB when run", "As highlighted below. The green tick indicates my SQL is valid.", "And here we see \u2014 no change in the amount of data scanned!", "Another really useful feature, is you can access these data scan metrics for other queries executed in BigQuery. To do this:", "Here is mine for the query above:", "Now, applying the limit 100, whilst it does not affect the data scanned, it does reduce the amount of data returned to the client. This has a dramatic impact on the duration for the query.", "If I remove the limit 100, the duration increases from 0.5 secs to 28.3 secs, more than a factor of 50!", "As well as your own queries, you can also see these metrics for other queries executed on this BigQuery instance; really helpful for example, if you are troubleshooting a slow running or expensive process.", "To do this, just click on the Project history tab:", "In my previous post, below, I warned against the use of select * in your SQL code.", "Well, performance on BigQuery is yet, another reason, not to use select *.", "Well, limiting your SQL to only the columns that you need reduces the amount of data BigQuery scans (reducing cost), and if your query is returning data to a client, or say loading a table, it will also reduce the execution time.", "So, my previous query below scanned 2.77 GB of data and ran for 28.3 secs.", "If I limit this to just a single column:", "This reduces the data scanned to 185.92 MB and executed in just 7.5 secs, reducing the data scanned by a factor of nearly 15, and the execution time by a factor of 4.", "Consider a query where we select all station names that have had at least one journey.", "One way to achieve this is to use the exists predicate:", "Should we, therefore, change this select * to a select 1 like this:", "Well, it turns out that this is one occasion where actually, a select * is OK. In both queries, the data scanned and execution times are identical.", "In BigQuery\u2019s distributed architecture, any order by clauses that occur in the middle of a SQL statement, greatly impact performance. This is because, in order to sort the rows, BigQuery must marshall data from distributed nodes in order to sort the data, before continuing to broadcast data back out.", "Instead, if you do need to sort data, keep your order by statements on the outermost level of your SQL query.", "For each starting station, return the bike id that made the most trips, and order by the total number of trips made by each bike.", "This scanned 1 GB of data and took 14.3 secs to execute.", "Now, let\u2019s add an order by in some of the subqueries, like this:", "If we click on Execution details, this is what the first query looked like compared with the second (the second has the additional order by clauses):", "Note the slot time increased by over 1 minute, and the bytes shuffled by 0.5 GB.", "When constructing SQL statements, always start with large tables first, filtering these as much possible in your where clause, before joining to (ideally, smaller) tables.", "This greatly reduces the amount of shuffling BigQuery needs to perform in its distributed architecture (the amount of data passed between distributed nodes).", "The query optimiser will try to do this for you, but to be on the safe side, I would recommend keeping this in mind.", "We want to count the number of rides that started at a station near a park, together with the date that the station was installed.", "The efficient way to do this is:", "Note we start with the largest rides table, and then join to the smaller station table, which is further reduced in size by filtering on the name to limit those near a park.", "This scans 184.2 MB of data and took 0.4 secs to execute.", "An inefficient way to do this, would be like this:", "The only change here is to filter the larger ride table. But the net result, is a larger set of stations is shuffled to nodes containing rides in order to produce the final counts.", "This scans 860 MB \u2014 nearly a 5 fold increase, just from this, seemingly trivial, change.", "Working with modern, column-store, distributed data platforms like BigQuery, demands some new knowledge in how to ensure SQL is written in a performant, and cost-efficient manner. Many tricks and tips learned in the past, don\u2019t necessarily apply; in fact, as we have seen, they can actually work against you.", "I hope you have found this article helpful. In the next article, I\u2019ll share some tips for working with shared and partitioned tables.", "1. Learn more about Ancoris Data, Analytics & AI", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Head of Data, Analytics & AI @ Ancoris. Part of a highly committed team of data scientists, mathematicians & engineers delivering Google Cloud client solutions"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Ff880b79cfa71&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2F5-bigquery-sql-performance-tips-for-modern-data-scientists-f880b79cfa71&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2F5-bigquery-sql-performance-tips-for-modern-data-scientists-f880b79cfa71&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2F5-bigquery-sql-performance-tips-for-modern-data-scientists-f880b79cfa71&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2F5-bigquery-sql-performance-tips-for-modern-data-scientists-f880b79cfa71&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----f880b79cfa71--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----f880b79cfa71--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://google-cloud-data.medium.com/?source=post_page-----f880b79cfa71--------------------------------", "anchor_text": ""}, {"url": "https://google-cloud-data.medium.com/?source=post_page-----f880b79cfa71--------------------------------", "anchor_text": "James Green"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fe242c1ce5f6d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2F5-bigquery-sql-performance-tips-for-modern-data-scientists-f880b79cfa71&user=James+Green&userId=e242c1ce5f6d&source=post_page-e242c1ce5f6d----f880b79cfa71---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ff880b79cfa71&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2F5-bigquery-sql-performance-tips-for-modern-data-scientists-f880b79cfa71&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ff880b79cfa71&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2F5-bigquery-sql-performance-tips-for-modern-data-scientists-f880b79cfa71&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://cloud.google.com/bigquery/public-data", "anchor_text": "BigQuery public datasets | Google Cloud\"type\": \"thumb-down\", \"id\": \"hardToUnderstand\", \"label\":\"Hard to understand\" },{ \"type\": \"thumb-down\", \"id\"\u2026cloud.google.com"}, {"url": "https://towardsdatascience.com/10-sql-standards-to-make-your-code-more-readable-in-2021-4410dc50b909", "anchor_text": "10 SQL standards to make your code more readable in 2021Make a NY resolution for 2021: Easy to read, and maintain SQLtowardsdatascience.com"}, {"url": "https://www.ancoris.com/solutions/data_analytics_ai", "anchor_text": "Ancoris Data, Analytics & AI"}, {"url": "https://medium.com/tag/sql?source=post_page-----f880b79cfa71---------------sql-----------------", "anchor_text": "Sql"}, {"url": "https://medium.com/tag/data-science?source=post_page-----f880b79cfa71---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/data-scientist?source=post_page-----f880b79cfa71---------------data_scientist-----------------", "anchor_text": "Data Scientist"}, {"url": "https://medium.com/tag/bigquery?source=post_page-----f880b79cfa71---------------bigquery-----------------", "anchor_text": "Bigquery"}, {"url": "https://medium.com/tag/database?source=post_page-----f880b79cfa71---------------database-----------------", "anchor_text": "Database"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Ff880b79cfa71&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2F5-bigquery-sql-performance-tips-for-modern-data-scientists-f880b79cfa71&user=James+Green&userId=e242c1ce5f6d&source=-----f880b79cfa71---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Ff880b79cfa71&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2F5-bigquery-sql-performance-tips-for-modern-data-scientists-f880b79cfa71&user=James+Green&userId=e242c1ce5f6d&source=-----f880b79cfa71---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ff880b79cfa71&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2F5-bigquery-sql-performance-tips-for-modern-data-scientists-f880b79cfa71&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----f880b79cfa71--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Ff880b79cfa71&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2F5-bigquery-sql-performance-tips-for-modern-data-scientists-f880b79cfa71&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----f880b79cfa71---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----f880b79cfa71--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----f880b79cfa71--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----f880b79cfa71--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----f880b79cfa71--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----f880b79cfa71--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----f880b79cfa71--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----f880b79cfa71--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----f880b79cfa71--------------------------------", "anchor_text": ""}, {"url": "https://google-cloud-data.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://google-cloud-data.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "James Green"}, {"url": "https://google-cloud-data.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "216 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fe242c1ce5f6d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2F5-bigquery-sql-performance-tips-for-modern-data-scientists-f880b79cfa71&user=James+Green&userId=e242c1ce5f6d&source=post_page-e242c1ce5f6d--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F354049f3c33d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2F5-bigquery-sql-performance-tips-for-modern-data-scientists-f880b79cfa71&newsletterV3=e242c1ce5f6d&newsletterV3Id=354049f3c33d&user=James+Green&userId=e242c1ce5f6d&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}