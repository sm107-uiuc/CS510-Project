{"url": "https://towardsdatascience.com/customize-classification-model-output-layer-46355a905b86", "time": 1683004684.085713, "path": "towardsdatascience.com/customize-classification-model-output-layer-46355a905b86/", "webpage": {"metadata": {"title": "Customize Classification Model Output Layer | by Gergely D. N\u00e9meth | Towards Data Science", "h1": "Customize Classification Model Output Layer", "description": "Image classification is a handbook example of deep learning applications. The standard way of making a classification model involves a preprocessing step where the human-readable class labels (eg\u2026"}, "outgoing_paragraph_urls": [{"url": "https://colab.research.google.com/github/tensorflow/docs/blob/master/site/en/tutorials/keras/classification.ipynb", "anchor_text": "This Colab notebook", "paragraph_index": 2}, {"url": "https://keras.io/layers/writing-your-own-keras-layers/", "anchor_text": "in Keras", "paragraph_index": 5}, {"url": "https://www.tensorflow.org/tutorials/keras/save_and_load", "anchor_text": "TensorFlow", "paragraph_index": 5}, {"url": "https://colab.research.google.com/drive/1--n60Ss4TY-jnJ2s0IoW-1Y9FRGxG1_i", "anchor_text": "this Colab notebook", "paragraph_index": 17}], "all_paragraphs": ["Image classification is a handbook example of deep learning applications. The standard way of making a classification model involves a preprocessing step where the human-readable class labels (eg.: \u2018car\u2019, \u2018person\u2019, \u2018cat\u2019) are changed to machine-ready numbers (eg.: 0,1,2). The most common way of doing this is to map the list of possible classes with their indices. Of course, this requires a postprocessing step as well, where the result is converted to the expected form. A common way is to store the label of the class with the highest score and the score (a widely used term for this is confidence).", "In this story, I will show an example of storing the labels in the model using a custom layer at the end of the model. The preferred output of my model is a list of the top k labels and their confidence scores. The formated output can be useful in production where the product is a model, and the labels have to be stored inside the model. Or, when the list of the labels changes with each iteration of models.", "For this story, I will use a simple classification model. This Colab notebook shows an example of a classifier trained on the Fashion MNIST dataset (trained on 60000 images and tested on 10000). The model expects 28x28x1 grayscale images and returns with a softmax probability of 10 classes. The list of the class labels are:", "A straightforward way to handle the output of the model can be a simple mapping: finding the index with the most score and use the label of that index.", "class_names[np.argmax(predictions[0])] to get the label of the image 0.", "To understand how to make a custom layer in Keras, I suggest reading the original documentation in Keras and TensorFlow.", "I want to implement a custom layer that stores the labels and a topnvalue, so the output of the layer can be the top n confidence labels and their scores. For this, we have to overwrite the __init__, the call, compute_output_shape and get_config functions of the layer.", "In the init function, we store the constructor parameters as the class\u2019 field. Don\u2019t forget to call the parent class\u2019 constructor! super(LabelLimitLayer, self).__init__(**kwargs)", "The call function expects the output of the previous layer as an input and calculates the top_k classes and their labels. For this, I used TensorFlow functions.", "To create a (?,len(labels)) shaped tensor from the list of labels, we first create a tensor using the list (parameter of our custom class) and then expand it using the shape of the previous layer\u2019s output (we extract the batch_size from it). The steps are:", "To select the top k scores, I used the corresponding TensorFlow function. We store the indices so we can map the labels for those indices as well as the confidence values.top_k = tf.nn.top_k(x, k=self.topn, sorted=True, name=\u201dtop_k\u201d).indices", "To get the values of a tensor using indices from another tensor, I use the tf.gather function.top_conf = tf.gather(x, top_k, batch_dims=1)top_labels = tf.gather(tf_labels, top_k, batch_dims=1)", "Finally, the layer returns with the last two tensors. return [top_conf, top_labels]", "Because of the two output tensor, the Keras layer can\u2019t automatically compute the output shape. Fortunately, it can be calculated as follows:top_shape = (batch_size, self.topn)return [top_shape, top_shape]", "To serialize the custom layer (when saving a model), one has to update the config with the values of the class parameters. Don\u2019t forget to add the superclass\u2019 config to the dictionary!", "In this example, I added a custom layer at the end of the base classification model, with labels (class_names) and top_k value (2).", "Finally, to save a model, we can use the Keras model\u2019s save function. To load a model with a custom layer, one has to define this custom layer at the custom_objects parameter.", "This snippet shows how to use Keras custom layers to create string labels as the output of a model. The story also uses top_k to keep only the relevant classes. The corresponding codes are available at this Colab notebook.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F46355a905b86&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustomize-classification-model-output-layer-46355a905b86&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustomize-classification-model-output-layer-46355a905b86&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustomize-classification-model-output-layer-46355a905b86&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustomize-classification-model-output-layer-46355a905b86&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----46355a905b86--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----46355a905b86--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@neged.ng?source=post_page-----46355a905b86--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@neged.ng?source=post_page-----46355a905b86--------------------------------", "anchor_text": "Gergely D. N\u00e9meth"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F71eefc6da84b&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustomize-classification-model-output-layer-46355a905b86&user=Gergely+D.+N%C3%A9meth&userId=71eefc6da84b&source=post_page-71eefc6da84b----46355a905b86---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F46355a905b86&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustomize-classification-model-output-layer-46355a905b86&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F46355a905b86&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustomize-classification-model-output-layer-46355a905b86&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@rangel?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "David Rangel"}, {"url": "https://unsplash.com/s/photos/programming?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Unsplash"}, {"url": "https://colab.research.google.com/github/tensorflow/docs/blob/master/site/en/tutorials/keras/classification.ipynb", "anchor_text": "This Colab notebook"}, {"url": "https://github.com/zalandoresearch/fashion-mnist", "anchor_text": "Fashion MNIST examples"}, {"url": "https://keras.io/layers/writing-your-own-keras-layers/", "anchor_text": "in Keras"}, {"url": "https://www.tensorflow.org/tutorials/keras/save_and_load", "anchor_text": "TensorFlow"}, {"url": "https://colab.research.google.com/drive/1--n60Ss4TY-jnJ2s0IoW-1Y9FRGxG1_i", "anchor_text": "this Colab notebook"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----46355a905b86---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/tensorflow?source=post_page-----46355a905b86---------------tensorflow-----------------", "anchor_text": "TensorFlow"}, {"url": "https://medium.com/tag/image-classification?source=post_page-----46355a905b86---------------image_classification-----------------", "anchor_text": "Image Classification"}, {"url": "https://medium.com/tag/code-snippet?source=post_page-----46355a905b86---------------code_snippet-----------------", "anchor_text": "Code Snippet"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----46355a905b86---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F46355a905b86&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustomize-classification-model-output-layer-46355a905b86&user=Gergely+D.+N%C3%A9meth&userId=71eefc6da84b&source=-----46355a905b86---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F46355a905b86&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustomize-classification-model-output-layer-46355a905b86&user=Gergely+D.+N%C3%A9meth&userId=71eefc6da84b&source=-----46355a905b86---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F46355a905b86&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustomize-classification-model-output-layer-46355a905b86&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----46355a905b86--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F46355a905b86&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustomize-classification-model-output-layer-46355a905b86&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----46355a905b86---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----46355a905b86--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----46355a905b86--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----46355a905b86--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----46355a905b86--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----46355a905b86--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----46355a905b86--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----46355a905b86--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----46355a905b86--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@neged.ng?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@neged.ng?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Gergely D. N\u00e9meth"}, {"url": "https://medium.com/@neged.ng/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "190 Followers"}, {"url": "https://ellisalicante.org", "anchor_text": "https://ellisalicante.org"}, {"url": "https://www.linkedin.com/in/gergely-nemeth-092b10137/", "anchor_text": "https://www.linkedin.com/in/gergely-nemeth-092b10137/"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F71eefc6da84b&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustomize-classification-model-output-layer-46355a905b86&user=Gergely+D.+N%C3%A9meth&userId=71eefc6da84b&source=post_page-71eefc6da84b--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fb43768ab187d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcustomize-classification-model-output-layer-46355a905b86&newsletterV3=71eefc6da84b&newsletterV3Id=b43768ab187d&user=Gergely+D.+N%C3%A9meth&userId=71eefc6da84b&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}