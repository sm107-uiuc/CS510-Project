{"url": "https://towardsdatascience.com/understanding-region-of-interest-part-2-roi-align-and-roi-warp-f795196fc193", "time": 1683003758.317933, "path": "towardsdatascience.com/understanding-region-of-interest-part-2-roi-align-and-roi-warp-f795196fc193/", "webpage": {"metadata": {"title": "Understanding Region of Interest \u2014 (RoI Align and RoI Warp) | by Kemal Erdem (burnpiro) | Towards Data Science", "h1": "Understanding Region of Interest \u2014 (RoI Align and RoI Warp)", "description": "As you remember from the first part of the series, RoI Pooling has one major problem. It loses a lot of data in the process. Every time it does that, part of the information about the object is\u2026"}, "outgoing_paragraph_urls": [{"url": "https://medium.com/@kemalpiro/understanding-region-of-interest-part-1-roi-pooling-e4f5dd65bb44", "anchor_text": "Understanding Region of Interest \u2014 (RoI Pooling)", "paragraph_index": 0}, {"url": "https://medium.com/@kemalpiro/understanding-region-of-interest-part-1-roi-pooling-e4f5dd65bb44", "anchor_text": "RoI Pooling", "paragraph_index": 8}, {"url": "https://arxiv.org/pdf/1512.04412.pdf", "anchor_text": "Instance-aware semantic segmentation via multi-task network cascades", "paragraph_index": 25}], "all_paragraphs": ["If you\u2019re not familiar with idea of RoI it might be beneficial to read Understanding Region of Interest \u2014 (RoI Pooling) first. This article doesn\u2019t include an introduction about what RoI is and focuses only on RoIAlign and RoIWarp.", "As you remember from the first part of the series, RoI Pooling has one major problem. It loses a lot of data in the process.", "Every time it does that, part of the information about the object is missing. That lowers the precision of the whole model and a lot of really smart people thought about it.", "Before we start I need to quickly explain our model.", "We\u2019re going to use Mask R-CNN network for testing. The only reason we\u2019re using it is that this kind of network benefits more from a precise pooling layer, so it\u2019s easier to show a difference between RoI Align and RoI Pooling. It doesn\u2019t really matter which network we\u2019re using until it does RoI Pooling. Because of that our setup remains the same and looks like that:", "Our model takes an image input of size 512x512x3 (width x height x RGB) and VGG16 is mapping it into a 16x16x512 feature map. A scale factor is 32.", "Next, we\u2019re using one of the proposed RoIs ( 145x200 box) and try to map it onto the feature map. Because not all of our object dimensions can be divided by 32, we\u2019re placing RoI not align with our grid.", "Once again we\u2019re choosing our pooling layer to have a size of 3x3 so the end result shape is 3x3x512 (That\u2019s just an arbitrary example to make it easier to display on image. Your pooling layer will probably have a different size).", "Up till this point, everything looks exactly the same as in RoI Pooling.", "The main difference between RoI Pooling and RoI Align is quantization. RoI Align is not using quantization for data pooling. You know that Fast R-CNN is applying quantization twice. First time in the mapping process and the second time during the pooling process.", "We can skip that by dividing original RoI into 9 equal size boxes and applying bilinear interpolation inside every one of them. Let\u2019s define boxes then:", "Each box size is determined by the size of the mapped RoI and the size of the pooling layer. We\u2019re using a 3x3 pooling layer so we have to divide mapped RoI ( 6.25x4.53) by 3. That gives us a box with a height of 1.51 and a width of 2.08 (I\u2019m rounding values here to make it easier). Now we can put our boxes into mapped RoI:", "If you look at the first box (top left), you can notice that it covers six different grid cells. To extract value for the pooling layer we have to sample some data from it. To sample data we have to create four sampling points inside that box.", "You can calculate where each of those points should be by dividing the height and width of the box by 3.", "In our case we\u2019re calculating first point (top left) coordinates like this:", "To calculate the second point (bottom left) we have to change only the Y:", "Now when we have all the points we can apply bilinear interpolation to sample data for this box. Bilinear interpolation is usually used in image processing to sample colors and its equation looks like this:", "Instead of trying to understand this equation please take a look on a graphical interpretation of how it works:", "When you take the first point from our box, you\u2019re connecting it with closest neighboring cells (exactly to the middle), unless it\u2019s already taken. In this case, our point has coordinates (9.44, 6.50). Closest middle of the cell in top-left direction is (9.50, 6.50) (it would be (9.50, 5.50) if our point was only 0.01 higher on the grid). Then we have to select a bottom-left point and the closest one is (9.50, 7.50). Following the same rule, we\u2019re selecting (10.50, 6.50) and (10.50, 7.50) as top-right and bottom-right points. Above the RoI, you could see the whole calculation to get the value for the first point (0.14).", "You should start seeing a pattern here :). Here are the other points:", "Now we have all the points calculated and can apply Max Pooling on them (it could be Avg Pooling if you want):", "I\u2019m not going to show you all interpolations because it would take to long and you probably know how to do them already. I\u2019m going to show you how the whole process works for pooling data from this RoI using RoIAlign:", "And ofc. this process goes for every layer there is so end result contains 512 layers (the same as feature map input)", "Notice that even if we\u2019re not placing our sampling points inside all cells from the feature map, we\u2019re extracting data from them by bilinear interpolation.", "If you compare data lost/data gain from RoIAlign and RoIPooling you should see that RoIAlign uses the whole area to pool data from:", "There is a third method of pooling data that was introduced in Instance-aware semantic segmentation via multi-task network cascades and it\u2019s called RoIWarp. The idea of RoIWarp is more or less the same as RoIAlign, the only difference is that RoIWarp is quantizing RoI mapping onto a feature map.", "And if you look on data lost/data gain:", "We\u2019re only losing a small amount of it due to bilinear interpolation.", "If we look at Mask R-CNN paper there are some important numbers to discuss. First one is a change in average precision when applying different RoI layers on ResNet-50-C4 with stride 16:", "There is only a small improvement when RoIWarp is applied but applying RoIAlign gives us a significant boost in precision. That boost increases with stride:", "Where APbb is an average precision for detecting bounding boxes. The test is done on ResNet-50-C5 with stride 32.", "Understanding RoI Pooling is important when we want to improve our R-CNN-like model accuracy. There is a significant difference between the standard approach proposed in the 2014 paper about Fast R-CNN and a new one proposed in the 2018 paper about Mask R-CNN. It doesn\u2019t mean those methods apply only to specific networks, we can easily use RoIAlign in Fast R-CNN and RoIPooling in Mask R-CNN but you have to remember that RoIAlign gives us better precision on average.", "I really hope that my explanation is easy to understand because I\u2019ve seen a lot of post writing about RoI Pooling without getting into calculations. In my opinion, a more visual approach is always better, especially if you don\u2019t want to spend a whole day reading the original paper over and over to finally understand what it does.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "ML Engineer, Javascript Architect, Consultant, MTB lover"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Ff795196fc193&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Funderstanding-region-of-interest-part-2-roi-align-and-roi-warp-f795196fc193&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Funderstanding-region-of-interest-part-2-roi-align-and-roi-warp-f795196fc193&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Funderstanding-region-of-interest-part-2-roi-align-and-roi-warp-f795196fc193&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Funderstanding-region-of-interest-part-2-roi-align-and-roi-warp-f795196fc193&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----f795196fc193--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----f795196fc193--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@kemalpiro?source=post_page-----f795196fc193--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@kemalpiro?source=post_page-----f795196fc193--------------------------------", "anchor_text": "Kemal Erdem (burnpiro)"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F33f26fcba3a2&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Funderstanding-region-of-interest-part-2-roi-align-and-roi-warp-f795196fc193&user=Kemal+Erdem+%28burnpiro%29&userId=33f26fcba3a2&source=post_page-33f26fcba3a2----f795196fc193---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ff795196fc193&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Funderstanding-region-of-interest-part-2-roi-align-and-roi-warp-f795196fc193&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ff795196fc193&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Funderstanding-region-of-interest-part-2-roi-align-and-roi-warp-f795196fc193&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://arxiv.org/pdf/1504.08083.pdf", "anchor_text": "https://arxiv.org/pdf/1504.08083.pdf"}, {"url": "https://medium.com/@kemalpiro/understanding-region-of-interest-part-1-roi-pooling-e4f5dd65bb44", "anchor_text": "Understanding Region of Interest \u2014 (RoI Pooling)"}, {"url": "https://arxiv.org/pdf/1703.06870.pdf", "anchor_text": "https://arxiv.org/pdf/1703.06870.pdf"}, {"url": "https://arxiv.org/pdf/1703.06870.pdf", "anchor_text": "https://arxiv.org/pdf/1703.06870.pdf"}, {"url": "https://www.flickr.com/photos/bunny/", "anchor_text": "https://www.flickr.com/photos/bunny/"}, {"url": "https://medium.com/@kemalpiro/understanding-region-of-interest-part-1-roi-pooling-e4f5dd65bb44", "anchor_text": "RoI Pooling"}, {"url": "https://arxiv.org/pdf/1512.04412.pdf", "anchor_text": "Instance-aware semantic segmentation via multi-task network cascades"}, {"url": "https://arxiv.org/pdf/1504.08083.pdf", "anchor_text": "https://arxiv.org/pdf/1504.08083.pdf"}, {"url": "https://arxiv.org/pdf/1512.04412.pdf", "anchor_text": "https://arxiv.org/pdf/1512.04412.pdf"}, {"url": "https://arxiv.org/pdf/1703.06870.pdf", "anchor_text": "https://arxiv.org/pdf/1703.06870.pdf"}, {"url": "https://erdem.pl/2020/02/understanding-region-of-interest-part-2-ro-i-align", "anchor_text": "https://erdem.pl"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----f795196fc193---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----f795196fc193---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/tag/neural-networks?source=post_page-----f795196fc193---------------neural_networks-----------------", "anchor_text": "Neural Networks"}, {"url": "https://medium.com/tag/convolutional-network?source=post_page-----f795196fc193---------------convolutional_network-----------------", "anchor_text": "Convolutional Network"}, {"url": "https://medium.com/tag/understanding-ml?source=post_page-----f795196fc193---------------understanding_ml-----------------", "anchor_text": "Understanding Ml"}, {"url": "https://creativecommons.org/licenses/by-nc-sa/4.0/", "anchor_text": "Some rights reserved"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Ff795196fc193&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Funderstanding-region-of-interest-part-2-roi-align-and-roi-warp-f795196fc193&user=Kemal+Erdem+%28burnpiro%29&userId=33f26fcba3a2&source=-----f795196fc193---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Ff795196fc193&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Funderstanding-region-of-interest-part-2-roi-align-and-roi-warp-f795196fc193&user=Kemal+Erdem+%28burnpiro%29&userId=33f26fcba3a2&source=-----f795196fc193---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ff795196fc193&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Funderstanding-region-of-interest-part-2-roi-align-and-roi-warp-f795196fc193&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----f795196fc193--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Ff795196fc193&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Funderstanding-region-of-interest-part-2-roi-align-and-roi-warp-f795196fc193&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----f795196fc193---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----f795196fc193--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----f795196fc193--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----f795196fc193--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----f795196fc193--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----f795196fc193--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----f795196fc193--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----f795196fc193--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----f795196fc193--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@kemalpiro?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@kemalpiro?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Kemal Erdem (burnpiro)"}, {"url": "https://medium.com/@kemalpiro/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "393 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F33f26fcba3a2&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Funderstanding-region-of-interest-part-2-roi-align-and-roi-warp-f795196fc193&user=Kemal+Erdem+%28burnpiro%29&userId=33f26fcba3a2&source=post_page-33f26fcba3a2--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F3b505e95e71f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Funderstanding-region-of-interest-part-2-roi-align-and-roi-warp-f795196fc193&newsletterV3=33f26fcba3a2&newsletterV3Id=3b505e95e71f&user=Kemal+Erdem+%28burnpiro%29&userId=33f26fcba3a2&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}