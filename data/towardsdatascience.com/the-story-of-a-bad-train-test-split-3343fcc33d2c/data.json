{"url": "https://towardsdatascience.com/the-story-of-a-bad-train-test-split-3343fcc33d2c", "time": 1682994247.1677032, "path": "towardsdatascience.com/the-story-of-a-bad-train-test-split-3343fcc33d2c/", "webpage": {"metadata": {"title": "The Story of a Bad Train-Test Split | by Yoel Zeldes | Towards Data Science", "h1": "The Story of a Bad Train-Test Split", "description": "Splitting your dataset to train-test sets can sometimes be more complicated than one might expect"}, "outgoing_paragraph_urls": [{"url": "https://engineering.taboola.com/story-of-bad-train-test-split", "anchor_text": "engineering.taboola.com", "paragraph_index": 20}], "all_paragraphs": ["About a year ago we incorporated a new type of feature into one of our models used for recommending content items to our users. I\u2019m talking about the thumbnail of the content item:", "Up until that point we used the item\u2019s title and metadata features. The title is easier to work with compared to the thumbnail \u2014 machine learning wise.", "Our model has matured and it was time to add the thumbnail to the party. This decision was the first step towards a horrible bias introduced into our train-test split procedure. Let me unfold the story\u2026", "From our experience it\u2019s hard to incorporate multiple types of features into a unified model. So we decided to take baby steps, and add the thumbnail to a model that uses only one feature \u2014 the title.", "There\u2019s one thing you need to take into account when working with these two features, and that\u2019s data leakage. When working with the title only, you can naively split your dataset into train-test randomly \u2014 after removing items with the same title. However, you can\u2019t apply random split when you work with both the title and the thumbnail. That\u2019s because many items share the same thumbnail or title. Stock photos are a good example for shared thumbnails across different items. Thus, a model that memorizes titles/thumbnails it encountered in the training set might have a good performance on the test set, while not doing a good job at generalization.", "The solution? We should split the dataset so that each thumbnail appears either in train or test, but not both. Same goes for the title.", "Well, that sounds simple. Let\u2019s start with the simplest implementation. We\u2019ll mark all the rows in the dataset as \u201ctrain\u201d. Then, we\u2019ll iteratively convert rows into \u201ctest\u201d until we get the desired split, let\u2019s say 80%-20%. How is the conversion done? At each step of the loop we\u2019ll pick a random \u201ctrain\u201d row and mark it for conversion. Before converting, we\u2019ll inspect all of the rows that have the same title/thumbnail, and mark them as well. We\u2019ll continue doing so until there are no more rows that we can mark. Finally, we\u2019ll convert the marked group into \u201ctest\u201d.", "At first sight nothing seems wrong with the naive solution. Each thumbnail/title appears either in train or in test. So what seems to be the problem?", "First I\u2019ll show you the symptoms of the problem. In order to be able to compare the title-only model to the model that also uses the thumbnail, we used the new split for the title-only model too. It shouldn\u2019t really make an impact on it\u2019s performance, right? But then we got the following results:", "In the top row we see what we already know: the title-only model has higher accuracy on train set, and accuracy isn\u2019t significantly affected by the ratio of the split.", "The problem pops up in the bottom row, where we apply the new split method. We expected to see similar results, but the title-only model was better on test. What?\u2026. It shouldn\u2019t be like that. Additionally, the performance is greatly affected by the ratio. Something is suspicious\u2026", "You can think of our dataset as a bipartite graph, where one side is the thumbnails, and the other is the titles. There is an edge between a thumbnail and a title if there is an item with that thumbnail and title.", "What we effectively did in our new split is making sure each connected component resides in its entirety either in train or test set.", "It turns out that the split is biased. It tends to select big components for the test set. Say the test set should contain 15% of the rows. You\u2019d expect it to contain 15% of the components, but what we got was 4%.", "What was the problem with what we did? When you randomly sample a row, the probability of getting a row from a specific component is proportional to the component\u2019s size. Therefore, the test set ended up with a small number of big components. It may be counterintuitive, but here\u2019s a code snippet you can try to experience it yourself:", "The components size distribution is different between the train and test set.", "Now that we formalized better what we were doing by means of bipartite graph, we can implement the split by randomly sampling connected components, instead of randomly sampling rows. Doing so, each component gets the same probability of being selected for the test set.", "The way you split your dataset into train-test is crucial for the research phase of a project. While researching, you spend a significant amount of your time on looking at the performance over the test set. It\u2019s not always straightforward to construct the test set so that it\u2019s representative of what happens at inference time.", "Take for example the task of recommending an item to a user: you can either recommend a completely new item or an item that has been shown to other users in the past. Both are important.", "In order to understand how the model is doing offline in the research phase, you\u2019ll have to construct a test set that contains both completely new items, and items that appear in the train set. What is the right proportion? Hard to say\u2026 I guess it can be a topic for another post on another day \ud83d\ude42", "Originally published by me at engineering.taboola.com.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F3343fcc33d2c&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-story-of-a-bad-train-test-split-3343fcc33d2c&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-story-of-a-bad-train-test-split-3343fcc33d2c&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-story-of-a-bad-train-test-split-3343fcc33d2c&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-story-of-a-bad-train-test-split-3343fcc33d2c&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----3343fcc33d2c--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----3343fcc33d2c--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://yoelzeldes.medium.com/?source=post_page-----3343fcc33d2c--------------------------------", "anchor_text": ""}, {"url": "https://yoelzeldes.medium.com/?source=post_page-----3343fcc33d2c--------------------------------", "anchor_text": "Yoel Zeldes"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fa609ddb637b2&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-story-of-a-bad-train-test-split-3343fcc33d2c&user=Yoel+Zeldes&userId=a609ddb637b2&source=post_page-a609ddb637b2----3343fcc33d2c---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F3343fcc33d2c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-story-of-a-bad-train-test-split-3343fcc33d2c&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F3343fcc33d2c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-story-of-a-bad-train-test-split-3343fcc33d2c&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://engineering.taboola.com/story-of-bad-train-test-split", "anchor_text": "engineering.taboola.com"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----3343fcc33d2c---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/data-science?source=post_page-----3343fcc33d2c---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----3343fcc33d2c---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F3343fcc33d2c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-story-of-a-bad-train-test-split-3343fcc33d2c&user=Yoel+Zeldes&userId=a609ddb637b2&source=-----3343fcc33d2c---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F3343fcc33d2c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-story-of-a-bad-train-test-split-3343fcc33d2c&user=Yoel+Zeldes&userId=a609ddb637b2&source=-----3343fcc33d2c---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F3343fcc33d2c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-story-of-a-bad-train-test-split-3343fcc33d2c&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----3343fcc33d2c--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F3343fcc33d2c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-story-of-a-bad-train-test-split-3343fcc33d2c&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----3343fcc33d2c---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----3343fcc33d2c--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----3343fcc33d2c--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----3343fcc33d2c--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----3343fcc33d2c--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----3343fcc33d2c--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----3343fcc33d2c--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----3343fcc33d2c--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----3343fcc33d2c--------------------------------", "anchor_text": ""}, {"url": "https://yoelzeldes.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://yoelzeldes.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Yoel Zeldes"}, {"url": "https://yoelzeldes.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "816 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fa609ddb637b2&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-story-of-a-bad-train-test-split-3343fcc33d2c&user=Yoel+Zeldes&userId=a609ddb637b2&source=post_page-a609ddb637b2--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Ffd4674272ff5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-story-of-a-bad-train-test-split-3343fcc33d2c&newsletterV3=a609ddb637b2&newsletterV3Id=fd4674272ff5&user=Yoel+Zeldes&userId=a609ddb637b2&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}