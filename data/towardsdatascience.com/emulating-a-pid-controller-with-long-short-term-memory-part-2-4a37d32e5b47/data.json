{"url": "https://towardsdatascience.com/emulating-a-pid-controller-with-long-short-term-memory-part-2-4a37d32e5b47", "time": 1683015271.6350222, "path": "towardsdatascience.com/emulating-a-pid-controller-with-long-short-term-memory-part-2-4a37d32e5b47/", "webpage": {"metadata": {"title": "Emulating a PID Controller with Long Short-term Memory: Part 2 | by Nicholas Lewis | Towards Data Science", "h1": "Emulating a PID Controller with Long Short-term Memory: Part 2", "description": "Welcome to Part 2 of this exciting project! The results have looked great so far, and now we can get into the meat of what we\u2019re trying to accomplish: emulating the behavior of a PID controller with\u2026"}, "outgoing_paragraph_urls": [{"url": "https://github.com/nrlewis929/TCLab_emulate_PID", "anchor_text": "Github", "paragraph_index": 1}, {"url": "https://towardsdatascience.com/emulating-a-pid-controller-with-long-short-term-memory-part-1-bb5b87165b08", "anchor_text": "last segment", "paragraph_index": 2}, {"url": "https://colah.github.io/posts/2015-08-Understanding-LSTMs/", "anchor_text": "Here", "paragraph_index": 2}, {"url": "https://towardsdatascience.com/recurrent-neural-networks-by-example-in-python-ffd204f99470", "anchor_text": "this", "paragraph_index": 2}, {"url": "https://towardsdatascience.com/illustrated-guide-to-lstms-and-gru-s-a-step-by-step-explanation-44e9eb85bf21", "anchor_text": "Here\u2019s", "paragraph_index": 2}, {"url": "http://apmonitor.com/do/index.php/Main/LSTMNetwork", "anchor_text": "APMonitor.com", "paragraph_index": 2}, {"url": "https://en.wikipedia.org/wiki/Vanishing_gradient_problem", "anchor_text": "vanishing gradient problem", "paragraph_index": 3}, {"url": "https://nrlewis929.medium.com/emulating-a-pid-controller-with-long-short-term-memory-part-4-19ab327be61b", "anchor_text": "Part 4", "paragraph_index": 5}, {"url": "https://scikit-learn.org/stable/modules/classes.html#module-sklearn.feature_selection", "anchor_text": "feature selection models", "paragraph_index": 6}, {"url": "http://hyperopt.github.io/hyperopt/", "anchor_text": "Hyperopt", "paragraph_index": 9}], "all_paragraphs": ["Welcome to Part 2 of this exciting project! The results have looked great so far, and now we can get into the meat of what we\u2019re trying to accomplish: emulating the behavior of a PID controller with an LSTM. As a recap, here\u2019s what we\u2019ve explored so far and where we\u2019re going:", "If you want to run this code on your own, you can find it on Github. It\u2019s heavily dependent on using the TCLab device on your computer, but eventually I plan to generate data and add some notebooks so you can run it as a standalone project as well. Of course, I always encourage you to see what principles you can take from this and apply them to your own project.", "After completing the last segment, we have some data to work with, and we want to see if an LSTM can emulate the behavior of the PID controller. There are some excellent articles about how LSTMs work, so I\u2019ll point you to those if you haven\u2019t worked with them before. Here is one of the places I went when looking at some of the math behind them, and this is a fantastic Towards Data Science article that introduced me to how they\u2019re implemented in Python with Keras. Here\u2019s another great tutorial that has a video. As usual, APMonitor.com is a rich resource in all things relevant to machine learning and process control.", "LSTMs have been a popular approach to all types of machine learning models because of their versatility. I\u2019ve used them in sequence prediction tasks, natural language processing, and anomaly detection; others have found applications ranging from image processing to speech recognition. What sets it apart from a standard recurrent neural network is the presence of its cell memory unit, which helps to address the vanishing gradient problem.", "LSTMs work well on this type of problem because we want to remember what has been happening previously in the control system. If we just barely changed the setpoint from 35\u00b0C to 70\u00b0C, we know the heater is going to be put on max for a while to get to that setpoint. However, if we just drop from 45\u00b0C down to 42\u00b0C, or have been holding steady at say 55\u00b0C for a while, the controller will have to account differently.", "In context of emulating the PID controller, we want to input a window of data, such as the temperature, setpoint, error, or heater values, and predict what the next heater value should be to reach the desired setpoint. This prediction is emulating the output that the PID controller with the given tuning constants would give us. Of course, if the tuning constants change, we\u2019re no longer looking at the same type of controller behavior. That\u2019s an interesting idea to explore in Part 4.", "The first step is to look at what features are useful to feed into the model. Intuitively, the PID controller takes the error between the sensor temperature and the setpoint as the input, and so it\u2019s likely that our LSTM will need those. Scikit-learn has lots of useful feature selection models to help us understand some good inputs. Let\u2019s use the SelectKBest method to narrow down our options. We have the sensor temperature, setpoint, and heater output; we\u2019ll also derive the error, and pass these into the SelectKBest function:", "Plotting the results shows that Tsp (setpoint temperature) and err (error between setpoint and sensor) are the most important features by far, which validates our intuition.", "For the LSTM, I\u2019ll be using Keras with a Tensorflow backend; I find this is an intuitive and efficient way of building models. Before building the model, I need to scale the data and format it to how the LSTM expects it. In this case, I\u2019ll take my Tsp and err features, and arrange them in such a way that the past 15 time points are fed as an input to predict the heater output Q1. Be sure to also set aside some data to test the model performance.", "There are tons of hyperparameters we could look at to optimize the fidelity of the LSTM to the PID controller. I typically will use an extremely useful Python package called Hyperopt to tune these, especially with a really complex problem. Here are some of the hyperparameters that worked well:", "Now, we\u2019re ready to construct the LSTM model. There are lots of tutorials on how to do this, so I\u2019ll go ahead and show the code, then comment on a few highlights.", "After constructing the LSTM and Dropout layers, we have a Dense layer with a value of 1, since the model is only predicting 1 output value. We use the adam optimizer and mean_squared_error as the loss function. I like to set aside some of the training data for validation with the validation_split argument. This allows me to monitor the loss on a separate set of data and stop the model training early if my loss plateaus (you can adjust how long you wait after it plateaus with the patience argument), which prevents overfitting the model. The TqdmCallback is a handy progress bar that I like better than the default one that comes with Keras. Finally, it\u2019s always good to plot the loss function to make sure that both the training loss and validation loss show a general decreasing trend. It will take a bit of time to train the LSTM, but we\u2019re not working with huge datasets, so it\u2019s not prohibitive.", "Before we use the LSTM to control the TCLab, we want to make sure its behavior approximates what the PID controller would do. Not only is this important for a sanity check, but it\u2019s also an important safety issue. Can you imagine using a temperature controller on a reactor that you weren\u2019t sure would work? If it didn\u2019t work as intended, and there was a runaway reaction, it could cause a big mess.", "Luckily, we already have some sample data that we set aside, all in the correct format that the LSTM expects for input. We just need to see that, given the inputs, the predicted heater outputs from the LSTM align with what the PID controller would do. Be sure to undo the scaling of the data so we have the real values.", "That\u2019s amazing! You can see the setpoint and T1 data (from which we derived the error), and the real data from the PID controller. The green then shows how the LSTM would behave, given the exact same set of input data. It looks like it follows the PID controller behavior with close fidelity, so I\u2019d be confident trying this out as a proxy controller, with just one adjustment. Notice that the LSTM output sometimes goes beyond the range [0, 100] that the heater is bound to. We\u2019ll have to remember to clip the results when we code it in as the controller.", "We\u2019ve got a working LSTM model, and the next step is to code it in as the controller. That\u2019s a pretty big project, so we\u2019ll save that for the next post in the series (coming October 2020). Until then, just be sure to save your model and any parameters you used for preprocessing.", "And there we have it. We successfully trained an LSTM model to emulate the behavior of a PID controller. The next big step is to put it to use.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F4a37d32e5b47&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Femulating-a-pid-controller-with-long-short-term-memory-part-2-4a37d32e5b47&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Femulating-a-pid-controller-with-long-short-term-memory-part-2-4a37d32e5b47&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Femulating-a-pid-controller-with-long-short-term-memory-part-2-4a37d32e5b47&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Femulating-a-pid-controller-with-long-short-term-memory-part-2-4a37d32e5b47&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----4a37d32e5b47--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----4a37d32e5b47--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://nrlewis929.medium.com/?source=post_page-----4a37d32e5b47--------------------------------", "anchor_text": ""}, {"url": "https://nrlewis929.medium.com/?source=post_page-----4a37d32e5b47--------------------------------", "anchor_text": "Nicholas Lewis"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fa4cd35f7b702&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Femulating-a-pid-controller-with-long-short-term-memory-part-2-4a37d32e5b47&user=Nicholas+Lewis&userId=a4cd35f7b702&source=post_page-a4cd35f7b702----4a37d32e5b47---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F4a37d32e5b47&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Femulating-a-pid-controller-with-long-short-term-memory-part-2-4a37d32e5b47&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F4a37d32e5b47&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Femulating-a-pid-controller-with-long-short-term-memory-part-2-4a37d32e5b47&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@ivorycirrus?utm_source=medium&utm_medium=referral", "anchor_text": "PilMo Kang"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://medium.com/@nrlewis929/emulating-a-pid-controller-with-long-short-term-memory-part-1-bb5b87165b08", "anchor_text": "Using the Temperature Control Lab to create Proportional-Integral-Derivative controller data"}, {"url": "https://nrlewis929.medium.com/emulating-a-pid-controller-with-long-short-term-memory-part-3-23da7df3e033", "anchor_text": "Controlling the Temperature Control Lab with an LSTM"}, {"url": "https://nrlewis929.medium.com/emulating-a-pid-controller-with-long-short-term-memory-part-4-19ab327be61b", "anchor_text": "Practical applications of temperature control using LSTM controller instead of PID controller"}, {"url": "https://github.com/nrlewis929/TCLab_emulate_PID", "anchor_text": "Github"}, {"url": "https://towardsdatascience.com/emulating-a-pid-controller-with-long-short-term-memory-part-1-bb5b87165b08", "anchor_text": "last segment"}, {"url": "https://colah.github.io/posts/2015-08-Understanding-LSTMs/", "anchor_text": "Here"}, {"url": "https://towardsdatascience.com/recurrent-neural-networks-by-example-in-python-ffd204f99470", "anchor_text": "this"}, {"url": "https://towardsdatascience.com/illustrated-guide-to-lstms-and-gru-s-a-step-by-step-explanation-44e9eb85bf21", "anchor_text": "Here\u2019s"}, {"url": "http://apmonitor.com/do/index.php/Main/LSTMNetwork", "anchor_text": "APMonitor.com"}, {"url": "https://en.wikipedia.org/wiki/Vanishing_gradient_problem", "anchor_text": "vanishing gradient problem"}, {"url": "https://nrlewis929.medium.com/emulating-a-pid-controller-with-long-short-term-memory-part-4-19ab327be61b", "anchor_text": "Part 4"}, {"url": "https://scikit-learn.org/stable/modules/classes.html#module-sklearn.feature_selection", "anchor_text": "feature selection models"}, {"url": "http://hyperopt.github.io/hyperopt/", "anchor_text": "Hyperopt"}, {"url": "https://medium.com/tag/keras?source=post_page-----4a37d32e5b47---------------keras-----------------", "anchor_text": "Keras"}, {"url": "https://medium.com/tag/lstm?source=post_page-----4a37d32e5b47---------------lstm-----------------", "anchor_text": "Lstm"}, {"url": "https://medium.com/tag/pid-controller?source=post_page-----4a37d32e5b47---------------pid_controller-----------------", "anchor_text": "Pid Controller"}, {"url": "https://medium.com/tag/python?source=post_page-----4a37d32e5b47---------------python-----------------", "anchor_text": "Python"}, {"url": "https://medium.com/tag/lstm-control-emulation?source=post_page-----4a37d32e5b47---------------lstm_control_emulation-----------------", "anchor_text": "Lstm Control Emulation"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F4a37d32e5b47&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Femulating-a-pid-controller-with-long-short-term-memory-part-2-4a37d32e5b47&user=Nicholas+Lewis&userId=a4cd35f7b702&source=-----4a37d32e5b47---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F4a37d32e5b47&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Femulating-a-pid-controller-with-long-short-term-memory-part-2-4a37d32e5b47&user=Nicholas+Lewis&userId=a4cd35f7b702&source=-----4a37d32e5b47---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F4a37d32e5b47&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Femulating-a-pid-controller-with-long-short-term-memory-part-2-4a37d32e5b47&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----4a37d32e5b47--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F4a37d32e5b47&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Femulating-a-pid-controller-with-long-short-term-memory-part-2-4a37d32e5b47&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----4a37d32e5b47---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----4a37d32e5b47--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----4a37d32e5b47--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----4a37d32e5b47--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----4a37d32e5b47--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----4a37d32e5b47--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----4a37d32e5b47--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----4a37d32e5b47--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----4a37d32e5b47--------------------------------", "anchor_text": ""}, {"url": "https://nrlewis929.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://nrlewis929.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Nicholas Lewis"}, {"url": "https://nrlewis929.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "214 Followers"}, {"url": "https://www.linkedin.com/in/nicholas-lewis-0366146b/", "anchor_text": "https://www.linkedin.com/in/nicholas-lewis-0366146b/"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fa4cd35f7b702&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Femulating-a-pid-controller-with-long-short-term-memory-part-2-4a37d32e5b47&user=Nicholas+Lewis&userId=a4cd35f7b702&source=post_page-a4cd35f7b702--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F9c6ec087b148&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Femulating-a-pid-controller-with-long-short-term-memory-part-2-4a37d32e5b47&newsletterV3=a4cd35f7b702&newsletterV3Id=9c6ec087b148&user=Nicholas+Lewis&userId=a4cd35f7b702&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}