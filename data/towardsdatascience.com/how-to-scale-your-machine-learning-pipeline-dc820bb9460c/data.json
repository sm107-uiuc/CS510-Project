{"url": "https://towardsdatascience.com/how-to-scale-your-machine-learning-pipeline-dc820bb9460c", "time": 1682993528.5247848, "path": "towardsdatascience.com/how-to-scale-your-machine-learning-pipeline-dc820bb9460c/", "webpage": {"metadata": {"title": "How To Scale Your Machine Learning Pipeline | by Micha\u0142 Dankiewicz | Towards Data Science", "h1": "How To Scale Your Machine Learning Pipeline", "description": "This article presents the easiest way to turn your machine learning application from a simple Python program into a scalable pipeline that runs on a cluster. Some of the functions in your application\u2026"}, "outgoing_paragraph_urls": [{"url": "https://github.com/datarevenue-berlin/tac-example", "anchor_text": "Github repository", "paragraph_index": 1}, {"url": "http://luigi.readthedocs.io/", "anchor_text": "luigi", "paragraph_index": 8}, {"url": "https://luigi.readthedocs.io/en/stable/example_top_artists.html", "anchor_text": "Here", "paragraph_index": 14}, {"url": "http://localhost:8082/", "anchor_text": "http://localhost:8082", "paragraph_index": 19}, {"url": "https://portal.aws.amazon.com/billing/signup", "anchor_text": "here", "paragraph_index": 26}, {"url": "https://s3.console.aws.amazon.com/s3", "anchor_text": "here", "paragraph_index": 27}, {"url": "https://console.aws.amazon.com/iam/home#/security_credential", "anchor_text": "this site", "paragraph_index": 31}, {"url": "http://click.pocoo.org/6/", "anchor_text": "Click", "paragraph_index": 37}, {"url": "https://github.com/datarevenue-berlin/tac-example", "anchor_text": "example project", "paragraph_index": 41}, {"url": "https://github.com/datarevenue-berlin/tac-example/blob/master/tac/task-dummy.py", "anchor_text": "example project", "paragraph_index": 52}, {"url": "https://kubernetes.io/docs/setup/minikube/", "anchor_text": "Minikube", "paragraph_index": 56}, {"url": "https://kubernetes.io/docs/tasks/tools/install-minikube/", "anchor_text": "here", "paragraph_index": 57}, {"url": "http://www.datarevenue.com", "anchor_text": "www.datarevenue.com", "paragraph_index": 72}], "all_paragraphs": ["This article presents the easiest way to turn your machine learning application from a simple Python program into a scalable pipeline that runs on a cluster.", "Check out the Github repository for ready-to-use example code.", "Some of the functions in your application may be time consuming and return huge outputs, so if your pipeline fails along the way, for any reason, it\u2019s gonna cost you a lot of time and frustration to fix a small bug and rerun everything.", "Suppose your pipeline needs to do the following things:", "You could code the workflow like this:", "But this code is quite prone to errors, such as may occur while downloading the data \u2014 one network error, and all the work you\u2019ve done is lost. Moreover, if you download data for the last ten days today and you\u2019re planning to run the same pipeline again tomorrow, it doesn\u2019t make much sense to download 90% of necessary data all over again.", "So how can you avoid doing the same thing twice?", "Sure, you can come up with ideas on how to save and reuse intermediate results, but there\u2019s no need for you to code it yourself.", "I recommend using the luigi package. It lets you easily divide your code into separate data-processing units \u2013 called tasks \u2013 each with concrete requirements and output.", "One of your tasks could look like this:", "From this snippet, we can see that:", "I\u2019ve given a complete example of a dummy pipeline below. Take a moment to analyse how the tasks\u2019 dependencies create a logical pipeline:", "Now, when you try to run the MakePredictions task, Luigi will make sure all the upstream tasks run beforehand. Try installing Luigi with pip install luigi, save the above example in task-dummy.py, and run this command:", "Furthermore, Luigi won\u2019t run any task when its output is already present. Try running the same command again \u2014 Luigi will report that MakePredictions for a given date has already been done.", "Here you can find another good example that will help you get started with Luigi.", "Can I run multiple tasks at the same time?", "Yes, you can! Luigi provides this functionality out of the box. Just by adding--workers 4 to the command, for example, you\u2019re letting Luigi run four tasks simultaneously.", "Let\u2019s use this opportunity to present Luigi\u2019s graphical interface.", "Open a second terminal and run the following command:", "This will start a so-called central Luigi scheduler that listens on a default port 8082. You can check its pretty dashboard on your browser at: http://localhost:8082.", "Now go back to the first terminal \u2014 you can run the Luigi command again, this time without the --local-scheduler argument (don\u2019t forget to delete the files you\u2019ve already created or choose another date if you want to see the tasks executing). If you want parallelism, add --workers 4 to the command. After refreshing the dashboard page, you should see a list of scheduled tasks. Click on the tree icon next to the MakePredictions task to see all its dependencies (Isn\u2019t it pretty?):", "Now we\u2019re getting serious \u2014 if one machine is not enough for you to run your tasks in parallel, you can take your pipeline to the next level and deploy it on a cluster. I\u2019ll walk you through all the necessary steps.", "In the previous example, all the files were saved locally on the same machine the tasks were executed on.", "So how can I share files between multiple machines in the cluster?", "There are many answers to this question, but we\u2019ll focus on one of the possible ways \u2014 using Amazon\u2019s S3.", "AWS S3 is a Simple Storage Service. It lets you store your files in the cloud. Instead of /home/user/data/file.csv, you save your file under s3://bucket/data/file.csv. Python provides tools that make it easy to switch from local storage to S3.", "For the simplicity of this tutorial, if you want to follow the instructions below, I need you to set up a free AWS trial account you\u2019ll use for storing your files. You can do it here and it\u2019s completely free of charge for one year. You can opt out after this period if you don\u2019t need it anymore.", "After creating the account, go here and create a bucket. Think of a bucket as a partition on a hard drive.", "To read and write data from S3, we\u2019re gonna use luigi.contrib.s3.S3Target class. You can modify the dummy example by simply adding a proper import and replacing the LocalTarget in task definitions as I\u2019ve done here:", "You\u2019ll also need to remove all self.output().makedirs() calls, because you don\u2019t need to create folders on S3.", "To use Luigi\u2019s S3 functionality, you must pip install boto3.", "You\u2019ll also need to give your application credentials for S3 authentication. Let\u2019s use the simplest approach: you can create a new Access Key on this site. You\u2019ll get an Access Key ID and a Secret Access Key \u2014 save them in the environment variables AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY, respectively.", "Now your application should be able to read and write data to AWS S3. Try it out by running the pipeline again.", "Sadly, you can\u2019t put your Python code on a cluster and just execute it. However, you can run a certain command in a certain container.", "I\u2019ll show you how to refactor your pipeline to run each task in a separate Docker container.", "The first step towards running tasks in containers is making them runnable from the command line.", "What\u2019s the fastest way to write a CLI in Python?", "Answer: Click. Click is an awesome package that makes creating command line interfaces very easy.", "Let\u2019s get back to the TransformData task example (not the dummy one). Its run() method calls two functions \u2014 namely, transform_data and save_result. Let\u2019s say these functions are defined in the file called transform.py:", "Now let\u2019s enable the running of these functions from the command line:", "Here, we defined a function (cli) that will be called when we run this script from a command line. We specified that the first argument will be an output path, and all further arguments will make up a tuple of input paths. After running pip install click, we can invoke data transformation from the command line:", "For convenience, let\u2019s call our project tac (it doesn\u2019t matter why). If you add setup.py to your project and pip install it (take a look at example project to see how a project should be structured, and don\u2019t forget to add __init__.py to the package directory), you should be able to run your script with:", "How can I easily create a Docker container in which to run my command?", "First, create a requirements.txt file in the project root dir. You\u2019ll need the following packages:", "Now, create a Dockerfile in the project root dir and put this inside:", "Now you can build a Docker image containing your project by executing this from your project root dir (assuming you still have your AWS credentials in env variables):", "So you\u2019ve just built a Docker image tagged tac-example:v1. Let\u2019s see if it works:", "This should save a docker-output.csv file in your S3 bucket.", "If you want to run all \u2014 or just some \u2014 of your pipeline tasks in a cluster, Luigi comes with a solution.", "Long story short, Kubernetes is a system that can manage a cluster. If you want to interact with a cluster, talk to Kubernetes.", "To run a piece of code in a cluster, you need to provide the following information to Kubernetes:", "Let\u2019s modify our good old TransformData task from the dummy pipeline to conform to these requirements.", "You should end up with something similar to what you can see in the example project.", "But we can\u2019t run it until we connect to a cluster. Keep reading.", "How can I run my pipeline in a cluster \u2014 without having access to a cluster?", "The cool thing is, you actually can run a mini version of a real cluster on your laptop!", "You can do this with Minikube. Minikube runs a single-node (single-machine) cluster inside a Virtual Machine on your computer.", "Take a moment now to install Minikube. You can find instructions here. You\u2019re gonna need all the components mentioned in these instructions.", "After installation, you should be able to run", "to spin up your local cluster. Be patient, as this may take a while, especially when you do it for the first time. Verify that your cluster is running with", "You should see something similar to:", "If everything is okay, you should be able to access Kubernetes\u2019 dashboard, which shows the current status of your cluster:", "A new browser tab will open and show you this:", "Since the cluster runs in a separate (virtual) machine, it doesn\u2019t have access to your Docker image (since you haven\u2019t pushed it to any online registry). We\u2019ll use a little trick to overcome this.", "The following command will set your current console session to execute docker commands using not your local Docker Engine, but the cluster VM\u2019s Docker Engine:", "Now all you need to do is call the docker build command again. This time, your image will be built inside the VM:", "And here comes the moment of truth.", "We\u2019re gonna execute our pipeline inside the cluster we\u2019ve just configured.", "If everything went well, just calling the Luigi command should be enough. Minikube has already set the proper configuration, so KubernetesJobTask knows where the target Kubernetes is running.", "So try executing this command from the directory where task-dummy.py lives:", "and watch how your TransformTask job runs in the cluster:", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Machine Learning Engineer at Data Revenue \u2014 www.datarevenue.com"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fdc820bb9460c&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-scale-your-machine-learning-pipeline-dc820bb9460c&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-scale-your-machine-learning-pipeline-dc820bb9460c&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-scale-your-machine-learning-pipeline-dc820bb9460c&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-scale-your-machine-learning-pipeline-dc820bb9460c&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----dc820bb9460c--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----dc820bb9460c--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@dankiewicz.michal?source=post_page-----dc820bb9460c--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@dankiewicz.michal?source=post_page-----dc820bb9460c--------------------------------", "anchor_text": "Micha\u0142 Dankiewicz"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F13e36e46fcaa&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-scale-your-machine-learning-pipeline-dc820bb9460c&user=Micha%C5%82+Dankiewicz&userId=13e36e46fcaa&source=post_page-13e36e46fcaa----dc820bb9460c---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fdc820bb9460c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-scale-your-machine-learning-pipeline-dc820bb9460c&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fdc820bb9460c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-scale-your-machine-learning-pipeline-dc820bb9460c&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://github.com/datarevenue-berlin/tac-example", "anchor_text": "Github repository"}, {"url": "http://luigi.readthedocs.io/", "anchor_text": "luigi"}, {"url": "http://click.pocoo.org/6/", "anchor_text": "click"}, {"url": "http://luigi.readthedocs.io/", "anchor_text": "luigi"}, {"url": "https://luigi.readthedocs.io/en/stable/example_top_artists.html", "anchor_text": "Here"}, {"url": "http://localhost:8082/", "anchor_text": "http://localhost:8082"}, {"url": "https://portal.aws.amazon.com/billing/signup", "anchor_text": "here"}, {"url": "https://s3.console.aws.amazon.com/s3", "anchor_text": "here"}, {"url": "https://console.aws.amazon.com/iam/home#/security_credential", "anchor_text": "this site"}, {"url": "http://click.pocoo.org/6/", "anchor_text": "Click"}, {"url": "https://github.com/datarevenue-berlin/tac-example", "anchor_text": "example project"}, {"url": "https://github.com/datarevenue-berlin/tac-example/blob/master/tac/task-dummy.py", "anchor_text": "example project"}, {"url": "https://kubernetes.io/docs/setup/minikube/", "anchor_text": "Minikube"}, {"url": "https://kubernetes.io/docs/tasks/tools/install-minikube/", "anchor_text": "here"}, {"url": "http://luigi.readthedocs.io/en/stable/api/luigi.contrib.gcs.html", "anchor_text": "This module"}, {"url": "https://dask.readthedocs.io/en/latest/", "anchor_text": "Dask"}, {"url": "https://github.com/dask/dask-kubernetes", "anchor_text": "integrating it with Kubernetes"}, {"url": "https://www.datarevenue.com/en/blog/how-to-scale-your-machine-learning-pipeline", "anchor_text": "www.datarevenue.com"}, {"url": "https://medium.com/tag/docker?source=post_page-----dc820bb9460c---------------docker-----------------", "anchor_text": "Docker"}, {"url": "https://medium.com/tag/kubernetes?source=post_page-----dc820bb9460c---------------kubernetes-----------------", "anchor_text": "Kubernetes"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----dc820bb9460c---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/distributed-systems?source=post_page-----dc820bb9460c---------------distributed_systems-----------------", "anchor_text": "Distributed Systems"}, {"url": "https://medium.com/tag/data-pipeline?source=post_page-----dc820bb9460c---------------data_pipeline-----------------", "anchor_text": "Data Pipeline"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fdc820bb9460c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-scale-your-machine-learning-pipeline-dc820bb9460c&user=Micha%C5%82+Dankiewicz&userId=13e36e46fcaa&source=-----dc820bb9460c---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fdc820bb9460c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-scale-your-machine-learning-pipeline-dc820bb9460c&user=Micha%C5%82+Dankiewicz&userId=13e36e46fcaa&source=-----dc820bb9460c---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fdc820bb9460c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-scale-your-machine-learning-pipeline-dc820bb9460c&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----dc820bb9460c--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fdc820bb9460c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-scale-your-machine-learning-pipeline-dc820bb9460c&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----dc820bb9460c---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----dc820bb9460c--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----dc820bb9460c--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----dc820bb9460c--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----dc820bb9460c--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----dc820bb9460c--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----dc820bb9460c--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----dc820bb9460c--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----dc820bb9460c--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@dankiewicz.michal?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@dankiewicz.michal?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Micha\u0142 Dankiewicz"}, {"url": "https://medium.com/@dankiewicz.michal/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "24 Followers"}, {"url": "http://www.datarevenue.com", "anchor_text": "www.datarevenue.com"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F13e36e46fcaa&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-scale-your-machine-learning-pipeline-dc820bb9460c&user=Micha%C5%82+Dankiewicz&userId=13e36e46fcaa&source=post_page-13e36e46fcaa--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fusers%2F13e36e46fcaa%2Flazily-enable-writer-subscription&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-scale-your-machine-learning-pipeline-dc820bb9460c&user=Micha%C5%82+Dankiewicz&userId=13e36e46fcaa&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}