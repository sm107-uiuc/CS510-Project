{"url": "https://towardsdatascience.com/trying-androids-nnapi-ml-accelerator-with-object-detection-on-a-pixel-4-xl-5217caea64d4", "time": 1683012919.989462, "path": "towardsdatascience.com/trying-androids-nnapi-ml-accelerator-with-object-detection-on-a-pixel-4-xl-5217caea64d4/", "webpage": {"metadata": {"title": "Trying Android\u2019s NNAPI ML accelerator with Object Detection on a Pixel 4 XL | by Juan De Dios Santos | Towards Data Science", "h1": "Trying Android\u2019s NNAPI ML accelerator with Object Detection on a Pixel 4 XL", "description": "As the requirements for more private and fast, low-latency machine learning increases, so does the need for more accessible and on-device solutions capable of performing well on the so-called \u201cedge.\u201d\u2026"}, "outgoing_paragraph_urls": [{"url": "https://coral.ai/docs/edgetpu/benchmarks/", "anchor_text": "it can perform 4 trillion operations per second while consuming just 2W", "paragraph_index": 2}, {"url": "http://download.tensorflow.org/models/object_detection/ssdlite_mobiledet_edgetpu_320x320_coco_2020_05_19.tar.gz", "anchor_text": "link", "paragraph_index": 5}, {"url": "https://arxiv.org/abs/2004.14525", "anchor_text": "MobileDet", "paragraph_index": 5}, {"url": "https://www.tensorflow.org/lite/performance/post_training_quantization#dynamic_range_quantization", "anchor_text": "source", "paragraph_index": 5}, {"url": "https://arxiv.org/pdf/1405.0312.pdf", "anchor_text": "Lin et al.", "paragraph_index": 5}, {"url": "https://github.com/juandes/mobiledet-tflite-nnapi", "anchor_text": "https://github.com/juandes/mobiledet-tflite-nnapi", "paragraph_index": 9}, {"url": "https://juandes.com", "anchor_text": "https://juandes.com", "paragraph_index": 17}], "all_paragraphs": ["As the requirements for more private and fast, low-latency machine learning increases, so does the need for more accessible and on-device solutions capable of performing well on the so-called \u201cedge.\u201d Two of these solutions are the Pixel Neural Core (PNC) hardware and its Edge TPU architecture currently available on the Google Pixel 4 mobile phone, and The Android Neural Networks API (NNAPI), an API designed for executing machine learning operations on Android devices.", "In this article, I will show how I modified the TensorFlow Lite Object Detection demo for Android to use an Edge TPU optimized model running under the NNAPI on a Pixel 4 XL. Additionally, I want to present the changes I did to log the prediction latencies and compare those done using the default TensorFlow Lite API and the NNAPI. But before that, let me give a brief overview of the terms I\u2019ve introduced so far.", "The Pixel Neural Core, the successor of the previous Pixel Visual Core, is a domain-specific chip that\u2019s part of the Pixel 4 hardware. It\u2019s architecture, follows that of the Edge TPU (tensor processing unit), Google\u2019s machine learning accelerator for edge computing devices. Being a chip designed for \u201cthe edge\u201d means that it is smaller and more energy-efficient (it can perform 4 trillion operations per second while consuming just 2W) than its big counterparts you will find in Google\u2019s cloud platform.", "The Edge TPU, however, is not an overall accelerator for all kinds of machine learning. The hardware is designed to improve forward-pass operations, meaning that it excels as an inference engine and not as a tool for training. That\u2019s why you will mostly find applications where the model used on the device, was trained somewhere else.", "On the software side of things, we have the NNAPI. This Android API, written in C, provides acceleration for TensorFlow Lite models on devices that employ hardware accelerators such as the Pixel Visual Core and GPUs. The TensorFlow Lite framework for Android includes an NNAPI delegate, so don\u2019t worry, we won\u2019t write any C code.", "The model we will use for this project is the float32 version of the MobileDet object detection model optimized for the Edge TPU and trained on the COCO dataset (link). Let me quickly explain what these terms mean. MobileDet (Xiong et al.) is a very recent state-of-the-art family of lightweight object detection models for low computational power devices like mobile phones. This float32 variant means that it is not a quantized model, a model that has been transformed to reduce its size at the cost of model accuracy. On the other hand, a fully quantized model uses small weights based on 8 bits integers (source). Then, we have the COCO dataset, short for \u201cCommon Objects in Context\u201d (Lin et al.). This collection of images has over 200k labeled images separated across 90 classes that include \u201cbird, \u201ccat,\u201d \u201cperson,\u201d and \u201ccar.\u201d", "Now, after that bit of theory, let\u2019s take a look at the app.", "The app I used is based on the object detection example app for Android provided in the TensorFlow repository. However, I altered it to use the NNAPI and log to a file the inference times, data I used to compare the NNAPI and default TFLITE API\u2019s prediction time. Below is the DetectorActivity.java file, responsible for producing the detections \u2014 the complete source code is on my GitHub; I\u2019m just showing this file since it has the most changes. In this file, I changed the name of the model (after adding the MobileDet model to the assets directory), changed the variable TF_OD_API_INPUT_SIZE to reflect the input size of MobileDet and set TF_OD_API_IS_QUANTIZED to false since the model is not quantized. Besides this, I added two lists to collect the inference times of the predictions (one list per API), and an override onStop method to dump the lists to a file once the use closes the app. Other small changes I had to do was changing NUM_DETECTIONS from TFLiteObjectDetectionAPIModel.java from 10 to 100 and adding the WRITE_EXTERNAL_STORAGE permission to the Android manifest so that the app could write the files to the Documents directory.", "Another important change I did was commenting out \u2014 and thus, enabling \u2014 the toggle button that allows us to run the app using the NNAPI. By default, that part of code is commented, so it is not possible to activate the API from within the app; I might be wrong, though (please correct me if you find otherwise).", "You can find the complete source code behind the app in my GitHub repo at https://github.com/juandes/mobiledet-tflite-nnapi. To run it, open Android Studio, select \u201copen an existing Android Studio project,\u201d and select the project\u2019s root directory. Once the project is opened, click the small green hammer icon to build it. Then, click the play icon to run it either on a virtual device or on an actual device (if one is connected). If possible, use a real device.", "So, how fast is the app at detecting objects? To measure the latency, I added a small functionality that writes to files the prediction time (in milliseconds) of the inference made with the normal TFLITE and NNAPI. After that, I took the files and performed a little analysis in R to get the insights from the data. Below are the results.", "Figures 2 and 3 are histograms of the inference times under each API. The first one (n=909), corresponding to the default TFLITE API, has a peak around the 100 (ms.) mark and several extreme outliers at the higher end of the visualization. Figure 3 (n=1169), corresponding to predictions done using the NNAPI, has its peak around 50 ms. However, those extreme outlier values shift the mean value and the distribution towards the right. So, to better visualize the times, I removed these values and drew the same visualizations without them. Now, they look as follows:", "Better, right? The black vertical lines on both plots indicate the mean value. For the TFLITE graph, the mean inference time is 103 ms., the median is 100 ms. On the NNAPI side, the average prediction takes 55 ms. with a median of 54. Almost twice as fast.", "The following video shows the app in action. Here, I\u2019m simply pointing the phone at my computer to detect objects from a video:", "The advances of machine learning and, generally AI, are truly fascinating. First, they took over our computers and cloud, and now they are on their way to our mobile devices. Yet, there\u2019s a big difference between the latter and the platforms we traditionally use to deploy machine learning platforms. Smaller processors and battery dependencies are some of these. As a result, the development of frameworks and hardware specialized for this sort of device is increasing rapidly.", "Several of these tools are the Pixel Neural Core, Edge TPU, and NNAPI. This combination of hardware and software aims to bring highly efficient and accurate AI to our mobile devices. In this article, I presented an overview of these. Then, I showed how to update the TensorFlow Lite object detection example for Android to able the NNAPI and write to file the inference times. Using these files, I did a small analysis using R to visualize them and discovered that the predictions done with the NNAPI took around half the time that those done with the default API.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Data storyteller, Trust and Safety Software Engineer, and fan of quantifying my life. Also, I like Pokemon. https://juandes.com, @jdiossantos."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F5217caea64d4&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftrying-androids-nnapi-ml-accelerator-with-object-detection-on-a-pixel-4-xl-5217caea64d4&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftrying-androids-nnapi-ml-accelerator-with-object-detection-on-a-pixel-4-xl-5217caea64d4&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftrying-androids-nnapi-ml-accelerator-with-object-detection-on-a-pixel-4-xl-5217caea64d4&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftrying-androids-nnapi-ml-accelerator-with-object-detection-on-a-pixel-4-xl-5217caea64d4&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----5217caea64d4--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----5217caea64d4--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@juandes?source=post_page-----5217caea64d4--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@juandes?source=post_page-----5217caea64d4--------------------------------", "anchor_text": "Juan De Dios Santos"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F9b9998a144da&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftrying-androids-nnapi-ml-accelerator-with-object-detection-on-a-pixel-4-xl-5217caea64d4&user=Juan+De+Dios+Santos&userId=9b9998a144da&source=post_page-9b9998a144da----5217caea64d4---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F5217caea64d4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftrying-androids-nnapi-ml-accelerator-with-object-detection-on-a-pixel-4-xl-5217caea64d4&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F5217caea64d4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftrying-androids-nnapi-ml-accelerator-with-object-detection-on-a-pixel-4-xl-5217caea64d4&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "http://juandes.me/", "anchor_text": "me"}, {"url": "https://coral.ai/docs/edgetpu/benchmarks/", "anchor_text": "it can perform 4 trillion operations per second while consuming just 2W"}, {"url": "https://developer.android.com/ndk/guides/neuralnetworks", "anchor_text": "https://developer.android.com/ndk/guides/neuralnetworks"}, {"url": "http://download.tensorflow.org/models/object_detection/ssdlite_mobiledet_edgetpu_320x320_coco_2020_05_19.tar.gz", "anchor_text": "link"}, {"url": "https://arxiv.org/abs/2004.14525", "anchor_text": "MobileDet"}, {"url": "https://www.tensorflow.org/lite/performance/post_training_quantization#dynamic_range_quantization", "anchor_text": "source"}, {"url": "https://arxiv.org/pdf/1405.0312.pdf", "anchor_text": "Lin et al."}, {"url": "https://github.com/juandes/mobiledet-tflite-nnapi", "anchor_text": "https://github.com/juandes/mobiledet-tflite-nnapi"}, {"url": "https://github.com/juandes/mobiledet-tflite-nnapi", "anchor_text": "juandes/mobiledet-tflite-nnapiNOTE: This project was originally taken (and modified) from the official TensorFlow examples repository at\u2026github.com"}, {"url": "https://medium.com/tag/tensorflow?source=post_page-----5217caea64d4---------------tensorflow-----------------", "anchor_text": "TensorFlow"}, {"url": "https://medium.com/tag/android?source=post_page-----5217caea64d4---------------android-----------------", "anchor_text": "Android"}, {"url": "https://medium.com/tag/programming?source=post_page-----5217caea64d4---------------programming-----------------", "anchor_text": "Programming"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----5217caea64d4---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----5217caea64d4---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F5217caea64d4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftrying-androids-nnapi-ml-accelerator-with-object-detection-on-a-pixel-4-xl-5217caea64d4&user=Juan+De+Dios+Santos&userId=9b9998a144da&source=-----5217caea64d4---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F5217caea64d4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftrying-androids-nnapi-ml-accelerator-with-object-detection-on-a-pixel-4-xl-5217caea64d4&user=Juan+De+Dios+Santos&userId=9b9998a144da&source=-----5217caea64d4---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F5217caea64d4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftrying-androids-nnapi-ml-accelerator-with-object-detection-on-a-pixel-4-xl-5217caea64d4&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----5217caea64d4--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F5217caea64d4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftrying-androids-nnapi-ml-accelerator-with-object-detection-on-a-pixel-4-xl-5217caea64d4&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----5217caea64d4---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----5217caea64d4--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----5217caea64d4--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----5217caea64d4--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----5217caea64d4--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----5217caea64d4--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----5217caea64d4--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----5217caea64d4--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----5217caea64d4--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@juandes?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@juandes?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Juan De Dios Santos"}, {"url": "https://medium.com/@juandes/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "882 Followers"}, {"url": "https://juandes.com", "anchor_text": "https://juandes.com"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F9b9998a144da&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftrying-androids-nnapi-ml-accelerator-with-object-detection-on-a-pixel-4-xl-5217caea64d4&user=Juan+De+Dios+Santos&userId=9b9998a144da&source=post_page-9b9998a144da--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F8e4ad12e7160&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftrying-androids-nnapi-ml-accelerator-with-object-detection-on-a-pixel-4-xl-5217caea64d4&newsletterV3=9b9998a144da&newsletterV3Id=8e4ad12e7160&user=Juan+De+Dios+Santos&userId=9b9998a144da&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}