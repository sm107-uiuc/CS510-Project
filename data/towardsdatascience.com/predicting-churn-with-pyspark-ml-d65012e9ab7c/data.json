{"url": "https://towardsdatascience.com/predicting-churn-with-pyspark-ml-d65012e9ab7c", "time": 1683012587.517344, "path": "towardsdatascience.com/predicting-churn-with-pyspark-ml-d65012e9ab7c/", "webpage": {"metadata": {"title": "Predicting Churn with PySpark ML. Solving Classification Problems with\u2026 | by Estella Zhang | Towards Data Science", "h1": "Predicting Churn with PySpark ML", "description": "Customer retention is critical for a thriving business. When we are enjoying the digital services with one-click-to-subscribe, companies are pulling hairs out because someone just took one click to\u2026"}, "outgoing_paragraph_urls": [{"url": "https://github.com/estella-zzz/sparkify_churn_prediction", "anchor_text": "project git repo", "paragraph_index": 39}], "all_paragraphs": ["Customer retention is critical for a thriving business. When we are enjoying the digital services with one-click-to-subscribe, companies are pulling hairs out because someone just took one click to quit. If we can identify which users are at-risk to churn, then the business can take action and potentially make them stay.", "To make this happen, we need machine learning solutions that are not only accurate, but also powerful enough to process large data fast. Apache Spark is a big-data platform that fits this need. Data science pipelines deployed on Spark can utilize distributed systems like HDFS to increase the scalability of the model. Spark ML supports algorithms like Logistic Regression, Random Forest and other models that scale linearly.", "Sparkify is a music streaming service in the Udacity universe. Just like Spotify, users can choose free tier subscription with ads or paid tier without ads.", "In this project, we will predict users that are at-risk to churn based on Sparkify user data. We will first analyze the data on a smaller subset (128MB), then deploy the pipeline to cloud services like AWS EMR to tune selected models with the full dataset (12GB).", "The small dataset contains 286500 records and 18 fields:", "Since we are only interested in existing Sparkify users, we will exclude guest traffic or activities that are not tied to a userId, which leaves us with 225 distinct users.", "In this study, we define churn as a user cancelled the subscription and left Sparkify. When user submits cancellation, the record will have auth == 'Cancelled' and page == 'Cancellation Confirmation' . The cancellation is effective immediately.", "In the small dataset, 52 users have churned. The probability of churn is 23.11%.", "In addition to playing songs, users can also rate the songs, change settings and add friends. Are users with more interactions on Sparkify more sticky to the platform? Will users leave because they got too many songs they don\u2019t like in their feed?", "To answer these questions, we added interactions, thumbs_down to the features.", "The date range in the dataset is 2018-09-30 to 2018-12-02. We can see paid tier and free tier has similar numbers of user sessions and distinct user at the beginning, then both metrics increased over time for the paid tier as the metrics decreased for free users.", "How long will a user stay on Sparkify before they churn? From the histogram of user age at the time of churn, we can see most churns happens within 100 days after registration.", "After exploring the dataset, 11 features have been chosen for further analysis:", "User information: gender, user_age, paid_user, downgraded", "Activity measures: artists, songs, length, interactions, thumbs_down, total_session, session_gap", "To use the features in PySpark, the features are assembled into vectors, then normalized using StandardScaler:", "Data is then split into test and validation sets:", "Since we are predicting whether a user is at-risk to churn(1/0), the prediction is a classification problem. 4 classification algorithms are used for initial training:", "To find the best model and parameters, we use CrossValidator to evaluate the model performance and validate the robustness of the models. With numFolds = 3 , the CrossValidator generates 3 sets of training/testing pairs, each of which uses 2/3 of the data for training and 1/3 for testing. To evaluate a particular model/param selection, CrossValidator computes the average evaluation metrics for the 3 models fitted on the 3 train/test pairs.", "To evaluate the model, we compare the algorithms by the f1_score, accuracy, precision and recall of the model prediction on validation data.", "f1-score: The harmonic mean of the precision and recall.", "Accuracy: (True Positives + True Negatives)/All Predictions", "precision: True Positives / (True Positives + False Positive)", "recall: True Positives / (True Positives + False Negatives)", "Since we are working on a small dataset, we want a balanced model with both precision and recalls. We will use f1-score to choose the best model.", "Logistic Regression has the best performance with F-score = 0.83. It predicts 44% of churns in the validation set and 100% of the churn predictions are correct. From the coefficients, the top 5 features that have high impacts on churn are:", "Random Forest is also performing well with F-score = 0.73. Since RF has stronger predicting power in large datasets, it is worth tuning the Random Forest model with full data as well. From the random forest feature importances, the top 5 features are:", "LSVC does not work well on this data set. The recall is 0, which means it is not able to identify any churn.", "Gradient-Boosted Tree has a slightly better F-score than LSVC but also has the low recall issue.", "The churn outcome is imbalanced in our dataset (23%), which compromises the actual predicting power of models (see LSVC, blind assigning everything to 0 will still get a 0.6 f1-score).", "For logistic regression, there are multiple ways to handle imbalanced data. We will try two solutions for this study:", "We want to assign higher weights to the positives( cancelled == 1). Generating class weights:", "Re-fit the logistic regression model with classWeightCol:", "Wow! re-balancing the dataset with class weights works very well in the small dataset, which increased the f1-score to 0.85 and recall to 0.67.", "Another way to balance the data is to set different thresholds to make positive predictions.", "Find the best threshold by f-score in the current logistic regression model:", "The best threshold for the current model is 0.27. This seems a bit too strict and will potentially cause low precision in larger dataset. To test the effectiveness of different threshold, we can use paramGrid to fit the model with threshold in [0.3, 0.4, 0.5].", "AWS EMR(Elastic MapReduce) features a high-performance environment for Spark. As a next step, we will deploy our pipeline AWS EMR. Then we will be able to train the models with the full data as well as improve the models with hyperparameter tuning.", "What\u2019s your favorite churn prediction solution? Do you have any suggestions to make this project better? Please leave a comment below with your thoughts!", "All scripts and results are included in the project git repo.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "I use data to see the world beyond the horizon."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fd65012e9ab7c&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-churn-with-pyspark-ml-d65012e9ab7c&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-churn-with-pyspark-ml-d65012e9ab7c&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-churn-with-pyspark-ml-d65012e9ab7c&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-churn-with-pyspark-ml-d65012e9ab7c&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----d65012e9ab7c--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----d65012e9ab7c--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@kxestella.zzz?source=post_page-----d65012e9ab7c--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@kxestella.zzz?source=post_page-----d65012e9ab7c--------------------------------", "anchor_text": "Estella Zhang"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F95a3d8ed47df&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-churn-with-pyspark-ml-d65012e9ab7c&user=Estella+Zhang&userId=95a3d8ed47df&source=post_page-95a3d8ed47df----d65012e9ab7c---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fd65012e9ab7c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-churn-with-pyspark-ml-d65012e9ab7c&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fd65012e9ab7c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-churn-with-pyspark-ml-d65012e9ab7c&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@franki?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Franki Chamaki"}, {"url": "https://unsplash.com/s/photos/machine-learning?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Unsplash"}, {"url": "https://github.com/estella-zzz/sparkify_churn_prediction", "anchor_text": "project git repo"}, {"url": "https://github.com/estella-zzz/sparkify_churn_prediction", "anchor_text": "Project git repo"}, {"url": "https://spark.apache.org/docs/latest/api/python/pyspark.ml.html?highlight=stringindexer#pyspark.ml.classification.LogisticRegression", "anchor_text": "PySpark ML Documentation"}, {"url": "https://stackoverflow.com/questions/33372838/dealing-with-unbalanced-datasets-in-spark-mllib", "anchor_text": "Class Weight with PySpark ML"}, {"url": "https://aws.amazon.com/emr/features/spark/", "anchor_text": "Apache Spark on Amazon EMR"}, {"url": "https://medium.com/tag/maching-learning?source=post_page-----d65012e9ab7c---------------maching_learning-----------------", "anchor_text": "Maching Learning"}, {"url": "https://medium.com/tag/classification?source=post_page-----d65012e9ab7c---------------classification-----------------", "anchor_text": "Classification"}, {"url": "https://medium.com/tag/spark?source=post_page-----d65012e9ab7c---------------spark-----------------", "anchor_text": "Spark"}, {"url": "https://medium.com/tag/data-science?source=post_page-----d65012e9ab7c---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/udacity?source=post_page-----d65012e9ab7c---------------udacity-----------------", "anchor_text": "Udacity"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fd65012e9ab7c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-churn-with-pyspark-ml-d65012e9ab7c&user=Estella+Zhang&userId=95a3d8ed47df&source=-----d65012e9ab7c---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fd65012e9ab7c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-churn-with-pyspark-ml-d65012e9ab7c&user=Estella+Zhang&userId=95a3d8ed47df&source=-----d65012e9ab7c---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fd65012e9ab7c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-churn-with-pyspark-ml-d65012e9ab7c&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----d65012e9ab7c--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fd65012e9ab7c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-churn-with-pyspark-ml-d65012e9ab7c&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----d65012e9ab7c---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----d65012e9ab7c--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----d65012e9ab7c--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----d65012e9ab7c--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----d65012e9ab7c--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----d65012e9ab7c--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----d65012e9ab7c--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----d65012e9ab7c--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----d65012e9ab7c--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@kxestella.zzz?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@kxestella.zzz?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Estella Zhang"}, {"url": "https://medium.com/@kxestella.zzz/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "5 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F95a3d8ed47df&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-churn-with-pyspark-ml-d65012e9ab7c&user=Estella+Zhang&userId=95a3d8ed47df&source=post_page-95a3d8ed47df--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F904bd4b75822&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-churn-with-pyspark-ml-d65012e9ab7c&newsletterV3=95a3d8ed47df&newsletterV3Id=904bd4b75822&user=Estella+Zhang&userId=95a3d8ed47df&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}