{"url": "https://towardsdatascience.com/using-attention-for-medical-image-segmentation-dd78825eaac6", "time": 1683006842.751392, "path": "towardsdatascience.com/using-attention-for-medical-image-segmentation-dd78825eaac6/", "webpage": {"metadata": {"title": "Using attention for medical image segmentation | by L\u00e9o Fillioux | Towards Data Science", "h1": "Using attention for medical image segmentation", "description": "The attention mechanism has been among the hottest areas of deep learning research over the last few years, starting with natural language processing and more recently in computer vision tasks. In\u2026"}, "outgoing_paragraph_urls": [{"url": "https://arxiv.org/pdf/1804.03999.pdf", "anchor_text": "this paper", "paragraph_index": 3}, {"url": "https://towardsdatascience.com/u-net-b229b32b4a71", "anchor_text": "this article", "paragraph_index": 3}, {"url": "https://arxiv.org/pdf/1906.02849.pdf", "anchor_text": "second architecture", "paragraph_index": 13}, {"url": "https://en.wikipedia.org/wiki/Bilinear_interpolation", "anchor_text": "bilinear interpolation", "paragraph_index": 14}], "all_paragraphs": ["The attention mechanism has been among the hottest areas of deep learning research over the last few years, starting with natural language processing and more recently in computer vision tasks. In this article, we will focus on how attention has impacted most recent architectures for medical image segmentation. For this, we will describe the architectures presented in two recent papers and try to give some intuition as to what happens, in the hope that it will give you some ideas of how you can apply attention to your own problem. We will also see simple PyTorch implementations.", "Segmentation of medical images differs from natural images on two main points :", "Note: of course, both the code and explanations are simplifications of the complex architectures described in the papers, the aim is mostly to give an intuition and a good idea of what is done and not to explain every detail.", "UNet is the go-to architecture for segmentation and most of the current advances in segmentation use this architecture as a backbone. In this paper, the authors propose a way to apply the attention mechanism to a standard UNet. If you want a refresher of how a standard UNet works, this article does a perfect job.", "The architecture uses the standard UNet as a backbone, and the contracting path is not changed. What changes is the expanding path, and more precisely, the attention mechanism is integrated into the skip connections.", "To explain how a block of the expanding path works, let\u2019s call g the input to this block coming from the previous block, and x the skip connection coming from the expanding path. The following equations sum up how this block works.", "The upsample block is pretty straight forward, and the ConvBlock is simply a sequence of two (convolution + batch norm + ReLU) blocks. The only block left to explain is the attention block.", "In a UNet, the contracting path can be seen as an encoder and the expanding path as a decoder. What is interesting about the UNet is the fact that the skip connections allows for features extracted by the encoder to be used directly during the decoder. This way, when \u201creconstructing\u201d the mask of the image, the network learns to use these features, because the features of the contracting path are concatenated with those of the expanding path.", "Applying an attention block before this concatenation allows for the network to put more weight on the features of the skip connection that will be relevant. It allows for the direct connection to focus on a particular part of the input, rather than feeding in every feature.", "The attention distribution is multiplied by the skip connection feature map to only keep the important parts. This attention distribution is extracted from what is called the query (the input) and the values (the skip connection). The attention operations allow for a selective picking of the information contained in the values. This selection is based on the query.", "To summarize : the input and skip connection are used to decide what parts of the skip connection to focus on. Then we use this subset of the skip connection, along with the input in a standard expanding path.", "The following code defines (a simplified version of) the attention block and the \u201cup-block\u201d that is used for the expanding path of the UNet. The \u201cdown-block\u201d is unchanged from the original UNet.", "Note : the ConvBatchNorm is a sequence of a Conv2d, BatchNorm2d and a ReLU activation function.", "The second architecture we will talk about, is a bit more original than the first one. It does not rely on a UNet architecture, but on feature extraction followed by guided attention blocks.", "The first part is to extract the features from the image. For this, the input image is fed to a pretrained ResNet, and we extract the feature maps at 4 different levels. This is interesting as low level features tend to be present at the beginning of the network and high level features towards the end of the network, so we will have access to features at multiple scales. All feature maps are upsampled to the size of the biggest one using bilinear interpolation. This gives us 4 feature maps of the same size, which are concatenated and fed into a convolutional block. The output of this convolutional block (the multi-scale feature map) is concatenated with each of the 4 feature maps, to give us the input of the attention blocks, which are a bit more complex than the previous ones.", "The guided attention block relies on the position and channel attention modules, which we will start by describing.", "We\u2019ll try to understand what is going on in these modules, but we won\u2019t go into too much detail of every operation in these two blocks (which can be understood by the code section below).", "These two blocks are actually very similar, the only differences between them reside in the operations which tries to extract either information from the channel or the position. Applying a convolution before flattening gives more importance to the position because the number of channels is diminished during the convolution. In the channel attention module, more weight is given to the channels as the original number of channels is kept during the reshape operation.", "In each block, it is important to notice that the top two branches are in charge of extracting the specific attention distribution. For example, in the position attention module, we have a (W*H)x(W*H) attention distribution, where the (i, j) element tells us how much position i impacts position j. In the channel block, we have a CxC attention distribution which tells us how much one channel impacts another. In the third branch of each module, this specific attention distribution is multiplied by a transformation of the input to get the channel or position attention distribution. As in the previous article, the attention distribution is then multiplied by the input to extract the relevant information of the input, given the multi-scale feature context. The outputs of both these modules are then summed element-wise to give the final self-attention features. Now let\u2019s see how the output of these two modules are used in the global framework.", "Guided attention is built from a succession of multiple refinement steps for each scale (4 scales in the proposed architecture). The input feature map is fed to the position and channel output module, which outputs a single feature map. It is also passed through an autoencoder, which produces a reconstructed version of the input. In each block, the attention map is produced by a multiplication these two outputs. This attention map is then multiplied by the multi-scale feature map produced previously. The output, therefore, represents which parts of the multi-scale we should focus on, given the specific scale on which we are working. You can then have a sequence of such guided attention modules, by concatenating the output of one block with the multi-scale attention map and giving this as the input to the following block.", "Two additional losses are necessary here to ensure that the refinement steps work correctly :", "Each attention feature is then passed through a convolution block to predict the mask. To produce the final prediction, an average of the four masks is taken, which can be seen as a sort of ensembling of the model for various scales fo features.", "As this architecture is much more complex than the previous one, it can be hard to understand what is going on behind the attention modules. Here is how I understand the contribution of the various blocks.", "The position attention module tries to specify which position of the specific scale features to focus on, based on the multi-scale representation of the input image. The channel attention module does the same thing, by specifying how much to pay attention to which channel. The specific operations used in either block is what gives more importance to the channel or the position information in the attention distribution. Combining both modules gives us an attention map giving a score to each position-channel pair, i.e. each element of the feature map.", "The autoencoder is used to make sure that the latent-representation of the feature map is not completely changed from on step to the other. As the latent space is lower-dimensional, only the key information will be extracted. We do not want this information to be changed from one refinement step to the next, we only want small adjustments to be made. These won\u2019t be seen in the latent representation.", "The use of a sequence of guided attention modules allows for the final attention map to be refined and to progressively make noise vanish and give more weight to the really important regions.", "Ensembling a few such networks with multiple scales allows for the network to have a vision of both global and local features. These features are then combined into a multi-scale feature map. Applying attention to the multi-scale feature maps along with each specific scale allows to better understand which features bring more value to the final output.", "So, what can be taken away from these articles? Attention can be seen as a mechanism that helps to point out to the networks, which extracted features to focus on, based on the context.", "In the UNet, this means, which features extracted during the contracting path we should pay more attention to, given the features extracted during the expanding path. This helps to give more sense to the skip connections, i.e. pass relevant information rather than every extracted feature. In the second article, which multi-scale features should we focus on, given the current scale on which we are working.", "The general idea can be applied to a wide range of problems, and I think that seeing multiple examples can help to better understand how attention can be adapted.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fdd78825eaac6&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-attention-for-medical-image-segmentation-dd78825eaac6&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-attention-for-medical-image-segmentation-dd78825eaac6&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-attention-for-medical-image-segmentation-dd78825eaac6&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-attention-for-medical-image-segmentation-dd78825eaac6&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----dd78825eaac6--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----dd78825eaac6--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@leo.fillioux?source=post_page-----dd78825eaac6--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@leo.fillioux?source=post_page-----dd78825eaac6--------------------------------", "anchor_text": "L\u00e9o Fillioux"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F2f8cb63d7c7a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-attention-for-medical-image-segmentation-dd78825eaac6&user=L%C3%A9o+Fillioux&userId=2f8cb63d7c7a&source=post_page-2f8cb63d7c7a----dd78825eaac6---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fdd78825eaac6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-attention-for-medical-image-segmentation-dd78825eaac6&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fdd78825eaac6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-attention-for-medical-image-segmentation-dd78825eaac6&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/photos/5081CW5tuz0", "anchor_text": "Peter Kasprzyk"}, {"url": "https://unsplash.com", "anchor_text": "Unsplash"}, {"url": "https://arxiv.org/pdf/1804.03999.pdf", "anchor_text": "this paper"}, {"url": "https://towardsdatascience.com/u-net-b229b32b4a71", "anchor_text": "this article"}, {"url": "https://arxiv.org/pdf/1804.03999.pdf", "anchor_text": "Attention UNet : learning where to look for the Pancreas"}, {"url": "https://arxiv.org/pdf/1804.03999.pdf", "anchor_text": "Attention UNet: learning where to look for the Pancreas"}, {"url": "https://arxiv.org/pdf/1906.02849.pdf", "anchor_text": "second architecture"}, {"url": "https://arxiv.org/pdf/1906.02849.pdf", "anchor_text": "Multi-scale self-guided attention for medical image segmentation"}, {"url": "https://en.wikipedia.org/wiki/Bilinear_interpolation", "anchor_text": "bilinear interpolation"}, {"url": "https://arxiv.org/pdf/1906.02849.pdf", "anchor_text": "Multi-scale self-guided attention for medical image segmentation"}, {"url": "https://arxiv.org/pdf/1906.02849.pdf", "anchor_text": "Multi-scale self-guided attention for medical image segmentation"}, {"url": "https://medium.com/tag/attention?source=post_page-----dd78825eaac6---------------attention-----------------", "anchor_text": "Attention"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----dd78825eaac6---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/tag/medical-imaging?source=post_page-----dd78825eaac6---------------medical_imaging-----------------", "anchor_text": "Medical Imaging"}, {"url": "https://medium.com/tag/segmentation?source=post_page-----dd78825eaac6---------------segmentation-----------------", "anchor_text": "Segmentation"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----dd78825eaac6---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fdd78825eaac6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-attention-for-medical-image-segmentation-dd78825eaac6&user=L%C3%A9o+Fillioux&userId=2f8cb63d7c7a&source=-----dd78825eaac6---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fdd78825eaac6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-attention-for-medical-image-segmentation-dd78825eaac6&user=L%C3%A9o+Fillioux&userId=2f8cb63d7c7a&source=-----dd78825eaac6---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fdd78825eaac6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-attention-for-medical-image-segmentation-dd78825eaac6&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----dd78825eaac6--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fdd78825eaac6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-attention-for-medical-image-segmentation-dd78825eaac6&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----dd78825eaac6---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----dd78825eaac6--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----dd78825eaac6--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----dd78825eaac6--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----dd78825eaac6--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----dd78825eaac6--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----dd78825eaac6--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----dd78825eaac6--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----dd78825eaac6--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@leo.fillioux?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@leo.fillioux?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "L\u00e9o Fillioux"}, {"url": "https://medium.com/@leo.fillioux/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "28 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F2f8cb63d7c7a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-attention-for-medical-image-segmentation-dd78825eaac6&user=L%C3%A9o+Fillioux&userId=2f8cb63d7c7a&source=post_page-2f8cb63d7c7a--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F8b489e81fc5b&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-attention-for-medical-image-segmentation-dd78825eaac6&newsletterV3=2f8cb63d7c7a&newsletterV3Id=8b489e81fc5b&user=L%C3%A9o+Fillioux&userId=2f8cb63d7c7a&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}