{"url": "https://towardsdatascience.com/how-to-create-a-datablock-for-multispectral-satellite-image-segmentation-with-the-fastai-v2-bc5e82f4eb5", "time": 1683012328.8107488, "path": "towardsdatascience.com/how-to-create-a-datablock-for-multispectral-satellite-image-segmentation-with-the-fastai-v2-bc5e82f4eb5/", "webpage": {"metadata": {"title": "How to create a DataBlock for Multispectral Satellite Image Segmentation with the Fastai-v2 | by Maur\u00edcio Cordeiro | Towards Data Science", "h1": "How to create a DataBlock for Multispectral Satellite Image Segmentation with the Fastai-v2", "description": "A step by step guide with code and data on how to create a DataBlock for multispectral satellite image segmentation with the Fastai-v2 library."}, "outgoing_paragraph_urls": [{"url": "https://youtu.be/oQaoj6LE5E4", "anchor_text": "available on YouTube", "paragraph_index": 0}, {"url": "http://cordmaur.carrd.co/", "anchor_text": "cordmaur.carrd.co", "paragraph_index": 0}, {"url": "https://www.fast.ai/2020/02/13/fastai-A-Layered-API-for-Deep-Learning/", "anchor_text": "Fastai", "paragraph_index": 1}, {"url": "https://medium.com/analytics-vidhya/how-to-create-a-custom-dataset-loader-in-pytorch-from-scratch-for-multi-band-satellite-images-c5924e908edf", "anchor_text": "here", "paragraph_index": 3}, {"url": "https://medium.com/analytics-vidhya/creating-a-very-simple-u-net-model-with-pytorch-for-semantic-segmentation-of-satellite-images-223aa216e705", "anchor_text": "here", "paragraph_index": 3}, {"url": "https://github.com/cordmaur/Fastai2-Medium", "anchor_text": "GitHub", "paragraph_index": 4}, {"url": "https://github.com/cordmaur/Fastai2-Medium/blob/master/01_Create_Datablock.ipynb", "anchor_text": "here", "paragraph_index": 4}, {"url": "https://dev.fast.ai/", "anchor_text": "https://dev.fast.ai", "paragraph_index": 5}, {"url": "https://medium.com/analytics-vidhya/a-simple-cloud-detection-walk-through-using-convolutional-neural-network-cnn-and-u-net-and-bc745dda4b04", "anchor_text": "story", "paragraph_index": 6}, {"url": "https://medium.com/analytics-vidhya/creating-training-patches-for-deep-learning-image-segmentation-of-satellite-sentinel-2-imagery-d3dd368c9c64", "anchor_text": "Creating training patches for Deep Learning Image Segmentation of Satellite (Sentinel 2) Imagery using the Google Earth Engine (GEE)", "paragraph_index": 6}, {"url": "https://github.com/cordmaur/Fastai2-Medium", "anchor_text": "https://github.com/cordmaur/Fastai2-Medium", "paragraph_index": 7}, {"url": "https://github.com/cordmaur/Fastai2-Medium", "anchor_text": "https://github.com/cordmaur/Fastai2-Medium", "paragraph_index": 24}, {"url": "https://www.linkedin.com/in/cordmaur/", "anchor_text": "https://www.linkedin.com/in/cordmaur/", "paragraph_index": 27}], "all_paragraphs": ["For information about the course Introduction to Python for Scientists (available on YouTube) and other articles like this, please visit my website cordmaur.carrd.co.", "Fastai is an open source deep learning library that adds higher level functionalities to PyTorch and makes it easier to achieve state-of-the-art results with little coding.", "The vision module is really handy when we need to quickly create an image dataset, apply data augmentations, resize, crop or even overlay a segmentation mask (Figure 1). However, all this simplification comes with a cost. Most of these higher level APIs for computer vision are optimized to RGB images, and these image libraries don\u2019t support multispectral or multichannel images.", "In recent years, due to an increase in data accessibility, Earth Observation researchers have been paying a lot of attention on deep learning techniques, like image recognition, image segmentation, object detection, among others. [1]. The problem is that satellite imagery, usually composed by many different spectral bands (wavelengths), doesn\u2019t fit in most vision libraries used by the deep learning community. For that reason, I have been working directly with PyTorch to create the dataset (here) and train the \u201chome-made\u201d U-Net architecture (here).", "With the upcoming of Fastai-v2 (promised to be released in next weeks)[2], I would like to test if it was possible to use it\u2019s Data Block structure to create a multispectral image dataset to train a U-Net model. That\u2019s more advanced than my previous stories as we have to create some custom subclasses, but I tried to make it as simple as possible. The notebook with all the code is available in the GitHub project (notebook here).", "Before we start, it\u2019s necessary to install fastai2 library, following the installation guide at https://dev.fast.ai.", "To continue, we will need some training patches as multispectral images. That could be a Kaggle dataset, as the 38-cloud dataset, used in this story, or a completely new one. In the story Creating training patches for Deep Learning Image Segmentation of Satellite (Sentinel 2) Imagery using the Google Earth Engine (GEE), I show how to create training patches from Google Earth Engine and consume them as NumPy arrays.", "For this tutorial, I made it available in the GitHub repository (https://github.com/cordmaur/Fastai2-Medium), under /data folder, a few sample patches from Or\u00f3s reservoir in Brazil. Data is saved as NumPy\u2019s arrays and separated in two folders /data/images for the multispectral patches and /data/labels for the target masks.", "As we can see from the output, the images were cropped in 366x366 pixels and the training patches have 13 channels. These are the 12 Sentinel-2 bands, in order, and I have added an additional band to indicate \u201cno data\u201d flag. Channels have been put in the first axis, as it is the standard for PyTorch and Fastai, differently from other image libraries. Mask values are 0-No water, 1-Water and 2-Water Shadow. We will check an image sample using Matplotlib. For this, we need to move the channels axes to the last position using Numpy.transpose and select the corresponding Red, Green and Blue axis.", "Now that we have checked our images, we need a way of opening them in Fastai. As Fastai uses the Python Imaging Library (PIL), it is not able to handle multispectral images like these. We will, then, inherit a new class called MSTensorImage from the original TensorImage that is capable of opening .npy extensions and showing it visually. Let\u2019s get to the code.", "First, we define a function that opens Numpy arrays and returns it as a given class (open_npy function).", "Then, we define the MSTensorImage class with a create method that receives the filename (or the numpy array, or a tensor), the desired channels (if we wouldn\u2019t want to load all 13 channels) and a flag indicating whether the channels are in the first axis or not.", "At last, we define a show method to correctly display this image. We can pass to the show method different channels to create false color composites and Matplotlib axes for multiple display. In the following example, we can see that the image was correctly loaded and displayed.", "To handle the mask, instead of creating a new class, as we did previously, we will use the TensorMask class already defined in Fastai2. The only difference, in this case, is that the TensorMask, doesn\u2019t know how to open .npy extensions. In this case, we will create it passing the result of our newly defined open_npy function, like so.", "The DataBlock is an abstraction to provide transformations to your source data to fit your model. Remember that in order to train a neural net, we have to provide the model a set of inputs (Xs) and corresponding targets (Ys). The cost and the optimization functions will take care of the rest. More complex architectures could have multiple Xs as inputs and even multiple targets, so the DataBlock accepts multiple pipelines (Figure 2).", "In our case, that is the most common, we need to create a DataBlock that provides only two blocks, Xs and Ys. For each block we can create a TransformBlock (that\u2019s like a processing pipe) that manipulates each group (Xs or Ys) until they reach the desired format for loading into the model.", "To create a DataBlock, besides the TransformBlocks, we have to provide a function responsible to get the items, given a source. In our example, as the files are already saved in disk, the get_items function will just read the directory and return the file_names. The list of files will be the starting point of our transformations pipes.", "If the mask is created from the same original file (for example, if the mask was the 14th channel), the X transformation pipeline would be responsible to exclude this channel and the Y transformation pipeline would be responsible to extract this information from the original image. As we have the files saved separately, we will provide a new function called get_lbl_fn that will receive the name of the image file and then return the name of the corresponding target file. Now that we have some understanding of the DataBlock, let\u2019s go to the code.", "The last command, DataBlock.summary, will check if everything is working fine and give us a data sample:", "As we can see in the results, the final sample, after processing all the transformations, is composed of a tuple with 2 items (X, Y). In our case the (MSTensorImage, TensorMask).", "Once we are done creating the DataBlock the creation of a DataSet or a DataLoader are very straightforward. The datasets will be splitted, considering the splitter function (in our case, a random splitter with 10% for validation), into training and validation datasets, and the data can be accessed directly by subscripting:", "The same is valid for DataLoaders. Additionally the show_batch method automatically understands that we are performing a segmentation task (because of the TensorMask class) and overlays Xs and Ys:", "In today\u2019s story we saw the basic concepts and how to use the Fastai 2\u2019s DataBlock to prepare the multispectral satellite data to fit a deep learning model. The subclassing of the TensorImage class and the use of the open_npy function were enough to handle the multiple channels. As one can note, the basic functionalities of Fastai to create a dataloader and show a batch sample were successfully preserved.", "The fact of using Fastai 2 for these Earth Observation tasks is really handy, as differently from Fastai 1 and other high level APIs, Fastai 2\u2019s built-in vision architectures accepts input channels as a parameter. But that\u2019s a subject for a next story.", "The notebook and sample data to follow this \u201chow-to\u201d is available at the GitHub repository https://github.com/cordmaur/Fastai2-Medium.", "See you in the next story.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Ph.D. Geospatial Data Scientist and water specialist at Brazilian National Water and Sanitation Agency. To get in touch: https://www.linkedin.com/in/cordmaur/"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fbc5e82f4eb5&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-a-datablock-for-multispectral-satellite-image-segmentation-with-the-fastai-v2-bc5e82f4eb5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-a-datablock-for-multispectral-satellite-image-segmentation-with-the-fastai-v2-bc5e82f4eb5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-a-datablock-for-multispectral-satellite-image-segmentation-with-the-fastai-v2-bc5e82f4eb5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-a-datablock-for-multispectral-satellite-image-segmentation-with-the-fastai-v2-bc5e82f4eb5&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----bc5e82f4eb5--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----bc5e82f4eb5--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://cordmaur.medium.com/?source=post_page-----bc5e82f4eb5--------------------------------", "anchor_text": ""}, {"url": "https://cordmaur.medium.com/?source=post_page-----bc5e82f4eb5--------------------------------", "anchor_text": "Maur\u00edcio Cordeiro"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F8878c77fe1a3&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-a-datablock-for-multispectral-satellite-image-segmentation-with-the-fastai-v2-bc5e82f4eb5&user=Maur%C3%ADcio+Cordeiro&userId=8878c77fe1a3&source=post_page-8878c77fe1a3----bc5e82f4eb5---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fbc5e82f4eb5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-a-datablock-for-multispectral-satellite-image-segmentation-with-the-fastai-v2-bc5e82f4eb5&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fbc5e82f4eb5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-a-datablock-for-multispectral-satellite-image-segmentation-with-the-fastai-v2-bc5e82f4eb5&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://youtu.be/oQaoj6LE5E4", "anchor_text": "available on YouTube"}, {"url": "http://cordmaur.carrd.co/", "anchor_text": "cordmaur.carrd.co"}, {"url": "https://www.fast.ai/2020/02/13/fastai-A-Layered-API-for-Deep-Learning/", "anchor_text": "Fastai"}, {"url": "https://www.fast.ai/images/fastai_paper/show_batch_seg.png", "anchor_text": "https://www.fast.ai/images/fastai_paper/show_batch_seg.png"}, {"url": "https://medium.com/analytics-vidhya/how-to-create-a-custom-dataset-loader-in-pytorch-from-scratch-for-multi-band-satellite-images-c5924e908edf", "anchor_text": "here"}, {"url": "https://medium.com/analytics-vidhya/creating-a-very-simple-u-net-model-with-pytorch-for-semantic-segmentation-of-satellite-images-223aa216e705", "anchor_text": "here"}, {"url": "https://github.com/cordmaur/Fastai2-Medium", "anchor_text": "GitHub"}, {"url": "https://github.com/cordmaur/Fastai2-Medium/blob/master/01_Create_Datablock.ipynb", "anchor_text": "here"}, {"url": "https://dev.fast.ai/", "anchor_text": "https://dev.fast.ai"}, {"url": "https://medium.com/analytics-vidhya/a-simple-cloud-detection-walk-through-using-convolutional-neural-network-cnn-and-u-net-and-bc745dda4b04", "anchor_text": "story"}, {"url": "https://medium.com/analytics-vidhya/creating-training-patches-for-deep-learning-image-segmentation-of-satellite-sentinel-2-imagery-d3dd368c9c64", "anchor_text": "Creating training patches for Deep Learning Image Segmentation of Satellite (Sentinel 2) Imagery using the Google Earth Engine (GEE)"}, {"url": "https://github.com/cordmaur/Fastai2-Medium", "anchor_text": "https://github.com/cordmaur/Fastai2-Medium"}, {"url": "https://github.com/cordmaur/Fastai2-Medium", "anchor_text": "https://github.com/cordmaur/Fastai2-Medium"}, {"url": "https://doi.org/10.3390/rs12101667", "anchor_text": "https://doi.org/10.3390/rs12101667"}, {"url": "https://doi.org/10.3390/info11020108", "anchor_text": "https://doi.org/10.3390/info11020108"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----bc5e82f4eb5---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/tag/remote-sensing?source=post_page-----bc5e82f4eb5---------------remote_sensing-----------------", "anchor_text": "Remote Sensing"}, {"url": "https://medium.com/tag/multispectral?source=post_page-----bc5e82f4eb5---------------multispectral-----------------", "anchor_text": "Multispectral"}, {"url": "https://medium.com/tag/fastai?source=post_page-----bc5e82f4eb5---------------fastai-----------------", "anchor_text": "Fastai"}, {"url": "https://medium.com/tag/image-segmentation?source=post_page-----bc5e82f4eb5---------------image_segmentation-----------------", "anchor_text": "Image Segmentation"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fbc5e82f4eb5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-a-datablock-for-multispectral-satellite-image-segmentation-with-the-fastai-v2-bc5e82f4eb5&user=Maur%C3%ADcio+Cordeiro&userId=8878c77fe1a3&source=-----bc5e82f4eb5---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fbc5e82f4eb5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-a-datablock-for-multispectral-satellite-image-segmentation-with-the-fastai-v2-bc5e82f4eb5&user=Maur%C3%ADcio+Cordeiro&userId=8878c77fe1a3&source=-----bc5e82f4eb5---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fbc5e82f4eb5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-a-datablock-for-multispectral-satellite-image-segmentation-with-the-fastai-v2-bc5e82f4eb5&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----bc5e82f4eb5--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fbc5e82f4eb5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-a-datablock-for-multispectral-satellite-image-segmentation-with-the-fastai-v2-bc5e82f4eb5&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----bc5e82f4eb5---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----bc5e82f4eb5--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----bc5e82f4eb5--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----bc5e82f4eb5--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----bc5e82f4eb5--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----bc5e82f4eb5--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----bc5e82f4eb5--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----bc5e82f4eb5--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----bc5e82f4eb5--------------------------------", "anchor_text": ""}, {"url": "https://cordmaur.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://cordmaur.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Maur\u00edcio Cordeiro"}, {"url": "https://cordmaur.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "1.7K Followers"}, {"url": "https://www.linkedin.com/in/cordmaur/", "anchor_text": "https://www.linkedin.com/in/cordmaur/"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F8878c77fe1a3&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-a-datablock-for-multispectral-satellite-image-segmentation-with-the-fastai-v2-bc5e82f4eb5&user=Maur%C3%ADcio+Cordeiro&userId=8878c77fe1a3&source=post_page-8878c77fe1a3--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fa9b1761194a9&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-create-a-datablock-for-multispectral-satellite-image-segmentation-with-the-fastai-v2-bc5e82f4eb5&newsletterV3=8878c77fe1a3&newsletterV3Id=a9b1761194a9&user=Maur%C3%ADcio+Cordeiro&userId=8878c77fe1a3&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}