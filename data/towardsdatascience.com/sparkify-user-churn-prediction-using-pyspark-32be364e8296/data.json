{"url": "https://towardsdatascience.com/sparkify-user-churn-prediction-using-pyspark-32be364e8296", "time": 1683000118.032098, "path": "towardsdatascience.com/sparkify-user-churn-prediction-using-pyspark-32be364e8296/", "webpage": {"metadata": {"title": "Sparkify user churn prediction using Pyspark | by Jiew Wan Tan | Towards Data Science", "h1": "Sparkify user churn prediction using Pyspark", "description": "User churn (cancellation) prediction is an imperative predictive tool. This project sets to solve this problem for a music streaming service: Sparkify. By exploring Sparkify usage data, the project\u2026"}, "outgoing_paragraph_urls": [{"url": "https://towardsdatascience.com/understanding-confusion-matrix-a9ad42dcfd62", "anchor_text": "confusion matrix", "paragraph_index": 18}, {"url": "https://en.wikipedia.org/wiki/Computational_complexity", "anchor_text": "computation complexity", "paragraph_index": 21}, {"url": "https://en.wikipedia.org/wiki/Time_complexity", "anchor_text": "time complexity", "paragraph_index": 23}, {"url": "https://github.com/jiewwantan/Churn_prediction_Sparkify", "anchor_text": "Github repository.", "paragraph_index": 36}], "all_paragraphs": ["User churn (cancellation) prediction is an imperative predictive tool. This project sets to solve this problem for a music streaming service: Sparkify. By exploring Sparkify usage data, the project identifies features for model learning. For computation efficiency reason, a tiny dataset (240Mb), a sample of the full dataset (12Gb) is used for initial data exploration, feature engineering and modelling experimentation on a local machine.", "The initial work on the tiny dataset shall identify the most suitable model and hyperparameters for the full dataset to train the final model . Once features and model are identified, they will be used for modelling the full dataset on AWS EMR. Assuming the sample dataset represents the population dataset, hyperparameters tuned by the sample dataset shall generalise well and applicable to modelling on the full dataset too. We will see if this assumption can help save some computation resource without having to grid search on big data.", "The actionable insight gained from churn prediction will identify users who are likely to churn and send them offers that hopefully keep them from clicking cancellation confirmation.", "The dataset schema below shows the dataset structure and the columns available for feature engineering. From EDA, we shall identify what features to engineer.", "\u201cChurn\u201d label is generated from the dataset by identifying users who confirm their subscription cancellation. Once churned users are identified, we can see how it behaves with other columns in the dataset:", "From the bar charts above, with 3 main data columns (Churn status, subscription level and gender) sorted differently, we can see that data are skewed towards one end and as such distributed rather unevenly. Non-churn users are much more that churn user, so are gender and subscription level. This is an important point to note for model learning and metric selection.", "Figure 2a and 2c show that user upgrades are distributed more evenly than user downgrades.", "User locations scattered widely and are rather sparse in almost all locations. Unless locations can be grouped into categories of geographical locations, this may not be helpful for modelling. Intuitively, we can extract state codes from the locations\u2019 last two characters to create a categorical feature for state.", "Page visits are also heavily skewed away from \u201cNextSong\u201d where most interactions concentrate. With this removed, user page interaction distribution could have been more obvious. The pages that capture users\u2019 behaviour are likely \u201cAdd Friend\u201d, \u201cAdd to playlist\u201d, \u201cCancellation confirmation\u201d (adopted for \u201cChurn\u201d label generation), \u201cDowngrade\u201d, \u201cRoll advert\u201d (helpful for ads display insight), \u201cSubmit Downgrade\u201d, \u201cSubmit Upgrade\u201d, \u201cThumbs Down\u201d and \u201cThumbs Up\u201d. Among these, \u201cAdd Friend\u201d and \u201cAdd to playlist\u201d shall be be adopted for feature engineering. The other columns are likely helpful in predictions other than churn.", "Aggregating user counts by hour of the day, the streaming service looks to have more users from late evenings towards after mid night. However, user churn do not look to have an obvious trend with regards to hour of the day.", "Page visits arranged by hour of the day share similar insight as its user count counterpart with a more prominent trend.", "The day of the week plots show more user engagement during weekdays.", "Instead of aggregating data by day or hour, we can also look at how trend evolves over the period of the dataset. Although the tiny dataset has only two months of data to explore, the insights revealed here are rather interesting. Its periodical trend agrees with weekday plots in which users engaged more towards midweek. It also shows how user behaviour changes over the two-months period: less churn and more upgrades. We need more info to know how many upgrades are from existing and new users as well as its causal factor.", "If computational resource allows, it will be even more interesting to see how this trend evolves in the full dataset.", "After exploratory data analysis, 10 features hypothetically assumed to play a part in determining user churn were engineered. Following that, feature importance as a result of model training will determine what model and features to be adopted for full dataset modelling.", "As a result, a Spark dataframe is created with 10 features and 1 label:", "The dataframe is split into 80% for training, 20% for testing.", "Modelling is done with 3-fold cross-validation of the training set and grid searching of best hyperparameters for four classifiers. Best models are identified with evaluation results and feature importance for each classifier:", "F1 score is adopted as the criteria for model selection as it considers both recall and precision. The dataset has a disproportionate distribution of label and binary features. F1 score will ensure that our model is not confused by a mis-classified confusion matrix: classifying 100 % True for a dataset with 95% True label to achieve 95% accuracy rate, doesn\u2019t matter the 5% False positives.", "With an F1 score of 0.8622, Gradient boosting tree is selected to be used for modelling the large dataset with the following hyperparameters:", "Training the large dataset by 3 x AWS EMR m3.xlarge instances took about 160 mins and produced the following evaluation result on its test set:", "Due to difference in computation complexity for different learning, optimisation or even data wrangling algorithms, performing tasks on a tiny dataset and a large dataset can impose significant difference in time and resources. As such it is imperative to have a good sense of varied algorithms\u2019 computation complexity to have a good judgement in task allocation (local vs distributed computing).", "It is expensive to perform exploratory data analysis (EDA) in the cloud. A comprehensive EDA on a large dataset like this will easily costs US$25 of EC2 and EMR charges per round. As such it is important to have a good understanding of the dataset by performing local EDA, deciding what should be hypothesised and what shouldn\u2019t of the large dataset before engaging cloud service to perform modelling.", "Grid-search is a computational expensive task to perform on a large dataset. To tune the right hyperparameters on a large dataset, it is easily an O(n-square) if not O(n-power) time complexity problem. Randomised search can be a faster and cheaper alternative for some performance trade-off. One smarter implementation of hyperparameter tuning is to combine random search and grid search:", "A comparison of hyperparameter tuning with and without grid search comparison, the modelling evaluation results above shows that the trade-off between model performance and computational resources is mixed for the four classifiers experimented. We save almost half of the Logistic regression training time without grid search for no difference in model performance improvement. For GradientBoosting Tree (GBT)the performance improvement with grid search is substantial: F1 score of 0.8622 (with grid search) vs 0.8158 (without grid search). However its computation took almost 3 hours more with grid search. GBT is certainly a high computational complexity algorithm that increases exponentially as dataset increase in size. The grid search was done on a 240Mb dataset, imagine if it was done on a 12Gb dataset!", "In comparison, Decision Tree and Random Forest\u2019s trade off is more linear, a minor performance improvement with minor increase in computation demand. Therefore by knowing a learning algorithm\u2019s computation complexity, we can make wiser decision to achieve an optimum performance vs computation trade off.", "There are certainly some statistical differences (see below for statistical comparison) between the features generated by the tiny and large dataset and as such the evaluation result are considerably different: 0.862 (tiny dataset) vs 0.725 (full dataset). The following provides a glimpse of the two datasets that could probably explain the model performance difference:", "3. Total number of songs listened", "4. Total number of artist listened", "5. Number of songs in playlist(s) added by user", "6. Number of friends added by user", "7. Total length of listening time", "8. Average number of songs per session", "10. Number of session per user", "On hindsight, I could have made a mixed of right and wrong decisions when it comes to assumption made on the large dataset: what features to engineer, what model and hyperparameter to tune in training. Retrospectively, there should be rooms for improvement for a better trained big data predictive model that yield more promising evaluation result with minimum computation time and resources. Among these are:", "For research beyond this project, aside from churn prediction, the dataset can be useful to identify more factors that cause and if not improve the promising trends shown in Figure 9 and 10.", "The source of this project is available from my Github repository.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Systems architect trained in data science & quantitative analysis. Generates solutions to business and investment problems using advanced learning algorithms."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F32be364e8296&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsparkify-user-churn-prediction-using-pyspark-32be364e8296&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsparkify-user-churn-prediction-using-pyspark-32be364e8296&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsparkify-user-churn-prediction-using-pyspark-32be364e8296&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsparkify-user-churn-prediction-using-pyspark-32be364e8296&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----32be364e8296--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----32be364e8296--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@jiewwantan?source=post_page-----32be364e8296--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@jiewwantan?source=post_page-----32be364e8296--------------------------------", "anchor_text": "Jiew Wan Tan"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fc3e3acabee1c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsparkify-user-churn-prediction-using-pyspark-32be364e8296&user=Jiew+Wan+Tan&userId=c3e3acabee1c&source=post_page-c3e3acabee1c----32be364e8296---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F32be364e8296&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsparkify-user-churn-prediction-using-pyspark-32be364e8296&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F32be364e8296&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsparkify-user-churn-prediction-using-pyspark-32be364e8296&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "http://www.freepik.com", "anchor_text": "Designed by Freepik"}, {"url": "https://towardsdatascience.com/understanding-confusion-matrix-a9ad42dcfd62", "anchor_text": "confusion matrix"}, {"url": "https://en.wikipedia.org/wiki/Computational_complexity", "anchor_text": "computation complexity"}, {"url": "https://en.wikipedia.org/wiki/Time_complexity", "anchor_text": "time complexity"}, {"url": "https://github.com/jiewwantan/Churn_prediction_Sparkify", "anchor_text": "Github repository."}, {"url": "https://www.kdnuggets.com/2019/05/churn-prediction-machine-learning.html", "anchor_text": "Customer Churn Prediction Using Machine Learning: Main Approaches and Models"}, {"url": "https://blog.markgrowth.com/eliminating-churn-is-growth-hacking-2-0-47a380194a06", "anchor_text": "Eliminating Churn Is Growth Hacking 2.0"}, {"url": "https://neilpatel.com/blog/improve-by-predicting-churn/", "anchor_text": "How to Improve Your Subscription Based Business by Predicting Churn"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----32be364e8296---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/apache-spark?source=post_page-----32be364e8296---------------apache_spark-----------------", "anchor_text": "Apache Spark"}, {"url": "https://medium.com/tag/churn-prediction?source=post_page-----32be364e8296---------------churn_prediction-----------------", "anchor_text": "Churn Prediction"}, {"url": "https://medium.com/tag/pyspark?source=post_page-----32be364e8296---------------pyspark-----------------", "anchor_text": "Pyspark"}, {"url": "https://medium.com/tag/aws-emr?source=post_page-----32be364e8296---------------aws_emr-----------------", "anchor_text": "Aws Emr"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F32be364e8296&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsparkify-user-churn-prediction-using-pyspark-32be364e8296&user=Jiew+Wan+Tan&userId=c3e3acabee1c&source=-----32be364e8296---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F32be364e8296&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsparkify-user-churn-prediction-using-pyspark-32be364e8296&user=Jiew+Wan+Tan&userId=c3e3acabee1c&source=-----32be364e8296---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F32be364e8296&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsparkify-user-churn-prediction-using-pyspark-32be364e8296&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----32be364e8296--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F32be364e8296&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsparkify-user-churn-prediction-using-pyspark-32be364e8296&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----32be364e8296---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----32be364e8296--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----32be364e8296--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----32be364e8296--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----32be364e8296--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----32be364e8296--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----32be364e8296--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----32be364e8296--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----32be364e8296--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@jiewwantan?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@jiewwantan?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Jiew Wan Tan"}, {"url": "https://medium.com/@jiewwantan/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "26 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fc3e3acabee1c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsparkify-user-churn-prediction-using-pyspark-32be364e8296&user=Jiew+Wan+Tan&userId=c3e3acabee1c&source=post_page-c3e3acabee1c--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F4203aab39b47&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsparkify-user-churn-prediction-using-pyspark-32be364e8296&newsletterV3=c3e3acabee1c&newsletterV3Id=4203aab39b47&user=Jiew+Wan+Tan&userId=c3e3acabee1c&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}