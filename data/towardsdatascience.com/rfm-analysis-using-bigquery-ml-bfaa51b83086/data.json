{"url": "https://towardsdatascience.com/rfm-analysis-using-bigquery-ml-bfaa51b83086", "time": 1683010202.309636, "path": "towardsdatascience.com/rfm-analysis-using-bigquery-ml-bfaa51b83086/", "webpage": {"metadata": {"title": "RFM Analysis using BigQuery ML. User Segmentation using RFM analysis in\u2026 | by muffaddal qutbuddin | Towards Data Science", "h1": "RFM Analysis using BigQuery ML", "description": "Tutorial on RFM analysis of Google Analytics data using BigQuery."}, "outgoing_paragraph_urls": [{"url": "https://towardsdatascience.com/send-google-analytics-hit-level-data-to-bigquery-5093e2db481b", "anchor_text": "google analytics data stored in BigQuery", "paragraph_index": 0}, {"url": "http://medium.com", "anchor_text": "medium.com", "paragraph_index": 5}, {"url": "https://bit.ly/3vTZdGH", "anchor_text": "If you need help with RFM Analysis reach me out here", "paragraph_index": 10}, {"url": "https://datastudio.google.com/u/1/reporting/3be5f079-bee9-4407-ac41-da91d1510c2d/page/GqBTB", "anchor_text": "created a template", "paragraph_index": 33}, {"url": "https://towardsdatascience.com/automate-data-import-to-google-analytics-471de2c3fc76", "anchor_text": "a detailed guide on how to set up GA import data pipeline", "paragraph_index": 43}, {"url": "https://bit.ly/3vTZdGH", "anchor_text": "Let\u2019s talk!", "paragraph_index": 65}, {"url": "https://www.linkedin.com/in/muffaddal-qutbuddin/", "anchor_text": "https://www.linkedin.com/in/muffaddal-qutbuddin/", "paragraph_index": 67}], "all_paragraphs": ["Suppose you want to remarket your users for conversions and reactivations by creating segments based on their website app activities using the google analytics data stored in BigQuery.", "In this guide, I will show how to implement one of the popular techniques to segment users, and visualize the results to help make important marketing decisions.", "The technique we will go through is RFM analysis. We will be using BigQuery ml to create segments and the data studio to visualize the results. Here is how it will look.", "First, calculate the recency, frequency, and monetary value of users.Second, create customer segments using k-means clustering algorithm.Third, visualize the results in the data studio.Fourth, import RFM-analysis results to Google Analytics for activationsFifth, automate RFM analysis process.", "One of the customer segmentation strategies is to create user cohorts using RFM analysis. It is based on the user\u2019s past activities. It uses three metrics to perform segmentation:", "Mainly used for purchases but RFM analysis can also be tailored to use for other important user activities such as the number of pages viewed instead of the number of times purchased for a content-based business like medium.com.", "The benefit of RFM analysis is that since users were segmented based on their past activities we have a pretty good idea about their affinity towards the business and each segment can be targeted accordingly.", "So as an example a user who frequently purchases from the website, and his average purchase amount is also high we instantly know that this is a loyal customer and should be used to spread the word of mouth. While on the other hand a user segment who had recently purchased but is not frequent can be offered a discount offer to help him get used to the product more.", "In order to calculate RFM analysis, we will need three metrics namely user id (GA client id in our case), conversion event date (purchase event date in our case), and the amount paid on purchase event.", "Note: I will assume that your data is in the format depicted above. If not then you either have to transform your data in the above format or modify the below query.", "If you need help with RFM Analysis reach me out here.", "First, we will calculate the recency, frequency, and monetary values of each user using the query below.", "Replace <your table > on line 9 with your data table name and run the above query should get you the recency, frequency, and monetary value for each of your users. Let\u2019s call this query 1", "The output of the query will look something like this:", "Save the output of the query as the Big Query data table named RFM_Valuesas shown below", "Next, we apply k-means clustering to group our users based on their RFM values.", "Using BigQuery ml we can apply machine learning models directly to the data set within BigQuery. And customer segmentation using BigQuery ml is also fairly simple.", "To use BigQuery ML algorithm start your SQL query with the command CREATE OR REPLACE MODEL. This tells BigQuery to apply the machine learning algorithm (mentioned in the options command) to the out of the query.", "Here is how to apply k-means clustering using BigQuery ML on the result we got from our last query:", "Update devtest.Demo.RFM_Model with the name of your table where you want to store the model's output and update project and dataset values at line 10. Run the query and you will get a new table created in your dataset. We call this our query 2.", "Navigate to the Evaluation tab of your modeled table to view statistics. It should look something like this:", "Centroid id column, tells in which segment the model grouped our users in to. And count demonstrate the number of users in each of the segments.", "If we put our discerning eyes on recency, frequency, and monetary columns we can exam on what ground the model grouped all the users.", "For example 4th segment in Centroid id column are users who didn\u2019t use the app frequently and neither they were recently active. However, their purchasing power is the highest among other segments.", "On the other hand, the 1st segment users were similarly active as 4th segment users but their purchasing power is a bit low.", "Since both of these users have not used our website for more than 2 months (average 74 days) they have likely churned and we should plan a marketing strategy to get them back.", "Note: Given my data model yielded the best segments with 5 clusters (see line 4 in the query). It may be different in your case so examine the results with the different number of clusters to see which gives you the best segments.", "Once we have created our segments it\u2019s time to join it back to the user_id so that we can use it to retarget them.", "Here is the query to do it:", "Note: I have named each segment as segment 1, 2, and so on at line 15 above, but I will advise giving them a proper name such as loyal users, potential users, lost users, etc.", "We call our last query as query 3", "here is how the result looks like:", "Save it as a BigQuery table RFM_Final which will be used for analysis and dashboarding.", "Next up is to connect our RFM_Final table to Data Studio and visualized the results. I went ahead and created a template dashboard based on our final data table.", "It shows the average for all recency, frequency, and monetary values at the top. Ideally, average recency should be minimum, and frequency and monetary values should be maximum so having a KPI indicator at the top helps to see the app\u2019s current standing.", "After that, the dashboard breaks down each of the three metrics by segments to help understand there spread with the ability to filter the report allows us to examine each segment thoroughly.", "Data studio\u2019s blending can also be used to connect these segments with the user\u2019s other activities to enrich the report and to further dig down in behavioral analysis.", "And the best part is that our dashboard will auto-update whenever RFM_Final table is updated. We will also see how to automate the RFM analysis to update the user segments on a timely basis. More on this later.", "Note: The template was built with google sheets and not with BigQuery to avoid the cost but It should be reusable with BigQuery connector as well.", "Now you have your users segmented and visualized. Some of those will be high paying loyal users while some will be lost users that needed to be heavily targeted to reactivate them. So next is to market them with different campaigns and promotions.", "Idea is to send the segment associated with each user to google analytics and from there create an audience and target them as you like using Google Ads. So we have to send our enriched data to google analytics.", "We can leverage GCP here as well. Doing so makes all our data in one platform. We have to set up a data pipeline to import the data to google analytics. To set up the pipeline enter the following command in the cloud shell to install all the required dependencies:", "Once installed all we have to do is move the data from RMF_Final table to cloud storage and the data will be imported to GA automatically!", "Here is a detailed guide on how to set up GA import data pipeline.", "The data pipeline continues to watch the folder mentioned during the installation in the cloud storage bucket and when it sees any new file uploaded pipeline processes it and sends it to google analytics.", "Running all three queries, discussed above, will get you updated segments for your user base whenever you want. But we can also automate this manual process so that the segments get updated monthly/quarterly depending upon the business needs.", "Note: The automation process requires a bit of programming knowledge so you might have to ask a technical person in your team to implement the automation process.", "We have three queries that are needed to be run in a timely fashion to create segments out of the user base. First, that calculates RFM values (Query 1). Second, that creates the model(Query 2). Third, that merges model output with users RFM values(Query 3).", "Idea is to chain all three queries so that completion of one query executes another.", "Here is how the data flow looks like:", "Note: I will assume that tables for all three queries have already been created as shown in the above sections.", "1- Let\u2019s start by first creating a Pub/Sub topic as it will be needed while creating query 1 schedular. I have named it RFM_Model_Topic as it will trigger the cloud function responsible for executing our model query (i.e query 2).", "Copy the topic name as it will be needed while creating query 1 schedular.", "2- Next, go to BigQuery, paste the query 1, that calculates RFM values for our users, in the query editor, and click the \u2018Schedule query\u2019 button to create new query schedular.", "3- Then, enter the required values in the scheduler creation menu to create the scheduler", "What this schedular will do is it will run on the specified time to calculate user's recency, frequency, and monetary values and store in the mentioned BigQuery table. Once the schedule is done executing the query it will send a message to our RFM_Model_Topic which will trigger a cloud function to trigger our model query. So let\u2019s create a cloud function now.", "4- Go to RFM_Model_Topicpub/sub topi and click \u2018Trigger Cloud Function\u2019 Button at the top of the screen.", "5- Enters settings as shown below and name the cloud function as RFM_Model_Function", "6- And paste below code in index.js file", "Once our BigQuery is executed we send a publish message to a new pub/sub topic named RFM_Final which triggers cloud function responsible for our last query that combines both RFM values and model results in one data set.", "7- Therefore, next, create RFM_Model topic in pub/sub and a cloud function as we did in the last step. Copy-paste below code in cloud function so that it can run our last query.", "We automated the RFM analysis process that will update our dashboard automatically by the start of every month.", "Targeting segmented users by personalized marketing results in increased retention, conversion rates, and revenue. RFM analysis creates cohorts of users based on their activities on the website/application.", "In this guide, we performed RFM analysis all using SQL queries by leveraging BigQuery ML and visualized the results in the data studio. We also touched on how the segmented users can be targeted by importing data to Google analytics. Lastly, we set up the data pipeline to automate the entire RFM analysis process so that we can get updated segments of users on a monthly basis.", "I hope I was able to convey the idea that with little efforts how much we can extract information out form the data that we have. And how effective it can be to support and improve the business.", "Need help with RFM analysis? Let\u2019s talk!", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Muffaddal has around 6 years of experience working with web analytics and user behavior data. https://www.linkedin.com/in/muffaddal-qutbuddin/"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fbfaa51b83086&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Frfm-analysis-using-bigquery-ml-bfaa51b83086&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Frfm-analysis-using-bigquery-ml-bfaa51b83086&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Frfm-analysis-using-bigquery-ml-bfaa51b83086&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Frfm-analysis-using-bigquery-ml-bfaa51b83086&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----bfaa51b83086--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----bfaa51b83086--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://muffaddal-qutbuddin.medium.com/?source=post_page-----bfaa51b83086--------------------------------", "anchor_text": ""}, {"url": "https://muffaddal-qutbuddin.medium.com/?source=post_page-----bfaa51b83086--------------------------------", "anchor_text": "muffaddal qutbuddin"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F13dafa14dc1c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Frfm-analysis-using-bigquery-ml-bfaa51b83086&user=muffaddal+qutbuddin&userId=13dafa14dc1c&source=post_page-13dafa14dc1c----bfaa51b83086---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fbfaa51b83086&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Frfm-analysis-using-bigquery-ml-bfaa51b83086&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fbfaa51b83086&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Frfm-analysis-using-bigquery-ml-bfaa51b83086&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://pixabay.com/users/geralt-9301/?utm_source=link-attribution&utm_medium=referral&utm_campaign=image&utm_content=1233873", "anchor_text": "Gerd Altmann"}, {"url": "https://pixabay.com/?utm_source=link-attribution&utm_medium=referral&utm_campaign=image&utm_content=1233873", "anchor_text": "Pixabay"}, {"url": "https://towardsdatascience.com/send-google-analytics-hit-level-data-to-bigquery-5093e2db481b", "anchor_text": "google analytics data stored in BigQuery"}, {"url": "http://medium.com", "anchor_text": "medium.com"}, {"url": "https://bit.ly/3vTZdGH", "anchor_text": "If you need help with RFM Analysis reach me out here"}, {"url": "https://datastudio.google.com/u/1/reporting/3be5f079-bee9-4407-ac41-da91d1510c2d/page/GqBTB", "anchor_text": "created a template"}, {"url": "https://github.com/GoogleCloudPlatform/cloud-for-marketing.git", "anchor_text": "https://github.com/GoogleCloudPlatform/cloud-for-marketing.git"}, {"url": "https://towardsdatascience.com/automate-data-import-to-google-analytics-471de2c3fc76", "anchor_text": "a detailed guide on how to set up GA import data pipeline"}, {"url": "https://bit.ly/3vTZdGH", "anchor_text": "Let\u2019s talk!"}, {"url": "https://towardsdatascience.com/user-segmentation-based-on-purchase-history-490c57402d53", "anchor_text": "Target Users With Products Based On Their Purchasing PowerImprove ad campaign by segmenting users based on their purchase behavior.towardsdatascience.com"}, {"url": "https://towardsdatascience.com/send-google-analytics-hit-level-data-to-bigquery-5093e2db481b", "anchor_text": "Send Google Analytics Hit Level Data to BigQueryHow to send standard Google Analytics hit level data to BigQuery.towardsdatascience.com"}, {"url": "https://towardsdatascience.com/automate-data-import-to-google-analytics-471de2c3fc76", "anchor_text": "Send Segmented Users Data to Google Analytics For Reactivation.Set up a data pipeline to import data to google analytics using Google Cloud Platfrom.towardsdatascience.com"}, {"url": "https://towardsdatascience.com/comprehensive-guide-on-item-based-recommendation-systems-d67e40e2b75d", "anchor_text": "Enhance User Experience with Personalized RecommendationsThis guide will show in detail how item-based recommendation system works and how to implement it in real work\u2026towardsdatascience.com"}, {"url": "https://medium.com/tag/segmentation?source=post_page-----bfaa51b83086---------------segmentation-----------------", "anchor_text": "Segmentation"}, {"url": "https://medium.com/tag/marketing?source=post_page-----bfaa51b83086---------------marketing-----------------", "anchor_text": "Marketing"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----bfaa51b83086---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/bigquery?source=post_page-----bfaa51b83086---------------bigquery-----------------", "anchor_text": "Bigquery"}, {"url": "https://medium.com/tag/analysis?source=post_page-----bfaa51b83086---------------analysis-----------------", "anchor_text": "Analysis"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fbfaa51b83086&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Frfm-analysis-using-bigquery-ml-bfaa51b83086&user=muffaddal+qutbuddin&userId=13dafa14dc1c&source=-----bfaa51b83086---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fbfaa51b83086&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Frfm-analysis-using-bigquery-ml-bfaa51b83086&user=muffaddal+qutbuddin&userId=13dafa14dc1c&source=-----bfaa51b83086---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fbfaa51b83086&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Frfm-analysis-using-bigquery-ml-bfaa51b83086&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----bfaa51b83086--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fbfaa51b83086&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Frfm-analysis-using-bigquery-ml-bfaa51b83086&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----bfaa51b83086---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----bfaa51b83086--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----bfaa51b83086--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----bfaa51b83086--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----bfaa51b83086--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----bfaa51b83086--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----bfaa51b83086--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----bfaa51b83086--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----bfaa51b83086--------------------------------", "anchor_text": ""}, {"url": "https://muffaddal-qutbuddin.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://muffaddal-qutbuddin.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "muffaddal qutbuddin"}, {"url": "https://muffaddal-qutbuddin.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "357 Followers"}, {"url": "https://www.linkedin.com/in/muffaddal-qutbuddin/", "anchor_text": "https://www.linkedin.com/in/muffaddal-qutbuddin/"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F13dafa14dc1c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Frfm-analysis-using-bigquery-ml-bfaa51b83086&user=muffaddal+qutbuddin&userId=13dafa14dc1c&source=post_page-13dafa14dc1c--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fe2e482d68f4c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Frfm-analysis-using-bigquery-ml-bfaa51b83086&newsletterV3=13dafa14dc1c&newsletterV3Id=e2e482d68f4c&user=muffaddal+qutbuddin&userId=13dafa14dc1c&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}