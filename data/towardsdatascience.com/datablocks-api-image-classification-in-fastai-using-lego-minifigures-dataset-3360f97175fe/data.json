{"url": "https://towardsdatascience.com/datablocks-api-image-classification-in-fastai-using-lego-minifigures-dataset-3360f97175fe", "time": 1683013983.3924532, "path": "towardsdatascience.com/datablocks-api-image-classification-in-fastai-using-lego-minifigures-dataset-3360f97175fe/", "webpage": {"metadata": {"title": "Datablocks API & Image Classification in fastai using Lego Minifigures Dataset | by Vinayak Nayak | Towards Data Science", "h1": "Datablocks API & Image Classification in fastai using Lego Minifigures Dataset", "description": "Image Classification has been a very common task since time immemorial however it wasn\u2019t until Deep Learning that computers were proficient at doing this task. With the advent of Convolutional Neural\u2026"}, "outgoing_paragraph_urls": [{"url": "https://www.kaggle.com/ihelon/lego-minifigures-classification", "anchor_text": "obtained from Kaggle here.", "paragraph_index": 4}, {"url": "https://docs.fast.ai/callback.core#", "anchor_text": "refer here", "paragraph_index": 20}], "all_paragraphs": ["The topics covered in this post are as follows", "You can click on any topic above to navigate to the respective section", "Image Classification has been a very common task since time immemorial however it wasn\u2019t until Deep Learning that computers were proficient at doing this task. With the advent of Convolutional Neural Networks this task has become so good that in recent years computers have also beat humans in few classification applications. Building a model to do image classification (MNIST digit recognition) marks the start of the deep learning journey for many beginners. Let\u2019s therefore do the same only let\u2019s make it even more exciting by using a dataset curated on Kaggle called LEGO Minifigures classification.", "fastai developed by Jeremy Howard and Sylvain Gugger is a library built on top of PyTorch for deep learning practitioners to ease the process of building/training and inferring from DL models. With relatively a very short code, you can build state of the art models for almost all tasks (classification, regression (on both structured & unstructured data), collaborative filtering etc.)using this library; that\u2019s the amount of effort that has gone into making it. So let\u2019s leverage it to our benefit and start with this task of image classification.", "We have images of 27 different mini-figures built by Lego which are obtained from Kaggle here. We have to build a classifier which when given an image of a particular minifigure can tell which superhero/character it is. Let\u2019s read in the dataset and have a look at few entries from the same.", "As we can see that the index file holds the information required to load the data that needs to be fed to the model and the metadata contains information about the different classes.", "When we take a close look at the minifigures, it is observed that both class_id 1 and class_id 17 represent SPIDER-MAN. The SPIDER-MAN from class_id 17 is from a marvel superheroes collection and is therefore renamed accordingly to MARVEL SPIDER-MAN. Once that\u2019s done, we can then join the index and metadata files on the class_id as primary key.", "Also, the DataBlock API expects the column train-valid to be a column of boolean values which have a value true if the row belongs to validation set and false otherwise. Hence making that change as well and after completing all of this, the final dataframe is as shown below.", "Let\u2019s have a look at the number of images that we have in train and validation sets respectively. It\u2019s generally good to have them in equal proportions and also they should both belong to the same population. Let\u2019s see how the distribution of data looks like.", "The dataset looks pretty much balanced with almost a hundred and fifty elements each in train and validation sets. Well, with respect to image standards, this number is pretty low for training a Neural Network classifier. Deep Neural Networks learn good representation functions when there\u2019s a lot of images. A few hundreds or thousands of images per classification label is pretty normal with respect to normal deep learning standards. Over here we have a combined 300 odd images for 27 classes which means we have not more than 10\u201312 images per class. Let\u2019s see how good a model we can build using this data.", "A substantial amount of time is consumed in curating the data in a format suitable to feed to the deep learning model in any application. To simplify this process so that any DL Practitioner can focus on the model building and interpretation more than data curation, fastai came up with the DataBlock API which is excellent at data curation.", "Generally, data is structured in one of the following two ways", "In this format, data is curated folderwise. There are separate folders for train and validation sets and each of them have folders corresponding to the respective classes that have the relevant data corresponding to those classes. The tree structure aside is for a cat-dog dataset curated in an Imagenet directory kind of style.", "In this method, the information about how the data is structured is wrapped in a csv. It has all information like the path to the data, class of the data, whether or not the item belongs to training or validation set and so forth. Our current dataset is curated in this particular format which we will leverage to create a datablock.", "fastai\u2019s datablock API provides support for both of these structures and even a few more however, we\u2019ll look at the general structure of the API and how we can use the same for the sake of this problem.", "The datablock API takes in several arguments some of which are compuslory and some are optional. We\u2019ll go through each one of them sequentially.", "Once we have the DataBlock API object, we can create dataloaders using this object which can be fed into the model for training. After creating a dataloader, we can see how data is input to the model using show_batch method and subsequently the vocab attribute can be used to see what and how many classes/labels are present in the dataset as a whole.", "The dataloaders object contains both the train and validation dataloaders in it. The items in vocab correspond to the classes pertaining to train dataloader and the validation dataloader may have less than or equal number of labels/classes as the train dataloader. Also, notice that in the show_batch method, you can provide the number of items that you want to see but if the number is bigger than batch size (9 as opposed to a bs of 8), then you\u2019ll only see as many images as in the batch size.", "Once you have a dataloader, next step is to create a model and to train it with an appropriate optimisation algorithm. fastai already abstracts a lot of these things and provides you with a very simple learner object which also has a lot of arguments but let me stress on the most important ones below.", "The compulsory arguments that our Learner object takes are as follows:", "Other optional but important arguments are opt_func which specifies the optimisation algorithm to be used for training the model and metrics which specify what metrics to gauge the performance on (it could be accuracy, precision, recall, any custom metric). Also there is a capability of calling different callbacks as well which is not in the scope of this article. You can refer here to understand more about the same.", "Once we have the learner object, we can utilize the lr_find function to find an optimal learning rate for our model. Looking at the loss vs learning rate profile, we should select the learning rate where the loss is minimum or a rate slightly below that point. It\u2019s good to be conservative with learning rates because in my personal opinion, delayed convergence is more tolerable than overshooting the optimal point.", "The function also gives suggestions for lr_min and the point where the steepest descent in loss was observed. The lr_min is an estimate of the minimum learning rate that one should pick in order to see decent speed of training without being extremely wary of skipping the optimal point in the loss surface while simultaneously ensuring that the model is learning something and parameter updates are happening. So, let\u2019s for this case pick a learning rate of .01 and start the training.", "Since we have only about 154 training images, each epoch takes around 4 seconds with validation and metric computation. In this case, for resnet101 pretrained model, it\u2019s top fc layers and a few penultimate convolution layers are getting the weight updates and the rest of the network is frozen i.e. weight updates don\u2019t propagate further backwards than that. This fine-tuning approach has empirically observed to be the best when adopting a pre-trained model for a custom task; however after substantial improvement, like when the error rate drops to 10% or accuracy reaches almost 90%, we can also unfreeze that portion of the network and again train the model with the parameter updates now penetrating throughout the neural network.", "That\u2019s exactly what we did here. After training for 25 epochs, we unfreezed the model and checked for a good learning rate with the help of lr_find and ran the training loop for 5 more epochs. However we couldn\u2019t find any substantial improvement in the error rate. It went down to 8.9% from 10.27%; this shows that the model is now saturated and no matter what you do to the model unless you provide new data, there wouldn\u2019t be any major impact on the accuracy of this model.", "In order to save this model for interpretation in future, you can simply use the command", "This will save the model with the name filename as a pkl file that could be later reloaded for inference. Now that we\u2019re through with all the training part, let\u2019s interpret the model and look at the predictions that it has made.", "After building a model, the performance of the model needs to gauged to ensure it\u2019s usability and fastai provides a class ClassificationInterpretation for the same. We can create an instance of this class with the learner object that we fit in the training part.", "Once we do that, we can observe the confusion matrix for validation data to see where the mistakes were made and how many of them were there.", "The overall structure of this seems good. In an idea case the diagonal is completely saturated with all the other non-diagonal elements being null. Here we can see that\u2019s not the case. This means that our model has misclassified some action figures for eg. 2 RON WEASLY Legos were incorrectly classified as HARRY POTTER, a YODA figure was misclassified as RON WEASLEY and so on. In order to particularly highlight the ones which are misclassified, the ClassificationInterpretation class also has one more method.", "Here we can see tuples of misclassified items. Each tuple is structured as (Ground Truth, Prediction, number of misclassifications) respectively. Optionally you can also provide a parameter which looks at only those pairs which were misclassified above a certain threshold number of times. This can help us identify the pairs which need to be focussed more on. Thereby we can make decisions like adding more data or deleting wrongly labelled data and so on.", "Although in my application everything is neatly labelled, there can be instances of mislabelling like below. The above code helps to create a GUI inline in the notebook which can be used to basically keep/delete/move items from one class to another. This is present in the widgets class in the fastai.vision package. If you\u2019re sometime not sure about the labelling in your dataset, auditing your dataset like this is worth a try to clean it.", "So that\u2019s it for this post guys; I hope you understood the steps to start using fastai for making your own image classifier. It has saved me a lot of time in terms of data preprocessing, model training and model interpretation, particularly in deep learning. Unlike PyTorch where we have to define the Datasets and Dataloader, the datablock API obviates the need for that step as it nicely wraps everything into one function call. Hope you liked the article and thanks for reading through!", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F3360f97175fe&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdatablocks-api-image-classification-in-fastai-using-lego-minifigures-dataset-3360f97175fe&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdatablocks-api-image-classification-in-fastai-using-lego-minifigures-dataset-3360f97175fe&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdatablocks-api-image-classification-in-fastai-using-lego-minifigures-dataset-3360f97175fe&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdatablocks-api-image-classification-in-fastai-using-lego-minifigures-dataset-3360f97175fe&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----3360f97175fe--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----3360f97175fe--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://nayakvinayak95.medium.com/?source=post_page-----3360f97175fe--------------------------------", "anchor_text": ""}, {"url": "https://nayakvinayak95.medium.com/?source=post_page-----3360f97175fe--------------------------------", "anchor_text": "Vinayak Nayak"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F9b10ad08afc7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdatablocks-api-image-classification-in-fastai-using-lego-minifigures-dataset-3360f97175fe&user=Vinayak+Nayak&userId=9b10ad08afc7&source=post_page-9b10ad08afc7----3360f97175fe---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F3360f97175fe&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdatablocks-api-image-classification-in-fastai-using-lego-minifigures-dataset-3360f97175fe&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F3360f97175fe&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdatablocks-api-image-classification-in-fastai-using-lego-minifigures-dataset-3360f97175fe&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@danielkcheung?utm_source=medium&utm_medium=referral", "anchor_text": "Daniel Cheung"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://www.kaggle.com/ihelon/lego-minifigures-classification", "anchor_text": "obtained from Kaggle here."}, {"url": "https://docs.fast.ai/callback.core#", "anchor_text": "refer here"}, {"url": "https://www.kaggle.com/ihelon/lego-minifigures-classification", "anchor_text": "Lego Minifigures dataset"}, {"url": "https://colab.research.google.com/github/fastai/fastbook/blob/master/05_pet_breeds.ipynb#scrollTo=iC8TjN36Lo-K", "anchor_text": "PetBreeds Classification Notebook"}, {"url": "https://github.com/ElisonSherton/fastai-basic-notebooks", "anchor_text": "Github Repo for code in this post"}, {"url": "https://medium.com/tag/fastai?source=post_page-----3360f97175fe---------------fastai-----------------", "anchor_text": "Fastai"}, {"url": "https://medium.com/tag/pytorch?source=post_page-----3360f97175fe---------------pytorch-----------------", "anchor_text": "Pytorch"}, {"url": "https://medium.com/tag/python?source=post_page-----3360f97175fe---------------python-----------------", "anchor_text": "Python"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----3360f97175fe---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/tag/image-classification?source=post_page-----3360f97175fe---------------image_classification-----------------", "anchor_text": "Image Classification"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F3360f97175fe&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdatablocks-api-image-classification-in-fastai-using-lego-minifigures-dataset-3360f97175fe&user=Vinayak+Nayak&userId=9b10ad08afc7&source=-----3360f97175fe---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F3360f97175fe&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdatablocks-api-image-classification-in-fastai-using-lego-minifigures-dataset-3360f97175fe&user=Vinayak+Nayak&userId=9b10ad08afc7&source=-----3360f97175fe---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F3360f97175fe&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdatablocks-api-image-classification-in-fastai-using-lego-minifigures-dataset-3360f97175fe&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----3360f97175fe--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F3360f97175fe&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdatablocks-api-image-classification-in-fastai-using-lego-minifigures-dataset-3360f97175fe&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----3360f97175fe---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----3360f97175fe--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----3360f97175fe--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----3360f97175fe--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----3360f97175fe--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----3360f97175fe--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----3360f97175fe--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----3360f97175fe--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----3360f97175fe--------------------------------", "anchor_text": ""}, {"url": "https://nayakvinayak95.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://nayakvinayak95.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Vinayak Nayak"}, {"url": "https://nayakvinayak95.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "80 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F9b10ad08afc7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdatablocks-api-image-classification-in-fastai-using-lego-minifigures-dataset-3360f97175fe&user=Vinayak+Nayak&userId=9b10ad08afc7&source=post_page-9b10ad08afc7--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fadfaf0b7759f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdatablocks-api-image-classification-in-fastai-using-lego-minifigures-dataset-3360f97175fe&newsletterV3=9b10ad08afc7&newsletterV3Id=adfaf0b7759f&user=Vinayak+Nayak&userId=9b10ad08afc7&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}