{"url": "https://towardsdatascience.com/why-how-to-create-quantiles-from-a-machine-learning-prediction-python-code-da9071622db2", "time": 1683013636.1323771, "path": "towardsdatascience.com/why-how-to-create-quantiles-from-a-machine-learning-prediction-python-code-da9071622db2/", "webpage": {"metadata": {"title": "Quantiles and IntervalIndex pandas | Towards Data Science", "h1": "Why & How to create quantiles from a Machine Learning prediction | Python + code", "description": "Dividing a machine learning predicted output by quantiles is a good way to apply business strategies. Study on pandas' functions qcut cut & IntervalIndex."}, "outgoing_paragraph_urls": [{"url": "https://groups.google.com/d/topic/pydata/8aTLVKrPJfs/discussion", "anchor_text": "floating point precision issues", "paragraph_index": 13}, {"url": "https://github.com/pandas-dev/pandas/issues/7640", "anchor_text": "Stephan SHOYER", "paragraph_index": 13}], "all_paragraphs": ["When we build a project involving a machine learning component we use metrics (e.g AUC, RMSE, \u2026) in order to choose which model fits our data the best. Then we use the sklearn predict() function to get the regression\u2019s value or the sklearn predict_proba() function to get the probability for the observation to be equal to the class (1 for a binary classification). The common point is that it returns a continuous output that has to be used for a business strategy.", "Building a business strategy is generally more complex than \u201cdo an action if probability \u2265 x, else do nothing\u201d and less complex than \u201cfor each possible value of the continuous output, do a differentiate action\u201d. This is why the creation of quantiles makes sense. To make it more concrete, here are 2 examples related to a regression task and a binary classification task.", "Example 1: Imagine we are working in the marketing department of a retail clothing company where the objective is to predict the amount of dollars each customer of the database will spend during the year. Based on that, the commercial strategy would be to provide an access to private sales for the 15% of clients who will spend the most, a discount for the 15% to 40%, free shipping for the 40% to 60% and a newsletter for the remaining clients.", "Example 2: Imagine we are working in the collection department of a house renting company where we have the client\u2019s database in delay of payment and where the objective is to predict which client will still be in delay at the end of the month. Moreover, we know that if we do nothing, 50% of these clients will still be in delay. Given the capacities and the costs, the agents can call 10% of the population, send an email to 30% of them, send a SMS to 20% of them and do nothing for the remaining 40%.", "As a result, creating quantiles enables to apply these strategies on each part of the distribution and leverage the added value of the machine learning model.", "For this article I will use a dataset related to sport gambling where the objective is to classify \u201cwin vs not win\u201d given 45 features. I divided the dataset in train, validation and out of time test, where out of time test is the season 2019/2020, having 732 observations. The distribution of train is 70% and validation is 30% with a respective length of 3262 and 1398. The target = 1 (win) is 44.3%, 44.28% and 43.44% therefore it is well balanced across the different sets. I trained a Gradient Boosting algorithm using the Catboost library and the predict_proba of each dataset have this distribution:", "Visually we can see that the distribution of probabilities seems to be the same and the Kolmogorov-Smirnov two samples test confirmed it. As a result, we can create our quantiles.", "Be careful ! The hypothesis of having the same distribution is mandatory, if it\u2019s not the case, the quantile will not be generalized and the business strategies will fail.", "In this use-case, I chose to divide my distribution in 7 quantiles (100/7 = 14.23%). A possible intuition would be to create a bin at each 14.23% but in the case of a distribution which is not uniform, we would have very few observations in the extremities and almost all of them in the middle.", "So the idea is that given a distribution, we want an equal number of observations in each quantile. The function of pandas for such task is pandas.qcut(x, q, labels=None, retbins=False, precision=3, duplicated='raise\u2019) where x is the 1d array or a Series; q is the number of quantile; labels allows to set a name to each quantile {ex: Low \u2014 Medium \u2014 High if q=3} and if labels=False the integer of the quantile is returned; retbins=True return an array of boundaries for each quantile.", "In the code below, we create the feature \u2018quantile\u2019, and \u2018edges\u2019 is the array obtained by the argument retbins=True. The values of \u2018edges\u2019 are on the interval [0.13653858 ; 0.88398169] which is a huge limitation. Indeed, a probability is between [0 ; 1] therefore it is perfectly possible to have in the validation and test datasets an observation having a y_proba = 0.094 or a y_proba = 0.925. This is why I modified the array by replacing the boundary of 0.13653858 by -0.001 (in order to have 0 included) and the boundary of 0.88398169 by 1 while keeping the others quantiles\u2019 boundaries as they are in the array. Without this change, the quantiles of y_proba = 0.094 or 0.925 would have the values NaN.", "Moreover, qcut associates the 0 value to the lowest quantile of x on an ascending order but in some industries (like credit scoring) it is on a decreasing order so that is why I re-ordered it to have the 0 quantile for the highest quantile of probabilities.", "Now that we have an array for our boundaries, let\u2019s transform it into an IntervalIndex.", "The key feature of IntervalIndex is that looking up an indexer should return all intervals in which the indexer's values fall. FloatIndex is a poor substitute, because of floating point precision issues, and because I don't want to label values by a single point. \u2014 Stephan SHOYER", "I used the function of pandas pandas.IntervalIndex.from_breaks(breaks, closed='right', name=None, copy=False, dtype=None) where breaks is the 1d array \u2018ed\u2019 previously defined, closed=\u2019right\u2019 aims to represent which part of the interval is closed (right means that the value on the right is included to the interval) and dtype is the inferred format (in our case I let None and the inferred format was float64).", "Now, the interval index object can be used inside the pandas function pandas.cut(x, bins, right=True, labels=None, retbins=False, precision=3, include_lowest=False, duplicates='raise', ordered=True). Here, x is the 1d array or Series to bin, bins is the criteria for the binning and it can take an integer, a sequence of scalar or an IntervalIndex; right, labels, include_lowest, precision and ordered are ignored if bins is an IntervalIndex. In the example below, I create a new feature \u2018quantile_interval\u2019 which apply the cut of y_proba based on the IntervalIndex. The train dataset looks like the Figure1 below.", "To finish the creation of quantiles, I store the quantile values in a DataFrame named dict_inter_quantile (see Figure2) and their associated IntervalIndex.", "Now that the way to create quantiles on the train set is explained, let\u2019s see how to apply them on new data such as validation , test , and any new data.", "This part is very simple because all of the job was done before. So we just have to use the cut function in order to have the IntervalIndex of the probability and to join the dataset to dict_inter_quantile in order to have the value of the quantiles.", "Example with the test set (same process for validation or any new data) which provide the output of Figure3.", "Now that we have the related quantile of the predicted probability for each new observation, we can verify if the distribution over quantiles is equally distributed on the validation and test as the train.", "So what ? Figure 4 above shows that the percentage of observations across the quantiles between train \u2014 validation \u2014 test is very similar which means that the data didn\u2019t shift and as a result we can apply to the test dataset the boundaries found in the train dataset. Moreover, we can apply an operational strategy as the examples in the beginning, we can check the percentage of y = 1 in each quantile to see if it\u2019s ranked in the same order and / or if the percentage is similar across datasets, we can try to improve some part of the distribution, \u2026", "We saw why it can be relevant to create quantiles from a prediction in order to apply a business strategy, how to create them from a distribution and how to use it on new ones. This only makes sense if your distributions are the same. You can check it with the Kolmogorov-Smirnov test or a more exotic way.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fda9071622db2&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhy-how-to-create-quantiles-from-a-machine-learning-prediction-python-code-da9071622db2&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhy-how-to-create-quantiles-from-a-machine-learning-prediction-python-code-da9071622db2&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhy-how-to-create-quantiles-from-a-machine-learning-prediction-python-code-da9071622db2&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhy-how-to-create-quantiles-from-a-machine-learning-prediction-python-code-da9071622db2&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----da9071622db2--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----da9071622db2--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@guillaume.j.clement?source=post_page-----da9071622db2--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@guillaume.j.clement?source=post_page-----da9071622db2--------------------------------", "anchor_text": "Guillaume J. CLEMENT"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fc3730acc2ff1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhy-how-to-create-quantiles-from-a-machine-learning-prediction-python-code-da9071622db2&user=Guillaume+J.+CLEMENT&userId=c3730acc2ff1&source=post_page-c3730acc2ff1----da9071622db2---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fda9071622db2&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhy-how-to-create-quantiles-from-a-machine-learning-prediction-python-code-da9071622db2&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fda9071622db2&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhy-how-to-create-quantiles-from-a-machine-learning-prediction-python-code-da9071622db2&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@fragilejames?utm_source=medium&utm_medium=referral", "anchor_text": "James L.W"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://groups.google.com/d/topic/pydata/8aTLVKrPJfs/discussion", "anchor_text": "floating point precision issues"}, {"url": "https://github.com/pandas-dev/pandas/issues/7640", "anchor_text": "Stephan SHOYER"}, {"url": "https://medium.com/tag/quantile?source=post_page-----da9071622db2---------------quantile-----------------", "anchor_text": "Quantile"}, {"url": "https://medium.com/tag/interval?source=post_page-----da9071622db2---------------interval-----------------", "anchor_text": "Interval"}, {"url": "https://medium.com/tag/boundaries?source=post_page-----da9071622db2---------------boundaries-----------------", "anchor_text": "Boundaries"}, {"url": "https://medium.com/tag/pandas?source=post_page-----da9071622db2---------------pandas-----------------", "anchor_text": "Pandas"}, {"url": "https://medium.com/tag/editors-pick?source=post_page-----da9071622db2---------------editors_pick-----------------", "anchor_text": "Editors Pick"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fda9071622db2&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhy-how-to-create-quantiles-from-a-machine-learning-prediction-python-code-da9071622db2&user=Guillaume+J.+CLEMENT&userId=c3730acc2ff1&source=-----da9071622db2---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fda9071622db2&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhy-how-to-create-quantiles-from-a-machine-learning-prediction-python-code-da9071622db2&user=Guillaume+J.+CLEMENT&userId=c3730acc2ff1&source=-----da9071622db2---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fda9071622db2&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhy-how-to-create-quantiles-from-a-machine-learning-prediction-python-code-da9071622db2&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----da9071622db2--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fda9071622db2&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhy-how-to-create-quantiles-from-a-machine-learning-prediction-python-code-da9071622db2&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----da9071622db2---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----da9071622db2--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----da9071622db2--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----da9071622db2--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----da9071622db2--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----da9071622db2--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----da9071622db2--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----da9071622db2--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----da9071622db2--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@guillaume.j.clement?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@guillaume.j.clement?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Guillaume J. CLEMENT"}, {"url": "https://medium.com/@guillaume.j.clement/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "71 Followers"}, {"url": "https://www.linkedin.com/in/guillaume-clement543922a9/", "anchor_text": "https://www.linkedin.com/in/guillaume-clement543922a9/"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fc3730acc2ff1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhy-how-to-create-quantiles-from-a-machine-learning-prediction-python-code-da9071622db2&user=Guillaume+J.+CLEMENT&userId=c3730acc2ff1&source=post_page-c3730acc2ff1--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fd749548d74dd&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwhy-how-to-create-quantiles-from-a-machine-learning-prediction-python-code-da9071622db2&newsletterV3=c3730acc2ff1&newsletterV3Id=d749548d74dd&user=Guillaume+J.+CLEMENT&userId=c3730acc2ff1&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}