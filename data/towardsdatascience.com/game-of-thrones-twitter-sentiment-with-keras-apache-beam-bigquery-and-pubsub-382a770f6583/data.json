{"url": "https://towardsdatascience.com/game-of-thrones-twitter-sentiment-with-keras-apache-beam-bigquery-and-pubsub-382a770f6583", "time": 1682996348.418931, "path": "towardsdatascience.com/game-of-thrones-twitter-sentiment-with-keras-apache-beam-bigquery-and-pubsub-382a770f6583/", "webpage": {"metadata": {"title": "Game of Thrones Twitter Sentiment with Google Cloud Platform and Keras | by Thomas Dehaene | Towards Data Science", "h1": "Game of Thrones Twitter Sentiment with Google Cloud Platform and Keras", "description": "The final season of Game of Thrones apparently raised a lot of eyebrows, so I wanted to dig deeper on how people felt before, during and after the final episode of Game of Thrones by turning towards\u2026"}, "outgoing_paragraph_urls": [{"url": "https://github.com/TDehaene/blogposts/tree/master/got_sentiment", "anchor_text": "this Github repo", "paragraph_index": 3}, {"url": "https://www.kaggle.com/kazanova/sentiment140", "anchor_text": "this Kaggle page", "paragraph_index": 18}, {"url": "https://www.aclweb.org/anthology/D14-1181", "anchor_text": "source", "paragraph_index": 20}, {"url": "https://github.com/TDehaene/blogposts/blob/master/got_sentiment/3_sentiment_analysis/training_and_serving.ipynb", "anchor_text": "this notebook", "paragraph_index": 23}, {"url": "https://cloud.google.com/blog/products/ai-machine-learning/ai-in-depth-creating-preprocessing-model-serving-affinity-with-custom-online-prediction-on-ai-platform-serving", "anchor_text": "here", "paragraph_index": 31}, {"url": "https://beam.apache.org/", "anchor_text": "the website", "paragraph_index": 34}, {"url": "https://github.com/TDehaene/blogposts/tree/master/got_sentiment", "anchor_text": "my Github repo", "paragraph_index": 39}], "all_paragraphs": ["The final season of Game of Thrones apparently raised a lot of eyebrows, so I wanted to dig deeper on how people felt before, during and after the final episode of Game of Thrones by turning towards the ever non-soft-spoken Twitter community.", "In this blogpost, we\u2019ll look at how an end-to-end solution can be built to tackle this problem, using the technology stack available on Google Cloud Platform.", "The focus is more on realising a fully working solution, rather than perfecting a single component in the entire pipeline. So any of the individual blocks can certainly be perfected!", "To keep it readable, I haven\u2019t included all of the code, but everything can be found on this Github repo, fully commented.", "The rough outline for the entire pipeline looks something like this:", "Basically, want can be done is:", "In the rest of the post, we\u2019ll glance over all of the various components separately, to finalize with a big orchestra of harmonious pipelining bonanza!", "We will be relying heavily on Google Cloud Platform, with the following components:", "Capturing tweets related to several searchterms can easily be done using the tweepy API, like so:", "To send it to Google Cloud PubSub, we can just use the client library:", "So with this done, it\u2019s just a simple as:", "Pub/Sub is a great piece of messaging middleware, which serves as the event ingestion and delivery system in your entire pipeline.", "Especially in this case, where the tweets will potentially flow in much faster than the streaming pipeline can pick them up, it\u2019s a great tool, given that ingestion and delivery are decoupled asynchronously.", "Pub/Sub can also store the received messages for a number of days, so no worries if your downstream tasks struggle to keep up.", "Creating a topic is extremely easy: just navigate to your GCP Console and go to the Pub/Sub menu:", "From here on, just click the CREATE TOPIC button and fill in a name for your topic. For future reference, I\u2019ve named mine \u2018got_tweets\u2019.", "For each tweet coming in, we want to determine if the sentiment expressed (presumably towards the episode) is positive or negative. This means we will have to:", "When thinking about sentiment analysis, we quickly think of the \u2018IMDB Movie Review\u2019 dataset. For this specific purpose though, this classic seemed less suited, since we are dealing with tweets here.", "Luckily, the Sentiment140 dataset, which contains 1.6 million labeled (positive and negative) tweets, seems to be perfectly suited for this case. More info, and the dataset, on this Kaggle page. Some examples:", "Preprocessing the text is done in a separate class, so that it can later be reused when calling the model:", "For the classification model itself, I based myself upon the famous 2014 Yoon Kim paper on Multichannel CNN\u2019s for Text Classification (source). For ease of development (and later deployment), I used Keras as the high-level API.", "A CNN-based model provides the additional benefit that training the model was still feasible on my little local workstation (NVidia GTX 1050Ti with 4GB memory) in a decent time. Whereas an RNN-based model (often used for sentiment classification) would have a much longer training time.", "We can try to give the model some extra zing by loading some pretrained Word Embeddings. In this case: the Glove 2.7B Twitter embeddings seemed like a good option!", "The full code can be found in this notebook.", "We trained the model for 25 epochs, with two Keras Callback mechanisms in place:", "The training and testing curve can be seen here:", "So we obtain an accuracy of about 82.5%.", "AI Platform provides a managed, scalable, serving platform for Machine Learning models, with some nice benefits like versioning built into it.", "Now for hosting, there\u2019s one special aspect of our model which makes it a bit less trivial to serve it in AI Platform: the fact that we need to normalize, tokenize and index our text in the same way we did while training.", "Still though, there are some options to choose from:", "Given that there wasn\u2019t time nor resources to go full-blown tf.transform, and that potentially overloading the streaming pipeline with additional preprocessing seemed like a bad choice, the last one looked like the way to go.", "Custom ModelPrediction classes are easy enough, there\u2019s a great blogpost by the peeps from Google on it here. Mine looks like this:", "To create a served AI platform model from this, we just need to:", "Tweets come in in a streaming fashion, it is literally an unbounded dataset. A streaming pipeline therefore seems like the perfect tool to capture tweets from a Pub/Sub topic and process them.", "We will use Apache Beam as the programming model, and run the pipeline on a Dataflow runner (managed environment on Google Cloud for running Beam pipelines). For those of you who want to read more on Apache Beam and its paradigm can read more on the website.", "Firstly, when streaming, we have to consider a Windowing strategy. Here, we just use a fixed window of 10 seconds.", "Other strategies can be done as well, such as a moving window strategy. This would probably infer extra calls to the hosted ML model. So the fixed windowing seemed the easiest to get started with.", "The main steps in our pipeline are:", "When running on Cloud Dataflow, it looks as follows:", "The full code is a little long to paste here, but it can be found in full on my Github repo.", "As stated before, we have two BigQuery tables to stream the results into:", "You can just create these from the UI, and specify a schema (which of course has to map to the specified schema in your Beam pipeline job).", "I ran the entire pipeline for a few hours, to capture both the sentiment leading up to, during and after the episode.", "Given that the amount of tweets could quickly become fairly large, it was also good to observe the scaling capabilities of all of the components:", "In total, about 500.000 tweets were collected in a 7-hour period. Here are some examples, with their predicted sentiment (warning: spoiler alert!)", "Now as for the main question, we could try to frame it as:", "What is the average sentiment expressed in the tweets, per minute. In one hour before, during and one hour after the episode.", "Simple enough with some SQL query magic (see the notebook in the repo), with some notes:", "\ud83d\udc49 So apparently, the community was very hostile towards GoT before the show, gradually putting down their pitchforks and torches towards the beginning of the episode.", "\ud83d\udc49 It could be stated that Bran being named king was well received, I too thought this was a very nice plot twist \ud83d\ude03!", "\ud83d\udc49 Another positive scene was when Brienne of Tarth was writing about Jaime in the book of knights.", "\ud83d\udc49 After the episode, the community seemed to be rather negative towards the final episode, changing their mind a little after about 45 minutes, before becoming negative once again\u2026", "They ended up being rather negative of the episode, which seems to be reflected in the IMDB score of only 4.4 \ud83d\ude2e. One could argue that the episode didn\u2019t stand a chance, as the community was already rather negative before the episode, so that the sentiment somewhat started with a disadvantage bias.", "Is this the ground truth though? Nobody knows for sure, but I\u2019m quite happy with the results \ud83d\udc4d.", "So there we have it! An answer to our question, using the toolbox Google Cloud provides us. FYI: the total cost of the operation ended up being around $5, which I would say is fairly reasonable!", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Information-addicted Machine Learning Engineer at ML6. Turning caffeine into Python code."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F382a770f6583&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fgame-of-thrones-twitter-sentiment-with-keras-apache-beam-bigquery-and-pubsub-382a770f6583&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fgame-of-thrones-twitter-sentiment-with-keras-apache-beam-bigquery-and-pubsub-382a770f6583&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fgame-of-thrones-twitter-sentiment-with-keras-apache-beam-bigquery-and-pubsub-382a770f6583&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fgame-of-thrones-twitter-sentiment-with-keras-apache-beam-bigquery-and-pubsub-382a770f6583&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----382a770f6583--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----382a770f6583--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@thomas_dehaene?source=post_page-----382a770f6583--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@thomas_dehaene?source=post_page-----382a770f6583--------------------------------", "anchor_text": "Thomas Dehaene"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F42421f0cbdbe&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fgame-of-thrones-twitter-sentiment-with-keras-apache-beam-bigquery-and-pubsub-382a770f6583&user=Thomas+Dehaene&userId=42421f0cbdbe&source=post_page-42421f0cbdbe----382a770f6583---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F382a770f6583&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fgame-of-thrones-twitter-sentiment-with-keras-apache-beam-bigquery-and-pubsub-382a770f6583&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F382a770f6583&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fgame-of-thrones-twitter-sentiment-with-keras-apache-beam-bigquery-and-pubsub-382a770f6583&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@lastly?utm_source=medium&utm_medium=referral", "anchor_text": "Tyler Lastovich"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://gifer.com/en/6Aqy", "anchor_text": "source"}, {"url": "https://github.com/TDehaene/blogposts/tree/master/got_sentiment", "anchor_text": "this Github repo"}, {"url": "https://download.logo.wine/logo/Google_Compute_Engine/Google_Compute_Engine-Logo.wine.png", "anchor_text": "source"}, {"url": "https://techlab.bol.com/app/files/2020/02/1200px-Cloud-Pub-Sub-Logo.svg_.jpg", "anchor_text": "source"}, {"url": "https://miro.medium.com/max/320/1*j55G2ObYgDVyeanO9XPbng.png", "anchor_text": "source"}, {"url": "https://www.kaggle.com/kazanova/sentiment140", "anchor_text": "this Kaggle page"}, {"url": "https://www.aclweb.org/anthology/D14-1181", "anchor_text": "source"}, {"url": "https://arxiv.org/pdf/1408.5882.pdf", "anchor_text": "source"}, {"url": "https://github.com/TDehaene/blogposts/blob/master/got_sentiment/3_sentiment_analysis/training_and_serving.ipynb", "anchor_text": "this notebook"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/contrib/lookup/HashTable", "anchor_text": "here"}, {"url": "https://blog.ml6.eu/pre-processing-for-tensorflow-pipelines-with-tf-transform-on-google-cloud-25b283bd47ea", "anchor_text": "here"}, {"url": "https://cloud.google.com/blog/products/ai-machine-learning/ai-in-depth-creating-preprocessing-model-serving-affinity-with-custom-online-prediction-on-ai-platform-serving", "anchor_text": "here"}, {"url": "https://codelabs.developers.google.com/codelabs/dataflow-notebooks-streamingwordcount/img/62b0919755804bea.png", "anchor_text": "source"}, {"url": "https://beam.apache.org/", "anchor_text": "the website"}, {"url": "https://beam.apache.org/documentation/programming-guide/", "anchor_text": "source"}, {"url": "https://github.com/TDehaene/blogposts/tree/master/got_sentiment", "anchor_text": "my Github repo"}, {"url": "https://cdn.worldvectorlogo.com/logos/google-bigquery-logo-1.svg", "anchor_text": "source"}, {"url": "https://static.gofugyourself.com/uploads/2019/05/source-1557101865-500x281.gif", "anchor_text": "source"}, {"url": "https://66.media.tumblr.com/09dc83bae883cdc4788a9cbb9a3fae9d/tumblr_nc38lh8qGz1tq4of6o1_500.gif", "anchor_text": "source"}, {"url": "https://medium.com/tag/google-cloud-platform?source=post_page-----382a770f6583---------------google_cloud_platform-----------------", "anchor_text": "Google Cloud Platform"}, {"url": "https://medium.com/tag/keras?source=post_page-----382a770f6583---------------keras-----------------", "anchor_text": "Keras"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----382a770f6583---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----382a770f6583---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/tag/towards-data-science?source=post_page-----382a770f6583---------------towards_data_science-----------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F382a770f6583&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fgame-of-thrones-twitter-sentiment-with-keras-apache-beam-bigquery-and-pubsub-382a770f6583&user=Thomas+Dehaene&userId=42421f0cbdbe&source=-----382a770f6583---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F382a770f6583&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fgame-of-thrones-twitter-sentiment-with-keras-apache-beam-bigquery-and-pubsub-382a770f6583&user=Thomas+Dehaene&userId=42421f0cbdbe&source=-----382a770f6583---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F382a770f6583&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fgame-of-thrones-twitter-sentiment-with-keras-apache-beam-bigquery-and-pubsub-382a770f6583&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----382a770f6583--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F382a770f6583&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fgame-of-thrones-twitter-sentiment-with-keras-apache-beam-bigquery-and-pubsub-382a770f6583&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----382a770f6583---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----382a770f6583--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----382a770f6583--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----382a770f6583--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----382a770f6583--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----382a770f6583--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----382a770f6583--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----382a770f6583--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----382a770f6583--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@thomas_dehaene?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@thomas_dehaene?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Thomas Dehaene"}, {"url": "https://medium.com/@thomas_dehaene/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "376 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F42421f0cbdbe&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fgame-of-thrones-twitter-sentiment-with-keras-apache-beam-bigquery-and-pubsub-382a770f6583&user=Thomas+Dehaene&userId=42421f0cbdbe&source=post_page-42421f0cbdbe--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F734d30253747&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fgame-of-thrones-twitter-sentiment-with-keras-apache-beam-bigquery-and-pubsub-382a770f6583&newsletterV3=42421f0cbdbe&newsletterV3Id=734d30253747&user=Thomas+Dehaene&userId=42421f0cbdbe&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}