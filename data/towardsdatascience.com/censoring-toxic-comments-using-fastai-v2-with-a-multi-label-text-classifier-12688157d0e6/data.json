{"url": "https://towardsdatascience.com/censoring-toxic-comments-using-fastai-v2-with-a-multi-label-text-classifier-12688157d0e6", "time": 1683014101.673373, "path": "towardsdatascience.com/censoring-toxic-comments-using-fastai-v2-with-a-multi-label-text-classifier-12688157d0e6/", "webpage": {"metadata": {"title": "Censoring toxic comments using fastai v2 with a multi-label text classifier | by Vinayak Nayak | Towards Data Science", "h1": "Censoring toxic comments using fastai v2 with a multi-label text classifier", "description": "The internet has become a basic necessity in recent times and a lot of things which happen physically in our world are on the verge of being digitised. Already a substantial proportion of the world\u2026"}, "outgoing_paragraph_urls": [{"url": "https://www.kaggle.com/c/jigsaw-toxic-comment-classification-challenge", "anchor_text": "Toxic Comment Classification Challenge on Kaggle.", "paragraph_index": 7}, {"url": "https://medium.com/analytics-vidhya/how-to-fetch-kaggle-datasets-into-google-colab-ea682569851a", "anchor_text": "This post", "paragraph_index": 11}, {"url": "https://medium.com/u/a30a62d08d0c?source=post_page-----12688157d0e6--------------------------------", "anchor_text": "MRINALI GUPTA", "paragraph_index": 11}], "all_paragraphs": ["The internet has become a basic necessity in recent times and a lot of things which happen physically in our world are on the verge of being digitised. Already a substantial proportion of the world population uses the internet for day to day chores, entertainment, academic research etc. It then is a big responsibility to keep the internet a safe space for everyone to come and interact because there are all sorts of people posting stuff on the internet without being conscious of its consequences.", "This post goes through the process of making a text classifier which takes in a piece of text (phrase, sentence, paragraph any length text) and tells if the text falls under a range of different types of malignant prose. The topics covered in this post are", "You can click on any of the above bullet points to navigate to the respective section.", "Disclaimer: The dataset used here contains some text that may be considered profane, vulgar, or offensive.", "Natural Language Processing is a field that deals with understanding the interactions between computers and human language. Since a lot of things are going online or digital, and since these services are democratised to the whole world, the scale at which this data is generated is humongous. In these times where everyone on the planet is putting their opinions, thoughts, facts, essays, poems etc. online, monitoring and moderating these pieces of text is an inhuman task (even when we think of humans as a community and not an individual being).", "Thanks to the advent of high capacity GPUs and TPUs and the recent advances in AI for text applications, we have come up with a lot of techniques to tackle this problem. Recurrent Neural Networks are the key element with the help of which these problems are addressed. fastai, a deep learning library built on top of PyTorch, developed by Jeremy Howard and Sylvain Gugger makes building applications for tasks like these very user-friendly and simple.", "Let\u2019s the get started and learn how to do text classification using fastai.", "The data we\u2019ll use for demonstrating the process of multi-label text classification is obtained from Toxic Comment Classification Challenge on Kaggle.", "Our model will be responsible for detecting different types of toxicity like threats, obscenity, insults, and identity-based hate. The dataset consists comments from Wikipedia\u2019s talk page edits. Without any further ado, let\u2019s get started with downloading this dataset.", "You can either download the dataset from Kaggle manually or use the API provided by kaggle using the above commands.", "To use the API, you\u2019ll have to create an account with Kaggle and generate the API key which allows you to use shell commands for downloading the dataset from kaggle and also making submissions for predictions from the working notebook or from the shell. Once you create a Kaggle account and create the API key, you will get a json file which contains both your username and key. Those need to be input in the above code as per your unique credentials.", "This post by MRINALI GUPTA nicely explains how to get started with Kaggle API for downloading datasets.", "Let\u2019s read in both the train and test sets and get a hang of what data is contained in them.", "There are several fields in the dataframe.", "These elements are independent in the sense, they\u2019re not mutually exclusive for eg. A comment can be both toxic and insulting, or it\u2019s not necessary that if a comment is toxic it couldn\u2019t be obscene and so on.", "In general, there\u2019s a lot less comments that have objectionable text; considering that we\u2019ve got more than a hundred thousand comments, there\u2019s less than tens of thousand objectionable categories (except toxic which is just a few more). This is good to know but it would be for the best if there were still fewer texts of this kind.", "Also, the text was annotated by humans to have these labels. This task of annotation is a huge task and a lot of human interpretation and bias will have come along with these annotations. It\u2019s something that needs to be remembered and we\u2019ll talk about this in closing thoughts.", "Text or sentences are sequences of individual units \u2014 words, sub-words or characters (depends on the language you speak). Any Machine Learning algorithm is not capable of handling anything other than numbers. So, we will first have to represent the data in terms of numbers.", "In any text related problems, first we create a vocabulary of words which basically is the total corpus of words which we will consider; any other word will be tagged with a special tag called unknown and put in that bucket. This process is called tokenization.", "Next, we map every word to a numerical token and create a dictionary of words that stores this mapping. So every prose/comment/text is now converted into a list of numbers. This process is called numericalization.", "Most certainly the comments will not be of equal length, because people are not restricted to comment in exactly a fixed number of words. But when creating batches of text to feed to our network, we need them all to be of the same length. Therefore we pad the sentences with a special token or truncate the sentence if it\u2019s too big to constrict to a fixed length. This process is called padding.", "While doing all the above, there are some other operations like lowercasing all the text, dealing with punctuation as separate tokens, understanding capitalization in spite of lowercasing and so on. This is where the good people at fastai make all of these things super easy for us.", "There\u2019s some more semantic information handled with more such tokens but all of this makes sure to capture precious information about the text and the meaning behind it.", "Once this preprocessing is done, we can then right of the bat build an LSTM model to classify the texts into the respective labels. Words are represented as n-dimensional vectors which are colloquially called encoding/embedding. There\u2019s a construct for Embedding in PyTorch which helps lookup the vector representation for a word given it\u2019s numerical token and that\u2019s followed by other RNN layers and fully connected layers to build an architecture which can take sequence as an input and return a bunch of probabilities as the output. These vector embeddings could be randomly initialized or borrowed from commonly available GLoVE or Word2Vec embeddings which have been trained on a large corpus of text so that they have a good semantic word understanding about context in that particular language in a generic sense.", "However, there\u2019s a trick which could improve the results if we perform it before building a classifier. That\u2019s what we\u2019ll look at next.", "fastai has suggested this tried and tested method of fine-tuning a Language Model before building any kind of classifier or application.", "In a nutshell, what they say is if you have a set of word embeddings which were trained on a huge corpus, they have a very generic understanding of the words that they learned from that corpus. However, when we talk about classification of hate speech and obnoxious comments and toxic stuff, there\u2019s a specific negative vibe associated with these sentences and that semantic context is not yet present in our embeddings. Also, many words/terms specific to our application (it may be medicine or law or toxic speech) may not be encountered often in that huge corpus from which we obtained the word embeddings. Those should be there included and represented well in the embeddings that our classifier is going to use.", "So, before building a classifier we\u2019ll finetune a Language Model which has been trained on wikipedia text corpus. We will bind the train and test dataset comments together and feed them to the language model. This is because we\u2019re not doing classification but simply guessing the next word of a sequence given the current sequence; it\u2019s called a self supervised task. With the embeddings learned this way, we\u2019ll be able to build a better classifier because it has an idea of the concepts specific to our corpus.", "Let\u2019s see how we can instantiate and fine-tune a language model in fastai v2.", "We append the train and test data and throw away the labels because we don\u2019t need them in this self-supervised learning task. Next, we have to create a dataloader to tokenize these texts, do all the numericalization, padding and preprocessing before feeding it to the language model.", "That\u2019s how simple it is in fastai, you just have to wrap all the arguments in a factory method and instantiate the TextDataLoaders class with it. This would have otherwise taken at least a hundred lines of codes with proper commenting and stuff but thanks to fastai, it\u2019s short and sweet. We can have a look at a couple of entries from a batch.", "As we can see the output is just offsetting the given sequence by one word which is in alignment with what we want, i.e. given a sequence, predict next word of a sequence. Once we have this dataloader, we can create a language model learner which can tune the encodings as per our corpus instead of the previous corpus of text.", "After we have the language model learner, we can fit the learner over several epochs and save the encodings using the save_encoder method. We can see that the language model can on an average predict with a 38% accuracy what the next word would be given the current sequence of words which is pretty decent for this dataset.", "Once we have this ready, now we can move to the next step of creating a classifier to identify the probabilities for different labels of the comment_text.", "Before we move to creating a classification model, there\u2019s some bit of preprocessing that we need to perform in order to build a proper dataloader. At the time of writing this post, there\u2019s an issue with the DataBlocks API for text which avoids it from inferring all the dependent variables properly, hence we have to resort to this method.", "Basically, we will have to create another column in our dataframe which indicates the presence or absence of individual label using a fixed delimiter. So, if a comment is obscene and toxic, our new column will show obscene;toxic where delimiter is \u201c;\u201d. Also for the rows which don\u2019t have any objectionable text, we will call them sober for now for the sake of giving a label (without any label, fastai won\u2019t create the dataloader).", "So we can see that there\u2019s a column Labels added which contains a \u201c;\u201d delimited labels field where all our labels are denoted instead of the one-hot encoded format in which they\u2019re provided.", "Now, we create the dataloaders using the datablocks API using \u201ccomment_text\u201d field for x and \u201cLabels\u201d field for y respectively. If we would have mentioned the names of 6 columns as a list in the get_y field, it always picks up only two fields; due to this incorrect inference on the dataloader\u2019s part, we have to go through the process of creating a separate label column for getting the dependent variable i.e. y\u2019s values. Next, once we have the dataloader, we can build a classifier model using an LSTM architecture. Also we need to load the language model encodings/embeddings to the classifier once have instantiated it.", "Then we can start training the classifier. Initially, we will keep most of the network except the final FC layer frozen. This means that the back-propagation weight updates will only happen in the penultimate layer. Gradually we will unfreeze the previous layers until eventually we unfreeze the whole network. We do this because if we start with an unfrozen network, it will become difficult for the model to converge quickly to the optimal solution.", "It can be seen that the accuracy has reached a pretty solid 98% buy the end of the training. Since both train and valid loss both are decreasing, we can ideally train for more epochs and keep going but in the interest of time, we shall consider this a good enough score and start with the inference.", "Now that we have a trained model and we\u2019ve stored it as a pkl, we can use it for making predictions on previously unseen i.e. test data.", "We shall first load the model that we just created and trained on the GPU. (Since we have hundreds of thousands of comment texts, CPU inference will take a lot of time). Next we will tokenize the test_df and then pass it through the same transforms that were used for train and validation data to create a dataloader of test comments for inference.", "Next we will use the get_preds method for inference and remember to pass the reorder method to False otherwise there\u2019s a random shuffling of the texts that happens which will lead to incorrect order of predictions at the end.", "Finally, we shall format these predictions in the sample_submissions.csv style. So, after predictions, we get a set of 7 values one for each class and the probability of \u201csober\u201d class is not needed since it was introduced by us as a placeholder. We remove that and get all the ids in proper order. This is how the final submission looks like.", "Finally we can submit these predictions using the kaggle API itself. No need to manually go to kaggle and submit the csv file. It could be done simply by this shell command.", "You can change the submissions file name and message as per your own convenience. The final submission score I got is as shown below", "The top score on the leaderboard is around .9885 so our score is somewhat good with such few lines of code and little to no preprocessing. We could\u2019ve removed stopwords, cleaned html tags, tackled punctuation, tuned language model even more or used GloVE or Word2Vec embeddings and went for a complex model like Transformer instead of a simple LSTM. Many people have approached this differently and used some of these techniques to get to such high scores. However, with little effort and using the already implemented fastai library we could get a decent enough score right in our first attempt.", "On a closing thought, it is worth mentioning that this dataset as annotated by humans may have been mislabelled or there could have been subjective differences between people which is also fair because it\u2019s a very manual and monotonous job. We could aid that process by building a model, then using it to annotate and have humans supervise the annotations to make the process simpler or crowd-source this work to multiple volunteers to get a large corpus of labelled data in a small amount of time. In any case, NLP has become highly instrumental in tackling many language problems in the real world and hope after reading this post, you feel confident to start your journey in the world of text with fastai!", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F12688157d0e6&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcensoring-toxic-comments-using-fastai-v2-with-a-multi-label-text-classifier-12688157d0e6&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcensoring-toxic-comments-using-fastai-v2-with-a-multi-label-text-classifier-12688157d0e6&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcensoring-toxic-comments-using-fastai-v2-with-a-multi-label-text-classifier-12688157d0e6&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcensoring-toxic-comments-using-fastai-v2-with-a-multi-label-text-classifier-12688157d0e6&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----12688157d0e6--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----12688157d0e6--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://nayakvinayak95.medium.com/?source=post_page-----12688157d0e6--------------------------------", "anchor_text": ""}, {"url": "https://nayakvinayak95.medium.com/?source=post_page-----12688157d0e6--------------------------------", "anchor_text": "Vinayak Nayak"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F9b10ad08afc7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcensoring-toxic-comments-using-fastai-v2-with-a-multi-label-text-classifier-12688157d0e6&user=Vinayak+Nayak&userId=9b10ad08afc7&source=post_page-9b10ad08afc7----12688157d0e6---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F12688157d0e6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcensoring-toxic-comments-using-fastai-v2-with-a-multi-label-text-classifier-12688157d0e6&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F12688157d0e6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcensoring-toxic-comments-using-fastai-v2-with-a-multi-label-text-classifier-12688157d0e6&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@jontyson?utm_source=medium&utm_medium=referral", "anchor_text": "Jon Tyson"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://www.kaggle.com/c/jigsaw-toxic-comment-classification-challenge", "anchor_text": "Toxic Comment Classification Challenge on Kaggle."}, {"url": "https://medium.com/analytics-vidhya/how-to-fetch-kaggle-datasets-into-google-colab-ea682569851a", "anchor_text": "This post"}, {"url": "https://medium.com/u/a30a62d08d0c?source=post_page-----12688157d0e6--------------------------------", "anchor_text": "MRINALI GUPTA"}, {"url": "https://www.kaggle.com/c/jigsaw-toxic-comment-classification-challenge/overview", "anchor_text": "Toxic Comments dataset from Kaggle"}, {"url": "https://medium.com/analytics-vidhya/how-to-fetch-kaggle-datasets-into-google-colab-ea682569851a", "anchor_text": "How to use Kaggle API for downloading data"}, {"url": "https://github.com/ElisonSherton/fastai-basic-notebooks", "anchor_text": "Github repo with all code for this post"}, {"url": "https://colab.research.google.com/github/fastai/fastbook/blob/master/10_nlp.ipynb", "anchor_text": "ext classification notebook using fastai"}, {"url": "https://medium.com/tag/naturallanguageprocessing?source=post_page-----12688157d0e6---------------naturallanguageprocessing-----------------", "anchor_text": "Naturallanguageprocessing"}, {"url": "https://medium.com/tag/data-science?source=post_page-----12688157d0e6---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/python-programming?source=post_page-----12688157d0e6---------------python_programming-----------------", "anchor_text": "Python Programming"}, {"url": "https://medium.com/tag/text-classification?source=post_page-----12688157d0e6---------------text_classification-----------------", "anchor_text": "Text Classification"}, {"url": "https://medium.com/tag/fastai?source=post_page-----12688157d0e6---------------fastai-----------------", "anchor_text": "Fastai"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F12688157d0e6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcensoring-toxic-comments-using-fastai-v2-with-a-multi-label-text-classifier-12688157d0e6&user=Vinayak+Nayak&userId=9b10ad08afc7&source=-----12688157d0e6---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F12688157d0e6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcensoring-toxic-comments-using-fastai-v2-with-a-multi-label-text-classifier-12688157d0e6&user=Vinayak+Nayak&userId=9b10ad08afc7&source=-----12688157d0e6---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F12688157d0e6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcensoring-toxic-comments-using-fastai-v2-with-a-multi-label-text-classifier-12688157d0e6&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----12688157d0e6--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F12688157d0e6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcensoring-toxic-comments-using-fastai-v2-with-a-multi-label-text-classifier-12688157d0e6&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----12688157d0e6---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----12688157d0e6--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----12688157d0e6--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----12688157d0e6--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----12688157d0e6--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----12688157d0e6--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----12688157d0e6--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----12688157d0e6--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----12688157d0e6--------------------------------", "anchor_text": ""}, {"url": "https://nayakvinayak95.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://nayakvinayak95.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Vinayak Nayak"}, {"url": "https://nayakvinayak95.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "80 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F9b10ad08afc7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcensoring-toxic-comments-using-fastai-v2-with-a-multi-label-text-classifier-12688157d0e6&user=Vinayak+Nayak&userId=9b10ad08afc7&source=post_page-9b10ad08afc7--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fadfaf0b7759f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcensoring-toxic-comments-using-fastai-v2-with-a-multi-label-text-classifier-12688157d0e6&newsletterV3=9b10ad08afc7&newsletterV3Id=adfaf0b7759f&user=Vinayak+Nayak&userId=9b10ad08afc7&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}