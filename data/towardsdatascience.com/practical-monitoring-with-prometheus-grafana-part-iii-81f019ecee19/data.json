{"url": "https://towardsdatascience.com/practical-monitoring-with-prometheus-grafana-part-iii-81f019ecee19", "time": 1683008598.812342, "path": "towardsdatascience.com/practical-monitoring-with-prometheus-grafana-part-iii-81f019ecee19/", "webpage": {"metadata": {"title": "Kubernetes Monitoring with Prometheus & Grafana | Towards Data Science", "h1": "Practical Monitoring with Prometheus & Grafana (Part III)", "description": "Applying simple statistics (z-score) for anomaly detection using Prometheus."}, "outgoing_paragraph_urls": [{"url": "https://medium.com/@yitaek/practical-monitoring-with-prometheus-grafana-part-i-22d0f172f993", "anchor_text": "Part I", "paragraph_index": 0}, {"url": "https://medium.com/@yitaek/practical-monitoring-with-prometheus-grafana-part-ii-5020be20ebf6", "anchor_text": "Part II", "paragraph_index": 0}, {"url": "https://awesome-prometheus-alerts.grep.to/", "anchor_text": "Awesome Prometheus Alerts", "paragraph_index": 2}, {"url": "https://coreos.com/tectonic/docs/latest/tectonic-prometheus-operator/user-guides/default-alerts.html", "anchor_text": "Prometheus Operator", "paragraph_index": 2}, {"url": "https://github.com/AICoE/prometheus-anomaly-detector", "anchor_text": "AlCoE\u2019s Prometheus Anomaly Detector", "paragraph_index": 2}, {"url": "https://github.com/siimon/prom-client#default-metrics", "anchor_text": "default NodeJS metrics", "paragraph_index": 4}, {"url": "https://cloud.google.com/monitoring/api/metrics_gcp", "anchor_text": "here", "paragraph_index": 7}, {"url": "https://www.kitchensoap.com/2015/05/01/openlettertomonitoringproducts/", "anchor_text": "An Open Letter To Monitoring/Metrics/Alerting Companies", "paragraph_index": 9}, {"url": "https://github.com/twitter/AnomalyDetection", "anchor_text": "AnomalyDetection", "paragraph_index": 12}, {"url": "https://github.com/linkedin/luminol", "anchor_text": "Luminol", "paragraph_index": 12}, {"url": "https://towardsdatascience.com/6-ways-to-test-for-a-normal-distribution-which-one-to-use-9dcf47d8fa93", "anchor_text": "multiple ways", "paragraph_index": 24}, {"url": "https://medium.com/@yitaek/practical-monitoring-with-prometheus-grafana-part-iv-d4f3f995cc78", "anchor_text": "next and final post", "paragraph_index": 28}, {"url": "https://yitaekhwang.com", "anchor_text": "https://yitaekhwang.com", "paragraph_index": 31}], "all_paragraphs": ["In Part I and Part II of the Practical Monitoring with Prometheus and Grafana series, we installed the Prometheus blackbox exporter to probe HTTP endpoints and deployed our monitoring stack to Kubernetes via Helm. In this post, we will complement our black-box monitor with white-box monitoring techniques, namely anomaly detection using z-scores.", "While there are plenty of tutorials on monitoring Kubernetes metrics or using the Prometheus client library to scrape application data, few posts cover anomaly detection techniques on common metrics such as HTTP requests and message queue size. This post will walk through an example scenario involving a web server communicating to other microservices via a message queue. We will attempt to detect anomalies in HTTP requests and a spike in message queue size to create smart alerting rules.", "NOTE: For preconfigured Prometheus metrics and alerting rules, you can use Awesome Prometheus Alerts or modify default alerts from Prometheus Operator. If you have Thanos set up and want to dive deeper into ML models, you can also look at AlCoE\u2019s Prometheus Anomaly Detector project.", "To run anomaly detection, we\u2019ll first need data. I\u2019ll be using a NodeJS/Express server as an example, but you can find the corresponding Prometheus client for your language of choice to follow along.", "We will just use default settings (i.e. expose Prometheus metrics to the /metrics endpoint and collect default NodeJS metrics) and specify HTTP request duration buckets.", "Now the server will collect http_requests_total (a counter for total requests received with route, method, and status labels) and http_request_duration_seconds (HTTP duration in seconds with route, method, and status labels). Make a Docker image, add the Prometheus scrape annotations, and deploy the Helm chart on Kubernetes.", "For the message queue, I\u2019ll be using Google Pub/Sub and monitor via Stackdriver, but you can replace it with Prometheus exporters for Kafka, RabbitMQ, or other queue implementation of your choice.", "To deploy the Stackdriver exporter, first create a stackdriver.yaml file to specify GCP project ID and Stackdriver metrics to monitor. I\u2019m using a few PubSub metrics, but you can also find the full list of available GCP (and AWS) metrics here.", "Now deploy the chart and wait until metrics start to show up:", "\u201cTo detect anomalies perfectly, at the right time, is not possible\u201d- John Allspaw from An Open Letter To Monitoring/Metrics/Alerting Companies", "The tricky part of performing anomaly detection on time-series data using Prometheus is setting reasonable aggregations to the data. For our HTTP requests and PubSub metrics example, we have two choices to make:", "If the aggregation spans too much data, anomalies within subsets of our dataset may be obfuscated by overall trends. On the other hand, if the aggregation is too granular, then our model is susceptible to false positives. The level of aggregation will depend on your use case, but in most cases, using services (i.e. server for HTTP requests and topic/subscription for Pub/Sub) in 5m intervals seemed to be optimal.", "Advanced time-series anomaly detection techniques such as state-space models (ARIMA, Holt-Winters), decomposition (STL), or dimensionality reduction (RPCA, SOM) are impractical to do using Prometheus exclusively. To try those popular models, you can use Thanos to export your data and use R (Twitter\u2019s AnomalyDetection) or Python (LinkedIn\u2019s Luminol). But for us, assuming that our traffic is mostly normally-distributed, simple z-scores will get us started.", "A z-score is a statistical measure determined by the number of standard deviations(\u03c3) the raw score is from the mean. A z-score of 0 would mean that our score matches the mean of our data set. Using a standard normal distribution, we would then know that 95% of the data falls within ~2\u03c3 from the mean and ~99.7% of the data falls within 3\u03c3.", "Now, assuming a normal distribution for our HTTP request counts and PubSub metrics, we can use the z-score to flag data outside 3\u03c3 as anomalies and trigger alerts.", "With aggregation levels defined, we need to create recording rules to save precomputed values for faster z-score analysis. For example, we can create a metric that captures the HTTP request rate in 5m intervals, grouped by app like:", "Likewise, for PubSub metrics, we can track message size in 5m intervals grouped by topic:", "To apply the recording rules, append the recording_rules.yml section under serverFilesin the Helm chart:", "Now you should see the recording rules on Prometheus/Grafana:", "In order to calculate z-score, we need to compute the mean and the standard deviation for a specified time period. Since we\u2019re dealing with a web service, using one week\u2019s worth of data is a reasonable time period to compute weekly averages:", "NOTE: I\u2019ll just be including PubSub rules for brevity, but the same applies to HTTP requests. After adding the new rules, don\u2019t forget to deploy the new Prometheus server configurations to see changes.", "Let\u2019s now compute the weekly average and standard deviation values:", "Z-score is then our sample data point minus the mean all divided by the standard deviation:", "Once we graph the z-scores, it\u2019s easy to spot anomalies that fall outside our +/- 3\u03c3 range:", "One note of caution: using z-scores to determine outliers only works if our underlying assumption is correct \u2014 that is our aggregated data is normally distributed. There are multiple ways to test for normal distribution, but you can simply plot the aggregated recording rules to visually determine.", "If your data doesn\u2019t seem normally distributed, you can calculate z-scores to see if the range stays within ~-3.5 to +3.5. If you see extremely high or low values, the data is too skewed and may need to resort to data transformations to normalize the dataset.", "Finally, we can use this data to create alerts to notify when anomalies are detected. Simply add an alerting rule when the z-score falls outside 3\u03c3:", "We can complement this alert with simple threshold checks (e.g. alert when the number of undelivered messages is greater than 500) to reduce false positives and only alert when a true anomaly is detected. You can also add in other statistical methods like seasonality to account for traffic levels during the week vs. on the weekend.", "On the next and final post of the Practical Monitoring with Prometheus and Grafana series, we will secure the Grafana dashboard with GCP\u2019s IAP service to protect our ingress.", "You can find other posts in this series here:", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Software Engineer at NYDIG writing about cloud, DevOps/SRE, and crypto topics: https://yitaekhwang.com"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F81f019ecee19&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-monitoring-with-prometheus-grafana-part-iii-81f019ecee19&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-monitoring-with-prometheus-grafana-part-iii-81f019ecee19&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-monitoring-with-prometheus-grafana-part-iii-81f019ecee19&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-monitoring-with-prometheus-grafana-part-iii-81f019ecee19&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----81f019ecee19--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----81f019ecee19--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://yitaek.medium.com/?source=post_page-----81f019ecee19--------------------------------", "anchor_text": ""}, {"url": "https://yitaek.medium.com/?source=post_page-----81f019ecee19--------------------------------", "anchor_text": "Yitaek Hwang"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fa9626034cb21&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-monitoring-with-prometheus-grafana-part-iii-81f019ecee19&user=Yitaek+Hwang&userId=a9626034cb21&source=post_page-a9626034cb21----81f019ecee19---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F81f019ecee19&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-monitoring-with-prometheus-grafana-part-iii-81f019ecee19&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F81f019ecee19&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-monitoring-with-prometheus-grafana-part-iii-81f019ecee19&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@chrisliverani?utm_source=medium&utm_medium=referral", "anchor_text": "Chris Liverani"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://medium.com/@yitaek/practical-monitoring-with-prometheus-grafana-part-i-22d0f172f993", "anchor_text": "Part I"}, {"url": "https://medium.com/@yitaek/practical-monitoring-with-prometheus-grafana-part-ii-5020be20ebf6", "anchor_text": "Part II"}, {"url": "https://awesome-prometheus-alerts.grep.to/", "anchor_text": "Awesome Prometheus Alerts"}, {"url": "https://coreos.com/tectonic/docs/latest/tectonic-prometheus-operator/user-guides/default-alerts.html", "anchor_text": "Prometheus Operator"}, {"url": "https://github.com/AICoE/prometheus-anomaly-detector", "anchor_text": "AlCoE\u2019s Prometheus Anomaly Detector"}, {"url": "https://github.com/siimon/prom-client#default-metrics", "anchor_text": "default NodeJS metrics"}, {"url": "https://cloud.google.com/monitoring/api/metrics_gcp", "anchor_text": "here"}, {"url": "https://www.kitchensoap.com/2015/05/01/openlettertomonitoringproducts/", "anchor_text": "An Open Letter To Monitoring/Metrics/Alerting Companies"}, {"url": "https://github.com/twitter/AnomalyDetection", "anchor_text": "AnomalyDetection"}, {"url": "https://github.com/linkedin/luminol", "anchor_text": "Luminol"}, {"url": "https://commons.wikimedia.org/w/index.php?curid=2799839", "anchor_text": "https://commons.wikimedia.org/w/index.php?curid=2799839"}, {"url": "https://towardsdatascience.com/6-ways-to-test-for-a-normal-distribution-which-one-to-use-9dcf47d8fa93", "anchor_text": "multiple ways"}, {"url": "https://medium.com/@yitaek/practical-monitoring-with-prometheus-grafana-part-iv-d4f3f995cc78", "anchor_text": "next and final post"}, {"url": "https://medium.com/@yitaek/practical-monitoring-with-prometheus-grafana-part-i-22d0f172f993", "anchor_text": "Installing Prometheus + Grafana via Helm in 5 Minutes"}, {"url": "https://medium.com/@yitaek/practical-monitoring-with-prometheus-grafana-part-ii-5020be20ebf6", "anchor_text": "Using Prometheus blackbox exporter for free uptime checks"}, {"url": "https://towardsdatascience.com/practical-monitoring-with-prometheus-grafana-part-iii-81f019ecee19", "anchor_text": "Applying simple statistics for anomaly detection using Prometheus"}, {"url": "https://medium.com/@yitaek/practical-monitoring-with-prometheus-grafana-part-iv-d4f3f995cc78", "anchor_text": "Securing Grafana with Identity-Award Proxy"}, {"url": "https://medium.com/tag/prometheus?source=post_page-----81f019ecee19---------------prometheus-----------------", "anchor_text": "Prometheus"}, {"url": "https://medium.com/tag/anomaly-detection?source=post_page-----81f019ecee19---------------anomaly_detection-----------------", "anchor_text": "Anomaly Detection"}, {"url": "https://medium.com/tag/statistics?source=post_page-----81f019ecee19---------------statistics-----------------", "anchor_text": "Statistics"}, {"url": "https://medium.com/tag/towards-data-science?source=post_page-----81f019ecee19---------------towards_data_science-----------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/tag/stackdriver?source=post_page-----81f019ecee19---------------stackdriver-----------------", "anchor_text": "Stackdriver"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F81f019ecee19&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-monitoring-with-prometheus-grafana-part-iii-81f019ecee19&user=Yitaek+Hwang&userId=a9626034cb21&source=-----81f019ecee19---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F81f019ecee19&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-monitoring-with-prometheus-grafana-part-iii-81f019ecee19&user=Yitaek+Hwang&userId=a9626034cb21&source=-----81f019ecee19---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F81f019ecee19&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-monitoring-with-prometheus-grafana-part-iii-81f019ecee19&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----81f019ecee19--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F81f019ecee19&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-monitoring-with-prometheus-grafana-part-iii-81f019ecee19&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----81f019ecee19---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----81f019ecee19--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----81f019ecee19--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----81f019ecee19--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----81f019ecee19--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----81f019ecee19--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----81f019ecee19--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----81f019ecee19--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----81f019ecee19--------------------------------", "anchor_text": ""}, {"url": "https://yitaek.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://yitaek.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Yitaek Hwang"}, {"url": "https://yitaek.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "9.94K Followers"}, {"url": "https://yitaekhwang.com", "anchor_text": "https://yitaekhwang.com"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fa9626034cb21&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-monitoring-with-prometheus-grafana-part-iii-81f019ecee19&user=Yitaek+Hwang&userId=a9626034cb21&source=post_page-a9626034cb21--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F12e873a5ee0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpractical-monitoring-with-prometheus-grafana-part-iii-81f019ecee19&newsletterV3=a9626034cb21&newsletterV3Id=12e873a5ee0&user=Yitaek+Hwang&userId=a9626034cb21&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}