{"url": "https://towardsdatascience.com/medical-image-dataloaders-in-tensorflow-2-x-ee5327a4398f", "time": 1683018248.006891, "path": "towardsdatascience.com/medical-image-dataloaders-in-tensorflow-2-x-ee5327a4398f/", "webpage": {"metadata": {"title": "Medical Image Dataloaders in TensorFlow 2.x | by Prerak Mody | Towards Data Science", "h1": "Medical Image Dataloaders in TensorFlow 2.x", "description": "This post is the first in a series that shall discuss design choices to consider while using Tensorflow 2.x for deep learning on medical imaging tasks like organ segmentation."}, "outgoing_paragraph_urls": [{"url": "http://www.imagenglab.com/wiki/mediawiki/index.php?title=2015_MICCAI_Challenge", "anchor_text": "open dataset", "paragraph_index": 0}, {"url": "https://www.youtube.com/watch?v=W8RYqC3YZwM&feature=youtu.be", "anchor_text": "here", "paragraph_index": 0}, {"url": "https://github.com/prerakmody/medloader", "anchor_text": "code attached to this post", "paragraph_index": 1}, {"url": "https://www.tensorflow.org/api_docs/python/tf/data/Dataset", "anchor_text": "tensorflow dataset API documentation", "paragraph_index": 5}, {"url": "https://www.tensorflow.org/guide/function", "anchor_text": "to be included into the tensorflow graph", "paragraph_index": 11}, {"url": "https://en.wikipedia.org/wiki/Hounsfield_scale", "anchor_text": "HU (Hounsfield Units)", "paragraph_index": 14}, {"url": "https://www.tensorflow.org/api_docs/python/tf/data/Dataset#batch", "anchor_text": "batch", "paragraph_index": 18}, {"url": "https://www.tensorflow.org/api_docs/python/tf/data/Dataset#prefetch", "anchor_text": "prefetch", "paragraph_index": 18}, {"url": "https://www.tensorflow.org/api_docs/python/tf/data/Dataset#shuffle", "anchor_text": "shuffle", "paragraph_index": 18}, {"url": "https://www.tensorflow.org/api_docs/python/tf/data/Dataset#repeat", "anchor_text": "repeat", "paragraph_index": 20}, {"url": "https://www.tensorflow.org/api_docs/python/tf/data/Dataset", "anchor_text": "tensorflow documentation", "paragraph_index": 24}, {"url": "https://github.com/prerakmody/medloader", "anchor_text": "git repository", "paragraph_index": 25}, {"url": "https://www.linkedin.com/in/ravishivamautar/?originalSubdomain=nl", "anchor_text": "Ravi Autar", "paragraph_index": 26}], "all_paragraphs": ["This post is the first in a series that shall discuss design choices to consider while using Tensorflow 2.x for deep learning on medical imaging tasks like organ segmentation. These choices shall be considered in context of an open dataset containing organs delineations on CT images of the head-and-neck (HaN) area. A video can be found here", "My hope is that the code attached to this post, can be used as a boilerplate for any of your medical image (e.g. CT/MR volumes) loading, training and profiling projects. Using the folder hierarchy may also be useful for most tasks. Throughout this series, I shall be highlighting my important learnings by tagging them with the \u201cNote: \u201ddescription", "Note: One of the issues with medical image dataloaders is that they need to extract 3D subvolumes from the full CT/MR volume. This needs to be done as 3D deep learning models can have GPU memory requirements that may not permit the processing of a full 3D volume.", "So lets flow em\u2019 tensors (sry, couldn't resist the urge to sound tacky \ud83e\udd37).", "This post shall use dataset APIs defined by Tensorflow to leverage all the behind-the-scenes optimization in the library. The image below details the main operations in the data pipeline.", "As described in the tensorflow dataset API documentation, we shall look into how one can :-", "Certain parameters such as the data directory, subvolume dimensions, parallel processing threads need to be defined. All code with user defined parameters shall be in the ./demo directory while all core classes and functions shall be in the ./medloader directory.", "The git repo includes a built in downloader and extractor in ./medloader/dataloader/extractors . You could also define custom downloader and extractor code (e.g. han_miccai2015.py) for your own datasets and then call them in your main dataloader class.", "Since it is not possible to load all the medical data into memory, the tf.data.Dataset.from_generator() function can assist with loading data as required. The first argument to this function is another function that shall output data using the yield argument. The current implementation yields a (tf.int16 CT volume, tf.uint8 CT mask, tf.int32 meta1, tf.string meta2). This generator yields the whole volume and an internal function caches this volume for subsequent access. The meta arguments are useful for debugging reasons. Pseudo-code for this operation is shown below.", "Note: If yielded arguments are cast from numpy volumes to tensorflow tensors, subsequent operations (i.e. map and filter) take place on a GPU and are hence fast.", "The cached CT volumes from the generator function are turned into smaller volumes using border information within the meta1 tensor. The mask data is also one-hot encoded using tensor operations for efficiency. This is essentially a map operation performed using the tf.data.Dataset.map() function.", "The input to the map function is another function that is decorated with the tf.function decorator. This allows your custom-defined functions to be included into the tensorflow graph thus leading to performance improvement (more on this in the second post). Another input to the map function is the num_parallel_calls that can be used to leverage under-the-hood parallelization optimizations. One can set this value to a fixed number of threads or simply use tf.data.AUTOTUNE to dynamically let Tensorflow figure out how many CPU threads are up for grabs.", "Note: An important consideration while using python functions with the tensorflow decorator is to pass tensor objects and not python objects as much as possible. Passing python objects (which may change value during each function invocation) leads to Tensorflow seeing a different function signature and hence converting each invocation to a new node in the tensorflow graph, something that is pointlessly repetitive in nature. This is referred to as the polymorphic nature of the tf.function decorator. Tensorflow graphs and the tf.function decorator shall be explained in detail in the second post.", "Since CT/MR volumes of the HaN region contain a lot of background-only areas, we would only like to sample a fixed percentage of them (for negative sample training). Using the tf.data.Dataset.filter() function we pass another function that returns True or False .", "CT volumes have a unit of HU (Hounsfield Units) which measures the radiodensity of voxels in 3D space. The have a range from -1000 (Air) up to 2000 (Bone). For numerical stability, this data should be normalized.", "For data augmentation, the repository has an example for 3D rotation, but other operations such as 3D deformation and scaling can be also be used.", "Pseudo-code for map and filter operations is shown below.", "Now that the data pipeline has given us a CT/MR subvolume (and its associated mask), we can loop over the elements that this pipeline outputs. To club data samples together, the tf.data.Dataset API offers functions such as batch(), prefetch(), shuffle() and repeat() .", "Define values for the batch(), prefetch()and shuffle() depending on your GPU memory.", "Note: Its always better to have as large a batch size as possible.", "This is the final step, where once we set parameters on how to sample data, we need to simply repeat these operations for each epoch. Using the repeat(1) operation we can loop over the dataset as shown in the pseudo-code below.", "Organ segmentation is important in clinical applications such as image guided radiotherapy (IMRT) for cancer treatment. This series of posts shall discuss how one can perform automated organ segmentation using deep learning.", "This post highlighted some design factors to consider while writing an efficient tensorflow dataloader such as:", "Note: Efficiency in a tensorflow dataloader is defined by ensuring that your deep learning models are never idle and always have access to training data waiting in a queue to be processed.", "It might also be useful to refer to the tensorflow documentation as it captures more nuances of the Dataset API with updates taking place frequently. As of the writing of this post, the documentation contains only toy examples and no dedicated examples for medical image data loading and training.", "The associated git repository also indicates how one can write code in a defined directory structure instead of just simple code snippets.", "Special thanks to Ravi Autar \ud83e\udd1f", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "I'm a PhD Candidate at Leiden University Medical Centre. My research focuses on using deep learning for contour propagation of Organs at Risk in CT images."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fee5327a4398f&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-dataloaders-in-tensorflow-2-x-ee5327a4398f&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-dataloaders-in-tensorflow-2-x-ee5327a4398f&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-dataloaders-in-tensorflow-2-x-ee5327a4398f&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-dataloaders-in-tensorflow-2-x-ee5327a4398f&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----ee5327a4398f--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----ee5327a4398f--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://prerakmody.medium.com/?source=post_page-----ee5327a4398f--------------------------------", "anchor_text": ""}, {"url": "https://prerakmody.medium.com/?source=post_page-----ee5327a4398f--------------------------------", "anchor_text": "Prerak Mody"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fae8f6a712124&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-dataloaders-in-tensorflow-2-x-ee5327a4398f&user=Prerak+Mody&userId=ae8f6a712124&source=post_page-ae8f6a712124----ee5327a4398f---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fee5327a4398f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-dataloaders-in-tensorflow-2-x-ee5327a4398f&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fee5327a4398f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-dataloaders-in-tensorflow-2-x-ee5327a4398f&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@nci?utm_source=medium&utm_medium=referral", "anchor_text": "National Cancer Institute"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "http://www.imagenglab.com/wiki/mediawiki/index.php?title=2015_MICCAI_Challenge", "anchor_text": "open dataset"}, {"url": "https://www.youtube.com/watch?v=W8RYqC3YZwM&feature=youtu.be", "anchor_text": "here"}, {"url": "https://github.com/prerakmody/medloader", "anchor_text": "code attached to this post"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/data/Dataset", "anchor_text": "tensorflow dataset API documentation"}, {"url": "https://www.tensorflow.org/guide/function", "anchor_text": "to be included into the tensorflow graph"}, {"url": "https://en.wikipedia.org/wiki/Hounsfield_scale", "anchor_text": "HU (Hounsfield Units)"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/data/Dataset#batch", "anchor_text": "batch"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/data/Dataset#prefetch", "anchor_text": "prefetch"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/data/Dataset#shuffle", "anchor_text": "shuffle"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/data/Dataset#repeat", "anchor_text": "repeat"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/data/Dataset", "anchor_text": "tensorflow documentation"}, {"url": "https://github.com/prerakmody/medloader", "anchor_text": "git repository"}, {"url": "https://www.linkedin.com/in/ravishivamautar/?originalSubdomain=nl", "anchor_text": "Ravi Autar"}, {"url": "https://medium.com/tag/tensorflow?source=post_page-----ee5327a4398f---------------tensorflow-----------------", "anchor_text": "TensorFlow"}, {"url": "https://medium.com/tag/medical-image-analysis?source=post_page-----ee5327a4398f---------------medical_image_analysis-----------------", "anchor_text": "Medical Image Analysis"}, {"url": "https://medium.com/tag/dataloader?source=post_page-----ee5327a4398f---------------dataloader-----------------", "anchor_text": "Dataloader"}, {"url": "https://medium.com/tag/image-segmentation?source=post_page-----ee5327a4398f---------------image_segmentation-----------------", "anchor_text": "Image Segmentation"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----ee5327a4398f---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fee5327a4398f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-dataloaders-in-tensorflow-2-x-ee5327a4398f&user=Prerak+Mody&userId=ae8f6a712124&source=-----ee5327a4398f---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fee5327a4398f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-dataloaders-in-tensorflow-2-x-ee5327a4398f&user=Prerak+Mody&userId=ae8f6a712124&source=-----ee5327a4398f---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fee5327a4398f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-dataloaders-in-tensorflow-2-x-ee5327a4398f&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----ee5327a4398f--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fee5327a4398f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-dataloaders-in-tensorflow-2-x-ee5327a4398f&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----ee5327a4398f---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----ee5327a4398f--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----ee5327a4398f--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----ee5327a4398f--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----ee5327a4398f--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----ee5327a4398f--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----ee5327a4398f--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----ee5327a4398f--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----ee5327a4398f--------------------------------", "anchor_text": ""}, {"url": "https://prerakmody.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://prerakmody.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Prerak Mody"}, {"url": "https://prerakmody.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "41 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fae8f6a712124&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-dataloaders-in-tensorflow-2-x-ee5327a4398f&user=Prerak+Mody&userId=ae8f6a712124&source=post_page-ae8f6a712124--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F42f73a1c8107&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmedical-image-dataloaders-in-tensorflow-2-x-ee5327a4398f&newsletterV3=ae8f6a712124&newsletterV3Id=42f73a1c8107&user=Prerak+Mody&userId=ae8f6a712124&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}