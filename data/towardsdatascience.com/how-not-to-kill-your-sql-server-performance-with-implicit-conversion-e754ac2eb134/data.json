{"url": "https://towardsdatascience.com/how-not-to-kill-your-sql-server-performance-with-implicit-conversion-e754ac2eb134", "time": 1683010433.927992, "path": "towardsdatascience.com/how-not-to-kill-your-sql-server-performance-with-implicit-conversion-e754ac2eb134/", "webpage": {"metadata": {"title": "How (not) to kill your SQL Server performance with implicit conversion | by Nikola Ilic | Towards Data Science", "h1": "How (not) to kill your SQL Server performance with implicit conversion", "description": "In my recent article, I was investigating \u201cpros\u201d and \u201ccons\u201d between using DATETIME and DATETIME2 data types. This investigation appeared to be eye-opening for me, because, while reading documentation\u2026"}, "outgoing_paragraph_urls": [{"url": "https://towardsdatascience.com/datetime2-why-you-should-not-use-it-70e50ae2bab9", "anchor_text": "article", "paragraph_index": 0}, {"url": "https://www.sqlskills.com/blogs/jonathan/finding-implicit-column-conversions-in-the-plan-cache/", "anchor_text": "this article", "paragraph_index": 24}, {"url": "https://docs.microsoft.com/en-us/sql/t-sql/data-types/data-type-conversion-database-engine?view=sql-server-ver15", "anchor_text": "super useful table", "paragraph_index": 25}, {"url": "https://docs.microsoft.com/en-us/sql/t-sql/data-types/data-type-precedence-transact-sql?view=sql-server-ver15", "anchor_text": "here", "paragraph_index": 26}, {"url": "http://data-mozart.com", "anchor_text": "data-mozart.com", "paragraph_index": 31}], "all_paragraphs": ["In my recent article, I was investigating \u201cpros\u201d and \u201ccons\u201d between using DATETIME and DATETIME2 data types. This investigation appeared to be eye-opening for me, because, while reading documentation about those data types and potential drawbacks when using DATETIME2, I\u2019ve discovered a whole new set of stuff I need to take care of!", "In most simple words, Implicit conversion occurs when SQL Server needs to automatically convert some portion of data from one data type to another.", "In some cases, when you are performing JOINs, or filtering results using WHERE clause, you are comparing \u201capples\u201d and \u201coranges\u201d \u2014 therefore, SQL Server needs to convert \u201capples\u201d to \u201coranges\u201d, or vice versa.", "In order to resolve inconsistencies between data types, SQL Server must put additional effort and consume more resources. Thus, performance will suffer, leading to inefficient usage of indexes and extensive usage of CPU.", "But, enough theory, let\u2019s check how implicit conversion kills performance in reality.", "I have a table that contains data about chats initiated by customers. This table has around 8.6 million rows. One of the columns is \u201cSourceID\u201d, which is chat ID from the source system. In my table, this column is VARCHAR(20) type, despite all values contain only numbers.", "I have a unique non-clustered index on the SourceID column, and index on the DatetmStartUTC column (this index includes all other foreign key columns), so let\u2019s run few queries to check what\u2019s happening in the background.", "I\u2019ve also turned on statistics for IO and time, to be able to compare results. Finally, I\u2019ve turned on the Actual Execution Plan to get more insight into every specific step in query execution.", "When someone performs simple data profiling within this table and see only numbers in SourceID column, it is completely expected to write a query like this:", "SQL Server returns around 822.000 rows, which is approximately 10% of data in the whole table.", "One would expect that SQL Server uses an index on SourceID, but let\u2019s check if that\u2019s the case:", "As we can notice, SQL Server uses our index, but instead of choosing to perform expected Index Seek operation, it scans the index. And if we hover over the Index Scan step, we will see in Predicate pane that implicit conversion occurred, since SQL Server had to apply data conversion behind the scenes during the query process.", "That action has many additional impacts on performance \u2014 just looking at a number of logical reads and CPU costs, we can conclude that this is far from the optimal performance:", "Now, let\u2019s check how SQL Server reacts when we provide it with matching data type:", "Now, SQL Server performs Index Seek as expected, so let\u2019s additionally check what SQL Server did in the background to get our results back:", "Woohoo, almost 10 times less logical reads and CPU time! And just because SQL Server didn\u2019t have to push hard to apply implicit conversion during the query process.", "Now, just imagine the difference in performance on a larger portion of data (remember, this query returned only 10% of data within the table), or on larger tables.", "Now, I want to show you another way of helping SQL Server to do what it best does \u2014 choose an optimal plan for executing our queries.", "Instead of giving SQL Server proper data type in our variable definition, we can still use INT data type, but we can later EXPLICITLY tell SQL Server that we want to compare \u201capples\u201d with \u201capples\u201d (in our case, VARCHAR with VARCHAR):", "What we did here? We explicitly notified SQL Server what we want him to do: compare VARCHAR(20) column SourceID with VARCHAR(20) value of the variable.", "And SQL Server is grateful, as we can see if we look at the results:", "In the beginning, the Index Seek operation is there. Let\u2019s check statistics:", "Numbers are similar as in the previous run, so we can conclude that these two perform almost identical.", "Implicit Conversion can be a huuuuge performance killer and it is especially dangerous because it\u2019s not so obvious and easy to spot.", "Therefore, I recommend checking this article written by Jonathan Kehayias, where he provides a very useful script for identifying implicit conversions in your plan cache.", "Additionally, if you want to be sure when an implicit conversion occurs, check this super useful table provided by Microsoft directly:", "Data type precedence can be found here and it helps to understand how SQL Server will handle data type conversions. For example, INT has higher precedence than VARCHAR, which means that SQL Server will convert VARCHAR to INT, not the other way around.", "Therefore, if you compare a column of type INT with values of type VARCHAR, your index can still be used, because the column for comparison doesn\u2019t need transformation.", "Additionally, when comparing types from the same \u201cfamily\u201d (for example, INT and BIGINT) SQL Server will still prefer Index Seek operation, since it is smart enough to recognize those cases and use an appropriate index.", "To conclude, as a general rule of thumb: one should not count on SQL Server \u201cmercy\u201d or scratching his head with data type precedence \u2014 data types should match whenever possible, or comparison should be eventually handled using explicit conversion.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Data Mozart \u2014 Make Music from your Data!| data-mozart.com | @DataMozart | Microsoft Data Platform MVP | Power BI Addict | Blogger, speaker, learner\u2026"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fe754ac2eb134&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-not-to-kill-your-sql-server-performance-with-implicit-conversion-e754ac2eb134&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-not-to-kill-your-sql-server-performance-with-implicit-conversion-e754ac2eb134&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-not-to-kill-your-sql-server-performance-with-implicit-conversion-e754ac2eb134&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-not-to-kill-your-sql-server-performance-with-implicit-conversion-e754ac2eb134&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----e754ac2eb134--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----e754ac2eb134--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://datamozart.medium.com/?source=post_page-----e754ac2eb134--------------------------------", "anchor_text": ""}, {"url": "https://datamozart.medium.com/?source=post_page-----e754ac2eb134--------------------------------", "anchor_text": "Nikola Ilic"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F64005b7daa38&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-not-to-kill-your-sql-server-performance-with-implicit-conversion-e754ac2eb134&user=Nikola+Ilic&userId=64005b7daa38&source=post_page-64005b7daa38----e754ac2eb134---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fe754ac2eb134&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-not-to-kill-your-sql-server-performance-with-implicit-conversion-e754ac2eb134&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fe754ac2eb134&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-not-to-kill-your-sql-server-performance-with-implicit-conversion-e754ac2eb134&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@sarahjgualtieri?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Sarah Gualtieri"}, {"url": "https://unsplash.com/s/photos/apple-and-oranges?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Unsplash"}, {"url": "https://towardsdatascience.com/datetime2-why-you-should-not-use-it-70e50ae2bab9", "anchor_text": "article"}, {"url": "https://www.sqlskills.com/blogs/jonathan/finding-implicit-column-conversions-in-the-plan-cache/", "anchor_text": "this article"}, {"url": "https://docs.microsoft.com/en-us/sql/t-sql/data-types/data-type-conversion-database-engine?view=sql-server-ver15", "anchor_text": "super useful table"}, {"url": "https://docs.microsoft.com/en-us/sql/t-sql/data-types/data-type-precedence-transact-sql?view=sql-server-ver15", "anchor_text": "here"}, {"url": "https://medium.com/tag/towards-data-science?source=post_page-----e754ac2eb134---------------towards_data_science-----------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/tag/sql?source=post_page-----e754ac2eb134---------------sql-----------------", "anchor_text": "Sql"}, {"url": "https://medium.com/tag/sql-server?source=post_page-----e754ac2eb134---------------sql_server-----------------", "anchor_text": "Sql Server"}, {"url": "https://medium.com/tag/performance?source=post_page-----e754ac2eb134---------------performance-----------------", "anchor_text": "Performance"}, {"url": "https://medium.com/tag/data?source=post_page-----e754ac2eb134---------------data-----------------", "anchor_text": "Data"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fe754ac2eb134&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-not-to-kill-your-sql-server-performance-with-implicit-conversion-e754ac2eb134&user=Nikola+Ilic&userId=64005b7daa38&source=-----e754ac2eb134---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fe754ac2eb134&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-not-to-kill-your-sql-server-performance-with-implicit-conversion-e754ac2eb134&user=Nikola+Ilic&userId=64005b7daa38&source=-----e754ac2eb134---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fe754ac2eb134&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-not-to-kill-your-sql-server-performance-with-implicit-conversion-e754ac2eb134&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----e754ac2eb134--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fe754ac2eb134&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-not-to-kill-your-sql-server-performance-with-implicit-conversion-e754ac2eb134&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----e754ac2eb134---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----e754ac2eb134--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----e754ac2eb134--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----e754ac2eb134--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----e754ac2eb134--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----e754ac2eb134--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----e754ac2eb134--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----e754ac2eb134--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----e754ac2eb134--------------------------------", "anchor_text": ""}, {"url": "https://datamozart.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://datamozart.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Nikola Ilic"}, {"url": "https://datamozart.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "2.1K Followers"}, {"url": "http://data-mozart.com", "anchor_text": "data-mozart.com"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F64005b7daa38&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-not-to-kill-your-sql-server-performance-with-implicit-conversion-e754ac2eb134&user=Nikola+Ilic&userId=64005b7daa38&source=post_page-64005b7daa38--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F9fc5611a2826&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-not-to-kill-your-sql-server-performance-with-implicit-conversion-e754ac2eb134&newsletterV3=64005b7daa38&newsletterV3Id=9fc5611a2826&user=Nikola+Ilic&userId=64005b7daa38&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}