{"url": "https://towardsdatascience.com/multi-gpu-multi-process-with-tensorflow-ba4cc2fe3ab7", "time": 1682997203.026297, "path": "towardsdatascience.com/multi-gpu-multi-process-with-tensorflow-ba4cc2fe3ab7/", "webpage": {"metadata": {"title": "Multi GPU, multi process with Tensorflow | by Gr\u00e9goire Del\u00e9tang | Towards Data Science", "h1": "Multi GPU, multi process with Tensorflow", "description": "Tensorflow is a tremendous tool to experiment deep learning algorithms. But to exploit the power of deep learning, you need to leverage it with computing power, and good engineering. You will\u2026"}, "outgoing_paragraph_urls": [{"url": "https://www.tensorflow.org/guide/using_gpu", "anchor_text": "official tutorial", "paragraph_index": 0}, {"url": "https://jhui.github.io/2017/03/07/TensorFlow-GPU/", "anchor_text": "excellent article", "paragraph_index": 2}, {"url": "https://medium.com/@jonathan_hui/rl-policy-gradients-explained-9b13b688b146", "anchor_text": "this article", "paragraph_index": 8}, {"url": "https://towardsdatascience.com/how-to-teach-an-ai-to-play-games-deep-reinforcement-learning-28f9b920440a", "anchor_text": "this article", "paragraph_index": 9}, {"url": "https://blog.coast.ai/lets-evolve-a-neural-network-with-a-genetic-algorithm-code-included-8809bece164", "anchor_text": "this article", "paragraph_index": 10}, {"url": "https://github.com/fazega/snake-rl", "anchor_text": "github repo", "paragraph_index": 26}], "all_paragraphs": ["Tensorflow is a tremendous tool to experiment deep learning algorithms. But to exploit the power of deep learning, you need to leverage it with computing power, and good engineering. You will eventually need to use multiple GPU, and maybe even multiple processes to reach your goals. I recommend you to read the official tutorial about GPUs by TensorFlow first.", "This is the most common case, since the majority of the deep learning community is doing supervised learning, with a big dataset (images, text, sound \u2026) and many parameters. This is also the hardest one : you will need to parallelize back propagation over multiple computing units.", "Jonathan Hui posted an excellent article on this in 2017, so you can read it directly. This is not the point of this article.", "This is the real point of this article. If you\u2019re working on reinforcement learning, or \u201cfancy\u201d types of learning like genetic algorithms or reservoir computing for instance, you maybe noticed having multiple processes is essential.", "We\u2019ll try to solve the game of snake as an example. The snake is a chain of squares, and the goal is to eat the fruit on the grid. When eating a fruit, the snake length grows by one, and a new fruit appears randomly on the grid. The snake loses when it (accidentally) eats his tail.", "We\u2019ll have multiple agents playing at the same time to accelerate the learning process.", "We\u2019ll use a simple convolutional neural network, but you can use any model you want. We could also use a dense neural network or a decision tree for instance.", "This game is not \u201cdynamic\u201d : the policy the agent needs to take only depends on the last frame. Therefore the network is fed with the last frame, an image of 10x10 in the python version I developed. I use 100 4x4 filters followed by 200 3x3 filters. I finally flatten the convolutions, add a 200 dense layer, and the final output layer of length 4, for the 4 possible actions (up, right, left, down).", "We won\u2019t get into details, because it is not the main point here. You can use policy gradient for instance, where the output layer contains the probabilities for each action, and the idea of the algorithm is to \u201cboost\u201d the actions regarding to the score they lead to. I recommend you to read this article.", "You can also use Q-learning, where the output layer contains the average scores of each action in the specified state (input frame), and take the argmax of these scores to choose an action. I recommend you to read this article.", "Finally you can also use a genetic algorithm, where the idea is to add noise to the parameters (here the weights of the network) and only keep the best agents. I recommend you to read this article.", "OK, now we can (finally !) talk about multiprocessing. It is not an easy task in general. Here I don\u2019t talk about multithreading, which is way simpler but also less powerful.", "Multiprocessing means multi cores. You need as many cores as processes you want to launch (sometimes cores can handle multiple \u201cthreads\u201d so this is the number you care about inthe end).", "We\u2019ll use the instance p3.8xlarge from AWS, providing 32 vCores, and 4 V100 graphics cards. AWS leases it at around 12$/hour, while the investment would be around 45k$ for this set, plus the cost of energy needed to run it.", "We can therefore run 32 different agents at the same time, each one in a separate process. We\u2019ll use the package \u201cmultiprocessing\u201d in python. This package allows us to launch processes and create pipes to communicate with them. Here is the topology of our architecture :", "We\u2019ve got 32 worker processes, and 1 master process. The worker processes are only playing games to gather data and send it to the master process, which will train on these data and save the new network in a file. The workers then receive the message to load the new network, load it, and play N games again. Therefore we will need to launch 32 processes from our master process, and create a pipe between the master and each process (that is 32 pipes). We will also need to create threads inside the master process to listen to the pipes asynchronously. Here is the code for it :", "As you can see, we\u2019re creating the processes and pipes at the beginning, then initialize the dictionaries to store the last scores and batches of data (keys are process ids). Then we create the threads to listen to the agents and start them. The communication protocol is very simple, with only one word messages, like \u201csaved\u201d or \u201ctrain_with_batchs\u201d. Communicating between processes is not easy because you need to pass only serializable objects, so basically data which is easy to parse. You can\u2019t pass a Tensorflow session directly for instance. Finally we play games while storing the moving average of the scores in a file.", "Now we\u2019ll have a look at the AgentProcess class, which is very simple :", "The agent is creating its AI model, and is using it to play games. The scoring method is not my focus here but you can check it and tune it yourself to get better performance. The \u201cdata\u201d is a triple of (states,actions,rewards). Fairly easy, right ?", "Tensorflow by default chooses the first available GPU for your model, and allocate full memory on the device for your process. We want none of the two ! We want our worker processes to share a model, but allocate their own part of the GPU set for their own usage.", "Sharing the model is very hard, because Tensorflow does not allow to easily share graphs or sessions among multiple processes. I\u2019m currently going deep into Tensorflow to see if it\u2019s possible and improve performance. For now, the only solution I\u2019ve got is to instanciate a new Tensorflow core in each process, that is to say call \u201cimport tensorflow\u201d in the AgentProcess class. Each process will have its own graph and session.", "For GPU allocation, we have 32 processes, and 4 GPU with 16GB memory each. Increasing the memory per process increases the speed of the process to run the model. But the memory is limited so we have to do a very tight optimization, by hand \u2026 The training is done by the master process and needs a lot of memory, so I allocate almost one entire GPU for it.", "The final allocation is [3, 10, 10, 10] (number of processes per GPU, where the first one contains also the master). To limit the memory, you can either limit the proportion manually for each process with per_process_gpu_memory_fraction or gpu_options.allow_growth which will take care of the memory for you (not allocating all memory at initialisation, increase it only when needed). I used the latter. Here is the code :", "To force the process to use a specific GPU, I use the environment variable CUDA_VISIBLE_DEVICES, which is independent from the master process which forked the worker process.", "It is clear that increasing the number of processes increases the performance, simply because more batches have been processed.", "It\u2019s possible to use Tensorflow to do multiprocessing and do real reinforcement learning on \u201crather\u201d powerful machines. Remember, machine learning is not about how to imagine an algorithm, it\u2019s mainly about how to build it efficiently.", "Here is the whole github repo.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fba4cc2fe3ab7&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-gpu-multi-process-with-tensorflow-ba4cc2fe3ab7&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-gpu-multi-process-with-tensorflow-ba4cc2fe3ab7&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-gpu-multi-process-with-tensorflow-ba4cc2fe3ab7&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-gpu-multi-process-with-tensorflow-ba4cc2fe3ab7&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----ba4cc2fe3ab7--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----ba4cc2fe3ab7--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@gregoiredeletang?source=post_page-----ba4cc2fe3ab7--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@gregoiredeletang?source=post_page-----ba4cc2fe3ab7--------------------------------", "anchor_text": "Gr\u00e9goire Del\u00e9tang"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F657bc8b509dc&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-gpu-multi-process-with-tensorflow-ba4cc2fe3ab7&user=Gr%C3%A9goire+Del%C3%A9tang&userId=657bc8b509dc&source=post_page-657bc8b509dc----ba4cc2fe3ab7---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fba4cc2fe3ab7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-gpu-multi-process-with-tensorflow-ba4cc2fe3ab7&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fba4cc2fe3ab7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-gpu-multi-process-with-tensorflow-ba4cc2fe3ab7&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://www.tensorflow.org/guide/using_gpu", "anchor_text": "official tutorial"}, {"url": "https://jhui.github.io/2017/03/07/TensorFlow-GPU/", "anchor_text": "excellent article"}, {"url": "https://medium.com/@jonathan_hui/rl-policy-gradients-explained-9b13b688b146", "anchor_text": "this article"}, {"url": "https://towardsdatascience.com/how-to-teach-an-ai-to-play-games-deep-reinforcement-learning-28f9b920440a", "anchor_text": "this article"}, {"url": "https://blog.coast.ai/lets-evolve-a-neural-network-with-a-genetic-algorithm-code-included-8809bece164", "anchor_text": "this article"}, {"url": "https://github.com/fazega/snake-rl", "anchor_text": "github repo"}, {"url": "https://medium.com/tag/reinforcement-learning?source=post_page-----ba4cc2fe3ab7---------------reinforcement_learning-----------------", "anchor_text": "Reinforcement Learning"}, {"url": "https://medium.com/tag/gpu?source=post_page-----ba4cc2fe3ab7---------------gpu-----------------", "anchor_text": "Gpu"}, {"url": "https://medium.com/tag/tensorflow?source=post_page-----ba4cc2fe3ab7---------------tensorflow-----------------", "anchor_text": "TensorFlow"}, {"url": "https://medium.com/tag/multiprocessing?source=post_page-----ba4cc2fe3ab7---------------multiprocessing-----------------", "anchor_text": "Multiprocessing"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fba4cc2fe3ab7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-gpu-multi-process-with-tensorflow-ba4cc2fe3ab7&user=Gr%C3%A9goire+Del%C3%A9tang&userId=657bc8b509dc&source=-----ba4cc2fe3ab7---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fba4cc2fe3ab7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-gpu-multi-process-with-tensorflow-ba4cc2fe3ab7&user=Gr%C3%A9goire+Del%C3%A9tang&userId=657bc8b509dc&source=-----ba4cc2fe3ab7---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fba4cc2fe3ab7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-gpu-multi-process-with-tensorflow-ba4cc2fe3ab7&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----ba4cc2fe3ab7--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fba4cc2fe3ab7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-gpu-multi-process-with-tensorflow-ba4cc2fe3ab7&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----ba4cc2fe3ab7---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----ba4cc2fe3ab7--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----ba4cc2fe3ab7--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----ba4cc2fe3ab7--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----ba4cc2fe3ab7--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----ba4cc2fe3ab7--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----ba4cc2fe3ab7--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----ba4cc2fe3ab7--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----ba4cc2fe3ab7--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@gregoiredeletang?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@gregoiredeletang?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Gr\u00e9goire Del\u00e9tang"}, {"url": "https://medium.com/@gregoiredeletang/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "104 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F657bc8b509dc&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-gpu-multi-process-with-tensorflow-ba4cc2fe3ab7&user=Gr%C3%A9goire+Del%C3%A9tang&userId=657bc8b509dc&source=post_page-657bc8b509dc--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F9e19f894421c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-gpu-multi-process-with-tensorflow-ba4cc2fe3ab7&newsletterV3=657bc8b509dc&newsletterV3Id=9e19f894421c&user=Gr%C3%A9goire+Del%C3%A9tang&userId=657bc8b509dc&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}