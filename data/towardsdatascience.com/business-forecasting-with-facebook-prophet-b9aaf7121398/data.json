{"url": "https://towardsdatascience.com/business-forecasting-with-facebook-prophet-b9aaf7121398", "time": 1683008838.014028, "path": "towardsdatascience.com/business-forecasting-with-facebook-prophet-b9aaf7121398/", "webpage": {"metadata": {"title": "Business forecasting with Facebook Prophet | by Leif Arne Bakker | Towards Data Science", "h1": "Business forecasting with Facebook Prophet", "description": "Forecasting with time series models can be used by businesses for many purposes, for example, to optimise sales, improve supply chain planning and perform anomaly detection, to mention a few. There\u2026"}, "outgoing_paragraph_urls": [{"url": "https://peerj.com/preprints/3190.pdf", "anchor_text": "paper", "paragraph_index": 3}, {"url": "https://peerj.com/preprints/3190/", "anchor_text": "paper", "paragraph_index": 9}, {"url": "https://github.com/pixelbakker/datasets/blob/master/bikerides_day.csv", "anchor_text": "https://github.com/pixelbakker/datasets/blob/master/bikerides_day.csv", "paragraph_index": 10}, {"url": "https://github.com/dr-prodigy/python-holidays.", "anchor_text": "https://github.com/dr-prodigy/python-holidays.", "paragraph_index": 41}], "all_paragraphs": ["Forecasting with time series models can be used by businesses for many purposes, for example, to optimise sales, improve supply chain planning and perform anomaly detection, to mention a few. There is also a multitude of techniques you can use, from naive extrapolation of historical data to more sophisticated machine learning models. Some of the advanced techniques put considerable requirements on both the data, implementor and analysts, often making it hard to come up with stable performing forecast models. The nice thing about the Prophet library is that it is quite forgiving, meaning that it produces reasonable results out of the box. That said, Prophet is best suited for business-like time series with clear seasonality and where you know important business dates and events beforehand. It\u2019s also, like with most time series tools, good to have a data set with observations that span a few years.", "Lastly, Prophet is also quite easy to tune with its understandable hyper-parameters. In addition, it is extendable, so if you need to add additional regressors, seasonalities or special events you can do so easily.", "Imagine that we work as data analysts at a bike rental start-up, let\u2019s call it Acme Bikes, and we have gathered some data measuring people using their bikes to and from work. In addition, the dataset is augmented with historical rainfall and temperature data. We are asked to provide some insights into the dataset and provide a forecast model to estimate future commutes at any given time horizon. We are also asked to provide some indication of validity in the form of statistical tests. Are we up for it? But of course.", "Prophet takes a novel approach and sees forecasting mainly as a curve fitting exercise using probabilistic techniques and inspiration from generalised additive models. We will not dive into the mathematical details in this article but for those inclined, I suggest reading the original Prophet paper.", "The Prophet library is especially useful for business time series with clear seasonality and the knowledge of special events that have high impact on the data, for example, national holidays, Black Friday, the introduction of a new product, promotional campaigns and so on. To model time series Prophet separate the signal into the following additive components:", "g(t) is the trend function which models non-periodic changes using either a non linear saturation growth model or piecewise linear regression model. You can configure this using parameters.", "s(t) is the seasonal functional (yearly, weekly and daily) which models the periodic changes in the value of the time series. This component is modelled using a Fourier transform and if you want you can add your own seasonalities.", "h(t) represents the function for modelling holidays and special impact events. You can add your own set of custom holidays and special events.", "\u03b5t is the models error/noise which is assumed being normal distributed", "I think this approach is an intuitive and novel one and it\u2019s easy for analysts to get a conceptual understanding of what makes up the predictions. Later on we are going to verify that the model actually works the way as described mathematically. If you\u2019re interested in the mathematics and theory behind Prophet you can read their paper which nicely describes the rationale behind building the library in addition to diving deeper into the different components of the model. Enough talk, let\u2019s get started!", "For this imaginary example, I\u2019ve made a dataset by combining real world data from the Norwegian road authorities and the Norwegian Meteorological Institute. More specifically the data is counting bike commuters on a specific stretch in Oslo, Norway at Ullev\u00e5l. You can download the data her: https://github.com/pixelbakker/datasets/blob/master/bikerides_day.csv", "Before we start working we make a brief work breakdown as follows:", "For brevity, I\u2019ve chosen to provide a cleaned dataset so that we can spend most of our time with actual analysis and not sorting out bad data.", "Prophet is expecting columns to have specific names, ds for the temporal part and y for the value part. So we adhere to that.", "It\u2019s always a good idea to plot the data to get a first impression on what we are dealing with. I use plot.ly for custom charts \u2014 it\u2019s good.", "We can see that the data has clear seasonality and maybe a slight positive trend although that is harder to see. We can also notice quite a lot of variability. Some of the variability is probably caused by weekends when people are not commuting to work. Let\u2019s remove all the weekends from our data and see how it looks.", "Still some variability but considerable less. Hopefully much of the remaining variability can be explained by seasonality, holidays and our additional weather regressors: rain and temperature. We\u2019ll see shortly.", "For time-series it\u2019s often useful to do some form of power transform of the data to stabilise variance and make the data more normal distribution-like. But what transformation to use for the best result? Fortunately, we can use a Box Cox transformation that evaluates a set of lambda coefficients (\u03bb) and selects the value that achieves the best approximation of normality. We can do it like so:", "We can se that the variance is less now, especially around the seasonal peaks.", "When we\u2019re into plotting let\u2019s have a look at the rain and temperature data as well. Before we plot we normalise the data so we get comparable scales.", "Not surprisingly, the temperature is highly correlated to the commute volume. We see a break in the pattern in July most likely due to the Norwegian common holiday. When it comes to the rain it\u2019s harder to draw any conclusions from the plot but when zooming in there are signs that rain might play a role. We\u2019ll see.", "Ok, it looks like we are ready to go. Let\u2019s do some forecasting.", "The Prophet code flow is really simple: First get hold of a Prophet instance and fit a model with our bike rides data frame. Then we create a data frame holding the prediction dates (horizon) and pass that into the Prophet predict method, like so:", "When listing the forecast data-frame we get:", "The yhat-column contains the predictions and then you have lower and upper bands of the predictions. Although the forecast data frame contains all the data you need to make your own plots, Prophet also provides convenience methods for plotting. For brevity, we are going to use the built-in methods where we can, but when needed, we\u2019ll make our own custom plots with plotly. Plotting our forecast with Prophet can be done like so:", "You can also add change-points (where the trend model is shifting) to the plot like this:", "This Prophet plot does not contain all the change points, only the most important ones. If you want to view all of them you could use the following code:", "If we want we can also plot all the components that make up the model: trend, different seasonalities and holidays \u2014 we\u2019ll cover that in more detail later on. For now let\u2019s just look at the components using the built-in plotting method.", "We can see that we have a clear positive trend and that Monday and Tuesday are the days when most people commute. We also see a strong yearly seasonality.", "In order for us to find out how our model performs and know if we are making progress we need some form of validation. We could, of course, write our own validation code, but fortunately we don\u2019t have to, because Prophet provides most of what we need.", "The Prophet library makes it possible to divide our historical data into training data and testing data for cross validation. The main concepts for cross validation with Prophet are:", "The resulting data frame can now be used to compute error measures of yhat vs. y. Below I\u2019ve plotted a chart with some markers to help you understand in a more visual way. In this example, we have a one year horizon and the model will make predictions for each month (~31 days).", "So we have now made our first forecast with the Prophet library. But how do we know if the results are any good? Fortunately, Prophet comes with some built-in performance metrics that can help us out. I\u2019m not going into the details when it comes to which metrics to use and leave that up to you. The performance metrics available are:", "The code for validating and gathering performance metrics is shown below. First you need to get the cross validation data (we already did that in the above code listing, it\u2019s the data frame called cv_df )Then we put the cross validation data frame into the Prophet method perfomance_metrics , like so:", "Listing the performance data frame gives us the following:", "To see how our model performs over time up to the horizon we can use the built-in plot calledplot_cross_validation_metric , like this:", "We see that we got forecasts for each day up to the horizon. At the beginning, we see that the mean average percentage error (mape) is considerable but it also goes down considerably after a few days. Hopefully we can make this plot more performant as we start tuning our model.", "As we proceed we want to compare our validation results, so I\u2019ve chosen to make a spreadsheet on the side in which to store the intermediate results. Also, since we use transformed numbers (remember the Box Cox) we just use the percentage error metrics. To keep track, we collect the mean aggregated data from our cross validation like this:", "Which gives a listing like this:", "After our first run the results spreadsheet looks like this:", "Before moving on to improve our forecast model we\u2019ll add two utility functions so we don\u2019t need to change data all over the place if we want to test different cross validation set-ups. They look like this:", "Prophet has several ways of adding holidays and special events. The easiest and most convenient one is to use the built-in national holidays. The holidays for each country are provided by the holidays package in Python. A list of available countries, and the country name to use, is available on their page: https://github.com/dr-prodigy/python-holidays. We need Norwegian holidays so we do it like this:", "The last line of code lists all the built-in holidays and from the looks of it, the listing seems to be correct, although it could be augmented with dates for Christmas Eve or New Years eve and maybe others \u2014 but it\u2019s a start. If we want to see the forecast and the effects made by the holidays regressors we can plot it like this:", "And the plot looks like this:", "If we look at the cross validation data we can see that the model fits both May 1 and 17 very well but Ascension Day on May 30 2018, not so much. In addition Ascension Day in 2018 is on a Thursday and that tends to make people take Friday off in Norway. We can see this in the plot if we zoom in.", "We are not particularly impressed with the Christmas model fits either. If we zoom in on the plot for 2019 we can see this:", "Fortunately Prophet gives us the opportunity to add our own holidays and special dates. To see if we get an improved forecast we\u2019ll add some additional dates for the model to take into account. Like so:", "For the Ascension Day date I\u2019ve set the upper_window. This means that the effect of the day will spill over by one day so that we can capture the effect on Friday also. For the Christmas dates I\u2019ve set the lower window so that we can catch the day before Christmas Eve in Norway and the upper window to catch the whole Christmas vacation that many Norwegians have. We can now fit a new model and add the new holiday effects.", "The new plots show impressive improvements. Below you can see the plot for Christmas 2019 which now has been perfectly fitted.", "We leave the holidays for now, but before we move on, let\u2019s gather some performance data and update our performance table:", "As we can see the holiday tuning has a significant forecast effect. Now, let\u2019s add some extra regressors.", "If we look at the plot it doesn\u2019t look half bad but can we improve our forecast? Remember we had some extra weather data? Let\u2019s see if adding those as extra regressors will have any effect. Adding extra regressors is pretty straightforward but remember if you are going to use some in your forecast model you need to have the data present beforehand. With weather data this can be accomplished with weather forecasts. IMHO, the easiest and most solid extra regressors you can use are holidays and special dates that you know about, so I encourage you to do some extra work on those. But back to the weather data. We can add the rain and temperature data as extra regressors to the model like this (note that it\u2019s only two code lines that change but I leave the whole listing for easy execution):", "Looking at the plot it\u2019s obvious that both rain and temperature are having an impact on the forecast. Let\u2019s gather the performance data and update our performance table:", "It stars to look like something! Our mean average percentage error is now below 10%.", "Prophet has quite a few parameters for you to tune. I\u2019m not going to delve into the details of all of them but below you can see code that you can use for testing different hyper-parameters in a loop and then pick the best ones. Remember that if you choose to test all of the parameters in one go the number of permutations will be many and the running time will be considerable. I chose to tune one parameter at a time and I left the parameter arrays that I started with in the comments for you to try out yourself.", "To see if the tuning have any effect we fit a new mode with our new parameters set, like this:", "We see that we get some improvement on the mape metric, although not that much. From other time-series analysed I\u2019ve seen better results so I guess it\u2019s always worth trying out.", "Remember that in the beginning, we listed the mathematical formula that said that our forecast was the sum of the model components for trend, seasonality, holidays and so on. We can actually check that this is true. Let\u2019s first start by plotting all of the components.", "Plotly does a fantastic job charting, and you can toggle the viewing of the different components by clicking on the legend labels on the right for better readability.", "To check that the model's forecast is actually the sum of its components we can run the following snippet:", "And gets the confirmation like so:", "So, we\u2019re done for now. The last thing we want to do is to make an actual forecast. Remember that we must take the inverse of our Box Cox transformed numbers also and this is how you do it:", "Confirming that the scales are back and usable in the real world.", "In this article, you have learned how to use the Facebook Prophet library to make time series forecasts. We have learned how to use Box Cox transformation and how to add extra regressors and tune Prophet models to perform increasingly better. We started out with a mean percentage average error of ~17% and ended up with ~9%, a considerable improvement and a usable result. I hope this article was valuable to you and that you learned something that you can use in your own work.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "I am the business design lead at the Futurice Oslo office where I work with a wide range of stuff, from business model design to machine learning."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fb9aaf7121398&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbusiness-forecasting-with-facebook-prophet-b9aaf7121398&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbusiness-forecasting-with-facebook-prophet-b9aaf7121398&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbusiness-forecasting-with-facebook-prophet-b9aaf7121398&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbusiness-forecasting-with-facebook-prophet-b9aaf7121398&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----b9aaf7121398--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----b9aaf7121398--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@leif.arne.bakker_91283?source=post_page-----b9aaf7121398--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@leif.arne.bakker_91283?source=post_page-----b9aaf7121398--------------------------------", "anchor_text": "Leif Arne Bakker"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F619a5a7c0c22&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbusiness-forecasting-with-facebook-prophet-b9aaf7121398&user=Leif+Arne+Bakker&userId=619a5a7c0c22&source=post_page-619a5a7c0c22----b9aaf7121398---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fb9aaf7121398&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbusiness-forecasting-with-facebook-prophet-b9aaf7121398&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fb9aaf7121398&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbusiness-forecasting-with-facebook-prophet-b9aaf7121398&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "http://twitter.com/rosssneddon", "anchor_text": "@rosssneddon"}, {"url": "https://unsplash.com/photos/zNGPmIVPQf4", "anchor_text": "Unsplash"}, {"url": "https://peerj.com/preprints/3190.pdf", "anchor_text": "paper"}, {"url": "https://peerj.com/preprints/3190/", "anchor_text": "paper"}, {"url": "https://github.com/pixelbakker/datasets/blob/master/bikerides_day.csv", "anchor_text": "https://github.com/pixelbakker/datasets/blob/master/bikerides_day.csv"}, {"url": "https://github.com/dr-prodigy/python-holidays.", "anchor_text": "https://github.com/dr-prodigy/python-holidays."}, {"url": "https://medium.com/tag/timeseries-forecasting?source=post_page-----b9aaf7121398---------------timeseries_forecasting-----------------", "anchor_text": "Timeseries Forecasting"}, {"url": "https://medium.com/tag/timeseries?source=post_page-----b9aaf7121398---------------timeseries-----------------", "anchor_text": "Timeseries"}, {"url": "https://medium.com/tag/business-forecasts?source=post_page-----b9aaf7121398---------------business_forecasts-----------------", "anchor_text": "Business Forecasts"}, {"url": "https://medium.com/tag/forecast-market?source=post_page-----b9aaf7121398---------------forecast_market-----------------", "anchor_text": "Forecast Market"}, {"url": "https://medium.com/tag/facebook-prophet?source=post_page-----b9aaf7121398---------------facebook_prophet-----------------", "anchor_text": "Facebook Prophet"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fb9aaf7121398&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbusiness-forecasting-with-facebook-prophet-b9aaf7121398&user=Leif+Arne+Bakker&userId=619a5a7c0c22&source=-----b9aaf7121398---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fb9aaf7121398&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbusiness-forecasting-with-facebook-prophet-b9aaf7121398&user=Leif+Arne+Bakker&userId=619a5a7c0c22&source=-----b9aaf7121398---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fb9aaf7121398&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbusiness-forecasting-with-facebook-prophet-b9aaf7121398&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----b9aaf7121398--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fb9aaf7121398&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbusiness-forecasting-with-facebook-prophet-b9aaf7121398&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----b9aaf7121398---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----b9aaf7121398--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----b9aaf7121398--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----b9aaf7121398--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----b9aaf7121398--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----b9aaf7121398--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----b9aaf7121398--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----b9aaf7121398--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----b9aaf7121398--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@leif.arne.bakker_91283?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@leif.arne.bakker_91283?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Leif Arne Bakker"}, {"url": "https://medium.com/@leif.arne.bakker_91283/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "51 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F619a5a7c0c22&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbusiness-forecasting-with-facebook-prophet-b9aaf7121398&user=Leif+Arne+Bakker&userId=619a5a7c0c22&source=post_page-619a5a7c0c22--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fe81d622d2d00&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbusiness-forecasting-with-facebook-prophet-b9aaf7121398&newsletterV3=619a5a7c0c22&newsletterV3Id=e81d622d2d00&user=Leif+Arne+Bakker&userId=619a5a7c0c22&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}