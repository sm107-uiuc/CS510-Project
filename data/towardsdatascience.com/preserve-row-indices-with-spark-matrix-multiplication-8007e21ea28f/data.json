{"url": "https://towardsdatascience.com/preserve-row-indices-with-spark-matrix-multiplication-8007e21ea28f", "time": 1683018069.3052359, "path": "towardsdatascience.com/preserve-row-indices-with-spark-matrix-multiplication-8007e21ea28f/", "webpage": {"metadata": {"title": "Preserve Row Indices with Spark Matrix Multiplication | by Shomit Goyal | Towards Data Science", "h1": "Preserve Row Indices with Spark Matrix Multiplication", "description": "Matrix multiplications are quite common in machine learning. For example, in case of a fully connected neural network we can vectorise the forward prop and define it as a sequence of matrix\u2026"}, "outgoing_paragraph_urls": [], "all_paragraphs": ["Matrix multiplications are quite common in machine learning. For example, in case of a fully connected neural network we can vectorise the forward prop and define it as a sequence of matrix multiplications. This vectorised implementation gives significant boost to the computations and makes training and scoring of deep neural nets feasible. Matrix multiplications are also very common in collaborative filtering implementations where we have a guest matrix consisting of every guest\u2019s latent vectors and an item matrix consisting of every item\u2019s latent vectors. The multiplication of these two matrices gives us the full guest-item rating matrix indicating every guest\u2019s predicted rating for every item.", "In this article we\u2019ll start by briefly describing spark MLlib\u2019s matrix API and how we can use it for large scale matrix multiplication. Then we\u2019ll get into the problem of row index preservation and talk about a neat little trick where we\u2019ll embed the row indices as dummy values in the original matrix to solve the problem. This will enable us to get back the original row indices from the matrix multiplication output. We\u2019ll then conclude the discussion with the pyspark implementation of this solution.", "Spark\u2019s MLlib provides a few convenient RDD based APIs to enable efficient matrix computations. There are 2 types of matrices that are available:", "The matrix APIs discussed above provide functionalities to perform various matrix algebra operations such as addition, multiplication, transpose etc. In this article we\u2019ll be focusing on matrix multiplication and a challenge associated with it, called row index preservation.", "Say we want to multiply a matrix A of dimensions m x n with another matrix B of dimensions n x k which will result into a new matrix of dimensions m x k. In its most basic form, this multiplication can be thought of as the dot product between every row vector of matrix A with every column vector of matrix B resulting into a total of m*k vector dot products. If the matrix A and B were small and runtime wasn\u2019t a concern we could simply store both the matrices A and B as separate RDDs and perform a cross join of two RDDs followed by a map operation to get an element-wise dot product and this will give us the values of the desired matrix. But in practise, while working on big data applications (think deep learning, collaborative filtering etc) we deal with matrices which are very large, say 100 million x 1 million. In such large settings, carrying out the cross join and vector dot product is very inefficient and suboptimal. Here we would like to utilise the vectorised algorithms for matrix multiplication which are much faster than the element wise multiplication or vector dot products. The matrix APIs provided by spark allows us to do exactly that. We can use eitherIndexedRowMatrix or BlockMatrix from spark\u2019s MLlib to carry out distributed matrix multiplications. In practise I have found BlockMatrix multiplications to be rather inefficient with respect to the computation time, so we will focus our attention to matrix multiplications using IndexedRowMatrix but the content that follows is applicable to BlockMatrix as well.", "Entry at (i, j) position in a matrix that is a result of a multiplication of two matrices represents the multiplication of ith row of the first matrix with jth row of the second matrix. When using the matrix multiplication function of spark\u2019s IndexedRowMatrix API which lets us multiply an IndexedRowMatrix with a LocalMatrix, the row ordering is guaranteed to be preserved only within every partition. What this means is that if the underlying rdd of our IndexedRowMatrix is distributed across many partitions then after multiplying it with a local matrix the ith row in the resulting matrix is not guaranteed to correspond to the ith row of the original matrix. This poses a huge issue as we don\u2019t have any way to link the results back to the original row identifiers.", "For example say we are working on a collaborative filtering algorithm and we have a guest matrix where we know which row index maps to which guest, we also have an item matrix. We multiply these two matrices and get the guest-item rating matrix, but if the row orders are not preserved, a particular row in the rating matrix will not necessarily correspond to the same guest that it was pointing to in the original guest matrix.", "To solve this problem, we\u2019ll implement a neat little trick where we will add a few dummy values to the original matrices so that we can reproduce the original row indices as the first column of the resulting matrix after multiplication. To do this, we\u2019ll add a dummy column to the original guest matrix at the beginning, having the row numbers as the values. We will alos add a dummy column and a dummy row to the original item matrix at the beginning having all the values as 0 except the (0,0) value which is set to 1. The image below illustrate this by comparing the original matrix multiplication with the one after employing this trick. The dummy rows and columns are highlighted in green.", "You can get the ipython notebook implementation of the content discussed in this article in the following github repository:", "Matrix multiplications are at the core of modern day machine learning and deep learning algorithms and the ability to perform them in a distributed manner is key for scaling these algorithms for the large amounts of data that is readily available in the current age. Spark provides very useful matrix APIs to carry out operations on matrices but it has certain limitations. In most cases one can find a workaround to deal with these limitations by being a bit creative. In this article we saw one such limitation with spark\u2019s matrix API called row index preservation and a quick and easy way to fix that.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Practise until you get it right and then keep practising until you can\u2019t get it wrong."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F8007e21ea28f&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpreserve-row-indices-with-spark-matrix-multiplication-8007e21ea28f&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpreserve-row-indices-with-spark-matrix-multiplication-8007e21ea28f&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpreserve-row-indices-with-spark-matrix-multiplication-8007e21ea28f&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpreserve-row-indices-with-spark-matrix-multiplication-8007e21ea28f&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----8007e21ea28f--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----8007e21ea28f--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://shomitg.medium.com/?source=post_page-----8007e21ea28f--------------------------------", "anchor_text": ""}, {"url": "https://shomitg.medium.com/?source=post_page-----8007e21ea28f--------------------------------", "anchor_text": "Shomit Goyal"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F5ff232147dd4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpreserve-row-indices-with-spark-matrix-multiplication-8007e21ea28f&user=Shomit+Goyal&userId=5ff232147dd4&source=post_page-5ff232147dd4----8007e21ea28f---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F8007e21ea28f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpreserve-row-indices-with-spark-matrix-multiplication-8007e21ea28f&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F8007e21ea28f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpreserve-row-indices-with-spark-matrix-multiplication-8007e21ea28f&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://towardsdatascience.com/tagged/getting-started", "anchor_text": "Getting Started"}, {"url": "https://unsplash.com/@comparefibre?utm_source=medium&utm_medium=referral", "anchor_text": "Compare Fibre"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://issues.apache.org/jira/browse/SPARK-8614", "anchor_text": "https://issues.apache.org/jira/browse/SPARK-8614"}, {"url": "https://github.com/hl475/svd/pull/1", "anchor_text": "https://github.com/hl475/svd/pull/1"}, {"url": "https://github.com/Shomitg/matrix-multiplication-spark", "anchor_text": "Shomitg/matrix-multiplication-sparkA trick to preserve the ordering of rows and keep track of indices while multiplying large distributed matrices using\u2026github.com"}, {"url": "https://medium.com/tag/spark?source=post_page-----8007e21ea28f---------------spark-----------------", "anchor_text": "Spark"}, {"url": "https://medium.com/tag/collaborative-filtering?source=post_page-----8007e21ea28f---------------collaborative_filtering-----------------", "anchor_text": "Collaborative Filtering"}, {"url": "https://medium.com/tag/math-tricks?source=post_page-----8007e21ea28f---------------math_tricks-----------------", "anchor_text": "Math Tricks"}, {"url": "https://medium.com/tag/programming-tricks?source=post_page-----8007e21ea28f---------------programming_tricks-----------------", "anchor_text": "Programming Tricks"}, {"url": "https://medium.com/tag/getting-started?source=post_page-----8007e21ea28f---------------getting_started-----------------", "anchor_text": "Getting Started"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F8007e21ea28f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpreserve-row-indices-with-spark-matrix-multiplication-8007e21ea28f&user=Shomit+Goyal&userId=5ff232147dd4&source=-----8007e21ea28f---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F8007e21ea28f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpreserve-row-indices-with-spark-matrix-multiplication-8007e21ea28f&user=Shomit+Goyal&userId=5ff232147dd4&source=-----8007e21ea28f---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F8007e21ea28f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpreserve-row-indices-with-spark-matrix-multiplication-8007e21ea28f&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----8007e21ea28f--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F8007e21ea28f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpreserve-row-indices-with-spark-matrix-multiplication-8007e21ea28f&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----8007e21ea28f---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----8007e21ea28f--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----8007e21ea28f--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----8007e21ea28f--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----8007e21ea28f--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----8007e21ea28f--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----8007e21ea28f--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----8007e21ea28f--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----8007e21ea28f--------------------------------", "anchor_text": ""}, {"url": "https://shomitg.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://shomitg.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Shomit Goyal"}, {"url": "https://shomitg.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "7 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F5ff232147dd4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpreserve-row-indices-with-spark-matrix-multiplication-8007e21ea28f&user=Shomit+Goyal&userId=5ff232147dd4&source=post_page-5ff232147dd4--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fff23ed60a1eb&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpreserve-row-indices-with-spark-matrix-multiplication-8007e21ea28f&newsletterV3=5ff232147dd4&newsletterV3Id=ff23ed60a1eb&user=Shomit+Goyal&userId=5ff232147dd4&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}