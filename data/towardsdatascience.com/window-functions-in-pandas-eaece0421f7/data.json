{"url": "https://towardsdatascience.com/window-functions-in-pandas-eaece0421f7", "time": 1682992995.735481, "path": "towardsdatascience.com/window-functions-in-pandas-eaece0421f7/", "webpage": {"metadata": {"title": "Window Functions In Pandas. Running Totals, Period To Date Returns\u2026 | by Tony Yiu | Towards Data Science", "h1": "Window Functions In Pandas", "description": "SQL has a neat feature called window functions. By the way, you should definitely know how to work with these in SQL if you are looking for a data analyst job. Pandas (with a little bit of legwork)\u2026"}, "outgoing_paragraph_urls": [{"url": "https://tonester524.medium.com/membership", "anchor_text": "If you liked this article and my writing in general, please consider supporting my writing by signing up for Medium via my referral link here. Thanks!", "paragraph_index": 24}, {"url": "https://tonester524.medium.com/membership", "anchor_text": "https://tonester524.medium.com/membership", "paragraph_index": 26}], "all_paragraphs": ["SQL has a neat feature called window functions. By the way, you should definitely know how to work with these in SQL if you are looking for a data analyst job. Pandas (with a little bit of legwork) allows us to do the same things. Let\u2019s see how.", "Window functions allow us to perform an operation with a given row\u2019s data and data from another row that is a specified number of rows away \u2014 this \u201cnumber of rows away value\u201d is called the window.", "For example, let\u2019s say you have 10 days of stock prices:", "Window functions allow us to perform computations among the values of a specified column. For example, I might want to compare today\u2019s stock price with yesterday\u2019s \u2014 then I would want a window of \u201c1\u201d looking backwards. A window function allows us to do that. If on the other hand, I want to compare today\u2019s price with the price 1 year ago, then I would want a window of \u201c356\u201d (assuming weekends are in your dataset).", "Window functions are especially useful for time series data where at each point in time in your data, you are only supposed to know what has happened as of that point (no crystal balls allowed). The good news is that windows functions exist in pandas and they are very easy to use.", "Let\u2019s say we want to calculate the daily change in price of our stock. To do this we would need to take each day\u2019s price and divide it by the previous day\u2019s price and subtract 1. We get our data as a list:", "Lists are not very math friendly so we can put our data in a numpy array (I reshape it to be a 9 by 1 array so that it\u2019s easier to view and display):", "Cool, we got the returns. No need for dataframes right? Well, not exactly. Dataframes are more versatile than numpy arrays (which are optimized for dealing with numerical data). And the developers of pandas have created all these nifty window methods to make our lives easier \u2014 they would be sad if we didn\u2019t take advantage.", "So let\u2019s put our stock prices into a dataframe:", "We can use the shift method to get the previous day\u2019s price. The shift method is very similar to SQL\u2019s lag function. The \u201c1\u201d tells it to lag things by one day, giving us the previous day\u2019s price:", "Cool, now we just need to divide price by prev_price and subtract 1 to get the daily return:", "We can do a lot more than just calculating returns. For example, say we want to compare our daily return to an expanding window average return in order to see how each return compares to the historical average. You might think, why not just calculate the average of all the values in the daily return_column and use that? The answer is data leakage.", "In time series analysis, when we are trying to forecast the future, we need to be really careful about what could have been observed and what could not have been observed on a specific date. For example, on day 5 of our dataset, we can only observe the first 5 prices: 100, 98, 95, 96, 99. So if we are testing features in order to make a forecast for day 6, we can\u2019t compare day 5\u2019s return of 3.03% with the mean daily change of the entire period because on day 5, we have not yet observed days 6 through 9.", "That\u2019s where an expanding window comes in. In case you are not familiar with expanding and rolling windows, the following picture visualizes what they are. With an expanding window, we calculate metrics in an expanding fashion \u2014 meaning that we include all rows up to the current one in the calculation. A rolling window allows us to calculate metrics on a rolling basis \u2014 for example, rolling(3) means that we use the current observation as well as the two preceding ones in order to calculate our desired metric.", "The rationale behind using an expanding window is that with every day that passes, we get another price and another daily change that we can add to our mean calculation. That\u2019s new information that we should capture in our calculated metrics. We can do this with the following code (I also threw in a 3 day rolling window as well for fun).", "Calling .expanding() on a pandas dataframe or series creates a pandas expanding object. It\u2019s a lot like the more well known groupby object (which groups things based on specified column labels). The expanding (or rolling) object is what allows us to calculate various metrics in an expanding fashion. Let\u2019s see what our dataframe looks like now:", "Notice that on day 1, expand_mean and daily_return are equal \u2014 that\u2019s necessarily the case because we are calculating the expanding mean with only one daily return on day 1. Also, on day 3 when we finally have enough data to calculate our rolling 3 day mean, roll_mean_3\u2019s first value is equal to expand_mean. That makes sense too \u2014 on day 3, our expanding mean is also calculated using the most recent 3 days\u2019 returns.", "Here is the plot (and code) of the stock\u2019s daily returns and the 2 means that we calculated:", "We can apply other functions besides the mean as well. Let\u2019s say our boss comes over and says, \u201cI want you to keep track of how many days this stock has been up.\u201d", "We can do this using an expanding object and the sum method (for keeping a running total). First we need to add a column to our dataframe to denote whether the stock was up that day or not. We can take advantage of the apply method (which applies a function to each row in the dataframe or series). We can either define a function to give apply or use a lambda function \u2014 I opted for a lambda function (fewer lines of code) that takes each return and returns 1 if it\u2019s positive and 0 if it\u2019s negative.", "Once we have the \u201cpositive\u201d column, we can apply an expanding window to it and the sum method (since each positive day is denoted by a 1, we just need to keep a running total of the number of 1s):", "And the dataframe that we would send to our boss looks like this:", "So as of right now, there are 6 positive days for the stock. But going forward as we collect more prices, our running total will update with it. Nice, our boss should be happy with this.", "Thanks for reading! Cheers and stay safe and healthy everyone.", "If you liked this article and my writing in general, please consider supporting my writing by signing up for Medium via my referral link here. Thanks!", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Data scientist. Founder Alpha Beta Blog. Doing my best to explain the complex in plain English. Support my writing: https://tonester524.medium.com/membership"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Feaece0421f7&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwindow-functions-in-pandas-eaece0421f7&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwindow-functions-in-pandas-eaece0421f7&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwindow-functions-in-pandas-eaece0421f7&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwindow-functions-in-pandas-eaece0421f7&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----eaece0421f7--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----eaece0421f7--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://tonester524.medium.com/?source=post_page-----eaece0421f7--------------------------------", "anchor_text": ""}, {"url": "https://tonester524.medium.com/?source=post_page-----eaece0421f7--------------------------------", "anchor_text": "Tony Yiu"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F840a3210fbe7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwindow-functions-in-pandas-eaece0421f7&user=Tony+Yiu&userId=840a3210fbe7&source=post_page-840a3210fbe7----eaece0421f7---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Feaece0421f7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwindow-functions-in-pandas-eaece0421f7&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Feaece0421f7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwindow-functions-in-pandas-eaece0421f7&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@mooo3721?utm_source=medium&utm_medium=referral", "anchor_text": "R Mo"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://tonester524.medium.com/membership", "anchor_text": "If you liked this article and my writing in general, please consider supporting my writing by signing up for Medium via my referral link here. Thanks!"}, {"url": "https://medium.com/tag/data-science?source=post_page-----eaece0421f7---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/programming?source=post_page-----eaece0421f7---------------programming-----------------", "anchor_text": "Programming"}, {"url": "https://medium.com/tag/technology?source=post_page-----eaece0421f7---------------technology-----------------", "anchor_text": "Technology"}, {"url": "https://medium.com/tag/coding?source=post_page-----eaece0421f7---------------coding-----------------", "anchor_text": "Coding"}, {"url": "https://medium.com/tag/analytics?source=post_page-----eaece0421f7---------------analytics-----------------", "anchor_text": "Analytics"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Feaece0421f7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwindow-functions-in-pandas-eaece0421f7&user=Tony+Yiu&userId=840a3210fbe7&source=-----eaece0421f7---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Feaece0421f7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwindow-functions-in-pandas-eaece0421f7&user=Tony+Yiu&userId=840a3210fbe7&source=-----eaece0421f7---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Feaece0421f7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwindow-functions-in-pandas-eaece0421f7&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----eaece0421f7--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Feaece0421f7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwindow-functions-in-pandas-eaece0421f7&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----eaece0421f7---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----eaece0421f7--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----eaece0421f7--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----eaece0421f7--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----eaece0421f7--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----eaece0421f7--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----eaece0421f7--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----eaece0421f7--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----eaece0421f7--------------------------------", "anchor_text": ""}, {"url": "https://tonester524.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://tonester524.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Tony Yiu"}, {"url": "https://tonester524.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "102K Followers"}, {"url": "https://tonester524.medium.com/membership", "anchor_text": "https://tonester524.medium.com/membership"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F840a3210fbe7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwindow-functions-in-pandas-eaece0421f7&user=Tony+Yiu&userId=840a3210fbe7&source=post_page-840a3210fbe7--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F78d3e392d884&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fwindow-functions-in-pandas-eaece0421f7&newsletterV3=840a3210fbe7&newsletterV3Id=78d3e392d884&user=Tony+Yiu&userId=840a3210fbe7&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}