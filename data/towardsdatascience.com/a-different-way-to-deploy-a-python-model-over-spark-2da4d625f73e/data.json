{"url": "https://towardsdatascience.com/a-different-way-to-deploy-a-python-model-over-spark-2da4d625f73e", "time": 1682996089.927787, "path": "towardsdatascience.com/a-different-way-to-deploy-a-python-model-over-spark-2da4d625f73e/", "webpage": {"metadata": {"title": "A different way to deploy a Python model over Spark | by Schaun Wheeler | Towards Data Science", "h1": "A different way to deploy a Python model over Spark", "description": "Separate the prediction method from the rest of the Python class and then implement in Scala"}, "outgoing_paragraph_urls": [{"url": "https://towardsdatascience.com/deploy-a-python-model-more-efficiently-over-spark-497fc03e0a8d", "anchor_text": "how to deploy a Python model over Spark", "paragraph_index": 0}, {"url": "https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestRegressor.html", "anchor_text": "RandomForestRegressor", "paragraph_index": 3}, {"url": "http://aampe.co", "anchor_text": "aampe.co", "paragraph_index": 12}], "all_paragraphs": ["A while ago, I wrote a post about how to deploy a Python model over Spark. The approach was roughly as follows:", "The method takes advantage of the numpy-enabled optimization that backs scikit-learn and reduces the number of times you have to go through the expensive process of serializing and de-serializing the model object.", "I\u2019ve recently adopted a different way of deploying a Python model over Spark that doesn\u2019t require the grouping and then exploding of lots of rows of data. I still train the model in Python on a sample of the total data, but then I store everything I need to call the predict method in a JSON file, and then that file can be called into a Scala function that can implement the predict method.", "For example, take a scikit-learn RandomForestRegressor. The predict method is the average of the results of the predict methods of a bunch of individual decision trees, but the implementation of the method itself doesn\u2019t use a tree structure at all. It encodes everything into a series of lists.", "The following code creates a pure Python function that will exactly reproduce the predictions of a trained RandomForestRegressor:", "Look at the tree_template string. We start out with five lists \u2014 each as long as there are nodes in the tree. The features list has as many unique values as there are features upon which the model was trained. We start at the first value of that list \u2014 index zero. If the value at index zero is, say, 3, then we pull out the value of the third feature upon which the model was trained. We then pull out the index zero value from the thresholds list. If the value of the selected feature is less than or equal to the value of the corresponding threshold, then we look at the zero-index value of the children_left list. Otherwise, we look at the zero-index value of the children_right list. Either way, that value is our new index, and then we start the process over again. We keep doing this until the value from the children list is the placeholder for \u201cyou\u2019ve reached the end of the tree\u201d. In scikit-learn, the default value for this placeholder is -2. At that point, whatever index you\u2019re currently on, you look up the value at that index from the values list. That\u2019s your prediction.", "So, yes, it\u2019s a lot of data \u2014 it common for a decision tree regressor with a couple dozen features to have around 100,000 nodes. But the logic of navigating the tree to get the prediction is incredibly simple. So all you have to do is create a function that contains the lists for each tree, along with the logic for jumping from index to index. Then take a set of features, get the predictions from each individual tree, and average. That\u2019s your random forest.", "It\u2019s easy to dump all of this information to JSON. The following function does exactly that. All it requires is a trained RandomForestRegressor object, the list of features in the order they were used in the training, and a filepath to which to dump the JSON file.", "The output for a single tree will look something like this:", "This next snippet of code comes from my colleague Sam Hendley, who has forgotten more about Scala than I will ever know. It reads in the tree information from the JSON file and implements the prediction logic for each tree and then the averaging for the forest as a whole.", "Implementing the predictions in Scala avoids the process of moving serializing and de-serializing the Python representations of the function \u2014 everything can be done directly on the JVM. And a Random Forest is one of the most complicated use cases here. In the case of any sort of model that produces coefficients, the transforming the predict function to JSON and Scala is even easier.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Co-founder @ aampe.co. Anthropologist + Data Scientist."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F2da4d625f73e&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-different-way-to-deploy-a-python-model-over-spark-2da4d625f73e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-different-way-to-deploy-a-python-model-over-spark-2da4d625f73e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-different-way-to-deploy-a-python-model-over-spark-2da4d625f73e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-different-way-to-deploy-a-python-model-over-spark-2da4d625f73e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----2da4d625f73e--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----2da4d625f73e--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@schaun.wheeler?source=post_page-----2da4d625f73e--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@schaun.wheeler?source=post_page-----2da4d625f73e--------------------------------", "anchor_text": "Schaun Wheeler"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F2d3762e7f110&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-different-way-to-deploy-a-python-model-over-spark-2da4d625f73e&user=Schaun+Wheeler&userId=2d3762e7f110&source=post_page-2d3762e7f110----2da4d625f73e---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F2da4d625f73e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-different-way-to-deploy-a-python-model-over-spark-2da4d625f73e&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F2da4d625f73e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-different-way-to-deploy-a-python-model-over-spark-2da4d625f73e&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://towardsdatascience.com/deploy-a-python-model-more-efficiently-over-spark-497fc03e0a8d", "anchor_text": "how to deploy a Python model over Spark"}, {"url": "https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestRegressor.html", "anchor_text": "RandomForestRegressor"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----2da4d625f73e---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/data-science?source=post_page-----2da4d625f73e---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/spark?source=post_page-----2da4d625f73e---------------spark-----------------", "anchor_text": "Spark"}, {"url": "https://medium.com/tag/python?source=post_page-----2da4d625f73e---------------python-----------------", "anchor_text": "Python"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F2da4d625f73e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-different-way-to-deploy-a-python-model-over-spark-2da4d625f73e&user=Schaun+Wheeler&userId=2d3762e7f110&source=-----2da4d625f73e---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F2da4d625f73e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-different-way-to-deploy-a-python-model-over-spark-2da4d625f73e&user=Schaun+Wheeler&userId=2d3762e7f110&source=-----2da4d625f73e---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F2da4d625f73e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-different-way-to-deploy-a-python-model-over-spark-2da4d625f73e&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----2da4d625f73e--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F2da4d625f73e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-different-way-to-deploy-a-python-model-over-spark-2da4d625f73e&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----2da4d625f73e---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----2da4d625f73e--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----2da4d625f73e--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----2da4d625f73e--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----2da4d625f73e--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----2da4d625f73e--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----2da4d625f73e--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----2da4d625f73e--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----2da4d625f73e--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@schaun.wheeler?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@schaun.wheeler?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Schaun Wheeler"}, {"url": "https://medium.com/@schaun.wheeler/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "894 Followers"}, {"url": "http://aampe.co", "anchor_text": "aampe.co"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F2d3762e7f110&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-different-way-to-deploy-a-python-model-over-spark-2da4d625f73e&user=Schaun+Wheeler&userId=2d3762e7f110&source=post_page-2d3762e7f110--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fd8dcfa98f86c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-different-way-to-deploy-a-python-model-over-spark-2da4d625f73e&newsletterV3=2d3762e7f110&newsletterV3Id=d8dcfa98f86c&user=Schaun+Wheeler&userId=2d3762e7f110&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}