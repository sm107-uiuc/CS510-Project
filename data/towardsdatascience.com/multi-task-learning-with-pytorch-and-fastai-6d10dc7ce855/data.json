{"url": "https://towardsdatascience.com/multi-task-learning-with-pytorch-and-fastai-6d10dc7ce855", "time": 1683007532.321841, "path": "towardsdatascience.com/multi-task-learning-with-pytorch-and-fastai-6d10dc7ce855/", "webpage": {"metadata": {"title": "Multi-Task Learning with Pytorch and FastAI | by Thiago Dantas | Towards Data Science", "h1": "Multi-Task Learning with Pytorch and FastAI", "description": "Following the concepts presented on my post named Should you use FastAI?, I\u2019d like to show here how to train a Multi-Task deep learning model using the hybrid Pytorch-FastAI approach. The basic idea\u2026"}, "outgoing_paragraph_urls": [{"url": "https://medium.com/deeplearningbrasilia/should-you-use-fastai-7ce994de67d0", "anchor_text": "Should you use FastAI?", "paragraph_index": 0}, {"url": "https://www.kaggle.com/jangedoo/utkface-new", "anchor_text": "UTKFace dataset", "paragraph_index": 2}, {"url": "https://github.com/thiagodma/Pytorch_exs/blob/master/MultiTaskLearning/multitask_age_gender_ethnicity_resnet34.ipynb", "anchor_text": "link", "paragraph_index": 3}, {"url": "https://ruder.io/multi-task/", "anchor_text": "post", "paragraph_index": 6}, {"url": "https://arxiv.org/abs/1705.07115", "anchor_text": "Multi-Task Learning Using Uncertainty to Weigh Losses for Scene Geometry and Semantics", "paragraph_index": 16}, {"url": "http://github.com/thiagodma", "anchor_text": "github", "paragraph_index": 26}, {"url": "https://www.linkedin.com/in/thiago-dantas-041b41167/", "anchor_text": "LinkedIn", "paragraph_index": 26}], "all_paragraphs": ["Following the concepts presented on my post named Should you use FastAI?, I\u2019d like to show here how to train a Multi-Task deep learning model using the hybrid Pytorch-FastAI approach. The basic idea from the Pytorch-FastAI approach is to define a dataset and a model using Pytorch code and then use FastAI to fit your model. This approach gives you the flexibility to build complicated datasets and models but still be able to use high level FastAI functionality.", "Multi-Task Learning (MTL) model is a model that is able to do more than one task. It is as simple as that. In general, as soon as you find yourself optimizing more than one loss function, you are effectively doing MTL.", "In this demonstration I\u2019ll use the UTKFace dataset. This dataset consists of more than 30k images with labels for age, gender and ethnicity.", "If you want skip all the talking and jump to the code, here is the link.", "When you look to someone\u2019s picture and try to predict age, gender and ethnicity, you\u2019re not using completely different parts of your brain right? What I\u2019m trying to say is that you don\u2019t try to understand the image in 3 different ways, each one specific to each task. What you\u2019re doing is using a single understanding that your brain makes of the image and then trying to decode that understanding into age, gender and ethnicity. And besides that, there is knowledge from gender estimation that might help on age estimation, there is knowledge from ethnicity estimation that might help on gender estimation and so forth.", "So, why MTL? We\u2019re confident that training a single model to do all tasks we\u2019re interested in yields better results than training a model for each task. Rich Caruana summarizes the goal of MTL pretty nicely: \u201cMTL improves generalization by leveraging the domain-specific information contained in the training signals of related tasks\u201d.", "As this is a practical tutorial for training MTL models I\u2019ll not dig deeper into theory and intuition but if you want to read more, check out this amazing post from Sebastian Ruder.", "When you\u2019re working on a Deep Learning problem, usually the first thing to care about is how to provide the data to your model so that it can learn. For this specific MTL problem, the Pytorch dataset definition is pretty straight forward.", "You may be questioning why did I take the logarithm of the age and then divide it by 4.75. Taking logs means that errors in predicting high ages and low ages will affect the result equally. I\u2019ll explain why dividing by 4.75 later. Another thing to mention is that I\u2019m using FastAI\u2019s data augmentations here (I think they\u2019re better than the ones from torchvision.transforms).", "Once the dataset class is defined, creating the dataloaders and databunch is really easy.", "Remember that our goal here is to, given an image, predict age, gender and ethnicity. Recall that predicting age is a regression problem with a single output, predicting gender is a classification problem with two outputs and ethnicity is a classification problem with 5 outputs (in this specific dataset). With that in mind, we can create our MTL model.", "You can see that the model uses only one encoder (a feature extractor) and feeds the encodings (features) to the task specific heads. Each head has the appropriate number of outputs so that it can learn its task.", "Why am I applying a sigmoid on the result from the ages head? That\u2019s related to the division by 4.75 I mentioned previously and I\u2019ll talk about that on the next session.", "The loss function is what guides the training, right? If your loss function is not good, your model won\u2019t be good. In a MTL problem, usually what you\u2019ll try to do is to combine somehow each loss for each task. In our problem, the losses could be Mean Squared Error for predicting age and Cross Entropy for predicting both gender and ethnicity, for instance. There are some common ways of combining the task specific losses for a MTL problem. I\u2019ll talk about three of them.", "The first take is to calculate the losses for each task and then add them together, or take the mean. Although I have read on some discussion forums that this approach works fine, that was not what I concluded from my experiments. As the losses may have different magnitudes, one of the losses can take control of the training and you don\u2019t get nice results.", "The second take is to try to weight the losses by hand and then sum/average them together. It turns out that this approach is pretty fiddly and can take too much time and I also couldn\u2019t make it work.", "The third take, on the other hand, led me to nice results. It consists of letting the model learn how to weight the task specific losses. In the paper Multi-Task Learning Using Uncertainty to Weigh Losses for Scene Geometry and Semantics the authors propose such loss function. Here\u2019s my implementation of the paper\u2019s proposal for this specific problem.", "We propose a principled approach to multi-task deep learning which weighs multiple loss functions by considering the homoscedastic uncertainty of each task. This allows us to simultaneously learn various quantities with different units or scales in both classification and regression settings.", "Now I should explain why did I choose to divide the logarithm of the age by 4.75 (on the __getitem__ method from the dataset class) and why did I apply a sigmoid to the output of the age\u2019s head (on the model definition).", "In theory the loss function should be able to learn the weights and scale each task\u2019s loss. But in fact, in my experiments I concluded that keeping the task specific losses kind of in the same scale helps a lot in the fitting process. So I divided the logarithm of the ages by 4.75 because that is the maximum value of the log(age). So the result from log(age)/4.75 should be a number between zero and one and then the MSE loss wouldn\u2019t be so bigger than the other losses. I applied a sigmoid after the age\u2019s head so that I can force my model to always output a prediction in the acceptable range.", "With the databunch, model and loss function defined its time to create the learner. I\u2019ll add some metrics to help me keep track of the model\u2019s performance on the validation set.", "With the learner defined, now we can use the FastAI functionality to train our model. We can use the learning rate finder, the fit_one_cycle method, the discriminative learning rates training etc.", "As I\u2019m using the resnet34 encoder pretrained on Imagenet, first I\u2019ll train only the heads and the batch norm layers on the encoder. Training for 15 epochs led me to a 0.087 RMSE for age prediction, 89.84% accuracy on gender prediction and 84.15% accuracy on ethnicity prediction.", "After that I unfreeze the encoder and train the whole model with discriminative learning rates for 100 epochs, and that led me to a 0.058 RMSE for age prediction, 99.42% accuracy on gender prediction and 99.19% accuracy for ethnicity prediction.", "In this post I presented the basics you need to train a MTL model using a hybrid Pytorch/FastAI approach. Once again I think I\u2019ve shown that FastAI\u2019s high level functionality is really useful and made my life much easier. Using advanced deep learning features as discriminative learning rates and one cycle scheduling so easily is a thumbs up for FastAI in my opinion.", "It is important to mention that in this tutorial my focus was to help you to solve a MTL problem. The UTKFace dataset is pretty biased to white people and people with ages between 20 and 40 years so you should keep that in mind. In my final implementation I made some minor adjustments on the loss function which resulted in a less biased performance of the model.", "If you liked this post, please give it some claps. You can check more about what I\u2019m doing by visiting my github and get in touch through LinkedIn.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F6d10dc7ce855&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-task-learning-with-pytorch-and-fastai-6d10dc7ce855&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-task-learning-with-pytorch-and-fastai-6d10dc7ce855&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-task-learning-with-pytorch-and-fastai-6d10dc7ce855&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-task-learning-with-pytorch-and-fastai-6d10dc7ce855&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----6d10dc7ce855--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----6d10dc7ce855--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@thiagodma?source=post_page-----6d10dc7ce855--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@thiagodma?source=post_page-----6d10dc7ce855--------------------------------", "anchor_text": "Thiago Dantas"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F3cc59ad4bff3&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-task-learning-with-pytorch-and-fastai-6d10dc7ce855&user=Thiago+Dantas&userId=3cc59ad4bff3&source=post_page-3cc59ad4bff3----6d10dc7ce855---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F6d10dc7ce855&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-task-learning-with-pytorch-and-fastai-6d10dc7ce855&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F6d10dc7ce855&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-task-learning-with-pytorch-and-fastai-6d10dc7ce855&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://www.pexels.com/@anastasia-shuraeva", "anchor_text": "Anastasia Shuraeva"}, {"url": "https://www.pexels.com/photo/woman-carrying-her-baby-and-working-on-a-laptop-4079283/", "anchor_text": "Pexels"}, {"url": "https://medium.com/deeplearningbrasilia/should-you-use-fastai-7ce994de67d0", "anchor_text": "Should you use FastAI?"}, {"url": "https://www.kaggle.com/jangedoo/utkface-new", "anchor_text": "UTKFace dataset"}, {"url": "https://github.com/thiagodma/Pytorch_exs/blob/master/MultiTaskLearning/multitask_age_gender_ethnicity_resnet34.ipynb", "anchor_text": "link"}, {"url": "https://ruder.io/multi-task/", "anchor_text": "post"}, {"url": "https://medium.com/u/76e70e1ceeca?source=post_page-----6d10dc7ce855--------------------------------", "anchor_text": "Stonelive"}, {"url": "https://arxiv.org/abs/1705.07115", "anchor_text": "Multi-Task Learning Using Uncertainty to Weigh Losses for Scene Geometry and Semantics"}, {"url": "http://github.com/thiagodma", "anchor_text": "github"}, {"url": "https://www.linkedin.com/in/thiago-dantas-041b41167/", "anchor_text": "LinkedIn"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----6d10dc7ce855---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/tag/pytorch?source=post_page-----6d10dc7ce855---------------pytorch-----------------", "anchor_text": "Pytorch"}, {"url": "https://medium.com/tag/fastai?source=post_page-----6d10dc7ce855---------------fastai-----------------", "anchor_text": "Fastai"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----6d10dc7ce855---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/tag/data-science?source=post_page-----6d10dc7ce855---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F6d10dc7ce855&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-task-learning-with-pytorch-and-fastai-6d10dc7ce855&user=Thiago+Dantas&userId=3cc59ad4bff3&source=-----6d10dc7ce855---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F6d10dc7ce855&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-task-learning-with-pytorch-and-fastai-6d10dc7ce855&user=Thiago+Dantas&userId=3cc59ad4bff3&source=-----6d10dc7ce855---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F6d10dc7ce855&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-task-learning-with-pytorch-and-fastai-6d10dc7ce855&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----6d10dc7ce855--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F6d10dc7ce855&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-task-learning-with-pytorch-and-fastai-6d10dc7ce855&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----6d10dc7ce855---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----6d10dc7ce855--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----6d10dc7ce855--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----6d10dc7ce855--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----6d10dc7ce855--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----6d10dc7ce855--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----6d10dc7ce855--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----6d10dc7ce855--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----6d10dc7ce855--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@thiagodma?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@thiagodma?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Thiago Dantas"}, {"url": "https://medium.com/@thiagodma/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "83 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F3cc59ad4bff3&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-task-learning-with-pytorch-and-fastai-6d10dc7ce855&user=Thiago+Dantas&userId=3cc59ad4bff3&source=post_page-3cc59ad4bff3--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F3503c8f07fbf&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmulti-task-learning-with-pytorch-and-fastai-6d10dc7ce855&newsletterV3=3cc59ad4bff3&newsletterV3Id=3503c8f07fbf&user=Thiago+Dantas&userId=3cc59ad4bff3&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}