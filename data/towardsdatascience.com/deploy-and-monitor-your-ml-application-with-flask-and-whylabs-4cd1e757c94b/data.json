{"url": "https://towardsdatascience.com/deploy-and-monitor-your-ml-application-with-flask-and-whylabs-4cd1e757c94b", "time": 1683019393.907723, "path": "towardsdatascience.com/deploy-and-monitor-your-ml-application-with-flask-and-whylabs-4cd1e757c94b/", "webpage": {"metadata": {"title": "Deploy and Monitor your ML Application with Flask and WhyLabs | by Felipe de Pontes Adachi | Towards Data Science", "h1": "Deploy and Monitor your ML Application with Flask and WhyLabs", "description": "One of the best milestones in every AI builder\u2019s journey is the day when a model is ready to graduate from training and get deployed into production. According to a recent survey done by Algorithmia\u2026"}, "outgoing_paragraph_urls": [{"url": "https://info.algorithmia.com/2021", "anchor_text": "recent survey done by Algorithmia", "paragraph_index": 0}, {"url": "https://archive.ics.uci.edu/ml/datasets/iris", "anchor_text": "Iris Dataset", "paragraph_index": 1}, {"url": "https://whylabs.ai/", "anchor_text": "WhyLabs", "paragraph_index": 1}, {"url": "https://github.com/whylabs/whylogs", "anchor_text": "whylogs", "paragraph_index": 1}, {"url": "https://github.com/whylabs/whylogs/tree/mainline/examples/flask_whylabs_example", "anchor_text": "here", "paragraph_index": 4}, {"url": "https://whylabs.ai/free", "anchor_text": "https://whylabs.ai/free", "paragraph_index": 9}, {"url": "https://hub.whylabsapp.com/models", "anchor_text": "https://hub.whylabsapp.com/models", "paragraph_index": 10}, {"url": "https://docs.whylabs.ai/docs/whylabs-api", "anchor_text": "WhyLabs API Documentation", "paragraph_index": 10}, {"url": "https://archive.ics.uci.edu/ml/machine-learning-databases/iris/", "anchor_text": "Iris dataset", "paragraph_index": 18}, {"url": "https://github.com/whylabs/whylogs/blob/mainline/examples/flask_whylabs_example/train.py", "anchor_text": "training routine", "paragraph_index": 18}, {"url": "https://hub.whylabsapp.com/models", "anchor_text": "model\u2019s dashboard", "paragraph_index": 29}, {"url": "https://en.wikipedia.org/wiki/Hellinger_distance", "anchor_text": "Hellinger Distance", "paragraph_index": 36}, {"url": "https://communityinviter.com/apps/whylabs-community/whylabs-community", "anchor_text": "WhyLabs community on Slack", "paragraph_index": 44}], "all_paragraphs": ["One of the best milestones in every AI builder\u2019s journey is the day when a model is ready to graduate from training and get deployed into production. According to a recent survey done by Algorithmia, most organizations already have more than 25 models in production. This underscores how enterprises are increasingly relying on ML to improve performance as intended outside of the lab. However, the post-deployment phase can be a difficult one for your ML model. Data scientists may think that the hard part\u2019s over once a model is deployed, but the truth is the problems have only just begun. Data errors, broken pipelines, and model performance degradation will certainly come one day or another and, when this day comes, we must be prepared to debug and troubleshoot these problems efficiently. In order to have a reliable and robust ML system, observability is an absolute must.", "In this article, I\u2019d like to share an approach on how to improve the observability of your ML application by efficiently logging and monitoring your models. To demonstrate, we\u2019ll deploy a Flask application for pattern recognition based on the well-known Iris Dataset. On the monitoring part, we\u2019ll explore the free, starter edition of the WhyLabs Observability Platform in order to set up our own model monitoring dashboard. From the dashboard, we\u2019ll have access to all the statistics, metrics, and performance data gathered from every part of our ML pipeline. To interact with the platform, we\u2019ll use whylogs, an open-source data logging library developed by WhyLabs.", "One of the key use cases for a monitoring dashboard is when there is an unexpected change in our data quality and/or consistency. On that account, we simulate one of the most common model failure scenarios, that of feature drift, meaning that there\u2019s a change in our input\u2019s distribution. We then use a monitoring dashboard to see how this kind of problem can be detected and debugged. While feature drift may or may not affect your model\u2019s performance, observing this kind of change in production should always be a reason for further inspection and, possibly, model retraining.", "In summary, we\u2019ll cover the step-by-step path to:", "If this is a problem that resonates with you, we\u2019ve made the complete code for this tutorial available here for you to reuse. You\u2019ll need to copy it onto your machine in order to follow this example. You\u2019ll also need a Docker and, preferably, a Python environment management tool, such as Conda or pipenv. For those interested in the details, we\u2019ve included a very thorough description and a Jupyter Notebook as a guideline.", "Let\u2019s take a look at how the different components of our system interact with each other.", "We\u2019ll deploy locally a Flask application, which is responsible for serving the user with the requested predictions through a REST endpoint. Our application will also use the whylogs library to create statistical profiles of both input and output features of our application during production. These statistical properties will then be sent in microbatches to WhyLabs at fixed intervals. WhyLabs merges them automatically, creating statistical profiles on a daily basis.", "There are various ways to upload your logged metrics into the platform. In this example, we\u2019re uploading them periodically in microbatches, as shown in the diagram. Another option would be to upload them at each log step.", "In order to monitor our application, let\u2019s first set up a WhyLabs account. Specifically, we\u2019ll need two pieces of information:", "Go to https://whylabs.ai/free and grab a free account. You can follow along with the examples if you wish, but if you\u2019re interested in only following this demonstration, you can go ahead and skip the quick start instructions.", "After that, you\u2019ll be prompted to create an API token, which you\u2019ll use to interact with your dashboard. Once you create the token, copy it and store it in a safe place. The second important information here is your org ID. Take note of it as well. WhyLabs gives you an example code of how to create a session and send data to your dashboard. You can test it as well and check if data is getting through. Otherwise, after you get your API Token and Org ID, you can just go to https://hub.whylabsapp.com/models to see your shiny new model\u2019s dashboard. To get to this step, we used the WhyLabs API Documentation, which also provides additional information about token creation and basic examples on how to use it.", "Once the dashboard is up and running, we can get started on deploying the application itself. We\u2019ll serve a Flask application with Gunicorn, packaged into a Docker container to facilitate deployment.", "The first step will be configuring the connection to WhyLabs. In this example, we do that through the .whylogs_flask.yaml file. The writer can be set to either output data locally or to different locations, like, for example, S3, an MLFlow path, or directly to WhyLabs. In this file, we\u2019ll also set the project\u2019s name and other additional information.", "The application assumes the existence of a set of variables, so we\u2019ll define them in a .env file. These are loaded later using the dotenv library. Copy the content below and replace the WHYLABS_API_KEY and WHYLABS_DEFAULT_ORG_ID values to the ones you got when creating your WhyLabs account. You can keep the other variables as is.", "Let\u2019s talk about some of the other existing variables.", "The application will be run from inside a Docker container, but we\u2019ll also run some pre-scripts (to download the data and train the model) and post-scripts (to send the requests), so let\u2019s create an environment for this tutorial. If you\u2019re using Conda, you can create it from the environment.yml configuration file:", "If that doesn\u2019t work out as expected, you can also create an environment from scratch:", "And then install directly from the requirements:", "If you look carefully, one of our environment variables is called MODEL_PATH. We don\u2019t have a model yet, so let\u2019s create it. We\u2019ll use sklearn to train a simple SVC classification model from the Iris dataset and save it as model.joblib. From the root of our example\u2019s folder, we can simply call the training routine:", "Now we have everything to actually run our application. To build the image, we define the Dockerfile below:", "And then build the image and run our container:", "This will start our application locally on port 5000. In this example, we\u2019re running our Flask application as a WSGI HTTP Server with Gunicorn. By setting thereload variable, we\u2019re able to debug more effectively, automatically reloading the workers when there\u2019s a change in code.", "You should see a message from gunicorn starting the server:", "Once the Docker container is running, we should check if the API is functional. The application has two endpoints:", "The API is properly documented with Swagger, so you can head to http:127.0.0.1:5000/apidocs to explore the documentation:", "From /apidocs you\u2019ll be able to see request examples to try out both endpoints, along with curl snippets, like:", "You should get a \u201chealthy\u201d response from the first command. Likewise, the response from the prediction request should be:", "Ok, our application is serving our requests appropriately. Now, we can just check if data is reaching our dashboard safe and sound.", "It\u2019s important to remember that data is not sent immediately, along with each request done. It\u2019s rather sent periodically, according to the ROTATION_TIME environment variable defined in the .env file. In this example, it was set to 5 minutes, which means that we\u2019ll have to wait 5 minutes before the information is sent to our dashboard. Then, we should see a message from whylogs indicating that the upload is complete.", "Once the upload is complete, the received information should be available in your model\u2019s dashboard within minutes. From your model\u2019s dashboard, you can check if any profile was logged, and access your summary\u2019s dashboard:", "So far, we have 1 profile logged and 5 features, which means data is getting through. Now, let\u2019s explore the platform a bit more with a use-case: We\u2019ll add some outliers to our data distribution and see how that is reflected in our dashboard.", "The real value of any observability platform surfaces when things go wrong. Things can go wrong in a lot of different ways, but for this demonstration let\u2019s pick a specific one: feature drift.", "The drift phenomenon in the context of Machine Learning can be a lengthy subject, so in this case, we\u2019ll limit ourselves to a basic definition of feature drift: when there is a change of distribution of the model\u2019s input.", "We\u2019ll use a collection of 150 unchanged samples from the Iris dataset to represent the normal distribution of a daily batch. Then, to represent the anomalous batch, we\u2019ll take the same set of samples, except we\u2019ll replace 30 of these samples for random outliers to one random input feature. We\u2019ll proceed to request predictions with input features as follows:", "The code snippet below will make 150 requests with unchanged input features. For the second day, we simply change the code to pass data_mod as the payload instead of data (line 35) and repeat the process. For this demonstration, the outliers were added to the sepal_width feature.", "Let\u2019s take a brief look at some sections from our dashboard. From the inputs page, there\u2019s a lot of useful information, such as count for the number of records in each batch, null fraction, and inferred feature type.", "One particularly useful piece of information is the Distribution Distance. This is a time series that shows the feature\u2019s mean statistical distance to previous batches of data over the selected date range, using the Hellinger Distance to estimate the distances between distributions. By adding the outliers in the sepal_width feature, we see a change in the distribution distance not only for the sepal_width feature itself but also on the prediction results.", "Note: For the remaining features, the distance seems to increase for the last day. That was actually a mistake on my part, as I sent 1 additional record, for a total of 151 records. Since the graphs are not in scale between features, the effect of this change seems high, but when inspecting the values themselves, the additional record yielded a distribution distance of 0.02.", "We can further inspect the individual features by clicking on them. From the distribution graphs, we can see the drift\u2019s effects on both class and sepal_width features.", "In the profiles section, we can select up to 3 dataset profiles for comparison, which is a very cool feature. In the image below, I selected a few features in each profile for comparison. As previously, the changes caused by adding the outliers are also very apparent.", "While we won\u2019t be able to discuss every available feature here, some of my favorites are:", "Feel free to explore them on your own!", "The post-deployment phase of ML applications presents us with countless challenges and the process of troubleshooting these applications can still be very manual and cumbersome. In this post, we covered an example of how to ease this burden by improving our system\u2019s observability with WhyLabs.", "We covered a simple example of deploying a Flask application for classification, based on the well-known Iris dataset, and integrated it with the WhyLabs platform using the whylogs data logging library. We also simulated a Feature Drift scenario by injecting outliers to our input in order to see how that is reflected in our monitoring dashboard. Even though it\u2019s a very simple use case, this example can be easily adapted to cover more tailored scenarios.", "Thank you for reading, and feel free to reach out if you have any questions/suggestions! If you try it out and have questions, I\u2019ve found the WhyLabs community on Slack very helpful and responsive.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F4cd1e757c94b&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-and-monitor-your-ml-application-with-flask-and-whylabs-4cd1e757c94b&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-and-monitor-your-ml-application-with-flask-and-whylabs-4cd1e757c94b&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-and-monitor-your-ml-application-with-flask-and-whylabs-4cd1e757c94b&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-and-monitor-your-ml-application-with-flask-and-whylabs-4cd1e757c94b&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----4cd1e757c94b--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----4cd1e757c94b--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://felipe-p-adachi.medium.com/?source=post_page-----4cd1e757c94b--------------------------------", "anchor_text": ""}, {"url": "https://felipe-p-adachi.medium.com/?source=post_page-----4cd1e757c94b--------------------------------", "anchor_text": "Felipe de Pontes Adachi"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fa038269245d5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-and-monitor-your-ml-application-with-flask-and-whylabs-4cd1e757c94b&user=Felipe+de+Pontes+Adachi&userId=a038269245d5&source=post_page-a038269245d5----4cd1e757c94b---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F4cd1e757c94b&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-and-monitor-your-ml-application-with-flask-and-whylabs-4cd1e757c94b&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F4cd1e757c94b&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-and-monitor-your-ml-application-with-flask-and-whylabs-4cd1e757c94b&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://info.algorithmia.com/2021", "anchor_text": "recent survey done by Algorithmia"}, {"url": "https://archive.ics.uci.edu/ml/datasets/iris", "anchor_text": "Iris Dataset"}, {"url": "https://whylabs.ai/", "anchor_text": "WhyLabs"}, {"url": "https://github.com/whylabs/whylogs", "anchor_text": "whylogs"}, {"url": "https://github.com/whylabs/whylogs/tree/mainline/examples/flask_whylabs_example", "anchor_text": "here"}, {"url": "https://whylabs.ai/free", "anchor_text": "https://whylabs.ai/free"}, {"url": "https://hub.whylabsapp.com/models", "anchor_text": "https://hub.whylabsapp.com/models"}, {"url": "https://docs.whylabs.ai/docs/whylabs-api", "anchor_text": "WhyLabs API Documentation"}, {"url": "https://hub.whylabsapp.com/models", "anchor_text": "https://hub.whylabsapp.com/models"}, {"url": "https://archive.ics.uci.edu/ml/machine-learning-databases/iris/", "anchor_text": "Iris dataset"}, {"url": "https://github.com/whylabs/whylogs/blob/mainline/examples/flask_whylabs_example/train.py", "anchor_text": "training routine"}, {"url": "https://hub.whylabsapp.com/models", "anchor_text": "model\u2019s dashboard"}, {"url": "https://en.wikipedia.org/wiki/Hellinger_distance", "anchor_text": "Hellinger Distance"}, {"url": "https://communityinviter.com/apps/whylabs-community/whylabs-community", "anchor_text": "WhyLabs community on Slack"}, {"url": "https://medium.com/tag/mlops?source=post_page-----4cd1e757c94b---------------mlops-----------------", "anchor_text": "Mlops"}, {"url": "https://medium.com/tag/data-science?source=post_page-----4cd1e757c94b---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/python?source=post_page-----4cd1e757c94b---------------python-----------------", "anchor_text": "Python"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----4cd1e757c94b---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----4cd1e757c94b---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F4cd1e757c94b&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-and-monitor-your-ml-application-with-flask-and-whylabs-4cd1e757c94b&user=Felipe+de+Pontes+Adachi&userId=a038269245d5&source=-----4cd1e757c94b---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F4cd1e757c94b&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-and-monitor-your-ml-application-with-flask-and-whylabs-4cd1e757c94b&user=Felipe+de+Pontes+Adachi&userId=a038269245d5&source=-----4cd1e757c94b---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F4cd1e757c94b&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-and-monitor-your-ml-application-with-flask-and-whylabs-4cd1e757c94b&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----4cd1e757c94b--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F4cd1e757c94b&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-and-monitor-your-ml-application-with-flask-and-whylabs-4cd1e757c94b&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----4cd1e757c94b---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----4cd1e757c94b--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----4cd1e757c94b--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----4cd1e757c94b--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----4cd1e757c94b--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----4cd1e757c94b--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----4cd1e757c94b--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----4cd1e757c94b--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----4cd1e757c94b--------------------------------", "anchor_text": ""}, {"url": "https://felipe-p-adachi.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://felipe-p-adachi.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Felipe de Pontes Adachi"}, {"url": "https://felipe-p-adachi.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "118 Followers"}, {"url": "https://datatravelogues.substack.com/", "anchor_text": "https://datatravelogues.substack.com/"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fa038269245d5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-and-monitor-your-ml-application-with-flask-and-whylabs-4cd1e757c94b&user=Felipe+de+Pontes+Adachi&userId=a038269245d5&source=post_page-a038269245d5--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fd79b2569b413&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fdeploy-and-monitor-your-ml-application-with-flask-and-whylabs-4cd1e757c94b&newsletterV3=a038269245d5&newsletterV3Id=d79b2569b413&user=Felipe+de+Pontes+Adachi&userId=a038269245d5&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}