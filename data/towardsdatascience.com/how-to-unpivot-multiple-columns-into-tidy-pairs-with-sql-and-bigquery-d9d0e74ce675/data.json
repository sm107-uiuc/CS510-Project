{"url": "https://towardsdatascience.com/how-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675", "time": 1683006106.912297, "path": "towardsdatascience.com/how-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675/", "webpage": {"metadata": {"title": "UNPIVOT multiple columns into tidy pairs with BigQuery and a SQL UDF | by Felipe Hoffa | Towards Data Science", "h1": "UNPIVOT multiple columns into tidy pairs with BigQuery and a SQL UDF", "description": "Important update: I left Google and joined Snowflake in 2020 \u2014 so I\u2019m unable to keep my older posts updated. If you want to try Snowflake, join us \u2014 I\u2019m having a lot of fun \u2744\ufe0f. As an example of\u2026"}, "outgoing_paragraph_urls": [{"url": "https://www.apple.com/covid19/mobility", "anchor_text": "Apple Mobility Trends Reports", "paragraph_index": 1}, {"url": "https://medium.com/@hoffa/new-in-bigquery-persistent-udfs-c9ea4100fd83", "anchor_text": "Persistent UDFs in BigQuery", "paragraph_index": 10}, {"url": "https://stackoverflow.com/a/27832362/132438", "anchor_text": "previous solution", "paragraph_index": 13}, {"url": "https://github.com/GoogleCloudPlatform/bigquery-utils/tree/master/udfs/community", "anchor_text": "bqutil", "paragraph_index": 14}, {"url": "https://cloud.google.com/blog/products/data-analytics/free-public-datasets-for-covid19", "anchor_text": "Google\u2019s public dataset program", "paragraph_index": 15}, {"url": "https://twitter.com/felipehoffa", "anchor_text": "@felipehoffa", "paragraph_index": 16}, {"url": "https://medium.com/@hoffa", "anchor_text": "medium.com/@hoffa", "paragraph_index": 16}, {"url": "https://reddit.com/r/bigquery", "anchor_text": "reddit.com/r/bigquery", "paragraph_index": 16}], "all_paragraphs": ["Important update: I left Google and joined Snowflake in 2020 \u2014 so I\u2019m unable to keep my older posts updated. If you want to try Snowflake, join us \u2014 I\u2019m having a lot of fun \u2744\ufe0f.", "As an example of non-tidy data, we can see how the Novel Coronavirus (COVID-19) Case (provided by JHU CSSE), and the Apple Mobility Trends Reports tables look:", "We don\u2019t want multiple columns, each for one date. We want to have (date, value) pairs. Since this problem seems so common, I wrote two BigQuery persistent UDFs to solve this:", "Just give unpivot() a full row, and the regex of how the name of each of the columns to unpivot look.", "That\u2019s so much better, but we are not done. How do we transform these values into dates and numbers?", "We can re-cast our unpivotted columns with cast_kv_array_to_date_float().", "What\u2019s even more \u201cinfuriating\u201d when casting these columns to dates is that they use different formats for encoding dates. You don\u2019t have to worry as the UDF can take the date format as an input too.", "For example, with the Apple tables:", "See? These results look way tidier than the starting tables.", "Once we have these 2 UDFs, applying them to other tables becomes really easy:", "Check my previous post about Persistent UDFs in BigQuery:", "The source code for these 2 UDFs is:", "The secret motor behind this function: Transforming a whole row into JSON with TO_JSON_STRING() and then doing a REGEXP_EXTRACT_ALL over it.", "My previous solution to UNPIVOT in BigQuery has received than 5k views on Stack Overflow:", "Once I write documentation for these functions, and we settle on their definitive name \u2014 I\u2019ll submit them to our shared repository with community UDFs (bqutil).", "Check Google\u2019s public dataset program, featuring an increasing collection of COVID-19 related datasets in BigQuery:", "I\u2019m Felipe Hoffa, a Developer Advocate for Google Cloud. Follow me on @felipehoffa, find my previous posts on medium.com/@hoffa, and all about BigQuery on reddit.com/r/bigquery.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Data Cloud Advocate at Snowflake \u2744\ufe0f. Originally from Chile, now in San Francisco and around the world. Previously at Google. Let\u2019s talk data."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fd9d0e74ce675&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----d9d0e74ce675--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----d9d0e74ce675--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://hoffa.medium.com/?source=post_page-----d9d0e74ce675--------------------------------", "anchor_text": ""}, {"url": "https://hoffa.medium.com/?source=post_page-----d9d0e74ce675--------------------------------", "anchor_text": "Felipe Hoffa"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F279fe54c149a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675&user=Felipe+Hoffa&userId=279fe54c149a&source=post_page-279fe54c149a----d9d0e74ce675---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fd9d0e74ce675&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fd9d0e74ce675&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://www.apple.com/covid19/mobility", "anchor_text": "Apple Mobility Trends Reports"}, {"url": "https://medium.com/@hoffa/new-in-bigquery-persistent-udfs-c9ea4100fd83", "anchor_text": "Persistent UDFs in BigQuery"}, {"url": "https://medium.com/@hoffa/new-in-bigquery-persistent-udfs-c9ea4100fd83", "anchor_text": "New in BigQuery: Persistent UDFsUser defined functions are a powerful way to extend BigQuery, but until now it has been a drag having to copy paste\u2026medium.com"}, {"url": "https://medium.com/@hoffa/how-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675", "anchor_text": "https://medium.com/@hoffa/how-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675"}, {"url": "https://medium.com/@hoffa/how-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675", "anchor_text": "https://medium.com/@hoffa/how-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675"}, {"url": "https://stackoverflow.com/a/27832362/132438", "anchor_text": "previous solution"}, {"url": "https://stackoverflow.com/a/27832362/132438", "anchor_text": "How to unpivot in BigQuery?stackoverflow.com"}, {"url": "https://github.com/GoogleCloudPlatform/bigquery-utils/tree/master/udfs/community", "anchor_text": "bqutil"}, {"url": "https://github.com/GoogleCloudPlatform/bigquery-utils/tree/master/udfs/community", "anchor_text": "GoogleCloudPlatform/bigquery-utilsThis directory contains community contributed user-defined functions to extend BigQuery for more specialized usage\u2026github.com"}, {"url": "https://cloud.google.com/blog/products/data-analytics/free-public-datasets-for-covid19", "anchor_text": "Google\u2019s public dataset program"}, {"url": "https://cloud.google.com/blog/products/data-analytics/free-public-datasets-for-covid19", "anchor_text": "Free public datasets for COVID-19 | Google Cloud BlogData always plays a critical role in the ability to research, study, and combat public health emergencies, and nowhere\u2026cloud.google.com"}, {"url": "https://twitter.com/felipehoffa", "anchor_text": "@felipehoffa"}, {"url": "https://medium.com/@hoffa", "anchor_text": "medium.com/@hoffa"}, {"url": "https://reddit.com/r/bigquery", "anchor_text": "reddit.com/r/bigquery"}, {"url": "https://medium.com/tag/data-science?source=post_page-----d9d0e74ce675---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/sql?source=post_page-----d9d0e74ce675---------------sql-----------------", "anchor_text": "Sql"}, {"url": "https://medium.com/tag/bigquery?source=post_page-----d9d0e74ce675---------------bigquery-----------------", "anchor_text": "Bigquery"}, {"url": "https://medium.com/tag/data-engineering?source=post_page-----d9d0e74ce675---------------data_engineering-----------------", "anchor_text": "Data Engineering"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fd9d0e74ce675&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675&user=Felipe+Hoffa&userId=279fe54c149a&source=-----d9d0e74ce675---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fd9d0e74ce675&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675&user=Felipe+Hoffa&userId=279fe54c149a&source=-----d9d0e74ce675---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fd9d0e74ce675&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----d9d0e74ce675--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fd9d0e74ce675&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----d9d0e74ce675---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----d9d0e74ce675--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----d9d0e74ce675--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----d9d0e74ce675--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----d9d0e74ce675--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----d9d0e74ce675--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----d9d0e74ce675--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----d9d0e74ce675--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----d9d0e74ce675--------------------------------", "anchor_text": ""}, {"url": "https://hoffa.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://hoffa.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Felipe Hoffa"}, {"url": "https://hoffa.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "17.8K Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F279fe54c149a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675&user=Felipe+Hoffa&userId=279fe54c149a&source=post_page-279fe54c149a--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F399b7ae54013&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-unpivot-multiple-columns-into-tidy-pairs-with-sql-and-bigquery-d9d0e74ce675&newsletterV3=279fe54c149a&newsletterV3Id=399b7ae54013&user=Felipe+Hoffa&userId=279fe54c149a&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}