{"url": "https://towardsdatascience.com/my-sweet-dreams-about-automatic-sleep-stage-classification-414128441728", "time": 1682994656.3061278, "path": "towardsdatascience.com/my-sweet-dreams-about-automatic-sleep-stage-classification-414128441728/", "webpage": {"metadata": {"title": "My Sweet Dreams about Automatic Sleep-Stage Classification | by Meryll Dindin | Towards Data Science", "h1": "My Sweet Dreams about Automatic Sleep-Stage Classification", "description": "Those last five months, I spent some of my spare time to sharpen my ML skills on a whole new challenge proposed by Dreem, a French company whose aim is to improve everyone\u2019s nights. Sleep rarely\u2026"}, "outgoing_paragraph_urls": [{"url": "https://challengedata.ens.fr/en/challenge/37/learning_sleep_stages_from_physiological_signals_on_dreem_headband.html", "anchor_text": "challenge", "paragraph_index": 0}, {"url": "https://dreem.com/en", "anchor_text": "Dreem", "paragraph_index": 0}, {"url": "https://www.theguardian.com/books/2017/sep/21/why-we-sleep-by-matthew-walker-review", "anchor_text": "Why We Sleep", "paragraph_index": 0}, {"url": "https://github.com/Coricos/DreemHeadband", "anchor_text": "GitHub", "paragraph_index": 1}, {"url": "https://towardsdatascience.com/from-tda-to-dl-d06f234f51d", "anchor_text": "TDA", "paragraph_index": 1}, {"url": "https://dreem.com/en/product", "anchor_text": "website", "paragraph_index": 2}, {"url": "https://en.wikipedia.org/wiki/Lyapunov_exponent", "anchor_text": "Lyapunov Exponents", "paragraph_index": 12}, {"url": "https://en.wikipedia.org/wiki/Hurst_exponent", "anchor_text": "Hurst Exponent", "paragraph_index": 13}, {"url": "https://en.wikipedia.org/wiki/Fractal_dimension", "anchor_text": "Fractal Dimension", "paragraph_index": 14}, {"url": "https://arxiv.org/abs/1603.06560", "anchor_text": "hyperband", "paragraph_index": 19}, {"url": "https://en.wikipedia.org/wiki/Cohen%27s_kappa", "anchor_text": "kappa score", "paragraph_index": 19}], "all_paragraphs": ["Those last five months, I spent some of my spare time to sharpen my ML skills on a whole new challenge proposed by Dreem, a French company whose aim is to improve everyone\u2019s nights. Sleep rarely receives the importance it deserves from us, and has now concrete and quantified aftermaths on our populations. Plummeting performances, lack of attention, memory disorders, \u2026 are all symptoms of a possible lack of sleep. Dreem\u2019s solution is a headband, actively stimulating your brain at night, monitoring your sleep and offering different programs for you to easily fall asleep. For the ones curious enough to dive deeper into the real importance of sleep in our daily life, I recommend you Why We Sleep by Matthew Walker, currently a teacher at UC Berkeley. This book astonished me in multiple ways, and gets over lots of principles and advice, for you to understand and improve your sleep, and thus your daily life.", "All the code used for that competition is available on my GitHub. Feel free to check it out and give me feedback. I will mainly deal with what brought me to the second place on the podium, even though the possibilities to handle this problem are limitless. You will also observe that this code can be used for broader problems relative to time-series and that it is mainly oriented towards interpretability. For the most curious ones, you will also find a lot more: DL architectures, auto-encoders, and TDA easter eggs. Enjoy!", "Before entering the whole machine-learning problem, let\u2019s spend some time understanding our context and the multi-modality of sources we will have to deal with. As presented on Dreem\u2019s website, their headband quantifies your brain activity (six EEG electrodes, equivalent to F7, F8, O1, O2, Fpz and one reference), your head movements and respiration (one 3D accelerometer) and your heart rate (one pulse oximeter).", "During your sleep, your brain will oscillate between different states, also called sleep stages (represented hereunder). Each stage corresponds to particular electric patterns and specific brain waves. The graph relative to the evolution of sleep stages over time is called a hypnogram.", "In the last decades, people have been wanting to replace the specialist-based annotations of those stages by automated processes. When getting over the literature, you will find out about the current hype relative to that topic. And that is exactly where machine-learning kicks in!", "I will not get into the details though, but every stage has a specific function regarding our brain well-being. Annotating those stages precisely would enable the medical field to look for pathologies and sleep disorders on a larger scale. Bigger (and statistically more accurate) epidemiology studies would then be possible thanks to robust data-based foundations. In the end, people would be enabled to enhance their sleep regarding real metrics, monitored on a daily basis. That is exactly what Dreem seems to offer! Moreover, since the company proposes brain stimulations during deep sleep (3 & 4), they must detect delta waves as accurately as possible to trigger them correctly.", "Dreem provides us with time-series obtained from the multiple sensors integrated into the headband. The given signals are 30 seconds epochs and sampled at different frequencies. As would a supervised-ML problem be, the data is split into a train set annotated with the corresponding sleep stages (theoretically given by a sleep scientist) and a test set. By quickly looking at the ratios of labels, one will observe that this is an imbalanced multi-classification problem. The distributions of the signals extrema also highlight a huge amount of artifacts present in the dataset (based on the assumption that a classic range for EEG signals is -500 to 500 microvolts).", "Playing around with the data, something priorly unexpected appeared to me: the labels are actually ordered! It means that the datasets have been build through the continuous aggregation of individuals, giving us the advantage of temporality. This, of course, opens a whole new scope for the model construction (GRU, LSTM, \u2026). From my understanding, Dreem seems to be currently using such models (typically LSTM over 30 epochs of 30 seconds). However, due to computational constraints (DL models used in the field are generally bazookas) and a will for interpretability, I decided to limit myself to the good old-fashioned and robust method of feature engineering.", "Temporality put aside, the previous observation enabled me to extract the individuals themselves, by splitting the indexes according to long periods of awakeness (label 0). A typical example of extracted hypnogram is given hereunder. Once extracted, those individuals could be gathered into subsets to build robust validation sets in order to assess the generalization ability of my models. I ended up with 88 subsets of diverse lengths, which is probably an over-estimation of the actual number of individuals (the corresponding average sleep duration would be of 4.5 hours with those segments).", "There comes the fun (and longest) part! How would I best describe EEG signals for sleep-stage classification? After going over the literature, I gathered multiple descriptive insights into my pipeline. As a result, each 30 seconds epoch was turned out into a 1200 features vector. I won\u2019t go over each feature (simply because a majority is classic), but rather focus on the ones that provided the greatest performances for sleep-stage classification.", "Typically, in the graph above, I estimated the importance of the 30 most important features regarding an XGBoost model and compared them to their relative importance obtained with LigthGBM, RandomForest, and ExtraTrees. The XGB model was my best performer on 5-folds cross-validation. (The importances are here the average of the 5 folds resulting models.)", "No wonder, chaos theory ended up being among the most significant. Why? Because we\u2019re trying to classify waves and occurring events: \u2018lower\u2019 chaos for periodic and predictable events; \u2018higher\u2019 chaos for generally unpredictable events (e.g. spindles, K-complexes that are patterns specific to some sleep stages). Those features have been recurrently useful throughout lots of my projects so far, so I\u2019ll reserve some lines to introduce those.", "Lyapunov Exponents refer to the rate of separation (general distance) between infinitesimally close trajectories. They quantify the predictability of a dynamic system (here non-stationnary EEGs), and have to be thought as a spectrum.", "The Hurst Exponent refers to as index of long-range dependence, as it quantifies the long-term memory of a specific time-serie, by relating to autocorrelations.", "A Fractal Dimension corresponds to a statistical index of complexity describing how the detail in a pattern changes with the scale at which it is measured.", "Those are exotic features. I also used coefficients of fitted auto-regressive models, the distance between the EEGs, a decomposition into Debauchies wavelets, a trend-residual decomposition and spectrograms to spot frequency dependencies (since each wave pattern [alpha, delta, theta waves] has specific and noticeable frequencies). This gave me a basis to enter the process of model construction.", "The process of feature engineering and preprocessing is now complete. I am able to distinguish some subsets of individuals in order to build both my training and validation sets. To build each model, I used 5-folds cross-validation (meaning that I put aside a specific subset of individuals for generalization characterization).", "Finally, to get the final predictions, I made two considerations: differentiation based on noise levels and aggregation through stacking.", "Generally, statistical models suffer from noise. My approach here consisted in building curated subsets of the train and test data according to specific metrics. Typically, to define a \u2018level of noise\u2019, I build three features for each of the EEG signals: maxima, minima, and area under curve. By centering (through median) the relative three distributions, I could naively determine a level of noise as corresponding to a ratio of distance to actual standard deviation. This method led me to define 5 levels of noise, as represented in the figure above as coverage levels. A signal that is not appearing at multiple levels is highly likely to contain an artifact. Such restrictions imply 5 different training phases, respective to each subset. However, those gave me levels of confidence regarding the multiple outputs. Finally, the predictions are obtained by iteratively overwriting themselves with predictions of finer levels.", "Once those 5 levels were dissociated, I launched the training of 4 different models (as presented in the feature engineering process): XGBoost, LigthGBM, RandomForest, and ExtraTrees. The hyperparameters were tuned using my own implementation of the hyperband. The optimized metric was the kappa score (understandable as an inter-agreement metric), used to benchmark the field.", "Those 4 models gave me, on each round of cross-validation, probabilities for the samples of either the training set, the validation set, and the test set. Importance was also given to the imbalance of the dataset and taken into account via weights during training and scoring.", "As a result, I ended up with the probabilities of those 4 models, which led me to stacking. This method is motivated by the diversity in outcomes, as presented in the predictions correlations between models hereunder. The underlying methodology, presented in the figure above, basically consists in taking the probabilities as features and using them as training, validation and test sets. In this case, I used a linear model (Stochastic Gradient Descent) and optimized the kappa metric through individual-based cross-validation.", "Let\u2019s focus on the correlations matrixes: since (XGBoost, LightGBM) and (RandomForest, ExtraTrees) are similar constructs, it appears intuitive that their predictions are highly correlated. However, two facts are noticeable:", "Given the previous results, my approach has strengths and weaknesses. It has two particular weaknesses: the model does not take into account the temporal relationship between samples, and it struggles in predicting the sleep-stage 1. Stage 1 is merely a transitional stage, going from an awake state to a real sleep-stage. I aimed at improving the previous model by building a filter on top of it. I first considered classic output smoothing, as would a bandpass (to keep either the high-frequency micro-wake-up and to insist on continuous sleep phases) or averaging method (e.g. Savitsky Golay). I then turned towards Hidden Markov Models, since those are exactly what I am looking for: transitional matrixes. However, the best result came from an approximation of it, through an overfitting LSTM based on 20 timesteps. The LSTM is based on the output probabilities (that I have both gathered for the train and test sets) and takes the temporal relationship into account. With it, I could build a transitional matrix (as would a HMM do) but for continuous inputs (probabilities).", "Finally, I improved the continuity of sleep phases, conserved micro-wake-ups events and emphasized the importance of the transitional stage 1.", "This concludes what I have been partially up to during this competition. A lot could be improved, and the possibilities are unlimited. In the end, I reached the second position, with a final kappa score of 70.7 on the private test set. As expected, the strategy used did not entirely protect me from overfitting, and a clear gap was observed between my internal score and the leaderboard score. In such healthcare context, involving individuals irremediably arouses the issue of covariate shift. The issue has been felt all along, but my results have shown great potential for generalization.", "I thank my beloved for her advice concerning Matthew Walker\u2019s book! Lots of similar projects are to come! Stay tuned for the incoming articles, and clap if you want more ;) !", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Serial Entrepreneur, Convinced Transhumanist, Tech Architect"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F414128441728&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmy-sweet-dreams-about-automatic-sleep-stage-classification-414128441728&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmy-sweet-dreams-about-automatic-sleep-stage-classification-414128441728&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmy-sweet-dreams-about-automatic-sleep-stage-classification-414128441728&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmy-sweet-dreams-about-automatic-sleep-stage-classification-414128441728&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----414128441728--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----414128441728--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://blog.merylldindin.com/?source=post_page-----414128441728--------------------------------", "anchor_text": ""}, {"url": "https://blog.merylldindin.com/?source=post_page-----414128441728--------------------------------", "anchor_text": "Meryll Dindin"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fe374d9336eec&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmy-sweet-dreams-about-automatic-sleep-stage-classification-414128441728&user=Meryll+Dindin&userId=e374d9336eec&source=post_page-e374d9336eec----414128441728---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F414128441728&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmy-sweet-dreams-about-automatic-sleep-stage-classification-414128441728&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F414128441728&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmy-sweet-dreams-about-automatic-sleep-stage-classification-414128441728&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "http://thefunnybeaver.com/32-memes-people-just-want-sleep/", "anchor_text": "The Funny Beaver"}, {"url": "https://challengedata.ens.fr/en/challenge/37/learning_sleep_stages_from_physiological_signals_on_dreem_headband.html", "anchor_text": "challenge"}, {"url": "https://dreem.com/en", "anchor_text": "Dreem"}, {"url": "https://www.theguardian.com/books/2017/sep/21/why-we-sleep-by-matthew-walker-review", "anchor_text": "Why We Sleep"}, {"url": "https://github.com/Coricos/DreemHeadband", "anchor_text": "GitHub"}, {"url": "https://towardsdatascience.com/from-tda-to-dl-d06f234f51d", "anchor_text": "TDA"}, {"url": "https://dreem.com/en/product", "anchor_text": "website"}, {"url": "https://dreem.com/en/product", "anchor_text": "Dreem"}, {"url": "http://www.macmillanhighered.com", "anchor_text": "http://www.macmillanhighered.com"}, {"url": "https://en.wikipedia.org/wiki/Lyapunov_exponent", "anchor_text": "Lyapunov Exponents"}, {"url": "https://en.wikipedia.org/wiki/Hurst_exponent", "anchor_text": "Hurst Exponent"}, {"url": "https://en.wikipedia.org/wiki/Fractal_dimension", "anchor_text": "Fractal Dimension"}, {"url": "https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3070217/#B13", "anchor_text": "PyEEG"}, {"url": "https://arxiv.org/abs/1603.06560", "anchor_text": "hyperband"}, {"url": "https://en.wikipedia.org/wiki/Cohen%27s_kappa", "anchor_text": "kappa score"}, {"url": "http://blog.kaggle.com/2017/06/15/stacking-made-easy-an-introduction-to-stacknet-by-competitions-grandmaster-marios-michailidis-kazanova/", "anchor_text": "No Free Hunch"}, {"url": "https://github.com/Coricos/DreemHeadband", "anchor_text": "Github Repository"}, {"url": "https://challengedata.ens.fr/en/challenge/37/learning_sleep_stages_from_physiological_signals_on_dreem_headband.html", "anchor_text": "Competition Website"}, {"url": "https://dreem.com/en", "anchor_text": "Dreem Website"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----414128441728---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/sleep?source=post_page-----414128441728---------------sleep-----------------", "anchor_text": "Sleep"}, {"url": "https://medium.com/tag/towards-data-science?source=post_page-----414128441728---------------towards_data_science-----------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/tag/healthcare?source=post_page-----414128441728---------------healthcare-----------------", "anchor_text": "Healthcare"}, {"url": "https://medium.com/tag/data-science?source=post_page-----414128441728---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F414128441728&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmy-sweet-dreams-about-automatic-sleep-stage-classification-414128441728&user=Meryll+Dindin&userId=e374d9336eec&source=-----414128441728---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F414128441728&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmy-sweet-dreams-about-automatic-sleep-stage-classification-414128441728&user=Meryll+Dindin&userId=e374d9336eec&source=-----414128441728---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F414128441728&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmy-sweet-dreams-about-automatic-sleep-stage-classification-414128441728&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----414128441728--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F414128441728&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmy-sweet-dreams-about-automatic-sleep-stage-classification-414128441728&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----414128441728---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----414128441728--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----414128441728--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----414128441728--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----414128441728--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----414128441728--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----414128441728--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----414128441728--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----414128441728--------------------------------", "anchor_text": ""}, {"url": "https://blog.merylldindin.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://blog.merylldindin.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Meryll Dindin"}, {"url": "https://blog.merylldindin.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "334 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fe374d9336eec&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmy-sweet-dreams-about-automatic-sleep-stage-classification-414128441728&user=Meryll+Dindin&userId=e374d9336eec&source=post_page-e374d9336eec--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F8c83f430ac8e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmy-sweet-dreams-about-automatic-sleep-stage-classification-414128441728&newsletterV3=e374d9336eec&newsletterV3Id=8c83f430ac8e&user=Meryll+Dindin&userId=e374d9336eec&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}