{"url": "https://towardsdatascience.com/the-kalman-filter-and-external-control-inputs-70ea6bcbc55f", "time": 1682996740.336121, "path": "towardsdatascience.com/the-kalman-filter-and-external-control-inputs-70ea6bcbc55f/", "webpage": {"metadata": {"title": "The Kalman Filter and External Control Inputs | by Ben Ogorek | Towards Data Science", "h1": "The Kalman Filter and External Control Inputs", "description": "With Python, implement a Kalman Filter model with external control inputs, use Maximum Likelihood to estimate unknown parameters, and see how cumulative impact can be modeled via the Kalman Filter."}, "outgoing_paragraph_urls": [{"url": "https://www.statsmodels.org/dev/generated/statsmodels.tsa.statespace.representation.Representation.html", "anchor_text": "statespace representation", "paragraph_index": 3}, {"url": "https://towardsdatascience.com/modeling-cumulative-impact-part-i-f7ef490ed5e3", "anchor_text": "Modeling Cumulative Impact Part I", "paragraph_index": 6}, {"url": "https://gist.github.com/baogorek/6d682e42079005b3bde951e98ebae89e", "anchor_text": "R gist", "paragraph_index": 13}, {"url": "https://towardsdatascience.com/modeling-cumulative-impact-part-ii-2bf65db3bb98", "anchor_text": "Modeling Cumulative Impact Part II", "paragraph_index": 13}, {"url": "https://drive.google.com/open?id=1kk40wiVYzPXOkrPffU55Vzy-LLTrgAVh", "anchor_text": "csv file", "paragraph_index": 13}, {"url": "https://www.statsmodels.org/dev/_modules/statsmodels/tsa/statespace/mlemodel.html", "anchor_text": "mlemodel", "paragraph_index": 15}, {"url": "https://www.statsmodels.org/dev/_modules/statsmodels/tsa/statespace/mlemodel.html", "anchor_text": "module", "paragraph_index": 15}, {"url": "https://towardsdatascience.com/modeling-cumulative-impact-part-iii-1b216273b499", "anchor_text": "Modeling Cumulative Impact Part III", "paragraph_index": 19}, {"url": "https://en.wikipedia.org/wiki/Broyden%E2%80%93Fletcher%E2%80%93Goldfarb%E2%80%93Shanno_algorithm", "anchor_text": "BFGS method", "paragraph_index": 19}, {"url": "https://towardsdatascience.com/modeling-cumulative-impact-part-i-f7ef490ed5e3", "anchor_text": "Modeling Cumulative Impact Part I", "paragraph_index": 22}, {"url": "https://www.mathworks.com/help/control/ug/kalman-filtering.html#responsive_offcanvas", "anchor_text": "MATLAB", "paragraph_index": 23}, {"url": "http://support.sas.com/documentation/cdl/en/etsug/67525/HTML/default/viewer.htm#etsug_ssm_details01.htm", "anchor_text": "SAS/ETS", "paragraph_index": 23}, {"url": "https://towardsdatascience.com/the-kalman-filter-and-maximum-likelihood-9861666f6742", "anchor_text": "The Kalman Filter and Maximum Likelihood", "paragraph_index": 26}], "all_paragraphs": ["The following is a specification of the Kalman Filter model with external \u201ccontrol\u201d input B u_t:", "where q_t \u223c N(0, \ud835\udc10) and r_t \u223c N(0, \ud835\udc11). The model matrices A, B, H, Q, and R may contain unknown parameters and are often allowed to vary through time. The external \u201ccontrol-vector\u201d input, u_t, must be known for all time points up to the present and \u2014 if the task requires predicting multiple time steps ahead \u2014 the future as well.", "In many forecasting contexts, the external control term is unused. Standard time series models, where the internal system dynamics are the only forces at play (e.g., ARIMA), do not need them. Consequently, the lack of an explicit control specification mechanism in statsmodels is no surprise. Fortunately, statsmodels does provide an interface to the state intercept that is sufficient to incorporate external control inputs.", "Take a moment to familiarize yourself with the statsmodels statespace representation, which uses slightly different notation for the state equation than presented at the beginning of this article:", "The \u201cstate_intercept\u201d c_t, which was not included in our specification, is zero by default in statsmodels. The description reads \u201cc : state_intercept (k_states x nobs)\u201d meaning that the user is free to specify a different value for the state intercept at every time point. (This is true for all statsmodels Kalman Filter model matrices.) But set", "for t=1\u2026T, and we have a Kalman Filter model with control inputs.", "The fitness-fatigue model from Modeling Cumulative Impact Part I is:", "where p_t is (athletic) performance and w_t is training \u201cdose\u201d (time-weighted training intensity) at time t. In my previous articles exploring this model, convolutions of training history with other functions has been the mechanism of representing the cumulative impact of the training sessions. This article will do something different by keeping a system state. In order to do that, we must put the fitness-fatigue model in state-space form, with training dose as the external control input.", "In the above equation, the first convolution sum represents athletic fitness, which I\u2019ll now call h_t. Below is the result of lagging one time step:", "Separating the final term in the convolution sum defining h_t, we arrive at the recursion:", "This argument proceeds in the same manner for fatigue\u2019s convolution sum, called g_t henceforth, and the recursive relationship for both fitness and fatigue can be expressed in the following \u201cstate-space form\u201d:", "We can continue using matrices to express the second \u201cmeasurement\u201d stage of the model with:", "where r_t ~ N(0, \u03c3\u00b2). The control input is lagged by one time period, which we\u2019ll have to account for, but otherwise we have a typical state-space formulation of the fitness-fatigue model with exogenous control inputs. Combined with the measurement model of performance given the current state of fitness and fatigue, the Kalman Filter toolkit (state estimation, easy imputation, and likelihood evaluation) is at our disposal.", "This section will use simulated data that can be reproduced from the R gist that was used in Modeling Cumulative Impact Part II, which is also available to the reader as a csv file. To run the code below, change the file path in the following Python code block:", "This block loads the required dependencies and prints a few lines of our input data set train_df:", "To create a Kalman Filter model in statsmodels, we must extend the MLEModel base class (from the mlemodel module).", "A few things to note about the class above:", "Next, instantiate the object with the data and estimate the unknown parameters using maximum likelihood. Note that we do need to lag the training input in order to match the model\u2019s specification (I\u2019ve gone back and forth on this during the time the article\u2019s been published).", "The last command produces the following output (spacing has been modified):", "The output shows that the Kalman Filter has done a good job recovering parameter values used in the simulation. Standard errors, which required a custom nonlinear approximation in Modeling Cumulative Impact Part III, are now available \u201cout of the box.\u201d On the other hand, the maximum likelihood procedure did require some tuning in this situation; increasing the minimum number of iterations and choosing the BFGS method led to a stable fit.", "The reader is encouraged to repeat the exercise above with the \u201capproximate diffuse\u201d initialization replaced by the known initialization (currently commented out). Unlike in The Kalman Filter and Maximum Likelihood, the results using the known initialization are somewhat different, especially the standard errors. When the known initialization is used, the standard error estimates from the Kalman Filter are similar to those estimated using the nonlinear approximation. With the approximate diffuse initialization, they are considerably larger for some parameters (especially the \u201ctime constants\u201d in the exponentials).", "The Kalman Filter gives us access to both filtered state estimates, which use only the data available up to a particular time point, and smoothed state estimates, which incorporate all available data into each time point\u2019s state estimate. Below we\u2019ll visualize the filtered state estimates, which naturally experience a rough start:", "Given that the true fitness state is initialized at 0 and gradually travels higher, the first few filtered state estimates are off by a lot and explain why likelihood_burn was set to 15. Replacing filtered_state with smoothed_state in the graphing code shows a picture that is much more similar to those in Modeling Cumulative Impact Part I.", "Before writing this article, I thought the only way to get a Kalman Filter with control inputs was to pay for MATLAB or SAS/ETS . And while statsmodels could make the specification a little more straightforward, adding in a control input to its Kalman Filter routines is still easily accomplished using the time-varying state intercept.", "Subclass derivation for defining a model, like that used in statsmodels, is sleek but makes debugging less transparent. (There were hours where these examples were not working.) Remember that the resulting objects contain their model matrices; printing them out is a good way to debug! Don\u2019t forget about the \u201cselection matrix\u201d which multiplies the state error in statsmodels \u2014 it defaults to zero. We didn\u2019t need it here because the fitness-fatigue model doesn\u2019t specify state error, but it can lead to the frustrating debugging scenario where code changes aren\u2019t affecting the output.", "Though the lack of a state error term made the current task simpler due to statsmodels defaults, the ability to add a state error term is an advantage of the Kalman Filter over the original fitness-fatigue model. It\u2019s easy to imagine things besides training that affect the latent fitness and fatigue, including sleep quality and nutrition. Adding a state error term to the original fitness-fatigue model is another variation to be explored.", "Unlike in The Kalman Filter and Maximum Likelihood, the \u201capproximate diffuse\u201d initialization led to different results than a known initialization of the state. In that article, perhaps the stationary ARMA(1, 2) model was too much of a softball, and that uncertainty about the initial state would really only matter in a non-stationary situation without the mean to fall back on. Nevertheless, it makes me curious about how different the \u201cexact diffuse\u201d initialization would have performed had it been implemented in statsmodels.", "The Kalman Filter is a very powerful tool for time series analysis and modeling. Not only is it able to calculate difficult likelihoods of classical time series models, but it can handle non-stationary models with exogenous control inputs and even guide the next space shuttle to the moon. As data scientists, we\u2019re lucky to have a free open-source implementation of the Kalman Filter, one that is sufficiently flexible for both statistical and engineering purposes, in statsmodels.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Data Scientist who enjoys learning and writing about methods. @benogorek on Twitter"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F70ea6bcbc55f&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-kalman-filter-and-external-control-inputs-70ea6bcbc55f&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-kalman-filter-and-external-control-inputs-70ea6bcbc55f&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-kalman-filter-and-external-control-inputs-70ea6bcbc55f&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-kalman-filter-and-external-control-inputs-70ea6bcbc55f&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----70ea6bcbc55f--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----70ea6bcbc55f--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@baogorek?source=post_page-----70ea6bcbc55f--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@baogorek?source=post_page-----70ea6bcbc55f--------------------------------", "anchor_text": "Ben Ogorek"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fa7ecfd165396&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-kalman-filter-and-external-control-inputs-70ea6bcbc55f&user=Ben+Ogorek&userId=a7ecfd165396&source=post_page-a7ecfd165396----70ea6bcbc55f---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F70ea6bcbc55f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-kalman-filter-and-external-control-inputs-70ea6bcbc55f&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F70ea6bcbc55f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-kalman-filter-and-external-control-inputs-70ea6bcbc55f&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://en.wikipedia.org/wiki/Control_theory#/media/File:Feedback_loop_with_descriptions.svg", "anchor_text": "by Wikimedia user Orzetto"}, {"url": "https://creativecommons.org/licenses/by-sa/4.0/", "anchor_text": "CC BY-SA 4.0"}, {"url": "https://towardsdatascience.com/modeling-cumulative-impact-part-i-f7ef490ed5e3", "anchor_text": "fitness-fatigue model of athletic performance"}, {"url": "https://www.statsmodels.org/dev/generated/statsmodels.tsa.statespace.representation.Representation.html", "anchor_text": "statespace representation"}, {"url": "https://towardsdatascience.com/modeling-cumulative-impact-part-i-f7ef490ed5e3", "anchor_text": "Modeling Cumulative Impact Part I"}, {"url": "https://gist.github.com/baogorek/6d682e42079005b3bde951e98ebae89e", "anchor_text": "R gist"}, {"url": "https://towardsdatascience.com/modeling-cumulative-impact-part-ii-2bf65db3bb98", "anchor_text": "Modeling Cumulative Impact Part II"}, {"url": "https://drive.google.com/open?id=1kk40wiVYzPXOkrPffU55Vzy-LLTrgAVh", "anchor_text": "csv file"}, {"url": "https://www.statsmodels.org/dev/_modules/statsmodels/tsa/statespace/mlemodel.html", "anchor_text": "mlemodel"}, {"url": "https://www.statsmodels.org/dev/_modules/statsmodels/tsa/statespace/mlemodel.html", "anchor_text": "module"}, {"url": "https://www.statsmodels.org/dev/generated/statsmodels.tsa.statespace.representation.Representation.html", "anchor_text": "statsmodels"}, {"url": "https://www.statsmodels.org/dev/generated/statsmodels.tsa.statespace.representation.Representation.html", "anchor_text": "representation"}, {"url": "https://towardsdatascience.com/modeling-cumulative-impact-part-iii-1b216273b499", "anchor_text": "Modeling Cumulative Impact Part III"}, {"url": "https://en.wikipedia.org/wiki/Broyden%E2%80%93Fletcher%E2%80%93Goldfarb%E2%80%93Shanno_algorithm", "anchor_text": "BFGS method"}, {"url": "https://towardsdatascience.com/modeling-cumulative-impact-part-i-f7ef490ed5e3", "anchor_text": "Modeling Cumulative Impact Part I"}, {"url": "https://www.mathworks.com/help/control/ug/kalman-filtering.html#responsive_offcanvas", "anchor_text": "MATLAB"}, {"url": "http://support.sas.com/documentation/cdl/en/etsug/67525/HTML/default/viewer.htm#etsug_ssm_details01.htm", "anchor_text": "SAS/ETS"}, {"url": "https://towardsdatascience.com/the-kalman-filter-and-maximum-likelihood-9861666f6742", "anchor_text": "The Kalman Filter and Maximum Likelihood"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----70ea6bcbc55f---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/towards-data-science?source=post_page-----70ea6bcbc55f---------------towards_data_science-----------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/tag/engineering?source=post_page-----70ea6bcbc55f---------------engineering-----------------", "anchor_text": "Engineering"}, {"url": "https://medium.com/tag/statistics?source=post_page-----70ea6bcbc55f---------------statistics-----------------", "anchor_text": "Statistics"}, {"url": "https://medium.com/tag/mathematics?source=post_page-----70ea6bcbc55f---------------mathematics-----------------", "anchor_text": "Mathematics"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F70ea6bcbc55f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-kalman-filter-and-external-control-inputs-70ea6bcbc55f&user=Ben+Ogorek&userId=a7ecfd165396&source=-----70ea6bcbc55f---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F70ea6bcbc55f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-kalman-filter-and-external-control-inputs-70ea6bcbc55f&user=Ben+Ogorek&userId=a7ecfd165396&source=-----70ea6bcbc55f---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F70ea6bcbc55f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-kalman-filter-and-external-control-inputs-70ea6bcbc55f&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----70ea6bcbc55f--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F70ea6bcbc55f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-kalman-filter-and-external-control-inputs-70ea6bcbc55f&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----70ea6bcbc55f---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----70ea6bcbc55f--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----70ea6bcbc55f--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----70ea6bcbc55f--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----70ea6bcbc55f--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----70ea6bcbc55f--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----70ea6bcbc55f--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----70ea6bcbc55f--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----70ea6bcbc55f--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@baogorek?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@baogorek?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Ben Ogorek"}, {"url": "https://medium.com/@baogorek/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "177 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fa7ecfd165396&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-kalman-filter-and-external-control-inputs-70ea6bcbc55f&user=Ben+Ogorek&userId=a7ecfd165396&source=post_page-a7ecfd165396--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F536bc54ba88c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fthe-kalman-filter-and-external-control-inputs-70ea6bcbc55f&newsletterV3=a7ecfd165396&newsletterV3Id=536bc54ba88c&user=Ben+Ogorek&userId=a7ecfd165396&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}