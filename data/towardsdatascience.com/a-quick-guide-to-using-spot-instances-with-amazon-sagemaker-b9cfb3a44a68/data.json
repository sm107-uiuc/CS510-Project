{"url": "https://towardsdatascience.com/a-quick-guide-to-using-spot-instances-with-amazon-sagemaker-b9cfb3a44a68", "time": 1683006364.6481228, "path": "towardsdatascience.com/a-quick-guide-to-using-spot-instances-with-amazon-sagemaker-b9cfb3a44a68/", "webpage": {"metadata": {"title": "A quick guide to using Spot instances with Amazon SageMaker | by Shashank Prasanna | Towards Data Science", "h1": "A quick guide to using Spot instances with Amazon SageMaker", "description": "Lower your deep learning training costs with Managed Spot Training on Amazon SageMaker"}, "outgoing_paragraph_urls": [{"url": "https://aws.amazon.com/blogs/machine-learning/train-deep-learning-models-on-gpus-using-amazon-ec2-spot-instances/", "anchor_text": "using Amazon EC2 Spot instances for deep learning training", "paragraph_index": 1}, {"url": "https://docs.aws.amazon.com/sagemaker/latest/dg/model-managed-spot-training.html", "anchor_text": "Managed Spot Training", "paragraph_index": 2}, {"url": "https://github.com/shashankprasanna/sagemaker-spot-training/blob/master/tf-keras-cifar10-spot-training.ipynb", "anchor_text": "Jupyter notebook", "paragraph_index": 28}, {"url": "https://twitter.com/shshnkp", "anchor_text": "@shshnkp", "paragraph_index": 33}, {"url": "https://www.linkedin.com/in/shashankprasanna/", "anchor_text": "LinkedIn", "paragraph_index": 33}, {"url": "http://shashankprasanna.com", "anchor_text": "shashankprasanna.com", "paragraph_index": 35}], "all_paragraphs": ["One of the simplest ways to lower your machine learning training costs is to use Amazon EC2 Spot instances. Spot instances allow you to access spare Amazon EC2 compute capacity at a steep discount of up to 90% compared to on-demand rates. So why not always use Spot instances? Well, you can, as long as your workload is tolerant to sudden interruptions. Since Spot instances are part of spare capacity, they may be reclaimed with just 2 minutes notice!", "Deep learning training is a good example of a workload that can be made tolerant to interruptions and I\u2019ve written about using Amazon EC2 Spot instances for deep learning training before. However, as a machine learning developer or data scientist, you may not want to manage Spot fleet requests, poll for capacity, poll for termination status, manually back up your checkpoints, manually sync checkpoints when resuming training, and set everything up every time you want to run training jobs.", "Amazon SageMaker offers Managed Spot Training, which is a convenient way to lower training costs using Amazon EC2 Spot instances for Amazon SageMaker training jobs. This means you can now save up to 90% on training workloads without having to setup and manage Spot instances. Amazon SageMaker will automatically provision Spot instances for you, and if a Spot instance is reclaimed, Amazon SageMaker will automatically resume training after capacity is available!", "In this blog post, I\u2019ll provide a step-by-step guide to using Spot instances with Amazon SageMaker for deep learning training. I\u2019ll cover what code changes you need to make to take advantage of Amazon SageMaker\u2019s automatic checkpoint back up and sync to Amazon S3 feature. I\u2019ll be using Keras with TensorFlow backend to illustrate how you can take advantage of Amazon SageMaker Managed Spot Training. You can also implement the same steps on an another framework such as PyTorch or MXNet.", "To take advantage of Spot instance savings, your workload must be tolerant of interruptions. In machine learning, and there are two types of workloads that broadly fall into this category:", "In the first case, if a Spot instance is reclaimed, traffic can be routed to another instance, assuming you\u2019ve set up your service with redundancy for high-availability. In the second case, if a Spot instance is interrupted, your application must immediately save its current state, and resume training when capacity has been restored.", "In this guide, I\u2019ll cover the second use-case, i.e. Spot instances for deep learning training jobs using open-source deep learning frameworks such as TensorFlow, PyTorch, MXNet and others.", "Let me start with how Amazon SageMaker runs deep learning training. This background is important to understand how SageMaker manages Spot training and backs up your checkpoint data and resumes training. If you\u2019re an Amazon SageMaker user, this should serve as a quick reminder.", "Amazon SageMaker will manage infrastructure details, so you don\u2019t have to. Amazon SageMaker will:", "Spot instances can be preempted and be terminated with just 2 minutes notice, therefore it\u2019s critical that you frequently checkpoint training progress. Thankfully, Amazon SageMaker will manage everything else. It\u2019ll automatically backup your training checkpoints to Amazon S3 and if the training instance is terminated due to lack of capacity, it\u2019ll keep polling for capacity, and automatically restart training once capacity becomes available.", "Amazon SageMaker will automatically copy your dataset and the checkpoint files into the new instance and make it available to your training script in a docker container so that you can resume training from the latest checkpoint.", "Let\u2019s take a look at an example to see how you can prepare your training scripts to make it Spot training ready.", "To make sure that your training scripts can take advantage of SageMaker Managed Spot instances you\u2019ll need to implement:", "I\u2019ll show how to make these changes in Keras, but you can follow the same steps on another framework.", "Amazon SageMaker will automatically back up and sync checkpoint files generated by your training script to Amazon S3. Therefore you\u2019ll need to make sure that your training script saves checkpoints to a local checkpoint directory on the docker container that\u2019s running the training. The default location to save the checkpoint files is /opt/ml/checkpoints and Amazon SageMaker will sync these files to the specific Amazon S3 bucket. Both local and Amazon S3 checkpoint locations are customizable.", "If you\u2019re using Keras, this is very easy. Create an instance of the ModelCheckpoint callback class and register it with the model by passing it to fit() function.", "Notice that I\u2019m passing initial_epoch which you normally wouldn\u2019t have bothered with. This lets us resume training from a certain epoch number and will come in handy when you already have checkpoint files.", "When spot capacity becomes available again after an interruption, Amazon SageMaker will:", "Your script needs to implement resuming training from checkpoint files, otherwise your training script will restart training from scratch. You can implement a load_checkpoint_mode function as shown below. It takes in the local checkpoint files path (/opt/ml/checkpoints being the default), and returns a model loaded from the latest checkpoint and the associated epoch number.", "There are many ways to query a list of files in a directory, extract the epoch number from the file names and load the file name with the latest epoch number. I use os.listdir() and regular expressions. I\u2019m sure you can come up with more clever and elegant ways to do the same thing.", "You can launch Amazon SageMaker training jobs from your laptop, desktop, Amazon EC2 instance, or Amazon SageMaker Notebook instances. As long as you have Amazon SageMaker Python SDK installed and the right user permissions to run SageMaker training jobs.", "To run a managed spot training job, you\u2019ll need to specify few additional options to your standard Amazon SageMaker Estimator function call.", "That\u2019s it. Those are all the changes you need to make to dramatically lower your cost to train.", "To monitor your training job and view savings you can look at the logs on your Jupyter notebook or navigate to Amazon SageMaker Console > Training Job, click on your training job name. Once the training is completed, you should see how much you saved. As an example, for a 30 epoch training on a p3.2xlarge GPU instance, I was able to save 70% on training cost!", "How do you know if your training will resume properly if a spot interruption occurs?", "If you\u2019re familiar with running Amazon EC2 Spot instances, you know that you can simulate your application behavior during a Spot interruption by terminating the Amazon EC2 Spot instance. If there is capacity, Spot fleet will launch a new instance to replace the one you terminated. You can monitor your application to check if it handles interruptions and resumes gracefully. Unfortunately (or fortunately?), you can\u2019t terminate an Amazon SageMaker training instance manually. Your only option is to stop the entire training job.", "Fortunately, you can still test your code for its behavior when resuming training. To do that first run an Amazon SageMaker Managed Spot training for a specified number of epochs as described in the previous section. Let\u2019s say you run training for 10 epochs. Amazon SageMaker would have backed up your checkpoint files to the specified Amazon S3 location for the 10 epochs. Head over to Amazon S3 to verify that the checkpoints are available:", "Now run a second training run, but this time provide the first jobs\u2019 checkpoint location to checkpoint_s3_uri", "Here is the relevant excerpt from the Jupyter notebook:", "By providing checkpoint_s3_uri with your previous job\u2019s checkpoints, you\u2019re telling Amazon SageMaker to copy those checkpoints to your new job\u2019s container. Your training script will then load the latest checkpoint and resume training. In the figure below you can see that the training will resume from the 10th epoch.", "The key difference between simulating interruption this way and how Amazon SageMaker will manage interruptions is that you\u2019re creating a new training job to test your code. In the case of Spot interruptions, Amazon SageMaker will simply resume the existing interrupted job.", "I know I don\u2019t have to convince you that saving costs is a good thing. Hopefully, I\u2019ve shown you that it\u2019s easy to save on training costs with Amazon SageMaker Managed Spot training. With minimal code changes, you can save over 70% in training costs. You can now peacefully run GPUs training jobs without breaking the bank.", "Thanks for reading, I hope you enjoyed this guide. All the code and examples are available on GitHub here:", "If you have questions about this article, suggestions on how to improve it or ideas for new guides and articles, please reach out to me on twitter (@shshnkp), LinkedIn or leave a comment below. Happy saving!", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Talking Engineer. Runner. Coffee Connoisseur. Formerly Machine learning @Meta, AWS, NVIDIA, MATLAB, posts are my own opinions. website: shashankprasanna.com"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fb9cfb3a44a68&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-quick-guide-to-using-spot-instances-with-amazon-sagemaker-b9cfb3a44a68&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-quick-guide-to-using-spot-instances-with-amazon-sagemaker-b9cfb3a44a68&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-quick-guide-to-using-spot-instances-with-amazon-sagemaker-b9cfb3a44a68&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-quick-guide-to-using-spot-instances-with-amazon-sagemaker-b9cfb3a44a68&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----b9cfb3a44a68--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----b9cfb3a44a68--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@shashankprasanna?source=post_page-----b9cfb3a44a68--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@shashankprasanna?source=post_page-----b9cfb3a44a68--------------------------------", "anchor_text": "Shashank Prasanna"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fe0c596ca35b5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-quick-guide-to-using-spot-instances-with-amazon-sagemaker-b9cfb3a44a68&user=Shashank+Prasanna&userId=e0c596ca35b5&source=post_page-e0c596ca35b5----b9cfb3a44a68---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fb9cfb3a44a68&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-quick-guide-to-using-spot-instances-with-amazon-sagemaker-b9cfb3a44a68&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fb9cfb3a44a68&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-quick-guide-to-using-spot-instances-with-amazon-sagemaker-b9cfb3a44a68&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://aws.amazon.com/blogs/machine-learning/train-deep-learning-models-on-gpus-using-amazon-ec2-spot-instances/", "anchor_text": "using Amazon EC2 Spot instances for deep learning training"}, {"url": "https://docs.aws.amazon.com/sagemaker/latest/dg/model-managed-spot-training.html", "anchor_text": "Managed Spot Training"}, {"url": "https://github.com/shashankprasanna/sagemaker-spot-training", "anchor_text": "https://github.com/shashankprasanna/sagemaker-spot-training"}, {"url": "https://aws.amazon.com/blogs/machine-learning/deploying-pytorch-models-for-inference-at-scale-using-torchserve/", "anchor_text": "read my blog post"}, {"url": "https://github.com/shashankprasanna/sagemaker-spot-training/blob/master/code/cifar10-training-sagemaker.py", "anchor_text": "https://github.com/shashankprasanna/sagemaker-spot-training/blob/master/code/cifar10-training-sagemaker.py"}, {"url": "https://github.com/shashankprasanna/sagemaker-spot-training/blob/master/code/cifar10-training-sagemaker.py", "anchor_text": "https://github.com/shashankprasanna/sagemaker-spot-training/blob/master/code/cifar10-training-sagemaker.py"}, {"url": "https://github.com/shashankprasanna/sagemaker-spot-training/blob/master/tf-keras-cifar10-spot-training.ipynb", "anchor_text": "https://github.com/shashankprasanna/sagemaker-spot-training/blob/master/tf-keras-cifar10-spot-training.ipynb"}, {"url": "https://github.com/shashankprasanna/sagemaker-spot-training/blob/master/tf-keras-cifar10-spot-training.ipynb", "anchor_text": "Jupyter notebook"}, {"url": "https://github.com/shashankprasanna/sagemaker-spot-training/blob/master/tf-keras-cifar10-spot-training.ipynb", "anchor_text": "https://github.com/shashankprasanna/sagemaker-spot-training/blob/master/tf-keras-cifar10-spot-training.ipynb"}, {"url": "https://github.com/shashankprasanna/sagemaker-spot-training", "anchor_text": "https://github.com/shashankprasanna/sagemaker-spot-training"}, {"url": "https://twitter.com/shshnkp", "anchor_text": "@shshnkp"}, {"url": "https://www.linkedin.com/in/shashankprasanna/", "anchor_text": "LinkedIn"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----b9cfb3a44a68---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----b9cfb3a44a68---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/tag/sagemaker?source=post_page-----b9cfb3a44a68---------------sagemaker-----------------", "anchor_text": "Sagemaker"}, {"url": "https://medium.com/tag/tensorflow?source=post_page-----b9cfb3a44a68---------------tensorflow-----------------", "anchor_text": "TensorFlow"}, {"url": "https://medium.com/tag/aws?source=post_page-----b9cfb3a44a68---------------aws-----------------", "anchor_text": "AWS"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fb9cfb3a44a68&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-quick-guide-to-using-spot-instances-with-amazon-sagemaker-b9cfb3a44a68&user=Shashank+Prasanna&userId=e0c596ca35b5&source=-----b9cfb3a44a68---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fb9cfb3a44a68&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-quick-guide-to-using-spot-instances-with-amazon-sagemaker-b9cfb3a44a68&user=Shashank+Prasanna&userId=e0c596ca35b5&source=-----b9cfb3a44a68---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fb9cfb3a44a68&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-quick-guide-to-using-spot-instances-with-amazon-sagemaker-b9cfb3a44a68&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----b9cfb3a44a68--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fb9cfb3a44a68&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-quick-guide-to-using-spot-instances-with-amazon-sagemaker-b9cfb3a44a68&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----b9cfb3a44a68---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----b9cfb3a44a68--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----b9cfb3a44a68--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----b9cfb3a44a68--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----b9cfb3a44a68--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----b9cfb3a44a68--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----b9cfb3a44a68--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----b9cfb3a44a68--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----b9cfb3a44a68--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@shashankprasanna?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@shashankprasanna?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Shashank Prasanna"}, {"url": "https://medium.com/@shashankprasanna/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "681 Followers"}, {"url": "http://shashankprasanna.com", "anchor_text": "shashankprasanna.com"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fe0c596ca35b5&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-quick-guide-to-using-spot-instances-with-amazon-sagemaker-b9cfb3a44a68&user=Shashank+Prasanna&userId=e0c596ca35b5&source=post_page-e0c596ca35b5--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fd48ce4d9cb5c&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fa-quick-guide-to-using-spot-instances-with-amazon-sagemaker-b9cfb3a44a68&newsletterV3=e0c596ca35b5&newsletterV3Id=d48ce4d9cb5c&user=Shashank+Prasanna&userId=e0c596ca35b5&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}