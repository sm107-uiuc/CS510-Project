{"url": "https://towardsdatascience.com/implementing-spade-using-fastai-6ad86b94030a", "time": 1682996140.521656, "path": "towardsdatascience.com/implementing-spade-using-fastai-6ad86b94030a/", "webpage": {"metadata": {"title": "Implementing SPADE using fastai. I was fascinated by the results of\u2026 | by Divyansh Jha | Towards Data Science", "h1": "Implementing SPADE using fastai", "description": "I was fascinated by the results of Nvidia\u2019s latest research paper when it came out. If you haven\u2019t looked at the paper result then you are missing out. Also, have a look at SPADE based GAN in action\u2026"}, "outgoing_paragraph_urls": [{"url": "https://arxiv.org/abs/1903.07291", "anchor_text": "paper", "paragraph_index": 0}, {"url": "https://medium.com/u/ab69c39a85e1?source=post_page-----6ad86b94030a--------------------------------", "anchor_text": "NVIDIA AI", "paragraph_index": 6}, {"url": "https://github.com/divyanshj16/spade", "anchor_text": "Github repository here", "paragraph_index": 7}, {"url": "https://github.com/divyanshj16/SPADE/blob/master/SPADE-without-feature-matching-loss.ipynb", "anchor_text": "this notebook", "paragraph_index": 7}, {"url": "https://chesapeakeconservancy.org/conservation-innovation-center/high-resolution-data/land-cover-data-project/", "anchor_text": "Chesapeake Conservancy Land Cover Data Project", "paragraph_index": 21}, {"url": "https://github.com/divyanshj16/SPADE", "anchor_text": "my Github repository", "paragraph_index": 26}, {"url": "https://github.com/divyanshj16/SPADE", "anchor_text": "https://github.com/divyanshj16/SPADE", "paragraph_index": 30}, {"url": "https://twitter.com/divyanshjha", "anchor_text": "Twitter", "paragraph_index": 31}, {"url": "https://github.com/divyanshj16", "anchor_text": "GitHub", "paragraph_index": 31}], "all_paragraphs": ["I was fascinated by the results of Nvidia\u2019s latest research paper when it came out. If you haven\u2019t looked at the paper result then you are missing out. Also, have a look at SPADE based GAN in action in the GIF. I couldn\u2019t wait for the official implementation to be released and decided to implement the paper myself using our favorite fastai library. fastai provides a very neat API which can be used to develop highly customizable models. Specifically, it\u2019s datablock and callbacks API is mind-blowing.", "The paper is a very simple idea which is reported to give huge performance boosts on the task of photo-realistic image synthesis using semantic maps as inputs to the GAN model. Today I am gonna implement it block by block.", "If you follow this blog till the end, you will learn about fastai and PyTorch and implementing new architectures and using new datasets.", "SPADE stands for SPatially ADaptivE Normalization which is just a normalization technique like Batch Norm, Instance Norm, etc. It is used in GANs to generate synthetic photo-realistic Images from the segmentation mask. The paper uses this normalization technique in all the layers of the generator. The idea of SPADE is that instead of learning the affine parameters in the Batch Norm layer they use the semantic map to compute those affine parameters. Confused what affine parameters are?", "This is an image from the batch norm paper. Those little gamma and beta guys are the affine parameters. Those parameters are learnable and gives model the freedom to choose any distribution they want to become. So, the SPADE says why not use the semantic maps to compute those gammas and betas so called the scaling and shifting parameters respectively.", "Instead of using the randomly initialized scaling and shifting parameters, SPADE will utilize the semantic maps to compute those and THAT\u2019S IT! They did this because the conventional normalization layers washes away the information in input semantic masks. SPADE helps in effectively propagating the semantic information throughout the network. Below is an architecture of a SPADE block.", "Now, all that I spoke must have started to make sense. The traditional normalization is still performed, just the affine parameters are different. Basically, they are just a couple of convolutions applied on the input semantic map. I am really thankful to NVIDIA AI researchers for making this paper so much visual. So now let\u2019s get set and write the code.", "All of the code that I will be showing here is from my Github repository here. I will show you the implementation of a version of the SPADE paper with fewer features which is in this notebook, but I have implemented other additions in other notebooks. Since it is a GAN, it will have a generator block and a discriminator block. The generator block is what contains SPADE layer. So we will start first by implementing the basic SPADE block.", "This image is just the more detailed version of the earlier picture. It tells exactly which convolutions to be performed on the semantic map.", "It accepts the segmentation mask and features. The segmentation mask is just the straight and simple long integer 2D mask, the paper advises to use embedding layer for the classes, but I decided to go simple, therefore the first convolutional layer number of input filters is 1. Then it resizes the mask in the size of the features. It does that because SPADE layer will be used at every layer, so it needs to know the size of the features so that the mask can be resized for the operation of the affine paramete. Take a look at when I initialize the BatchNorm2d layer I set affine to false to not use the default affine parameters. Spectral Normalization is used in all the convolutional blocks in the paper to stabilize the GAN training. In PyTorch a new layer is implemented by inheriting from \u201cnn.Module\u201d and by implementing \u201c__init__\u201d and \u201cforward\u201d functions. The variable names ni and nf are used for number of input filters and number of output filter in convolutional layers respectively.", "After implementing the SPADE block we can now use it in our SPADE ResBlk and its pretty straight forward.", "Now, we have got the basic block setup and now is the time to stack them up as shown in the architecture below.", "I listed out the number of feature maps that individual layers will be throwing out and created the generator using a for loop.", "To keep things simple in my code, I use these tricks like initializing the parameters of the module with a global variable. You can see that the nfs variable contains the output of all the SPADE residual blocks which used in initializing the layers in the generator. In the end, I make the output from the tanh layer to be in the range 0\u20131, so that it is simpler to visualize.", "The discriminator is a Multi-Scale, Patch Gan based Discriminator. Multi-Scale means that it classifies the given image at different scale. Patch Gan based discriminator the final output layer is convolutional and the spatial mean is taken. The output from multiple scale is just added to give the final output.", "The discriminator takes both mask and the generated/real images at one time and output the activation. As this can be seen in the code the forward method in the discriminator is taking both mask and image as input.", "Now we have implemented the complete architecture of the model. The complete architecture looks like this.", "It\u2019s now time to implement the loss functions.", "Since it\u2019s a gan there are two loss functions one for the generator and the other one for the discriminator. The loss function is the the hinge loss from SAGAN paper which I mentioned in my earlier blog. The loss unction is very simple and is literally just one line of code. BUT, it is the part where I spent the most time and realized how important is a loss function in a deep learning problem.", "The above two equations can be written in code in the code block below. Sometimes these scary looking equations are just a single line of code.", "Here we have the paper implemented in code, but we need to 2 more things. Firstly we need the data to pass to the model and preprocess the data and a training loop to train our model. The data preparation step used to haunt me earlier, but not much after the fastai version 1 has been released. It makes a lot of these things very simple and quick.", "I used land cover classification data provided by Chesapeake Conservancy Land Cover Data Project. I extracted all the images of from the classified raster using ArcGIS Pro\u2019s \u201cExport Training Data for Deep Learning\u201d tool. Once I got images on the disk, I used fastai datablock API to load them to be passed to create a fastai learner and call its fit method. After creating appropriate classes I used the following code to create a fastai databunch object.", "The classes I created were SpadeItemList, it\u2019s just the fastai\u2019s SegmentaionItemList reversed. So what fastai does is that, you can create a class inheriting from a fastai Item or Label class and override a couple of methods according to your needs and it will create the databunch object using that class. Databunch object contains attributes contaning PyTorch datasets and dataloaders. It contains a method that shows your data called show_batch. Here is the output of my show_batch.", "Now, the data preparation step is complete, so now have to train the model.", "In fastai we have to create a learner which contains the method fit which actually trains the model. But this is not a simple model like image classification, in GAN we need to switch the model from generator to discriminator and viceversa. To use the fastai library we need to create callback mechanism to do that. I copied fastai library\u2019s GANLearner and modified it a bit to do that.", "The self.gen_mode tells the GANModule when to use generator and when to use discriminator. There is a callback implemented in fastai which switches the GAN at fixed intervals. I set the discriminator steps to five times for each generator step. This is done using FixedGANSwitcher.", "There are other callbacks that are used. Please look at the code in my Github repository.", "Now we can run fit method to train the model.", "The results are not that photorealistic, but given enough time and compute and removing any bugs present will make the model to generate good images. Below are the initial images that the model generated.", "And after 100 epochs of training. It started to produce some detailed images but with some artifacts.", "Spade is just a normalization layer which helps in generating photorealistic images. I implemented it here: https://github.com/divyanshj16/SPADE", "If you made it till here, I hope you liked it. You can reach me on Twitter for any queries. Follow me on GitHub as I will be implementing more papers. I am new to this paper implementing business so please highlight any mistakes you may have found in my code and in my blog. Cheers!", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F6ad86b94030a&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fimplementing-spade-using-fastai-6ad86b94030a&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fimplementing-spade-using-fastai-6ad86b94030a&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fimplementing-spade-using-fastai-6ad86b94030a&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fimplementing-spade-using-fastai-6ad86b94030a&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----6ad86b94030a--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----6ad86b94030a--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@divyanshj.16?source=post_page-----6ad86b94030a--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@divyanshj.16?source=post_page-----6ad86b94030a--------------------------------", "anchor_text": "Divyansh Jha"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F463c1e39f861&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fimplementing-spade-using-fastai-6ad86b94030a&user=Divyansh+Jha&userId=463c1e39f861&source=post_page-463c1e39f861----6ad86b94030a---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F6ad86b94030a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fimplementing-spade-using-fastai-6ad86b94030a&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F6ad86b94030a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fimplementing-spade-using-fastai-6ad86b94030a&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://arxiv.org/abs/1903.07291", "anchor_text": "paper"}, {"url": "https://nvlabs.github.io/SPADE/", "anchor_text": "https://nvlabs.github.io/SPADE/"}, {"url": "https://arxiv.org/abs/1502.03167", "anchor_text": "https://arxiv.org/abs/1502.03167"}, {"url": "https://arxiv.org/abs/1903.07291", "anchor_text": "https://arxiv.org/abs/1903.07291"}, {"url": "https://medium.com/u/ab69c39a85e1?source=post_page-----6ad86b94030a--------------------------------", "anchor_text": "NVIDIA AI"}, {"url": "https://github.com/divyanshj16/spade", "anchor_text": "Github repository here"}, {"url": "https://github.com/divyanshj16/SPADE/blob/master/SPADE-without-feature-matching-loss.ipynb", "anchor_text": "this notebook"}, {"url": "https://arxiv.org/abs/1903.07291", "anchor_text": "https://arxiv.org/abs/1903.07291"}, {"url": "https://arxiv.org/abs/1903.07291", "anchor_text": "https://arxiv.org/abs/1903.07291"}, {"url": "https://arxiv.org/abs/1903.07291", "anchor_text": "https://arxiv.org/abs/1903.07291"}, {"url": "https://arxiv.org/abs/1903.07291", "anchor_text": "https://arxiv.org/abs/1903.07291"}, {"url": "https://arxiv.org/abs/1903.07291", "anchor_text": "https://arxiv.org/abs/1903.07291"}, {"url": "https://chesapeakeconservancy.org/conservation-innovation-center/high-resolution-data/land-cover-data-project/", "anchor_text": "Chesapeake Conservancy Land Cover Data Project"}, {"url": "https://github.com/divyanshj16/SPADE", "anchor_text": "my Github repository"}, {"url": "https://github.com/divyanshj16/SPADE", "anchor_text": "https://github.com/divyanshj16/SPADE"}, {"url": "https://twitter.com/divyanshjha", "anchor_text": "Twitter"}, {"url": "https://github.com/divyanshj16", "anchor_text": "GitHub"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----6ad86b94030a---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----6ad86b94030a---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----6ad86b94030a---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/tag/computer-vision?source=post_page-----6ad86b94030a---------------computer_vision-----------------", "anchor_text": "Computer Vision"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F6ad86b94030a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fimplementing-spade-using-fastai-6ad86b94030a&user=Divyansh+Jha&userId=463c1e39f861&source=-----6ad86b94030a---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F6ad86b94030a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fimplementing-spade-using-fastai-6ad86b94030a&user=Divyansh+Jha&userId=463c1e39f861&source=-----6ad86b94030a---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F6ad86b94030a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fimplementing-spade-using-fastai-6ad86b94030a&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----6ad86b94030a--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F6ad86b94030a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fimplementing-spade-using-fastai-6ad86b94030a&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----6ad86b94030a---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----6ad86b94030a--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----6ad86b94030a--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----6ad86b94030a--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----6ad86b94030a--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----6ad86b94030a--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----6ad86b94030a--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----6ad86b94030a--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----6ad86b94030a--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@divyanshj.16?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@divyanshj.16?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Divyansh Jha"}, {"url": "https://medium.com/@divyanshj.16/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "458 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F463c1e39f861&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fimplementing-spade-using-fastai-6ad86b94030a&user=Divyansh+Jha&userId=463c1e39f861&source=post_page-463c1e39f861--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F6e71dc3fa77a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fimplementing-spade-using-fastai-6ad86b94030a&newsletterV3=463c1e39f861&newsletterV3Id=6e71dc3fa77a&user=Divyansh+Jha&userId=463c1e39f861&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}