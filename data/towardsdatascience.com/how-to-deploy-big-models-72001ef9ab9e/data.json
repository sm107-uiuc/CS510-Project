{"url": "https://towardsdatascience.com/how-to-deploy-big-models-72001ef9ab9e", "time": 1682996595.075605, "path": "towardsdatascience.com/how-to-deploy-big-models-72001ef9ab9e/", "webpage": {"metadata": {"title": "How to deploy big models. 500MB of Pytorch on AppEngine and\u2026 | by Ben Mann | Towards Data Science", "h1": "How to deploy big models", "description": "I recently deployed a 500MB Pytorch model. It was surprisingly hard! In this post, I document the pitfalls and tradeoffs I made. Running on CPU was nearly as fast as GPU for non-batch processing, so\u2026"}, "outgoing_paragraph_urls": [{"url": "https://duet.li", "anchor_text": "deployed", "paragraph_index": 0}, {"url": "https://www.tensorflow.org/tfx/guide/serving", "anchor_text": "Tensorflow Serving", "paragraph_index": 2}, {"url": "https://medium.com/styria-data-science-tech-blog/running-pytorch-models-in-production-fa09bebca622", "anchor_text": "difficult", "paragraph_index": 2}, {"url": "https://github.com/JasonBenn/duet/blob/master/Dockerfile", "anchor_text": "docker container", "paragraph_index": 5}, {"url": "https://github.com/JasonBenn/duet/blob/master/app.yaml", "anchor_text": "boosted", "paragraph_index": 5}, {"url": "https://docs.pylonsproject.org/projects/waitress/en/stable/#", "anchor_text": "Waitress", "paragraph_index": 6}], "all_paragraphs": ["I recently deployed a 500MB Pytorch model. It was surprisingly hard! In this post, I document the pitfalls and tradeoffs I made.", "Running on CPU was nearly as fast as GPU for non-batch processing, so I recommend starting with that if you can.", "Tensorflow Serving seemed ok, but converting our model from Pytorch to ONNX might have been difficult. We also wanted to keep the local code as simple as possible for ease of development. To make sure the server came up quickly, I copied the model into the codebase with a .gitignore entry. I added pytorch-pretrained-bert to my requirements.txt, which added over 300MB of dependencies.", "First I tried Google AppEngine (GAE)standard environment. When I tried to deploy, the remote build failed with a mysterious error message. I eventually discovered it was because my app had exceeded the maximum for the remote build environment. According to the support forums, there is no way to increase the memory limit.", "I thought maybe Heroku would support larger payloads, but it turned out to have the same 500MB limit and a much more reasonable error message: \u201cCompiled slug size: 634M is too large (max is 500M).\u201d", "Then I set up a docker container to deploy on GAE flexible environment. This also failed because the machines ran out of memory as they came up and were silently killed. I figured this out by looking at the memory usage and seeing it spike up above the default limits. I boosted the memory requirements and it started serving! But it was still horribly slow (30 seconds just to load static pages) on the server, but fast locally.", "I found the main difference was Gunicorn vs Flask development server. For some reason Gunicorn failed to respond to health checks. I tried manually implementing these checks in Flask, but to no avail. Then I tried deploying with the Flask dev server, which I knew to be a no-no since it doesn\u2019t provide things like request queues. Each request was fast, but the flask dev server isn\u2019t built to scale. I my the Docker container locally with Gunicorn and found it just as slow as on AppEngine. I tried a bunch of magic config options including verbose logging, but nothing helped or revealed the problem. After evaluating many alternatives, I finally settled on Waitress. It was pretty poorly documented, but I eventually found the magic invocation. It worked!", "Deployment still takes an eternity and a half for some reason (~15\u201330 minutes), so to speed things up, I do my docker build locally and then docker push the already-built image.", "AppEngine does not support GPUs, so I went with Google Kubernetes Engine (GKE). It turns out that it\u2019s not enough to add GPUs to your nodes. You also need to install the drivers. Creating the cluster and setting up the service should be something like this:", "Then find your public IP using kubectl get ingress. It will take a minute to provision.", "Managed services like Heroku and AppEngine try to isolate developers from DevOps, but the promise does not appear to extend to large models, and especially not Pytorch models. In this post I showed how to deploy to GAE flexible environment and GKE using Flask and Waitress. Now that I have a recipe that works, it will be easy to host more in the future. The nice part is we still get autoscaling, logging, etc from GAE for free. For GKE it\u2019s just a config away.", "Have you found an easier way? Leave a note!", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Software engineer, tinkerer, aspiring mad scientist"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F72001ef9ab9e&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-deploy-big-models-72001ef9ab9e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-deploy-big-models-72001ef9ab9e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-deploy-big-models-72001ef9ab9e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-deploy-big-models-72001ef9ab9e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----72001ef9ab9e--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----72001ef9ab9e--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://8enmann.medium.com/?source=post_page-----72001ef9ab9e--------------------------------", "anchor_text": ""}, {"url": "https://8enmann.medium.com/?source=post_page-----72001ef9ab9e--------------------------------", "anchor_text": "Ben Mann"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F33ebef5d1079&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-deploy-big-models-72001ef9ab9e&user=Ben+Mann&userId=33ebef5d1079&source=post_page-33ebef5d1079----72001ef9ab9e---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F72001ef9ab9e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-deploy-big-models-72001ef9ab9e&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F72001ef9ab9e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-deploy-big-models-72001ef9ab9e&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://duet.li", "anchor_text": "deployed"}, {"url": "https://www.tensorflow.org/tfx/guide/serving", "anchor_text": "Tensorflow Serving"}, {"url": "https://medium.com/styria-data-science-tech-blog/running-pytorch-models-in-production-fa09bebca622", "anchor_text": "difficult"}, {"url": "https://github.com/JasonBenn/duet/blob/master/Dockerfile", "anchor_text": "docker container"}, {"url": "https://github.com/JasonBenn/duet/blob/master/app.yaml", "anchor_text": "boosted"}, {"url": "https://docs.pylonsproject.org/projects/waitress/en/stable/#", "anchor_text": "Waitress"}, {"url": "https://raw.githubusercontent.com/GoogleCloudPlatform/container-engine-accelerators/master/nvidia-driver-installer/ubuntu/daemonset-preloaded.yaml", "anchor_text": "https://raw.githubusercontent.com/GoogleCloudPlatform/container-engine-accelerators/master/nvidia-driver-installer/ubuntu/daemonset-preloaded.yaml"}, {"url": "https://github.com/JasonBenn/duet/blob/master/cloud.yaml", "anchor_text": "cloud.yaml"}, {"url": "https://medium.com/tag/docker?source=post_page-----72001ef9ab9e---------------docker-----------------", "anchor_text": "Docker"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----72001ef9ab9e---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----72001ef9ab9e---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/tag/devops?source=post_page-----72001ef9ab9e---------------devops-----------------", "anchor_text": "DevOps"}, {"url": "https://medium.com/tag/data-science?source=post_page-----72001ef9ab9e---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F72001ef9ab9e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-deploy-big-models-72001ef9ab9e&user=Ben+Mann&userId=33ebef5d1079&source=-----72001ef9ab9e---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F72001ef9ab9e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-deploy-big-models-72001ef9ab9e&user=Ben+Mann&userId=33ebef5d1079&source=-----72001ef9ab9e---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F72001ef9ab9e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-deploy-big-models-72001ef9ab9e&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----72001ef9ab9e--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F72001ef9ab9e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-deploy-big-models-72001ef9ab9e&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----72001ef9ab9e---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----72001ef9ab9e--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----72001ef9ab9e--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----72001ef9ab9e--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----72001ef9ab9e--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----72001ef9ab9e--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----72001ef9ab9e--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----72001ef9ab9e--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----72001ef9ab9e--------------------------------", "anchor_text": ""}, {"url": "https://8enmann.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://8enmann.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Ben Mann"}, {"url": "https://8enmann.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "950 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F33ebef5d1079&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-deploy-big-models-72001ef9ab9e&user=Ben+Mann&userId=33ebef5d1079&source=post_page-33ebef5d1079--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F869b10d3566e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-deploy-big-models-72001ef9ab9e&newsletterV3=33ebef5d1079&newsletterV3Id=869b10d3566e&user=Ben+Mann&userId=33ebef5d1079&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}