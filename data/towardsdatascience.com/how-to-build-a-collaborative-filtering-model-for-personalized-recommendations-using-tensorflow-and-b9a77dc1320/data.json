{"url": "https://towardsdatascience.com/how-to-build-a-collaborative-filtering-model-for-personalized-recommendations-using-tensorflow-and-b9a77dc1320", "time": 1682993314.48068, "path": "towardsdatascience.com/how-to-build-a-collaborative-filtering-model-for-personalized-recommendations-using-tensorflow-and-b9a77dc1320/", "webpage": {"metadata": {"title": "How to build a collaborative filtering model for personalized recommendations | by Lak Lakshmanan | Towards Data Science", "h1": "How to build a collaborative filtering model for personalized recommendations", "description": "April 2020 update: Note that a much simpler way to do this now exists. Read this article on building a recommendations model using BigQuery ML. In this article, I will step you through how to use\u2026"}, "outgoing_paragraph_urls": [{"url": "https://towardsdatascience.com/training-a-recommendation-model-for-google-analytics-data-using-bigquery-ml-2327f9a2e8e9", "anchor_text": "recommendations model using BigQuery ML", "paragraph_index": 0}, {"url": "https://cloud.google.com/solutions/machine-learning/recommendation-system-tensorflow-overview", "anchor_text": "read those solutions", "paragraph_index": 1}, {"url": "https://github.com/GoogleCloudPlatform/training-data-analyst/blob/master/courses/machine_learning/deepdive/10_recommend/wals_tft.ipynb", "anchor_text": "complete source code is on GitHub", "paragraph_index": 2}, {"url": "https://github.com/tensorflow/transform", "anchor_text": "TensorFlow Transform", "paragraph_index": 7}, {"url": "https://github.com/GoogleCloudPlatform/training-data-analyst/blob/master/courses/machine_learning/deepdive/10_recommend/wals_tft.ipynb", "anchor_text": "notebook in GitHub", "paragraph_index": 13}], "all_paragraphs": ["April 2020 update: Note that a much simpler way to do this now exists. Read this article on building a recommendations model using BigQuery ML.", "In this article, I will step you through how to use TensorFlow\u2019s Estimator API to build a WALS collaborative filtering model for product recommendations. Recently, my colleague Lukman Ramsey published a series of solutions detailing how to build a recommendation model \u2014 read those solutions for context on what recommendations are and how to set up an end-to-end system.", "In this article, I\u2019m replacing the use of Pandas in the original solution by Apache Beam \u2014 this will permit the solution to scale to larger datasets easier. Because the context exists in the solution, I\u2019ll simply dive into the technical details here. The complete source code is on GitHub.", "For collaborative filtering, we don\u2019t need to know any attributes about either the users or the content. Essentially, all we need to know is userId, itemId, and rating that the particular user gave the particular item. In this case, we can use the time-spent on the page as a proxy for rating. Google Analytics 360 exports web traffic information to BigQuery, and it is from BigQuery that I extract the data:", "The query itself is specific to the way that the newspaper had set up Google Analytics \u2014 specifically, the way they had set up custom dimensions \u2014 you might have to use a different query to extract your data into something that resembles this table:", "This is the raw dataset that is needed to do collaborative filtering. Obviously, what you will use for visitorId, contentId and ratings will be dependent on your problem. Beyond this, everything else is quite standard and you should be able to use it as-is.", "The WALS algorithm requires that user ids and item ids be enumerated, i.e., they should simply be the row number and column number in an interactions matrix. So, we need to take the visitorId above, which is a string, and map them to 0, 1, 2, \u2026. We need to do the same thing for item ids. Additionally, the rating has to be small numbers, typically 0\u20131. So, we\u2019ll have to scale the session_duration.", "To do this mapping, we will use TensorFlow Transform (TFT) \u2014 this is a library that allows you to create preprocessed datasets using Apache Beam for training and then turn around apply that preprocessing as part of your TensorFlow graph during inference!", "Here\u2019s the crux of my preprocessing function using TFT:", "The result of preprocessing a row from BigQuery consisting of visitorId, contentId and session_duration is a Python dictionary called result that contains three columns: userId, itemId and rating.", "tft.string_to_int looks through the entire training dataset and creates a mapping to enumerate the visitors and writes the mapping (\u201cthe vocabulary\u201d) to the file vocab_users. I do the same thing for the contentId, creating the itemId. The rating is obtained by scaling the session_duration to lie within 0\u20131. My scaling essentially clips off the long-tail of extremely long session durations which probably represent people who close their laptops while on a newspaper article. The key thing to note is that I do such clipping using pure TensorFlow functions like tf.less and tf.ones. This is important because this preprocessing function has to be applied during inference (prediction) as part of the TensorFlow serving graph.", "The preprocess function is applied to the training dataset using Apache Beam:", "The training set for WALS consists of two files \u2014 one provides all the items rated by a specific user (the interaction matrix row-wise) and the other provides all the users who have rated a specific item (the interaction matrix column-wise). Obviously, the two files contain the same data, but it is necessary to split the dataset so that they can be processed in parallel. We can do this also in the same Apache Beam pipeline where we did the enumeration:", "We can then execute the Apache Beam pipeline on Cloud Dataflow. This is a fully managed service, so we don\u2019t have to muck around with setting up infrastructure and installing software (see the notebook in GitHub for full code).", "At this point, we\u2019ll have the following files:", "There is an Estimator API-based WALS implementation in TensorFlow. We use it the way we use any other Estimator \u2014 see the functions read_dataset() and train_and_evaluate() in the GitHub repo.", "The more interesting thing is how we use the trained estimator for batch prediction. For a particular user, we want to find the top K items. That can be done in TensorFlow using:", "Batch prediction involves calling the above function for every user, but making sure that when we write out the output, we write out the string visitorId and not the number userId (and similarly for the contentId/userId):", "To do the training and batch prediction, we can run the TensorFlow model on Cloud ML Engine, again without mucking around with any infrastructure:", "It\u2019s kind of ugly to have to hardcode nitems and nusers like this. So, we can go back to our Beam pipeline and have it write out nitems and nusers also to files, and then simply do a \u201cgsutil cat\u201d to get the appropriate values \u2014 the full code on GitHub does this.", "Here is an example of what the output looks like:", "Essentially, you get 3 items for each visitorId.", "While doing product recommendations is the key use case for WALS, another use case is to find low-dimensionality ways of representing products and users, for example, to do product or customer segmentation by clustering the item factors and column factors. So, we implement a serving function to provide back these to callers (again, see GitHub for full code):", "Note that this article is only about replacing the machine learning training and batch prediction parts of the original solution. The original solution also explains how to do orchestration and filtering. Where do they fit in?", "At this point, we now have a BigQuery query, a Beam/Dataflow pipeline and potentially an AppEngine application (see below). How do you run them periodically one after the other? Use Apache Airflow as suggested in the solution for doing this orchestration.", "If you are recommending chocolates to customers, then it is okay to recommend a chocolate they have already tried, but if you are recommending newspaper articles to users, then it is important that you refrain from recommending articles they have already read.", "My batch prediction code, unlike the original solution, does not filter out articles that the user has already read. If it is important that the recommendations not include already read/purchased items, then there are two ways you can do it.", "The simpler method is to zero out the entries corresponding to already read items (here, items with a rating < 0.01) before finding the top_k:", "The problem with this is lag \u2014 you may not recommend items that the user read yesterday (because it is in your training dataset), but the batch prediction code does have access to the stream of read articles in real-time, so you will be recommending articles they read a few minutes ago.", "If this lag is an issue that you want to avoid, then you should make the k in the batch prediction much higher (so that, for example, you are getting 20 articles from the recommender even if you are going to recommend only 5 of them) and then do a second-level of filtering in AppEngine, as suggested in the original solution.", "You now have batch prediction, online prediction and training, all without setting up any cluster! Plus, TensorFlow Transform has allowed us to simplify computation of metadata and mapping of items/users to fit the WALS paradigm.", "Thanks to my colleagues Lukman Ramsey and Yiliang Zhao for helpful comments and suggestions on this article.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "articles are personal observations and not investment advice."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fb9a77dc1320&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-build-a-collaborative-filtering-model-for-personalized-recommendations-using-tensorflow-and-b9a77dc1320&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-build-a-collaborative-filtering-model-for-personalized-recommendations-using-tensorflow-and-b9a77dc1320&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-build-a-collaborative-filtering-model-for-personalized-recommendations-using-tensorflow-and-b9a77dc1320&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-build-a-collaborative-filtering-model-for-personalized-recommendations-using-tensorflow-and-b9a77dc1320&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----b9a77dc1320--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----b9a77dc1320--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://lakshmanok.medium.com/?source=post_page-----b9a77dc1320--------------------------------", "anchor_text": ""}, {"url": "https://lakshmanok.medium.com/?source=post_page-----b9a77dc1320--------------------------------", "anchor_text": "Lak Lakshmanan"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F247b0630b5d6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-build-a-collaborative-filtering-model-for-personalized-recommendations-using-tensorflow-and-b9a77dc1320&user=Lak+Lakshmanan&userId=247b0630b5d6&source=post_page-247b0630b5d6----b9a77dc1320---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fb9a77dc1320&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-build-a-collaborative-filtering-model-for-personalized-recommendations-using-tensorflow-and-b9a77dc1320&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fb9a77dc1320&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-build-a-collaborative-filtering-model-for-personalized-recommendations-using-tensorflow-and-b9a77dc1320&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://towardsdatascience.com/training-a-recommendation-model-for-google-analytics-data-using-bigquery-ml-2327f9a2e8e9", "anchor_text": "recommendations model using BigQuery ML"}, {"url": "https://cloud.google.com/solutions/machine-learning/recommendation-system-tensorflow-overview", "anchor_text": "read those solutions"}, {"url": "https://github.com/GoogleCloudPlatform/training-data-analyst/blob/master/courses/machine_learning/deepdive/10_recommend/wals_tft.ipynb", "anchor_text": "complete source code is on GitHub"}, {"url": "https://github.com/tensorflow/transform", "anchor_text": "TensorFlow Transform"}, {"url": "https://github.com/GoogleCloudPlatform/training-data-analyst/blob/master/courses/machine_learning/deepdive/10_recommend/wals_tft.ipynb", "anchor_text": "notebook in GitHub"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----b9a77dc1320---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/tensorflow?source=post_page-----b9a77dc1320---------------tensorflow-----------------", "anchor_text": "TensorFlow"}, {"url": "https://medium.com/tag/recommender-systems?source=post_page-----b9a77dc1320---------------recommender_systems-----------------", "anchor_text": "Recommender Systems"}, {"url": "https://medium.com/tag/recommendation-system?source=post_page-----b9a77dc1320---------------recommendation_system-----------------", "anchor_text": "Recommendation System"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fb9a77dc1320&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-build-a-collaborative-filtering-model-for-personalized-recommendations-using-tensorflow-and-b9a77dc1320&user=Lak+Lakshmanan&userId=247b0630b5d6&source=-----b9a77dc1320---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fb9a77dc1320&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-build-a-collaborative-filtering-model-for-personalized-recommendations-using-tensorflow-and-b9a77dc1320&user=Lak+Lakshmanan&userId=247b0630b5d6&source=-----b9a77dc1320---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fb9a77dc1320&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-build-a-collaborative-filtering-model-for-personalized-recommendations-using-tensorflow-and-b9a77dc1320&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----b9a77dc1320--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fb9a77dc1320&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-build-a-collaborative-filtering-model-for-personalized-recommendations-using-tensorflow-and-b9a77dc1320&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----b9a77dc1320---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----b9a77dc1320--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----b9a77dc1320--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----b9a77dc1320--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----b9a77dc1320--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----b9a77dc1320--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----b9a77dc1320--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----b9a77dc1320--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----b9a77dc1320--------------------------------", "anchor_text": ""}, {"url": "https://lakshmanok.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://lakshmanok.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Lak Lakshmanan"}, {"url": "https://lakshmanok.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "9.3K Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F247b0630b5d6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-build-a-collaborative-filtering-model-for-personalized-recommendations-using-tensorflow-and-b9a77dc1320&user=Lak+Lakshmanan&userId=247b0630b5d6&source=post_page-247b0630b5d6--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F44e3f26acd1a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-build-a-collaborative-filtering-model-for-personalized-recommendations-using-tensorflow-and-b9a77dc1320&newsletterV3=247b0630b5d6&newsletterV3Id=44e3f26acd1a&user=Lak+Lakshmanan&userId=247b0630b5d6&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}