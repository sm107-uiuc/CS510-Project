{"url": "https://towardsdatascience.com/heres-how-flink-stores-your-state-7b37fbb60e1a", "time": 1683000575.4612339, "path": "towardsdatascience.com/heres-how-flink-stores-your-state-7b37fbb60e1a/", "webpage": {"metadata": {"title": "Here\u2019s How Apache Flink Stores Your State data | by Kartik Khare | Towards Data Science", "h1": "Here\u2019s How Apache Flink Stores Your State data", "description": "If you have every wondered, what happens once you update a value in your Flink state, here\u2019s the answer. A low-level view of Flink\u2019s High level state APIs."}, "outgoing_paragraph_urls": [{"url": "https://rocksdb.org/", "anchor_text": "RocksDB by Facebook", "paragraph_index": 10}, {"url": "https://github.com/google/leveldb", "anchor_text": "LevelDB by Google", "paragraph_index": 10}], "all_paragraphs": ["One of the significant features of Apache Flink is its ability to do stateful processing. The API to store and retrieve state data is simple which makes it a joy to use.", "However, behind that API lies a system to manage your data while providing persistence guarantees and that\u2019s what we\u2019ll be understanding in this article.", "We\u2019ll be looking at 3 parts of the State Management \u2014", "Let\u2019s first look at where the state is actually stored.", "Flink provides three backend storage for your state out of the box. These are", "This storage persists the data in the memory of each task manager\u2019s Heap. Hence, this makes it extremely fast in access. In spite of this performance, this state should never be used in production jobs. That\u2019s because the state creates a backup of the data (also known as checkpointing) in the job manager memory which puts unnecessary pressure on the job manager's operational stability.", "Another limitation of this backend that the total state size of a task can\u2019t exceed 10MB. It can be configured to a higher limit but is not advised by the authors due to performance consideration.", "This is the default backend used by Flink in case nothing is configured.", "This backend is similar to Memory state backend except for the fact that it stores the backup on the filesystem rather than job manager memory. The filesystem can be task manager's local filesystem or a durable store such as HDFS/S3.", "This state is also limited by the heap memory and hence should be used for cases when you have fewer data and require high performance.", "This backend uses RocksDB by Facebook to store the data. If you are not aware of RocksDB, it\u2019s an embeddable key-value store which offers ACID guarantees. It is based on LevelDB by Google but offers much better write performance.", "Flink chose to use RocksDB instead of some of the most popular embeddable storage such as SQLlite because of its high write performance which comes from the LSM architecture based design. Since RocksDB also maintains an in-memory table (also known as mem-table) along with bloom filters, reading recent data also is extremely fast.", "Each task manager maintains its own Rocks DB file and the backup of this state is checkpointed to a durable store such as HDFS.", "This is the only backend which offers support for incremental checkpointing i.e. taking a backup of only modified data rather than complete data.", "If your applications require a large state to store, this should be your choice. However, since it requires disk access and serialization/deserialization, it is comparatively slower than the rest of the backends.", "Let\u2019s look at how the data is actually stored once you create a state in your application.", "The storage format differs according to the backend. However, the common part is both the key and the value of the state are stored in byte arrays created using Flink\u2019s own Type serializers.", "We\u2019ll be using RocksDB backend for demonstration.", "Each task manager has multiple RocksDB folders with each folder a database in itself. Each database contains multiple column families defined by the name given in the state descriptors.", "Each column family contain key-value pairs where the key is the operator\u2019s key and value is the state\u2019s data.", "As an example. let\u2019s look at the state of this example job", "This job contains two stateful functions which are defined as", "If you run this job and set Rocksdb as state backend in the flink-conf.yml file, following directories, get generated on every task manager.", "Here\u2019s how the directory names are defined", "The names are composed of 3 parts", "3. UUID: This is just a random UUID generated while creating the directories.", "Each of these directories contains an instance of RocksDB. The file structure of RocksDB will be", "The .sst files are the SSTable files of the Rocksdb which contain the actual data. LOG file contains the commit log.MANIFEST contains metadata such as column families.OPTIONS contain the configuration used to create RocksDB instance.", "Let\u2019s open this DB using RocksDB java API. We\u2019ll take a look at the StatefulMapTest functions directory.", "The following code prints all the column family names which are present in the DB. The output of the above piece of code turns out to be", "We can also print all the key-value pairs inside each column family. This can be done using below piece of code", "TestInputView here is just Flink specific construct which is used to read Byte Array data streams.", "Flink provides persistence for your application state using a mechanism called Checkpointing. It takes a snapshot of the state on periodic intervals and then stores it in a durable store such as HDFS/S3. This allows the Flink application to resume from this backup in case of failures.", "Checkpointing is disabled by default for a Flink job. To enable it, you can add the following piece of code to your application", "This will configure your application to take a snapshot of your state every 60 seconds and put it to job manager/HDFS/S3 for future recovery. In case of HDFS/S3, the directory used to store the checkpoint can be configured with state.checkpoints.dir in flink-conf.yml.", "The final directory structure of a checkpoint looks like", "JOB_ID is your application\u2019s unique ID and checkpoint ID is auto-incremental numeric id.", "To restore the state from checkpoint at the start of the application, simply run", "You can extend your stateful functions with Checkpointed Function which provide the ability to modify the state upon initialization and taking the snapshot. The previous StatefulProcess function can be extended to use this interface.", "This completes our deep dive into Flink state and now you can be sure that your state is well preserved by the application.", "If you want to get started with State processing Apache Flink, these are some useful links to the official docs -", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Software Engineer @StarTree | Previously @WalmartLabs, @Olacabs | Committer @ApachePinot"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F7b37fbb60e1a&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fheres-how-flink-stores-your-state-7b37fbb60e1a&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fheres-how-flink-stores-your-state-7b37fbb60e1a&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fheres-how-flink-stores-your-state-7b37fbb60e1a&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fheres-how-flink-stores-your-state-7b37fbb60e1a&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----7b37fbb60e1a--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----7b37fbb60e1a--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@kharekartik?source=post_page-----7b37fbb60e1a--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@kharekartik?source=post_page-----7b37fbb60e1a--------------------------------", "anchor_text": "Kartik Khare"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F2c9d8b2edb6e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fheres-how-flink-stores-your-state-7b37fbb60e1a&user=Kartik+Khare&userId=2c9d8b2edb6e&source=post_page-2c9d8b2edb6e----7b37fbb60e1a---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F7b37fbb60e1a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fheres-how-flink-stores-your-state-7b37fbb60e1a&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F7b37fbb60e1a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fheres-how-flink-stores-your-state-7b37fbb60e1a&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@samuelzeller?utm_source=medium&utm_medium=referral", "anchor_text": "Samuel Zeller"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://rocksdb.org/", "anchor_text": "RocksDB by Facebook"}, {"url": "https://github.com/google/leveldb", "anchor_text": "LevelDB by Google"}, {"url": "https://ci.apache.org/projects/flink/flink-docs-stable/dev/stream/state/state.html", "anchor_text": "Working with State"}, {"url": "https://ci.apache.org/projects/flink/flink-docs-release-1.9/ops/state/state_backends.html", "anchor_text": "State Backends"}, {"url": "https://ci.apache.org/projects/flink/flink-docs-release-1.9/dev/libs/state_processor_api.html", "anchor_text": "State Processor API"}, {"url": "https://medium.com/tag/big-data?source=post_page-----7b37fbb60e1a---------------big_data-----------------", "anchor_text": "Big Data"}, {"url": "https://medium.com/tag/analytics?source=post_page-----7b37fbb60e1a---------------analytics-----------------", "anchor_text": "Analytics"}, {"url": "https://medium.com/tag/data-engineering?source=post_page-----7b37fbb60e1a---------------data_engineering-----------------", "anchor_text": "Data Engineering"}, {"url": "https://medium.com/tag/programming?source=post_page-----7b37fbb60e1a---------------programming-----------------", "anchor_text": "Programming"}, {"url": "https://medium.com/tag/software-development?source=post_page-----7b37fbb60e1a---------------software_development-----------------", "anchor_text": "Software Development"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F7b37fbb60e1a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fheres-how-flink-stores-your-state-7b37fbb60e1a&user=Kartik+Khare&userId=2c9d8b2edb6e&source=-----7b37fbb60e1a---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F7b37fbb60e1a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fheres-how-flink-stores-your-state-7b37fbb60e1a&user=Kartik+Khare&userId=2c9d8b2edb6e&source=-----7b37fbb60e1a---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F7b37fbb60e1a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fheres-how-flink-stores-your-state-7b37fbb60e1a&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----7b37fbb60e1a--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F7b37fbb60e1a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fheres-how-flink-stores-your-state-7b37fbb60e1a&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----7b37fbb60e1a---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----7b37fbb60e1a--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----7b37fbb60e1a--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----7b37fbb60e1a--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----7b37fbb60e1a--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----7b37fbb60e1a--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----7b37fbb60e1a--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----7b37fbb60e1a--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----7b37fbb60e1a--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@kharekartik?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@kharekartik?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Kartik Khare"}, {"url": "https://medium.com/@kharekartik/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "1K Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F2c9d8b2edb6e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fheres-how-flink-stores-your-state-7b37fbb60e1a&user=Kartik+Khare&userId=2c9d8b2edb6e&source=post_page-2c9d8b2edb6e--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fc2535e6ef270&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fheres-how-flink-stores-your-state-7b37fbb60e1a&newsletterV3=2c9d8b2edb6e&newsletterV3Id=c2535e6ef270&user=Kartik+Khare&userId=2c9d8b2edb6e&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}