{"url": "https://towardsdatascience.com/create-reusable-ml-modules-with-mlflow-projects-docker-33cd722c93c4", "time": 1683009268.731572, "path": "towardsdatascience.com/create-reusable-ml-modules-with-mlflow-projects-docker-33cd722c93c4/", "webpage": {"metadata": {"title": "Create Reusable ML Modules with MLflow Projects & Docker | by George Novack | Towards Data Science", "h1": "Create Reusable ML Modules with MLflow Projects & Docker", "description": "How to build a reusable Machine Learning module with MLflow Projects and Docker"}, "outgoing_paragraph_urls": [{"url": "https://mlflow.org/", "anchor_text": "MLflow", "paragraph_index": 3}, {"url": "http://mmlab.ie.cuhk.edu.hk/projects/CelebA.html", "anchor_text": "CelebA", "paragraph_index": 4}, {"url": "https://www.python.org/downloads/", "anchor_text": "Python 3", "paragraph_index": 5}, {"url": "https://www.docker.com/get-started", "anchor_text": "Docker", "paragraph_index": 5}, {"url": "https://www.tensorflow.org/datasets", "anchor_text": "TensorFlow Datasets", "paragraph_index": 7}, {"url": "https://mlflow.org/docs/latest/projects.html#project-environments", "anchor_text": "Conda, Docker Container, or Local system", "paragraph_index": 11}, {"url": "https://github.com/gnovack/celeb-cnn-project", "anchor_text": "https://github.com/gnovack/celeb-cnn-project", "paragraph_index": 25}, {"url": "http://localhost:5000/", "anchor_text": "http://localhost:5000/", "paragraph_index": 27}], "all_paragraphs": ["Let\u2019s face it, getting a Machine Learning model into production isn\u2019t easy. From pulling together data from disparate sources to tuning hyperparameters and evaluating model performance, there are so many different steps from sandbox to production that, if we\u2019re not careful, can and will end up scattered across a number of interdependent notebooks or scripts that all must be run in the correct order to recreate the model. And to make matters worse, as we iterate and evaluate new versions of our model, it\u2019s easy to neglect to document each combination of hyperparameters and each resulting metric, so that we often lose track of the lessons learned during the iterative model building process.", "And remember those notebooks that we strung together to produce version 1 of the model? Well, by the time we\u2019re finished building version 2, those notebooks have been tweaked and altered so much that we\u2019d be hopeless to recreate version 1 if we ever needed to.", "In this article, I\u2019ll show how you can use MLflow and Docker to create ML Projects that are modular, reusable, and that allows you to easily recreate old versions of your model and tune parameters to build and evaluate new ones.", "MLflow is an open-source suite of tools that help manage the ML model development lifecycle from early experimentation and discovery, all the way to registering the model in a central repository and deploying it as a REST endpoint to perform real-time inference. We won\u2019t be covering the model registry or model deployment tools in this article. Our focus will be on MLflow Tracking, which allows us to evaluate and record model results as we quickly iterate through different versions of the model, and MLflow Projects, which we will use to package our model development workflow into a reusable, parameterized module.", "In this article, we\u2019ll use TensorFlow and the CelebA dataset to build a basic Convolutional Neural Network to predict whether or not the subject of a given image is smiling or not. We\u2019ll create a Docker image that will act as our training environment and will contain all the dependencies required to train the model. Next, we\u2019ll package the model training code as an MLflow Project, and finally, we\u2019ll create a simple driver program that will kick off multiple runs of the Project asynchronously using different hyperparameter values.", "In order to follow along, you\u2019ll need Python 3, Docker, and MLflow installed locally. You can install MLflow using pip", "Since our focus is on MLflow, I won\u2019t go into great detail on the actual model, but I will briefly go over some code examples and include links to a working end-to-end project at the end of this article.", "The first order of business is to load the CelebA dataset. We\u2019ll do this using TensorFlow Datasets.", "The dataset loaded from tfds doesn\u2019t contain explicit target values. Each record is just an image and a set of attributes about the image (e.g. whether or not the person in the image is smiling, is wearing a hat, has a mustache, etc.), so the data_generator() function is used to format the data in a way that can be passed into a model. The function returns a generator that yields each record as a tuple of the following format:", "We\u2019ll create the training and validation datasets for the model by using tf.data.from_generator and passing in the data_generator() function.", "Next, we\u2019ll build and train a CNN using the training and validation datasets.", "MLflow Projects allows you to define environments in three different ways: Conda, Docker Container, or Local system. We\u2019ll be using a Docker Container for our project environment.", "Here\u2019s the Dockerfile for our simple project environment:", "The requirements.txt file contains the packages needed to run the project: mlflow, tensorflow, and tensorflow-datasets. And the load_data.py script simply loads the CelebA dataset from TensorFlow and stores the results in the /app/data directory.", "Note: In a real-world scenario, you would probably not store the training/validation data along with the project environment. Instead, your environment would just include the configuration and libraries needed to access the data wherever it is stored (e.g. an on-prem database or a cloud storage account). I\u2019m only doing this here to avoid downloading the dataset from TensorFlow every time the project is run.", "We\u2019ll now package the model training code from earlier into an MLflow Project. An MLflow Project is simply a directory with an MLproject file that defines a few things about the project:", "The first step is to create an MLproject file. It is in this file that we reference the Docker image that will be used as the project environment. We\u2019ll also define any parameters that can be passed into the project.", "As you can see, our project will use the gnovack/celebs-cnn image as the project environment (this is the Docker image created in the previous section) and will accept a number of parameters: the batch size, number of epochs, number of convolution layers, number of training and validation samples, and a boolean indicating whether or not to perform some random transformations on the input images during training.", "Next, we\u2019ll modify the model training code to use the parameters passed in and to log training progress using MLflow Tracking. We\u2019ll discuss MLflow Tracking shortly, but for now just know it consists of a Tracking Server, which tracks parameters and metrics during model training runs (which MLflow calls Experiment runs), and a GUI that allows us to view all of our runs and visualize the performance metrics of each run.", "We can access the project input parameters using argparse like we would with any command-line arguments.", "Then we can use these parameters to construct the CNN dynamically. We\u2019ll also wrap the model training in an MLflow run using mlflow.start_run()to tell MLflow to track our model training as an MLflow Experiment run.", "A few notes about the above code:", "With our Docker environment defined and our MLflow project created, we can now write a driver program to execute a few runs of the project asynchronously, allowing us to evaluate different combinations of hyperparameters and neural network architectures.", "Before running the project, we\u2019ll need to start the MLflow tracking server. For this example, we\u2019ll just use your local machine as the tracking server, but in an environment where you are working on a team of engineers and/or data scientists, you would probably want to stand up a shared tracking server that\u2019s always running for all team members to share. Some cloud services like Databricks and Azure Machine Learning even have a built-in MLflow tracking server.", "To run a local tracking server and open the MLflow GUI, run the following command:", "We\u2019ll use the mlflow.projects.run() method with a link to the MLflow project in Github, https://github.com/gnovack/celeb-cnn-project, to run the project (you could also use a relative file path to a local directory containing the MLflow Project). The driver script runs the project three times asynchronously with different parameters.", "We specify synchronous=False so that we can execute all three runs in parallel, and backend='local' indicates that the project will execute on your local machine. MLflow also supports executing Projects on Databricks, or on a Kubernetes cluster.", "After executing the driver program, go to http://localhost:5000/ to see the three active runs in the MLflow tracking UI.", "By drilling into each run you can view model performance metrics, which, thanks to the MLFlowCallback we created, are updated after each training epoch, allowing us to plot these metrics over time while our model is still being trained.", "As you can see from the accuracy numbers, our model isn\u2019t going to win any awards after just a few epochs of training with a small set of data, but you can start to see trends in the performance of the different models (e.g. the top model, which used no convolution layers, seems to be overfitting the data, as the training accuracy is rising steadily while the validation accuracy is remaining fairly static). Once each run finishes, it will output the trained model object as an artifact that can be downloaded from the tracking server, which means that, with MLflow Tracking, we not only have access to the parameters and metrics of historical training runs, but we have access to the trained models as well.", "When working with more complex models and larger sets of training data, the training process can easily take several hours or days to complete, so being able to view these metrics in real-time allows us to determine which combinations of parameters might or might not yield production-quality models, and gives us the opportunity to stop runs once we start seeing trends like overfitting in the performance metrics.", "In this article, we\u2019ve seen how we can use MLflow projects to package the development and training of machine learning models into an encapsulated and reusable module, allowing us to train several versions of the model in parallel and compare their performance in real-time during training. MLflow also gives us the ability to keep track of the parameters, metrics, and models associated with each historical project run, which means that we can easily reproduce any previous version of the model if needed. It\u2019s also worth noting that although we used TensorFlow exclusively in this article, MLflow Tracking and MLflow Projects work with all the major ML frameworks.", "Thanks for reading! I\u2019ll leave links to repositories containing the end-to-end project described in this article, as well as a few helpful documents I referenced while working on this. Feel free to reach out with any questions or comments.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F33cd722c93c4&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcreate-reusable-ml-modules-with-mlflow-projects-docker-33cd722c93c4&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcreate-reusable-ml-modules-with-mlflow-projects-docker-33cd722c93c4&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcreate-reusable-ml-modules-with-mlflow-projects-docker-33cd722c93c4&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcreate-reusable-ml-modules-with-mlflow-projects-docker-33cd722c93c4&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----33cd722c93c4--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----33cd722c93c4--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://gnovack.medium.com/?source=post_page-----33cd722c93c4--------------------------------", "anchor_text": ""}, {"url": "https://gnovack.medium.com/?source=post_page-----33cd722c93c4--------------------------------", "anchor_text": "George Novack"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F76cce7566b5e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcreate-reusable-ml-modules-with-mlflow-projects-docker-33cd722c93c4&user=George+Novack&userId=76cce7566b5e&source=post_page-76cce7566b5e----33cd722c93c4---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F33cd722c93c4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcreate-reusable-ml-modules-with-mlflow-projects-docker-33cd722c93c4&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F33cd722c93c4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcreate-reusable-ml-modules-with-mlflow-projects-docker-33cd722c93c4&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://mlflow.org/", "anchor_text": "MLflow"}, {"url": "http://mmlab.ie.cuhk.edu.hk/projects/CelebA.html", "anchor_text": "CelebA"}, {"url": "https://www.python.org/downloads/", "anchor_text": "Python 3"}, {"url": "https://www.docker.com/get-started", "anchor_text": "Docker"}, {"url": "https://www.tensorflow.org/datasets", "anchor_text": "TensorFlow Datasets"}, {"url": "https://mlflow.org/docs/latest/projects.html#project-environments", "anchor_text": "Conda, Docker Container, or Local system"}, {"url": "https://mlflow.org/docs/latest/tracking.html#automatic-logging", "anchor_text": "https://mlflow.org/docs/latest/tracking.html#automatic-logging"}, {"url": "https://github.com/gnovack/celeb-cnn-project", "anchor_text": "https://github.com/gnovack/celeb-cnn-project"}, {"url": "http://localhost:5000/", "anchor_text": "http://localhost:5000/"}, {"url": "https://github.com/gnovack/celeb-cnn-base-image", "anchor_text": "https://github.com/gnovack/celeb-cnn-base-image"}, {"url": "https://hub.docker.com/repository/docker/gnovack/celebs-cnn", "anchor_text": "https://hub.docker.com/repository/docker/gnovack/celebs-cnn"}, {"url": "https://github.com/gnovack/celeb-cnn-project", "anchor_text": "https://github.com/gnovack/celeb-cnn-project"}, {"url": "https://github.com/gnovack/celeb-cnn-driver", "anchor_text": "https://github.com/gnovack/celeb-cnn-driver"}, {"url": "https://mlflow.org/docs/latest/projects.html#", "anchor_text": "https://mlflow.org/docs/latest/projects.html#"}, {"url": "https://mlflow.org/docs/latest/tracking.html#tensorflow-and-keras-experimental", "anchor_text": "https://mlflow.org/docs/latest/tracking.html#tensorflow-and-keras-experimental"}, {"url": "https://www.tensorflow.org/datasets/catalog/celeb_a", "anchor_text": "https://www.tensorflow.org/datasets/catalog/celeb_a"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/data/Dataset?hl=en", "anchor_text": "https://www.tensorflow.org/api_docs/python/tf/data/Dataset?hl=en"}, {"url": "https://medium.com/tag/mlflow?source=post_page-----33cd722c93c4---------------mlflow-----------------", "anchor_text": "Mlflow"}, {"url": "https://medium.com/tag/tensorflow?source=post_page-----33cd722c93c4---------------tensorflow-----------------", "anchor_text": "TensorFlow"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----33cd722c93c4---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/ml-engineering?source=post_page-----33cd722c93c4---------------ml_engineering-----------------", "anchor_text": "ML Engineering"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F33cd722c93c4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcreate-reusable-ml-modules-with-mlflow-projects-docker-33cd722c93c4&user=George+Novack&userId=76cce7566b5e&source=-----33cd722c93c4---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F33cd722c93c4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcreate-reusable-ml-modules-with-mlflow-projects-docker-33cd722c93c4&user=George+Novack&userId=76cce7566b5e&source=-----33cd722c93c4---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F33cd722c93c4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcreate-reusable-ml-modules-with-mlflow-projects-docker-33cd722c93c4&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----33cd722c93c4--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F33cd722c93c4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcreate-reusable-ml-modules-with-mlflow-projects-docker-33cd722c93c4&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----33cd722c93c4---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----33cd722c93c4--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----33cd722c93c4--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----33cd722c93c4--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----33cd722c93c4--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----33cd722c93c4--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----33cd722c93c4--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----33cd722c93c4--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----33cd722c93c4--------------------------------", "anchor_text": ""}, {"url": "https://gnovack.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://gnovack.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "George Novack"}, {"url": "https://gnovack.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "136 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F76cce7566b5e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcreate-reusable-ml-modules-with-mlflow-projects-docker-33cd722c93c4&user=George+Novack&userId=76cce7566b5e&source=post_page-76cce7566b5e--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fc5cf182bbc89&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fcreate-reusable-ml-modules-with-mlflow-projects-docker-33cd722c93c4&newsletterV3=76cce7566b5e&newsletterV3Id=c5cf182bbc89&user=George+Novack&userId=76cce7566b5e&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}