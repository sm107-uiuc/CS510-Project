{"url": "https://towardsdatascience.com/from-scripts-to-prediction-api-2372c95fb7c7", "time": 1683012543.754452, "path": "towardsdatascience.com/from-scripts-to-prediction-api-2372c95fb7c7/", "webpage": {"metadata": {"title": "From Scripts To Prediction API. submission.csv? No thanks! | by Geoffrey Hung | Towards Data Science", "h1": "From Scripts To Prediction API", "description": "Last time we discussed how to convert Jupyter Notebook to scripts, together with all sorts of basic engineering practices such as CI, unit testing, package environment, configuration, logging, etc\u2026"}, "outgoing_paragraph_urls": [{"url": "https://fastapi.tiangolo.com/", "anchor_text": "FastAPI", "paragraph_index": 4}, {"url": "https://www.fast.ai/", "anchor_text": "fast.ai", "paragraph_index": 4}, {"url": "https://fastapi.tiangolo.com/history-design-future/", "anchor_text": "this article", "paragraph_index": 6}, {"url": "https://github.com/G-Hung/model-productization_article", "anchor_text": "one repo", "paragraph_index": 7}, {"url": "https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods", "anchor_text": "HTTP request methods", "paragraph_index": 23}, {"url": "https://www.postman.com/", "anchor_text": "Postman", "paragraph_index": 26}, {"url": "https://github.com/G-Hung/model-productization_article/blob/master/notebook/prediction_API_test.ipynb", "anchor_text": "this Notebook", "paragraph_index": 27}, {"url": "http://127.0.0.1:8000/docs#/", "anchor_text": "http://127.0.0.1:8000/docs#/", "paragraph_index": 31}, {"url": "https://medium.com/@keeper6928/how-to-unit-test-machine-learning-code-57cf6fd81765", "anchor_text": "How to unit test machine learning code", "paragraph_index": 36}, {"url": "https://docs.cortex.dev/", "anchor_text": "Cortex", "paragraph_index": 53}, {"url": "https://towardsdatascience.com/why-we-switched-from-flask-to-fastapi-for-production-machine-learning-765aab9b3679", "anchor_text": "use FastAPI", "paragraph_index": 53}, {"url": "https://github.com/G-Hung/model-productization_article", "anchor_text": "repo", "paragraph_index": 57}, {"url": "https://www.linkedin.com/in/geoffreyhung/", "anchor_text": "my LinkedIn", "paragraph_index": 58}], "all_paragraphs": ["This is the continuation of my previous article:", "Last time we discussed how to convert Jupyter Notebook to scripts, together with all sorts of basic engineering practices such as CI, unit testing, package environment, configuration, logging, etc", "Even with the script form, it still requires us to change the configuration and run the script, It is OK for Kaggle competitions because all you need is just the submission.csv, but you probably don\u2019t want to sit behind the computer 24/7 and hit Run whenever users send you a prediction request \ud83d\ude41", "In this article, we will discuss how to utilize the models we have built last time and create prediction APIs to do model serving using FastAPI!", "For ML/DL folks, we are talking about FastAPI, NOT fast.ai !!!", "There are many frameworks in Python ecosystem for API, my original thought was to use Flask. But I am impressed by how simple and intuitive [and fast as the name suggests] FastAPI is and love to try it out in this mini-project!", "\u201cRome wasn\u2019t built in a day\u201d, FastAPI has learned a lot from the previous frameworks such as Django, Flask, APIStar, I cannot explain better than the creator himself and this article is great!", "Things are all in one repo which is probably not a good practice, it should be different GitHub repo in the real use case, maybe I will refactor [professional way to say \u201cclean my previous sxxt\u201d] later!", "*CS folks always say single responsibility principle, instead of saying \u201cdon\u2019t put code with different functionalities together\u201d, next time maybe you can say \u201cwe should follow single responsibility principle for this!\u201d", "First of all, let\u2019s update requirements.txt with the new packages, as we mentioned last time, we should specify the exact version such that others can reproduce the work!", "After this, we need to install requirements.txt again in the conda env [because we have new packages]", "Let\u2019s think about what is happening, we want to have API endpoint to do prediction, to be specific if users give us the input, we need to use the model to predict and return prediction.", "Instead of having us [human] handle the incoming request, we just create an API server to wait for the requests, parse the inputs, do prediction, and return results. API is just the structural way to talk to our computer and ask for the service [prediction in this case]", "This is good for the happy flow! But we should NEVER trust the user, just ask yourself, will you ever read the user manual in your daily life?", "This is fatal to our API because our model doesn\u2019t know how to respond to this. We need to introduce some input structures to protect us! Therefore, we should update our pseudocode!", "Looks good to me now! Let\u2019s translate them using FastAPI part by part!", "It seems many lines but things are the same, as you can guess, we define a class called `Sample` which defines every predictor as float and greater than [gt] zero!", "Then we load the trained model, hmmm what is `Predictor`? it is just a custom class that wraps the model with different methods so we can call a method instead of implementing the logic in API server", "Then we create the API using FastAPI\u2026\u2026pseudocode is almost the code already", "This looks complicated but they are very straightforward", "Instead of saying \u201cwhen the user sends a request to `api`.`predict`\u201d", "We say: \u201cHey, app, if people send \u201cGET request\u201d to `predict`, please run function predict_item, we expect the input follows the schema we defined in `Sample`\u201d", "What predict_item does is only transform input shape, feed to trained model and return the prediction, simple Python function", "If you want to know more about HTTP request methods", "But you may ask: hey! One line is missing!!! Where is the input validation? What if users provide the wrong data type/key or miss a field?", "Well\u2026\u2026.Remember we have defined `Sample` class for the input schema? Fast API automatically validates it for us according to the schema and we don\u2019t need to care about that!!! This saves a lot of brainpower and many lines of code to build a robust and well-tested API!", "There are different ways to experiment with the API, depending on your environment, you may use requests in Python or cURL in the command line. BTW there is a handy tool is called Postman, try it out, it is a very intuitive and user-friendly tool for API!", "We will use Python requests for the following examples, you can see them in this Notebook [sometimes Jupyter is helpful \ud83d\ude0e]", "Example below uses a valid input: YEAH! \ud83d\ude0d We made it! The endpoint returns the prediction!!!", "Example below misses a field and FastAPI helps us to handle it according to our defined schema, I literally write nothing other than the schema class", "Just for fun, I also implemented a update_model PUT API to swap the models, for example, originally we were using Random Forest, I updated it to Gradient Boosting\u263a\ufe0f", "One of the cool FastAPI features is auto-document, just go to http://127.0.0.1:8000/docs#/ and you will have the interactive and powerful API document out of the box! So intuitive that I don\u2019t need to elaborate", "I cannot emphasize enough about the importance of unit testing, it verifies the functions are doing what we expect them to do such that you will not break things accidentally!", "But if I try to cover every test it will be too boring and lengthy. What I plan to do here is to share some areas I will brainlessly test & some [probably useful] articles. Then I will talk about a pytest feature called parameterized unit test and some testing options in pytest. The easiest way to motivate yourself to learn unit testing is to try to refactor your previous code, the larger the better!", "Whenever you found difficult to write/understand the unit tests, you probably need to review your code structure first. Below are 4 areas that I will consider brainlessly:", "For example, I focus quite a lot on output dimension, type, value range below. It seems simple but if you modify any output format, it will remind you what is the expected formats!", "How to unit test machine learning code [deep learning]", "Suppose you have 100 mock data [annotate by D_i, i: 1..100] and you want to run the same unit test for each of them, how will you do?", "But if you need to modify `some_operation`, you need to modify it 100 times LOL\u2026\u2026\u2026Although you can make it as a utility function, this makes the tests hard to read and very lengthy", "But you can\u2019t know exactly which tests fail because these 100 tests are all in one test", "pytest offers us a feature called parametrize", "Last time we mentioned we can just run `pytest` in command line and pytest will find ALL the tests under the folder itself. But sometimes we may not want to run all the unit tests during development [maybe some tests take a long time but unrelated to your current tasks]", "In that case, you can simply run pytest FOLDER, eg: `pytest ./scripts` or `pytest ./prediction_api` in the demo", "Sometimes your test cases are too heavy, it may be a good idea to run things in parallel! You can install pytest-xdist and replace pytest by py.test in your command, eg: py.test -n 4", "This is personal taste, I prefer the verbose output and see green PASSED \u2705 to start my day", "You can read more from the materials below:", "Yooo\u270b we have created a prediction API that consumes our model, users can now send the request and get the prediction without a human sitting behind, this over-simplifies the reality [throughput, latency, model management, authentication, AB testing, etc] but this is the idea!", "At least if your prototype is at this level, engineers are much happier to take over from this point and hence speed up the whole process, and you can show them you know something \ud83d\ude08", "File tree below to show the development steps", "BUT (again, bad news usually starts with BUT) they are still on my local computer.", "Although we don\u2019t need to sit behind and hit Run, the user requests cannot reach the API endpoints. Even if they do, it means I cannot close my Macbook, it means I cannot scale if there are many incoming prediction requests\ud83d\ude31!!!", "The way to escape from this hell, as we mentioned in the last article, is to either buy another computer OR rent a server from cloud providers such as AWS", "But first, we also need to ensure the code is working fine there! How?", "Although I haven\u2019t tried, there is a startup called Cortex which focuses on open source machine learning API framework and they also use FastAPI under the hood!", "By now, you should be able to understand their tutorial, in short, they solve many production-level problems behind the scene such as rolling update, DL model inference, integration with AWS, Autoscaling etc\u2026\u2026 [These are DevOps concerns? Or maybe fancier term: MLOps]", "But from user [aka you] perspective, they deploy the APIs using declarative yml [similar to how we configure model in the last article], have a predictor class [similar to our Predictor class], trainer.py [similar to train.py in the last article]", "Writing the code is relatively easy but writing an article for the code is hard, if you found this article useful, you can leave some comments", "OR you can star my repo!", "OR my LinkedIn [Welcome but please leave a few words to indicate you are not zombie]!", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F2372c95fb7c7&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffrom-scripts-to-prediction-api-2372c95fb7c7&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffrom-scripts-to-prediction-api-2372c95fb7c7&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffrom-scripts-to-prediction-api-2372c95fb7c7&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffrom-scripts-to-prediction-api-2372c95fb7c7&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----2372c95fb7c7--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----2372c95fb7c7--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@geoffreyhung?source=post_page-----2372c95fb7c7--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@geoffreyhung?source=post_page-----2372c95fb7c7--------------------------------", "anchor_text": "Geoffrey Hung"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fcf2c9ab57bf7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffrom-scripts-to-prediction-api-2372c95fb7c7&user=Geoffrey+Hung&userId=cf2c9ab57bf7&source=post_page-cf2c9ab57bf7----2372c95fb7c7---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F2372c95fb7c7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffrom-scripts-to-prediction-api-2372c95fb7c7&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F2372c95fb7c7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffrom-scripts-to-prediction-api-2372c95fb7c7&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://towardsdatascience.com/from-jupyter-notebook-to-sc-582978d3c0c", "anchor_text": "From Jupyter Notebook To Scripts"}, {"url": "https://fastapi.tiangolo.com/", "anchor_text": "FastAPI"}, {"url": "https://www.fast.ai/", "anchor_text": "fast.ai"}, {"url": "https://fastapi.tiangolo.com/history-design-future/", "anchor_text": "this article"}, {"url": "https://github.com/G-Hung/model-productization_article", "anchor_text": "one repo"}, {"url": "https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods", "anchor_text": "HTTP request methods"}, {"url": "https://www.postman.com/", "anchor_text": "Postman"}, {"url": "https://github.com/G-Hung/model-productization_article/blob/master/notebook/prediction_API_test.ipynb", "anchor_text": "this Notebook"}, {"url": "http://127.0.0.1:8000/predict", "anchor_text": "http://127.0.0.1:8000/predict"}, {"url": "http://127.0.0.1:8000/predict", "anchor_text": "http://127.0.0.1:8000/predict"}, {"url": "http://127.0.0.1:8000/update_model", "anchor_text": "http://127.0.0.1:8000/update_model"}, {"url": "http://127.0.0.1:8000/docs#/", "anchor_text": "http://127.0.0.1:8000/docs#/"}, {"url": "https://towardsdatascience.com/unit-testing-for-data-scientists-dc5e0cd397fb", "anchor_text": "Unit Testing for Data Scientists"}, {"url": "https://medium.com/@keeper6928/how-to-unit-test-machine-learning-code-57cf6fd81765", "anchor_text": "How to unit test machine learning code"}, {"url": "http://twitter.com/pytest", "anchor_text": "@pytest"}, {"url": "https://docs.pytest.org/en/stable/", "anchor_text": "https://docs.pytest.org/en/stable/"}, {"url": "https://www.guru99.com/pytest-tutorial.html#5", "anchor_text": "https://www.guru99.com/pytest-tutorial.html#5"}, {"url": "https://www.youtube.com/watch?v=rR4n-0KYeKQ", "anchor_text": "this 1 min Youtube video"}, {"url": "https://docs.cortex.dev/", "anchor_text": "Cortex"}, {"url": "https://towardsdatascience.com/why-we-switched-from-flask-to-fastapi-for-production-machine-learning-765aab9b3679", "anchor_text": "use FastAPI"}, {"url": "https://github.com/G-Hung/model-productization_article", "anchor_text": "repo"}, {"url": "https://www.linkedin.com/in/geoffreyhung/", "anchor_text": "my LinkedIn"}, {"url": "https://medium.com/tag/data-science?source=post_page-----2372c95fb7c7---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/data-engineering?source=post_page-----2372c95fb7c7---------------data_engineering-----------------", "anchor_text": "Data Engineering"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----2372c95fb7c7---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F2372c95fb7c7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffrom-scripts-to-prediction-api-2372c95fb7c7&user=Geoffrey+Hung&userId=cf2c9ab57bf7&source=-----2372c95fb7c7---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F2372c95fb7c7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffrom-scripts-to-prediction-api-2372c95fb7c7&user=Geoffrey+Hung&userId=cf2c9ab57bf7&source=-----2372c95fb7c7---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F2372c95fb7c7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffrom-scripts-to-prediction-api-2372c95fb7c7&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----2372c95fb7c7--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F2372c95fb7c7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffrom-scripts-to-prediction-api-2372c95fb7c7&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----2372c95fb7c7---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----2372c95fb7c7--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----2372c95fb7c7--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----2372c95fb7c7--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----2372c95fb7c7--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----2372c95fb7c7--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----2372c95fb7c7--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----2372c95fb7c7--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----2372c95fb7c7--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@geoffreyhung?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@geoffreyhung?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Geoffrey Hung"}, {"url": "https://medium.com/@geoffreyhung/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "202 Followers"}, {"url": "https://www.linkedin.com/in/geoffreyhung/", "anchor_text": "https://www.linkedin.com/in/geoffreyhung/"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fcf2c9ab57bf7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffrom-scripts-to-prediction-api-2372c95fb7c7&user=Geoffrey+Hung&userId=cf2c9ab57bf7&source=post_page-cf2c9ab57bf7--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F46a7491e2da8&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffrom-scripts-to-prediction-api-2372c95fb7c7&newsletterV3=cf2c9ab57bf7&newsletterV3Id=46a7491e2da8&user=Geoffrey+Hung&userId=cf2c9ab57bf7&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}