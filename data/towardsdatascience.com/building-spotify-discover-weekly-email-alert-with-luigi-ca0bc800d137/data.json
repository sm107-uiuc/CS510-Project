{"url": "https://towardsdatascience.com/building-spotify-discover-weekly-email-alert-with-luigi-ca0bc800d137", "time": 1682996485.196505, "path": "towardsdatascience.com/building-spotify-discover-weekly-email-alert-with-luigi-ca0bc800d137/", "webpage": {"metadata": {"title": "Building Spotify Discover Weekly Email Alert with Luigi | by Ricky Kim | Towards Data Science", "h1": "Building Spotify Discover Weekly Email Alert with Luigi", "description": "First of all, I would like you to understand that this is a record of my personal learning. You might find a better way to implement things than what I have tried and shown here. If you have any\u2026"}, "outgoing_paragraph_urls": [{"url": "https://developer.spotify.com/dashboard/applications", "anchor_text": "Spotify for Developers", "paragraph_index": 5}, {"url": "https://localhost:8080", "anchor_text": "https://localhost:8080", "paragraph_index": 9}, {"url": "https://crontab.guru/", "anchor_text": "https://crontab.guru/", "paragraph_index": 42}], "all_paragraphs": ["First of all, I would like you to understand that this is a record of my personal learning. You might find a better way to implement things than what I have tried and shown here. If you have any suggestions to improve the code, I\u2019d be very happy to hear advice, comments.", "If you are a Spotify user, you may have heard of their feature called \u201cDiscover Weekly\u201d. Discover Weekly is a playlist of 30 songs, that Spotify recommends based on your listening history. I absolutely love Discover Weekly, and sometimes even get scared a little bit of how Spotify knows me too well. And it is not just me, it appears.", "The only problem I have with Discover Weekly is that I can\u2019t access my historical Discover Weekly since it automatically refreshes every Monday. When I forgot to save the songs I like to my libraries or playlists, next week the list is completely gone, and I have no way to figure out what was that song I absolutely loved but forgot to save.", "The small private project I am sharing here started from the above problem. The solution I came up with is to extract the list of songs from Discover Weekly every Monday and send the list as an email to myself. It was a perfect opportunity to try a simple data pipeline with Luigi.", "(BTW I am using a Macbook for this project, some of the steps might be slightly different if you are on Windows.)", "In order to be able to access Spotify programmatically, you need client ID and client secret from Spotify. You can get them easily by going to Spotify for Developers page. Once you are in the dashboard page, you can click on the green \u201cCREATE A CLIENT ID\u201d button, then you will be asked questions like app name, description, etc.", "Next, you will be asked if the app is for commercial use. In my case, I am just building this for myself, so I clicked \u201cNo\u201d.", "Finally, tick the checkboxes, then submit.", "Then you will be given a client ID and a client secret that you can use to access Spotify API.", "Take a memo or copy and paste it somewhere because we will need these later. Click \u201cEDIT SETTINGS\u201d, and add \u201chttps://localhost:8080\u201d to Redirect URIs. In a proper app, this will redirect the user to the app after confirming the API access, but in this case, this will only be used as a part of authentication params.", "One last thing you need to do is to follow Discover Weekly on your Spotify. This makes it possible to retrieve Discover Weekly from our Python program.", "Sign in to your AWS Management Console, and click into EC2. I am writing this assuming that you already have an AWS account. Click \u201cLaunch Instance\u201d. For this project, I chose Amazon Linux AMI 2018.03.0.", "Make sure the instance type chosen is t2.micro which is eligible for free tier. One important step we should do is to open the port for Luigi so that we can access Luigi\u2019s central scheduler.", "Keep the default settings for the rest except for \u201c6. Configure Security Group\u201d. Once you get here, click \u201cAdd Rules\u201d and choose Custom TCP from the \u201cType\u201d dropdown, and type in \u201c8082\u201d in \u201cPort Ranges\u201d. Luigi\u2019s central scheduler GUI uses port 8082 as a default, so this step enables us to access Luigi GUI on a web browser. As an additional step, you can add your own IP address in the \u201cSources\u201d section, so that you only allow inbound traffic from a certain IP address. If you want to explicitly your own IP address only type in \u201cyour-IP-address/32\u201d in the Sources section. Now click \u201cReview and Launch\u201d.", "Next, you will be prompted to either choose an existing key pair or create a new one. The key will be used when communicating with your instance from your local machine. Let\u2019s create a new key pair for the project.", "First, download key pair, then finally launch instance. Go back to EC2 section of AWS console, and you might see the instance is still not in \u201crunning\u201d state. Give it a few moments, and when it turned to \u201crunning\u201d, take a good note of its Public DNS (IPv4) and IPv4 Public IP.", "Either from terminal or on AWS web console, create an S3 bucket named \u201cluigi-spotify\u201d. This will be later used to store the list of songs extracted from Spotify as TSV.", "I hope there was nothing too complicated so far. Now since we launched the instance, we can ssh into it. Before we do that, we need to change the file permission of the key pair we downloaded above, because EC2 instance will not accept key file which is publicly viewable. Open your terminal and run below command after replacing \u201cdirectory\u2026\u201d part to your own directory", "There are 3 permissions (Read, Write, Execute) for 3 types of users (User, Group, Others). What the above line of code does is changing the file permission so that the key file has only one permission (Read) allowed to one type of user (User). Now we are ready to ssh into our instance. Again please replace the part \u201cdirectory\u2026\u201d and \u201cyour-instance\u2026\u201d with your own directory and public DNS.", "Once in your EC2 instance, let\u2019s first install Git so that we can clone the repository I prepared for this project.", "Now clone the repository using git clone command.", "Go to the cloned directory, and let\u2019s first take a look at files.", "ec2-prep.sh will be used to install required packages. luigi.cfg is a configuration file where you will put all the API keys and credentials. luigi_cron.sh is a bash script that runs Luigi pipeline defined in run-luigi.py.", "Make both of the bash scripts executable by running below command.", "Now let\u2019s first run the ec2-prep.sh", "Before we actually run the pipeline, it\u2019d be good to have an understanding of what the pipeline does and how it does it. Below is the code for run_luigi.py.", "On a high level, it performs two tasks. First, get the list of songs from the Discover Weekly playlist, and store them in S3 as TSV. Once it\u2019s finished storing TSV, then with the TSV, it creates an email message that shows [Song Title] \u2014 [Artist] as Spotify links, then send the message to yourself. The first task is defined in GetWeeklyTracks class, and the second is defined in SendWeeklyEmail class. In order for these tasks to be able to run, it needs credential info, and these are retrieved from luigi.cfg file using luigi.Config class. Getting Spotify API token, and establish the connection to Spotify is being done outside of Luigi tasks.", "Next thing we need to do is filling in the information in luigi.cfg file. First open the file with Nano.", "Fill in each value with your own credentials without quotes or double quotes. Now we are finally ready to do a local test run of the pipeline within our EC2.", "Due to Spotipy\u2019s (a Python library for Spotify API) authentication flow, you will see instructions like below.", "If tested on your local machine, this would have opened the web browser, but it doesn\u2019t open on EC2 since there is no web browser installed. Copy the URL (the blue highlighted part in the above screenshot), and paste this to your local machine web browser and open.", "If you see a screen like above, click \u201cAGREE\u201d, then it will show error page like below. You don\u2019t have to worry about this error page. This happens because the redirect URI we provided is just a localhost port without anything running on it. Copy the URL address of the error page, there is a code embedded in the URL that will be used by Spotipy\u2019s autehntication flow.", "Now back to your EC2 terminal, paste the URL to the console, where it shows \u201cEnter the URL you were redirected to:\u201d. Now chances are high that this won\u2019t succeed at first try because Google blocking this Gmail login from an unknown IP address at first. If this happens, log in to your Gmail using your local machine web browser, then try run the command again. If everything goes well you will have received the email sent from the trial run.", "We are almost there. The train run succeeded, now we have a few more steps to go. Now let\u2019s do a proper run of the pipeline with Luigi\u2019s Central Scheduler, so that we can access Lugi GUI. First, create a directory for log files.", "When we do a background run console output will be stored in log files in the above directory we just created. Let\u2019s launch Luigi Central Scheduler.", "Since we have opened the port 8082 to access GUI, we can now open GUI on a web browser. Open the page with the IPv4 Public IP and \u201c:8082\u201d attached as below.", "We haven\u2019t run any tasks yet, so you won\u2019t see any tasks now. Now let\u2019s run the pipeline without \u201c \u2014 local-scheduler\u201d param at the end. You might want to delete the folder created in the S3 bucket during the trial run to see the whole pipeline running from scratch. Otherwise, Luigi will see the folder and files in the S3 bucket, then just check the output files are there and mark the task as success without running any of the tasks. Now you will see two tasks run successfully.", "The very last part is to set up a Cron job so that we can decide when and how frequent these tasks run. The one thing you have to consider here is that your EC2 instance\u2019s Linux time might be different from your local time. Run below command to set the time zone in your EC2 instance.", "After you select the right timezone for you. Copy the part that\u2019s highlighted in blue from your own terminal and run. Since I will finish setting up my EC2 without restarting, I just directly run the code on the terminal without appending it to \u2018.profile\u2019.", "We will be setting up a Cron job with luigi_cron.sh that will run run_luigi.py. As you will see from the Cron command below, I am specifying LC_CTYPE with the correct value of the EC2 instance. This small part took me a while to figure out. The same file, the same tasks were throwing encoding error when run as a Cron job, while it works perfectly fine without Cron. After a long googling I finally found the way that works. You can find the EC2 instance\u2019s LC_CTYPE value by run \u201clocale\u201d.", "Once you have that LC-CTYPE info, open a Crontab with below code.", "You won\u2019t find anything there yet. Press \u201ci\u201d and go into \u201cinsert\u201d mode, then paste below code, and press esc then type \u201c:wq\u201d to write the changes and exit.", "Above Crontab expression will schedule the bash script to run 08:00AM every Monday, but you can change it to your own preference. If you need help with Crontab expression, you can try your own expression at https://crontab.guru/.", "If you want to check if the Cron works, you can first set the Crontab value as below (It will run the task every minute), then check if it works, and change it back to the weekly Crontab value you want to set. Again if you want to do this check, please don\u2019t forget to delete the folder from your S3 bucket.", "That is it! Now the Luigi pipeline will run every Monday to fetch songs from my Discover Weekly and will send me an email!", "I know this is not a very complicated task. But it was such a wonderful learning experience for me. Of course, there are spaces for improvements in my code implementation, but I am one happy man today who solved one of my daily problems using data and Luigi!", "Thank you for reading. You can find Git repository from the below link.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "The Rickest Ricky. Love data, beer, coffee, and good memes in no particular order."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fca0bc800d137&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbuilding-spotify-discover-weekly-email-alert-with-luigi-ca0bc800d137&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbuilding-spotify-discover-weekly-email-alert-with-luigi-ca0bc800d137&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbuilding-spotify-discover-weekly-email-alert-with-luigi-ca0bc800d137&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbuilding-spotify-discover-weekly-email-alert-with-luigi-ca0bc800d137&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----ca0bc800d137--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----ca0bc800d137--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@rickykim78?source=post_page-----ca0bc800d137--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@rickykim78?source=post_page-----ca0bc800d137--------------------------------", "anchor_text": "Ricky Kim"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F57a8aa301d13&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbuilding-spotify-discover-weekly-email-alert-with-luigi-ca0bc800d137&user=Ricky+Kim&userId=57a8aa301d13&source=post_page-57a8aa301d13----ca0bc800d137---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fca0bc800d137&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbuilding-spotify-discover-weekly-email-alert-with-luigi-ca0bc800d137&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fca0bc800d137&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbuilding-spotify-discover-weekly-email-alert-with-luigi-ca0bc800d137&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@ryanquintal?utm_source=medium&utm_medium=referral", "anchor_text": "Ryan Quintal"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://developer.spotify.com/dashboard/applications", "anchor_text": "Spotify for Developers"}, {"url": "https://localhost:8080", "anchor_text": "https://localhost:8080"}, {"url": "https://github.com/tthustla/luigi_spotify.git", "anchor_text": "https://github.com/tthustla/luigi_spotify.git"}, {"url": "https://www.redbubble.com/people/vernonv/works/28166990-luigi-dab?p=art-print", "anchor_text": "vernonv on Redbubble"}, {"url": "https://crontab.guru/", "anchor_text": "https://crontab.guru/"}, {"url": "https://github.com/tthustla/luigi_spotify", "anchor_text": "https://github.com/tthustla/luigi_spotify"}, {"url": "https://medium.com/tag/aws?source=post_page-----ca0bc800d137---------------aws-----------------", "anchor_text": "AWS"}, {"url": "https://medium.com/tag/luigi?source=post_page-----ca0bc800d137---------------luigi-----------------", "anchor_text": "Luigi"}, {"url": "https://medium.com/tag/spotify?source=post_page-----ca0bc800d137---------------spotify-----------------", "anchor_text": "Spotify"}, {"url": "https://medium.com/tag/python?source=post_page-----ca0bc800d137---------------python-----------------", "anchor_text": "Python"}, {"url": "https://medium.com/tag/data-engineering?source=post_page-----ca0bc800d137---------------data_engineering-----------------", "anchor_text": "Data Engineering"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fca0bc800d137&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbuilding-spotify-discover-weekly-email-alert-with-luigi-ca0bc800d137&user=Ricky+Kim&userId=57a8aa301d13&source=-----ca0bc800d137---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fca0bc800d137&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbuilding-spotify-discover-weekly-email-alert-with-luigi-ca0bc800d137&user=Ricky+Kim&userId=57a8aa301d13&source=-----ca0bc800d137---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fca0bc800d137&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbuilding-spotify-discover-weekly-email-alert-with-luigi-ca0bc800d137&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----ca0bc800d137--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fca0bc800d137&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbuilding-spotify-discover-weekly-email-alert-with-luigi-ca0bc800d137&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----ca0bc800d137---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----ca0bc800d137--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----ca0bc800d137--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----ca0bc800d137--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----ca0bc800d137--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----ca0bc800d137--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----ca0bc800d137--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----ca0bc800d137--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----ca0bc800d137--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@rickykim78?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@rickykim78?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Ricky Kim"}, {"url": "https://medium.com/@rickykim78/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "2.6K Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F57a8aa301d13&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbuilding-spotify-discover-weekly-email-alert-with-luigi-ca0bc800d137&user=Ricky+Kim&userId=57a8aa301d13&source=post_page-57a8aa301d13--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F90941e4c1749&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fbuilding-spotify-discover-weekly-email-alert-with-luigi-ca0bc800d137&newsletterV3=57a8aa301d13&newsletterV3Id=90941e4c1749&user=Ricky+Kim&userId=57a8aa301d13&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}