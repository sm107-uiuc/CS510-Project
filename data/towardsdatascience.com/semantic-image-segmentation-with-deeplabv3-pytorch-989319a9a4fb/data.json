{"url": "https://towardsdatascience.com/semantic-image-segmentation-with-deeplabv3-pytorch-989319a9a4fb", "time": 1683017678.7507699, "path": "towardsdatascience.com/semantic-image-segmentation-with-deeplabv3-pytorch-989319a9a4fb/", "webpage": {"metadata": {"title": "Semantic Image Segmentation with DeepLabv3-pytorch | by Vinayak Nayak | Towards Data Science", "h1": "Semantic Image Segmentation with DeepLabv3-pytorch", "description": "With the surge in use of video calling services during the COVID lockdown, many players are offering a service where the user of the service could blur the background or add a custom background etc\u2026"}, "outgoing_paragraph_urls": [{"url": "https://stackoverflow.com/questions/40207011/opencv-not-working-properly-with-python-on-linux-with-anaconda-getting-error-th", "anchor_text": "one such issue", "paragraph_index": 11}, {"url": "http://host.robots.ox.ac.uk/pascal/VOC/voc2012/segexamples/index.html", "anchor_text": "PASCAL VOC dataset", "paragraph_index": 13}], "all_paragraphs": ["With the surge in use of video calling services during the COVID lockdown, many players are offering a service where the user of the service could blur the background or add a custom background etc. (Zoom, MS-Teams etc.) This is a classic use case of image segmentation where the object of interest is located and the pixels barring this region are modified/substituted.", "There are many deep learning architectures which could be used to solve the instance segmentation problem and today we\u2019re going to useDeeplab-v3 which is a State of the Art semantic image segmentation model which comes in many flavors. Its goal is to assign semantic labels (e.g., person, sheep, airplane and so on) to every pixel in the input image. We are going to particularly be focusing on using the Deeplabv3 model with a Resnet-101 backbone that is offered out of the box with the torch library.", "At the end of this post, you\u2019ll be able to build something as shown above. We\u2019ll go about building this in a step by step fashion as follows:", "So without any further ado, let\u2019s get started!", "For reproducing the code below, we will need to have python installed on our system and in addition to that we will also need the following:", "These could be simply installed by using the command", "If you\u2019re working with conda, I would recommend you create a separate environment for this project using the following command. You can choose a higher version for python as well by changing the last portion to python=3.7 or python=3.8 etc.", "Once you install the above packages, we\u2019re ready to go to the next step.", "We will be using opencv to interface a webcam for reading in input from our screens and we\u2019ll use matplotlib\u2019s pyplot module to render the processed video feed to output.", "opencv\u2019s VideoCapture object is used to get the image input for video. If you have multiple webcams you could create multiple such objects by passing the appropriate index; by default nowadays, most monitors have one inbuilt camera which could be indexed at 0th position.", "Subsequently, opencv reads images in a BGR format but while rendering we need to show it in RGB format; so we\u2019ve written a tiny function that captures a frame in realtime and converts it from BGR format to RGB format above. With this, we\u2019re set with the input preprocessing steps. Let\u2019s look at how we\u2019ll set the stage for output now.", "Why use matplotlib.pyplot and not cv2.imshow? There are some inconsistencies with cv2.imshow when it comes to ubuntu distributions; I had one such issue which caused me to look at alternate methods and since pyplot is easy to implement and mostly included with all major python distributions like anaconda by default, I thought of using pyplot for rendering the output.", "So basically we set up two subplots as seen in the gif on the top; one to see the blurred version and another one to actually look at the labels mask which the deeplab model has predicted. We switch on the interactive mode for pyplot and display the image captured directly at the very beginning of the stream. Now, that we have the stage set, let\u2019s discuss the part to obtain predictions from the deeplab-v3 model.", "The model offered at torch-hub for segmentation is trained on PASCAL VOC dataset which contains 20 different classes of which the most important one for us is the person class with label 15.", "Using the above code we can download the model from torch-hub and use it for our segmentation task. Note that since this is based on top of a Resnet-101 model which is quite heavy, the inference will take time and rendering will lag heavily if you do not have a medium sized GPU if not a high end one. Now that we have the model loaded, let\u2019s discuss how we could get predictions from it.", "We will first load the image using Pillow or directly get it from the VideoCapture object of cv2 defined above. Once we have this, we will normalize it using imagenet stats and convert it to a tensor. Then if we have a GPU available at our disposal, we can move the tensor to GPU. All pre-trained models expect input images in mini-batches of 3-channel RGB images of shape (N, 3, H, W), where N is the number of images, H and W are height and width of the two images respectively. Since our video capture object captures single frames, it\u2019s output is (3, H, W). We therefore unsqueeze the tensor along the first dimension to make it (1, 3, H, W).", "Once we do that, we then put the model in eval mode and without autograd perform a forward pass through the same. The forward pass gives auxand out objects from which, the out object is of interest to us during inference. The aux values have loss value per pixel and are useful during train time. So, we get the out object and do a argmax along the 1st dimension to obtain the labels map which is of the same height and width as the original image with a single channel. This mask could be used for segmentation which we\u2019ll look at in the next section.", "Now that we have the predictions, we can use them for segmenting the human and blurring the background.", "The labels extracted out of the image are two dimensional. We need to replicate this mask across all three channels i.e. RGB. So, we use numpy to repeat this segmentation mask across all three channels.", "Next, we use opencv\u2019s Gaussian Blur to blue the entire frame output and get a new image called blur. The extent of blur is determined by the blur_value variable which is a tuple representing the kernel size for blurring. Higher the value, more the blur and vice versa.", "Next, with the help of mask, we replace the background pixels of the frame with the blurred frame\u2019s pixels. Now that we have both the mask and the resulting manipulated frame, we set the data of the two image variables defined in the Setting the stage for output section to these two frames respectively and define an interval for interactive pyplot object for refreshing the frame (think of it as an equivalent of frame rate).", "This is how you could use DeepLabv3 for making your very own background blurring feature on custom videos or live vidcams with Image Segmentation.", "Just like we blurred the background above, we could also substitute the background with a custom image and it only requires some minor modifications to the code.", "We read a background image of our choice for substitution using cv2 and bring it to RGB format. Next, in the part where we replace the frame\u2019s non-human pixels with blurred pixels, we now use this background image pixels instead.", "Basically, we resize the background image to fit the frame capture source or the video source, then mask all the human pixels in this image with the frame\u2019s human pixels. This gives the source human overlaid on top of the background image like shown in the gif below.", "Hope you enjoyed reading this post as much as I did while writing it. If you want to read further, I\u2019ve mentioned some links in the resource section which may prove helpful. Cheers!", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F989319a9a4fb&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsemantic-image-segmentation-with-deeplabv3-pytorch-989319a9a4fb&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsemantic-image-segmentation-with-deeplabv3-pytorch-989319a9a4fb&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsemantic-image-segmentation-with-deeplabv3-pytorch-989319a9a4fb&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsemantic-image-segmentation-with-deeplabv3-pytorch-989319a9a4fb&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----989319a9a4fb--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----989319a9a4fb--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://nayakvinayak95.medium.com/?source=post_page-----989319a9a4fb--------------------------------", "anchor_text": ""}, {"url": "https://nayakvinayak95.medium.com/?source=post_page-----989319a9a4fb--------------------------------", "anchor_text": "Vinayak Nayak"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F9b10ad08afc7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsemantic-image-segmentation-with-deeplabv3-pytorch-989319a9a4fb&user=Vinayak+Nayak&userId=9b10ad08afc7&source=post_page-9b10ad08afc7----989319a9a4fb---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F989319a9a4fb&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsemantic-image-segmentation-with-deeplabv3-pytorch-989319a9a4fb&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F989319a9a4fb&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsemantic-image-segmentation-with-deeplabv3-pytorch-989319a9a4fb&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@frostroomhead?utm_source=medium&utm_medium=referral", "anchor_text": "Rodion Kutsaev"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://stackoverflow.com/questions/40207011/opencv-not-working-properly-with-python-on-linux-with-anaconda-getting-error-th", "anchor_text": "one such issue"}, {"url": "http://host.robots.ox.ac.uk/pascal/VOC/voc2012/segexamples/index.html", "anchor_text": "PASCAL VOC dataset"}, {"url": "https://pytorch.org/hub/pytorch_vision_deeplabv3_resnet101/", "anchor_text": "Deeplabv3-Resnet101 Pytorch"}, {"url": "https://github.com/ElisonSherton/instanceSegmentation/", "anchor_text": "All the code for the above example"}, {"url": "http://www.cs.toronto.edu/~jepson/csc2503/segmentation.pdf", "anchor_text": "More on Image Segmentation"}, {"url": "https://www.pyimagesearch.com/2018/11/26/instance-segmentation-with-opencv/", "anchor_text": "PyImageSearch Article on Instance Segmentation with opencv"}, {"url": "https://medium.com/tag/artificial-intelligence?source=post_page-----989319a9a4fb---------------artificial_intelligence-----------------", "anchor_text": "Artificial Intelligence"}, {"url": "https://medium.com/tag/data-science?source=post_page-----989319a9a4fb---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/python?source=post_page-----989319a9a4fb---------------python-----------------", "anchor_text": "Python"}, {"url": "https://medium.com/tag/image-segmentation?source=post_page-----989319a9a4fb---------------image_segmentation-----------------", "anchor_text": "Image Segmentation"}, {"url": "https://medium.com/tag/computer-vision?source=post_page-----989319a9a4fb---------------computer_vision-----------------", "anchor_text": "Computer Vision"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F989319a9a4fb&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsemantic-image-segmentation-with-deeplabv3-pytorch-989319a9a4fb&user=Vinayak+Nayak&userId=9b10ad08afc7&source=-----989319a9a4fb---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F989319a9a4fb&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsemantic-image-segmentation-with-deeplabv3-pytorch-989319a9a4fb&user=Vinayak+Nayak&userId=9b10ad08afc7&source=-----989319a9a4fb---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F989319a9a4fb&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsemantic-image-segmentation-with-deeplabv3-pytorch-989319a9a4fb&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----989319a9a4fb--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F989319a9a4fb&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsemantic-image-segmentation-with-deeplabv3-pytorch-989319a9a4fb&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----989319a9a4fb---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----989319a9a4fb--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----989319a9a4fb--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----989319a9a4fb--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----989319a9a4fb--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----989319a9a4fb--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----989319a9a4fb--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----989319a9a4fb--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----989319a9a4fb--------------------------------", "anchor_text": ""}, {"url": "https://nayakvinayak95.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://nayakvinayak95.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Vinayak Nayak"}, {"url": "https://nayakvinayak95.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "80 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F9b10ad08afc7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsemantic-image-segmentation-with-deeplabv3-pytorch-989319a9a4fb&user=Vinayak+Nayak&userId=9b10ad08afc7&source=post_page-9b10ad08afc7--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fadfaf0b7759f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsemantic-image-segmentation-with-deeplabv3-pytorch-989319a9a4fb&newsletterV3=9b10ad08afc7&newsletterV3Id=adfaf0b7759f&user=Vinayak+Nayak&userId=9b10ad08afc7&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}