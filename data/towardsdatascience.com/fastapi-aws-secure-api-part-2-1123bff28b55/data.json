{"url": "https://towardsdatascience.com/fastapi-aws-secure-api-part-2-1123bff28b55", "time": 1683016555.8573902, "path": "towardsdatascience.com/fastapi-aws-secure-api-part-2-1123bff28b55/", "webpage": {"metadata": {"title": "FastAPI + AWS = secure API (Part 2) | by Anna Geller | Towards Data Science", "h1": "FastAPI + AWS = secure API (Part 2)", "description": "Let's build a secure and observable Python REST API with FastAPI, AWS Lambda, API Gateway, CloudWatch, and AWS X-Ray"}, "outgoing_paragraph_urls": [{"url": "https://towardsdatascience.com/fastapi-aws-robust-api-part-1-f67ae47390f9", "anchor_text": "Part 1 of this article", "paragraph_index": 0}, {"url": "https://www.postman.com/downloads/", "anchor_text": "Postman", "paragraph_index": 9}, {"url": "https://github.com/anna-anisienia/cryptoAPI", "anchor_text": "this Github repository", "paragraph_index": 11}, {"url": "https://rapidapi.com/marketplace", "anchor_text": "monetized", "paragraph_index": 23}, {"url": "https://github.com/aws/aws-xray-sdk-python", "anchor_text": "Python SDK", "paragraph_index": 34}, {"url": "https://calculator.aws/#/", "anchor_text": "AWS Pricing Calculator", "paragraph_index": 46}, {"url": "https://medium.com/@anna.anisienia", "anchor_text": "follow me", "paragraph_index": 48}, {"url": "https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-api-usage-plans.html", "anchor_text": "API Gateway docs", "paragraph_index": 49}, {"url": "https://docs.aws.amazon.com/xray/latest/devguide/xray-concepts.html", "anchor_text": "AWS X-Ray docs", "paragraph_index": 50}, {"url": "https://courses.edx.org/courses/course-v1:AWS+OTP-AWSD12+3T2020/course/", "anchor_text": "Building Modern Python Applications on AWS", "paragraph_index": 51}, {"url": "http://www.annageller.com", "anchor_text": "www.annageller.com", "paragraph_index": 53}, {"url": "https://annageller.medium.com/subscribe", "anchor_text": "https://annageller.medium.com/subscribe", "paragraph_index": 53}], "all_paragraphs": ["In Part 1 of this article, we discussed how to build and deploy a FastAPI application to AWS with API Gateway and Amazon Lambda. In Part 2, we will build on that to ensure that our API is secure, easy to redeploy, and that we can monitor its health via distributed logging and tracing. This article is based on a top-down approach: we will first create all resources and later we will dive deeper into details about them and discuss how all those services work together.", "First, within the API Gateway, we need to set the option \u201cAPI Key Required\u201d to true for both Method and Resource proxy:", "Go to the section \u201cAPI Keys\u201d in the left navigation panel:", "Now we can create an API KEY: Actions \u2192 Create API Key \u2192 Save:", "Then, let\u2019s create a usage plan [1]: go to Usage Plans (in the left navigation bar above API Keys) \u2192 Create:", "Once we have a usage plan, we can associate it with our API deployed to the dev stage:", "Let\u2019s also associate the previously created API KEY with this usage plan:", "Now the essential part: to activate the changes to the API Key, we need to redeploy our dev API stage:", "In our browser, we should now see a message \u201cforbidden\u201d (it can take 1\u20132 minutes for the changes to take effect).", "We can test the usage with our API key via Postman:", "Once you click on \u201cSend\u201d, you should see the correct API response.", "You can download the code for this project from this Github repository.", "Let\u2019s make a tiny change to the return value of the root path:", "In order to make those changes to the API deployed to AWS, we repeat the steps of packaging the code, as mentioned in Part 1 of this article:", "It all can be accomplished with those lines:", "After executing the command: bash package_and_update_lambda_code.bash, we should be able to see the changes reflected in the API (no need to redeploy the API stage, as we only made changes to the underlying Lambda function, not to the API Gateway resource):", "To take advantage of centralized logging, all we need to do is to select the checkbox next to CloudWatch Logs. That\u2019s it! We can choose the desired log level and whether to log full request/response data.", "On top of that, we can enable Access Logging, which can be useful to see which users or agents use specific endpoints. This way, we\u2019ll have a track of access records if something goes wrong.", "After having enabled X-Ray Tracing and making a few API requests, we should be able to see\u00a0the\u00a0collected\u00a0traces\u00a0and\u00a0metrics:", "The errors in the image above, marked yellow, are the result of me trying to access the API from the browser without authenticating by using API Key.", "In order to find the correct Log group for your API, look for one that starts with the API ID. Then, you can find the logs of all API requests and responses:", "Let\u2019s dive deeper into how those services work and how to use them effectively.", "1. What is a Usage Plan?", "API Gateway allows us to build APIs that can be monetized as a product. A usage plan, together with the associated API keys, let us offer our API to authorized customers at specific request rates and speed:", "\u201cA usage plan specifies who can access one or more deployed API stages and methods \u2014 and also how much and how fast they can access them.\u201d [4]", "This means that by assigning an API key to a specific usage plan within a specific API stage (ex. dev or prod), we can achieve a different level of permissions and different throttling restrictions to various API stages. We can assign many API keys to each usage plan, which allows fine-granular access control.", "2. How do we use API keys?", "API keys are simple strings (30-128 characters long) that can be assigned to usage plans or Lambda authorizers. They allow us to assign permissions on the API stage and request type level.", "For example, we might want to have more open access within the dev stage and more restrictive access in prod. This would mean that a privileged user could get access to both stages dev and prod, while some other user could get an API key that gets only assigned to the usage plan corresponding to the dev API stage.", "3. How do we differentiate between CloudWatch logs for Lambda executions and for API Gateway requests?", "CloudWatch stores logs in separate log groups corresponding to each service (ex. API Gateway) and resource within that service (your specific API). You can identify the log group corresponding to your API Gateway logs by looking up your API ID. You can find it in your URL endpoint or in the management console:", "The log group corresponding to your API in API Gateway will look similar to:", "Amazon Lambda logs can be identified by the function name:", "X-Ray is a service for distributed tracing. It tracks metrics such as latency and success rate of requests made to our API and how different components in our service depend on each other. The main benefit of X-Ray is that it generates a service map, which lets us analyze which requests are followed by other downstream requests and what are the potential bottlenecks in our API.", "Internally, X-Ray generates traces by using segments, i.e. compute resources that execute our API requests such as API Gateway and Amazon Lambda. Those segments can be broken down into subsegments for a more granular tracing\u200a\u2014\u200afor instance, we could have used X-Ray\u2019s Python SDK in our FastAPI code to add new subsegments, make annotations and overall make our traces\u00a0more\u00a0granular.", "A single trace collects all segments and subsegments generated by a specific request.", "5. Does X-Ray automatically tracks and records every single request?", "Short answer: no. Measuring every single request would be expensive and likely unnecessary (if the first 50 requests of the same type took 200ms each, then it will likely be the same for the next five million subsequent requests). X-Ray uses representative samples: it tracks, by default, the first request per second, plus 5% of all additional requests. This sampling rule can be configured based on the properties of your specific requests [2].", "There are, also, two different types of tracing: active and passive. Both have the same effect in that they result in X-Ray sampling the requests and collecting traces.", "When we enable X-Ray in API Gateway that invokes our Lambda function, it means that passive tracing is enabled on this Lambda function, as an upstream service (i.e. API Gateway) takes care of adding tracing header that tells Lambda whether to send traces or not. In contrast, if we have enabled tracing directly from the Lambda configuration rather than from API Gateway, this would be active tracing.", "5. How does X-Ray differ from CloudWatch and CloudTrail?", "X-Ray lets us collect metrics about our specific API or microservice. CloudTrail has a much wider \u201caudience\u201d \u2014 since everything in AWS is an API call, every action made within our AWS account can be tracked with CloudTrail. It\u2019s possible to integrate X-Ray with CloudTrail to track additional actions made by a user, IAM role, or any AWS service and analyze them within X-Ray traces [3].", "In contrast, CloudWatch allows us to track execution logs, access logs, or even full request and response data, and analyze them either directly in CloudWatch console or in a tool such as Kibana or Grafana.", "While CloudWatch gives us detailed logs, X-Ray gives us just metrics about latency and status of sampled requests.", "6. How much do those services cost?", "The prices vary depending on your AWS region, type of API (REST, HTTP), and your number of requests (bulk discount). At the time of writing:", "You can use AWS Pricing Calculator to get a more realistic estimate corresponding to your use case. Also, note that with the free tier you get (limited) free access to API Gateway, Amazon Lambda, and CloudWatch logs.", "In this article, we looked at how to make our API secure and easy to maintain. We discussed how to assign usage plans and API keys, and how to monitor the health of our API by enabling distributed logging and tracing. Finally, we dived deeper into how those services work and how to use them effectively.", "If this article was helpful, follow me to see my next articles.", "[1] API Gateway docs on usage plans", "[2] AWS X-Ray docs on sampling requests and tracing", "[3] AWS Edx Course on Building Modern Python Applications on AWS", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "DevRel, Data Professional, Cloud & .py fan. www.annageller.com. Get my articles via email: https://annageller.medium.com/subscribe"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F1123bff28b55&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffastapi-aws-secure-api-part-2-1123bff28b55&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffastapi-aws-secure-api-part-2-1123bff28b55&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffastapi-aws-secure-api-part-2-1123bff28b55&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffastapi-aws-secure-api-part-2-1123bff28b55&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----1123bff28b55--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----1123bff28b55--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://annageller.medium.com/?source=post_page-----1123bff28b55--------------------------------", "anchor_text": ""}, {"url": "https://annageller.medium.com/?source=post_page-----1123bff28b55--------------------------------", "anchor_text": "Anna Geller"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F5bdf5a3385cd&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffastapi-aws-secure-api-part-2-1123bff28b55&user=Anna+Geller&userId=5bdf5a3385cd&source=post_page-5bdf5a3385cd----1123bff28b55---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F1123bff28b55&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffastapi-aws-secure-api-part-2-1123bff28b55&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F1123bff28b55&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffastapi-aws-secure-api-part-2-1123bff28b55&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://www.pexels.com/@spencer-selover-142259?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels", "anchor_text": "Spencer Selover"}, {"url": "https://www.pexels.com/photo/adult-color-palette-colorful-colors-567452/?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels", "anchor_text": "Pexels"}, {"url": "https://towardsdatascience.com/fastapi-aws-robust-api-part-1-f67ae47390f9", "anchor_text": "Part 1 of this article"}, {"url": "https://www.postman.com/downloads/", "anchor_text": "Postman"}, {"url": "https://github.com/anna-anisienia/cryptoAPI", "anchor_text": "this Github repository"}, {"url": "https://towardsdatascience.com/fastapi-aws-robust-api-part-1-f67ae47390f9", "anchor_text": "FastAPI + AWS = robust API (Part 1)Let\u2019s build a scalable Python-based REST API with FastAPI, Amazon Lambda, and API Gatewaytowardsdatascience.com"}, {"url": "https://rapidapi.com/marketplace", "anchor_text": "monetized"}, {"url": "https://github.com/aws/aws-xray-sdk-python", "anchor_text": "Python SDK"}, {"url": "https://aws.amazon.com/api-gateway/pricing/", "anchor_text": "API Gateway"}, {"url": "https://aws.amazon.com/xray/pricing/", "anchor_text": "AWS X-Ray"}, {"url": "https://aws.amazon.com/lambda/pricing/", "anchor_text": "AWS Lambda"}, {"url": "https://aws.amazon.com/cloudwatch/pricing/", "anchor_text": "CloudWatch"}, {"url": "https://calculator.aws/#/", "anchor_text": "AWS Pricing Calculator"}, {"url": "https://medium.com/@anna.anisienia", "anchor_text": "follow me"}, {"url": "https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-api-usage-plans.html", "anchor_text": "API Gateway docs"}, {"url": "https://docs.aws.amazon.com/xray/latest/devguide/xray-concepts.html", "anchor_text": "AWS X-Ray docs"}, {"url": "https://courses.edx.org/courses/course-v1:AWS+OTP-AWSD12+3T2020/course/", "anchor_text": "Building Modern Python Applications on AWS"}, {"url": "https://medium.com/tag/programming?source=post_page-----1123bff28b55---------------programming-----------------", "anchor_text": "Programming"}, {"url": "https://medium.com/tag/aws?source=post_page-----1123bff28b55---------------aws-----------------", "anchor_text": "AWS"}, {"url": "https://medium.com/tag/software-development?source=post_page-----1123bff28b55---------------software_development-----------------", "anchor_text": "Software Development"}, {"url": "https://medium.com/tag/software-engineering?source=post_page-----1123bff28b55---------------software_engineering-----------------", "anchor_text": "Software Engineering"}, {"url": "https://medium.com/tag/python?source=post_page-----1123bff28b55---------------python-----------------", "anchor_text": "Python"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F1123bff28b55&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffastapi-aws-secure-api-part-2-1123bff28b55&user=Anna+Geller&userId=5bdf5a3385cd&source=-----1123bff28b55---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F1123bff28b55&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffastapi-aws-secure-api-part-2-1123bff28b55&user=Anna+Geller&userId=5bdf5a3385cd&source=-----1123bff28b55---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F1123bff28b55&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffastapi-aws-secure-api-part-2-1123bff28b55&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----1123bff28b55--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F1123bff28b55&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffastapi-aws-secure-api-part-2-1123bff28b55&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----1123bff28b55---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----1123bff28b55--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----1123bff28b55--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----1123bff28b55--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----1123bff28b55--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----1123bff28b55--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----1123bff28b55--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----1123bff28b55--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----1123bff28b55--------------------------------", "anchor_text": ""}, {"url": "https://annageller.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://annageller.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Anna Geller"}, {"url": "https://annageller.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "5.4K Followers"}, {"url": "http://www.annageller.com", "anchor_text": "www.annageller.com"}, {"url": "https://annageller.medium.com/subscribe", "anchor_text": "https://annageller.medium.com/subscribe"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F5bdf5a3385cd&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffastapi-aws-secure-api-part-2-1123bff28b55&user=Anna+Geller&userId=5bdf5a3385cd&source=post_page-5bdf5a3385cd--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F908ff40c4340&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ffastapi-aws-secure-api-part-2-1123bff28b55&newsletterV3=5bdf5a3385cd&newsletterV3Id=908ff40c4340&user=Anna+Geller&userId=5bdf5a3385cd&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}