{"url": "https://towardsdatascience.com/using-ctes-to-improve-sql-queries-dfcb04b7edf0", "time": 1683004330.399425, "path": "towardsdatascience.com/using-ctes-to-improve-sql-queries-dfcb04b7edf0/", "webpage": {"metadata": {"title": "How to use CTEs in SQL. How to use a Common Table Expression to\u2026 | by Jason | Towards Data Science", "h1": "How to use CTEs in SQL", "description": "If you have ever used SQL, you know how important it is when you create a well-written query that would be helpful to use later. Usually, when you query something, you use it once, but there are\u2026"}, "outgoing_paragraph_urls": [{"url": "https://www.sqlservertutorial.net/sql-server-basics/sql-server-cte/", "anchor_text": "CTE", "paragraph_index": 1}, {"url": "https://www.sqlservertutorial.net/sql-server-basics/sql-server-select/", "anchor_text": "SELECT", "paragraph_index": 1}, {"url": "https://www.sqlservertutorial.net/sql-server-basics/sql-server-insert/", "anchor_text": "INSERT", "paragraph_index": 1}, {"url": "https://www.sqlservertutorial.net/sql-server-basics/sql-server-update/", "anchor_text": "UPDATE", "paragraph_index": 1}, {"url": "https://www.sqlservertutorial.net/sql-server-basics/sql-server-delete/", "anchor_text": "DELETE", "paragraph_index": 1}, {"url": "https://www.sqlservertutorial.net/sql-server-basics/sql-server-merge/", "anchor_text": "MERGE", "paragraph_index": 1}, {"url": "https://www.datacamp.com/courses", "anchor_text": "Datacamp\u2019s", "paragraph_index": 3}, {"url": "https://education.github.com/pack", "anchor_text": "GitHub Student Developer Pack", "paragraph_index": 3}, {"url": "https://www.w3schools.com/sql/sql_foreignkey.asp", "anchor_text": "foreign key", "paragraph_index": 19}, {"url": "https://www.linkedin.com/in/jasonmchlee/", "anchor_text": "Linkedin", "paragraph_index": 26}, {"url": "https://github.com/jasonmchlee", "anchor_text": "Github", "paragraph_index": 26}], "all_paragraphs": ["If you have ever used SQL, you know how important it is when you create a well-written query that would be helpful to use later. Usually, when you query something, you use it once, but there are times you need to reference old queries \u2014 this is where Common Table Expressions (CTEs) come in!", "A CTE allows you to define a temporary named result set that available temporarily in the execution scope of a statement such as SELECT, INSERT, UPDATE, DELETE, or MERGE.", "For this tutorial, I will assume you have basic \u2014 intermediate SQL experience. If you don\u2019t, here are some great resources to get started.", "I will be working with a movie database from Datacamp\u2019s SQL course. (If you are a student with an edu email, and want to get three months of free Datacamp visit \u2014 GitHub Student Developer Pack).", "The Movie database consists of the following tables (+ columns):", "We can see looking at the tables and columns; several keys can be used to join the tables together. Below are snapshots of each table.", "As mentioned earlier CTEs are temporarily available in the execution scope of a statement.", "Here is the basic layout of a CTE.", "In the code above, the CTE must start with a WITH. This tells your query that it is a CTE statement. Next, CTE_NAME is the name you want to call it. You can name it anything, but since this is generally used for a reference later, it should make sense. The column_1, column_2, & column_3 are the names you want your columns to be aliased. Finally, the AS, is the start of the SQL statement, which I labeled as #normal SQL query as a note reference.", "Our goal is to write several queries that can be built into a CTE. We are trying to find the following,", "Highest rated IMDB moving in 2014, that had an actor with a name starting with \u2018Matt\u2019", "Immediately we can see the query can be broken down into several parts.", "For this example, we will create two CTEs.", "We will first write a query without the CTE syntax to call all people in the entire database that have \u201cMatt\u201d in their name. We also want to join the roles table to find out the exact film_id that actor was in.", "Now we have a query that calls all Matt\u2019s we can use this later when building the CTE.", "We want to build the next query to find each film in 2014 and join the reviews table to find their IMDB rating.", "We now have all the necessary information from both of our queries to find the answer to find out which movie had the highest IMDB rating with an actor named \u2018Matt.\u2019", "Let\u2019s combine both our previous queries to create this CTE. When we want to add a second CTE in the same statement, we put a comma and add a second AS statement as seen below.", "Our CTE has built and saved the two queries under the alias MATT_cte and IMDB_cte. These aliases will be a reference when we run the final code.", "It is important to note that if you plan on joining the two CTEs, you create later, you will need to have a foreign key in both CTEs. In this case, our foreign keys are film_id in both tables.", "We are all set to use our CTEs and get our answer! Let\u2019s join our new temporary result and find out which movie it is. Reminded, we are trying to get the following. The CTE will need to be referenced in the same query, so we add our final query underneath it.", "Highest rated IMDB moving in 2014, that had an actor with a name starting with \u2018Matt\u2019", "We have successfully found all the names that contain \u201cMatt\u201d in it, movie title, IMDB score, and release year.", "Our final answer would be that Interstellar as the highest-rated IMDB moving in 2014, that had an actor with a name starting with \u2018Matt.\u2019", "I hope you see the value CTEs bring to your SQL queries. It is best used if you plan on calling the same query over and over again. For example, if we only wanted IMDB rated movies with a score higher than 8, we could make a temporary result to make sure that CTE is always available.", "Another method used in SQL that can be helpful is subqueries. I plan on sharing a tutorial on how to use subqueries, so make sure to follow me for more lessons!", "Connect with me on Linkedin or Github", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fdfcb04b7edf0&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-ctes-to-improve-sql-queries-dfcb04b7edf0&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-ctes-to-improve-sql-queries-dfcb04b7edf0&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-ctes-to-improve-sql-queries-dfcb04b7edf0&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-ctes-to-improve-sql-queries-dfcb04b7edf0&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----dfcb04b7edf0--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----dfcb04b7edf0--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@jasonmchlee?source=post_page-----dfcb04b7edf0--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@jasonmchlee?source=post_page-----dfcb04b7edf0--------------------------------", "anchor_text": "Jason"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fd433f083b9c0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-ctes-to-improve-sql-queries-dfcb04b7edf0&user=Jason&userId=d433f083b9c0&source=post_page-d433f083b9c0----dfcb04b7edf0---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fdfcb04b7edf0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-ctes-to-improve-sql-queries-dfcb04b7edf0&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fdfcb04b7edf0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-ctes-to-improve-sql-queries-dfcb04b7edf0&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://www.pexels.com/@punttim?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels", "anchor_text": "Tim Gouw"}, {"url": "https://www.pexels.com/photo/man-in-white-shirt-using-macbook-pro-52608/?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels", "anchor_text": "Pexels"}, {"url": "https://www.sqlservertutorial.net/sql-server-basics/sql-server-cte/", "anchor_text": "CTE"}, {"url": "https://www.sqlservertutorial.net/sql-server-basics/sql-server-select/", "anchor_text": "SELECT"}, {"url": "https://www.sqlservertutorial.net/sql-server-basics/sql-server-insert/", "anchor_text": "INSERT"}, {"url": "https://www.sqlservertutorial.net/sql-server-basics/sql-server-update/", "anchor_text": "UPDATE"}, {"url": "https://www.sqlservertutorial.net/sql-server-basics/sql-server-delete/", "anchor_text": "DELETE"}, {"url": "https://www.sqlservertutorial.net/sql-server-basics/sql-server-merge/", "anchor_text": "MERGE"}, {"url": "https://www.datacamp.com/courses/", "anchor_text": "Datacamp"}, {"url": "https://www.udemy.com/course/sql-for-newbs/", "anchor_text": "Weekender Crash Course"}, {"url": "https://www.udemy.com/course/sqldatabases/", "anchor_text": "Learn MS SQL Server + PostgreSQL"}, {"url": "https://www.datacamp.com/courses", "anchor_text": "Datacamp\u2019s"}, {"url": "https://education.github.com/pack", "anchor_text": "GitHub Student Developer Pack"}, {"url": "https://www.datacamp.com/courses", "anchor_text": "Datacamp"}, {"url": "https://www.datacamp.com/courses", "anchor_text": "Datacamp"}, {"url": "https://www.datacamp.com/courses", "anchor_text": "Datacamp"}, {"url": "https://www.datacamp.com/courses", "anchor_text": "Datacamp"}, {"url": "https://www.w3schools.com/sql/sql_foreignkey.asp", "anchor_text": "foreign key"}, {"url": "https://desktopwalls.net/user/the-master-assassin/", "anchor_text": "The Master Assassin"}, {"url": "https://www.linkedin.com/in/jasonmchlee/", "anchor_text": "Linkedin"}, {"url": "https://github.com/jasonmchlee", "anchor_text": "Github"}, {"url": "https://medium.com/tag/sql?source=post_page-----dfcb04b7edf0---------------sql-----------------", "anchor_text": "Sql"}, {"url": "https://medium.com/tag/data-science?source=post_page-----dfcb04b7edf0---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/analytics?source=post_page-----dfcb04b7edf0---------------analytics-----------------", "anchor_text": "Analytics"}, {"url": "https://medium.com/tag/data-analysis?source=post_page-----dfcb04b7edf0---------------data_analysis-----------------", "anchor_text": "Data Analysis"}, {"url": "https://medium.com/tag/programming?source=post_page-----dfcb04b7edf0---------------programming-----------------", "anchor_text": "Programming"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fdfcb04b7edf0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-ctes-to-improve-sql-queries-dfcb04b7edf0&user=Jason&userId=d433f083b9c0&source=-----dfcb04b7edf0---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fdfcb04b7edf0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-ctes-to-improve-sql-queries-dfcb04b7edf0&user=Jason&userId=d433f083b9c0&source=-----dfcb04b7edf0---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fdfcb04b7edf0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-ctes-to-improve-sql-queries-dfcb04b7edf0&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----dfcb04b7edf0--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fdfcb04b7edf0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-ctes-to-improve-sql-queries-dfcb04b7edf0&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----dfcb04b7edf0---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----dfcb04b7edf0--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----dfcb04b7edf0--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----dfcb04b7edf0--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----dfcb04b7edf0--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----dfcb04b7edf0--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----dfcb04b7edf0--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----dfcb04b7edf0--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----dfcb04b7edf0--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@jasonmchlee?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@jasonmchlee?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Jason"}, {"url": "https://medium.com/@jasonmchlee/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "1.2K Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fd433f083b9c0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-ctes-to-improve-sql-queries-dfcb04b7edf0&user=Jason&userId=d433f083b9c0&source=post_page-d433f083b9c0--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F6a145b757c79&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fusing-ctes-to-improve-sql-queries-dfcb04b7edf0&newsletterV3=d433f083b9c0&newsletterV3Id=6a145b757c79&user=Jason&userId=d433f083b9c0&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}