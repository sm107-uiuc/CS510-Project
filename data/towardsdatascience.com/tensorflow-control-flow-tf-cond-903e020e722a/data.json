{"url": "https://towardsdatascience.com/tensorflow-control-flow-tf-cond-903e020e722a", "time": 1682995887.142967, "path": "towardsdatascience.com/tensorflow-control-flow-tf-cond-903e020e722a/", "webpage": {"metadata": {"title": "TensorFlow Control Flow: tf.cond() | by Hosein Fooladi | Towards Data Science", "h1": "TensorFlow Control Flow: tf.cond()", "description": "Tensorflow is one of the most popular deep learning frameworks and has played a key role in advancing deep learning. I am using Tensorflow for more than two years, but I have seen lots of bizarre and\u2026"}, "outgoing_paragraph_urls": [{"url": "https://youtu.be/IzKXEbpT9Lg", "anchor_text": "video", "paragraph_index": 1}, {"url": "https://stackoverflow.com/questions/46680462/tensorflow-node-which-is-dead", "anchor_text": "here", "paragraph_index": 9}, {"url": "https://www.tensorflow.org/api_docs/python/tf/cond", "anchor_text": "tf.cond()", "paragraph_index": 10}, {"url": "https://www.tensorflow.org/api_docs/python/tf/while_loop", "anchor_text": "tf.while_loop()", "paragraph_index": 10}, {"url": "https://stackoverflow.com/questions/47107994/how-to-use-the-function-merge-and-switch-of-tensorflow", "anchor_text": "this", "paragraph_index": 11}, {"url": "https://towardsdatascience.com/using-tf-print-in-tensorflow-aa26e1cff11e", "anchor_text": "here", "paragraph_index": 32}, {"url": "https://hfooladi.github.io/", "anchor_text": "https://hfooladi.github.io/", "paragraph_index": 40}], "all_paragraphs": ["Tensorflow is one of the most popular deep learning frameworks and has played a key role in advancing deep learning. I am using Tensorflow for more than two years, but I have seen lots of bizarre and unpredictable behavior during using control flow.", "Recently (19 April 2019), I watched a video of TensorFlow team\u2019s own internal training sessions, which was very helpful and make it more clear how control flow ops work. I definitely recommend watching this video.", "The video covers tf.cond() and tf.while_loop in details. So, I decided to write this post to elaborate more on how tf.cond() works, and provide some examples for illustration. Hopefully, I will cover tf.while_loop in the subsequent post.", "Note: I am going to cover low-level operations in this post. There are other ops like Functional ops, which is beyond the scope of this blog post.", "Two important ops that are used during the construction of the graph are Switch and Merge. Therefore, in this section, I am going to introduce how they work and provide some examples for becoming familiar with some of their weird behavior!", "As you can observe, the switch receives two inputs: data and predicate, and provides two outputs: data and dead tensor!. Also, Merge receive two (or more than two) inputs and provides one output which is the data. I am going to go to more details in the following.", "First, let\u2019s consider the switch. If you visit the Tensorflow website, you can find this definition and summary about switch operation:", "Forwards data to the output port determined by pred. If pred is true, the data input is forwarded to output_true. Otherwise, the data goes to output_false.", "As I mentioned before, Switch receives two inputs. One of them is a predicate, which is boolean tensor (true or false), and another one is the data that should be passed. Predicate determines whether the data should be passed by output_true branch or output_false branch. But, one weird stuff here is the concept of the dead tensor. No matter whether the predicate is true or false; always there are two outputs: one of them is data and the other one is the dead tensor. If pred is true, the dead tensor is sent along output_false(and vice versa).", "There is not a clear reference that explains why and how dead tensors are useful, but it seems they are useful for distributed processing, and their existence is an implementation detail. e.g., you can find here one somehow convincing answer:", "First of all, dead tensors are an implementation detail of TensorFlow\u2019s control flow constructs: tf.cond() and tf.while_loop(). These constructs enable TensorFlow to determine whether or not to execute a subgraph based on a data-dependent value.", "Let\u2019s see an example to make things more clear. I have taken inspiration from this post for providing this example.", "So, let\u2019s dive in to see what\u2019s happening in this example. I have created the figure that illustrates what is going on.", "I think it\u2019s clear from the figure what is happening. e.g., in x_0, x_1 = control_flow_ops.switch(tf.constant(1.0), False) , the predicate is false; therefore, tf.constant(1.0) is forwarded to the output_false branch and dead tensor to the output_true branch.", "One important thing to mention is that I have executed the x_0 and x_3 within tf.Session(), which contain the data (tensor). If I try to run and execute the dead tensor, I will face with an error. Whenever you try to execute and retrieve the dead tensor in the Session.run(), it will lead to an error. e.g., the following code raises a famous and frequently occurred error:", "Now, I think it\u2019s enough for Switch. let\u2019s see how Merge operates.", "Merge is another operator which is required for construction of tf.cond() graph.", "Merge can receive more than one inputs, but only one of them must contain the data and others should be the dead tensors. Otherwise, we will face with some random and unpredictable behavior. Let\u2019s see how Merge works in the last example:", "It behaves completely according to our expectation. But, things get a little unexpected and bizarre, when you feed two tensors which have data into the Merge.", "Sometimes, it returns the value of x_0and sometimes the value of x_3. So, be cautious about this behavior.", "Note: Dead tensors propagate through the computational graph until they reach to the Merge ops.", "Now, I think we have a good grasp of how Switch and Merge operate. It is a good time to dive into the tf.cond(). I am considering the simple case, where the input arguments are pred, true_fn, and false_fn.", "I am going to consider a simple example to introduce this concept. consider the following condition:", "I have constructed the computational graph for this simple example, and you can find it in figure 4.", "The first thing to mention is that there is a switch for each input. By input, I mean the arguments of true and false functions within the tf.cond(). In this example, there are three inputs (x, y, and z), and as a result, there are three switches in the computational graph.", "For true_fn, the switch outputs are emitted from the true branch. For false_fn, the switch outputs are emitted from the false branch. Based on the condition result(whether x is smaller than y or not), the predicate can be true or false, and one of the branches (left or right) will be executed. It is important to note that, both tf.add() and tf.square() operations come after the switches. As a result, in this example, only one of them will be executed and the other one remains untouched.", "In addition, I think this picture is a little wrong. I think dead tensors propagate through the add or square operation until they meet the Merge ops. Merge ops remove the dead tensors and only provides one output.", "Hopefully, you have learned something about tf.cond() up to know, and you have become more comfortable for working with this API. I am going to end this post by providing one controversial example and explain how something we have learned so far can help us to understand the inner working. In the TensorFlow website, you can find the following statement:", "WARNING: Any Tensors or Operations created outside of true_fn and false_fn will be executed regardless of which branch is selected at runtime. Although this behavior is consistent with the dataflow model of TensorFlow, it has frequently surprised users who expected a lazier semantics.", "So, I a going to provide an example to clarify what this warning says. I am providing two examples: in the first one all the operations are defined within the true_fn and false_fn, and in the second example, some operations are defined outside this functions. I am going to construct and visualize the computational graph to illustrate why this behavior occurs.", "The important point here to focus on is that all the Tensors and operations have been created inside the functions. So, there are three input arguments and consequently, there exist three switches in the graph. Constructing a computational graph for this case will be easy.", "if the predicate becomes true (x will be smaller than y), the true_fn (left branch) will be executed and the right one does not execute and remain untouched (and Vice versa).", "Note: I have used tf.Print() function in order to print something in the computational graph and have access to the value of a tensor in the graph. Using tf.Print() is a little tricky and I am not going to explain here how it works. There is an excellent blog post about this function here.", "Note: When the predicate is false (x > y), the false_fn (right branch) is executed, and as a result, tf.Print() receives only the dead tensors and does not print anything.", "The example 1 was a little boring and the result was completely what we expected. Things get more interesting in this example.", "In this example, the predicate is false (x > y) and we expect that the false_fn executes and true_fn remains untouched. However, we can see that output contains \u201cThe value I want to print!![6]\u201d which belongs to the true_fn. At first, maybe this behavior seems a little weird, but it is completely consistent with what we have seen and understood so far. Some of the tensors (z and print_output) have defined outside the function and as a result, they will be put before the switch in the computational graph. let\u2019s draw the graph to make this point clear:", "You can see in figure 6 that multiply and prints ops are outside (before) the switches. So, no matter the predicate is true or false, these two operations will be executed in both cases.", "So, by understanding switch and merge and realizing how tf.cond() works, hopefully, you can see this behavior is consistent with the dataflow model of TensorFlow and there is nothing wrong about it.", "I m going to finish this post here. Thanks for reading the post up to the end. Please let me know if I have made a mistake or something is wrong. Hopefully, I am going to cover tf.while_loop() in the subsequent post.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "I like deep learning and it\u2019s connection to cognitive science. Also, I am interested in applying deep learning in drug discovery. https://hfooladi.github.io/"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F903e020e722a&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftensorflow-control-flow-tf-cond-903e020e722a&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftensorflow-control-flow-tf-cond-903e020e722a&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftensorflow-control-flow-tf-cond-903e020e722a&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftensorflow-control-flow-tf-cond-903e020e722a&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----903e020e722a--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----903e020e722a--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@fooladi.hosein?source=post_page-----903e020e722a--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@fooladi.hosein?source=post_page-----903e020e722a--------------------------------", "anchor_text": "Hosein Fooladi"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F2e7938ce915d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftensorflow-control-flow-tf-cond-903e020e722a&user=Hosein+Fooladi&userId=2e7938ce915d&source=post_page-2e7938ce915d----903e020e722a---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F903e020e722a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftensorflow-control-flow-tf-cond-903e020e722a&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F903e020e722a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftensorflow-control-flow-tf-cond-903e020e722a&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://youtu.be/IzKXEbpT9Lg", "anchor_text": "video"}, {"url": "https://stackoverflow.com/questions/46680462/tensorflow-node-which-is-dead", "anchor_text": "here"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/cond", "anchor_text": "tf.cond()"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/while_loop", "anchor_text": "tf.while_loop()"}, {"url": "https://stackoverflow.com/questions/47107994/how-to-use-the-function-merge-and-switch-of-tensorflow", "anchor_text": "this"}, {"url": "https://towardsdatascience.com/using-tf-print-in-tensorflow-aa26e1cff11e", "anchor_text": "here"}, {"url": "https://www.youtube.com/watch?v=IzKXEbpT9Lg&t=907s", "anchor_text": "TensorFlow"}, {"url": "https://stackoverflow.com/questions/46680462/tensorflow-node-which-is-dead", "anchor_text": "Tensorflow, node which is dead"}, {"url": "https://stackoverflow.com/questions/47107994/how-to-use-the-function-merge-and-switch-of-tensorflow", "anchor_text": "How to use the function merge and switch of TensorFlow?"}, {"url": "https://www.tensorflow.org/api_docs/python/tf/cond", "anchor_text": "Official"}, {"url": "https://www.tensorflow.org/api_docs/cc/class/tensorflow/ops/switch", "anchor_text": "documentation"}, {"url": "https://towardsdatascience.com/using-tf-print-in-tensorflow-aa26e1cff11e", "anchor_text": "Using"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----903e020e722a---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/tensorflow?source=post_page-----903e020e722a---------------tensorflow-----------------", "anchor_text": "TensorFlow"}, {"url": "https://medium.com/tag/conditional-statements?source=post_page-----903e020e722a---------------conditional_statements-----------------", "anchor_text": "Conditional Statements"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----903e020e722a---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F903e020e722a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftensorflow-control-flow-tf-cond-903e020e722a&user=Hosein+Fooladi&userId=2e7938ce915d&source=-----903e020e722a---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F903e020e722a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftensorflow-control-flow-tf-cond-903e020e722a&user=Hosein+Fooladi&userId=2e7938ce915d&source=-----903e020e722a---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F903e020e722a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftensorflow-control-flow-tf-cond-903e020e722a&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----903e020e722a--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F903e020e722a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftensorflow-control-flow-tf-cond-903e020e722a&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----903e020e722a---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----903e020e722a--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----903e020e722a--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----903e020e722a--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----903e020e722a--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----903e020e722a--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----903e020e722a--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----903e020e722a--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----903e020e722a--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@fooladi.hosein?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@fooladi.hosein?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Hosein Fooladi"}, {"url": "https://medium.com/@fooladi.hosein/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "57 Followers"}, {"url": "https://hfooladi.github.io/", "anchor_text": "https://hfooladi.github.io/"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F2e7938ce915d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftensorflow-control-flow-tf-cond-903e020e722a&user=Hosein+Fooladi&userId=2e7938ce915d&source=post_page-2e7938ce915d--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fusers%2F2e7938ce915d%2Flazily-enable-writer-subscription&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Ftensorflow-control-flow-tf-cond-903e020e722a&user=Hosein+Fooladi&userId=2e7938ce915d&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}