{"url": "https://towardsdatascience.com/how-to-quickly-build-a-tensorflow-training-pipeline-15e9ae4d78a0", "time": 1682993860.461377, "path": "towardsdatascience.com/how-to-quickly-build-a-tensorflow-training-pipeline-15e9ae4d78a0/", "webpage": {"metadata": {"title": "How to (quickly) Build a Tensorflow Training Pipeline | by Uri Merhav | Towards Data Science", "h1": "How to (quickly) Build a Tensorflow Training Pipeline", "description": "Tensorflow is great. Really, you can do everything imaginable. You can build really cool products with it. However, Tensorflow\u2019s code examples generally tend to gloss over how to get data into your\u2026"}, "outgoing_paragraph_urls": [{"url": "http://www.proproductpix.org/?ref=medium", "anchor_text": "cool products with it", "paragraph_index": 0}, {"url": "http://vis-www.cs.umass.edu/lfw/lfw.tgz", "anchor_text": "here", "paragraph_index": 7}, {"url": "https://github.com/urimerhav/tflow-dataset", "anchor_text": "available on github", "paragraph_index": 15}, {"url": "https://www.proproductpix.org/", "anchor_text": "Pro Product Pix", "paragraph_index": 16}, {"url": "http://proproductpix.org\\", "anchor_text": "here", "paragraph_index": 23}, {"url": "https://www.hosstechnology.com/blog/how-to-quickly-build-a-tensorflow-training-pipeline", "anchor_text": "Hoss Technology tech blog", "paragraph_index": 24}], "all_paragraphs": ["Tensorflow is great. Really, you can do everything imaginable. You can build really cool products with it. However, Tensorflow\u2019s code examples generally tend to gloss over how to get data into your model: they either sometimes naively assume that someone else did the hard work for you and serialized the data into Tensorflow\u2019s native format, or showcase unreasonably slow methods that would have a GPU idling away with shockingly low performance. Also oftentimes the code is very hacky and difficult to follow. So I thought it might be useful to show a small, self contained example that handles both training and efficient data pipelining on a nontrivial example.", "In typical Tensorflow fashion, there are many ways that you could get your data pipeline set up. This guide will quickly list the top 3, and show you how to use a compromise that gets you that go-to solution that is very easy to code and blazingly fast for the for 80% of the use cases.", "Generally Speaking, there are 3 ways in which you can get data into your model:", "Let\u2019s take a look at real-life use case, and build a complex data pipeline that trains blazingly fast on a single machine with potentially high capacity GPU.", "So let\u2019s deal with a concrete example. Let\u2019s imagine that our goal is to build a Face Recognition model. The input to the model are 2 images, and the output is 1 if they\u2019re the same person, and 0 otherwise. Let\u2019s see how a super-naive Tensorflow model might approach this task", "Alright, so this model isn\u2019t going to win any awards for best face recognition in history. We\u2019re just taking the difference between the two images, an feed this difference map through a standard conv-relu-maxpool neural net. If this is gibberish to you, don\u2019t worry: it\u2019s not a a very good approach to compare images anyway. Just take my word for it that it would be at least somewhat capable in identifying photos that are of the same person. All the model needs now is data \u2014 which is the point of our fun little post.", "So what does our data look like?", "A classic (tiny) dataset for face recognition is called labeled faces in the wild which you can download here. The data is quite simple: you got a bunch of folders, and each folders contains photos of the same person, like so:", "One thing we could do is generate all the pairs imaginable, cache them, and feed them to the model. That would be highly and take up all of our memory, since there are 18,984 photos here, and 18,894 squared is\u2026 a lot.", "So, let\u2019s build a very lightweight pythonic function that yields a pair of photos, and indicates whether they\u2019re the same person \u2014 and samples another random pair at each iteration.", "Woah! but didn\u2019t I say python is too slow for a data pipeline? The answer is yes, python is slow, but when it comes to randomly drawing strings and feeding it, it\u2019s snappy enough. The important thing is, that all of the heavy lifting: reading .jpg images from disk, resizing them, batching them, queueing them etc \u2014 that\u2019s all done in pure Tensorflow.", "So now we\u2019re left with building a data pipeline in Tensorflow! Without further ado:", "So basically we start out with a dictionary of the pythonic generator output (3 strings). Let\u2019s break down what happens here:", "Now that everything is set up, simply instantiating a session and calling session.run(element) will automagically get actual values for img1_resized, img2_resized, and label. If we hit session.run(opt_step) then a new piece of data will flow through the pipeline to perform a single optimization step. Here\u2019s a tiny script for fetching one data element, and performing 100 training steps just to see it all works", "When you keep only George Bush and the Dalai Lama as classes, the model converges rather quickly. Here\u2019s the result of this dummy run:", "I hope you\u2019ll find this guide useful. The entire (tiny) code repo is available on github. Feel free to use it however you see fit!", "I\u2019ll probably follow up with a blog more elaborate blog post about it later, but I should note that I recently data training pipeline which I rather like for a small proof of concept site I built called Pro Product Pix as a side project. The concept is simple: E-sellers need to take photos of products, and then have to do a laborious task of removing the background pixels (which is quite tedious!). Why not do that automatically?", "But getting labeled images of products with and without background is very tricky. So: data generator to the rescue! Here\u2019s what I ended up doing:", "So all told we have a bunch of backgrounds like these:", "And we merge them with product photos that have no background", "There\u2019s a bunch of small problems to solve here. For exmaple, the backgrounds are usually much bigger than the product photo, so we need to crop the background photo to the product size, and then merge the two photos. The entire pipeline is a tad complicated as it wasn\u2019t written with a tutorial in mind, but I\u2019ll put the highlight snippets here. We have a generator that yields background path + product path", "We load the background as an rgb image, and the object png actually has both an rgb image and what we call a transparency map (which we call object_pixels: it tells us which pixels belong to the background and which belong to the object). Then inside our dataset.map operation, we crop a random piece of background, and blend it with the foreground.", "The results are pretty neat \u2014 sometimes. Here\u2019s one before/after pic I rather like, though it\u2019s still not 100% perfect:", "I hope I\u2019ll find the time someday to write more about the actual model used. You can play around with the model on the site here, but be forewarned \u2014 this basically only works on pictures that resemble real product photos. Anything else, it\u2019s garbage in \u2014 garbage out!", "Originally posted on Hoss Technology tech blog (that\u2019s my ML consulting company)", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Deep Learning Consultant Based in San Francisco. Former LinkedIn Staff ML Engineer"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F15e9ae4d78a0&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-quickly-build-a-tensorflow-training-pipeline-15e9ae4d78a0&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-quickly-build-a-tensorflow-training-pipeline-15e9ae4d78a0&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-quickly-build-a-tensorflow-training-pipeline-15e9ae4d78a0&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-quickly-build-a-tensorflow-training-pipeline-15e9ae4d78a0&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----15e9ae4d78a0--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----15e9ae4d78a0--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://urimerhav.medium.com/?source=post_page-----15e9ae4d78a0--------------------------------", "anchor_text": ""}, {"url": "https://urimerhav.medium.com/?source=post_page-----15e9ae4d78a0--------------------------------", "anchor_text": "Uri Merhav"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F2dc5253a1da3&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-quickly-build-a-tensorflow-training-pipeline-15e9ae4d78a0&user=Uri+Merhav&userId=2dc5253a1da3&source=post_page-2dc5253a1da3----15e9ae4d78a0---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F15e9ae4d78a0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-quickly-build-a-tensorflow-training-pipeline-15e9ae4d78a0&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F15e9ae4d78a0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-quickly-build-a-tensorflow-training-pipeline-15e9ae4d78a0&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "http://www.proproductpix.org/?ref=medium", "anchor_text": "cool products with it"}, {"url": "https://realpython.com/python-gil/", "anchor_text": "GIL"}, {"url": "https://medium.com/mostly-ai/tensorflow-records-what-they-are-and-how-to-use-them-c46bc4bbb564", "anchor_text": "here"}, {"url": "http://vis-www.cs.umass.edu/lfw/lfw.tgz", "anchor_text": "here"}, {"url": "https://github.com/urimerhav/tflow-dataset", "anchor_text": "available on github"}, {"url": "https://www.proproductpix.org/", "anchor_text": "Pro Product Pix"}, {"url": "http://proproductpix.org\\", "anchor_text": "here"}, {"url": "https://www.hosstechnology.com/blog/how-to-quickly-build-a-tensorflow-training-pipeline", "anchor_text": "Hoss Technology tech blog"}, {"url": "https://medium.com/tag/tensorflow?source=post_page-----15e9ae4d78a0---------------tensorflow-----------------", "anchor_text": "TensorFlow"}, {"url": "https://medium.com/tag/machine-leraning?source=post_page-----15e9ae4d78a0---------------machine_leraning-----------------", "anchor_text": "Machine Leraning"}, {"url": "https://medium.com/tag/deep-learning?source=post_page-----15e9ae4d78a0---------------deep_learning-----------------", "anchor_text": "Deep Learning"}, {"url": "https://medium.com/tag/data-science?source=post_page-----15e9ae4d78a0---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/programming?source=post_page-----15e9ae4d78a0---------------programming-----------------", "anchor_text": "Programming"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F15e9ae4d78a0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-quickly-build-a-tensorflow-training-pipeline-15e9ae4d78a0&user=Uri+Merhav&userId=2dc5253a1da3&source=-----15e9ae4d78a0---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F15e9ae4d78a0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-quickly-build-a-tensorflow-training-pipeline-15e9ae4d78a0&user=Uri+Merhav&userId=2dc5253a1da3&source=-----15e9ae4d78a0---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F15e9ae4d78a0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-quickly-build-a-tensorflow-training-pipeline-15e9ae4d78a0&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----15e9ae4d78a0--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F15e9ae4d78a0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-quickly-build-a-tensorflow-training-pipeline-15e9ae4d78a0&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----15e9ae4d78a0---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----15e9ae4d78a0--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----15e9ae4d78a0--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----15e9ae4d78a0--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----15e9ae4d78a0--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----15e9ae4d78a0--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----15e9ae4d78a0--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----15e9ae4d78a0--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----15e9ae4d78a0--------------------------------", "anchor_text": ""}, {"url": "https://urimerhav.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://urimerhav.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Uri Merhav"}, {"url": "https://urimerhav.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "426 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F2dc5253a1da3&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-quickly-build-a-tensorflow-training-pipeline-15e9ae4d78a0&user=Uri+Merhav&userId=2dc5253a1da3&source=post_page-2dc5253a1da3--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fusers%2F2dc5253a1da3%2Flazily-enable-writer-subscription&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-quickly-build-a-tensorflow-training-pipeline-15e9ae4d78a0&user=Uri+Merhav&userId=2dc5253a1da3&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}