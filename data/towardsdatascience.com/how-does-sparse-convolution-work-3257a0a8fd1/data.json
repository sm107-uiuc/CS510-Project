{"url": "https://towardsdatascience.com/how-does-sparse-convolution-work-3257a0a8fd1", "time": 1683018267.99369, "path": "towardsdatascience.com/how-does-sparse-convolution-work-3257a0a8fd1/", "webpage": {"metadata": {"title": "How does sparse convolution work? | by Zhiliang Zhou | Towards Data Science", "h1": "How does sparse convolution work?", "description": "Sparse Convolution plays an essential role in LiDAR signal processing. This article describes how the sparse convolution works, which used a quite different concept and GPU calculation schema\u2026"}, "outgoing_paragraph_urls": [{"url": "https://arxiv.org/pdf/1711.10275.pdf", "anchor_text": "3D Semantic Segmentation with Submanifold Sparse Convolutional Networks", "paragraph_index": 1}, {"url": "https://pdfs.semanticscholar.org/5125/a16039cabc6320c908a4764f32596e018ad3.pdf", "anchor_text": "SECOND: Sparsely Embedded Convolutional Detection", "paragraph_index": 1}, {"url": "https://arxiv.org/abs/1711.10275", "anchor_text": "3d semantic segmentation with submanifold sparse convolutional networks", "paragraph_index": 27}, {"url": "https://pdfs.semanticscholar.org/5125/a16039cabc6320c908a4764f32596e018ad3.pdf", "anchor_text": "Second: Sparsely embedded convolutional detection", "paragraph_index": 27}, {"url": "https://arxiv.org/abs/1901.08373", "anchor_text": "Three-dimensional Backbone Network for 3D Object Detection in Traffic Scenes", "paragraph_index": 27}, {"url": "https://github.com/masszhou/spconv_lite", "anchor_text": "https://github.com/masszhou/spconv_lite", "paragraph_index": 27}, {"url": "https://cs231n.github.io/convolutional-networks/", "anchor_text": "https://cs231n.github.io/convolutional-networks/", "paragraph_index": 27}, {"url": "https://github.com/masszhou/second_lite", "anchor_text": "https://github.com/masszhou/second_lite", "paragraph_index": 27}, {"url": "http://www.cvlibs.net/datasets/kitti/", "anchor_text": "Are we ready for autonomous driving? the kitti vision benchmark suite", "paragraph_index": 27}], "all_paragraphs": ["Sparse Convolution plays an essential role in LiDAR signal processing. This article describes how the sparse convolution works, which used a quite different concept and GPU calculation schema compared with traditional convolution.", "In this article, the theory part is based on the paper \u201c3D Semantic Segmentation with Submanifold Sparse Convolutional Networks\u201d [1]. The implementation part, i.e. SpConv() is based on the paper \u201cSECOND: Sparsely Embedded Convolutional Detection\u201d [2]. In [3], the author made a more general discussion about sparse convolution.", "Convolutional Neural Network(CNN) has been proved very effective for 2D image signal processing. However, for 3D point cloud signals, the extra dimension Z increases the calculation significantly. On the other hand, unlike regular images, most of the voxels of the 3D point cloud are empty, which makes point cloud data in the 3D voxels often sparse signals.", "The question is whether we can only calculate the convolution with the sparse data efficiently instead of scanning all the image pixels or spatial voxels.", "One intuitive thinking is, regular image signals are stored as matrix or tensor. And the corresponding convolution was calculated as dense matrix multiplication. The sparse signals are normally represented as data lists and index lists. We could develop a special convolution schema that uses the advantage of sparse signal representation.", "In a short, the traditional convolution uses FFT or im2col [5] to build the computational pipeline. Sparse Convolution collects all atomic operations w.r.t convolution kernel elements and saves them in a Rulebook as instructions of computation.", "Below is an example, which explains how sparse convolution works.", "In order to explain the concept of sparse convolution step by step and let it easier to read, I use 2D sparse image processing as an example. Since the sparse signals are represented with data list and index list, 2D and 3D sparse signals have no essential difference.", "The convolution kernel of sparse convolution is the same as traditional convolution. Fig.3 is an example, which has kernel size 3x3. The dark and light colors stand for 2 filters. In this example, we use the following convolution parameters.", "The output of the sparse convolution is quite different from traditional convolution. The sparse convolution has 2 kinds of output definitions [1]. One is regular output definition, just like ordinary convolution, calculate the output sites as long as kernel covers an input site. The other one is called the submanifold output definition. the convolution output will be counted only when the kernel center covers an input site.", "Fig.4 illustrates the difference between these two kinds of outputs. A1 stands for the active output sites, i.e. the convolution result from P1. Similarly, A2 stands for the active output sites which are calculated from P2. A1A2 stands for the active output sites which are the sum of outputs from P1 and P2. Dark and light colors stand for different output channels.", "So in dense form, the output tensor has a shape [1x2x3x3] with NCHW order. In sparse form, the output has two lists, a data list, and an index list, which are similar to the input representation.", "Traditional convolution normally uses im2col [5] to rewrite convolution as a dense matrix multiplication problem. However, sparse convolution [1] uses a Rulebook to schedule all atomic operations instead of im2col.", "The first step is to build hash tables.", "In fig.5, the input hash table stores all active input sites. Then we estimated all possible active output sites, considering either regular output definition or submanifold output definition. At last, using the output hash table to record all involved active output sites.", "Note, in fig.5 my convention is not very clear, the v is more like a hash key, and the key is more like a hash value. However, neither of them has duplicate elements. Thus which one should be the key depends on the program.", "The second step is to build the Rulebook. This is the key part of sparse convolution. The purpose of Rulebook is similar to im2col [5], which converts convolution from mathematic form to an efficient programmable form. But unlike im2col, Rulebook collects all involved atomic operation in convolution, then associate them to corresponding kernel elements.", "Fig.6 is an example of how to build Rulebook. P\u1d62\u2099 has the input sites index. In this example, we have two nonzero data at position (2, 1) and (3, 2). P\u2092\u1d64\u209c has the corresponding output sites index. Then we collect the atomic operations from the convolution calculation process, i.e. consider the convolution process as many atomic operations w.r.t kernel elements. At last, we record all atomic operations into Rulebook. In Fig.6 the right table is an example of the Rulebook. The first column is the kernel element index. The second column is a counter and index about how many atomic operations this kernel element involves. The third and fourth column is about the source and result of this atomic operation.", "The last step is the overview of the programming calculation pipeline.", "As Fig.7 illustrates, we calculate the convolution, not like the sliding window approach but calculate all the atomic operations according to Rulebook. In Fig.7 red and blue arrows indicate two examples.", "In Fig.7 red and blue arrows indicate two calculation instances. The red arrow processes the first atomic operation for kernel element (-1, -1). From Rulebook, we know this atomic operation has input from P1 with position (2, 1) and has output with position (2, 1). This entire atomic operation can be constructed as Fig. 8.", "Similarly, the blue arrow indicates another atomic operation, which shares the same output site. The result from the red arrow instance and the blue arrow instance can be added together.", "However, in practice, the neural network calculates the sum of the linear transformation with activation function like f(\u2211 w\u1d62 x\u1d62 +b). So we don\u2019t really need the hash table for active output sites, just sum all of the atomic operation results together.", "The computation w.r.t the Rulebook can be parallel launched in GPU.", "So the sparse convolution is quite efficient because we do not need to scan all the pixels or spatial voxels. We only calculate convolution for the nonzero elements. We use Rulebook instead of im2col to rewrite the sparse convolution into a compact linear transformation problem, or we say a compact matrix multiplication problem. One additional computation cost is building the Rulebook. Fortunately, this building work can be also parallel processed with GPU.", "At last, I wrote a SpConv Lite library [4], which was derived from [2]. It was implemented by CUDA and packaged into a python library. I also made a real-time LiDAR object detector [6] based on SpConv Lite.", "I wrote this article when my living city Dresden is under lockdown. Merry Christmas 2020 and Happy new year 2021. Hope everyone keeps healthy. Hope 2021 will be a better year.", "[1] Graham, Benjamin, Martin Engelcke, and Laurens Van Der Maaten. \u201c3d semantic segmentation with submanifold sparse convolutional networks.\u201d Proceedings of the IEEE conference on computer vision and pattern recognition. 2018.[2] Yan, Yan, Yuxing Mao, and Bo Li. \u201cSecond: Sparsely embedded convolutional detection.\u201d Sensors 18.10 (2018): 3337.[3] Li, Xuesong, et al. \u201cThree-dimensional Backbone Network for 3D Object Detection in Traffic Scenes.\u201d arXiv preprint arXiv:1901.08373 (2019).[4] SpConv Lite by the author. https://github.com/masszhou/spconv_lite[5] im2col, Convolution implementation as Matrix Multiplication https://cs231n.github.io/convolutional-networks/[6] Real-time 3D voxel-based LiDAR object detector by the author. https://github.com/masszhou/second_lite[7] Geiger, Andreas, Philip Lenz, and Raquel Urtasun. \u201cAre we ready for autonomous driving? the kitti vision benchmark suite.\u201d 2012 IEEE Conference on Computer Vision and Pattern Recognition. IEEE, 2012.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F3257a0a8fd1&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-sparse-convolution-work-3257a0a8fd1&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-sparse-convolution-work-3257a0a8fd1&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-sparse-convolution-work-3257a0a8fd1&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-sparse-convolution-work-3257a0a8fd1&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----3257a0a8fd1--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----3257a0a8fd1--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://zhouzhiliang.medium.com/?source=post_page-----3257a0a8fd1--------------------------------", "anchor_text": ""}, {"url": "https://zhouzhiliang.medium.com/?source=post_page-----3257a0a8fd1--------------------------------", "anchor_text": "Zhiliang Zhou"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F46a18ebb403f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-sparse-convolution-work-3257a0a8fd1&user=Zhiliang+Zhou&userId=46a18ebb403f&source=post_page-46a18ebb403f----3257a0a8fd1---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F3257a0a8fd1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-sparse-convolution-work-3257a0a8fd1&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F3257a0a8fd1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-sparse-convolution-work-3257a0a8fd1&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://arxiv.org/pdf/1711.10275.pdf", "anchor_text": "3D Semantic Segmentation with Submanifold Sparse Convolutional Networks"}, {"url": "https://pdfs.semanticscholar.org/5125/a16039cabc6320c908a4764f32596e018ad3.pdf", "anchor_text": "SECOND: Sparsely Embedded Convolutional Detection"}, {"url": "https://arxiv.org/abs/1901.08373", "anchor_text": "3"}, {"url": "https://arxiv.org/abs/1711.10275", "anchor_text": "1"}, {"url": "https://arxiv.org/abs/1711.10275", "anchor_text": "3d semantic segmentation with submanifold sparse convolutional networks"}, {"url": "https://pdfs.semanticscholar.org/5125/a16039cabc6320c908a4764f32596e018ad3.pdf", "anchor_text": "Second: Sparsely embedded convolutional detection"}, {"url": "https://arxiv.org/abs/1901.08373", "anchor_text": "Three-dimensional Backbone Network for 3D Object Detection in Traffic Scenes"}, {"url": "https://github.com/masszhou/spconv_lite", "anchor_text": "https://github.com/masszhou/spconv_lite"}, {"url": "https://cs231n.github.io/convolutional-networks/", "anchor_text": "https://cs231n.github.io/convolutional-networks/"}, {"url": "https://github.com/masszhou/second_lite", "anchor_text": "https://github.com/masszhou/second_lite"}, {"url": "http://www.cvlibs.net/datasets/kitti/", "anchor_text": "Are we ready for autonomous driving? the kitti vision benchmark suite"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----3257a0a8fd1---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/lidar?source=post_page-----3257a0a8fd1---------------lidar-----------------", "anchor_text": "Lidar"}, {"url": "https://medium.com/tag/neural-networks?source=post_page-----3257a0a8fd1---------------neural_networks-----------------", "anchor_text": "Neural Networks"}, {"url": "https://medium.com/tag/gpu?source=post_page-----3257a0a8fd1---------------gpu-----------------", "anchor_text": "Gpu"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F3257a0a8fd1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-sparse-convolution-work-3257a0a8fd1&user=Zhiliang+Zhou&userId=46a18ebb403f&source=-----3257a0a8fd1---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F3257a0a8fd1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-sparse-convolution-work-3257a0a8fd1&user=Zhiliang+Zhou&userId=46a18ebb403f&source=-----3257a0a8fd1---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F3257a0a8fd1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-sparse-convolution-work-3257a0a8fd1&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----3257a0a8fd1--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F3257a0a8fd1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-sparse-convolution-work-3257a0a8fd1&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----3257a0a8fd1---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----3257a0a8fd1--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----3257a0a8fd1--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----3257a0a8fd1--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----3257a0a8fd1--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----3257a0a8fd1--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----3257a0a8fd1--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----3257a0a8fd1--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----3257a0a8fd1--------------------------------", "anchor_text": ""}, {"url": "https://zhouzhiliang.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://zhouzhiliang.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Zhiliang Zhou"}, {"url": "https://zhouzhiliang.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "31 Followers"}, {"url": "https://www.linkedin.com/in/zhiliang-zhou/", "anchor_text": "https://www.linkedin.com/in/zhiliang-zhou/"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F46a18ebb403f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-sparse-convolution-work-3257a0a8fd1&user=Zhiliang+Zhou&userId=46a18ebb403f&source=post_page-46a18ebb403f--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F67b547ba0434&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-does-sparse-convolution-work-3257a0a8fd1&newsletterV3=46a18ebb403f&newsletterV3Id=67b547ba0434&user=Zhiliang+Zhou&userId=46a18ebb403f&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}