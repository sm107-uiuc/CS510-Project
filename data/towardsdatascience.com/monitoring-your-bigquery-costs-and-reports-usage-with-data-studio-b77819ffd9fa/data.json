{"url": "https://towardsdatascience.com/monitoring-your-bigquery-costs-and-reports-usage-with-data-studio-b77819ffd9fa", "time": 1683014260.909058, "path": "towardsdatascience.com/monitoring-your-bigquery-costs-and-reports-usage-with-data-studio-b77819ffd9fa/", "webpage": {"metadata": {"title": "Monitoring your BigQuery costs and reports usage with Data Studio | by \ud83d\udca1Mike Shakhomirov | Towards Data Science", "h1": "Monitoring your BigQuery costs and reports usage with Data Studio", "description": "If you are a BigQuery user and you visualise your data with Data Studio then you might want to answer the following questions: In this article I will talk you through the complete process of setting\u2026"}, "outgoing_paragraph_urls": [{"url": "https://datastudio.google.com/u/0/reporting/de01deda-04d8-4d74-a90e-5038e94ddd9c/page/FQ1YB/preview", "anchor_text": "template", "paragraph_index": 6}, {"url": "https://cloud.google.com/logging/docs/audit/", "anchor_text": "Cloud Audit Log", "paragraph_index": 7}, {"url": "https://cloud.google.com/logging/docs/audit/", "anchor_text": "Logging", "paragraph_index": 9}, {"url": "https://cloud.google.com/logging/docs/export/configure_export_v2", "anchor_text": "here", "paragraph_index": 9}, {"url": "https://cloud.google.com/bigquery/docs/cached-results", "anchor_text": "https://cloud.google.com/bigquery/docs/cached-results", "paragraph_index": 25}, {"url": "https://console.cloud.google.com/iam-admin/iam", "anchor_text": "IAM", "paragraph_index": 30}, {"url": "https://cloud.google.com/bigquery/docs/access-control", "anchor_text": "https://cloud.google.com/bigquery/docs/access-control", "paragraph_index": 31}, {"url": "https://console.cloud.google.com/monitoring/dashboards", "anchor_text": "Dashboards", "paragraph_index": 34}, {"url": "https://cloud.google.com/monitoring/api/ref_v3/rest/v3/projects.alertPolicies?_ga=2.148405559.-181916626.1572688026#Aligner", "anchor_text": "Aligner", "paragraph_index": 35}, {"url": "https://console.cloud.google.com/monitoring/alerting", "anchor_text": "Alerting", "paragraph_index": 36}, {"url": "http://linktr.ee/mshakhomirov", "anchor_text": "linktr.ee/mshakhomirov", "paragraph_index": 45}], "all_paragraphs": ["If you are a BigQuery user and you visualise your data with Data Studio then you might want to answer the following questions:", "Standard Google Billing dashboard won\u2019t answer these questions.", "According to official Google docs at the moment you can\u2019t use labels for BigQuery jobs.", "But what if we want to know who exactly ran the query and HOW MUCH it cost us?", "In this article I will talk you through the complete process of setting up BigQuery cost monitoring dashboard.", "I used standard Google Ads template from Google Data Studio. I think it looks nice and I slightly changed it for my needs.", "If you want you can just copy the template with all relevant settings and widgets included. Just adjust the datsource (create your own) for each widget as shown below in bq_cost_analysis.sql", "In this article I will use Cloud Audit Log for BigQuery. We\u2019ll use these events data, export it to BigQuery and analyse it.", "Google-recommended best practice is to use custom log based metrics.", "Go to Logging and create a sink. Read more about creating sinks here.", "This will output all BigQuery `query_job_completed` log events from Cloud Audit Log service into your BigQuery table.", "In this way you can export any logs for further analysis which I find very useful.", "Note that only new logs will be exported but you can also filter and narrow down the logs you are investigating in Logging console:", "So now when I have BigQuery event data flowing into my logs dataset I will create a view based on the data I have:", "And that\u2019s the bit we need to calculate BigQuery costs (per query or a job):", "We can simply multiply then: cost per TB processed * numbers of TB processed.", "It is a custom query bq_cost_analysis.sql:", "Now we have processedBytes with associated cost per user and per query nicely grouped:", "You probably noticed me adding a query tag in bq_cost_analysis.sql", "That\u2019s a little trick that will help with cost groupings and let us use actual labels (which are currently not supported).", "Simply adjust that SQL and add a column for your tagged query. It can be anything, a report in Data Studio, table name or a scheduled query:", "Or something like this might work even better:", "Of course, you can aggregate costs by query too.", "If you set the table at the bottom to display only one record (one query) per page that would make query cost analysis realy simple.", "Adding sliders for hour and minute can also be very useful.", "Another interesting thing. Cache. If you want to save money you should enable prefetch caching in Data Studio report you must use owner's credentials and enable Cache option (data freshness). Read more about cache here: https://cloud.google.com/bigquery/docs/cached-results", "In this case if you share an access to your report with any other users they will be using your credentials to access the data and what you will see in your cost report is only your account name.", "If you want to enable other users for your cost reports you should use Viewer's credentials and grant them access to underlying datasets too.", "I find it really annoying but this is how it works in Data Studio.", "If you are using Viewer\u2019s credential in Data Studio you will need this.", "Let\u2019s go to IAM roles and create the role called Data Studio User. For that we will need permissions to view and list tables in the datasets. You can simply add predefined BigQuery Data Viewer role.", "To run reports from Data Studio we will also need BigQuery Job User role which adds bigquery.jobs.create permission. Read more about predefined roles here: https://cloud.google.com/bigquery/docs/access-control", "Now you can assign this role to any user to let them use Viewer\u2019s credentials in Data Studio. Just click on the dataset name and click Share dataset. This fits into Google best security practice when only minimum scope of permissions is granted.", "I also want to be notified in case of a sudden surge in billed bytes amount.", "To create this Alert first go to Dashboards, click Add chart and select Scanned Bytes Billed:", "Select Aggregator and Aligner to Sum. An Aggregator describes how to aggregate data points across multiple time series and in case you have labels to use in Group By. Aligner describes how to bring the data points in each individual time series into equal periods of time. Read more about Aligner.", "Now let\u2019s go to Google Alerting and create a policy:", "Let\u2019s call it \u2018Last 15 minutes BilledBytes exceed 1Gb\u2019 so we will be getting alerts every time total amount of billed bytes exceeds 1Gb over any of 15 minute windows:", "Now if we run any query/queries (including Data Studio reports) where SUM of Total Billed Bytes exceeds the threshold over the last 15 minutes the system will notify us.", "Let\u2019s run a query that exceeds this threashold and see if that worked:", "You should receive an email alert. It worked:", "You can also set alerts for number of slots in use and Query execution time, for example, in a similar way.", "Now you have a beautiful cost monitoring dashboard where you can see your BigQuery costs associated to each Data Studio report allowing you to go deeper and beyond basic dataset level reporting in Google Cloud Billing.", "Thanks for reading and let me know if you have any questions.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "BigData Engineer | Full stack dev | I write about ML/AI in Digital marketing. | linktr.ee/mshakhomirov | @MShakhomirov"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fb77819ffd9fa&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmonitoring-your-bigquery-costs-and-reports-usage-with-data-studio-b77819ffd9fa&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmonitoring-your-bigquery-costs-and-reports-usage-with-data-studio-b77819ffd9fa&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmonitoring-your-bigquery-costs-and-reports-usage-with-data-studio-b77819ffd9fa&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmonitoring-your-bigquery-costs-and-reports-usage-with-data-studio-b77819ffd9fa&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----b77819ffd9fa--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----b77819ffd9fa--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://mshakhomirov.medium.com/?source=post_page-----b77819ffd9fa--------------------------------", "anchor_text": ""}, {"url": "https://mshakhomirov.medium.com/?source=post_page-----b77819ffd9fa--------------------------------", "anchor_text": "\ud83d\udca1Mike Shakhomirov"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fe06a48b3dd48&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmonitoring-your-bigquery-costs-and-reports-usage-with-data-studio-b77819ffd9fa&user=%F0%9F%92%A1Mike+Shakhomirov&userId=e06a48b3dd48&source=post_page-e06a48b3dd48----b77819ffd9fa---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fb77819ffd9fa&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmonitoring-your-bigquery-costs-and-reports-usage-with-data-studio-b77819ffd9fa&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fb77819ffd9fa&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmonitoring-your-bigquery-costs-and-reports-usage-with-data-studio-b77819ffd9fa&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://cloud.google.com/bigquery/docs/filtering-labels", "anchor_text": "https://cloud.google.com/bigquery/docs/filtering-labels"}, {"url": "https://datastudio.google.com/u/0/reporting/de01deda-04d8-4d74-a90e-5038e94ddd9c/page/FQ1YB/preview", "anchor_text": "template"}, {"url": "https://cloud.google.com/", "anchor_text": "Google Cloud Platform"}, {"url": "https://cloud.google.com/logging/docs/audit/", "anchor_text": "Cloud Audit Log"}, {"url": "https://cloud.google.com/logging/docs/audit/", "anchor_text": "Logging"}, {"url": "https://cloud.google.com/logging/docs/export/configure_export_v2", "anchor_text": "here"}, {"url": "https://cloud.google.com/bigquery/docs/cached-results", "anchor_text": "https://cloud.google.com/bigquery/docs/cached-results"}, {"url": "https://developers.google.com/datastudio/solution/blocks/enforce-viewer-creds", "anchor_text": "https://developers.google.com/datastudio/solution/blocks/enforce-viewer-creds"}, {"url": "https://console.cloud.google.com/iam-admin/iam", "anchor_text": "IAM"}, {"url": "https://cloud.google.com/bigquery/docs/access-control", "anchor_text": "https://cloud.google.com/bigquery/docs/access-control"}, {"url": "https://console.cloud.google.com/monitoring/dashboards", "anchor_text": "Dashboards"}, {"url": "https://cloud.google.com/monitoring/api/ref_v3/rest/v3/projects.alertPolicies?_ga=2.148405559.-181916626.1572688026#Aligner", "anchor_text": "Aligner"}, {"url": "https://console.cloud.google.com/monitoring/alerting", "anchor_text": "Alerting"}, {"url": "https://cloud.google.com/monitoring/alerts/using-alerting-ui#create-policy", "anchor_text": "https://cloud.google.com/monitoring/alerts/using-alerting-ui#create-policy"}, {"url": "https://cloud.google.com/blog/products/data-analytics/taking-a-practical-approach-to-bigquery-cost-monitoring", "anchor_text": "https://cloud.google.com/blog/products/data-analytics/taking-a-practical-approach-to-bigquery-cost-monitoring"}, {"url": "https://cloud.google.com/bigquery/docs/access-control?_ga=2.51607977.-181916626.1572688026", "anchor_text": "https://cloud.google.com/bigquery/docs/access-control?_ga=2.51607977.-181916626.1572688026"}, {"url": "https://cloud.google.com/logging/docs/export", "anchor_text": "https://cloud.google.com/logging/docs/export"}, {"url": "https://cloud.google.com/bigquery/docs/monitoring", "anchor_text": "https://cloud.google.com/bigquery/docs/monitoring"}, {"url": "https://cloud.google.com/bigquery/docs/controlling-costs", "anchor_text": "https://cloud.google.com/bigquery/docs/controlling-costs"}, {"url": "https://cloud.google.com/bigquery/docs/best-practices-costs", "anchor_text": "https://cloud.google.com/bigquery/docs/best-practices-costs"}, {"url": "https://medium.com/google-cloud/visualize-gcp-billing-using-bigquery-and-data-studio-d3e695f90c08", "anchor_text": "https://medium.com/google-cloud/visualize-gcp-billing-using-bigquery-and-data-studio-d3e695f90c08"}, {"url": "https://support.google.com/cloud/answer/7233314?hl=en", "anchor_text": "https://support.google.com/cloud/answer/7233314?hl=en"}, {"url": "https://cloud.google.com/billing/docs/how-to/export-data-bigquery-setup?hl=en", "anchor_text": "https://cloud.google.com/billing/docs/how-to/export-data-bigquery-setup?hl=en"}, {"url": "https://cloud.google.com/bigquery/docs/cached-results", "anchor_text": "https://cloud.google.com/bigquery/docs/cached-results"}, {"url": "https://medium.com/tag/big-data?source=post_page-----b77819ffd9fa---------------big_data-----------------", "anchor_text": "Big Data"}, {"url": "https://medium.com/tag/data-science?source=post_page-----b77819ffd9fa---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/data-visualization?source=post_page-----b77819ffd9fa---------------data_visualization-----------------", "anchor_text": "Data Visualization"}, {"url": "https://medium.com/tag/data-engineering?source=post_page-----b77819ffd9fa---------------data_engineering-----------------", "anchor_text": "Data Engineering"}, {"url": "https://medium.com/tag/analytics?source=post_page-----b77819ffd9fa---------------analytics-----------------", "anchor_text": "Analytics"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fb77819ffd9fa&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmonitoring-your-bigquery-costs-and-reports-usage-with-data-studio-b77819ffd9fa&user=%F0%9F%92%A1Mike+Shakhomirov&userId=e06a48b3dd48&source=-----b77819ffd9fa---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fb77819ffd9fa&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmonitoring-your-bigquery-costs-and-reports-usage-with-data-studio-b77819ffd9fa&user=%F0%9F%92%A1Mike+Shakhomirov&userId=e06a48b3dd48&source=-----b77819ffd9fa---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fb77819ffd9fa&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmonitoring-your-bigquery-costs-and-reports-usage-with-data-studio-b77819ffd9fa&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----b77819ffd9fa--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fb77819ffd9fa&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmonitoring-your-bigquery-costs-and-reports-usage-with-data-studio-b77819ffd9fa&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----b77819ffd9fa---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----b77819ffd9fa--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----b77819ffd9fa--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----b77819ffd9fa--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----b77819ffd9fa--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----b77819ffd9fa--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----b77819ffd9fa--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----b77819ffd9fa--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----b77819ffd9fa--------------------------------", "anchor_text": ""}, {"url": "https://mshakhomirov.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://mshakhomirov.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "\ud83d\udca1Mike Shakhomirov"}, {"url": "https://mshakhomirov.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "2.2K Followers"}, {"url": "http://linktr.ee/mshakhomirov", "anchor_text": "linktr.ee/mshakhomirov"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fe06a48b3dd48&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmonitoring-your-bigquery-costs-and-reports-usage-with-data-studio-b77819ffd9fa&user=%F0%9F%92%A1Mike+Shakhomirov&userId=e06a48b3dd48&source=post_page-e06a48b3dd48--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F9d2ef9c7b433&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fmonitoring-your-bigquery-costs-and-reports-usage-with-data-studio-b77819ffd9fa&newsletterV3=e06a48b3dd48&newsletterV3Id=9d2ef9c7b433&user=%F0%9F%92%A1Mike+Shakhomirov&userId=e06a48b3dd48&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}