{"url": "https://towardsdatascience.com/how-to-read-bigquery-data-from-tensorflow-2-0-efficiently-9234b69165c8", "time": 1683003681.721272, "path": "towardsdatascience.com/how-to-read-bigquery-data-from-tensorflow-2-0-efficiently-9234b69165c8/", "webpage": {"metadata": {"title": "How to read BigQuery data from TensorFlow 2.0 efficiently | by Lak Lakshmanan | Towards Data Science", "h1": "How to read BigQuery data from TensorFlow 2.0 efficiently", "description": "TensorFlow\u2019s BigQueryClient uses the Storage API to efficiently read data directly out of BigQuery storage (i.e., without having to issue a BigQuery query). In this article, I show you how to use\u2026"}, "outgoing_paragraph_urls": [{"url": "https://github.com/tensorflow/io/tree/master/tensorflow_io/bigquery", "anchor_text": "BigQueryClient", "paragraph_index": 0}, {"url": "https://github.com/GoogleCloudPlatform/training-data-analyst/blob/master/blogs/bigquery_datascience/bigquery_tensorflow.ipynb", "anchor_text": "notebook on GitHub.", "paragraph_index": 0}, {"url": "https://github.com/tensorflow/io/tree/master/tensorflow_io/bigquery", "anchor_text": "BigQueryClient", "paragraph_index": 5}, {"url": "https://towardsdatascience.com/how-to-build-a-wide-and-deep-model-using-keras-in-tensorflow-2-0-2f7a236b5a4b", "anchor_text": "my article on creating wide-and-deep models", "paragraph_index": 8}, {"url": "https://medium.com/swlh/ml-design-pattern-1-transform-9e82ccbc3209", "anchor_text": "transformation code", "paragraph_index": 8}, {"url": "https://cloud.google.com/bigquery/pricing#storage-api", "anchor_text": "the Storage API beyond a certain limit may incur BigQuery charges", "paragraph_index": 20}], "all_paragraphs": ["TensorFlow\u2019s BigQueryClient uses the Storage API to efficiently read data directly out of BigQuery storage (i.e., without having to issue a BigQuery query). In this article, I show you how to use this class in your Keras/TensorFlow 2.0 model to create a tf.data Dataset. You can follow along with this notebook on GitHub.", "As an illustration, I will use a dataset of credit card transactions. Some 0.17% of these transactions are fraudulent, and the challenge is to train a classification model on this very, very unbalanced dataset. So, along the way, you will also learn some tricks on how to deal with imbalanced data.", "A best practice whenever developing a machine learning model is to have a simple benchmark. In this case, I will develop the benchmark model using BigQuery ML:", "Note that I do several things in this super-simple model:", "This gives me a model with an AUC (area under the curve) of 0.9863, illustrating how powerful BigQuery ML can be. Let\u2019s see if we can beat this with a more complex machine learning model written in Keras.", "To read the BigQuery data into Keras, I am going to use the BigQueryClient. Here\u2019s code that will create a dataset:", "Essentially, we use client.read_session() to create a session, passing in the table to read, the columns of the table to read, a simple restriction on the rows we care about. This data is read in parallel into the tf.data.dataset, and I use it to create a training dataset and an evaluation dataset.", "Note that the code above uses some of the tf.data.dataset best practices such as prefetching, shuffling and batching.", "Creating a Keras model to read structured data involves feature columns. To learn more, see my article on creating wide-and-deep models in Keras and on keeping transformation code separate from inputs. So, without repeating myself, here\u2019s the code to create the input layer to Keras:", "Handling class imbalance in a Keras model consists of two steps:", "We can compute the necessary values using BigQuery:", "This gives me the following numbers: Keras model\u2019s output bias needs to be set at -6.36 The class weights need to be 289.4 and 0.5.", "We can then create a Keras model with 2 hidden fully-connected layers and a dropout layer (to limit overfitting) and taking care to provide an initial bias to the output layer and class weights to the loss function:", "The result? After 20 iterations, I got:", "This is better than the benchmark logistic regression model, but only barely. We will need to further hyperparameter tune the # of nodes, dropout, etc. of the Deep Learning model to do even better than this.", "You can load the trained TensorFlow model into BigQuery and use it to do inference. To load the model, call this from Keras:", "You can predict with this model just as if it were a native BigQuery ML logistic regression model:", "The reason it\u2019s called d4 above is that my Keras output node was called d4.", "In this article, you saw how to:", "Along the way, you also saw how to train a BigQuery ML model and a Keras model on highly imbalanced data.", "Note: Depending on your company\u2019s pricing plan, use of the Storage API beyond a certain limit may incur BigQuery charges. At the time I am writing this, customers on the flat rate plan start incurring these charges if they read in excess of 300 TB/month.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "articles are personal observations and not investment advice."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F9234b69165c8&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-read-bigquery-data-from-tensorflow-2-0-efficiently-9234b69165c8&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-read-bigquery-data-from-tensorflow-2-0-efficiently-9234b69165c8&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-read-bigquery-data-from-tensorflow-2-0-efficiently-9234b69165c8&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-read-bigquery-data-from-tensorflow-2-0-efficiently-9234b69165c8&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----9234b69165c8--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----9234b69165c8--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://lakshmanok.medium.com/?source=post_page-----9234b69165c8--------------------------------", "anchor_text": ""}, {"url": "https://lakshmanok.medium.com/?source=post_page-----9234b69165c8--------------------------------", "anchor_text": "Lak Lakshmanan"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F247b0630b5d6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-read-bigquery-data-from-tensorflow-2-0-efficiently-9234b69165c8&user=Lak+Lakshmanan&userId=247b0630b5d6&source=post_page-247b0630b5d6----9234b69165c8---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F9234b69165c8&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-read-bigquery-data-from-tensorflow-2-0-efficiently-9234b69165c8&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F9234b69165c8&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-read-bigquery-data-from-tensorflow-2-0-efficiently-9234b69165c8&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://github.com/tensorflow/io/tree/master/tensorflow_io/bigquery", "anchor_text": "BigQueryClient"}, {"url": "https://github.com/GoogleCloudPlatform/training-data-analyst/blob/master/blogs/bigquery_datascience/bigquery_tensorflow.ipynb", "anchor_text": "notebook on GitHub."}, {"url": "https://github.com/tensorflow/io/tree/master/tensorflow_io/bigquery", "anchor_text": "BigQueryClient"}, {"url": "https://towardsdatascience.com/how-to-build-a-wide-and-deep-model-using-keras-in-tensorflow-2-0-2f7a236b5a4b", "anchor_text": "my article on creating wide-and-deep models"}, {"url": "https://medium.com/swlh/ml-design-pattern-1-transform-9e82ccbc3209", "anchor_text": "transformation code"}, {"url": "https://github.com/GoogleCloudPlatform/training-data-analyst/blob/master/blogs/bigquery_datascience/bigquery_tensorflow.ipynb", "anchor_text": "notebook on GitHub"}, {"url": "https://www.amazon.com/Google-BigQuery-Definitive-Warehousing-Analytics/dp/1492044466", "anchor_text": "BigQuery: The Definitive Guide"}, {"url": "https://cloud.google.com/bigquery/pricing#storage-api", "anchor_text": "the Storage API beyond a certain limit may incur BigQuery charges"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F9234b69165c8&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-read-bigquery-data-from-tensorflow-2-0-efficiently-9234b69165c8&user=Lak+Lakshmanan&userId=247b0630b5d6&source=-----9234b69165c8---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F9234b69165c8&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-read-bigquery-data-from-tensorflow-2-0-efficiently-9234b69165c8&user=Lak+Lakshmanan&userId=247b0630b5d6&source=-----9234b69165c8---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F9234b69165c8&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-read-bigquery-data-from-tensorflow-2-0-efficiently-9234b69165c8&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----9234b69165c8--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F9234b69165c8&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-read-bigquery-data-from-tensorflow-2-0-efficiently-9234b69165c8&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----9234b69165c8---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----9234b69165c8--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----9234b69165c8--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----9234b69165c8--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----9234b69165c8--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----9234b69165c8--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----9234b69165c8--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----9234b69165c8--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----9234b69165c8--------------------------------", "anchor_text": ""}, {"url": "https://lakshmanok.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://lakshmanok.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Lak Lakshmanan"}, {"url": "https://lakshmanok.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "9.3K Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F247b0630b5d6&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-read-bigquery-data-from-tensorflow-2-0-efficiently-9234b69165c8&user=Lak+Lakshmanan&userId=247b0630b5d6&source=post_page-247b0630b5d6--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F44e3f26acd1a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-read-bigquery-data-from-tensorflow-2-0-efficiently-9234b69165c8&newsletterV3=247b0630b5d6&newsletterV3Id=44e3f26acd1a&user=Lak+Lakshmanan&userId=247b0630b5d6&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}