{"url": "https://towardsdatascience.com/setting-up-a-ci-using-dbt-cloud-and-snowflake-f79eecbb98ae", "time": 1683014817.966971, "path": "towardsdatascience.com/setting-up-a-ci-using-dbt-cloud-and-snowflake-f79eecbb98ae/", "webpage": {"metadata": {"title": "Setting up a CI using dbt Cloud and Snowflake | by Massimo Belloni | Towards Data Science", "h1": "Setting up a CI using dbt Cloud and Snowflake", "description": "At HousingAnywhere, we are using dbt and Snowflake to model our data in order to offer meaningful views and materializations to our business analysts and data scientists. Our data warehouse is\u2026"}, "outgoing_paragraph_urls": [{"url": "https://housinganywhere.com/", "anchor_text": "HousingAnywhere", "paragraph_index": 0}, {"url": "https://www.getdbt.com/", "anchor_text": "dbt", "paragraph_index": 0}, {"url": "https://www.stitchdata.com/", "anchor_text": "Stitch", "paragraph_index": 0}, {"url": "https://towardsdatascience.com/testing-airflow-jobs-on-google-cloud-composer-using-pytest-9e0a1198b4cd?source=friends_link&sk=c1580e3682d25ea3f6b86a72f04d35c0", "anchor_text": "using Airflow", "paragraph_index": 0}, {"url": "https://www.getdbt.com/", "anchor_text": "dbt Cloud", "paragraph_index": 4}, {"url": "https://www.getdbt.com/product/", "anchor_text": "a lot of interesting features", "paragraph_index": 4}, {"url": "https://docs.getdbt.com/docs/building-a-dbt-project/tests/", "anchor_text": "already contained tests", "paragraph_index": 7}, {"url": "https://www.linkedin.com/in/julian-smidek/", "anchor_text": "Julian Smidek", "paragraph_index": 11}, {"url": "https://www.linkedin.com/in/stephen-o-farrell-20207a16b/", "anchor_text": "Stephen O\u2019 Farrell", "paragraph_index": 11}], "all_paragraphs": ["At HousingAnywhere, we are using dbt and Snowflake to model our data in order to offer meaningful views and materializations to our business analysts and data scientists. Our data warehouse is populated with raw structured data coming from a wide variety of different sources, the majority of which are replicated via Stitch; an easy and scalable plug-and-play managed ETL tool. Others required a more personal touch and are integrated using Airflow with ad-hoc periodical tasks. In both cases, it can be frustrating to extract meaningful insights from these sources, considering the prevalence of data that is dirty, incoherent and/or stored in over-engineered structures that were not designed with ease of access and information extraction in mind.", "dbt itself is a command line tool that allows data engineers to efficiently transform data in their data warehouse. It uses SQL enriched with Jinja templates when more complex logic is needed or to access information about a job\u2019s execution or the targeted schema/table. The data warehouse is used as a source from which data is transformed and pushed back into the same warehouse, though in a different location. The results of dbt are usually easier to understand and maintain, often consisting of multiple joins from tables possibly originating from different data sources. It isn\u2019t uncommon for BI tools (eg. Mode, Looker, etc) to only have visibility of these resulting tables, as opposed to the original raw sources.", "The results of dbt are usually easier to understand and maintain, often consisting of multiple joins from tables possibly originating from different data sources.", "To give an example: imagine a table containing various information concerning a property, with the latitude and longitude to describe its location. It isn\u2019t easy to query this kind of data. We created a model using dbt that adds a \u2018city\u2019 column, retrieved by computing the haversine distance from the property location and cities of interest for our business. These distances are calculated and the closest city is assigned to the property for reporting purposes. Business Analysts can simply query the second table without having to worry about the complex logic behind the scene.", "dbt, being a Python module distributed on pypi, can be deployed on any machine running Python. That said, it is definitely handier to use dbt Cloud, which allows you to have an efficient deployment of dbt for free (initially, of course, with a pay-as-you-grow model coming into play later). dbt Cloud also adds a lot of interesting features to the core product, and the user-friendly web interface makes it a real no-brainer in terms of the best way to implement dbt in a production setting. Thanks to the seamless integration with Github, all the models and configurations can be code versioned using git, and the development process can be carried out as in any other classical software engineering project, with multiple branches opened in parallel and pull requests (PR) to merge changes on master. At scheduled times, dbt Cloud picks up the master branch and runs the selected models against production data, transforming them as defined in the code and delivering the changes.", "Thanks to the seamless integration with Github, all the models and configurations can be code versioned using git, and the development process can be carried out as in any other classical software engineering project.", "This allows for an efficient, observable and easy to maintain environment, though having master directly connected to the production warehouse isn\u2019t the most reliable thing to do. The dbt syntax is quite error prone and even if it ideally can be compiled locally (Jinja templates have to be translated to SQL), it isn\u2019t easy to assess whether the changes are breaking some semantic constraint in the data. In a naive implementation, nothing prevents you from merging to master with a commit that breaks something, only for you to discover the error in your ways when the scheduled task is run sometime during the night. Not ideal.", "Luckily, dbt Cloud comes to help, allowing for jobs to be run against custom branches when triggered from an opened PR on a connected repository. In other words: the exact copy of the production jobs can be run using the models found on the branch every time a PR is opened, materialised against a temporary schema on this same production environment. The temporary schema is deleted when the PR is closed or merged, but while the PR is open, it can be accessed as any other schema on the database, to run tests or to manually check things \u2014 if needed. This feature is particularly useful to check the syntax and high level consistency of the branch\u2019s content, preventing contributors from merging breaking changes. If the dbt pipeline in production already contained tests, these will also be run against the temporary schema in order to check its content on a semantic level.", "However, while having the whole production environment replicated on the temporary schema, is appealing in theory, it is not feasible to materialise tables with hundreds of millions of rows on every commit. The main goal of having a CI is to provide the developers with quick checks on their work, while a complete re-population of some tables can require a few hours in the best case. While executing dbt jobs, it is quite easy to distinguish production runs from CI ones, considering the strict naming pattern followed by temporary schemas used for the purpose (dbt_cloud_pr_xx at the time of this post). Overcoming references to raw tables in dbt models and reducing the size of the referenced ephemeral instances while executing CI jobs will do the trick, allowing the CI runs to use a small subset of the production data, drastically reducing the time needed to have reliable checks on each PR.", "Reducing the scope of the tables in order to avoid tampering with the external references of the data structures is an easy job syntactically and there isn\u2019t any rule of thumb to do it properly. What we decided to do is to restrict the time horizon on one master table and to populate the others in order to preserve the joins and references.", "Here\u2019s an example not very far from reality: imagine a database schema where there are conversations between tenants and advertisers related to some housing properties (listings). The most logical decision is to just select the conversations created in a specific time interval (eg. January 2019, some tens of thousands of samples), to enforce the existence of the listings to which those conversations were related and \u2014 of course \u2014 of the users that were involved on both sides. The resulting schema is reduced in size but still consistent. Reasoning in this direction we can close all the transitive dependencies related to this part of the schema, possibly time constraining on the same period other tables that don\u2019t have direct dependencies to these.", "Thanks to Julian Smidek and Stephen O\u2019 Farrell for their contribution to this project and this post.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Ff79eecbb98ae&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsetting-up-a-ci-using-dbt-cloud-and-snowflake-f79eecbb98ae&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsetting-up-a-ci-using-dbt-cloud-and-snowflake-f79eecbb98ae&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsetting-up-a-ci-using-dbt-cloud-and-snowflake-f79eecbb98ae&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsetting-up-a-ci-using-dbt-cloud-and-snowflake-f79eecbb98ae&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----f79eecbb98ae--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----f79eecbb98ae--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://massibelloni.medium.com/?source=post_page-----f79eecbb98ae--------------------------------", "anchor_text": ""}, {"url": "https://massibelloni.medium.com/?source=post_page-----f79eecbb98ae--------------------------------", "anchor_text": "Massimo Belloni"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F4e623cf1c796&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsetting-up-a-ci-using-dbt-cloud-and-snowflake-f79eecbb98ae&user=Massimo+Belloni&userId=4e623cf1c796&source=post_page-4e623cf1c796----f79eecbb98ae---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ff79eecbb98ae&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsetting-up-a-ci-using-dbt-cloud-and-snowflake-f79eecbb98ae&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ff79eecbb98ae&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsetting-up-a-ci-using-dbt-cloud-and-snowflake-f79eecbb98ae&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@kianlem?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Kian Lem"}, {"url": "https://unsplash.com/?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText", "anchor_text": "Unsplash"}, {"url": "https://housinganywhere.com/", "anchor_text": "HousingAnywhere"}, {"url": "https://www.getdbt.com/", "anchor_text": "dbt"}, {"url": "https://www.stitchdata.com/", "anchor_text": "Stitch"}, {"url": "https://towardsdatascience.com/testing-airflow-jobs-on-google-cloud-composer-using-pytest-9e0a1198b4cd?source=friends_link&sk=c1580e3682d25ea3f6b86a72f04d35c0", "anchor_text": "using Airflow"}, {"url": "https://www.getdbt.com/", "anchor_text": "dbt Cloud"}, {"url": "https://www.getdbt.com/product/", "anchor_text": "a lot of interesting features"}, {"url": "https://docs.getdbt.com/docs/building-a-dbt-project/tests/", "anchor_text": "already contained tests"}, {"url": "https://www.linkedin.com/in/julian-smidek/", "anchor_text": "Julian Smidek"}, {"url": "https://www.linkedin.com/in/stephen-o-farrell-20207a16b/", "anchor_text": "Stephen O\u2019 Farrell"}, {"url": "https://medium.com/tag/data-engineering?source=post_page-----f79eecbb98ae---------------data_engineering-----------------", "anchor_text": "Data Engineering"}, {"url": "https://medium.com/tag/dbt?source=post_page-----f79eecbb98ae---------------dbt-----------------", "anchor_text": "Dbt"}, {"url": "https://medium.com/tag/snowflake?source=post_page-----f79eecbb98ae---------------snowflake-----------------", "anchor_text": "Snowflake"}, {"url": "https://medium.com/tag/big-data?source=post_page-----f79eecbb98ae---------------big_data-----------------", "anchor_text": "Big Data"}, {"url": "https://medium.com/tag/etl?source=post_page-----f79eecbb98ae---------------etl-----------------", "anchor_text": "Etl"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Ff79eecbb98ae&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsetting-up-a-ci-using-dbt-cloud-and-snowflake-f79eecbb98ae&user=Massimo+Belloni&userId=4e623cf1c796&source=-----f79eecbb98ae---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Ff79eecbb98ae&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsetting-up-a-ci-using-dbt-cloud-and-snowflake-f79eecbb98ae&user=Massimo+Belloni&userId=4e623cf1c796&source=-----f79eecbb98ae---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Ff79eecbb98ae&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsetting-up-a-ci-using-dbt-cloud-and-snowflake-f79eecbb98ae&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----f79eecbb98ae--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Ff79eecbb98ae&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsetting-up-a-ci-using-dbt-cloud-and-snowflake-f79eecbb98ae&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----f79eecbb98ae---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----f79eecbb98ae--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----f79eecbb98ae--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----f79eecbb98ae--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----f79eecbb98ae--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----f79eecbb98ae--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----f79eecbb98ae--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----f79eecbb98ae--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----f79eecbb98ae--------------------------------", "anchor_text": ""}, {"url": "https://massibelloni.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://massibelloni.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Massimo Belloni"}, {"url": "https://massibelloni.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "443 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F4e623cf1c796&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsetting-up-a-ci-using-dbt-cloud-and-snowflake-f79eecbb98ae&user=Massimo+Belloni&userId=4e623cf1c796&source=post_page-4e623cf1c796--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fd607a9e5bd7d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsetting-up-a-ci-using-dbt-cloud-and-snowflake-f79eecbb98ae&newsletterV3=4e623cf1c796&newsletterV3Id=d607a9e5bd7d&user=Massimo+Belloni&userId=4e623cf1c796&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}