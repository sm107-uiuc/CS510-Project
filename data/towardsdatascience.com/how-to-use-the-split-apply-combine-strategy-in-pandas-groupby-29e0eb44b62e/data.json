{"url": "https://towardsdatascience.com/how-to-use-the-split-apply-combine-strategy-in-pandas-groupby-29e0eb44b62e", "time": 1682997212.02719, "path": "towardsdatascience.com/how-to-use-the-split-apply-combine-strategy-in-pandas-groupby-29e0eb44b62e/", "webpage": {"metadata": {"title": "How to use the Split-Apply-Combine strategy in Pandas groupby | by Filip Ciesielski | Towards Data Science", "h1": "How to use the Split-Apply-Combine strategy in Pandas groupby", "description": "Pandas groupby-apply is an invaluable tool in a Python data scientist\u2019s toolkit. You can go pretty far with it without fully understanding all of its internal intricacies. However, sometimes that can\u2026"}, "outgoing_paragraph_urls": [{"url": "https://sunscrapers.com/?utm_source=medium&utm_medium=article", "anchor_text": "Sunscrapers", "paragraph_index": 1}, {"url": "https://pandas.pydata.org/pandas-docs/stable/reference/groupby.html", "anchor_text": "here for more", "paragraph_index": 10}, {"url": "http://pandas.pydata.org/pandas-docs/stable/user_guide/groupby.html", "anchor_text": "here", "paragraph_index": 25}, {"url": "http://pandas.pydata.org/pandas-docs/version/0.24/reference/api/pandas.DataFrame.apply.html", "anchor_text": "here", "paragraph_index": 39}], "all_paragraphs": ["Pandas groupby-apply is an invaluable tool in a Python data scientist\u2019s toolkit. You can go pretty far with it without fully understanding all of its internal intricacies. However, sometimes that can manifest itself in unexpected behavior and errors. Ever had one of those? Or maybe you\u2019re struggling to figure out how to deal with more advanced data transformation problem? Then read this visual guide to Pandas groupby-apply paradigm to understand how it works, once and for all.", "Source: Courtesy of my team at Sunscrapers.", "Solid understanding of the groupby-apply mechanism is often crucial when dealing with more advanced data transformations and pivot tables in Pandas.", "That can be a steep learning curve for newcomers and a kind of \u2018gotcha\u2019 for intermediate Pandas users too. That\u2019s why I wanted to share a few visual guides with you that demonstrate what actually happens under the hood when we run the groupby-apply operations.", "Here are a few things that I believe you should understand first to make working with more advanced Pandas pivot tables more straightforward:", "Groupby \u2014 what does it do?", "Read on to get answers to these questions and some extra insights about working with pivot tables in Pandas.", "Let\u2019s use the classic Iris dataset as an example (fetchable from the Seaborn plotting library) and limit it to just 15 rows for simplicity:", "The table is quite small, but well sufficient enough for our needs and will suit us nicely for demonstration purposes in this article:", "Let\u2019s start with refreshing some basics about groupby and then build the complexity on top as we go along.", "You can apply groupby method to a flat table with a simple 1D index column. That doesn\u2019t perform any operations on the table yet, but only returns a DataFrameGroupBy instance and so it needs to be chained to some kind of an aggregation function (for example, sum, mean, min, max, etc. see here for more) which will work on the grouped rows (we will discuss apply later on).", "What\u2019s important to remember here is that it automatically concatenates the results of individual aggregated outcomes back into a single dataframe.", "A very simple example can be grouping by a specific column value (eg. \u201cspecies\u201d in our table) and summing all the remaining applicable columns:", "Alternatively, we can specify which columns are to be summed up. A common mistake made by some is calculating the sum first and then sticking a column selector at the end like this:", "That means the summation is carried out first on every applicable column (numeric or string) and then a specified column is selected for output.", "Specify the column before the aggregate function so only that one is summed up in the process, resulting in a SIGNIFICANT speed improvement (2.5x for this small table):", "Note that since only a single column will be summed, the resulting output is a pd.Series object:", "However, if you want to automatically return a dataframe object directly (after all, it\u2019s much more readable), there\u2019s no need to cast it via pd.Dataframe(). Instead, provide the column name as a list to the column selection (essentially, use double brackets) like that:", "Finally, groupby can take a list of column names and perform an aggregation function on all of the remaining applicable columns (that weren\u2019t mentioned before).", "It\u2019s key to understand here that the resulting table will then have a MultiIndex object as the index and will behave slightly differently from a regular table.", "Useful tip: When working with MultiIndex tables, you can use .xs to select subsets of the dataframe by selecting a value and then a particular index level. The resulting output is usually also a dataframe object.", "Also, don\u2019t forget that you can \u201cflatten\u201d the index into columns by running the reset_idnex method:", "Additionally, if you pass a drop=True parameter to the reset_index function, your output dataframe will drop the columns that make up the MultiIndex and create a new index with incremental integer values.", "Let\u2019s take it to the next level now.", "Instead of using one of the stock functions provided by Pandas to operate on the groups we can define our own custom function and run it on the table via the apply() method.", "To write a custom function well, you need to understand how the two methods work with each other in the so-called Groupby-Split-Apply-Combine chain mechanism (more on this here).", "As I already mentioned, the first stage is creating a Pandas groupby object (DataFrameGroupBy) which provides an interface for the apply method to group rows together according to specified column(s) values.", "We split the groups transiently and loop them over via an optimized Pandas inner code. We then pass each group to a specified function as either a Series or a DataFrame object.", "The output of a function is stored temporarily until all groups have been processed. In the last stage all the results (from each function invocation) are finally combined into a single output.", "Here are a couple of points we need to keep in mind to avoid potential surprises that may arise when we work with the groupby and apply methods.", "That\u2019s especially important on the rare occasions when we\u2019re forced to iterate over individual groups of rows with a for-in loop (usually, that\u2019s a sign of bad practice \u2014 however, it may be inevitable in certain situations).", "You can provide the logic for per-group operations in a couple of ways.", "You can either define your separate function and pass it as an object to apply or pass a lambda expression directly. There\u2019s also the .agg() method which allows to pipe multiple aggregation functions by providing a name or a list of names of functions too (but that\u2019s outside of the scope of this article).", "On a side note \u2014 yes, the columns with string values are also \u201csummed,\u201d they are simply concatenated together.", "The custom function should have one input parameter which will be either a Series or a DataFrame object, depending on whether a single or multiple columns are specified via the groupby method:", ", whereas (ignore the fact that there are 4 lines here \u2014 I\u2019ll explain it later)", "When writing a complex table transformation you may sometimes want to walk yourself through the inner workings of the apply\u2019ed function and add a print() statement to inspect what\u2019s going on during the operation (I do that from time to time to set my bearings when stuck).", "It may come as quite a surprise to some of you, but when you run the following code, you will get one extra bit that you may not have anticipated:", "and this is what\u2019s being printed out:", "This mysterious behaviour is actually explained in the Pandas documentation here, but it\u2019s easy to miss \u2014 I know I did and had to learn it the hard way, so let me save you the trouble:", "\u201cIn the current implementation apply calls func twice on the first column/row to decide whether it can take a fast or slow code path. This can lead to unexpected behavior if func has side-effects, as they will take effect twice for the first column/row.\u201d", "The final piece of the puzzle is the applied function\u2019s output and how it\u2019s handled in the combine stage. What happens there is that Pandas grabs all the outputs from each subsequent group operation and concatenates them with their corresponding labels, also provided by the DataFrameGroupBy object. The latter are then used to create a new index.", "It implies that you can design a custom function to return anything, and it will be placed in a single row for a specific group under the group name label.", "This example should illustrate that well:", "What happens in most of the cases though (e.g., with the sum function) is that each iteration returns a Pandas Series object per row where the index values are used to assort the values to the right column name in the final dataframe.", "Let\u2019s create a custom Series object and return it on every group via the apply method:", "What if we return a DataFrame per each iterated group? The result is somewhat interesting because it will create a table with a MultiIndex structure. It will append the DataFrame into each row as is and its index will be integrated with the groups label value, for example:", "Understanding these issues should make it easier for you to work with some of the more complex pivots and operations on Pandas tables. I revisit these basics from time to time or whenever I get stuck \u2014 and it always helps me to speed up the process a lot!", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Biophysicist turned software engineer @ Sunscrapers. Solving Python & data science problems."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F29e0eb44b62e&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-use-the-split-apply-combine-strategy-in-pandas-groupby-29e0eb44b62e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-use-the-split-apply-combine-strategy-in-pandas-groupby-29e0eb44b62e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-use-the-split-apply-combine-strategy-in-pandas-groupby-29e0eb44b62e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-use-the-split-apply-combine-strategy-in-pandas-groupby-29e0eb44b62e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----29e0eb44b62e--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----29e0eb44b62e--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@phil.thyharry?source=post_page-----29e0eb44b62e--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@phil.thyharry?source=post_page-----29e0eb44b62e--------------------------------", "anchor_text": "Filip Ciesielski"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F99269edb373a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-use-the-split-apply-combine-strategy-in-pandas-groupby-29e0eb44b62e&user=Filip+Ciesielski&userId=99269edb373a&source=post_page-99269edb373a----29e0eb44b62e---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F29e0eb44b62e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-use-the-split-apply-combine-strategy-in-pandas-groupby-29e0eb44b62e&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F29e0eb44b62e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-use-the-split-apply-combine-strategy-in-pandas-groupby-29e0eb44b62e&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://sunscrapers.com/?utm_source=medium&utm_medium=article", "anchor_text": "Sunscrapers"}, {"url": "https://pandas.pydata.org/pandas-docs/stable/reference/groupby.html", "anchor_text": "here for more"}, {"url": "http://pandas.pydata.org/pandas-docs/stable/user_guide/groupby.html", "anchor_text": "here"}, {"url": "http://pandas.pydata.org/pandas-docs/version/0.24/reference/api/pandas.DataFrame.apply.html", "anchor_text": "here"}, {"url": "https://medium.com/tag/data-science?source=post_page-----29e0eb44b62e---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/python?source=post_page-----29e0eb44b62e---------------python-----------------", "anchor_text": "Python"}, {"url": "https://medium.com/tag/pandas?source=post_page-----29e0eb44b62e---------------pandas-----------------", "anchor_text": "Pandas"}, {"url": "https://medium.com/tag/data-analysis?source=post_page-----29e0eb44b62e---------------data_analysis-----------------", "anchor_text": "Data Analysis"}, {"url": "https://medium.com/tag/tutorial?source=post_page-----29e0eb44b62e---------------tutorial-----------------", "anchor_text": "Tutorial"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F29e0eb44b62e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-use-the-split-apply-combine-strategy-in-pandas-groupby-29e0eb44b62e&user=Filip+Ciesielski&userId=99269edb373a&source=-----29e0eb44b62e---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F29e0eb44b62e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-use-the-split-apply-combine-strategy-in-pandas-groupby-29e0eb44b62e&user=Filip+Ciesielski&userId=99269edb373a&source=-----29e0eb44b62e---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F29e0eb44b62e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-use-the-split-apply-combine-strategy-in-pandas-groupby-29e0eb44b62e&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----29e0eb44b62e--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F29e0eb44b62e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-use-the-split-apply-combine-strategy-in-pandas-groupby-29e0eb44b62e&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----29e0eb44b62e---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----29e0eb44b62e--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----29e0eb44b62e--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----29e0eb44b62e--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----29e0eb44b62e--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----29e0eb44b62e--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----29e0eb44b62e--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----29e0eb44b62e--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----29e0eb44b62e--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@phil.thyharry?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@phil.thyharry?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Filip Ciesielski"}, {"url": "https://medium.com/@phil.thyharry/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "267 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F99269edb373a&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-use-the-split-apply-combine-strategy-in-pandas-groupby-29e0eb44b62e&user=Filip+Ciesielski&userId=99269edb373a&source=post_page-99269edb373a--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F10f50dee8de7&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-use-the-split-apply-combine-strategy-in-pandas-groupby-29e0eb44b62e&newsletterV3=99269edb373a&newsletterV3Id=10f50dee8de7&user=Filip+Ciesielski&userId=99269edb373a&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}