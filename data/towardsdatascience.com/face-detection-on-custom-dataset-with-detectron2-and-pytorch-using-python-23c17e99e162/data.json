{"url": "https://towardsdatascience.com/face-detection-on-custom-dataset-with-detectron2-and-pytorch-using-python-23c17e99e162", "time": 1683004012.034604, "path": "towardsdatascience.com/face-detection-on-custom-dataset-with-detectron2-and-pytorch-using-python-23c17e99e162/", "webpage": {"metadata": {"title": "Face Detection on Custom Dataset with Detectron2 and PyTorch using Python | by Venelin Valkov | Towards Data Science", "h1": "Face Detection on Custom Dataset with Detectron2 and PyTorch using Python", "description": "Historically, this was a really tough problem to solve. Tons of manual feature engineering, novel algorithms and methods were developed to improve the state-of-the-art. These days, face detection\u2026"}, "outgoing_paragraph_urls": [{"url": "https://docs.opencv.org/4.2.0/db/d28/tutorial_cascade_classifier.html", "anchor_text": "Cascade Classifier", "paragraph_index": 3}, {"url": "https://github.com/facebookresearch/detectron2", "anchor_text": "Detectron2", "paragraph_index": 6}, {"url": "https://github.com/facebookresearch/Detectron", "anchor_text": "first version", "paragraph_index": 6}, {"url": "https://detectron2.readthedocs.io/notes/benchmarks.html", "anchor_text": "blazing fast training", "paragraph_index": 7}, {"url": "https://ai.facebook.com/blog/-detectron2-a-pytorch-based-modular-object-detection-library-/", "anchor_text": "introductory blog post", "paragraph_index": 7}, {"url": "https://github.com/facebookresearch/detectron2/blob/master/MODEL_ZOO.md", "anchor_text": "Model Zoo", "paragraph_index": 8}, {"url": "https://dataturks.com/projects/devika.mishra/face_detection", "anchor_text": "freely available in the public domain", "paragraph_index": 13}, {"url": "https://dataturks.com/", "anchor_text": "Dataturks", "paragraph_index": 13}, {"url": "https://www.kaggle.com/dataturks/face-detection-in-images", "anchor_text": "Kaggle", "paragraph_index": 13}, {"url": "http://cocodataset.org/#home", "anchor_text": "COCO dataset", "paragraph_index": 34}, {"url": "https://medium.com/@jonathan_hui/map-mean-average-precision-for-object-detection-45c121a31173", "anchor_text": "mAP (mean Average Precision) for Object Detection", "paragraph_index": 46}], "all_paragraphs": ["TL;DR Learn how to prepare a custom Face Detection dataset for Detectron2 and PyTorch. Fine-tune a pre-trained model to find face boundaries in images.", "Face detection is the task of finding (boundaries of) faces in images. This is useful for", "Historically, this was a really tough problem to solve. Tons of manual feature engineering, novel algorithms and methods were developed to improve the state-of-the-art.", "These days, face detection models are included in almost every computer vision package/framework. Some of the best-performing ones use Deep Learning methods. OpenCV, for example, provides a variety of tools like the Cascade Classifier.", "In this guide, you\u2019ll learn how to:", "Here\u2019s an example of what you\u2019ll get at the end of this guide:", "Detectron2 is a framework for building state-of-the-art object detection and image segmentation models. It is developed by the Facebook Research team. Detectron2 is a complete rewrite of the first version.", "Under the hood, Detectron2 uses PyTorch (compatible with the latest version(s)) and allows for blazing fast training. You can learn more at the introductory blog post by Facebook Research.", "The real power of Detectron2 lies in the HUGE amount of pre-trained models available at the Model Zoo. But what good that would it be if you can\u2019t fine-tune those on your own datasets? Fortunately, that\u2019s super easy! We\u2019ll see how it is done in this guide.", "At the time of this writing, Detectron2 is still in an alpha stage. While there is an official release, we\u2019ll clone and compile from the master branch. This should equal version 0.1.", "Let\u2019s start by installing some requirements:", "And download, compile, and install the Detectron2 package:", "At this point, you\u2019ll need to restart the notebook runtime to continue!", "The dataset is freely available in the public domain. It is provided by Dataturks, and it is hosted on Kaggle. Here\u2019s an excerpt from the description:", "Faces in images marked with bounding boxes. Have around 500 images with around 1100 faces manually tagged via bounding box.", "I\u2019ve downloaded the JSON file containing the annotations and uploaded it to Google Drive. Let\u2019s get it:", "Let\u2019s load the file into a Pandas data frame:", "Each line contains a single face annotation. Note that multiple lines might point to a single image (e.g. multiple faces per image).", "The dataset contains only image URLs and annotations. We\u2019ll have to download the images. We\u2019ll also normalize the annotations, so it\u2019s easier to use them with Detectron2 later on:", "Let\u2019s put the data into a data frame so we can have a better look:", "We have a total of 409 images (a lot less than the promised 500) and 1132 annotations. Let\u2019s save them to the disk (so you might reuse them):", "Let\u2019s see some sample annotated data. We\u2019ll use OpenCV to load an image, add the bounding boxes, and resize it. We\u2019ll define a helper function to do it all:", "Let\u2019s start by showing some annotated images:", "Those are good ones, the annotations are clearly visible. We can use torchvision to create a grid of images. Note that the images are in various sizes, so we\u2019ll resize them:", "You can clearly see that some annotations are missing (column 4). That\u2019s real-life data for you, sometimes you have to deal with it in some way.", "It is time to go through the steps of fine-tuning a model using a custom dataset. But first, let\u2019s save 5% of the data for testing:", "The classical train test split won\u2019t work here, cause we want a split amongst the file names.", "The next parts are written in a bit more generic way. Obviously, we have a single class \u2014 face. But adding more should be as simple as adding more annotations to the data frame:", "Next, we\u2019ll write a function that converts our dataset into a format that is used by Detectron2:", "We convert every annotation row to a single record with a list of annotations. You might also notice that we\u2019re building a polygon that is of the exact same shape as the bounding box. This is required for the image segmentation models in Detectron2.", "You\u2019ll have to register your dataset into the dataset and metadata catalogs:", "Unfortunately, the evaluator for the test set is not included by default. We can easily fix that by writing our own trainer:", "The evaluation results will be stored in the coco_eval folder if no folder is provided.", "Fine-tuning a Detectron2 model is nothing like writing PyTorch code. We\u2019ll load a configuration file, change a few values, and start the training process. But hey, it really helps if you know what you\u2019re doing \ud83d\ude02", "For this tutorial, we\u2019ll use the Mask R-CNN X101-FPN model. It is pre-trained on the COCO dataset and achieves very good performance. The downside is that it is slow to train.", "Let\u2019s load the config file and the pre-trained model weights:", "Specify the datasets (we registered those) we\u2019ll use for training and evaluation:", "And for the optimizer, we\u2019ll do a bit of magic to converge to something nice:", "Except for the standard stuff (batch size, max number of iterations, and learning rate) we have a couple of interesting params:", "Finally, we\u2019ll specify the number of classes and the period at which we\u2019ll evaluate on the test set:", "Time to train, using our custom trainer:", "Evaluating object detection models is a bit different when compared to evaluating standard classification or regression models.", "The main metric you need to know about is IoU (intersection over union). It measures the overlap between two boundaries \u2014 the predicted and ground truth one. It can get values between 0 and 1.", "Using IoU, one can define a threshold (e.g. >0.5) to classify whether a prediction is a true positive (TP) or a false positive (FP).", "Now you can calculate average precision (AP) by taking the area under the precision-recall curve.", "Now AP@X (e.g. AP50) is just AP at some IoU threshold. This should give you a working understanding of how object detection models are evaluated.", "I suggest you read the mAP (mean Average Precision) for Object Detection tutorial by Jonathan Hui if you want to learn more about the topic.", "I\u2019ve prepared a pre-trained model for you, so you don\u2019t have to wait for the training to complete. Let\u2019s download it:", "We can start making predictions by loading the model and setting a minimum threshold of 85% certainty at which we\u2019ll consider the predictions as correct:", "Let\u2019s run the evaluator with the trained model:", "Next, let\u2019s create a folder and save all images with predicted annotations in the test set:", "Not bad. Not bad at all. I suggest you explore more images on your own, too!", "Note that some faces have multiple bounding boxes (on the second image) with different degrees of certainty. Maybe training the model longer will help? How about adding more or augmenting the existing data?", "Congratulations! You now know the basics of Detectron2 for object detection! You might be surprised by the results, given the small dataset we have. That\u2019s the power of large pre-trained models for you \ud83d\ude0d", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F23c17e99e162&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fface-detection-on-custom-dataset-with-detectron2-and-pytorch-using-python-23c17e99e162&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fface-detection-on-custom-dataset-with-detectron2-and-pytorch-using-python-23c17e99e162&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fface-detection-on-custom-dataset-with-detectron2-and-pytorch-using-python-23c17e99e162&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fface-detection-on-custom-dataset-with-detectron2-and-pytorch-using-python-23c17e99e162&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----23c17e99e162--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----23c17e99e162--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://venelinvalkov.medium.com/?source=post_page-----23c17e99e162--------------------------------", "anchor_text": ""}, {"url": "https://venelinvalkov.medium.com/?source=post_page-----23c17e99e162--------------------------------", "anchor_text": "Venelin Valkov"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F102e34a0beb1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fface-detection-on-custom-dataset-with-detectron2-and-pytorch-using-python-23c17e99e162&user=Venelin+Valkov&userId=102e34a0beb1&source=post_page-102e34a0beb1----23c17e99e162---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F23c17e99e162&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fface-detection-on-custom-dataset-with-detectron2-and-pytorch-using-python-23c17e99e162&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F23c17e99e162&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fface-detection-on-custom-dataset-with-detectron2-and-pytorch-using-python-23c17e99e162&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@chrisjoelcampbell", "anchor_text": "Christopher Campbell"}, {"url": "https://docs.opencv.org/4.2.0/db/d28/tutorial_cascade_classifier.html", "anchor_text": "Cascade Classifier"}, {"url": "https://colab.research.google.com/drive/1Jk4-qX9zdYGsBrTnh2vF52CV9ucuqpjk", "anchor_text": "Run the complete notebook in your browser (Google Colab)"}, {"url": "https://github.com/curiousily/Getting-Things-Done-with-Pytorch", "anchor_text": "Read the Getting Things Done with Pytorch book"}, {"url": "https://leanpub.com/getting-things-done-with-pytorch", "anchor_text": "Get SH*T Done with PyTorch\"Success in creating AI would be the biggest event in human history. Unfortunately, it might also be the last, unless\u2026leanpub.com"}, {"url": "https://github.com/facebookresearch/detectron2", "anchor_text": "Detectron2"}, {"url": "https://github.com/facebookresearch/Detectron", "anchor_text": "first version"}, {"url": "https://detectron2.readthedocs.io/notes/benchmarks.html", "anchor_text": "blazing fast training"}, {"url": "https://ai.facebook.com/blog/-detectron2-a-pytorch-based-modular-object-detection-library-/", "anchor_text": "introductory blog post"}, {"url": "https://github.com/facebookresearch/detectron2/blob/master/MODEL_ZOO.md", "anchor_text": "Model Zoo"}, {"url": "https://github.com/facebookresearch/detectron2", "anchor_text": "https://github.com/facebookresearch/detectron2"}, {"url": "https://dataturks.com/projects/devika.mishra/face_detection", "anchor_text": "freely available in the public domain"}, {"url": "https://dataturks.com/", "anchor_text": "Dataturks"}, {"url": "https://www.kaggle.com/dataturks/face-detection-in-images", "anchor_text": "Kaggle"}, {"url": "http://cocodataset.org/#home", "anchor_text": "COCO dataset"}, {"url": "https://medium.com/@jonathan_hui/map-mean-average-precision-for-object-detection-45c121a31173", "anchor_text": "mAP (mean Average Precision) for Object Detection"}, {"url": "https://colab.research.google.com/drive/1Jk4-qX9zdYGsBrTnh2vF52CV9ucuqpjk", "anchor_text": "Run the complete notebook in your browser (Google Colab)"}, {"url": "https://github.com/curiousily/Getting-Things-Done-with-Pytorch", "anchor_text": "Read the Getting Things Done with Pytorch book"}, {"url": "https://www.kaggle.com/dataturks/face-detection-in-images", "anchor_text": "Face Detection in Images"}, {"url": "https://github.com/facebookresearch/detectron2/", "anchor_text": "Detectron2 on GitHub"}, {"url": "https://medium.com/@jonathan_hui/map-mean-average-precision-for-object-detection-45c121a31173", "anchor_text": "mAP (mean Average Precision) for Object Detection"}, {"url": "https://leanpub.com/getting-things-done-with-pytorch", "anchor_text": "Get SH*T Done with PyTorch\"Success in creating AI would be the biggest event in human history. Unfortunately, it might also be the last, unless\u2026leanpub.com"}, {"url": "https://www.curiousily.com/posts/face-detection-on-custom-dataset-with-detectron2-in-python/", "anchor_text": "https://www.curiousily.com"}, {"url": "https://medium.com/tag/object-detection?source=post_page-----23c17e99e162---------------object_detection-----------------", "anchor_text": "Object Detection"}, {"url": "https://medium.com/tag/pytorch?source=post_page-----23c17e99e162---------------pytorch-----------------", "anchor_text": "Pytorch"}, {"url": "https://medium.com/tag/python?source=post_page-----23c17e99e162---------------python-----------------", "anchor_text": "Python"}, {"url": "https://medium.com/tag/computer-vision?source=post_page-----23c17e99e162---------------computer_vision-----------------", "anchor_text": "Computer Vision"}, {"url": "https://medium.com/tag/face-recognition?source=post_page-----23c17e99e162---------------face_recognition-----------------", "anchor_text": "Face Recognition"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F23c17e99e162&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fface-detection-on-custom-dataset-with-detectron2-and-pytorch-using-python-23c17e99e162&user=Venelin+Valkov&userId=102e34a0beb1&source=-----23c17e99e162---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F23c17e99e162&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fface-detection-on-custom-dataset-with-detectron2-and-pytorch-using-python-23c17e99e162&user=Venelin+Valkov&userId=102e34a0beb1&source=-----23c17e99e162---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F23c17e99e162&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fface-detection-on-custom-dataset-with-detectron2-and-pytorch-using-python-23c17e99e162&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----23c17e99e162--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F23c17e99e162&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fface-detection-on-custom-dataset-with-detectron2-and-pytorch-using-python-23c17e99e162&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----23c17e99e162---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----23c17e99e162--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----23c17e99e162--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----23c17e99e162--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----23c17e99e162--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----23c17e99e162--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----23c17e99e162--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----23c17e99e162--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----23c17e99e162--------------------------------", "anchor_text": ""}, {"url": "https://venelinvalkov.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://venelinvalkov.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Venelin Valkov"}, {"url": "https://venelinvalkov.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "2.5K Followers"}, {"url": "https://mlexpert.io", "anchor_text": "https://mlexpert.io"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F102e34a0beb1&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fface-detection-on-custom-dataset-with-detectron2-and-pytorch-using-python-23c17e99e162&user=Venelin+Valkov&userId=102e34a0beb1&source=post_page-102e34a0beb1--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F5323954064aa&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fface-detection-on-custom-dataset-with-detectron2-and-pytorch-using-python-23c17e99e162&newsletterV3=102e34a0beb1&newsletterV3Id=5323954064aa&user=Venelin+Valkov&userId=102e34a0beb1&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}