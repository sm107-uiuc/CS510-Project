{"url": "https://towardsdatascience.com/simple-machine-learning-pipeline-770eb3f08a2d", "time": 1683006637.081824, "path": "towardsdatascience.com/simple-machine-learning-pipeline-770eb3f08a2d/", "webpage": {"metadata": {"title": "Simple Machine Learning Pipeline. Bringing together all essential parts\u2026 | by Andrej Baranovskij | Towards Data Science", "h1": "Simple Machine Learning Pipeline", "description": "In this article, I\u2019m going to cover multiple topics and explain how to build Machine Learning pipeline. What is ML pipeline? This is a solution that helps to re-train ML model automatically and make\u2026"}, "outgoing_paragraph_urls": [{"url": "https://apscheduler.readthedocs.io/en/stable/", "anchor_text": "APScheduler", "paragraph_index": 4}, {"url": "https://flask.palletsprojects.com/en/1.1.x/", "anchor_text": "Flask", "paragraph_index": 5}, {"url": "https://apscheduler.readthedocs.io/en/stable/", "anchor_text": "scheduler", "paragraph_index": 19}, {"url": "https://flask.palletsprojects.com/en/1.1.x/", "anchor_text": "Flask", "paragraph_index": 21}, {"url": "https://pm2.keymetrics.io/", "anchor_text": "PM2", "paragraph_index": 26}], "all_paragraphs": ["In this article, I\u2019m going to cover multiple topics and explain how to build Machine Learning pipeline. What is ML pipeline? This is a solution that helps to re-train ML model automatically and make it available through API. Re-training intervals can be configured through a scheduler, the model can be updated daily or at any other selected intervals.", "The brief architecture of the solution:", "I\u2019m using Keras to build a model, which can calculate wait time for enterprise report generation. Time is calculated based on Report ID, Report Parameters, and Day Part. There is a common rule, the one which model picks up during training \u2014 report run slower with fewer parameters and in the second part of the day.", "Python function which trains Keras model is fetching data, processing it, and then calls Keras API to fit the model. Model training is done in ten separate calls, to be able to select the best result. The best result is selected based on model evaluation results with test data, more on this later. The new model is saved using a timestamp, this allows the current model still to be served if there are any active calls happening at the same time (or maybe some users still would prefer to call the previous model \u2014 this adds extra flexibility).", "Model re-training is executed from APScheduler. I\u2019m using the background scheduler option, this allows us to run it together with REST API process (I\u2019m using PM2 to run Python process). This makes it more simple to control and REST API call is not blocked when re-training task runs.", "REST API runs using Flask library. Model predict function is executed by loading the latest available model with tf.keras.models.load_model API and calling predict function on top of it.", "The model logic is implemented in report_exec_time_model.py.", "Function fetch_data reads data from CSV. In this example, it always reads the same data (for simplicity reasons), but in the actual implementation, for each re-training, most likely you would read new data. Both training and test data sets are fetched. Training data contains 0\u201310 values for Report Parameters feature, test data contains 11\u201320. This is done on purpose, we are testing with data that was not known during training. This would allow us to check if the model was able to pick up the correct trend \u2014 execution time should decrease with more report parameters. Feature Report Parameters is normalized by calculating log to make the value smaller, hence help the model to learn it better. The same is applied for both training and test datasets. 20% of the training data is used for validation. Data structure:", "Test data for Report Parameters is from a different set and differs in scale from a train set, but using log makes it possible to normalize data in different sets by the same rule:", "Function build_feature_layer defines TensorFlow feature layer. This is a metadata layer that helps to execute automatic data conversion into the format which can be fed to a training algorithm. Features Report ID and Day Part are categorical. Both of these features are encoded as indicator columns using TensorFlow categorical feature support. Report Parameters feature is defined as a numeric column. All three columns are defined as TensorFlow feature layer \u2014 this allows to convert data without additional custom processing:", "Function build_dataset converts Pandas data into TensorFlow dataset. Such dataset can be sent directly to Keras model training:", "I\u2019m using batch size = 16. Based on my testing, this is an optimal batch to find the best fit during model training for given data. We don\u2019t need to shuffle training data, it was already shuffled during split into training and validation sets.", "Function build_model constructs the sequential Keras model. The model accepts as a first layer \u2014 feature layer (the list of features and how they are represented). There is no need to specify the input dimension. There are three layers, the third layer is the output layer (one unit/neuron). The first two layers are set with 16 and 8 units/neurons respectively and relu activation. The number of layers and units is selected by experimenting with different settings.", "The model is trained in train_model function. Training is repeated from scratch for ten times. The best model is saved as a result. The model is saved in TensorFlow format. After the training loop completes the best model is copied to the deployment folder accessible by API endpoint. Each new model is stored with a timestamp, this allows to implement model versioning. Training is configured with EarlyStopping callback, when there is no improvement in 10 epochs, training is stopped. Model training with TensorFlow dataset:", "Saving the best model. The model is evaluated based on the test set. I included data with Report Parameters > 10 into the test set, to be able to test how regression works on unseen data. The model should pick up a rule during training \u2014 with a larger number of report parameters, execution time should be shorter. I was glad to see that model was actually learning this rule correctly:", "Copying the best model into a directory accessible by API, along with timestamp value for versioning:", "This is the model training result with RMSE = 8.02 seconds (this means ~8 seconds error calculating report execution time for the test set data). We can see that it took around 100 epochs before EarlyStopping callback terminated training:", "Function run_predict accepts input data for inference, loads the latest available model, and executes predict call.", "Endpoint logic is implemented in report_exec_time_endpoint.py", "In this script, I implemented both re-training scheduler and REST API. Re-training runs in the background thread, this allows keeping REST API running without blocking.", "The scheduler is configured to run once per day, but it\u2019s up to you to configure re-training intervals. It makes sense to re-train when new data becomes available:", "REST API is implemented with Flask. Request parameters are sent for inference into the model (automatically picked up the best latest model trained from the scheduler, or you can implement other logic based on model versioning) predict method, the result is returned back to the client:", "Let\u2019s verify the model. Take for example this data from the model training set (Report ID, Report Parameters, Day Part = Time):", "Do inference with 15 report parameters. As expected, execution time is shorter = 429, this means model was trained correctly:", "With 11 report parameters, execution time is slightly longer, as it should:", "You can play around with different Report ID and Day Part values, to see how execution time calculation changes.", "Python endpoint process is running using PM2 manager. Start process with PM2 command:", "Hopefully, the information described in this article will help you to run a scalable Machine Learning pipeline in production. I believe the core part is an automated re-training option, this helps to keep the model up to date, when new data becomes available. The ability to run scheduled re-training in separate thread allows us to manage it in the same process as API endpoint. This makes pipeline simpler and more maintainable.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F770eb3f08a2d&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsimple-machine-learning-pipeline-770eb3f08a2d&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsimple-machine-learning-pipeline-770eb3f08a2d&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsimple-machine-learning-pipeline-770eb3f08a2d&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsimple-machine-learning-pipeline-770eb3f08a2d&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----770eb3f08a2d--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----770eb3f08a2d--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://andrejusb.medium.com/?source=post_page-----770eb3f08a2d--------------------------------", "anchor_text": ""}, {"url": "https://andrejusb.medium.com/?source=post_page-----770eb3f08a2d--------------------------------", "anchor_text": "Andrej Baranovskij"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fbbd1211c851b&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsimple-machine-learning-pipeline-770eb3f08a2d&user=Andrej+Baranovskij&userId=bbd1211c851b&source=post_page-bbd1211c851b----770eb3f08a2d---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F770eb3f08a2d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsimple-machine-learning-pipeline-770eb3f08a2d&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F770eb3f08a2d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsimple-machine-learning-pipeline-770eb3f08a2d&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://pixabay.com/users/alexei_other-9114223/", "anchor_text": "Alexei_other"}, {"url": "https://pixabay.com/", "anchor_text": "Pixabay"}, {"url": "https://apscheduler.readthedocs.io/en/stable/", "anchor_text": "APScheduler"}, {"url": "https://flask.palletsprojects.com/en/1.1.x/", "anchor_text": "Flask"}, {"url": "https://apscheduler.readthedocs.io/en/stable/", "anchor_text": "scheduler"}, {"url": "https://flask.palletsprojects.com/en/1.1.x/", "anchor_text": "Flask"}, {"url": "http://twitter.com/app", "anchor_text": "@app"}, {"url": "https://pm2.keymetrics.io/", "anchor_text": "PM2"}, {"url": "https://github.com/abaranovskis-redsamurai/automation-repo/tree/master/pipeline", "anchor_text": "GitHub"}, {"url": "https://medium.com/tag/python?source=post_page-----770eb3f08a2d---------------python-----------------", "anchor_text": "Python"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----770eb3f08a2d---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/tag/programming?source=post_page-----770eb3f08a2d---------------programming-----------------", "anchor_text": "Programming"}, {"url": "https://medium.com/tag/tensorflow?source=post_page-----770eb3f08a2d---------------tensorflow-----------------", "anchor_text": "TensorFlow"}, {"url": "https://medium.com/tag/keras?source=post_page-----770eb3f08a2d---------------keras-----------------", "anchor_text": "Keras"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F770eb3f08a2d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsimple-machine-learning-pipeline-770eb3f08a2d&user=Andrej+Baranovskij&userId=bbd1211c851b&source=-----770eb3f08a2d---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F770eb3f08a2d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsimple-machine-learning-pipeline-770eb3f08a2d&user=Andrej+Baranovskij&userId=bbd1211c851b&source=-----770eb3f08a2d---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F770eb3f08a2d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsimple-machine-learning-pipeline-770eb3f08a2d&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----770eb3f08a2d--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F770eb3f08a2d&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsimple-machine-learning-pipeline-770eb3f08a2d&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----770eb3f08a2d---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----770eb3f08a2d--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----770eb3f08a2d--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----770eb3f08a2d--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----770eb3f08a2d--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----770eb3f08a2d--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----770eb3f08a2d--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----770eb3f08a2d--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----770eb3f08a2d--------------------------------", "anchor_text": ""}, {"url": "https://andrejusb.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://andrejusb.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Andrej Baranovskij"}, {"url": "https://andrejusb.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "1.2K Followers"}, {"url": "https://github.com/katanaml", "anchor_text": "https://github.com/katanaml"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fbbd1211c851b&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsimple-machine-learning-pipeline-770eb3f08a2d&user=Andrej+Baranovskij&userId=bbd1211c851b&source=post_page-bbd1211c851b--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fd22cc5338107&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsimple-machine-learning-pipeline-770eb3f08a2d&newsletterV3=bbd1211c851b&newsletterV3Id=d22cc5338107&user=Andrej+Baranovskij&userId=bbd1211c851b&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}