{"url": "https://towardsdatascience.com/convert-to-new-spark-3-0-udf-style-8d2e4cee3c0f", "time": 1683011673.94866, "path": "towardsdatascience.com/convert-to-new-spark-3-0-udf-style-8d2e4cee3c0f/", "webpage": {"metadata": {"title": "Convert to New Spark 3.0 UDF Style | by Edward Cui | Towards Data Science", "h1": "Convert to New Spark 3.0 UDF Style", "description": "Apache Spark 2.3 release introduced Pandas UDF back in 2017. This new feature has significantly improved the performance of Python UDFs since Apache Arrow replaced Py4J to accelerate data transfer\u2026"}, "outgoing_paragraph_urls": [], "all_paragraphs": ["Apache Spark 2.3 release introduced Pandas UDF back in 2017. This new feature has significantly improved the performance of Python UDFs since Apache Arrow replaced Py4J to accelerate data transfer between JVM and Python. By interfacing Spark with Pandas, users can easily scale their methodologies written in Python libraries (e.g. sklearn, scipy) by wrapping them around Pandas UDFs.", "In addition to the original Python UDF ( pyspark.sql.functions.udf introduced in version 1.3), Spark 2.3+ has 3 types of Pandas UDF, including PandasUDFType.SCALAR, PandasUDFType.GROUPED_MAP (both introduced in version 2.3.0), and PandasUDFType.GROUPED_AGG (introduced in version 2.4, which can also be used as a window function). In June 2020, the release of Spark 3.0 introduced a new set of interfaces for Pandas UDF. In this article, I will briefly explore two examples of how the old style (Pandas) UDFs can be converted to the new styles.", "I simulated a dataframe with the following 4 columns", "First, define some functions for simulation", "which gets a dataframe that looks like the following", "Then, repeat this dataframe 1000 times", "This is a good size of data to work with using Spark, with", "The original spark.sql.functions.udf applies a custom function to each item in the column, taking the values of another column(s) as inputs. In this example, we use withColumn to store the results of the udf application.", "The results look like the following", "In Spark 3.0, we can use an iterator Pandas UDF instead", "The iterator uses Python typing as hints, to let the function know that it is iterating over a pair of pandas.series as inputs, and returns another pandas.series. The pandas_udf decorator above specifies what data type the element of the series is to be returned. Note that the length of the input needs to be the same as the length of the output series. The nested function apply_custom_mapper takes the two columns as Pandas series, and user need to iterate over each element of the series to apply a function (e.g. custom_mapper). Then next, the user needs to construct the iterator to yield the results of the function application. This seems like a double for-loop, but it is really separating the iteration of inputs and outputs, i.e. first iterate on the inputs to apply the elementary function custom_mapper to get an iterator of results, then map the results step by step back to the output series.", "groupby.apply(pandas_udf) patterns are often used to apply a custom function by iterating over each sub-group of the dataframe. The custom pandas_udf takes the data of each group as a Pandas Dataframe (which we denote as pdf_in) as the input and returns another Pandas Dataframe as output (which we denote as pdf_out). The schema of pdf_out does not need to be the same as that of pdf_in. In the following example, we will replace the secret column with the cumulative sum (casted to string) of the column n within the group. Then we will drop the column n. We need to specify in the panads_udf decorator the output schema, which we obtain from df.drop(\"n\").schema.", "For adding a new column in the schema, we can do", "The output of the above code looks like this", "The number of rows returned by the UDF does not have to be the same as that of the input. In the following example, we modify the above script such that we only return every other row.", "The new interface uses groupby.applyInPandas(python_func, schema) instead.", "The first example then changed to", "The second example is changed to", "Notice that apply takes a pandas_udf function, where the schema is specified within the decorator. On the other hand, applyInPandas takes a Python function, where the schema is specified within the applyInPandas arguments.", "One last thing to note is the memory usage of these functions. Spark\u2019s Pandas UDF documentation indicates that the entire group of data will be loaded into memory. In our groupby examples, we would have pdf as a dataframe of 10000 rows, hence we would expect to have ~43 MB of data per executor core. If we have 5 cores per executor. Then that becomes 215 MB of data in the memory. In addition, the memory stack of our UDF also adds on top of memory usage. Suppose we convert the length 4096 hex string to binary as a numpy boolean array of length 16384, each array would consume about 16kB of memory, and 10000 of these would consume an additional 165 MB. 5 cores would total an extra 825 MB, which would total over 1GB of memory. Thus, when tuning Spark with Pandas UDF involved, it is necessary to pay attention to the amount of memory used by the UDF, in addition to the size of the exposed data group as a Pandas DataFrame.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "A data science researcher who keeps it real"], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F8d2e4cee3c0f&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fconvert-to-new-spark-3-0-udf-style-8d2e4cee3c0f&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fconvert-to-new-spark-3-0-udf-style-8d2e4cee3c0f&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fconvert-to-new-spark-3-0-udf-style-8d2e4cee3c0f&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fconvert-to-new-spark-3-0-udf-style-8d2e4cee3c0f&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----8d2e4cee3c0f--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----8d2e4cee3c0f--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@cui23327?source=post_page-----8d2e4cee3c0f--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@cui23327?source=post_page-----8d2e4cee3c0f--------------------------------", "anchor_text": "Edward Cui"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F89fd9231764f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fconvert-to-new-spark-3-0-udf-style-8d2e4cee3c0f&user=Edward+Cui&userId=89fd9231764f&source=post_page-89fd9231764f----8d2e4cee3c0f---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F8d2e4cee3c0f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fconvert-to-new-spark-3-0-udf-style-8d2e4cee3c0f&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F8d2e4cee3c0f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fconvert-to-new-spark-3-0-udf-style-8d2e4cee3c0f&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://unsplash.com/@ianjbattaglia?utm_source=medium&utm_medium=referral", "anchor_text": "Ian Battaglia"}, {"url": "https://unsplash.com?utm_source=medium&utm_medium=referral", "anchor_text": "Unsplash"}, {"url": "https://medium.com/tag/spark?source=post_page-----8d2e4cee3c0f---------------spark-----------------", "anchor_text": "Spark"}, {"url": "https://medium.com/tag/pandas?source=post_page-----8d2e4cee3c0f---------------pandas-----------------", "anchor_text": "Pandas"}, {"url": "https://medium.com/tag/pandasudf?source=post_page-----8d2e4cee3c0f---------------pandasudf-----------------", "anchor_text": "Pandasudf"}, {"url": "https://medium.com/tag/python?source=post_page-----8d2e4cee3c0f---------------python-----------------", "anchor_text": "Python"}, {"url": "https://medium.com/tag/big-data?source=post_page-----8d2e4cee3c0f---------------big_data-----------------", "anchor_text": "Big Data"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F8d2e4cee3c0f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fconvert-to-new-spark-3-0-udf-style-8d2e4cee3c0f&user=Edward+Cui&userId=89fd9231764f&source=-----8d2e4cee3c0f---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F8d2e4cee3c0f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fconvert-to-new-spark-3-0-udf-style-8d2e4cee3c0f&user=Edward+Cui&userId=89fd9231764f&source=-----8d2e4cee3c0f---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F8d2e4cee3c0f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fconvert-to-new-spark-3-0-udf-style-8d2e4cee3c0f&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----8d2e4cee3c0f--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F8d2e4cee3c0f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fconvert-to-new-spark-3-0-udf-style-8d2e4cee3c0f&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----8d2e4cee3c0f---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----8d2e4cee3c0f--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----8d2e4cee3c0f--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----8d2e4cee3c0f--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----8d2e4cee3c0f--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----8d2e4cee3c0f--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----8d2e4cee3c0f--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----8d2e4cee3c0f--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----8d2e4cee3c0f--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@cui23327?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@cui23327?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Edward Cui"}, {"url": "https://medium.com/@cui23327/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "6 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F89fd9231764f&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fconvert-to-new-spark-3-0-udf-style-8d2e4cee3c0f&user=Edward+Cui&userId=89fd9231764f&source=post_page-89fd9231764f--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fusers%2F89fd9231764f%2Flazily-enable-writer-subscription&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fconvert-to-new-spark-3-0-udf-style-8d2e4cee3c0f&user=Edward+Cui&userId=89fd9231764f&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}