{"url": "https://towardsdatascience.com/predicting-the-spread-of-covid-19-using-networks-in-r-part-2-a85377f5fc39", "time": 1683015715.2940779, "path": "towardsdatascience.com/predicting-the-spread-of-covid-19-using-networks-in-r-part-2-a85377f5fc39/", "webpage": {"metadata": {"title": "Predicting the spread of Covid-19 using networks in R-Part 2 | by James Lowe | Towards Data Science", "h1": "Predicting the spread of Covid-19 using networks in R-Part 2", "description": "In part one we showed why networks can be useful in predicting the spread of Covid-19, and we created and visualised a geographic network of small areas within the UK called MSOAs. We finished by\u2026"}, "outgoing_paragraph_urls": [{"url": "https://towardsdatascience.com/predicting-the-spread-of-covid-19-using-networks-in-r-2fee0013db91", "anchor_text": "part one", "paragraph_index": 0}, {"url": "https://github.com/theOtherJLo/using_networks_to_predict_covid_cases", "anchor_text": "on github", "paragraph_index": 2}, {"url": "https://rdrr.io/github/thomasp85/tidygraph/man/map_local.html", "anchor_text": "map_local", "paragraph_index": 21}, {"url": "https://www.r-bloggers.com/2015/07/r-tutorial-on-the-apply-family-of-functions/", "anchor_text": "apply family", "paragraph_index": 27}, {"url": "https://www.imperial.ac.uk/stories/coronavirus-modelling/", "anchor_text": "this work", "paragraph_index": 42}, {"url": "https://github.com/theOtherJLo/using_networks_to_predict_covid_cases", "anchor_text": "on GitHub", "paragraph_index": 43}], "all_paragraphs": ["In part one we showed why networks can be useful in predicting the spread of Covid-19, and we created and visualised a geographic network of small areas within the UK called MSOAs. We finished by showing a network of these areas in Leicester, overlaid onto a map of Leicester (as shown below). We focussed on Leicester because it was the first area in England to have a local lockdown.", "In this second and final part, we are going to use this network to generate features about each area. We will finish by using these features to create a model to predict the number of Covid cases an area will get in the coming week.", "Except for the work we covered in part one, we will showcase code as we go along, and you can find all of the code on github.", "We start with two R objects. The first is msoa which is a tibble containing MSOA case data, and the second is msoa_network which is a {tidygraph} network object of every MSOA in England, where the nodes are MSOAs and an edge connects two MSOAs if they are neighbours. The above image shows us this network but just for Leicester.", "These are all the packages that were used to create the data and visualisations shown in this post.", "There are two ways we can use our network to create features, and it helps to think of them separately.", "The first are features based off the structure of the network for example, the number of neighbours an area has (AKA it\u2019s degree). The thinking here is that the way the LAs are grouped and connected might be a good indication for how Covid spreads through the network.", "The second are features based off of what is happening in neighbouring areas, for example, how many cases there are in neighbouring MSOAs. The thinking here is that an area surrounded by high case numbers can expect to see a rise itself in the following week.", "We will examine a few of these, show how we derived them for our network and then show the values of these features for each of the MSOAs in Leicester.", "Degree = The number of neighbours. You can see from the below image that we have two different ways of visualising this.", "The first is using the Network, which makes it easier to see the edges connecting each MSOA. Using this network, you can easily count up all the neighbours of any of the central MSOAs to see it matches their degree. We can\u2019t do this for the bordering MSOAs because we haven\u2019t plotted all of their neighbours as they aren\u2019t all in Leicester.", "The second method is to visualise using a map. This can make it easier to see the distribution of values across the whole LA.", "Betweenness = How many shortest paths a node sits on. This is a measure of node importance. If you wanted to travel from one MSOA to another, there is always at least one shortest route which minimises the number of MSOAs you have to go through. You might therefore expect a node with high betweenness to have more people travelling through it. In reality, this measure is unlikely to represent this here, and the shortest travel distance in real life has nothing to do with minimising MSOAs you travel through. However, it does give some extra context that a model might find helpful.", "Again, as we are only plotting a subset of a whole network, we can\u2019t try and calculate the betweenness just from the Leicester network alone.", "Triangles = The number of triangles this node is part of. A triangle is just a situation where you have three nodes which are all connected to each other. In our case, this happens when an MSOA borders two MSOAs which also border each other. We might expect Covid to spread more in an area where there are a lot of triangles, as the MSOAs are more connected.", "Transitivity = How much local clustering there is. This is a measure of how many of a node\u2019s neighbours are also neighbours, and is calculated by dividing the number of pairs of neighbours by how many triangles that node is in. Social networks have high transitivity, as friends of friends are quite likely to themselves be friends. We might expect a higher value to impact how Covid spreads through the network, because it means areas are more interconnected.", "Creating these features is really easy to do, by combining handy {igraph} functions with {tidygraph} mutate methodology.", "We start with our network object. We activate the nodes, so it knows the following mutate is to be applied to the underlying node data. We then apply mutate, defining our new features to be the corresponding {igraph} function applied to our network object, which is obtained using .G() .", "The only difference is that for transitivity you have to specify you want to use local transitivity (i.e. the transitivity of each node) rather than network transitivity (which is a single metric for the whole network).", "We now want to generate features based on what is happening in neighbouring MSOAs, for example, the number of cases. Unlike with the above features, which only need to be generated once, we need to generate this for every week of case data we have. To start, we will just look at this for a specific week, namely week 25 which is when Leicester had its first spike.", "First of all, we join on the cases data to our network object. Again, we take advantage of the way we can use {dplyr} verbs like left_join() on {tidygraph} objects.", "Now there is a whole suite of {tidygraph} functions that let you apply custom functions at a neighbourhood level (see map_local for an example) however, what we want here is quite simple, and the most efficient way of calculating it (by a long way) is to use an adjacency matrix.", "You may recall from last time that an adjacency matrix defines a network. It has a row and column for every node in the network and the value of cell (i, j) is 1 if an edge connects node i to node j and 0 otherwise.", "We used an adjacency matric to create our network in the first place, however, it is very easy to obtain an adjacency matrix from an existing network in the following way:", "Now if we have a vector of values for each node in the network, like covid cases for example, let\u2019s think about what happens if we multiply the adjacency matrix to this vector. The result will be a vector of the same length. Position i will just be the sum of all the values of the original vector multiply their positions in row i of the adjacency matrix. But we know row i is all 0s except for the neighbours of row i, and in those places, it is just 1. We therefore see that the result is just a sum of all the Covid cases in all the nodes that neigbour node i, which is exactly what we want! And because this is just matrix multiplication, it happens really quickly.", "So we now know that in order to generate this \u201ccovid cases in neighbouring MSOAs\u201d feature, we just need to multiply the adjacency matrix by a vector of Covid cases in each MSOA. This can be easily done in the following way:", "Again we can apply mutate to our tidygraph object. We get our vector of cases by using .N() which access the node data underlying the network, and then using $cases to take the vector of cases. We multiply our adjacency matric to this using matrix multiplication, which in R is denoted by %*% . Finally we wrap the result in as.vector() so R, and more specifically mutate, knows to treat this as a vector. We calculate the average number of cases by dividing by the degree of the node.", "Now we have done this for a single week, we just need to do it for every week. I did this using lapply in the following way. If you are unfamiliar with the apply family, it is similar to a for loop, but more efficient. The code we are applying on a weekly basis should look very similar to what we did above. The key difference here is we are doing it for every week in our data, then binding together all the results at the end.", "With this, we have created a data set which should look much more familiar for undertaking predictive modelling. We have one row per MSOA per week, with lots of features that might help us predict the following week. We have provided an extract below so you can see these new features we have created for a particular MSOA for a subset of weeks. Note, we have created a \u201ccases_next_week\u201d variable, as this will be our outcome variable. In other words, we are going to use all the other variables to try and predict how many cases there will be next week.", "Like with the other features, we are able to visualise these on a map for any given week. The below visualisation shows this for week 25. In other words, the brighter one area is, the more cases there are in its neighbouring areas. We have called this variable \u201ccases nb\u201d.", "We are going to use the above dataset to try and predict \u201ccases_next_week\u201d using the other variables. This blog post is not going to delve deeply into predictive modelling or machine learning methodology or best practices. Instead, we will show you how to create a simple linear model using the dataset created above. If you are using this blog series to create your own predictive models from networks, you can then just substitute in your favourite models instead.", "Just to see how well the model results generalise, we split the data into training and test datasets. We do this so roughly 70% of the data is used for training and 30% for test.", "We split using the week variable, so we are training on all data up to a certain point in time, and testing on the rest of the data. This is to avoid a situation where we are testing on past data, which might result in data leakage. If we were to try and put this model to practice and predict what was happening next week, we would never have training data from the future.", "Now we just create out model using the lm function.", "Here we can examine the summary of the model, and reassuringly see that \u201ccases_in_neighbourhood_average\u201d has a similar sized coefficient to \u201ccases\u201d which you would expect to be extremely important. This means that an extra case in an MSOA has a similar associative effect on cases next week, than if we got an extra case in every neighbouring area. In other words, the model is relying upon our neighbouring features.", "Interestingly it looks like the features based on the structure of the network have a more uncertain relationship with next week cases, and don\u2019t have the effect we expected. For example, most of their coefficients are negative. This might have something to do with the fact that having a network structure susceptible to the spread of Covid means little if there is not much Covid in the area.", "We can create predictions for our test data in the following way.", "This lets us compare predictions and observations on unseen data. For example, here we calculate the RMSE on the test data and see it is 8.36 which is much higher than the 0.35 achieved on the training data, showing the model suffers from overfitting.", "There are obviously hundreds of different ways a model like this can be used. One way is to visualise the outputs on a map. The below shows our models predictions for cases in each MSOA for week 41 based on data from week 40 (which was in our test data) and compares it to what actually happened in week 41.", "Now as you can probably tell from the above visualisation, this model isn\u2019t particularly good. It is wrong about a lot of areas, and even when it\u2019s right, it\u2019s heavily relying on how many cases that area already has which isn\u2019t very helpful. To give you an idea of this, if we replaced this model with a baseline model which just assumed that case numbers didn\u2019t change, we would get an RMSE of 8.18, which is better than our linear model.", "If we were looking to use this model in the real world, a lot of work would be needed to understand how it would be used, and designing a model pipeline around that. This is just the nature of predictive modelling. Here\u2019s a few ideas for things you would probably want to explore if you were to do this yourself:", "This post effectively shows how you can start with nothing but information about how things are connected (like geographical neighbours) and create many useful features which can be used in predictive modelling.", "Covid-19 is continuing to have a huge effect on our lives and society. Due to the exponential nature of disease spread, being given any warning on where an outbreak is likely to happen can make a huge difference in terms of the options and impact of the response. There is already a lot of very impressive modelling work going on to try and give this extra warning (for example this work by Imperial). This blog post shows that networks could be used to provide additional features that could make models even more accurate, and therefore help us fight this disease.", "All the code used in this post can be found on GitHub where renv has been used to deal with package versions and dependencies.", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "Maths Masters graduate, and a Data Scientist working in the public sector."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2Fa85377f5fc39&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-the-spread-of-covid-19-using-networks-in-r-part-2-a85377f5fc39&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-the-spread-of-covid-19-using-networks-in-r-part-2-a85377f5fc39&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-the-spread-of-covid-19-using-networks-in-r-part-2-a85377f5fc39&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-the-spread-of-covid-19-using-networks-in-r-part-2-a85377f5fc39&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----a85377f5fc39--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----a85377f5fc39--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://lowe-james.medium.com/?source=post_page-----a85377f5fc39--------------------------------", "anchor_text": ""}, {"url": "https://lowe-james.medium.com/?source=post_page-----a85377f5fc39--------------------------------", "anchor_text": "James Lowe"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F2e7cb5074bee&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-the-spread-of-covid-19-using-networks-in-r-part-2-a85377f5fc39&user=James+Lowe&userId=2e7cb5074bee&source=post_page-2e7cb5074bee----a85377f5fc39---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fa85377f5fc39&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-the-spread-of-covid-19-using-networks-in-r-part-2-a85377f5fc39&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fa85377f5fc39&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-the-spread-of-covid-19-using-networks-in-r-part-2-a85377f5fc39&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://towardsdatascience.com/predicting-the-spread-of-covid-19-using-networks-in-r-2fee0013db91", "anchor_text": "part one"}, {"url": "https://github.com/theOtherJLo/using_networks_to_predict_covid_cases", "anchor_text": "on github"}, {"url": "https://rdrr.io/github/thomasp85/tidygraph/man/map_local.html", "anchor_text": "map_local"}, {"url": "https://towardsdatascience.com/graph-theory-set-matrix-notation-7dfb04b8ed24", "anchor_text": "blog series on graph theory"}, {"url": "https://www.r-bloggers.com/2015/07/r-tutorial-on-the-apply-family-of-functions/", "anchor_text": "apply family"}, {"url": "https://www.imperial.ac.uk/stories/coronavirus-modelling/", "anchor_text": "this work"}, {"url": "https://github.com/theOtherJLo/using_networks_to_predict_covid_cases", "anchor_text": "on GitHub"}, {"url": "https://medium.com/tag/r?source=post_page-----a85377f5fc39---------------r-----------------", "anchor_text": "R"}, {"url": "https://medium.com/tag/network?source=post_page-----a85377f5fc39---------------network-----------------", "anchor_text": "Network"}, {"url": "https://medium.com/tag/covid-19?source=post_page-----a85377f5fc39---------------covid_19-----------------", "anchor_text": "Covid-19"}, {"url": "https://medium.com/tag/data-science?source=post_page-----a85377f5fc39---------------data_science-----------------", "anchor_text": "Data Science"}, {"url": "https://medium.com/tag/visualization?source=post_page-----a85377f5fc39---------------visualization-----------------", "anchor_text": "Visualization"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fa85377f5fc39&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-the-spread-of-covid-19-using-networks-in-r-part-2-a85377f5fc39&user=James+Lowe&userId=2e7cb5074bee&source=-----a85377f5fc39---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2Fa85377f5fc39&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-the-spread-of-covid-19-using-networks-in-r-part-2-a85377f5fc39&user=James+Lowe&userId=2e7cb5074bee&source=-----a85377f5fc39---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fa85377f5fc39&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-the-spread-of-covid-19-using-networks-in-r-part-2-a85377f5fc39&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----a85377f5fc39--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2Fa85377f5fc39&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-the-spread-of-covid-19-using-networks-in-r-part-2-a85377f5fc39&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----a85377f5fc39---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----a85377f5fc39--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----a85377f5fc39--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----a85377f5fc39--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----a85377f5fc39--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----a85377f5fc39--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----a85377f5fc39--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----a85377f5fc39--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----a85377f5fc39--------------------------------", "anchor_text": ""}, {"url": "https://lowe-james.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://lowe-james.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "James Lowe"}, {"url": "https://lowe-james.medium.com/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "19 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F2e7cb5074bee&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-the-spread-of-covid-19-using-networks-in-r-part-2-a85377f5fc39&user=James+Lowe&userId=2e7cb5074bee&source=post_page-2e7cb5074bee--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fusers%2F2e7cb5074bee%2Flazily-enable-writer-subscription&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fpredicting-the-spread-of-covid-19-using-networks-in-r-part-2-a85377f5fc39&user=James+Lowe&userId=2e7cb5074bee&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}