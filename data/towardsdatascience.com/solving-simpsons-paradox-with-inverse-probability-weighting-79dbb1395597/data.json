{"url": "https://towardsdatascience.com/solving-simpsons-paradox-with-inverse-probability-weighting-79dbb1395597", "time": 1683004133.6151302, "path": "towardsdatascience.com/solving-simpsons-paradox-with-inverse-probability-weighting-79dbb1395597/", "webpage": {"metadata": {"title": "Solving Simpson\u2019s Paradox with Inverse Probability Weighting | by Ehud Karavani | Towards Data Science", "h1": "Solving Simpson\u2019s Paradox with Inverse Probability Weighting", "description": "An intuition on how Inverse Propensity Weighting (IPW) - a popular causal-inference method - works, and how it helps solve Simpson's Paradox."}, "outgoing_paragraph_urls": [{"url": "https://www.tandfonline.com/doi/abs/10.1080/01621459.1972.10482387", "anchor_text": "\u00b9", "paragraph_index": 18}, {"url": "https://www.ncbi.nlm.nih.gov/pmc/articles/PMC1339981/", "anchor_text": "real-world example", "paragraph_index": 19}], "all_paragraphs": ["Statisticians love using the word \u201cparadox\u201d to describe simply unintuitive results, regardless of how much it upsets their fellow logicians. To get back at them, we\u2019ll apply causality to solve one of their most famous paradoxes \u2014 Simpson\u2019s Paradox.", "In this post, I will briefly introduce what IPW is in the context of causal inference and present a simple intuition to how it works. I will then provide a popular example of the paradox from the medical domain and we\u2019ll see, visually, how IPW solves it.Want to skip the details? Scroll to the end of the article.", "IPW, short for Inverse Probability (sometimes Propensity) Weighting, is a popular method for estimating causal effects from data. It\u2019s a simple yet powerful tool to eliminate confounding or selection bias. To keep it casual (ha!), let\u2019s introduce it via a simple hypothetical example of estimating the causal effect of drug D on the risk of stroke.", "For that, we\u2019ll make a quick detour through randomized control trials.", "Usually, to estimate the causal effect of a drug, we would construct a Randomized Control Trial (RCT). This means, we would recruit people and flip a coin to assign them either to take drug D or to take placebo (control). Then we would measure the rate of stroke in each group, compare them, and conclude whether D increased or decreased the risk of illness.", "We know that there are multiple contributing factors to stroke. For example, sex (vascular systems can be differentiated between males and females) and age (veins tend to clog with time). The reason we could simply compare the two groups and disregard those other factors has everything to do with the randomization we applied.The randomization creates a similar distribution of age and sex between the two groups (on average). Consequently, when comparing the groups, the contributions of those variables cancel themselves out. The only parameter consistently different between the groups is whether they took D or placebo, and therefore, the differences we observed in the risk can be contributed only to D, making them the causal effect of D.", "We can decompose the risk of stroke in our simple example into a slightly more concise mathematical notation:", "We compare the risk between between our groups by taking the difference.Since age and sex are distributed similarly between groups, they contribute the same risk in both groups and so they cancel themselves out. Since placebo is a small sugar pill, its contribution is zero. Hence, we are left only with:risk_stroke_treated -risk_stroke_control = risk_because_D.", "Voil\u00e0! The causal effect of D on stroke.", "However, performing a randomized control trial costs money and takes a long time (among other disadvantages). Still paying our student-loan, we don\u2019t have the resources to conduct such an experiment. What we do have is data, because data is becoming ever cheaper and HMOs collect them easily.", "The problem with such observational data from HMOs is that it no longer comes from our nice experimental distribution. Unfortunately for us (but really luckily for us), physicians are not random. They assign treatments based on our characteristics (say, age and sex). Therefore, there might be an overall tendency to prescribe certain groups with one drug and not the other. In this case, if we were to simply compare those who did take D with those who did not, the distribution of those factors will not necessarily be the same and so their contribution will no longer cancel out.Consequently, the \u201ceffect\u201d we\u2019ll observe will no longer be the causal effect of D, but rather a quantity entangling both causal and non-causal impacts, essentially contaminating the causal effect of D with the contribution of those other factors.", "To estimate the true causal effect, we\u2019ll first need to make the two groups comparable, and the way to make them comparable is where causal inference, and specifically IPW, comes into play.", "Now that we have set the scene, we can finally present what IPW is. As we said, IPW stands for Inverse Propensity Weighting. It\u2019s a method to balance groups by giving each data-point a weight, so that the weighted-distribution of features in first group is similar to the weighted-distribution of the second one.", "We mentioned that physicians don\u2019t prescribe drugs randomly, but rather base it on the features of their patients. Therefore, each patient will have a different likelihood to be prescribed to D, based on their characteristics. This likelihood is referred to the propensity to be treated. To put it mathematically, if we mark our patient features as X, the propensity is the probability of patients getting or not getting the treatment: Pr[D|X]. Once we estimated this probability to treat, the weight we assign is simply its inverse: 1/Pr[D|X].", "When we have a large number of features, we will need some machine learning model to crunch all those high dimensional data into one probability scalar. But in order to see why this process even results in a balanced population, let\u2019s take the simple example with one feature, say being an adult male.", "Examining the distribution in the above figure, we see that our groups are imbalanced with regard to males. Therefore, if we were to simply calculate an average risk in each group, we would not be able to say whether the difference we see is due to being treated or simply because of being a male.Our first step is to calculate the probability of each individual to be in the group they are actually assigned to. We have 5 men in total, 1 treated and 4 that are not. Hence, we can make a simple estimate that the probability for males to get the drug is \u2155 and the probability for males to not get the drug is \u2158.", "Our second step is to inverse those probabilities and assign them to each individual. Homer, therefore, getting a weight of 5, while Moe, Barney, Groundskeeper Willie, and Principal Skinner each get a weight of 5/4. We basically create a pseudo population where we have 5 Homers, and we have 5/4 of each of the untreated \u2014 meaning we have one Moe, one Barney, one Willie, and one Skinner, and another hybrid-person which is \u00bc of each. Making that a total of 5 treated and 5 controls.", "See that we were able to create a population in which males are evenly distributed between groups.In real life, of course, there will be more than one feature to handle, and that\u2019s why we\u2019ll need a model to estimate Pr[D|X].", "By now you might have a hunch how we can use IPW to solve Simpson\u2019s paradox, but before we do, let\u2019s briefly introduce what this paradox is all about.Simpson\u2019s Paradox, a term coined by Blyte\u00b9, is named after Edward Simpson, the first statistician to explicitly point to this problem. In short, the paradox happens when an overall average trend in the population is reversed or canceled-out when examining its composing sub-groups.The intuition in the continuous case is very clear, as suggested by this GIF:", "To get a better understanding of the phenomena, let\u2019s examine a real-world example:According to the paper, we have two ways to treat kidney-stones. Either with an open-surgery (A) or with a new non-invasive method using shock-waves (B). We gather medical records from 700 people, 350 from each treatment-group and compare their success rates.", "Wishing to conclude which method is better, we compare the success rates among group A and B and see they are 78% and 82.5%, respectively. Naively, we want to deduce B is better (by 4.5%), but we remember we read somewhere (where?) that physicians are not random. We suspect there\u2019s probably some reason as to why patients got a certain treatment but not the other, and that it probably has to do with their prior medical condition.", "Lo and behold, when we split the patients based on stone size \u2014 we see a different trend. Suddenly it is treatment A that is better for both small stones and large stones \u2014 93.1 and 73% respectively.", "Do you see what the denominator is hiding? The game is rigged. B got the majority of easy cases (small stones), while A got the majority of hard cases. Severity of the patients is not similarly distributed across treatment groups. Since larger stones also have a lower chance of success \u2014 because they are more difficult to handle, we find ourselves in a biased situation where comparison of treatments is not fair. This is common in day-to-day scenarios, because when physicians encounter tougher cases (larger stones), they will tend to use bigger guns (open surgery).", "Generally speaking, a variable that affects both the treatment assignment and the outcome is called a confounding variable. In our case, the severity of patients, expressed by the size of their kidney stones, is a confounder since it increases both the likelihood to be assigned to a harsher medical procedure (a surgery more likely to be effective), and increases the risk of failing (stones not being completely removed).", "In our final act of this post, we\u2019ll fix this discrepancy in features (severity through stone sizes) between the treated and controls using IPW.", "Therefore, we can easily calculate the weight of each individual by taking the inverted fraction of people from each group (since we look only at binary stone size, our individuals are basically identical within their groups, so we can use group-level weights). To compute an unbiased success risk, we simply calculate the average of the success risk weighted by these weights:", "And we see that now, even if we aggregate the size of stones, treatment A is better than B (by ~15%). This is consistent with A also being better in every sub-group, and so the reversal we saw before no longer exists.", "TL;DR in case you haven\u2019t read a word, here\u2019s the entire post summed up as a GIF:", "Your home for data science. A Medium publication sharing concepts, ideas and codes.", "A research scientist working on machine learning for healthcare. Causal inference, data visualization and multi-modal prediction."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F79dbb1395597&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsolving-simpsons-paradox-with-inverse-probability-weighting-79dbb1395597&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsolving-simpsons-paradox-with-inverse-probability-weighting-79dbb1395597&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsolving-simpsons-paradox-with-inverse-probability-weighting-79dbb1395597&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsolving-simpsons-paradox-with-inverse-probability-weighting-79dbb1395597&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----79dbb1395597--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----79dbb1395597--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@ehudkr?source=post_page-----79dbb1395597--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@ehudkr?source=post_page-----79dbb1395597--------------------------------", "anchor_text": "Ehud Karavani"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F2f86c3f9b1e0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsolving-simpsons-paradox-with-inverse-probability-weighting-79dbb1395597&user=Ehud+Karavani&userId=2f86c3f9b1e0&source=post_page-2f86c3f9b1e0----79dbb1395597---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F79dbb1395597&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsolving-simpsons-paradox-with-inverse-probability-weighting-79dbb1395597&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F79dbb1395597&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsolving-simpsons-paradox-with-inverse-probability-weighting-79dbb1395597&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://www.tandfonline.com/doi/abs/10.1080/01621459.1972.10482387", "anchor_text": "\u00b9"}, {"url": "https://www.ncbi.nlm.nih.gov/pmc/articles/PMC1339981/", "anchor_text": "real-world example"}, {"url": "https://medium.com/u/751b6306bd5d?source=post_page-----79dbb1395597--------------------------------", "anchor_text": "John Burn-Murdoch"}, {"url": "https://medium.com/tag/causal-inference?source=post_page-----79dbb1395597---------------causal_inference-----------------", "anchor_text": "Causal Inference"}, {"url": "https://medium.com/tag/simpsons-paradox?source=post_page-----79dbb1395597---------------simpsons_paradox-----------------", "anchor_text": "Simpsons Paradox"}, {"url": "https://medium.com/tag/ipw?source=post_page-----79dbb1395597---------------ipw-----------------", "anchor_text": "Ipw"}, {"url": "https://medium.com/tag/visualization?source=post_page-----79dbb1395597---------------visualization-----------------", "anchor_text": "Visualization"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F79dbb1395597&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsolving-simpsons-paradox-with-inverse-probability-weighting-79dbb1395597&user=Ehud+Karavani&userId=2f86c3f9b1e0&source=-----79dbb1395597---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F79dbb1395597&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsolving-simpsons-paradox-with-inverse-probability-weighting-79dbb1395597&user=Ehud+Karavani&userId=2f86c3f9b1e0&source=-----79dbb1395597---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F79dbb1395597&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsolving-simpsons-paradox-with-inverse-probability-weighting-79dbb1395597&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----79dbb1395597--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F79dbb1395597&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsolving-simpsons-paradox-with-inverse-probability-weighting-79dbb1395597&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----79dbb1395597---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----79dbb1395597--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----79dbb1395597--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----79dbb1395597--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----79dbb1395597--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----79dbb1395597--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----79dbb1395597--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----79dbb1395597--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----79dbb1395597--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@ehudkr?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@ehudkr?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Ehud Karavani"}, {"url": "https://medium.com/@ehudkr/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "73 Followers"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F2f86c3f9b1e0&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsolving-simpsons-paradox-with-inverse-probability-weighting-79dbb1395597&user=Ehud+Karavani&userId=2f86c3f9b1e0&source=post_page-2f86c3f9b1e0--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fec66ea90b7fc&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fsolving-simpsons-paradox-with-inverse-probability-weighting-79dbb1395597&newsletterV3=2f86c3f9b1e0&newsletterV3Id=ec66ea90b7fc&user=Ehud+Karavani&userId=2f86c3f9b1e0&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}