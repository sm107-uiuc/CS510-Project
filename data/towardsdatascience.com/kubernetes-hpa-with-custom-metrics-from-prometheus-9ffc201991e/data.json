{"url": "https://towardsdatascience.com/kubernetes-hpa-with-custom-metrics-from-prometheus-9ffc201991e", "time": 1683009990.4044302, "path": "towardsdatascience.com/kubernetes-hpa-with-custom-metrics-from-prometheus-9ffc201991e/", "webpage": {"metadata": {"title": "Kubernetes HPA with Custom Metrics from Prometheus | by Cezar Romaniuc | Towards Data Science", "h1": "Kubernetes HPA with Custom Metrics from Prometheus", "description": "Autoscaling Kubernetes deployments or replica sets using Horizontal Pod Autoscaler, Prometheus Adapter and custom metrics from Prometheus"}, "outgoing_paragraph_urls": [{"url": "https://prometheus.io/", "anchor_text": "Prometheus", "paragraph_index": 2}, {"url": "https://github.com/helm/charts/blob/master/stable/prometheus-adapter/README.md", "anchor_text": "stable/prometheus-adapter", "paragraph_index": 5}], "all_paragraphs": ["I decided to write these steps because I was recently involved in migrating a complex application from AWS to GCP and as with other systems of this kind we cannot meet their SLAs by relying on CPU or memory usage metrics only.", "Autoscaling is an approach to automatically scale up or down workloads based on the resource usage. The K8s Horizontal Pod Autoscaler:", "In what follows we\u2019ll focus on the custom metrics because the Custom Metrics API made it possible for monitoring systems like Prometheus to expose application-specific metrics to the HPA controller.", "In order to scale based on custom metrics we need to have two components:", "We would like to scale our application pods based on the endpoint latency.", "2. Since we\u2019ve got Prometheus metrics, it makes sense to use the Prometheus adapter to serve metrics out of Prometheus. A helm chart is listed on the Kubeapps Hub as stable/prometheus-adapter and can be used to install the adapter:", "3. Configure the adapter with myapplication_api_response_time_avg custom metric:", "We are exposing myapplication_api_response_time_avg and this will be queried by HPA. Each rule has to specify a few resource overrides and metricsQuery tells the adapter which Prometheus query it should execute when retrieving data.", "4. Check the value of the metric using the following command, which sends a raw GET request to the Kubernetes API server:", "Notice that the API uses Kubernetes-style quantities to describe metric values. The most common to see in the metrics API is the m suffix, which means milli-units, or 1000ths of a unit. If the metric is exactly a whole number of units, we might not see a suffix.", "5. Create a HPA that will scale up the myapplication-deployment if the latency exposed by myapplication_api_response_time_avg goes over 500 ms. After a couple of seconds, the HPA fetches the myapplication_api_response_time_avg value from the metrics API.", "6. Check the newly created HPA. We may notice that the autoscaler doesn\u2019t react immediately to latency spikes. By default, the metrics sync happens once every 30 seconds and scaling up and down can only happen if there was no rescaling within the last 3\u20135 minutes. In this way, the HPA prevents rapid execution of conflicting decisions and gives time for the Cluster Autoscaler to kick in.", "Dealing with autoscaling is a common task basically in every production ready systems and so is the case with the application that I mentioned about in the introduction where we had to autoscale based on latency, for example, in order to handle traffic bursts. By instrumenting this application and exposing the right metrics through Prometheus for autoscaling we could fine tune it to better handle bursts and ensure high availability.", "Your home for data science. A Medium publication sharing concepts, ideas and codes."], "all_outgoing_urls": [{"url": "https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F9ffc201991e&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderCollection&source=---two_column_layout_nav----------------------------------", "anchor_text": "Open in app"}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkubernetes-hpa-with-custom-metrics-from-prometheus-9ffc201991e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkubernetes-hpa-with-custom-metrics-from-prometheus-9ffc201991e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---two_column_layout_nav-----------------------new_post_sidenav-----------", "anchor_text": "Write"}, {"url": "https://medium.com/search?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkubernetes-hpa-with-custom-metrics-from-prometheus-9ffc201991e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign up"}, {"url": "https://medium.com/m/signin?operation=login&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkubernetes-hpa-with-custom-metrics-from-prometheus-9ffc201991e&source=post_page---two_column_layout_nav-----------------------global_nav-----------", "anchor_text": "Sign In"}, {"url": "https://towardsdatascience.com/?source=post_page-----9ffc201991e--------------------------------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----9ffc201991e--------------------------------", "anchor_text": "Towards Data Science"}, {"url": "https://medium.com/@cezarromaniuc?source=post_page-----9ffc201991e--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@cezarromaniuc?source=post_page-----9ffc201991e--------------------------------", "anchor_text": "Cezar Romaniuc"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F4b5720dd5457&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkubernetes-hpa-with-custom-metrics-from-prometheus-9ffc201991e&user=Cezar+Romaniuc&userId=4b5720dd5457&source=post_page-4b5720dd5457----9ffc201991e---------------------follow_byline-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F9ffc201991e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkubernetes-hpa-with-custom-metrics-from-prometheus-9ffc201991e&source=--------------------------bookmark_header-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F9ffc201991e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkubernetes-hpa-with-custom-metrics-from-prometheus-9ffc201991e&source=--------------------------bookmark_header-----------", "anchor_text": "Save"}, {"url": "https://github.com/kubernetes/metrics/blob/master/IMPLEMENTATIONS.md#custom-metrics-api", "anchor_text": "known solutions"}, {"url": "https://prometheus.io/", "anchor_text": "Prometheus"}, {"url": "https://github.com/DirectXMan12/k8s-prometheus-adapter", "anchor_text": "k8s-prometheus-adapter"}, {"url": "http://prometheus-server.prometheus", "anchor_text": "http://prometheus-server.prometheus"}, {"url": "https://github.com/helm/charts/blob/master/stable/prometheus-adapter/README.md", "anchor_text": "stable/prometheus-adapter"}, {"url": "https://medium.com/tag/kubernetes?source=post_page-----9ffc201991e---------------kubernetes-----------------", "anchor_text": "Kubernetes"}, {"url": "https://medium.com/tag/prometheus?source=post_page-----9ffc201991e---------------prometheus-----------------", "anchor_text": "Prometheus"}, {"url": "https://medium.com/tag/metrics?source=post_page-----9ffc201991e---------------metrics-----------------", "anchor_text": "Metrics"}, {"url": "https://medium.com/tag/custom-metrics?source=post_page-----9ffc201991e---------------custom_metrics-----------------", "anchor_text": "Custom Metrics"}, {"url": "https://medium.com/tag/autoscaling?source=post_page-----9ffc201991e---------------autoscaling-----------------", "anchor_text": "Autoscaling"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F9ffc201991e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkubernetes-hpa-with-custom-metrics-from-prometheus-9ffc201991e&user=Cezar+Romaniuc&userId=4b5720dd5457&source=-----9ffc201991e---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Ftowards-data-science%2F9ffc201991e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkubernetes-hpa-with-custom-metrics-from-prometheus-9ffc201991e&user=Cezar+Romaniuc&userId=4b5720dd5457&source=-----9ffc201991e---------------------clap_footer-----------", "anchor_text": ""}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F9ffc201991e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkubernetes-hpa-with-custom-metrics-from-prometheus-9ffc201991e&source=--------------------------bookmark_footer-----------", "anchor_text": ""}, {"url": "https://towardsdatascience.com/?source=post_page-----9ffc201991e--------------------------------", "anchor_text": "More from Towards Data Science"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fcollection%2Ftowards-data-science%2F9ffc201991e&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkubernetes-hpa-with-custom-metrics-from-prometheus-9ffc201991e&collection=Towards+Data+Science&collectionId=7f60cf5620c9&source=post_page-----9ffc201991e---------------------follow_footer-----------", "anchor_text": "Follow"}, {"url": "https://towardsdatascience.com/?source=post_page-----9ffc201991e--------------------------------", "anchor_text": "Read more from Towards Data Science"}, {"url": "https://medium.com/?source=post_page-----9ffc201991e--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----9ffc201991e--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----9ffc201991e--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----9ffc201991e--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----9ffc201991e--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----9ffc201991e--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----9ffc201991e--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@cezarromaniuc?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@cezarromaniuc?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Cezar Romaniuc"}, {"url": "https://medium.com/@cezarromaniuc/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "92 Followers"}, {"url": "https://www.linkedin.com/in/cezarromaniuc/", "anchor_text": "https://www.linkedin.com/in/cezarromaniuc/"}, {"url": "https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F4b5720dd5457&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkubernetes-hpa-with-custom-metrics-from-prometheus-9ffc201991e&user=Cezar+Romaniuc&userId=4b5720dd5457&source=post_page-4b5720dd5457--two_column_layout_sidebar-----------------------follow_profile-----------", "anchor_text": "Follow"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2Fbb2ed4b06fc4&operation=register&redirect=https%3A%2F%2Ftowardsdatascience.com%2Fkubernetes-hpa-with-custom-metrics-from-prometheus-9ffc201991e&newsletterV3=4b5720dd5457&newsletterV3Id=bb2ed4b06fc4&user=Cezar+Romaniuc&userId=4b5720dd5457&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}