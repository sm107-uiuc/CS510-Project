{"url": "https://medium.com/airbnb-engineering/architecting-a-machine-learning-system-for-risk-941abbba5a60", "time": 1682988217.332926, "path": "medium.com/airbnb-engineering/architecting-a-machine-learning-system-for-risk-941abbba5a60/", "webpage": {"metadata": {"title": "Architecting a Machine Learning System for Risk | by AirbnbEng | The Airbnb Tech Blog | Medium", "h1": "Architecting a Machine Learning System for Risk", "description": "At Airbnb, we want to build the world\u2019s most trusted community. Guests trust Airbnb to connect them with world-class hosts for unique and memorable travel experiences. Airbnb hosts trust that guests\u2026"}, "outgoing_paragraph_urls": [{"url": "https://www.linkedin.com/in/naseemh", "anchor_text": "Naseem Hakim", "paragraph_index": 0}, {"url": "https://www.linkedin.com/in/aaronkeys", "anchor_text": "Aaron Keys", "paragraph_index": 0}, {"url": "https://www.airbnb.com/trust", "anchor_text": "world\u2019s most trusted community", "paragraph_index": 1}, {"url": "http://www.cybersource.com/resources/collateral/pdf/CyberSource_MRC_Survey_Top_9_Fraud_Attacks.pdf", "anchor_text": "many", "paragraph_index": 3}, {"url": "http://en.wikipedia.org/wiki/Credit_card_fraud", "anchor_text": "different", "paragraph_index": 3}, {"url": "http://www.kount.com/use-cases", "anchor_text": "kinds", "paragraph_index": 3}, {"url": "http://www.idology.com/resources/fraud-glossary-of-terms/", "anchor_text": "risk", "paragraph_index": 3}, {"url": "http://www.ohadsamet.com/introduction-to-online-payments-risk-management-an-oreilly-ebook/", "anchor_text": "ebook", "paragraph_index": 8}, {"url": "http://nerds.airbnb.com/httpjson-services-in-modern-java/", "anchor_text": "modular", "paragraph_index": 12}, {"url": "http://en.wikipedia.org/wiki/Predictive_Model_Markup_Language", "anchor_text": "Predictive Model Markup Language (PMML)", "paragraph_index": 13}, {"url": "https://github.com/vruusmann", "anchor_text": "Villu Ruusmann", "paragraph_index": 13}, {"url": "http://openscoring.io/", "anchor_text": "most recent version", "paragraph_index": 13}, {"url": "https://github.com/andykram", "anchor_text": "Andy Kramolisch", "paragraph_index": 13}, {"url": "https://github.com/andykram/openscoring", "anchor_text": "modified Openscoring", "paragraph_index": 13}, {"url": "http://cran.r-project.org/web/packages/pmml/pmml.pdf", "anchor_text": "R PMML", "paragraph_index": 17}, {"url": "http://scikit-learn.org/stable/", "anchor_text": "scikit-learn", "paragraph_index": 18}, {"url": "http://www.cardfellow.com/blog/chargebacks/", "anchor_text": "simplification", "paragraph_index": 20}, {"url": "https://www.airbnb.com/jobs/departments/position/2213", "anchor_text": "data science", "paragraph_index": 25}, {"url": "https://www.airbnb.com/jobs/departments/position/12039", "anchor_text": "engineering", "paragraph_index": 25}, {"url": "http://airbnb.io", "anchor_text": "http://airbnb.io", "paragraph_index": 27}], "all_paragraphs": ["By Naseem Hakim & Aaron Keys", "At Airbnb, we want to build the world\u2019s most trusted community. Guests trust Airbnb to connect them with world-class hosts for unique and memorable travel experiences. Airbnb hosts trust that guests will treat their home with the same care and respect that they would their own. The Airbnb review system helps users find community members who earn this trust through positive interactions with others, and the ecosystem as a whole prospers.", "The overwhelming majority of web users act in good faith, but unfortunately, there exists a small number of bad actors who attempt to profit by defrauding websites and their communities. The trust and safety team at Airbnb works across many disciplines to help protect our users from these bad actors, ideally before they have the opportunity to impart negativity on the community.", "There are many different kinds of risk that online businesses may have to protect against, with varying exposure depending on the particular business. For example, email providers devote significant resources to protecting users from spam, whereas payments companies deal more with credit card chargebacks.", "We can mitigate the potential for bad actors to carry out different types of attacks in different ways.", "Many risks can be mitigated through user-facing changes to the product that require additional verification from the user. For example, requiring email confirmation, or implementing 2FA to combat account takeovers, as many banks have done.", "Scripted attacks are often associated with a noticeable increase in some measurable metric over a short period of time. For example, a sudden 1000% increase in reservations in a particular city could be a result of excellent marketing, or fraud.", "Fraudulent actors often exhibit repetitive patterns. As we recognize these patterns, we can apply heuristics to predict when they are about to occur again, and help stop them. For complex, evolving fraud vectors, heuristics eventually become too complicated and therefore unwieldy. In such cases, we turn to machine learning, which will be the focus of this blog post.", "For a more detailed look at other aspects of online risk management, check out Ohad Samet\u2019s great ebook.", "Different risk vectors can require different architectures. For example, some risk vectors are not time critical, but require computationally intensive techniques to detect. An offline architecture is best suited for this kind of detection. For the purposes of this post, we are focusing on risks requiring realtime or near-realtime action. From a broad perspective, a machine-learning pipeline for these kinds of risk must balance two important goals:", "These may seem like competing goals, since optimizing for realtime calculations during a web transaction creates a focus on speed and reliability, whereas optimizing for model building and iteration creates more of a focus on flexibility. At Airbnb, engineering and data teams have worked closely together to develop a framework that accommodates both goals: a fast, robust scoring framework with an agile model-building pipeline.", "In keeping with our service-oriented architecture, we built a separate fraud prediction service to handle deriving all the features for a particular model. When a critical event occurs in our system, e.g., a reservation is created, we query the fraud prediction service for this event. This service can then calculate all the features for the \u201creservation creation\u201d model, and send these features to our Openscoring service, which is described in more detail below. The Openscoring service returns a score and a decision based on a threshold we\u2019ve set, and the fraud prediction service can then use this information to take action (i.e., put the reservation on hold).", "The fraud prediction service has to be fast, to ensure that we are taking action on suspicious events in near realtime. Like many of our backend services for which performance is critical, it is built in java, and we parallelize the database queries necessary for feature generation. However, we also want the freedom to occasionally do some heavy computation in deriving features, so we run it asynchronously so that we are never blocking for reservations, etc. This asynchronous model works for many situations where a few seconds of delay in fraud detection has no negative effect. It\u2019s worth noting, however, that there are cases where you may want to react in realtime to block transactions, in which case a synchronous query and precomputed features may be necessary. This service is built in a very modular way, and exposes an internal restful API, making adding new events and models easy.", "Openscoring is a Java service that provides a JSON REST interface to the Java Predictive Model Markup Language (PMML) evaluator JPMML. Both JPMML and Openscoring are open source projects released under the Apache 2.0 license and authored by Villu Ruusmann (edit \u2014 the most recent version is licensed the under AGPL 3.0) . The JPMML backend of Openscoring consumes PMML, an xml markup language that encodes several common types of machine learning models, including tree models, logit models, SVMs and neural networks. We have streamlined Openscoring for a production environment by adding several features, including kafka logging and statsd monitoring. Andy Kramolisch has modified Openscoring to permit using several models simultaneously.", "As described below, there are several considerations that we weighed carefully before moving forward with Openscoring:", "After considering all of these factors, we decided that Openscoring best satisfied our two-pronged goal of having a fast and robust, yet flexible machine learning framework.", "A schematic of our model-building pipeline using PMML is illustrated above. The first step involves deriving features from the data stored on the site. Since the combination of features that gives the optimal signal is constantly changing, we store the features in a json format, which allows us to generalize the process of loading and transforming features, based on their names and types. We then transform the raw features through bucketing or binning values, and replacing missing values with reasonable estimates to improve signal. We also remove features that are shown to be statistically unimportant from our dataset. While we omit most of the details regarding how we perform these transformations for brevity here, it is important to recognize that these steps take a significant amount of time and care. We then use our transformed features to train and cross-validate the model using our favorite PMML-compatible machine learning library, and upload the PMML model to Openscoring. The final model is tested and then used for decision-making if it becomes the best performer.", "The model-training step can be performed in any language with a library that outputs PMML. One commonly used and well-supported library is the R PMML package. As illustrated below, generating a PMML with R requires very little code.", "This R script has the advantage of simplicity, and a script similar to this is a great way to start building PMMLs and to get a first model into production. In the long run, however, a setup like this has some disadvantages. First, our script requires that we perform feature transformation as a pre-processing step, and therefore we have add these transformation instructions to the PMML by editing it afterwards. The R PMML package supports many PMML transformations and data manipulations, but it is far from universal. We deploy the model as a separate step \u2014 post model-training \u2014 and so we have to manually test it for validity, which can be a time-consuming process. Yet another disadvantage of R is that the implementation of the PMML exporter is somewhat slow for a random forest model with many features and many trees. However, we\u2019ve found that simply re-writing the export function in C++ decreases run time by a factor of 10,000, from a few days to a few seconds. We can get around the drawbacks of R while maintaining its advantages by building a pipeline based on Python and scikit-learn. Scikit-learn is a Python package that supports many standard machine learning models, and includes helpful utilities for validating models and performing feature transformations. We find that Python is a more natural language than R for ad-hoc data manipulation and feature extraction. We automate the process of feature extraction based on a set of rules encoded in the names and types of variables in the features json; thus, new features can be incorporated into the model pipeline with no changes to the existing code. Deployment and testing can also be performed automatically in Python by using its standard network libraries to interface with Openscoring. Standard model performance tests (precision recall, ROC curves, etc.) are carried out using sklearn\u2019s built-in capabilities. Sklearn does not support PMML export out of the box, so have written an in-house exporter for particular sklearn classifiers. When the PMML file is uploaded to Openscoring, it is automatically tested for correspondence with the scikit-learn model it represents. Because feature-transformation, model building, model validation, deployment and testing are all carried out in a single script, a data scientist or engineer is able to quickly iterate on a model based on new features or more recent data, and then rapidly deploy the new model into production.", "Although this blog post has focused mostly on our architecture and model building pipeline, the truth is that much of our time has been spent elsewhere. Our process was very successful for some models, but for others we encountered poor precision-recall. Initially we considered whether we were experiencing a bias or a variance problem, and tried using more data and more features. However, after finding no improvement, we started digging deeper into the data, and found that the problem was that our ground truth was not accurate.", "Consider chargebacks as an example. A chargeback can be \u201cNot As Described (NAD)\u201d or \u201cFraud\u201d (this is a simplification), and grouping both types of chargebacks together for a single model would be a bad idea because legitimate users can file NAD chargebacks. This is an easy problem to resolve, and not one we actually had (agents categorize chargebacks as part of our workflow); however, there are other types of attacks where distinguishing legitimate activity from illegitimate is more subtle, and necessitated the creation of new data stores and logging pipelines.", "Most people who\u2019ve worked in machine learning will find this obvious, but it\u2019s worth re-stressing:", "If your ground truth is inaccurate, you\u2019ve already set an upper limit to how good your precision and recall can be. If your ground truth is grossly inaccurate, that upper limit is pretty low.", "Towards this end, sometimes you don\u2019t know what data you\u2019re going to need until you\u2019ve seen a new attack, especially if you haven\u2019t worked in the risk space before, or have worked in the risk space but only in a different sector. So the best advice we can offer in this case is to log everything. Throw it all in HDFS, whether you need it now or not. In the future, you can always use this data to backfill new data stores if you find it useful. This can be invaluable in responding to a new attack vector.", "Although our current ML pipeline uses scikit-learn and Openscoring, our system is constantly evolving. Our current setup is a function of the stage of the company and the amount of resources, both in terms of personnel and data, that are currently available. Smaller companies may only have a few ML models in production and a small number of analysts, and can take time to manually curate data and train the model in many non-standardized steps. Larger companies might have many, many models and require a high degree of automation, and get a sizable boost from online training. A unique challenge of working at a hyper-growth company is that landscape fundamentally changes year-over-year, and pipelines need to adjust to account for this.", "As our data and logging pipelines improve, investing in improved learning algorithms will become more worthwhile, and we will likely shift to testing new algorithms, incorporating online learning, and expanding on our model building framework to support larger data sets. Additionally, some of the most important opportunities to improve our models are based on insights into our unique data, feature selection, and other aspects our risk systems that we are not able to share publicly. We would like to acknowledge the other engineers and analysts who have contributed to these critical aspects of this project. We work in a dynamic, highly-collaborative environment, and this project is an example of how engineers and data scientists at Airbnb work together to arrive at a solution that meets a diverse set of needs. If you\u2019re interested in learning more, contact us about our data science and engineering teams!", "Creative engineers and data scientists building a world where you can belong anywhere. http://airbnb.io", "Creative engineers and data scientists building a world where you can belong anywhere. http://airbnb.io"], "all_outgoing_urls": [{"url": "https://medium.com/?source=---two_column_layout_nav----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/airbnb-engineering?source=post_page-----941abbba5a60--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/airbnb-engineering?source=post_page-----941abbba5a60--------------------------------", "anchor_text": "The Airbnb Tech Blog"}, {"url": "https://medium.com/@airbnbeng?source=post_page-----941abbba5a60--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@airbnbeng?source=post_page-----941abbba5a60--------------------------------", "anchor_text": "AirbnbEng"}, {"url": "https://www.linkedin.com/in/naseemh", "anchor_text": "Naseem Hakim"}, {"url": "https://www.linkedin.com/in/aaronkeys", "anchor_text": "Aaron Keys"}, {"url": "https://www.airbnb.com/trust", "anchor_text": "world\u2019s most trusted community"}, {"url": "http://www.cybersource.com/resources/collateral/pdf/CyberSource_MRC_Survey_Top_9_Fraud_Attacks.pdf", "anchor_text": "many"}, {"url": "http://en.wikipedia.org/wiki/Credit_card_fraud", "anchor_text": "different"}, {"url": "http://www.kount.com/use-cases", "anchor_text": "kinds"}, {"url": "http://www.idology.com/resources/fraud-glossary-of-terms/", "anchor_text": "risk"}, {"url": "http://www.ohadsamet.com/introduction-to-online-payments-risk-management-an-oreilly-ebook/", "anchor_text": "ebook"}, {"url": "http://nerds.airbnb.com/httpjson-services-in-modern-java/", "anchor_text": "modular"}, {"url": "http://en.wikipedia.org/wiki/Predictive_Model_Markup_Language", "anchor_text": "Predictive Model Markup Language (PMML)"}, {"url": "https://github.com/vruusmann", "anchor_text": "Villu Ruusmann"}, {"url": "http://openscoring.io/", "anchor_text": "most recent version"}, {"url": "https://github.com/andykram", "anchor_text": "Andy Kramolisch"}, {"url": "https://github.com/andykram/openscoring", "anchor_text": "modified Openscoring"}, {"url": "http://www.cascading.org/projects/pattern/", "anchor_text": "pattern"}, {"url": "http://www.cascading.org/", "anchor_text": "cascading"}, {"url": "http://cran.r-project.org/web/packages/pmml/pmml.pdf", "anchor_text": "R PMML"}, {"url": "http://scikit-learn.org/stable/", "anchor_text": "scikit-learn"}, {"url": "http://www.cardfellow.com/blog/chargebacks/", "anchor_text": "simplification"}, {"url": "https://www.airbnb.com/jobs/departments/position/2213", "anchor_text": "data science"}, {"url": "https://www.airbnb.com/jobs/departments/position/12039", "anchor_text": "engineering"}, {"url": "http://airbnb.io", "anchor_text": "airbnb.io"}, {"url": "https://twitter.com/AirbnbEng", "anchor_text": "@AirbnbEng"}, {"url": "https://twitter.com/AirbnbData", "anchor_text": "@AirbnbData"}, {"url": "http://nerds.airbnb.com/architecting-machine-learning-system-risk/", "anchor_text": "nerds.airbnb.com"}, {"url": "https://medium.com/tag/big-data?source=post_page-----941abbba5a60---------------big_data-----------------", "anchor_text": "Big Data"}, {"url": "https://medium.com/tag/analytics?source=post_page-----941abbba5a60---------------analytics-----------------", "anchor_text": "Analytics"}, {"url": "https://medium.com/tag/machine-learning?source=post_page-----941abbba5a60---------------machine_learning-----------------", "anchor_text": "Machine Learning"}, {"url": "https://medium.com/airbnb-engineering?source=post_page-----941abbba5a60--------------------------------", "anchor_text": "More from The Airbnb Tech Blog"}, {"url": "https://medium.com/airbnb-engineering?source=post_page-----941abbba5a60--------------------------------", "anchor_text": "Read more from The Airbnb Tech Blog"}, {"url": "https://medium.com/?source=post_page-----941abbba5a60--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/about?autoplay=1&source=post_page-----941abbba5a60--------------------------------", "anchor_text": "About"}, {"url": "https://help.medium.com/hc/en-us?source=post_page-----941abbba5a60--------------------------------", "anchor_text": "Help"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----941abbba5a60--------------------------------", "anchor_text": "Terms"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----941abbba5a60--------------------------------", "anchor_text": "Privacy"}, {"url": "https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8&ct=post_page&source=post_page-----941abbba5a60--------------------------------", "anchor_text": ""}, {"url": "https://play.google.com/store/apps/details?id=com.medium.reader&source=post_page-----941abbba5a60--------------------------------", "anchor_text": ""}, {"url": "https://medium.com/plans?source=upgrade_membership---two_column_layout_sidebar----------------------------------", "anchor_text": "Get unlimited access"}, {"url": "https://medium.com/@airbnbeng?source=---two_column_layout_sidebar----------------------------------", "anchor_text": ""}, {"url": "https://medium.com/@airbnbeng?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "AirbnbEng"}, {"url": "https://medium.com/@airbnbeng/followers?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "61K Followers"}, {"url": "http://airbnb.io", "anchor_text": "http://airbnb.io"}, {"url": "https://medium.com/m/signin?actionUrl=%2F_%2Fapi%2Fsubscriptions%2Fnewsletters%2F950725068cc5&operation=register&redirect=https%3A%2F%2Fmedium.com%2Fairbnb-engineering%2Farchitecting-a-machine-learning-system-for-risk-941abbba5a60&newsletterV3=ebe93072cafd&newsletterV3Id=950725068cc5&user=AirbnbEng&userId=ebe93072cafd&source=---two_column_layout_sidebar-----------------------subscribe_user-----------", "anchor_text": ""}, {"url": "https://help.medium.com/hc/en-us?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Help"}, {"url": "https://medium.statuspage.io/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Status"}, {"url": "https://about.medium.com/creators/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Writers"}, {"url": "https://blog.medium.com/?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Blog"}, {"url": "https://medium.com/jobs-at-medium/work-at-medium-959d1a85284e?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Careers"}, {"url": "https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Privacy"}, {"url": "https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Terms"}, {"url": "https://medium.com/about?autoplay=1&source=---two_column_layout_sidebar----------------------------------", "anchor_text": "About"}, {"url": "https://speechify.com/medium?source=---two_column_layout_sidebar----------------------------------", "anchor_text": "Text to speech"}]}, "scrape_status": {"code": "1"}}